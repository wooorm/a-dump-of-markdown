# The Open Guide to Equity Compensation

❇️ *This guide is now [published on Holloway](https://www.holloway.com/g/equity-compensation).
Read it there for additional features like search and commenting.*

## Introduction

**Equity compensation** is the practice of granting partial ownership in a company in
exchange for work.
In its ideal form, equity compensation aligns the interests of individual employees with
the goals of the company they work for, which can yield dramatic results in team building,
innovation, and longevity of employment.
Each of these [contributes](#history-and-significance) to the creation of value—for a
company, for its users and customers, and for the individuals who work to make it a
success.

The [ways equity can be granted](#how-equity-is-granted) as compensation—including restricted
stock, stock options, and restricted stock units—are **notoriously complex**. Equity
compensation involves confounding terminology, legal obscurities, and many high-stakes
decisions for those who give and receive it.

If you talk to enough employees and hiring managers, you’ll hear stories of how they or
their colleagues met with the painful consequences of not learning enough up front.
Though many people learn the basic ideas from personal experience or from colleagues or
helpful friends who have been through it before, the intricacies of equity compensation
are best understood by tax attorneys, corporate lawyers, and other professionals.

Decisions related to [negotiating an offer](#offers-and-negotiations) and
[exercising stock options](#stock-option-scenarios), in particular, can have **major financial
consequences**. Because the value of employee equity is determined by the fate of the
company, an employee’s equity may be [illiquid](#what-is-private-stock-worth) for a long time
or ultimately [worth nothing](#growth-and-risk), while taxes and the costs of exercise, if
they apply, may not be recouped.
Even when a company is doing well, an employee may suffer
[catastrophic tax pitfalls](#tax-dangers) because they didn’t anticipate the tax consequences
of their decisions.

Understanding the technicalities of equity compensation does not guarantee that fortune
will smile upon you as warmly as it did [the early hires](#history-and-significance) of
Facebook. But a thorough overview can help you be informed when
[discussing with professionals](#seeking-professional-advice) for further assistance, make
better decisions for your personal situation, and avoid some [common](#tax-dangers) and
[costly](#the-amt-trap) mistakes.

### Why This Guide?

The first edition of this work, written by the same lead authors as the one you’re reading
now, received significant feedback and discussion
[on Hacker News](https://news.ycombinator.com/item?id=10880726),
[on GitHub](https://github.com/jlevy/og-equity-compensation), and from individual experts.
Now, Holloway is pleased to publish this new edition of the Guide.
We’ve expanded sections, added resources and visuals, and filled in gaps.

There is [a lot of information](#further-reading) about equity compensation spread across
blogs and articles that focus on specific components of the topic, such as vesting, types
of stock options, or equity levels.
We believe there is a need for a consolidated and shared resource, written by and for
people on different sides of compensation decisions, including employees, hiring managers,
founders, and students.
Anyone can feel overwhelmed by the complex details and high-stakes personal choices that
this topic involves.
This reference exists to answer the needs of beginners and the more experienced.

Holloway and our contributors are motivated by a single purpose:
To help readers understand important details and their contexts well enough to make better
decisions themselves.
The Guide aims to be **practical** (with concrete suggestions and pitfalls to avoid),
**thoughtful** (with context and multiple expert perspectives, including divergent opinion on
controversial topics), and **concise** (it is dense but contains only notable details—still,
it’s at least a three-hour read, with links to three hundred sources!).

The Guide does not purport to be either perfect or complete.
A reference like this is always in process.
That’s why we’re currently testing features to enable the Holloway community to suggest
improvements, contribute new sections, and call out anything that needs revision.
We welcome (and will gladly credit) [your help](#please-help).

We especially wish to [recognize](#credits) the dozens of people who have helped write,
review, edit, and improve it so far—and in the future—and hope you’ll check back often as
it improves.

### Scope

This Guide **currently covers**:

- Equity compensation in **C corporations** in the **United States**.
- Equity compensation for most employees, advisors, and independent contractors in private
  companies, from startups through larger private corporations.
- Limited coverage of equity compensation in public companies.

Topics **not yet covered**:

- Equity compensation programs, such as [ESPPs](https://www.investopedia.com/terms/e/espp.asp)
  in public companies.
  (We’d like to [see this improve](#please-help) in the future.)
- Full details on executive equity compensation.
- Compensation outside the United States.
- Compensation in companies other than C corporations, including
  [LLCs](https://en.wikipedia.org/wiki/Limited_liability_company) and
  [S corporations](https://en.wikipedia.org/wiki/S_corporation), where equity compensation is
  approached and practiced in very different ways.

For these situations, see [other resources](#when-to-turn-elsewhere) and get
[professional advice](#seeking-professional-advice).

### Who May Find This Useful

Our aim is to be as helpful to the beginner as to those with more experience.
Having talked with employees, CEOs, investors, and lawyers, we can assure you that no
matter how much you know about equity compensation, you will likely run into confusion at
some point.

If you’re an **employee** or a **candidate for a job**, some of these may apply to you:

- You’ve heard phrases like *stock*, *stock options*, *strike price*, *ISOs*, *RSUs*, *83(b)
  election*, *409A valuation*, *AMT*, or *early exercise* and know they are probably
  important but are mystified by what some of them really mean or whether they apply to your
  situation.
- You’re considering a job offer but don’t know how to
  [navigate or negotiate](#offers-and-negotiations) the equity component of the offer.
- You’re joining a startup for the first time and are overwhelmed by all the
  [paperwork](#documents-and-agreements).
- You’re quitting, taking a leave of absence, or are being laid off or fired from a company
  where you have stock or options and are thinking through the decisions and consequences.
- A company you work for is going through an acquisition, IPO, or shutdown.
- You have stock in a private company and [need cash](#stock-option-scenarios).

**Founders** or **hiring managers** who need to talk about equity compensation with employees
or potential hires will also find this Guide useful.
As many entrepreneurs and hiring managers will tell you, this topic isn’t easy on that
side of the table, either!
Negotiating with candidates and fielding questions from candidates and employees requires
understanding the same complex technicalities of equity compensation well.

That said, this topic is **not simple** and we ask that readers be willing to invest time to
get through a lot of confusing detail.
If you’re in a hurry, or you don’t care to learn the details, this Guide may not be for
you. [Seek advice](#seeking-professional-advice).

### A Note on Fairness

Much of what you read about equity compensation was written by a single person, from a
single vantage point.
The authors and editors of this Guide have navigated the territory of equity compensation
from the perspective of employees, hiring managers, founders, and lawyers.
We do believe that the knowledge here,
[combined with professional advice](#seeking-professional-advice), can make a significant
difference for **both employees and hiring managers**.

One of the difficulties for candidates negotiating equity compensation is that they may
have less information about what they are worth than the person hiring them.
Companies talk to many candidates and often have access to or pay for expensive
market-rate compensation data.
While some data on [typical equity levels](#typical-employee-equity-levels) have been
published online, much of it fails to represent the value of a candidate with their own
specific experience in a specific role.
However, even without exact data, candidates and hiring managers can develop better mental
frameworks to think about [offers and negotiations](#offers-and-negotiations).

On the other hand, challenges are not limited to those of employees.
Founders and hiring managers also often struggle with talking through the web of
technicalities with potential hires, and can make equally poor decisions when making
offers. Either over-compensating or under-compensating employees can have unfortunate
consequences.

In short, both companies and employees are routinely hurt by uninformed decisions and
costly mistakes when it comes to equity compensation.
A shared resource is helpful for both sides.

## Roadmap

### The Holloway Reader

The Holloway Reader you’re using now is designed to help you find and navigate the
material you need. **Use the search box.**
It will reveal definitions, section-by-section results, and content contained in **the
hundreds of resources we’ve linked to** throughout the Guide.
Think of it as a mini library of the best content on equity compensation.
We also provide mouseover (or short tap on mobile) for **definitions of terms**, related
section suggestions, and external links while you read.

### How This Guide Is Organized

This Guide contains a lot of material.
And it’s dense.
Some readers may wish to read front to back, but you can also **search or navigate directly**
to parts that are of interest to you, **referring back** to foundational topics as needed.

Equity compensation lies at the intersection of corporate law, taxation, and employee
compensation, and so requires some basic understanding of all three.
You might think compensation and taxation are separate topics, but they are so intertwined
it would be misleading to explain one without the other.
We cover material in logical order, so that if you do read the earlier sections first,
later sections on the interactions of tax and compensation will be clearer.

We start with [**Equity Compensation Basics**](#equity-compensation-basics): What compensation
and equity are, and why equity is used as compensation.

But before we get much further, we need to talk about what stock is, and how companies are
formed. [**Fundamentals of Stock Corporations**](#fundamentals-of-stock-corporations) covers how
companies organize their ownership, how stock is issued, public companies and private
companies, and IPOs and liquidity (which determine when equity is worth cash).

While not everyone reading this works at an early stage company, those who do can benefit
from understanding the role of equity in [**Startups and Growth**](#startups-and-growth). This is
good context for anyone involved in a private company that has taken on venture capital.

[**How Equity is Granted**](#how-equity-is-granted) is the core of this Guide.
We describe the forms in which equity is most commonly granted, including restricted stock
grants, stock options, and RSUs.

Now is where it gets messier—taxes:

- [**Tax Basics**](#tax-basics): A technical summary of how taxation works.
  Many of the headaches of equity compensation involve how it is taxed, including ordinary
  income tax, long-term capital gains tax, and the lesser-known but sometimes critical
  alternative minimum tax.
- [**Taxes on Equity Compensation**](#taxes-on-equity-compensation): How much tax you owe is greatly
  affected by the kind of equity you have (such as restricted stock awards, stock options,
  or RSUs), when you choose to pay (including 83(b) elections), and when you choose to
  exercise options.

After these technical concerns, we move on to how you can think about all this in
practice. These sections focus on scenarios common to employees and candidates, but are
also of likely interest to founders and hiring managers:

- [**Plans and Scenarios**](#plans-and-scenarios): Whether you have equity now or will in the
  future, it is helpful to learn *how to think about* the value of equity and its tax
  burden. We also cover whether you can [sell private stock](#can-you-sell-private-stock).
- [**Offers and Negotiations**](#offers-and-negotiations): Equity often comes up as you’re
  negotiating or debating whether to accept a job offer.
  Here we cover what to expect, what to ask, tips and pitfalls, and more.

Finally, we offer some additional resources:

- [**Documents and Agreements**](#documents-and-agreements): A bit more detail on the actual legal
  paperwork you’re likely to see as you negotiate and after you’ve accepted an offer.
- [**Further Reading**](#further-reading): A curated list of what else you can read on the subject,
  including many papers, books, and articles that have informed this Guide.

🚧 What about a Getting Help section outlining when to go to whom for professional help?

### When to Turn Elsewhere

**CEOs**, **CFOs**, **COOs**, or anyone who runs a company or team of significant size should be
sure to talk to an equity compensation consultant or a specialist at a law firm to learn
about equity compensation plans.

**Founders** looking for an introduction to the legalities of running a company may wish to
check out [*Legal Concepts for Founders*](https://handbook.clerky.com/), from Clerky, in
addition to talking to a lawyer.
Founders should also lean on their investors for advice, as they may have additional
experience.

**Executive compensation** at large or public companies is an even more nuanced topic, on
both sides of the table.
Hire an experienced lawyer or compensation consultant.
There are extensive legal [resources](https://www.compensationstandards.com/home/) available
on executive compensation.

### Seeking Professional Advice

This Guide does not replace professional advice.

Please read the full [disclaimer](#disclaimer) and seek professional advice from a lawyer,
tax professional, or other compensation expert before making significant decisions.

Does that make reading through these details a waste of time?
Not at all. Important decisions rarely should or can be blindly delegated.
This Guide *complements but does not replace* the advice you get from professionals.
Working with the support of a professional can help you make better decisions when you
have an understanding of the topic yourself and know what questions to ask.

## Equity Compensation Basics

### History and Significance

Companies ranging from two-person startups to the
[Fortune 500](http://fortune.com/fortune500/) have found that granting partial ownership in a
company is among the best methods to attract and retain exceptional talent.
In the United States, partial ownership through [stock options](#stock-options) has been a
key part of pay for executives and other employees since the 1950s.[^corpgovlaw.6vw7qt]
As recently as 2014, **7.2%** of all private sector employees (**8.5 million** people) and
**13.1%** of *all* employees of companies with stock held stock options, according to the
National Center for Employee Ownership.[^nceoorgass.x6588n]
Many believe employee ownership has
[💰fostered innovations](https://www.wsj.com/articles/reviving-the-flagging-spirit-of-silicon-valley-1428706671)
in technology, especially in Silicon Valley, from the
[early days](http://www.hp.com/hpinfo/abouthp/histnfacts/publications/measure/pdf/1976_07.pdf)
of Hewlett-Packard to recent examples like Facebook.
Stock options helped the first 3,000 employees of Facebook enjoy roughly **$23 billion** at
the time the company went public.[^ftcomconte.x613np]

🌪 Some controversy surrounds the use of equity compensation for high-paid executives.
Public companies offer executives equity compensation in no small part because of a tax
loophole. In 1993, President Bill Clinton attempted to limit executive pay with a new
section[^treasurygo.tbpcyx] of the Internal Revenue Code.
Unfortunately, the legislation backfired;
a loophole made performance-based pay—including stock options—fully tax deductible,
thereby creating a dramatic incentive to pay executives through stock options.[^epiorgpubl.cq5o0o]
From 1970–79, the average compensation for a CEO of one of the 50 largest firms in the
United States was **$1.2M**, of which **11.2%** was from stock options.
By 2000–05, the same numbers had risen to **$9.2M** and **37%**, respectively.[^nberorgpap.wtsymr]

### Growth and Risk

Generally, equity compensation is closely linked to the **growth** of a company.
Cash-poor startups persuade early employees to take pay cuts and join their team by
offering meaningful [ownerships stakes](#typical-employee-equity-levels), catering to hopes
that the company will one day grow large enough to [go public](#ipos) or
[be sold](#sales-and-liquidity) for an ample sum.
More mature but still fast-growing companies find offering compensation linked to
ownership is more attractive than high cash compensation to many candidates.

With the hope for growth, however, also comes **risk**. Large, fast-growing companies often
hit hard times.
And [startups](#startups-and-growth) routinely fail or yield no returns for investors or
workers. According to [a report](http://fortune.com/2017/06/27/startup-advice-data-failure/)
by Cambridge Associates and Fortune Magazine, between 1990 and 2010, **about 60%** of
venture capital-backed companies returned less than the original investment, leaving
employees with the painful realization that their startup was not, in fact, the next
Google. Of the remaining **40%**, just a select few go on to make a many of their employees
wealthy, as has been the case with iconic high-growth companies, like Starbucks,[^investoped.aaps6n] UPS,[^moneycnnco.80o8bh]
Amazon,[^techcrunch.9ucopn] Google,[^dealbookny.es6h1j] or Facebook.[^enwikipedi.q7bc95]

### Compensation and Equity

🄳 **Compensation** is any remuneration to a person (including employees, contractors,
advisors, founders, and board members) for services performed or rendered to a company.
Compensation comes in the forms of cash pay (salary and any bonuses) and any non-cash pay,
including [benefits](https://en.wikipedia.org/wiki/Employee_benefits#United_States) like
health insurance, family-related protections, perks, and retirement plans.

Company strategies for compensation are
[far from simple](http://firstround.com/review/counterintuitive-comp-tips-for-the-unwary-and-uninitiated/).
Beth Scheer, head of talent at the venture fund Homebrew, offers a
[thoughtful overview](https://quip.com/HEB3Ah9dYD6o) of compensation in startups.

Another term you may encounter is
[*total rewards*](https://www.worldatwork.org/total-rewards-model/), which refers to a model of
attracting and retaining employees using a combination of salary and incentive
compensation (like equity), benefits, recognition for contribution or commitment (like
awards and bonuses), training programs, and initiatives to improve the work environment.

🄳 In the context of compensation and investment, **equity** broadly refers to any kind of
ownership in a company that can be held by individuals (like employees or board members)
and by other businesses (like venture capital firms).
One common kind of equity is stock, but equity can take other forms, such as stock options
or warrants, that give ownership rights.
Commonly, equity also comes with certain conditions, such as vesting or repurchase rights.
Note the term *equity* also has
[several other](https://www.investopedia.com/terms/e/equity.asp) technical meanings in
accounting and real estate.

🄳 [**Equity compensation**](http://www.investopedia.com/terms/e/equity-compensation.asp) is the
practice of granting equity in exchange for work.

In this Guide we focus on equity compensation in stock corporations, the kind of company
where ownership is represented by stock.
(We describe stock in more detail in [the next section](#fundamentals-of-stock-corporations).)
Equity compensation in the form of a direct grant of stock with no strings attached is
very rare. Instead, employees are given stock with additional restrictions placed on it,
or are given contractual rights that later can lead to owning stock.
These forms of equity compensation include restricted stock, stock options, and restricted
stock units, each of which we’ll [describe in detail](#how-equity-is-granted).

### The Goals of Equity Compensation

The purpose of equity compensation is threefold:

- **Attract and retain talent.**
  When a company already has or can be predicted to have significant financial success,
  talented people are [incentivized](https://avc.com/2010/10/employee-equity-options/) to work
  for the company by the prospect of their equity being
  [worth a lot](https://www.entrepreneur.com/article/253438) of money in the future.
  The actual probability of life-changing lucre may be low (or at least, lower than you may
  think if your entire knowledge of startups is watching “[The Social Network](https://en.wikipedia.org/wiki/The_Social_Network)”).
  But even a small chance at winning big can be worth the risk to many people, and to some
  the risk itself can be exciting.
- **Align incentives.**
  Even companies that can afford to pay lots of cash may prefer to give employees equity,
  so that employees work to increase the *future* value of the company.
  In this way, equity aligns individuals’ incentives with the interests of the company.
  At its best, this philosophy fosters an environment of teamwork and a “rising tides lift
  all boats” mentality.
  It also encourages everyone involved to think
  [long-term](https://www.cebglobal.com/blogs/equity-compensation-will-stop-short-termism-and-boost-growth/),
  which is key for company success.
  As we’ll [discuss later](#offers-and-negotiations), the amount of equity you’re offered
  usually reflects both your contribution to the company and your commitment to the company
  in the future.
- **Reduce cash spending.**
  By giving equity, a company can often pay less in cash compensation to employees now,
  with the hope of rewarding them later, and put that money toward other investments or
  operating expenses.
  This can be essential in the early stages of a company or at other times where there may
  not be enough revenue to pay large salaries.
  Equity compensation can also help recruit senior employees or executives who would
  otherwise command especially high salaries.

🚧 Mention or link to lockup periods etc.

## Fundamentals of Stock Corporations

In this section, we describe the basics of how stock and shares are used.

Those familiar with stock, stock corporations, public companies, and private companies can
[jump ahead](#how-equity-is-granted) to how those companies grant equity.

### Kinds of Companies

🄳 A **company** is a legal entity formed under corporate law for the purpose of conducting
trade. In the United States, specific rules and regulations govern several kinds of
[business entities](https://en.wikipedia.org/wiki/Types_of_business_entity#United_States).
Federal and state law have significant implications on liability and taxation for each
kind of company.
Notable types of companies include sole proprietorships, partnerships, limited liability
companies (LLCs), S corporations, and C corporations.

🄳 A **corporation** is a company that is legally recognized as a single entity.
The corporation itself, and not its owners, is obligated to repay debts and accountable
under contracts and legal actions (that is, is a “[legal person](https://en.wikipedia.org/wiki/Legal_person)”).
Most commonly, the term *corporation* is used to refer to a
**[stock corporation (or joint-stock company)](https://en.wikipedia.org/wiki/Joint-stock_company)**,
which is a corporation where ownership is managed using stock. **Non-stock corporations**
that do not issue stock exist as well, the most common being
[nonprofit organizations](https://en.wikipedia.org/wiki/Nonprofit_organization). (A few
[less common](https://en.wikipedia.org/wiki/Non-stock_corporation) for-profit non-stock
corporations also exist.)

In practice, people often use the word *company* to mean *corporation*.

🄳 **Incorporation** is the
[legal process](https://en.wikipedia.org/wiki/Incorporation_(business)) of forming (or
**incorporating**) a new corporation, such as a business or nonprofit.
Corporations can be created in any country.
In the United States, incorporation is handled by state law, and involves filing
[articles of incorporation](https://en.wikipedia.org/wiki/Articles_of_incorporation) and a
variety of other [required information](https://handbook.clerky.com/formation/process) with
the Secretary of State.
(Note that the formation of companies that are not corporations, such as partnerships or
LLCs, is not the same as incorporation.)

🄳 A [**C corporation (or C corp)**](https://en.wikipedia.org/wiki/C_corporation) is a type of
stock corporation in the United States with certain federal
[tax treatment](https://ct.wolterskluwer.com/resource-center/articles/what-c-corporation). It
is the most prevalent kind of corporation.[^investoped.m9wdqp]
Most large, well-known American companies are C corporations.
C corporations differ from
[S corporations](https://www.incorporate.com/starting-a-business/s-corporation) and other
business entities in several ways, including how income is taxed and who may own stock.
C corporations have no limit on the number of shareholders allowed to own part of the
company. They also allow other corporations, as well as partnerships, trusts, and other
businesses, to own stock.

C corps are overwhelmingly popular for early-stage
[private companies](#public-and-private-companies) looking to sell part of their business in
exchange for investment from individuals and organizations like venture capital firms
(which are often partnerships), and for established public companies selling large numbers
of stock to individuals and other companies on the
[public exchange](https://en.wikipedia.org/wiki/Stock_exchange).

In practice, for a few reasons, these companies are usually formed in Delaware, so
legalities of all this are defined in Delaware law.[^quoracomwh.wsnr2b][^nytimescom.67ksyb]
You can think of Delaware law as the primary “language” of U.S. corporate law.
Incorporating a company in Delaware has evolved into a national standard for high-growth
companies, regardless of where they are physically located.

🔸 This Guide focuses specifically on C corporations and [does not cover](#scope) how equity
compensation works in LLCs, S corporations, partnerships, or sole proprietorships.
Both equity and compensation are handled in significantly different ways in each of these
kinds of businesses.

Loosely, one way to think about companies is that they are simply a set of
[contracts](https://www.law.cornell.edu/wex/contract), negotiated over time between the people
who own and operate the company, and which are enforced by the government, that aligns the
interests of everyone involved in creating things customers are willing to pay for.
Key to these contracts is a way to precisely track ownership of the company;
issuing stock is how companies often choose to do this.

🚧 Mention how court cases are settled?

### Stock and Shares

🄳 [**Stock**](https://en.wikipedia.org/wiki/Stock) is a legal invention that represents
ownership in a company. [**Shares**](https://en.wikipedia.org/wiki/Share_(finance)) are portions
of stock that allow a company to grant ownership to a variety of people or other companies
in flexible ways.
Each **shareholder (or stockholder)**, as these owners are called, holds a specific number
of shares. Founders, investors, employees, board members, contractors, advisors, and other
companies, like law firms, can all be shareholders.

🄳 Stock ownership is often formalized on **stock certificates**, which are fancy pieces of
paper that prove who owns the stock.

Sometimes you have stock but don’t have the physical certificate, as it may be held for
you at a law office.

Some companies now manage their ownership through online services called *ownership
management platforms*, such as [Carta](https://carta.com/). If the company you work for uses
an ownership management platform, you will be able to view your stock certificates and
stock values online.

Younger companies may also choose to keep their stock *uncertificated*, which means your
sole evidence of ownership is your contracts with the company, and your spot on the
company’s cap table, without having a separate certificate for it.

🄳 [**Outstanding shares**](http://www.investopedia.com/terms/o/outstandingshares.asp) refer to
the total number of shares held by all shareholders.
This number starts at an essentially arbitrary value (such as 10 million) when the company
is created, and thereafter will increase as new shares are added (issued) and granted to
people in exchange for money or services.

Outstanding shares may increase or decrease for other reasons too, such as
[stock splits and share buybacks](http://www.investorguide.com/article/11713/splits-and-buybacks-explained/),
which we won’t get into here.

Later, we discuss several [subtleties](#counting-shares) in how shares are counted.

🚧 What is a good overview on stock splits and share buyback.
Key resources?

🄳 Any shareholder has a **percentage ownership** in the company, determined by dividing the
number of shares they own by the number of outstanding shares.
Although stock paperwork will always list numbers of shares, if share value is uncertain,
percentage ownership is often a more meaningful number, particularly if you know or can
estimate a likely valuation of the company.
Even if the number of shares a person has is fixed, their percentage ownership will change
over time as the outstanding shares change.
Typically, this number is presented in percent or
[**basis points**](https://www.investopedia.com/terms/b/basispoint.asp) (hundredths of a percent).

### Public and Private Companies

🄳 [**Public companies**](https://en.wikipedia.org/wiki/Public_company) are corporations in which
any member of the public can own stock.
People can buy and sell the stock for cash on public
[stock exchanges](https://www.investopedia.com/terms/e/exchange.asp). The value of a company’s
shares is the value displayed in the stock market reports, so shareholders know how much
their stock is worth.

🄳 Most smaller companies, including all startups, are
[**private companies**](https://en.wikipedia.org/wiki/Privately_held_company) with owners who
control how those companies operate.
Unlike a public company, where anyone is able to buy and sell stock, owners of a private
company control who is able to buy and sell stock.
There may be few or no transactions, or they may not be publicly known.

🚧 What are public exchanges and how is stock bought and sold in practice?
Mention accredited investors?

### Governance

🄳 A corporation has a **board of directors**, a
[group of people](https://en.wikipedia.org/wiki/Board_of_directors) whose legal obligation is
to oversee the company and ensure it serves the best interests of the shareholders.
Public companies are legally obligated to have a board of directors, while private
companies often elect to have one.
The board typically consists of **inside directors**, such as the CEO, one or two founders,
or executives employed by the company, and **outside directors**, who are not involved in
the day-to-day workings of the company.
These **board members** are elected individuals who have legal, corporate governance rights
and duties when it comes to voting on key company decisions.
A board member is said to have a **board seat** at the company.

Boards of directors range from 3 to 31 members, with an average size of 9.[^investoped.fn52lq] Boards are
almost always an odd number in order to avoid tie votes.
It’s worth noting that the state of California requires public companies to have at least
one woman on their boards.[^nytimescom.gec7iw]

Key decisions of the board are made formally in *board meetings* or in writing (called
*written consent*).[^dlapiperac.wb4617] Many decisions around granting equity to employees are approved by the
board of directors.

🚧 This section could be expanded, and also include more legal links.

### IPOs

🄳 A private company becomes a public company in a process called an
[**initial public offering (IPO)**](https://en.wikipedia.org/wiki/Initial_public_offering).
Historically, only private companies with a strong track record of years of growth have
considered themselves ready to take this significant step.
The IPO has [pros and cons](https://www.investopedia.com/university/ipo/ipo.asp) that include
exchanging a host of high regulatory costs for the benefits of significant capital.
After a company “IPOs” or “**goes public**," investors and the general public can buy stock,
and existing shareholders can sell their stock far more easily than when the company was
private.

Companies take years to IPO after being formed.
The median time between a company’s founding and its IPO has been increasing.
According to a Harvard report, companies that went public in **2016** took **7.7 years** to do
so, compared to **3.1 years** for companies that went public in **1996**.[^corpgovlaw.vbw82s]

🚧 What are the restrictions and regulations on selling stock that affect employees at
IPO? What is a lockup period?

### Sales and Liquidity

❗️ With private companies, it can be very [hard to know](#what-is-private-stock-worth) the
value of equity.
Because the value of private company stock is not determined by regular trades on public
markets, shareholders can only make educated guesses about the likely future value, at a
time when they will be able to sell stock.

After all, private company stock is simply a legal agreement that entitles you to
something of highly uncertain value, and could well be worthless in the future, or highly
valuable, depending on the fate of the company.

☝️ We’ll discuss the notion of a company officially assigning a
[fair market value](#409a-valuations) later, but even if a company gives you a value for your
stock for tax and accounting purposes, it doesn’t mean you can expect to sell it for that
value!

🄳 An [**acquisition**](https://www.investopedia.com/terms/a/acquisition.asp) is the purchase of
more than 50% of the shares of one company (the acquired company) by another company (the
purchaser). This is also called a **sale** of the acquired company.
In an acquisition, the acquired company cedes control to the purchaser.

🄳 The ability to buy and sell stock is called **liquidity**. In startups and many private
companies, it is often hard to sell stock until the company is sold or goes public, so
there is little or no liquidity for shareholders until those events occur.
Thus, sales and IPOs are called both **exits** and **liquidity events**. Sales, dissolutions,
and bankruptcy are all called **liquidations**.

Often people wish they could sell stock in a private company, because they would prefer
having the cash.
This is only possible occasionally.
We get into the details [later](#can-you-sell-private-stock), in our section on selling
private stock.

🄳 A [**dividend**](http://www.investopedia.com/terms/d/dividend.asp) is a distribution of a
company’s profit to shareholders, authorized by the board of directors.
Established public companies and some private companies pay dividends, but this is rare
among startups and companies focused on rapid growth, since they often wish to re-invest
their profits into expanding the business, rather than paying that money back to
shareholders. Amazon, for example, has
[never paid](https://www.fool.com/investing/2017/12/28/will-amazon-start-paying-a-dividend-in-2018.aspx)
dividends.

## Startups and Growth

If you’re considering working for a startup, what we cover next on how these early-stage
companies raise money and grow is helpful in understanding what your equity may be worth.

If you’re only concerned with large and established companies, you can skip ahead to
[how equity is granted](#how-equity-is-granted).

### Startups

🄳 A [**startup**](https://en.wikipedia.org/wiki/Startup_company) is an emerging company,
typically a private company, that aspires to grow quickly in size, revenue, and influence.
Once a company is established in the market and successful for a while, it usually stops
being called a startup.

☝️ Unlike the terminology around corporations, which has legal significance, the term
*startup* is informal, and not everyone uses it consistently.

Startups are not the same as small businesses.
Small businesses, like a coffee shop or plumbing business, typically intend to grow slowly
and organically, while relying much less on investment capital and equity compensation.
Distinguished startup investor
[Paul Graham](https://en.wikipedia.org/wiki/Paul_Graham_(programmer)) has
[emphasized](http://www.paulgraham.com/growth.html) that it’s best to think of a startup as
any [early stage](#stages-of-a-startup) company intending to grow quickly.

∑ C corporations dominate the startup ecosystem.
LLCs tend to be better suited for slower-growth companies that intend to distribute
profits instead of re-investing them for growth.
Because of this, and for complex reasons related to how their capital is raised, venture
capitalists significantly prefer to invest in C corporations.

🚧 What are good stats on how many people work in startups vs.
established companies?

### Fundraising, Growth, and Dilution

Many large and successful companies began as startups.
In general, startups rely on investors to help fund rapid growth.

🄳 **Fundraising** is the process of seeking capital to build or scale a business.
Selling shares in a business to investors is one form of fundraising, as are loans and
[initial coin offerings](https://en.wikipedia.org/wiki/Initial_coin_offering). **Financing**
refers both to fundraising from outside sources and to bringing in revenue from selling a
product or service.

🄳 **Venture capital** is a form of financing for early-stage companies that individual
investors or investment firms provide in exchange for partial ownership, or equity, in a
company. These investors are called **venture capitalists (or VCs)**. Venture capitalists
invest in companies they perceive to be capable of growing quickly and commanding
significant market share.
“Venture” refers to the risky nature of investing in early-stage businesses—typically
startups—with unproven business models.

A startup goes through several [stages of growth](#stages-of-a-startup) as it raises capital
based on the hope and expectation that the company will grow and make more money in the
future.

🄳 Companies add (or “issue”) shares during fundraising, which can be exchanged for cash
from investors.
As the number of outstanding shares goes up, the percentage ownership of each shareholder
goes down. This is called [**dilution**](http://www.investopedia.com/terms/d/dilution.asp).

☝️ Dilution doesn’t necessarily mean that you’re losing anything as a shareholder.
As a company issues stock and raises money, the smaller percentage of the company you *do*
have could be worth more.
The size of your slice gets relatively smaller, but, if the company is growing, the size
of the cake gets bigger.
For example, a typical startup might have three rounds of funding, with each round of
funding issuing 20% more shares.
At the end of the three rounds, there are more outstanding shares—roughly 73% more in this
case, since 120%×120%×120% is 173%—and each shareholder owns proportionally less of the
company.

🄳 The [**valuation**](https://en.wikipedia.org/wiki/Valuation_(finance)) of the company is the
present value investors believe the company has.
If the company is doing well, growing revenue or showing indications of future revenue
(like a growing number of users or traction in a promising market), the company’s
valuation will usually be on the rise.
That is, the [price](https://en.wikipedia.org/wiki/Share_price) for an investor to buy one
share of the company would be increasing.

❗️ Of course, things do not always go well, and the valuation of a company does not always
go up. It can happen that a company fails entirely and all ownership stakes become
worthless, or that the valuation is lower than expected and
[certain kinds](#classes-of-stock) of shares become worthless while other kinds have some
value. When investors and leadership in a company expect the company to do better than it
actually does, it can have a lot of disappointing consequences for shareholders.

### Dilution Illustrations

These visualizations illustrate how ownership of a venture-backed company evolves as
funding is raised.
One scenario imagines changes to ownership in a well-performing startup, and the other is
loosely based on a careful analysis of Zipcar,[^reactionwh.uw835n] a ride-sharing company that experienced
substantial dilution before eventually going public and being
[acquired](#sales-and-liquidity). These diagrams simplify complexities such as the ones
discussed in that analysis, but they give a sense of how ownership can be diluted.

```hlwy-infographics
{
  "name": "CaptableDilution",
  "data": {
    "hypothetical": {
      "label": "Hypothetical",
      "stages": [
        {
          "label": "Founding",
          "postValuation": 1000,
          "captable": [
            {
              "type": "founder1",
              "label": "Founder #1",
              "shares": 4000000
            },
            {
              "type": "founder2",
              "label": "Founder #2",
              "shares": 3000000
            },
            {
              "type": "founder3",
              "label": "Founder #3",
              "shares": 3000000
            }
          ]
        },
        {
          "label": "Series A",
          "captable": [
            {
              "type": "founder1",
              "label": "Founder #1",
              "shares": 4000000
            },
            {
              "type": "founder2",
              "label": "Founder #2",
              "shares": 3000000
            },
            {
              "type": "founder3",
              "label": "Founder #3",
              "shares": 3000000
            },
            {
              "type": "options",
              "label": "Options Pool",
              "shares": 1500000
            },
            {
              "type": "investment",
              "label": "Seed",
              "preValuation": 8000000,
              "raised": 2000000
            },
            {
              "type": "investment",
              "label": "Series A",
              "preValuation": 8000000,
              "raised": 5000000
            }
          ]
        },
        {
          "label": "Series C",
          "captable": [
            {
              "type": "founder1",
              "label": "Founder #1",
              "shares": 4000000
            },
            {
              "type": "founder2",
              "label": "Founder #2",
              "shares": 3000000
            },
            {
              "type": "founder3",
              "label": "Founder #3",
              "shares": 3000000
            },
            {
              "type": "options",
              "label": "Options Pool",
              "shares": 1500000
            },
            {
              "type": "investment",
              "label": "Seed",
              "preValuation": 8000000,
              "raised": 2000000
            },
            {
              "type": "investment",
              "label": "Series A",
              "preValuation": 8000000,
              "raised": 5000000
            },
            {
              "type": "investment",
              "label": "Series B",
              "preValuation": 20000000,
              "raised": 10000000
            },
            {
              "type": "investment",
              "label": "Series C",
              "preValuation": 40000000,
              "raised": 20000000
            }
          ]
        }
      ]
    },
    "zipcar": {
      "label": "Approx. Zipcar",
      "stages": [
        {
          "label": "Founding",
          "postValuation": 1000,
          "captable": [
            {
              "type": "founder1",
              "label": "Founder #1",
              "shares": 570000
            },
            {
              "type": "founder2",
              "label": "Founder #2",
              "shares": 570000
            }
          ]
        },
        {
          "label": "Series A",
          "captable": [
            {
              "type": "founder1",
              "label": "Founder #1",
              "shares": 570000
            },
            {
              "type": "founder2",
              "label": "Founder #2",
              "shares": 570000
            },
            {
              "type": "options",
              "label": "Options Pool",
              "shares": 378000
            },
            {
              "type": "investment",
              "label": "Series A",
              "preValuation": 5800000,
              "raised": 1400000
            }
          ]
        },
        {
          "label": "Series B",
          "captable": [
            {
              "type": "founder1",
              "label": "Founder #1",
              "shares": 570000
            },
            {
              "type": "founder2",
              "label": "Founder #2",
              "shares": 570000
            },
            {
              "type": "options",
              "label": "Options Pool",
              "shares": 378000
            },
            {
              "type": "investment",
              "label": "Series A",
              "preValuation": 5800000,
              "raised": 1400000
            },
            {
              "type": "investment",
              "label": "Series A",
              "preValuation": 2200000,
              "raised": 4700000
            }
          ]
        }
      ]
    }
  }
}
```

### Stages of a Startup

Understanding the value of stock and equity in a startup requires a grasp of the stages of
growth a startup goes through.
These stages are largely reflected in how much funding has been raised—how much ownership,
in the form of shares, has been sold for capital.

Very roughly,
[typical stages](http://blog.eladgil.com/2011/03/how-funding-rounds-differ-seed-series.html)
are:

- [**Bootstrapped**](https://www.investopedia.com/terms/b/bootstrapping.asp) (little funding or
  self-funded): Founders are figuring out what to build, or they’re starting to build with
  their own time and resources.
- [**Series Seed**](https://www.investopedia.com/terms/s/seedcapital.asp) (roughly $250K to $2
  million in funding): Figuring out the product and market.
  The low end of this spectrum is now often called **pre-seed**.
- [**Series A**](https://www.investopedia.com/terms/s/seriesa.asp) ($2 to $15 million): Scaling the
  product and making the business model work.
- [**Series B**](https://www.investopedia.com/terms/s/series-b-financing.asp) (tens of millions):
  Scaling the business.
- **Series C, D, E, et cetera** (tens to hundreds of millions): Continued scaling of the
  business.

Keep in mind that these numbers are more typical for startups located in California.
The amount raised at various stages is typically smaller for companies located outside of
Silicon Valley, where what would be called a seed round may be called a Series A in, say,
Houston, Denver, or Columbus, where there are fewer companies competing for investment
from fewer venture firms, and costs associated with growth (including providing livable
salaries) are lower.[^nytimescom.bcfuyu][^chicagotri.fq0msp]

🔸 Most startups don’t get far.
According to an analysis of
[angel investments](https://www.investopedia.com/terms/a/angelinvestor.asp), by Susa Ventures
general partner [Leo Polovets](http://codingvc.com), **more than half** of investments fail;
**one in 3** are small successes (1X to 5X returns); **one in 8** are big successes (5X to
30X); and **one in 20** are huge successes (30X+).[^codingvcco.bcspni]

🚧 What are some stats beyond angel investments?

🔸 Each stage reflects the reduction of risk and increased dilution.
For this reason, the amount of equity team members get is higher in the earlier stages
(starting with founders) and increasingly lower as a company matures.
(See the picture above.)

### The Option Pool

🄳 At some point early on, generally before the first employees are hired, a number of
shares will be reserved for an employee
**[option pool](http://www.investopedia.com/terms/o/option-pool.asp) (or employee pool)**. The
option pool is part of a legal structure called an equity incentive plan.
A typical size for the option pool is 20% of the stock of the company, but, especially for
earlier stage companies, the option pool can be 10%, 15%, or other sizes.

Once the pool is established, the company’s board of directors grants stock from the pool
to employees as they join the company.

∑ Well-advised companies will reserve in the option pool only what they
[expect to use](http://siliconhillslawyer.com/2014/05/01/option-pool-not-ocean-startups/) over
the next 12 months or so;
otherwise, given how equity grants are usually promised, they may be over-granting equity.
The whole pool may never be fully used, but companies should still try not to reserve more
than they plan to use.
The size of the pool is determined by
[complex factors](http://venturehacks.com/articles/option-pool-shuffle) between founders and
investors. It’s worth employees (and
[founders](https://www.cooleygo.com/negotiating-option-pool/)) understanding that a small pool
can be a good thing in that it reflects the company preserving ownership in negotiations
with investors.
The size of the pool may be increased later.

### Counting Shares

There are some key subtleties you’re likely to come across in the way
[outstanding shares](#stock-and-shares) are counted:

🄳 Private companies always have what are referred to as **authorized but unissued** shares,
referring to shares that are authorized in legal paperwork but have not actually been
issued. Until they are issued, the
[unissued stock](https://www.investopedia.com/terms/u/unissuedstock.asp) these shares
represent doesn’t mean anything to the company or to shareholders:
no one owns it.

☝️ For example, a corporation might have 100 million *authorized* shares, but will only
have *issued* 10 million shares.
In this example, the corporation would have 90 million *authorized but unissued* shares.
When you are trying to determine what percentage a number of shares represents, you do
*not* make reference to the authorized but unissued shares.

☝️ You actually want to know the total issued shares, but even this number can be
confusing, as it can be computed
[more than one way](http://www.mattbartus.com/option-grants-fully-diluted-or-issued-and-outstanding/).
Typically, people count shares in two ways: *issued and outstanding* and *fully diluted*.

🄳 **Issued and outstanding** refers to the number of shares actually issued by a company to
shareholders, and does not include shares that others may have an option to purchase.

🄳 **Fully diluted** refers to all of the shares that a company has issued, all of the
shares that have been set aside in a stock incentive plan, and all of the shares that
could be issued if all convertible securities (such as outstanding warrants) were
exercised.

A key difference between fully diluted shares and shares issued and outstanding is that
the total of fully diluted shares will include all the shares in the employee option pool
that are reserved but *not yet issued to* employees.

🔹 If you’re trying to figure out the likely percentage a number of shares will be worth
in the future, it’s best to know the number of shares that are fully diluted.

∑ Even the fully diluted number may not take into account outstanding convertible
securities (like convertible notes) that are *waiting* to be converted into stock at a
future milestone.
For a more complete understanding, in addition to asking about the fully-diluted
capitalization you can ask about any convertible securities outstanding that are not
included in that number.

☝️ The terminology mentioned here isn’t universally applied.
It’s worth discussing these terms with your company to be sure you’re on the same page.

🄳 A **capitalization table (cap table)** is a
[table](https://www.investopedia.com/terms/c/capitalization-table.asp) (often a spreadsheet or
other official record) that records the ownership stakes, including number and class of
shares, of all shareholders in the company.
It is updated as stock is granted to new shareholders.[^cooleygoco.p5v68j]

🚧 Better discuss future sources of dilution.
Define convertible securities and convertible notes and “[fully diluted](https://www.lawinsider.com/dictionary/fully-diluted-basis)”
more. Do people say “fully diluted” but not include convertible securities?

### Classes of Stock

🄳 Investors often ask for rights to be paid back first in exchange for their investment.
The way these different rights are handled is by creating different
[**classes of stock**](https://www.upcounsel.com/classes-of-stock). (These are also sometimes
called [**classes of shares**](https://www.investopedia.com/terms/c/class.asp), though that term
has another meaning in the context of mutual funds.)

🄳 Two important classes of stock are
[**common stock**](https://en.wikipedia.org/wiki/Common_stock) and
[**preferred stock**](https://en.wikipedia.org/wiki/Preferred_stock). In general, preferred stock
has “[rights, preferences, and privileges](https://www.americanbar.org/groups/business_law/publications/blt/2014/01/04_bigler/)”
that common stock does not have.
Typically, investors get preferred stock, and founders and employees get common stock (or
stock options).

The exact number of classes of stock and the differences between them can vary company to
company, and, in a startup, these can vary at [each round](#stages-of-a-startup) of funding.

☝️ Another term you’re likely to hear is
[*founders’ stock*](http://www.alleywatch.com/2013/08/what-is-founders-stock-legally/), which is
(usually) common stock allocated at a company’s formation, but otherwise doesn’t have any
different rights from other common stock.[^lsvpwordpr.dgym96]

Although preferred stock rights are too complex to cover fully, we can give a few key
details:

🄳 Preferred stock usually has a
[**liquidation preference (or preference)**](http://www.investopedia.com/terms/l/liquidation-preference.asp),
meaning the preferred stock owners will be paid before the common stock owners when a
[liquidity event](#sales-and-liquidity) occurs, such as if the company is sold or goes public.

🄳 A company is in
[**liquidation overhang**](https://equityzen.com/blog/startup-valuations-and-liquidation-preference-overhang/)
when the value of the company doesn’t reach the dollar amount investors put into it.
Because of liquidation preference, those holding preferred stock (investors) will have to
be paid before those holding common stock (employees).
If investors have put millions of dollars into a company and it’s sold, employees’ equity
won’t be worth anything if the company is in liquidation overhang and the sale doesn’t
exceed that amount.[^avccom2010.zxzhsl]

☝️ The complexities of the liquidation preference are
[infamous](https://venturebeat.com/2010/08/16/beware-the-trappings-of-liquidation-preference/).
It’s worth understanding that investors and entrepreneurs negotiate a lot of the details
around preferences, including:

- The *multiple*, a number designating how many times the investor must be paid back before
  common shareholders receive proceeds.
  (Often the multiple is 1X, but it can be 2X or higher.)

- Whether preferred stock is
  [*participating*](https://en.wikipedia.org/wiki/Participating_preferred_stock), meaning
  investors get their money back and also participate in proceeds from common stock.

- Whether there is a *cap*, which limits the payout if it is participating.

- ∑
  [🔑This primer](https://medium.com/@CharlesYu/the-ultimate-guide-to-liquidation-preferences-478dda9f9332)
  by Charles Yu gives a concise overview.
  Founders and companies are affected significantly and in subtle ways by these
  considerations.
  For example, as lawyer José Ancer points out, common and preferred stockholders are
  typically quite different and their incentives
  [sometimes](http://siliconhillslawyer.com/2017/10/13/common-stock-v-preferred-stock/)
  [diverge](http://siliconhillslawyer.com/2018/02/07/board-works-common-stock/).

- 🚧 What are good resources to mention that describe conversion of preferred stock to
  common stock?

🔹 For the **purposes of an employee who holds common stock**, the most important thing to
understand about preferences is that they’re not likely to matter if a company does well
in the long term.
In that case, every stockholder has valuable stock they can eventually sell.
But if a company fails or [exits](#sales-and-liquidity) for less than investors had hoped,
the preferred stockholders are generally first in line to be paid back.
Depending on how favorable the terms are for the investor, if the company exits at a low
or modest valuation, it’s likely that common shareholders will receive little—or nothing
at all.

## How Equity Is Granted

In this section we’ll lay out how equity is granted in practice, including the
differences, benefits, and drawbacks of common types of equity compensation, including
restricted stock awards, stock options, and restricted stock units (RSUs).
We’ll go over a few less common types as well.
While the [intent](#the-goals-of-equity-compensation) of each kind of equity grant is
similar, they differ in many ways, particularly around how they are
[taxed](#taxes-on-equity-compensation).

Except in rare cases where it may be negotiable, the type of equity you get is up to the
company you work for.
In general, larger companies grant RSUs, and startups grant stock options, and
occasionally executives and very early employees get restricted stock awards.

🚧 Add section on when equity is granted, including plus-ups.

### Restricted Stock Awards

At face value, the most direct approach to equity compensation would be for the company to
award stock to an employee in exchange for work.
In practice, it turns out a company will only want to do this with restrictions on how and
when the stock is fully owned.

Even so, this is actually one of the least common ways to get equity.
We mention it first because it is the simplest form of equity compensation, useful for
comparison as things get more complex.

🄳 A **restricted stock award** is when a company grants someone stock as a form of
compensation. The stock awarded has additional conditions on it, including a vesting
schedule, so is called **restricted stock**. Restricted stock awards may also be called
simply **stock awards** or **stock grants**.

∑ What *restricted* means here is actually
[complex](https://github.com/jlevy/og-equity-compensation/issues/24). It refers to the fact
that the stock (i) has certain restrictions on it (like transfer restrictions) required
for private company stock, and (ii) will be subject to repurchase at cost pursuant to a
vesting schedule.
The repurchase right lapses over the service-based vesting period, which is what is meant
in this case by the stock “vesting.”

☝️ Restricted stock awards are
[not the same](https://www.fool.com/knowledge-center/the-difference-between-a-restricted-stock-unit-res.aspx)
thing as restricted stock units.

Typically, stock awards are limited to executives or very early hires, since once the
value of the shares increases, the tax burden of receiving them (without paying the
company for their value) can be too great for most people.
Usually, instead of restricted stock, an employee will get stock options.

### Stock Options

🄳 [**Stock options**](https://en.wikipedia.org/wiki/Employee_stock_option) are contracts that
allow individuals to buy a specified number of shares in the company they work for at a
fixed price. Stock options are the most common way early-stage companies grant equity.

🄳 A person who has received a stock option grant is not a shareholder until they
**exercise** their option, which means purchasing some or all of their shares at the strike
price. Prior to exercising, an option holder does not have voting rights.

🄳 The **strike price (or exercise price)** is the fixed price per share at which stock can
be purchased, as set in a stock option agreement.
The strike price is generally set lower (often much lower) than what people expect will be
the *future* value of the stock, which means selling the stock down the road could be
profitable.

☝️ *Stock options* is a confusing term.
In investment, an *option* is a right (but not an obligation) to buy something at a
certain price within a certain time frame.
You’ll often see stock options discussed in the context of
[investment](https://www.investopedia.com/terms/s/stockoption.asp). What investors in
financial markets call *stock options* are indeed options on stock, but they are not
*compensatory* stock options awarded for services.
In this Guide, and most likely in any conversation you have with an employer, anyone who
says “stock options” will be referring to compensatory stock options.

☝️ Stock options are not the same as stock;
they are only the *right to buy stock* at a certain price and under a set of conditions
specified in an employee’s stock option agreement.
We’ll get into these conditions next.

∑ Although everyone typically refers to “stock options” in the plural, when you receive a
stock option grant, you are receiving *an option* to purchase a given number of shares.
So technically, it’s incorrect to say someone “has 10,000 stock options.”

It’s best to understand the financial and [tax implications](#taxes-on-isos-and-nsos) before
deciding [when to exercise](#stock-option-scenarios) options.
In order for the option to be tax-free to receive, the strike price must be the fair
market value of the stock on the date the option is granted.

∑ Those familiar with
[stock trading](https://www.investopedia.com/university/stocks/stocks3.asp) (or those with
economics degrees) will tell you about the
[**Black-Scholes model**](https://www.investopedia.com/university/options-pricing/black-scholes-model.asp),
a general mathematical model for determining the value of options.
While theoretically sound, this does not have as much practical application in the context
of employee stock options.

🚧 Any real-world examples or statistics of how low strike price has led to big payoffs?
Also we could mention and relate this to the term *employee stock options (or ESOs)* and
dispel any confusion between ESOs and ESPPs.

### Vesting and Cliffs

🄳 **Vesting** is the process of gaining full legal rights to something.
In the context of compensation, founders, executives, and employees typically gain rights
to their grant of equity incrementally over time, subject to restrictions.
People may refer to their shares or stock options vesting, or may say that a person is
vesting or has fully vested.

🄳 In the majority of cases, vesting occurs incrementally over time, according to a
**vesting schedule**. A person vests only while they work for the company.
If the person quits or is terminated immediately, they get no equity, and if they stay for
years, they’ll get most or all of it.

Awards of stock, stock options, and RSUs are almost always subject to a vesting schedule.

🄳 Vesting schedules can have a **cliff** designating a length of time that a person must
work before they vest at all.

For example, if your equity award had a one-year cliff and you only worked for the company
for 11 months, you would not get anything, since you haven’t vested in any part of your
award. Similarly, if the company is sold within a year of your arrival, depending on what
your paperwork says, you may receive nothing on the sale of the company.

A very common vesting schedule is vesting over **4 years**, with a **1 year** cliff.
This means you get 0% vesting for the first 12 months, 25% vesting at the 12th month, and
1/48th (2.08%) more vesting each month until the 48th month.
If you leave just before a year is up, you get nothing, but if you leave after 3 years,
you get 75%.

🄳 In some cases, vesting may be triggered by specific events outside of the vesting
schedule, according to contractual terms called **accelerated vesting (or acceleration)**.
Two kinds of accelerated vesting that are commonly negotiated are if the company is sold
or undergoes a merger (**single trigger**) or if it’s sold and the person is fired (**double
trigger**).

🌪 Cliffs are an important topic.
When they work well, cliffs are an effective and reasonably fair system to both employees
and companies.
But they can be abused and their complexity can lead to misunderstandings:

- The intention of a cliff is to make sure new hires are committed to staying with the
  company for a significant period of time.
  However, the flip side of vesting with cliffs is that if an employee is leaving—quits or
  is laid off or fired—just short of their cliff, they may walk away with no stock ownership
  at all, sometimes through no fault of their own, as in the event of a family emergency or
  illness. In situations where companies fire or lay off employees just before a cliff, it
  can easily lead to hard feelings and even lawsuits (especially if the company is doing
  well enough that the stock is worth a lot of money).[^inccombusi.oldydy][^bloombergc.a48epn]
- 🔹 As a manager or founder, if an employee is performing poorly or may have to be laid
  off, it’s both thoughtful and wise to let them know what’s going on well before their
  cliff.
- ∑ Founders often have vesting on their stock themselves.
  As entrepreneur Dan Shapiro explains, this is often for
  [good reason](http://www.danshapiro.com/blog/2012/04/vesting-is-a-hack/).
- 🔹 As an employee, if you’re leaving or considering leaving a company before your vesting
  cliff is met, consider waiting.
  Or, if your value to the company is high enough, you might
  [negotiate](https://www.businessinsider.com/everything-you-need-to-know-about-cliff-vesting-2011-5)
  to get some of your stock “[vested up](https://www.foley.com/when-should-vesting-of-equity-grants-accelerate-06-19-2014/)”
  early. Your manager may well agree that is is fair for someone who has added a lot of
  value to the company to own stock even if they leave earlier than expected, especially for
  something like a family emergency.
  These kinds of vesting accelerations are entirely discretionary, however, unless you
  negotiated for special acceleration in an employment agreement.
  Such special acceleration rights are typically reserved for executives who negotiate their
  employment offers heavily.
- 🚧 How does taking time off, for example a leave of absence, affect the vesting schedule?
- Acceleration when a company is sold (called
  [*change of control*](http://stockoptioncounsel.com/blog/change-of-control-terms-for-startup-stock-options-restricted-stock-and-rsus/2018/6/4)
  terms) is common for founders and not so common for employees.
  It’s worth understanding acceleration and triggers in case they show up in your option
  agreement, but these may not be something you can negotiate unless you are going to be in
  a key role.
- Companies may impose additional restrictions on stock that is vested.
  For example, your shares are very likely subject to a right of first refusal, which means
  that you can’t sell the stock without offering it first to the company.
  And it can happen that companies reserve the right to
  [repurchase](https://www.forbes.com/sites/dianahembree/2018/01/10/startup-employee-alert-can-your-company-take-back-your-vested-stock-options/#75fb48ee6e49)
  vested shares in certain events.

🚧 Can we give any examples here?

### How Options Expire

🄳 The **exercise window (or exercise period)** is the period during which a person can buy
shares at the strike price.
Options are only exercisable for a fixed period of time, until they expire, typically
seven to ten years as long as the person is working for the company.
But this window is not always open.

❗ **Expiration after termination.**
Options can expire after you quit working for the company.
Often, the expiration is **90 days** after termination of service, making the options
effectively worthless if you cannot exercise before that point.
As we’ll get into later, you need to understand the costs, [taxes](#taxes-on-isos-and-nsos),
and tax [liabilities](#the-amt-trap) of exercise and to plan ahead.
In fact, you can find out when you are granted the options, or better yet, before you sign
an offer letter.

🔹 **Longer exercise windows.**
Recently (since around 2015) a few companies are finding ways to keep the exercise window
open for years after leaving a company, promoting this practice as fairer to employees.
Companies with
[extended exercise windows](https://github.com/holman/extended-exercise-windows) include
Amplitude,[^amplitudec.fvea8b] Clef,[^githubcomc.ygtolb] Coinbase,[^mediumcomb.nqs9mo] Pinterest,[^fortunecom.nnfd6o] and Quora.[^quoracomwh.4dxi02]
However, the 90-day exercise window remains the norm.

🌪 **The exercise window debate.**
Whether to have extended exercise windows has been debated at significant length.
Some believe extended exercise windows are
[the future](https://triplebyte.com/blog/extending-stock-option-exercise-window-guide#.12rv7ovrv),
arguing that a shorter window makes a company’s success a
[punishment](http://stockoptioncounsel.com/blog/nc7go8ivzxb1el5rhv6nltrjan0n2t/2017/3/6) to
early employees.

Key considerations include:

- Everyone agrees that employees holding stock options with an expiring window often have to
  make a painful choice if they wish to leave:
  Pay for a substantial tax bill (perhaps five to seven figures) on top of the cost to
  exercise (possibly looking for [secondary liquidity or a loan](#can-you-sell-private-stock))
  or walk away from the options.
- Many familiar with this situation have spoken out
  [forcefully](https://zachholman.com/posts/fuck-your-90-day-exercise-window/) against shorter
  exercise windows, arguing that an employee can help grow the value of a company
  substantially—often having taken a lower salary in exchange for equity—but end up with
  [no ownership](https://triplebyte.com/blog/fixing-the-inequity-of-startup-equity) because
  they’re unable or unwilling to stay for the several years [typically needed](#ipos) before an
  IPO or sale.
- On the other side, a few companies and investors
  [stand by](https://a16z.com/2016/06/23/options-timing/) the existing system, arguing that it
  is better to incentivize people not to leave a company, or that long windows effectively
  transfer wealth from employees who commit long-term to those who leave.
- Some focused on the legalities also argue that it’s a legal requirement of ISOs to have a
  90-day exercise window.
  While this is technically true, it’s not the
  [whole story](https://news.ycombinator.com/item?id=9254299). It is possible for companies to
  extend the exercise window by changing the nature of the options (converting them from
  ISOs to NSOs) and [many companies](https://github.com/holman/extended-exercise-windows) now
  choose to do just that.
- Another path is to
  [split the difference](http://stockoptioncounsel.com/blog/early-expiration-of-startup-stock-options-part-2-the-full-10-year-term-solution/2017/3/28)
  and give extended windows only to longer-term employees.
- Taken together, it’s evident many employees have not been clear on the nuances of this
  when joining companies, and some have
  [🔑suffered](https://medium.com/@ben_mathes/90-days-and-my-six-figure-mistake-a495f4a188e2)
  because of it.
  With the risks of short exercise windows for employees becoming more widely known, longer
  exercise windows are gradually becoming more prevalent.
  As an employee or a founder, it is fairer and wiser to understand and negotiate these
  things up front, and avoid unfortunate surprises.

☝️ Options granted to advisors typically vest over a shorter period than employee grants,
often one to two years.
Advisor grants also typically have a longer exercise window post termination of service,
and will usually have single trigger acceleration on an acquisition, because no one
expects advisors to stay on with a company once it’s acquired.
Typical terms for advisors, including equity levels, are available in the
[📥Founder/Advisor Standard Template (FAST)](https://fi.co/contents/fast#), from the Founder
Institute.

### Kinds of Stock Options

🄳 Compensatory stock options come in two flavors, **incentive stock options (ISOs)** and
**non-qualifying stock options (NQOs, or NQSOs)**. Confusingly, lawyers and the IRS use
[several names](https://www.irs.gov/taxtopics/tc427) for these two kinds of stock options,
including **statutory stock options** and **non-statutory stock options (or NSOs)**,
respectively.

In this Guide, we refer to ISOs and NSOs.

| Type | Also called |
| - | - |
| Statutory | Incentive stock option, ISO |
| Non-statutory | Non-qualifying stock option, NQO, NQSO, NSO |

- Companies generally decide to give ISOs or NSOs depending on the legal advice they get.
  It’s rarely up to the employee which they will receive, so it’s best to know about both.
  There are pros and cons of each from both the recipient’s and the company’s perspective.
- ISOs are common for employees because they have the possibility of being more favorable
  from a tax point of view than NSOs.
- 🔸 ISOs can only be granted to employees (not independent contractors or directors who are
  not also employees).
- But ISOs have a number of limitations and conditions and can also create difficult
  [tax consequences](#taxes-on-isos-and-nsos).

### Early Exercise

🄳 Sometimes, to help reduce the tax burden on stock options, a company will make it
possible for option holders to **early exercise (or forward exercise)** their options, which
means they can exercise even before they vest.
The option holder becomes a stockholder sooner, after which the vesting applies to actual
stock rather than options.
This will have [tax implications](#83b-elections).

🔸 However, the company has the right to repurchase the *unvested* shares, at the price
paid or at the fair market value of the shares (whichever is lower), if a person quits
working for the company.
The company will typically repurchase the unvested shares should the person leave the
company before the stock they’ve purchased vests.

### Restricted Stock Units

While stock options are the most common form of equity compensation in smaller private
companies, RSUs have become the most common type of equity award for public and large
private companies.
Facebook pioneered the use of RSUs as a private company to allow it to avoid having to
register as a public company earlier.

🚧 Why? More links on history of RSUs and Facebook story?

🄳
[**Restricted stock units (RSUs)**](http://www.investopedia.com/terms/r/restricted-stock-unit.asp)
refer to an agreement by a company to issue an employee shares of stock or the cash value
of shares of stock on a future date.
Each unit represents one share of stock or the cash value of one share of stock that the
employee will receive in the future.
(They’re called *units* since they are neither stock nor stock options, but another thing
altogether that is contractually linked to the value of stock.)

🄳 The date on which an employee receives the shares or cash payment for RSUs is known as
the **settlement date**.

- 🔸 RSUs may vest according to a vesting schedule.
  The settlement date may be the time-based vesting date or a later date based on, for
  instance, the date of a company’s IPO.
- RSUs are difficult in a startup or early stage company because when the RSUs vest, the
  value of the shares might be significant, and taxes will be owed on the receipt of the
  shares.[^thestartup.tn6iyt] This is not a bad result when the company has sufficient capital to help the
  employee make the tax payments, or the company is a public company that has put in place a
  program for selling shares to pay the taxes.
  But for cash-strapped private startups, neither of these are possibilities.
  This is the reason most startups use stock options rather than RSUs or stock awards.
- RSUs are often considered less preferable to grantees since they remove control over when
  you owe tax. Options, if granted with an exercise price equal to the fair market value of
  the stock, are not taxed until exercise, an event under the control of the optionee.
  If an employee is awarded an RSU or restricted stock award which vests over time, they
  will be taxed on the vesting schedule;
  they have been put on “autopilot” with respect to the timing of the tax event.
  If the shares are worth a lot on the date of vesting, the tax burden can be significant.
- ☝️ You don’t want to confuse *restricted stock units* with *restricted stock*, which
  typically refers to restricted stock awards.

### Less Common Types of Equity

While most employee equity compensation takes the form of stock, stock options, or RSUs, a
complete tour of equity compensation must mention a few less common forms.

🄳 **Phantom equity** is a type of compensation award that references equity, but does not
entitle the recipient to actual ownership in a company.
These awards come under a variety of different monikers, but the key to understanding them
is knowing that they are really just cash bonus plans, where the cash amounts are
determined by reference to a company’s stock.
Phantom equity can have significant value, but may be perceived as less valuable by
workers because of the contractual nature of the promises.
Phantom equity plans can be set up as purely discretionary bonus plans, which is less
attractive than owning a piece of something.

Two examples of phantom equity are phantom stock and stock appreciation rights:

🄳 A
[**phantom stock**](http://www.investopedia.com/articles/stocks/12/introduction-phantom-stock.asp)
award is a type of phantom equity that entitles the recipient to a payment equal to the
value of a share of the company’s stock, upon the occurrence of certain events.

🄳
[**Stock appreciation rights (SARs)**](https://www.nceo.org/articles/phantom-stock-appreciation-rights-sars)
are a type of phantom equity that gives the recipient the right to receive a payment
calculated by reference to the appreciation in the equity of the company.

🚧 Elaboration needed on what events typically trigger phantom stock.
More data on how rare these are?
And what is appreciation?

🄳 [**Warrants**](https://en.wikipedia.org/wiki/Warrant_%28finance%29) are another kind of option
to purchase stock, generally used in investment transactions (for example, in a
convertible note offering, investors may also get a warrant, or a law firm may ask for one
in exchange for vendor financing).
They differ from stock options in that they are more abbreviated and stand-alone legal
documents, not granted pursuant to a single legal agreement (typically called a “[plan](#documents-and-agreements)”)
for all employees.

Employees and advisors may not encounter warrants, but it’s worth knowing they exist.

## Tax Basics

The awarding of equity compensation can give rise to multiple types of taxes for the
recipient, including federal and state income taxes and employment taxes.
There’s a lot that you have to be aware of. [Skip ahead](#taxes-on-equity-compensation) to
understand how taxes on equity work, but if you have time, this section gives a technical
summary of tax fundamentals, just in case you never really figured out all the numbers on
your pay stub.

You don’t need to know every detail, and can rely on software and professionals to
determine the tax you owe, but we do suggest understanding the different kinds of taxes,
how large they can be, and how each is “triggered” by different events.

Given the complexity, most taxpayers aren’t aware of exactly how their tax is calculated.
It does take up thousands of pages[^slatecomar.qqwwen] of the federal tax code and involves the intricate
diversity of state tax law as well.[^gpogovfdsy.clz3vr]

☝️ If you’re already familiar with tax terminology, this section may not have any major
surprises. But for those who are not used to it, watch out:
Many terms sound like regular English, but they’re not. *Ordinary income*, *long-term* and
*short-term*, *election*, *qualified small business*, and other phrases have very specific
meanings we’ll do our best to spell out.

### Kinds of Income

🄳 **Income** is the money an individual makes.
For tax purposes, there are two main types of income, which are taxed differently.
[**Ordinary income**](https://www.investopedia.com/terms/o/ordinaryincome.asp) includes wages,
salary, bonuses and interest made on investments.
[**Capital gains**](https://www.investopedia.com/terms/c/capital_gains_tax.asp) are the profits an
individual makes from selling assets, including stock.

One key difference between ordinary income and capital gains is that when capital gains
taxes are calculated, consideration is given not just to the sale price of the asset but
to the total gain or loss the investment incurred, each outcome having significantly
different tax consequences.

🄳 Capital gains are classified as long-term or short-term. **Long-term capital gains** are
the profits an individual makes from selling assets, such as stock, a business, a house,
or land, that were held for more than a year. **Short-term capital gains** are profits from
the sale of assets held for less than a year.

Although this topic is not without
[💰controversy](https://www.wsj.com/articles/how-should-capital-gains-be-taxed-1425271052),
the general idea is, if you are selling something you’ve owned for a long time, you can be
taxed a lower rate.

All these rates have evolved over time based on economic and political factors,[^taxpolicyc.sjye20] so you
can be confident they will change again in the future.

📰 In 2017, Congress passed the
[Tax Cuts and Jobs Act](https://en.wikipedia.org/wiki/Tax_Cuts_and_Jobs_Act_of_2017) (TCJA),
which made
[many changes](https://heritageinvestment.com/wp-content/uploads/2018/01/TCJA-HIG-Old-vs.-New-Comparison.pdf)
to tax rates for the **2018** tax year.
Long-term capital gains taxes did
[not change](https://www.marketwatch.com/story/your-simple-guide-to-the-new-capital-gains-tax-rates-2018-04-16)
significantly.

🚧 Can we clarify the term *investment income* too?

### Federal Taxes

🄳 **Income tax** is the money paid by individuals to federal, state, and, in some cases,
local governments, and includes taxation of ordinary income and capital gains.
Generally, U.S. citizens, residents, and some
[foreigners](https://www.irs.gov/individuals/international-taxpayers/nra-withholding) must
[file](https://www.irs.gov/pub/irs-pdf/p17.pdf) and pay federal income tax.

🔹 In general, federal tax applies to many
[kinds of income](https://www.irs.gov/taxtopics/tc400.html). If you’re an employee at a
startup, you need to consider four kinds of federal tax, each of which is computed
differently.

☝️ When it comes to equity compensation, it’s possible that you’ll have to worry about
*all of these*, depending on your situation.
That’s why we have a lot to cover here:

🄳 **Ordinary income tax** is the tax on wages or salary income, and short-term investment
income. The term **short-term capital gains tax** may be applied to taxes on assets sold
less than a year from purchase, but profits from these sales are taxed as ordinary income.
For a lot of people who make most of their money by working, ordinary income tax is the
biggest chunk of tax they pay.

🄳 **Employment taxes** are an additional kind of federal tax beyond ordinary income tax,
and consist of Social Security and
[Medicare taxes](https://www.irs.gov/businesses/small-businesses-self-employed/questions-and-answers-for-the-additional-medicare-tax)
that are withheld from a person’s paycheck.
Employment taxes are also referred to as
[**payroll taxes**](https://en.wikipedia.org/wiki/Payroll_tax) as they often show up on employee
pay stubs. The Social Security wage withholding rate in 2018 is 6.2% up to the FICA wage
base. The Medicare component is 1.45%, and it does not phase out above the FICA wage base.

- 🚧 Review and add more links on SS and Medicare taxes.

🄳 **Long-term capital gains tax** is a tax on the sale of assets held longer than a year.
Long-term capital gains tax is often lower than ordinary income tax.
Many investors hold assets for longer than a year in order to qualify for the lesser tax
burden of long-term capital gains.

🄳 **Alternative minimum tax (AMT)** is a
[supplemental income tax](https://en.wikipedia.org/wiki/Alternative_minimum_tax) that applies
to certain individuals in some situations.
This type of tax does not come up for many taxpayers, but higher income earners and people
in special situations may have to pay large AMT bills.
AMT was first enacted in 1979 in response to reports that 155 wealthy individuals had paid
no income tax in 1966.[^taxpolicyc.mgorf1] It is not the same as ordinary income tax or employment tax, and
is calculated according to its
[own rules](https://www.nerdwallet.com/blog/taxes/alternative-minimum-tax-amt/).

🚧 What is the history and motivation of AMT?

❗ AMT is relevant to you if you’re reading this.
It’s important to understand because exercising ISOs can trigger AMT. In some cases a *lot*
of AMT, *even when you haven’t sold the stock* and have no money to pay.
We discuss this [later](#the-amt-trap).

#### Figure: Bracke Rates, Income, and Taxes

```hlwy-infographics
{
  "name": "TaxRates",
  "data": {
    "rates": [
      {
        "rate": 0.1,
        "single": 0,
        "married": 0,
        "hoh": 0
      },
      {
        "rate": 0.12,
        "single": 9525,
        "married": 19050,
        "hoh": 13600
      },
      {
        "rate": 0.22,
        "single": 38700,
        "married": 77400,
        "hoh": 51800
      },
      {
        "rate": 0.24,
        "single": 82500,
        "married": 165000,
        "hoh": 82500
      },
      {
        "rate": 0.32,
        "single": 157500,
        "married": 315000,
        "hoh": 157500
      },
      {
        "rate": 0.35,
        "single": 200000,
        "married": 400000,
        "hoh": 200000
      },
      {
        "rate": 0.37,
        "single": 500000,
        "married": 600000,
        "hoh": 500000
      }
    ],
    "deductions": {
      "single": 0,
      "married": 0,
      "hoh": 0
    }
  }
}
```

```hlwy-infographics
{
  "name": "TaxRates",
  "data": {
    "rates": [
      {
        "rate": 0,
        "single": 0,
        "married": 0,
        "hoh": 0
      },
      {
        "rate": 0.15,
        "single": 38600,
        "married": 77200,
        "hoh": 51700
      },
      {
        "rate": 0.2,
        "single": 425801,
        "married": 479001,
        "hoh": 452401
      }
    ],
    "deductions": {
      "single": 0,
      "married": 0,
      "hoh": 0
    }
  }
}
```

🄴 *Source: IRS and the
[Tax Foundation](https://files.taxfoundation.org/20180207142513/TaxFoundation-FF567-Updated.pdf)*

A bit on how all this fits together:

- Ordinary income tax applies in the situations you’re probably already familiar with, where
  you pay taxes on [salaries or wages](https://www.irs.gov/taxtopics/tc401.html). Tax rates are
  based on [filing status](https://www.irs.gov/newsroom/choosing-the-correct-filing-status) (if
  you are single, married, or support a family), and on which
  [**income bracket**](https://taxfoundation.org/2018-tax-brackets) you fall under.
- **Income brackets.**
  For ordinary income, as of the **2018** tax year, there are income brackets at **10%**, **12%**,
  **22%**, **24%**, **32%**, **35%**, and **37%**
  [marginal tax rates](http://www.investopedia.com/terms/m/marginaltaxrate.asp)—see
  [Notice 1036](https://www.irs.gov/pub/irs-pdf/n1036.pdf) or a Tax Foundation
  [summary](https://files.taxfoundation.org/20180207142513/TaxFoundation-FF567-Updated.pdf). Be
  sure you understand how these brackets work, and what bracket you’re likely to be in.
  - ☝️ There is a popular misconception that if you move to a higher bracket, you’ll make less
    money.[^todayyougo.tyjmz8] What actually happens is when you cross certain thresholds, each additional
    (marginal) dollar you make is taxed at a slightly higher rate, equal to the bracket you’re
    in. After you earn more than your deduction, on which you pay no tax, your post-tax income
    looks like the diagram above.
    (More discussion on such misconceptions are in
    [this Reddit thread](https://www.reddit.com/r/personalfinance/comments/2wkbgz/graphing_one_misconception_about_tax_brackets/).)
- Investment gains, such as buying and selling a stock, are similarly taxed at “ordinary”
  rates, unless they are [**long-term**](https://www.irs.gov/taxtopics/tc409.html), which means you
  held the asset for more than a year.
- You also pay a number of other federal taxes (see a
  [📥2018 summary for all states](https://www.adp.com/tools-and-resources/compliance-connection/state-taxes/2018-fast-wage-and-tax-facts.aspx)),
  notably:
  - **6.2%** for Social Security on your first $118,500
  - **1.45%** for Medicare
  - **0.9%**
    [Additional Medicare Tax](https://www.irs.gov/Businesses/Small-Businesses-&-Self-Employed/Questions-and-Answers-for-the-Additional-Medicare-Tax)
    on income over $200,000 (single) or $250,000 (married filing jointly)
  - **3.8%**
    [Net Investment Income Tax](https://www.irs.gov/uac/Newsroom/Net-Investment-Income-Tax-FAQs)
    (NII) (enacted as part of the Affordable Care Act,[^taxpolicyc.w7dds7] also called “Obamacare”) on
    investment income if you make over $200,000 (single) or $250,000 (married filing jointly).[^investoped.s08hcp]
- Ordinary federal income tax, Social Security, and Medicare taxes are withheld from your
  paycheck by your employer and are called
  [**employment taxes**](https://www.irs.gov/Businesses/Small-Businesses-&-Self-Employed/Understanding-Employment-Taxes).
- 🔹 Long-term capital gains are taxed at a lower rate than ordinary income tax: **0%**, **15%**,
  or **20%**.[^foolcomtax.ox10ej] This covers cases where you get dividends or sell stock after holding it a
  year. If you are in the middle brackets (more than about $37K and less than $413K of
  ordinary income), your long-term capital gains rate is 15%. You can find more detail on
  tax brackets at the [Tax Foundation](https://taxfoundation.org/2018-tax-brackets/).
- [AMT](http://fairmark.com/general-taxation/alternative-minimum-tax/alternative-minimum-tax-101/)
  is a [complex part](https://www.irs.gov/taxtopics/tc556.html) of the federal tax code most
  taxpayers don’t worry about.
  But it comes into play when [exercising ISOs](#the-amt-trap). Most people do not pay AMT
  unless it is “triggered” by specific
  [situations](https://www.marketwatch.com/story/meet-the-new-friendlier-alternative-minimum-tax-2018-02-26),
  typically high income (more than $500K) or high deductions.
  Whether you pay AMT also depends on the state in which you file, since your state taxes
  can significantly affect your deductions.
  If you are affected, AMT tax rates are usually at **26%** or **28%** marginal tax rate, but
  effectively **35%** for some ranges, meaning it is higher than ordinary income tax for some
  incomes and lower for others.[^foolcomtax.3ka4p1]
  AMT rules are so complicated you often need professional tax help if they might apply to
  you. The IRS’s
  [AMT Assistant](https://www.irs.gov/Businesses/Small-Businesses-&-Self-Employed/Alternative-Minimum-Tax-(AMT)-Assistant-for-Individuals)
  might also help.
- 🔹 [Section 1202](https://www.investopedia.com/terms/s/section-1202.asp) of the Internal
  Revenue Code provides a special tax break for qualified small business stock held for more
  than five years.[^blogwealth.3vcf24]
  Currently, this tax break is a 100% exclusion from income for up to $10M in gain.
  There are also special rules that enable you to rollover gain on qualified small business
  stock you have held for less than five years.
  Stock received on the exercise of options can qualify for the Section 1202 stock benefit.
- 🚧 Fill in details on QSBS. Move this elsewhere?
  Good readings on this?

### State Taxes

State tax rates and rules
[vary significantly](https://taxfoundation.org/state-individual-income-tax-rates-brackets-2018/).
Since federal rates are much higher than state rates, you usually think of federal tax
planning first.
But you should also know a bit about tax rates in your state.

State long-term capital gains rates range widely.
California has the highest, at **13.3%**; several states have none.[^foolcomper.bw6uel]

🔹 For this reason, some people even
[consider moving](https://www.forbes.com/sites/robertwood/2016/05/17/can-you-avoid-california-taxes-by-moving/#316bd9471694)
to another state if they are likely to have a windfall gain, like selling a lot of stock
after an IPO.

🚧 How do you determine to what state you owe taxes?
Any good resources on this?

## Taxes on Equity Compensation

Equity and taxes interact in complicated ways, and the tax consequences for an employee
receiving restricted stock, stock options, or RSUs are dramatically different.
This section will cover these messy details and help you make decisions that reduce the
tax burden of your equity compensation.

### 83(b) Elections

This section covers one of the most important and complex decisions you may need to make
regarding stock awards and stock options:
paying taxes early with an 83(b) election.

- Generally, restricted stock is taxed as ordinary income
  [*when it vests*](http://www.investopedia.com/articles/tax/09/restricted-stock-tax.asp?performancelayout=true).
- If the stock is in a startup with low value, this may not result in high tax.
  If it’s been years since the stock was first granted and the company is now worth a lot,
  the taxes owed could be quite significant.

🄳 The Internal Revenue Code, in
[Section 83(b)](https://www.law.cornell.edu/uscode/text/26/83), offers taxpayers receiving
equity in exchange for work the option to pay taxes on their options before they vest.
If qualified, a person can tell the IRS they prefer this alternative in a process called
an
[**83(b) election**](http://acceleratedvesting.com/what-is-an-83b-election-and-when-do-i-make-it-part-1-with-graphic/).
Paying taxes early with an 83(b) election can potentially reduce taxes significantly.
If the shares go up in value, the taxes owed at vesting might be far greater than the
taxes owed at the time of receipt.

- ☝️ Why is it called an *election*? Because you are *electing* (choosing) to pay taxes
  early in exchange for this treatment by the IRS. Does the IRS secretly enjoy making simple
  concepts sound confusing?
  We’re not sure.
- An 83(b) election isn’t guaranteed to reduce your taxes, however.
  For example, the value of the stock may not increase.
  And if you leave the company before you vest, you *don’t* get back the taxes you’ve
  already paid.
- ❗ You must file the 83(b) election yourself with the IRS
  [**within 30 days**](https://www.irs.gov/irb/2012-28_IRB/ar12.html) of the grant or exercise, or
  the opportunity is irrevocably lost.
- ☝️ Note an 83(b) election is made on receipt of actual shares of stock.
  Technically, it cannot be made on the receipt of a stock *option* itself:
  You first must exercise that option, then file the election.
- If you receive an early exercisable stock option (when you don’t have to wait for the the
  stock to vest), you can make an 83(b) election upon receipt of the exercised shares.
- Section 83(b) elections do not apply to vested shares;
  the election only applies to stock that is not yet vested.
  Thus, if you receive options that are *not* early exercisable (meaning you have to wait
  until they vest to exercise), an 83(b) election would not apply.
- 🔹 Founders and very early employees will almost always want to do an 83(b) election upon
  the receipt of unvested shares, since the stock value is probably low.
  If the value is really low, and the taxes owed are not that great, you can make the
  election without having to pay much tax and start your capital gains holding period on the
  shares.
- 🚧 Clarify here which types of equity compensation the 83b can apply to.

📰 With the passage of the
[Tax Cuts and Jobs Act](https://en.wikipedia.org/wiki/Tax_Cuts_and_Jobs_Act_of_2017) (TCJA) in
2017, Congress approved a
[**new Section 83(i)**](https://www.wsgr.com/WSGR/Display.aspx?SectionName=publications/PDFSearch/wsgralert-section-83i.htm)
that is intended to allow deferral of tax until RSU and stock option holders can sell
shares to pay the tax bill.
Whether companies will choose or be able to make this available to employees is
[not clear](http://stockoptioncounsel.com/blog/tax-deferred-option-exercises-under-the-new-section-83i-tax-cuts-and-jobs-act-of-2017)
yet.

### 409A Valuations

When a person’s stock vests, or they exercise an option, the IRS determines the tax that
person owes. But if no one is buying and selling stock, as is the case in most startups,
then the value of the stock—and thus any tax owed on it—is not obvious.

🄳 The **fair market value (FMV)** of any good or property refers to a price upon which the
buyer and seller have agreed, when both parties are willing, knowledgeable, and not under
direct pressure to carry out the exchange.
The fair market value of a company’s stock refers to the price at which a company will
issue stock to its employees, and is used by the IRS to calculate how much tax an employee
owes on any equity compensation they receive.
The FMV of a company’s stock is determined by the company’s most recent 409A valuation.

🄳 A
[**409A valuation**](http://www.fenwick.com/FenwickDocuments/409_Valuations_Stock_Options.pdf) is
an assessment private companies are required by the IRS to conduct regarding the value of
any equity the company issues or offers to employees.
A company wants the 409A to be low, so that employees make more off options, but not so
low the IRS won’t consider it reasonable.
In order to minimize the risk that a 409A valuation is manipulated to the benefit of the
company, companies hire independent firms to perform 409A valuations, typically annually
or after events like fundraising.

The 409A valuation of employee equity is usually much less than what investors pay for
preferred stock;
often, it might be only a third or less of the preferred stock price.

🌪 Although the 409A process is required and completely standard for startups, the
practice is a strange mix of formality and complete guesswork.
It has been called “quite precise—remarkably inaccurate,” by venture capitalist Bill
Gurley. You can read more about its
[nuances and controversies](https://www.nytimes.com/2017/03/08/business/dealbook/valuation-shell-game-silicon-valleys-dirty-secret.html).

- 🚧 More on when 409As happen.

  - A 409A does have to happen every 12 months to grant the company safe harbor.
  - A 409A has to be done after any event that could be deemed a “material event,” which is a
    fancy way of saying any event that could change the price or value of the company
    meaningfully. Other examples could be if a CEO leaves, if the company starts making a ton
    of money, or an acquisition.

- ∑ “FMV” is a legal term defined in Supreme Court Case 546,
  [United States vs. Cartwright](https://scholar.google.com/scholar_case?case=4964174066744569590&hl=en&as_sdt=6&as_vis=1&oi=scholarr#p551).

- ∑ “409A” is a reference to the
  [section](https://en.wikipedia.org/wiki/Internal_Revenue_Code_section_409A) of the Internal
  Revenue Code that sets requirements for options to be tax-free on grant.

### Taxes on ISOs and NSOs

Typically, early to mid-stage companies grant stock options, which may be
[ISOs or NSOs](#kinds-of-stock-options).

- ❗When you get stock options and are considering if and when to exercise, you need to think
  about the taxes and **when you owe them**. In principle, you need to think about taxes you
  may incur at three points in time:
  - at **time of grant**
  - at **time of exercise**
  - at **time of sale**
- These events trigger ordinary tax (high), long-term capital gains (lower), or AMT
  (possibly high) taxes in different ways for NSOs and ISOs.

🄳 The taxes at time of exercise will depend on the gain between the strike price and the
FMV, known as the **spread** or the
[**bargain element**](http://www.investorwords.com/5414/bargain_element.html).

- 🔹 If you’re granted ISOs or NSOs at a low strike price, and the bargain element is zero,
  then you may be able to exercise at a reasonable price without triggering taxes at all.
  So assuming the company allows it, it makes sense to early exercise *immediately* (buying
  most or all of the shares, even though they’re not vested yet) and simultaneously file an
  83(b) election.
- 🔸 An 83(b) election, as already discussed, is the choice to be taxed on the receipt of
  property even though you might have to forfeit or give back the property to the company.
  You can make an election on the receipt of stock, but you cannot make the election on the
  receipt of a stock option or an RSU because options and RSUs are not considered property
  for the purposes of Section 83(b).
- 🚧 Move or remove this note, as it’s covered earlier?
- 🔸 ISOs are often preferred by startups, as they’re supposedly better for employees from a
  tax perspective.
  This assumes that (1) AMT won’t be triggered and (2) you’ll get a low long-term capital
  gains rate by holding the stock for the appropriate holding periods.
  However, often you either run afoul of the AMT trap, or don’t hold the stock long enough
  with the complicated 1 year + 2 year requirement, or the spread at exercise is small or
  zero, so the difference wouldn’t matter anyway.
  NSOs do have a slightly higher tax because of the need to pay employment taxes on NSOs and
  not ISOs.
- 🌪 Overall, it’s not clear the ISO is that much better for employees, so
  [many people](http://www.business2community.com/finance/nsos-better-isos-0826167#fz1HTCiOQxRyTr62.97)
  argue [for NSOs](http://www.startuplawblog.com/2010/08/11/top-reasons-nqos-over-isos/)
  instead.
- ☝️ This is partly because ISOs can make it harder to meet the long-term capital gains
  holding period.[^thestartup.25gj0l]
  Many people expect early exercise, together with an 83(b) election, will help them hold
  the stock long enough to qualify for long-term capital gains.
  While this is true for NSOs, a murky part of the rules on ISOs states that even with an
  83(b) election, the capital gains holding period does not begin until the shares actually
  vest. So if you want to immediately exercise an option and file a Section 83(b) election,
  and you might have liquidity soon, it’s better—for those who can—to do so with NSOs.

### The AMT Trap

When it comes to taxes and equity compensation, one scenario is so dangerous we give it
its own section.

❗ If you have received an ISO, exercising it may unexpectedly trigger a big AMT bill—even
before you actually make any money on a sale!
If there is a large spread between the strike price and the 409A valuation, you are
potentially on the hook for an enormous tax bill, even if you can’t sell the stock.
This has pushed people into bankruptcy.
It also caused Congress to grant a one-time forgiveness, the odds of which happening again
are very low.

🄳 The catastrophic scenario where exercising ISOs triggers a large AMT bill, with no
ability to sell the stock to pay taxes, is sometimes called the **AMT trap**. This
[infamous](https://www.nceo.org/articles/stock-options-alternative-minimum-tax-amt) problem
has trapped many employees and
[bankrupted](http://blog.sfgate.com/dgreenberg/2012/06/22/tax-advice-from-the-dot-com-bubble-beware-of-isos/)
people during past dot-com busts.
Now more people know about it, but it’s still a significant obstacle to plan around.

📰 In 2017, Congress passed the
[Tax Cuts and Jobs Act](https://en.wikipedia.org/wiki/Tax_Cuts_and_Jobs_Act_of_2017) (TCJA),
which increases AMT exemptions and their phaseout thresholds.
This means fewer people will be affected by AMT in 2018 than in prior years.[^mediumcomb.57vdab]

Note that if your AMT applies to events prior to 2008, you’re
[off the hook](http://www.startuplawblog.com/2009/04/03/whoops-i-didnt-pay-amt-on-my-isos-exercised-prior-to-1108-what-do-i-do/).

Understand this topic and talk to a professional if you exercise ISOs.
The AMT trap does not apply to NSOs.

🚧 Links to coverage on Congress’s forgiveness?

### Stock Awards vs. ISOs vs. NSOs

Because the differences are so nuanced, what follows is a summary of the taxes on
restricted stock awards, ISOs, and NSOs, from an employee’s point of view.

- **Restricted stock awards.**
  Assuming vesting, you pay full taxes early with the 83(b) or at vesting:

  - At grant:
    - if 83(b) election filed, ordinary tax on FMV
    - none otherwise
  - At vesting:
    - none if 83(b) election filed
    - ordinary tax on FMV of vested portion otherwise
  - At sale:
    - long-term capital gains tax on gain if held for **1 year** past when taken into income
    - ordinary tax otherwise (including immediate sale)

- **NSOs.** You pay full taxes at exercise, and the sale is like any investment gain:

  - At grant and vesting:
    - no tax if granted at FMV
  - At exercise:
    - ordinary tax on the bargain element
    - income and employment tax withholding on paycheck
  - At sale:
    - long-term capital gains tax on gain if held for **1 year** past exercise
    - ordinary tax otherwise (including immediate sale)

- **ISOs.** You might pay less tax at exercise, but it’s complicated:

  - At grant and vesting:
    - no tax if granted at FMV
  - At exercise:
    - **AMT tax event** on the bargain element
    - no ordinary or capital gains tax
    - no income or employment tax withholding on paycheck
  - At sale:
    - long-term capital gains if held for **1 year** past exercise and **2 years** past grant date
    - ordinary tax otherwise (including immediate sale)

Mary Russell, a lawyer who specializes in equity compensation, recommends each form of
equity be used at the appropriate time in private companies:
restricted stock awards for the earliest stage of a startup, stock options with longer
exercise windows for the early to mid stage, and RSUs for the later stages.[^stockoptio.z54l1t]

If you relish tax complexity, you can learn more from:

- The [Tax Topics](https://www.irs.gov/taxtopics/tc427.html) coverage of ISOs and NSOs from the
  IRS
- Joe Wallin’s posts on the Startup Law Blog, “[Top 6 Reasons To Grant NQOs Over ISOs](http://www.startuplawblog.com/2010/08/11/top-reasons-nqos-over-isos/)”
  and “[Incentive Stock Options vs. Nonqualified Stock Options](http://www.startuplawblog.com/2013/05/15/incentive-stock-options-vs-nonqualified-stock-options/)”
- Investopedia’s post “[Get the Most Out of Employee Stock Options](http://www.investopedia.com/articles/optioninvestor/07/esoabout.asp)”
- EquityZen’s summary of the topic, “[Understanding Equity Compensation And What It Means For Startup Employees](https://equityzen.com/blog/understanding-equity-compensation-for-startup-employees/)”

### Taxes on RSUs

If you are awarded RSUs, each unit represents one share of stock that you will be given
when the units vest.

- Here’s the tax summary for RSUs:
  - At grant:
    - no tax
  - At vesting/delivery:
    - ordinary tax on current share value
  - At sale:
    - long-term capital gains tax on gain if held for **1 year** past vesting
    - ordinary tax otherwise (including immediate sale)
- 🔸 When you receive your shares, you are taxed on their value at that time.[^joewallinc.8eaojr]
  If you are an employee, this means you may have to write a check to the company to cover
  your income and employment tax withholding.
  Often, for U.S. employees, companies will withhold the tax in the form of shares such that
  no action is required by the employee at vesting time.[^schwabcomp.94cuxl]
- If you receive an RSU when the stock is of little value, you cannot elect to be taxed on
  the value of that stock when you receive the RSU—you pay taxes at vesting time, based on
  the value of the shares at that time.
- 🔸 RSUs present some big problems in private companies:
  - You will owe tax when you receive the shares, even though they are illiquid.
  - You can’t minimize the tax impact of an increase in value of the underlying shares between
    the date you receive the RSU and the date it is settled.
  - If you are an employee you will have to write a check to the company to satisfy your
    income and employment tax withholding.
- 🔸 RSUs are less attractive than stock options from a tax point of view because you cannot
  make an 83(b) election with respect to RSUs.
  By contrast, if you receive a stock option, as long as it’s priced at fair market value
  you will have no income upon receipt of the options, and your income tax and employment
  tax consequences will be deferred until you exercise, an event under your control for the
  most part.

### Tax Comparison Table

#### Table: Comparing Taxes on Types of Equity Compensation

This table is a summary of the differences in taxation on types of equity compensation.

| | Restricted stock awards | ISOs | NSOs | RSUs |
| - | - | - | - | - |
| *Tax at grant* | If 83(b) election filed, ordinary tax on FMV. None otherwise. | No tax if granted at FMV. | No tax if granted at FMV. | No tax. |
| *Tax at vesting* | None if 83(b) election filed. Ordinary tax on FMV of vested portion otherwise. | No tax if granted at FMV. | No tax if granted at FMV. | Ordinary tax on current share value. |
| *Tax at exercise* | | AMT tax event on the bargain element. No ordinary or capital gains or employment tax. | Ordinary tax on the bargain element. Income and employment tax. | |
| *Tax at sale* | Long-term capital gains tax on gain if held for **1 year** past when taken into income. Ordinary tax otherwise (including immediate sale). | Long-term capital gains if held for **1 year** past exercise and **2 years** past grant date. Ordinary tax otherwise (including immediate sale). | Long-term capital gains if held for **1 year** past exercise. Ordinary tax otherwise (including immediate sale). | Long-term capital gains tax on gain if held for **1 year** past vesting. Ordinary tax otherwise (including immediate sale). |

### Tax Dangers

Because they are so important, we list some costly errors to watch out for when it comes
to taxes on equity compensation:

- ❗ If you are going to file an 83(b) election, it must be **within 30 days** of stock grant
  or option exercise.
  Often, law firms will take a while to send you papers, so you might only have a week or
  two. If you miss this window, it could potentially have giant tax consequences, and is
  essentially an irrevocable mistake—it’s one deadline the IRS won’t extend.
  When you file, get documentation from the post office as well as a delivery confirmation,
  and include a self-addressed, stamped envelope for the IRS to send you a return receipt.
  (Some people are so concerned about this they even ask a friend to go with them to the
  post office as a witness!)
- ❗ Watch out for the AMT trap we’ve already discussed.
- ❗ If you exercise your options, and your income had been from consulting rather than
  employment (1099, not W-2), you will be subject to the
  [self-employment tax](https://www.irs.gov/businesses/small-businesses-self-employed/self-employment-tax-social-security-and-medicare-taxes),
  which consist of both the employer and the employee side of FICA. In addition to owing the
  normal income tax, this means you will owe the Social Security tax component (**6.2%**) up
  to the FICA wage base, and you will owe the Hospital Insurance component (**2.9%**) on all
  of your income.
- ❗ Thoughtfully decide when to exercise options.
  As discussed, if you wait until the company is doing really well, or when you are leaving,
  the delay can have serious downsides.

## Plans and Scenarios

### Evaluating Equity Compensation

Once you understand the [types of equity](#how-equity-is-granted) and their
[tax implications](#taxes-on-equity-compensation), you have many of the tools you need to
evaluate an offer that includes equity compensation, or to evaluate equity you currently
have in a company.

In summary, you have to determine or make educated guesses about several things:

- **Equity value.** This can be estimated by the value the company may have in the future, and
  the number of shares you may own.
  - **Percentage ownership.**
    As we’ve mentioned, knowing how many shares of stock or stock options you have is
    meaningless unless you know the number of outstanding shares.
    What matters is the percentage ownership of the company the shares represent, including
    the [details](#counting-shares) of how the total is counted.
  - **Risk.** It is critical to understand [risk](#stages-of-a-startup) in the business and dilution
    to ascertain the possible future value of equity.
    [This article](http://codingvc.com/valuing-employee-options/) from Leo Polovets provides some
    additional thoughts.
- **Vesting.** Understand [when](#vesting-and-cliffs) you will receive the equity, as well as
  whether you’re able to exercise stock options (and pay the associated costs and taxes),
  and whether you can do all this before your exercise window expires.
- **Liquidity.** Determine when you will be able to [sell your shares](#sales-and-liquidity), and
  if that is likely to be for a profit at that time.
  (We talk about liquidity of private stock next.)
- **Tax.** [Tax concerns](#taxes-on-equity-compensation) are inseparable from the value of equity.
  Know the tax implications of your possible grant, exercise, vesting, and sale, in terms of
  ordinary income tax, employment tax, long-term capital gains, and alternative minimum tax.

That’s a lot, and even so, decisions are uncertain, but it is possible to make much more
informed decisions once you have this information.

### What Is Private Stock Worth?

We now turn to the question of determining the value of private company stock.
We’ve seen how stock in private companies often [can’t be sold](#can-you-sell-private-stock),
so its value is
[difficult to estimate](https://www.investopedia.com/articles/fundamental-analysis/11/valuing-private-companies.asp).

The value of equity you cannot yet sell is a reflection of three major concerns:

1. How well the company is doing now—that is, how profitable it is, or how many customers it
   is attracting.
2. How well the company will perform in the future.
3. How likely it is the company will be valuable as part of another company—that is, whether
   it may be [acquired](#sales-and-liquidity).

The first concern is relatively clear, if you know the company’s financials.
The second and third come down to predictions and are never certain.
In fact, it’s important to understand just how uncertain all three of these estimations
are, depending on the stage of the company.

In earlier stage private companies, there may be little or no profit, but the company may
seem valuable because of high expectations that it can make future profit or be acquired.
If a company like this takes money from investors, the investors determine the price they
pay based on these educated guesses and market conditions.

In startups there tends to be a high degree of uncertainty about the future value of
equity, while in later stage private companies financials are better understood (at least
to investors and others with an inside view of the company), and these predictions are
often more certain.

### Can You Sell Private Stock?

Ultimately, the value of your equity depends on whether and when you are able to convert
it into stock that you sell for cash.
With public companies, the answer is relatively easy to estimate—as long as there are no
restrictions on your ability to sell, you know the current market value of the stock you
own or might own.
What about private companies?

A liquidity event is usually what makes it possible for shareholders in a private company
to sell their stock.
However, individuals may sometimes be able to gain liquidity while a company is still
private.

🄳 A **secondary market (or secondary sale, or private sale)** transaction is when private
company stock [is sold](https://www.cooleygo.com/secondary-sales-of-private-company-stock/)
to another private party.
This is in contrast to **primary market** transactions, where companies sell directly to
investors. Secondary sales are not routine, but they can sometimes occur, such as when an
employee sells to an accredited investor who wants to invest in the company.

🄳 Shares held by an employee are typically subject to a **right of first refusal (ROFR)**
in favor of the company, meaning the employee can’t sell their shares to a third party
without offering to sell their shares to the company first.

🔸 Private sales generally require the agreement and cooperation of the company, for both
contractual and practical reasons.
While those who hold private stock may hope or expect they need only find a willing buyer,
in practice secondary sales only work out in
[a few situations](https://venturebeat.com/2016/12/19/secondary-market-for-shares-in-pre-ipo-unicorns-is-booming/).

Unlike a transaction on a public exchange, the buyer and seller of private company stock
are not in total control of the sale.
There are a few reasons **why companies may not support secondary sales**:

- Historically, startups have seen little purpose in letting current employees sell their
  stock, since they prefer employees hold their stock and work to make it more valuable by
  improving the value of the company as a whole.
- Even if employee retention is not a concern, there are reasons private sales may not be in
  the company’s interest.
  Former employees and other shareholders often have difficulty initiating secondary
  transactions with a company.[^wsjcomarti.vm6qmp]
  Private buyers may ask for the company’s internal financials in order to estimate the
  current and future value of its stock;
  the company may not wish to share this confidential information.
- Companies must
  [consider](https://www.square1bank.com/insights/new-normal-secondaries-409a-valuation-process/)
  whether sales could influence their [409A valuation](#409a-valuations).
- Secondary sales are an administrative and legal burden that may not make it to the top of
  the list of priorities for busy startup CEOs and CFOs.

🔹 However, participation in the secondary market has evolved in recent years,[^techcrunch.qn7usd][^industryve.6prupc][^mediumcomr.ez02hw] and **a few
options may be possible**:

- [SharesPost](http://sharespost.com/), [Equidate](https://www.equidateinc.com/), and
  [EquityZen](https://equityzen.com/) have sought to establish a market around secondary sales,
  particularly for well-known pre-IPO companies.
- A few other secondary firms have emerged that have interest in certain purchases,
  especially for larger secondary sales from founders, early employees, or executives.
  A company can work with a firm to facilitate multiple transactions.
  These firms include [137 Ventures](http://137ventures.com/),
  [ESO Fund](https://employeestockoptions.com/),
  [Akkadian Ventures](https://www.akkadianventures.com/),
  [Industry Ventures](http://www.industryventures.com/), [Atlas Peak](http://www.atlaspeakcap.com/),
  and [Founders Circle](http://www.founderscircle.com/).
- In some cases, an employee may have luck selling stock privately to an individual, like a
  board member or former executive, who wishes to increase their ownership.
  Further discussion can be found
  [on Quora](https://www.quora.com/How-do-employees-in-startups-sell-stock-in-the-secondary-markets).

### Stock Option Scenarios

The key decisions around stock options are when to exercise and, if you can, when to sell.
Here we lay out some common scenarios that might apply to you.
Considering these scenarios and their outcomes can help you evaluate your position and
decide what you should do.

- **Exercise and hold.**
  You can write the company a check and pay any taxes on the spread.
  You are then a stockholder, with a stock certificate that may have value in the future.
  As [discussed](#how-equity-is-granted), you may exercise:
  - Early, even immediately upon grant.
  - Before vesting (if early exercise is available to you).
  - Sometime after vesting.
  - After leaving the company, as long as the exercise window is open.
    - 🔸 Recall that the window is likely to [close soon](#how-options-expire) after you leave a
      company, often 90 days after termination.
- **Wait until acquisition.**
  If the company is acquired for a large multiple of the exercise price, you may then use
  your options to buy valuable stock.
  However, as discussed, your shares could be worth next to nothing unless the sale price
  exceeds the liquidation overhang.
- 🔸 **Secondary market.**
  As [discussed](#can-you-sell-private-stock), in some cases it’s possible to exercise and
  sell the stock in a private company directly to a private party.
  But this generally requires some cooperation from the company and is not something you can
  always count on.
- **Cashless exercise.**
  In the event of an IPO, a broker can allow you to exercise all of your vested options and
  immediately sell a portion of them into the public market, removing the need for cash up
  front to exercise and pay taxes.

🔹 Note that some of these scenarios may require significant cash up front, so it makes
sense to do the math early.
If you are in a tight spot, where you may lose valuable options altogether because you
don’t have the cash to exercise, it’s worth exploring each of the scenarios above, or
combinations of them, such as exercising and then selling a portion to pay taxes.
In addition, there are a [few funds](#can-you-sell-private-stock) and individual investors
who may be able to front you the cash to exercise or pay taxes in return for an agreement
to share profits.

Author and programmer Alex MacCaw
[explores](https://blog.alexmaccaw.com/an-engineers-guide-to-stock-options#exercising_2) a few
more detailed scenarios.

🚧 Infographic:
Possible visualization of these exercise options.
A flowmap? “If this, then this” (with arrows).

### Summary of Dangers

Because of their importance, we’ll wind up with a recap of some of the key dangers we’ve
discussed when thinking about equity compensation:

- ❗ When it comes to equity compensation, details matter!
  You need to understand the type of stock grant or stock option in detail, as well as what
  it means for your taxes, to know what your equity is worth.
- ❗ Because details are so important, [professional advice](#seeking-professional-advice) from
  a tax advisor or lawyer familiar with equity compensation (or both) is often a good idea.
  Avoid doing everything yourself, but also avoid blindly trusting advisors without having
  them explain the details to you in a way you understand.
- ❗ With stock options, high exercise costs or high taxes, including the AMT trap, may
  prevent you from exercising your options.
  If you can’t sell the stock and your exercise window is limited, you could effectively be
  forced to walk away from your stock options.
- ❗ If a job offer includes equity, you need a lot of information to understand the value of
  the equity component.
  If the company trusts you enough to be making an offer but doesn’t want to answer
  questions about that offer, consider it a warning sign.
  Next, we offer more details on what to ask about your offer, and how to negotiate to get
  the answers you want.

## Offers and Negotiations

When a company offers any form of equity as part of its compensation package, there is a
whole new set of factors for a prospective employee to consider.
This chapter will help you prepare for negotiating a job offer that includes equity,
covering negotiation tips and expectations, and specific reminders on what you can ask and
what is negotiable when it comes to equity.

### Why Negotiation Matters

Before accepting any job offer, you’ll want to negotiate
[firmly and fairly](http://cefne.com/en/harvard-method-negotiation). You’re planning to devote
a lot of your time and sanity to any full-time role;
help yourself make sure that this is
[💰what you want](https://hbr.org/2016/12/think-strategically-about-your-career-development).

☝️ It’s perfectly natural to be
[anxious](https://www.pon.harvard.edu/daily/negotiation-skills-daily/the-impact-of-anxiety-and-emotions-on-negotiations-how-to-avoid-misjudgment-in-negotiation-scenarios/)
about negotiations, whether you’re going through this process for the first time or the
tenth. There is a lot at stake, and it can be uncomfortable and stressful to ask for
things you need or want.
Many
[people think](https://www.forbes.com/sites/tanyatarr/2017/12/31/here-are-five-negotiation-myths-we-can-leave-behind-in-2017/#250ff99b15f9engaging)
negotiating could get the job offer revoked, so they’ll accept their offer with little or
no discussion.
But remember that negotiations are the first experience you’ll have of working with your
new team. If you’re nervous, it can help to remind yourself why it’s important to have
these conversations:

- Negotiations ask you to focus on what you actually want.
  What is important to you—personal growth, career growth, impact, recognition, cash,
  ownership, teamwork?
  Not being clear with yourself on what your priorities really are is a recipe for
  dissatisfaction later.
- If you aren’t satisfied with the terms of your offer, accepting it without discussion can
  be tough not just for you but for your new company and colleagues as well.
  No one wants to take on a hire who’s going to walk away in just a few months when
  something better comes along.
  For everyone’s sake, take your time now to consider what you want—and then
  [ask for it](https://www.earnest.com/decision-making/articles/negotiating-job-offers-science-asking-want).
- The negotiation process itself can teach you a lot about a company and your future
  manager. Talking about a tough subject like an offer is a great way to see how you’ll work
  with someone down the road.

A Guide like this can’t give you personalized advice on what a reasonable offer is, as
that depends greatly on your skills, the marketplace of candidates, what other offers you
have, what the company can pay, what other candidates the company has found, and the
company’s needs.
But we can cover the basics of what to expect with offers, and advise candidates on how to
approach negotiations.

### Equal Treatment

🔹 Companies can and should work hard to ensure that all candidates are given
[equal treatment](https://rework.withgoogle.com/guides/pay-equity/steps/introduction/) in the
hiring process, but inequalities persist.[^iwprorgpub.1ukyxt]
Workplace disparities in pay and opportunity span race and gender,[^digitalcom.k5w0oc] with research
focusing on inequality in the U.S. workplace,[^pewresearc.dws8o8] executive leadership and its
well-documented lack of diversity,[^aflcioorgp.6v6p19][^fortunecom.87hw00] and the technology industry.[^eeocgoveeo.9aynwh]
Gender bias in negotiation itself is also an issue;
many women have been made to feel that they shouldn’t ask for what they deserve.[^newyorkerc.mdcz9c]

More effort is needed to end biases and close the wage gap.
All candidates should take the time to understand their worth and the specific value they
can add to a company, so that they are fully prepared to negotiate for a better offer.

### General Expectations

- Many companies will give some leeway during [negotiations](#negotiation-tips), letting you
  indicate whether you prefer
  [higher salary](https://hired.com/blog/candidates/salary-vs-equity-how-decide-whats-right/) or
  [higher equity](https://www.investopedia.com/articles/personal-finance/041515/equity-vs-salary-what-you-need-know.asp).
- Candidates with competing offers almost always have more leverage and get better offers.[^shrmorgres.qv3vrf]
- Salaries at startups are often a bit below what you’d get at an established company, since
  early on, cash is at a premium.
  For very early stage startups, risk is higher, offers can be more highly variable, and
  variation among companies will be greater, particularly when it comes to equity.
- The dominant factors [determining equity](#typical-employee-equity-levels) are what funding
  [stage](#stages-of-a-startup) a company is at, and the role you’ll play at the company.
  If no funding has been raised, large equity may be needed to get early team members to
  work for very little or for free.
  Once significant funding of an A round is in place, most people will take typical or
  moderately discounted salaries.
  Startups with seed funding lie somewhere in between.

### Offers

🄳 When making a job offer, companies will often give a candidate a **verbal offer** first,
to speed things along and facilitate the negotiation, following it with a **written offer**
if it seems like the candidate and the company are close to agreement on the terms of the
offer. The written offer takes the form of an
[📥**offer letter**](https://www.upcounsel.com/employee-offer-letter), which is just the summary
sent to the candidate, typically with an expiration date and other details and
[paperwork](#documents-and-agreements).

Although companies often want you to sign right away to save time and effort, if you’re
doing it thoughtfully you’ll also be talking to the company (typically with a hiring
manager, your future manager, or a recruiter, or some combination) multiple times before
signing. This helps you negotiate details and gives you a chance to get to know the people
you could be working with, the company, and the role, so that you can make the best
decision for your personal situation.

When you are ready to accept the terms of the offer letter, you can go ahead and sign.

Things to look for in the
[offer letter](https://www.glassdoor.com/blog/how-to-read-offer-letter/) include:

- **Title and level.**
  What your role is officially called, who you report to, and what level of seniority your
  role is within the company.
- **Salary.** What you’re paid in cash, in a year, before taxes.
- **Equity compensation.**
  You know what this is now.
- **Bonus.** Additional cash you’ll get on a regular basis, if the company has a plan for this.
- **[Signing bonus](https://www.investopedia.com/terms/s/signing-bonus.asp).** Cash you get just
  for signing. (Signing bonuses usually have some strings attached—for example, you could
  have to pay back the bonus if you leave the company within 12 or 24 months.)

While the details may not be included in your offer letter, to get full information on
your total rewards you’ll also want to discuss:

- [Benefits](https://en.wikipedia.org/wiki/Employee_benefits) like health insurance, retirement
  savings, and snacks.
- All other aspects of the job that might matter to you, like time off, ability to work from
  home, flexible hours, training and education, and so on.

A few general notes on these components (credits to
[Cristina Cordova](https://twitter.com/cjc/status/984094472190349312) for some of these):

- Early stage startups will focus on salary and equity and (if they are funded) benefits.
  An offer of bonuses or a signing bonus are more common in larger, prosperous companies.
- Bonuses are usually standardized to the company and your level, so are not likely to be
  something you can negotiate.
- The signing bonus is highly negotiable.
  This doesn’t mean any company will give large signing bonuses, but it’s feasible because
  signing bonus amounts vary candidate by candidate, and unlike salary and other bonuses,
  it’s a one-time cost to the company.

### Offers From Startups

Because startups are so much smaller than many established companies, and because they may
grow quickly, there are additional considerations worth taking into account when
negotiating a job offer from a startup:

- **Cash versus equity.**
  If your [risk tolerance](https://www.investopedia.com/terms/r/risktolerance.asp) is
  reasonably high, you might ask for an offer with more equity and less cash.
  If a company begins to do well, it’ll likely “level up” lower salaries (bringing them
  closer to market average) even if you got more equity up front.
  On the other hand, if you ask for more cash and less equity, it’s unlikely you’ll be able
  to negotiate to get more equity later on, since equity is increasingly scarce over time
  (at least in a successful company!). Entrepreneur and venture capitalist
  [Mark Suster](https://en.wikipedia.org/wiki/Mark_Suster) stresses the need to
  [level up](https://bothsidesofthetable.com/this-is-how-startups-level-up-after-raising-money-328d17076515)
  by scaling pay and spending, focusing appropriately at each funding stage.
  In the very early days of a startup, it’s not uncommon for employees to have higher
  salaries than the company’s founders.[^siliconhil.1wd4aa]
- 🚧 What is risk and how should people think about risk tolerance?
  Good readings on this?
- **Title.** Negotiating title and exact details of your role early on may not matter as much
  in a small and growing company, because your role and the roles of others may change a
  lot, and quickly.
  It’s more important that you respect the founders and leaders of the company.
  It’s more important that you feel you are
  [respected](https://blog.shrm.org/blog/respect-and-trust-top-the-list-of-most-important-employee-job-satisfaction).

### Questions Candidates Can Ask

🔹 It’s important to ask questions when you get an offer that includes any kind of equity.
In addition to helping you learn the facts about the equity offer, the process of
discussing these details can help you get a sense of the company’s transparency and
responsiveness.
Here are a few questions you should consider asking, especially if you’re evaluating an
offer from a startup or another private company:

- **Percentage ownership.**
  - *What percentage of the company do the shares represent?*
  - *What set of shares was used to compute that percentage?
    Is it outstanding shares or fully diluted?*
  - *What convertible securities are outstanding (convertible notes, SAFEs, or warrants), and
    how much dilution can I expect from their conversion?*
- **Valuation.**
  - *What did the last round value the company at?
    (That is, what is the preferred share price times the total outstanding shares?)*
  - *What is the most recent 409A valuation?
    When was it done, and will it be done again soon?*
  - *What exit valuation will need to be achieved before common stock has positive value (that
    is, what are the liquidation overhangs)?*
- **Stock options.**
  - *Do you allow early exercise of my options?*
  - *Am I required to exercise my options within 90 days after I leave or am terminated?
    Does the company extend the exercise window of the options of employees that depart?*
- **Vesting.**
  - *Are all employees on the same vesting schedule?*
  - *Is there any acceleration of my vesting if the company is acquired?*
  - *Do you have a policy regarding follow-on stock grants?*
  - *Does the company have any repurchase right to vested shares?*

This information will help you consider the benefits and drawbacks of possible
[exercise scenarios](#stock-option-scenarios).

🔹 If you’re considering working for a startup, there are further questions to ask in
order to assess the state of the company’s business and its plans.
Before or when you’re getting an offer is the right time to do this.
Startups are understandably careful about sharing financial information, so you may not
get full answers to all of these, but you should at least ask:

- *How much money has the company raised (including in how many rounds, and when)?*
- *What did the last round value the company at?*
- *What is the aggregate liquidation preference on top of the preferred stock?*
  (This will tell you how much the company needs to sell for before the common stock—your
  equity—is worth something in an exit.)
- *Will the company likely raise more capital soon?*
- *How long will the company’s current funding last?*
  (This will likely be given at the current burn rate, or how quickly a company is spending
  its funding, so will likely not include calculations for things like future employee
  salaries.)
- *What is the hiring plan?
  (How many people over what time frame?)*
- *What is the revenue now, if any?
  What are the revenue goals/projections?*
- *Where do you see this company in 1 year and 5 years, in terms of revenue, number of
  employees, and market position?*

There are several other
[resources](https://blog.wealthfront.com/stock-options-14-crucial-questions/) with
[more questions](http://www.inc.com/atish-davda/5-questions-you-should-ask-before-taking-a-start-up-job-offer.html)
like this to consider.

🚧 Summarize the best items in the links above.

### Typical Employee Equity Levels

🚧 This section currently mostly covers startups;
what later-stage resources are available?

Compensation data is highly situational.
What an employee receives in equity, cash, and benefits depends on the role they’re
filling, the sector they work in, where they and the company are located, and the possible
value that specific individual may bring to the company.

Any compensation data out there is hard to come by.
Companies often pay for this data from
[vendors](https://www.advanced-hr.com/products-overview), but it’s usually not available to
candidates.

For startups, a variety of data is easier to come by.
We give some overview here of early-stage Silicon Valley tech startups;
many of these numbers are not representative of companies of different kinds across the
country:

- 🔹 One of the best ways to tell what is reasonable for a given company and candidate is to
  look at offers from companies with similar profiles on [AngelList](https://angel.co/). The
  [**AngelList salary data**](https://angel.co/salaries) is extensive.
- There are no hard and fast rules, but for **post-series A startups** in **Silicon Valley**,
  the table below, based on
  [the one by Babak Nivi](http://venturehacks.com/articles/option-pool-shuffle#market), gives
  ballpark equity levels that many think are reasonable.
  These would usually be for restricted stock or stock options with a standard 4-year
  vesting schedule.
  They apply if each of these roles were filled just after an A round and the new hires are
  also being paid a salary (so are not founders or employees hired before the A round).
  The upper ranges would be for highly desired candidates with strong track records.
  - Chief executive officer (CEO): **5–10%**
  - Chief operating officer (COO): **2–5%**
  - Vice president (VP): **1–2%**
  - Independent board member: **1%**
  - Director: **0.4–1.25%**
  - Lead engineer **0.5–1%**
  - Senior engineer: **0.33–0.66%**
  - Manager or junior engineer: **0.2–0.33%**
- For **post-series B startups**, equity numbers would be much lower.
  How much lower will depend significantly on the size of the team and the company’s
  valuation.
- Seed-funded startups would offer higher equity—sometimes much higher if there is little
  funding, but base salaries will be lower.
- Leo Polovets created a
  [survey](http://codingvc.com/analyzing-angellist-job-postings-part-2-salary-and-equity-benchmarks)
  of AngelList job postings from 2014, an excellent summary of equity levels for the first
  few dozen hires at these early-stage startups.
  For **engineers** in Silicon Valley, the highest (not typical!)
  equity levels were:
  - Hire #1: up to **2%–3%**
  - Hires #2 through #5: up to **1%–2%**
  - Hires #6 and #7: up to **0.5%–1%**
  - Hires #8 through #14: up to **0.4%–0.8%**
  - Hires #15 through #19: up to **0.3%–0.7%**
  - Hires #21 [sic] through #27: up to **0.25%–0.6%**
  - Hires #28 through #34: up to **0.25%–0.5%**
- José Ancer gives another good
  [overview](http://siliconhillslawyer.com/2018/05/08/early-startup-employee-compensation/) for
  early stage hiring.
- *Founder* compensation is another topic entirely that may still be of interest to
  employees. José Ancer provides a thoughtful
  [overview](http://siliconhillslawyer.com/2016/06/23/founder-compensation-cash-equity-liquidity/).

### Negotiation Tips

🚧 Structure: Move negotiation points earlier?

When negotiating a job offer, companies will always ask you what you want for
compensation, and you should always be
[cautious](http://review.chicagobooth.edu/strategy/2018/article/how-answer-one-toughest-interview-questions)
about answering.

If you name the lowest number you’ll accept, you can be pretty sure the company’s not
going to exceed it, at least not by much.

🔸 Asking about salary expectations is a normal part of the hiring process at most
companies, but asking about **salary history** has been banned in a growing number of
states, cities, and counties.[^hrdivecomn.56fguz]
These laws attempt to combat pay disparity[^nytimescom.yev52k] among women and minorities by making it
illegal for companies to ask about or consider candidates’ current or past compensation
when making them offers.
Make sure you understand the laws relevant to your situation.

A few points on negotiating compensation:

- Some argue that a
  [good tactic](http://www.businessinsider.com/how-to-negotiate-make-first-offer-2014-5) in
  negotiating is to start higher than you will be willing to accept, so that the other party
  can “win” by negotiating you down a little bit.
  Keep in mind, this is just a suggested tactic, not a hard and fast rule.
- If you are inexperienced and unsure what a fair offer should look like, avoid saying
  exactly what you want for compensation very early in discussions.
  Though many hiring managers and recruiters ask about
  [salary expectations](http://fistfuloftalent.com/2018/01/ask-salary-without-asking-salary-expectations.html)
  early in the process to avoid risk at the offer stage, some ask in order to take
  advantage of candidates who don’t have a good sense of
  [their own worth](https://nuleadership.com/2018/01/08/know-your-worth-compensation-negotiation/).
  Tell them you want to focus on the opportunity as a whole and your ability to contribute
  before discussing numbers.
  Ask them to give you a fair offer once they understand what you can bring to the company.
- If you are experienced and know your value, it’s often in your interest to state what sort
  of compensation and role you are looking for to anchor expectations.
  You might even share your expectations early in the process, so you don’t waste each
  other’s time.
- Discuss what your compensation might be like in the future.
  No one can promise you future equity, salary, or bonuses, but it should be possible to
  agree what those could look like *if* you demonstrate outstanding performance and the
  company has money.
- If you’re moving from an established company to a startup, you may be asked to take a
  [salary cut](https://www.quora.com/Should-you-take-a-salary-cut-if-you-join-a-startup). This
  is reasonable, but it’s wise to discuss explicitly how much the cut is, and when your
  salary will be renegotiated.
  For example, you might take 25% below your previous salary, but there can be an agreement
  that this will be corrected if your performance is strong and the company gets funding.
- 🔹 Always negotiate
  [non-compensation](http://www.kennedyexecutive.com/blog/salary-negotiation-33-things-negotiate-money/)
  aspects before agreeing to an offer.
  If you want a specific role, title, opportunity, visa sponsorship, parental leave, special
  treatment (like working from home), or have timing constraints about when you can join,
  [negotiate these early](https://www.nerdwallet.com/blog/loans/student-loans/negotiate-nonsalary-benefits-job-perks/),
  not late in the process.
- 🔹 If you’re going to be a very early employee, consider asking for a restricted stock
  grant instead of stock options, and a cash bonus equal to the tax on those options.
  The company will have some extra paperwork (and legal costs), but it means you won’t have
  to pay to exercise.
  Then, if you file an 83(b) election, you’re simplifying your situation even further,
  eliminating the [AMT issues](#the-amt-trap) of ISOs, and maximizing your chances of
  qualifying for long-term capital gains tax.
- 🚧 What other *specific* suggestions are helpful?

A few notes on the negotiation process itself:

- 🔹 Although offer letters have expirations, it’s often possible to negotiate more time if
  you need it. How much flexibility depends on the situation.
  Some have criticized “exploding job offers” as a
  [bad practice](https://www.huffingtonpost.com/adam-grant/its-time-to-eliminate-exp_b_4594222.html)
  that makes [no sense](https://erikbern.com/2016/03/16/exploding-offers-are-bullshit.html) at
  all. If you are likely the best candidate for the position, or the role is a specialized
  and well-paid one where there are usually not enough good candidates to meet the demand,
  you’ll likely have plenty of leverage to
  [ask for more time](http://www.businessinsider.com/how-to-politely-postpone-accepting-a-job-offer-2015-6#dont-be-afraid-to-negotiate-4),
  which may be needed to complete the interview process with other companies.
  Software engineering roles in tech companies are like this currently.
- Getting
  [multiple offers](https://www.themuse.com/advice/a-guide-to-juggling-multiple-job-offers-and-coming-out-on-top)
  is always in your interest.
  If you have competing offers, sharing the competing offers with the company you want to
  work for can be helpful, granted your offers are competitive.
  - However, dragging out negotiations excessively so you can “shop around” an offer to other
    companies is considered bad form by some;
    it’s thoughtful to be judicious and timely to the extent that it’s possible.
- ❗ Get all agreements in writing, if they are not in your offer letter.
- Do not accept an offer verbally or in writing unless you’re ready to stand by your word.
  In practice, people do occasionally accept an offer and then go back on it, or
  [*renege*](https://purduecco.wordpress.com/2016/03/28/the-risks-of-reneging-on-a-job-offer/).
  This can put the company in a difficult position (they may have declined another key
  candidate based on your acceptance), and may hurt your reputation in unexpected ways
  later.

Some additional resources:

- Harvard Business Review has a variety of general
  [💰suggestions](https://hbr.org/2014/04/15-rules-for-negotiating-a-job-offer) on negotiation
  processes.
- Robby Grossman, a VP at Wistia, gives a good
  [overview](http://rob.by/2013/negotiating-your-startup-job-offer) of equity compensation and
  negotiation suggestions in startups.

### Offer and Negotiation Dangers

To wind up our discussion of offers and negotiations, here are some key dangers and
mistakes to watch out for:

- ❗ Do not accept an offer of stock or shares without also asking for the exact number of
  total shares (or, equivalently, the exact percentage of the company those shares
  represent). It’s quite common for some companies to give offers of stock or options and
  tell you only the number of shares.
  Without the percentage, the number of shares is meaningless.
  Not telling you is a deeply unfair practice.
  A company that refuses to tell you even when you’re ready to sign an offer is likely
  giving you a very poor deal.
- 🔸 If you’re looking at an offer, work out whether you can and should early exercise, and
  what the cost to exercise and tax will be, before accepting the offer.
- ❗ If you join a startup right as it raises a new round, and don’t have the chance to
  exercise right away, they may potentially issue you the options with the low strike price,
  but the 409A valuation of the stock will have gone up.
  This means you won’t be able to early exercise without a large tax bill.
  In fact, it might not be financially feasible for you to exercise at all.
- ❗ Vesting starts on a vesting commencement date.
  Sometimes stock option paperwork won’t reach you for weeks or months after you join a
  company, since it needs to be written by the lawyers and approved by the board of
  directors. In your negotiations, do make sure the vesting commencement date will reflect
  the true start date of when you joined the company, not the time at which the stock option
  is granted.
- 🔸 The offer letter is not the actual grant of your equity.
  After you sign your offer letter, ensure the company delivers you your actual equity grant
  documents within a few weeks.
  It is not uncommon for early-stage startups to be sloppy with their equity granting.
  If they take too long to send your grant documents, the fair market value (and exercise
  price) of the equity could rise in the time you’re waiting, which is money lost for you.
- 🔸 If you’re going to early exercise, consider it like any investment.
  Don’t believe every projection about the value of the company you hear.
  Founders will tell you the best-case scenario.
  Remember, most startups fail.
  Do your research and ask others’ opinions about likely outcomes for the company.
- ❗ It may not be common, but some companies retain a right to repurchase (buy back) vested
  shares. It’s simple enough to ask, “Does the company have any repurchase right to *vested*
  shares?” (Note repurchasing *unvested* shares that were purchased via early exercise is
  different, and helps you.)
  If you don’t want to ask, the fair market value repurchase right should be included in the
  documents you are being asked to sign or acknowledge that you have read and understood.
  (Skype’s
  [controversy](https://techcrunch.com/2011/06/26/skypes-worthless-employee-stock-option-plan-heres-why-they-did-it/)
  related to repurchasing has some startup employees
  [looking out](https://www.quora.com/Which-valley-startups-have-a-Skype-like-repurchase-right)
  for companies with similar plans.)
  You might find a repurchase right for vested shares in the Stock Plan itself, the Stock
  Option Agreement, the Exercise Agreement, the bylaws, the certificate of incorporation, or
  any other stockholder agreement.

## Documents and Agreements

This section covers a few kinds of documents you’re likely to see as you negotiate a job
offer and sign on to a company.
It’s not exhaustive, as titles and details vary.

- When you are considering your offer, make sure you have all of the documents you need from
  the company:
  - Your [📥offer letter](https://www.upcounsel.com/employee-offer-letter), which will detail
    salary, benefits, and equity compensation.
  - An
    [📥Employee Innovations Agreement](https://recruit.smashfly.com/SmashFlyMedia/Docs/12250/12250_168_United%20States%20-%20EIPIA%20English%20%28Rev%2014%20FEBRUARY%202017%29%202%20pages.pdf),
    Proprietary Information and Inventions Assignment Agreement, or similar, concerning
    intellectual property.
- If you have equity compensation, at some point—possibly weeks or months after you’ve
  joined—you should get a Summary of Stock Grant, Notice of Stock Option Grant, or similar
  document, detailing your grant of stock or options, along with all details such as number
  of shares, type of options, grant date, vesting commencement date, and vesting schedule.
  It will come with several other documents, which may be exhibits to that agreement:
  - [📥Stock Option Agreement](https://www.upcounsel.com/stock-option-agreement)
  - [📥Stock Plan](https://www.upcounsel.com/equity-incentive-plan) (sometimes called a Stock
    Option Plan, or Stock Award Plan, or Equity Incentive Plan)
  - [📥Code Section 409A Waiver and Release](https://www.lawinsider.com/clause/code-section-409a-waiver-and-release)
    (sometimes part of the Stock Option Agreement)
- If you are exercising your options, you should also see paperwork to assist with that
  purchase:
  - [📥Exercise Agreement](https://www.upcounsel.com/option-exercise-agreement)
  - Instructions and template for early exercise and
    [📥83(b) election](https://www.irs.gov/pub/irs-drop/rp-12-29.pdf), if applicable
- End of year tax documents

  - You should receive a form
    [📥3921 or 3922](https://www.irs.gov/uac/form-3921-exercise-of-an-incentive-stock-option-under-section-422-b)
    from your company if you exercised ISO options during the year.

## Further Reading

The resources here are a small subset of the full set of resources cited in the Guide to
Equity Compensation, selected for their breadth, notability, or depth on specific issues.

### General Resources

- Mark P. Cussen, Investopedia,
  [*Introduction To Incentive Stock Options*](http://www.investopedia.com/articles/stocks/12/introduction-incentive-stock-options.asp),
  updated 2017.
- Alex MacCaw,
  [*An Engineer’s Guide to Stock Options*](http://blog.alexmaccaw.com/an-engineers-guide-to-stock-options),
  2013.
- Andy Rachleff, Wealthfront,
  [*The 14 Crucial Questions about Stock Options*](https://blog.wealthfront.com/stock-options-14-crucial-questions),
  2014.
- Mary Russell, Stock Option Counsel,
  [*Startup Equity Standards: A Guide for Employees*](http://www.slideshare.net/StockOptionCnsl/startup-standards-stock-option-counsel),
  2014.
- David Weekly,
  [ 💰*An Introduction to Stock & Options for the Tech Entrepreneur or Startup Employee*](https://www.scribd.com/doc/55945011/An-Introduction-to-Stock-Options-for-the-Tech-Entrepreneur-or-Startup-Employee#scribd),
  2012.
- Investopedia,
  [*Employee Stock Options: Definitions and Key Concepts*](http://www.investopedia.com/university/employee-stock-options-eso/eso1.asp).

### Considerations for Founders

- Matthew Bartus, Cooley GO,
  [*Option Grants: Fully Diluted or Issued and Outstanding*](https://www.cooleygo.com/option-grants-fully-diluted-issued-outstanding/).
- Jay Bhatti, Business Insider,
  [*How Startups Should Deal With Cliff Vesting For Employees*](http://www.businessinsider.com/everything-you-need-to-know-about-cliff-vesting-2011-5),
  2011.
- Tahir J. Naim, Fenwick,
  [*Section 409A Valuations and Stock Option Grants for Start-up Technology and Life Science Companies*](http://www.fenwick.com/FenwickDocuments/409_Valuations_Stock_Options.pdf).
- Babak Nivi, Venture Hacks
  [*The Option Pool Shuffle*](http://venturehacks.com/articles/option-pool-shuffle) (and
  [table of equity](http://venturehacks.com/articles/option-pool-shuffle#market) ranges), 2017.
- Leo Polovets,
  [*Analyzing AngelList Job Postings, Part 2: Salary and Equity Benchmarks*](http://codingvc.com/analyzing-angellist-job-postings-part-2-salary-and-equity-benchmarks),
  2014.
- Beth Scheer, Homebrew, [Compensation at Startups](https://quip.com/HEB3Ah9dYD6o).
- Scott Edward Walker, VentureBeat,
  [*Beware the trappings of liquidation preference*](http://venturebeat.com/2010/08/16/beware-the-trappings-of-liquidation-preference/),
  2010.
- Joe Wallin, The Startup Law Blog,[*Top 6 Reasons To Grant NQOs Over ISOs*](http://www.startuplawblog.com/2010/08/11/top-reasons-nqos-over-isos/),
  2010.
- Clerky, [*Legal Concepts for Founders*](https://handbook.clerky.com/).

### Considerations for Candidates and Employees

- Anonymous,
  [*What I Wish I’d Known About Equity Before Joining A Unicorn*](https://gist.github.com/yossorion/4965df74fd6da6cdc280ec57e83a202d),
  2017.
- Atish Davda, Inc,
  [*5 Questions You Should Ask Before Accepting a Startup Job Offer*](http://www.inc.com/atish-davda/5-questions-you-should-ask-before-taking-a-start-up-job-offer.html),
  2014.
- Julia Evans,
  [*Things you should know about stock options before negotiating an offer*](http://jvns.ca/blog/2015/12/30/do-the-math-on-your-stock-options/),
  2015.
- Guy Kawasaki, [*Nine Questions to Ask a Startup*](http://guykawasaki.com/nine_questions_/),
  2006.
- Sheelah Kolhatkar, The New Yorker,
  [*The Tech Industry’s Gender-Discrimination Problem*](https://www.newyorker.com/magazine/2017/11/20/the-tech-industrys-gender-discrimination-problem),
  2017.
- Eileen Patten, Pew Research Center,
  [*Racial, gender wage gaps persist in U.S. despite some progress*](http://www.pewresearch.org/fact-tank/2016/07/01/racial-gender-wage-gaps-persist-in-u-s-despite-some-progress/),
  2016.
- Leo Polovets, [*Valuing Employee Options*](http://codingvc.com/valuing-employee-options/),
  2015\.
- Andy Rachleff, Wealthfront,
  [*When Should You Exercise Your Stock Options?*](https://blog.wealthfront.com/when-to-exercise-stock-options/),
  2015.
- David Weekly, GigaOm,
  [*5 Mistakes You Can’t Afford to Make with Stock Options*](https://gigaom.com/2011/06/05/5-mistakes-you-cant-afford-to-make-with-stock-options/),
  2011.

### Types of Equity Compensation

- Jeron Paul, Capshare,
  [*RSUs vs. Options: Why RSUs (Restricted Stock Units) Could be Better Than Stock Options At Your Private Company*](https://www.capshare.com/blog/rsus-vs-options/),
  2016.
- Andy Rachleff, Wealthfront,
  [*How Do Stock Options and RSUs Differ?*](https://blog.wealthfront.com/stock-options-versus-rsu/),
  2014.
- Mary Russell, Stock Option Counsel,
  [*Early Expiration of Startup Stock Options - Part 3 - Examples of Good Equity Design by Company Stage*](http://stockoptioncounsel.com/blog/early-expiration-of-startup-stock-options-part-3-examples-of-good-startup-equity-design-by-company-stage/2017/8/11),
  2017.
- Joe Wallin, The Startup Law Blog,
  [*Incentive Stock Options vs. Nonqualified Stock Options*](http://www.startuplawblog.com/2013/05/15/incentive-stock-options-vs-nonqualified-stock-options/),
  2013.
- Joe Wallin,
  [*RSUs vs. Restricted Stock vs. Stock Options*](http://joewallin.com/2014/09/13/rsus-vs-restricted-stock-vs-stock-options/),
  2014.

### Taxes

- Steven Ayre, Accelerated Vesting,
  [*What Is An 83(b) Election and When Do I Make It?*](http://acceleratedvesting.com/what-is-an-83b-election-and-when-do-i-make-it-part-1-with-graphic/),
  2013.
- Mark P. Cussen, Investopedia,
  [*How Restricted Stock And RSUs Are Taxed*](http://www.investopedia.com/articles/tax/09/restricted-stock-tax.asp?performancelayout=true).
- Barry Kramer,
  [🔑*The Tax Law that is (Unintentionally) Hammering Silicon Valley Employees*](https://medium.com/@barryjk/the-tax-law-that-is-unintentionally-hammering-silicon-valley-employees-894a7b54ba8a),
  2015.
- Joshua Levy and Joe Wallin, The Startup Law Blog,
  [*The Problem With Immediately Exercisable ISOs*](http://thestartuplawblog.com/the-problem-with-immediately-exercisable-isos/),
  2015.
- Kaye A. Thomas, Fairmark,
  [*AMT and Long-Term Capital Gain*](http://fairmark.com/general-taxation/alternative-minimum-tax/amt-long-term-capital-gain/),
  2014.
- Robert W. Wood, Forbes,
  [*Ten Tax Tips For Stock Options*](http://www.forbes.com/2010/03/10/10-tax-tips-stock-options-personal-finance-robert-wood.html),
  2010.
- NCEO,
  [*Stock Options and the Alternative Minimum Tax (AMT)*](https://www.nceo.org/articles/stock-options-alternative-minimum-tax-amt)

### Vesting and Expiration of Stock Options

- Babak Nivi, Venture Hacks,
  [*How to make a cap table*](http://venturehacks.com/articles/cap-table), 2007.
- Mary Russell, Stock Option Counsel,
  [*Can the Company Take Back My Vested Shares?*](http://stockoptioncounsel.com/blog/standards-ownership-canthecomanytakebackmyvestedshares),
  2017.
- Mary Russell, Stock Option Counsel,
  [*Early Expiration of Startup Stock Options - Part 1 - A $1 Million Problem*](http://stockoptioncounsel.com/blog/nc7go8ivzxb1el5rhv6nltrjan0n2t/2017/3/6),
  2017.
- Mary Russell, Stock Option Counsel,
  [*Early Expiration of Startup Stock Options - Part 2 -The Full 10-Year Term Solution*](http://stockoptioncounsel.com/blog/early-expiration-of-startup-stock-options-part-2-the-full-10-year-term-solution/2017/3/28),
  2017.
- Dan Shapiro, [*Vesting is a hack*](http://www.danshapiro.com/blog/2012/04/vesting-is-a-hack/),
  2012.

### Negotiation

- Robby Grossman,
  [*Negotiating Your Startup Job Offer*](http://rob.by/2013/negotiating-your-startup-job-offer),
  2013.
- Sheelah Kolhatkar, The New Yorker,
  [*Lean Out: The Dangers for Women who Negotiate*](https://www.newyorker.com/magazine/2017/11/20/the-tech-industrys-gender-discrimination-problem),
  2017.
- Deepak Malhotra, Harvard Business Review,
  [15 Rules for Negotiating a Job Offer](https://hbr.org/2014/04/15-rules-for-negotiating-a-job-offer),
  2014.
- [CEFNE (Center for Study and Training in Business Negotiation)](http://cefne.com/en/harvard-method-negotiation)

### Forms and Tools

- [🔨TLDR Stock Options](https://tldroptions.io/) and [OwnYourVenture](http://ownyourventure.com/)
  are simulators illustrating equity calculations and dilution
- Orrick,
  [📥Startup Forms: Equity Compensation](https://www.orrick.com/Total-Access/Tool-Kit/Start-Up-Forms/Equity-Compensation)

## Disclaimer

*This Guide and all associated comments and discussion do not constitute legal or tax
advice in any respect.
No reader should act or refrain from acting on the basis of any information presented
herein without seeking the advice of counsel in the relevant jurisdiction.
The author(s) expressly disclaim all liability in respect of any actions taken or not
taken based on any contents of this Guide or associated content.*

## Credits

Many thanks to all
[contributors](https://github.com/jlevy/og-equity-compensation/graphs/contributors) to this
Guide and those who have given detailed feedback, including
[Julia Evans](https://twitter.com/b0rk), [George Grellas](https://twitter.com/grellas),
[Chris McCann](https://twitter.com/mccannatron), [Leo Polovets](https://twitter.com/lpolovets),
[Srinath Sridhar](https://www.linkedin.com/in/srinath-sridhar-0a16705),
[Andy Sparks](https://twitter.com/SparksZilla), and [David Weekly](https://twitter.com/dweekly),
and to the many [commentators on Hacker News](https://news.ycombinator.com/item?id=10880726).
The original authors are [Joshua Levy](https://twitter.com/ojoshe) and
[Joe Wallin](https://twitter.com/joewallin).

### Please Help!

This Guide is a living publication, imperfect but improving.
If you have an idea or contribution that might improve this Guide, please add suggestions
in the margins.
We gladly credit all contributors.

## License

[![Creative Commons License](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)

This work is licensed under a
[Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/).

[^corpgovlaw.6vw7qt]: <https://corpgov.law.harvard.edu/2014/10/02/what-has-happened-to-stock-options/>

[^nceoorgass.x6588n]: <https://www.nceo.org/assets/pdf/articles/GSS-2014-data.pdf>

[^ftcomconte.x613np]: <https://www.ft.com/content/d6599ae0-5738-11e1-869b-00144feabdc0>

[^treasurygo.tbpcyx]: <https://www.treasury.gov/resource-center/tax-policy/tax-analysis/Documents/Firms-Exceeding-162m.pdf>

[^epiorgpubl.cq5o0o]: <https://www.epi.org/publication/taxes-executive-compensation/>

[^nberorgpap.wtsymr]: <http://www.nber.org/papers/w16585.pdf>

[^investoped.aaps6n]: <https://www.investopedia.com/articles/markets/120215/if-you-had-invested-right-after-starbucks-ipo.asp>

[^moneycnnco.80o8bh]: <https://money.cnn.com/1999/11/10/companies/ups/>

[^techcrunch.9ucopn]: <https://techcrunch.com/2017/06/28/a-look-back-at-amazons-1997-ipo/>

[^dealbookny.es6h1j]: <https://dealbook.nytimes.com/2009/08/19/googles-ipo-5-years-later/>

[^enwikipedi.q7bc95]: <https://en.wikipedia.org/wiki/Initial_public_offering_of_Facebook>

[^investoped.m9wdqp]: <https://www.investopedia.com/terms/c/c-corporation.asp>

[^quoracomwh.wsnr2b]: <https://www.quora.com/Why-do-most-technology-startups-incorporate-in-Delaware>

[^nytimescom.67ksyb]: <https://www.nytimes.com/2012/07/01/business/how-delaware-thrives-as-a-corporate-tax-haven.html>

[^investoped.fn52lq]: <http://www.investopedia.com/articles/analyst/03/111903.asp>

[^nytimescom.gec7iw]: <https://www.nytimes.com/2018/09/30/business/women-corporate-boards-california.html>

[^dlapiperac.wb4617]: <https://www.dlapiperaccelerate.com/knowledge/2017/board-action-meetings-vs-written-consents.html>

[^corpgovlaw.vbw82s]: <https://corpgov.law.harvard.edu/2017/05/25/2017-ipo-report/>

[^reactionwh.uw835n]: <http://reactionwheel.net/2018/05/zipcar-fundraising-breakdown.html>

[^nytimescom.bcfuyu]: <https://www.nytimes.com/2016/08/22/business/economy/bay-area-start-ups-find-low-cost-outposts-in-arizona.html>

[^chicagotri.fq0msp]: <http://www.chicagotribune.com/bluesky/technology/ct-silicon-valley-midwest-startups-20150925-story.html>

[^codingvcco.bcspni]: <http://codingvc.com/valuing-employee-options/>

[^cooleygoco.p5v68j]: <https://www.cooleygo.com/what-is-a-cap-table/>

[^lsvpwordpr.dgym96]: <https://lsvp.wordpress.com/2008/09/15/what-entrepreneurs-need-to-know-about-founders-stock/>

[^avccom2010.zxzhsl]: <https://avc.com/2010/10/employee-equity-the-liquidation-overhang/>

[^inccombusi.oldydy]: <https://www.inc.com/business-insider/tanium-security-startup-orion-hindawi-fired-employees-before-stocks-vested.html>

[^bloombergc.a48epn]: <https://www.bloomberg.com/news/articles/2017-09-19/tesla-worker-says-timing-of-firing-denied-him-lucrative-shares>

[^amplitudec.fvea8b]: <https://amplitude.com/blog/2015/12/01/employee-equity-is-broken-heres-our-fix/>

[^githubcomc.ygtolb]: <https://github.com/clef/handbook/blob/master/Hiring%20Documents/Guide%20to%20Your%20Equity.md>

[^mediumcomb.nqs9mo]: <https://medium.com/@barmstrong/improving-equity-compensation-at-coinbase-8749979409c3>

[^fortunecom.nnfd6o]: <http://fortune.com/2015/03/23/pinterest-employee-taxes/>

[^quoracomwh.4dxi02]: <https://www.quora.com/Why-do-most-startups-force-employees-to-exercise-their-vested-ISO-options-within-90-days-if-they-leave-rather-than-the-option-to-convert-to-NSOs>

[^thestartup.tn6iyt]: <http://thestartuplawblog.com/rsus-the-tax-problems/>

[^slatecomar.qqwwen]: <http://www.slate.com/articles/news_and_politics/politics/2014/04/how_long_is_the_tax_code_it_is_far_shorter_than_70_000_pages.html>

[^gpogovfdsy.clz3vr]: <https://www.gpo.gov/fdsys/pkg/USCODE-2016-title26/content-detail.html>

[^taxpolicyc.sjye20]: <https://www.taxpolicycenter.org/briefing-book/how-are-capital-gains-taxed>

[^taxpolicyc.mgorf1]: <https://www.taxpolicycenter.org/briefing-book/what-amt>

[^todayyougo.tyjmz8]: <https://today.yougov.com/news/2013/01/08/understanding-how-marginal-taxes-work-its-all-part/>

[^taxpolicyc.w7dds7]: <https://www.taxpolicycenter.org/briefing-book/what-tax-changes-did-affordable-care-act-make>

[^investoped.s08hcp]: <https://www.investopedia.com/articles/personal-finance/020714/new-taxes-under-affordable-care-act.asp>

[^foolcomtax.ox10ej]: <https://www.fool.com/taxes/2017/12/11/long-term-capital-gains-tax-rates-in-2018.aspx>

[^foolcomtax.3ka4p1]: <https://www.fool.com/taxes/2018/02/05/how-the-alternative-minimum-tax-is-changing-in-201.aspx>

[^blogwealth.3vcf24]: <https://blog.wealthfront.com/qualified-small-business-stock-2016/>

[^foolcomper.bw6uel]: <http://www.fool.com/personal-finance/taxes/2014/10/04/the-states-with-the-highest-capital-gains-tax-rate.aspx>

[^thestartup.25gj0l]: <http://thestartuplawblog.com/the-problem-with-immediately-exercisable-isos/>

[^mediumcomb.57vdab]: <https://medium.com/@barryjk/the-tax-law-that-is-unintentionally-hammering-silicon-valley-employees-894a7b54ba8a>

[^stockoptio.z54l1t]: <http://stockoptioncounsel.com/blog/early-expiration-of-startup-stock-options-part-3-examples-of-good-startup-equity-design-by-company-stage/2017/8/11>

[^joewallinc.8eaojr]: <http://joewallin.com/2014/09/13/rsus-vs-restricted-stock-vs-stock-options/>

[^schwabcomp.94cuxl]: <https://www.schwab.com/public/eac/resources/articles/rsu_basics.html>

[^wsjcomarti.vm6qmp]: <https://www.wsj.com/articles/former-employee-wins-legal-feud-to-open-up-startups-books-1485435602>

[^techcrunch.qn7usd]: <https://techcrunch.com/2015/10/14/selling-private-company-shares-2-0/>

[^industryve.6prupc]: <http://www.industryventures.com/2014/12/02/employee-liquidity-good-for-private-companies/>

[^mediumcomr.ez02hw]: <https://medium.com/@rizstanford/secondary-sales-in-vc-backed-startups-a-quick-primer-for-entrepreneurs-bdc25ea7f39a>

[^digitalcom.k5w0oc]: <https://digitalcommons.ilr.cornell.edu/cgi/viewcontent.cgi?article=2208&context=articles>

[^pewresearc.dws8o8]: <http://www.pewresearch.org/fact-tank/2016/07/01/racial-gender-wage-gaps-persist-in-u-s-despite-some-progress/>

[^iwprorgpub.1ukyxt]: <https://iwpr.org/publications/gender-wage-gap-2017-race-ethnicity/>

[^aflcioorgp.6v6p19]: <https://aflcio.org/paywatch/company-pay-ratios>

[^fortunecom.87hw00]: <http://fortune.com/2017/06/09/white-men-senior-executives-fortune-500-companies-diversity-data/>

[^eeocgoveeo.9aynwh]: <https://www.eeoc.gov/eeoc/statistics/reports/hightech/>

[^newyorkerc.mdcz9c]: <https://www.newyorker.com/science/maria-konnikova/lean-out-the-dangers-for-women-who-negotiate>

[^shrmorgres.qv3vrf]: <https://www.shrm.org/resourcesandtools/hr-topics/employee-relations/pages/using-a-job-offer-as-leverage-is-no-longer-a-big-no-no.aspx>

[^siliconhil.1wd4aa]: <http://siliconhillslawyer.com/2016/06/23/founder-compensation-cash-equity-liquidity/>

[^hrdivecomn.56fguz]: <https://www.hrdive.com/news/salary-history-ban-states-list/516662/>

[^nytimescom.yev52k]: <https://www.nytimes.com/2018/02/16/business/economy/salary-history-laws.html>

![An Open Guide](figures/signpost-horiz1-1600.jpg)

The Open Guide to Amazon Web Services
=====================================

[![Slack Chat](https://img.shields.io/badge/Chat-Slack-ff69b4.svg "Join us. Anyone is welcome!")](http://slackhatesthe.cloud) ⇦ Join us!

[Credits](AUTHORS.md) ∙ [Contributing guidelines](CONTRIBUTING.md)

Table of Contents
-----------------

**Purpose**

-	[Why an Open Guide?](#why-an-open-guide)
-	[Scope](#scope)
-	[Legend](#legend)

**AWS in General**

-	[General Information](#general-information)
-	[Learning and Career Development](#learning-and-career-development)
-	[Managing AWS](#managing-aws)
-	[Managing Servers and Applications](#managing-servers-and-applications)

| Specific AWS Services                 | Basics                         | Tips                          | Gotchas                                        |
|---------------------------------------|--------------------------------|-------------------------------|------------------------------------------------|
| [ALB](#alb) | [📗](#alb-basics) | [📘](#alb-tips) | [📙](#alb-gotchas-and-limitations) |
| [AMIs](#amis) | [📗](#ami-basics) | [📘](#ami-tips) | [📙](#ami-gotchas-and-limitations) |
| [API Gateway](#api-gateway) | [📗](#api-gateway-basics) | [📘](#api-gateway-tips) | [📙](#api-gateway-gotchas-and-limitations) |
| [Auto Scaling](#auto-scaling) | [📗](#auto-scaling-basics) | [📘](#auto-scaling-tips) | [📙](#auto-scaling-gotchas-and-limitations) |
| [Batch](#batch) | [📗](#batch-basics) | [📘](#batch-tips) |
| [Certificate Manager](#certificate-manager) | [📗](#certificate-manager-basics) | [📘](#certificate-manager-tips) | [📙](#certificate-manager-gotchas-and-limitations) |
| [CLB (ELB)](#clb) | [📗](#clb-basics) | [📘](#clb-tips) | [📙](#clb-gotchas-and-limitations) |
| [CloudFront](#cloudfront) | [📗](#cloudfront-basics) | [📘](#cloudfront-tips) | [📙](#cloudfront-gotchas-and-limitations) |
| [CloudFormation](#cloudformation) | [📗](#cloudformation-basics) | [📘](#cloudformation-tips) | [📙](#cloudformation-gotchas-and-limitations) |
| [CloudWatch](#cloudwatch) | [📗](#cloudwatch-basics) | [📘](#cloudwatch-tips) | [📙](#cloudwatch-gotchas-and-limitations) |
| [Device Farm](#device-farm) | [📗](#device-farm-basics) | [📘](#device-farm-tips) | [📙](#device-farm-gotchas-and-limitations) |
| [DirectConnect](#directconnect) | [📗](#directconnect-basics) | [📘](#directconnect-tips) |  |
| [DynamoDB](#dynamodb) | [📗](#dynamodb-basics) | [📘](#dynamodb-tips) | [📙](#dynamodb-gotchas-and-limitations) |
| [EBS](#ebs) | [📗](#ebs-basics) | [📘](#ebs-tips) | [📙](#ebs-gotchas-and-limitations) |
| [EC2](#ec2) | [📗](#ec2-basics) | [📘](#ec2-tips) | [📙](#ec2-gotchas-and-limitations) |
| [ECS](#ecs) | [📗](#ecs-basics) | [📘](#ecs-tips) |  |
| [EKS](#eks) | [📗](#eks-basics) | [📘](#eks-tips) | [📙](#eks-gotchas-and-limitations)  |
| [EFS](#efs) | [📗](#efs-basics) | [📘](#efs-tips) | [📙](#efs-gotchas-and-limitations) |
| [Elastic Beanstalk](#elastic-beanstalk) | [📗](#elastic-beanstalk-basics) | [📘](#elastic-beanstalk-tips) | [📙](#elastic-beanstalk-gotchas-and-limitations) |
| [Elastic IPs](#elastic-ips) | [📗](#elastic-ip-basics) | [📘](#elastic-ip-tips) | [📙](#elastic-ip-gotchas-and-limitations) |
| [ElastiCache](#elasticache) | [📗](#elasticache-basics) | [📘](#elasticache-tips) | [📙](#elasticache-gotchas-and-limitations) |
| [EMR](#emr) | [📗](#emr-basics) | [📘](#emr-tips) | [📙](#emr-gotchas-and-limitations) |
| [Fargate](#fargate) | [📗](#fargate-basics) | [📘](#fargate-tips) | [📙](#fargate-gotchas-and-limitations) |
| [Glacier](#glacier) | [📗](#glacier-basics) | [📘](#glacier-tips) | [📙](#glacier-gotchas-and-limitations) |
| [IoT](#iot) | [📗](#iot-basics) | [📘](#iot-tips) | [📙](#iot-gotchas-and-limitations) |
| [Kinesis Firehose](#kinesis-firehose) |  |  | [📙](#kinesis-firehose-gotchas-and-limitations) |
| [Kinesis Streams](#kinesis-streams) | [📗](#kinesis-streams-basics) | [📘](#kinesis-streams-tips) | [📙](#kinesis-streams-gotchas-and-limitations) |
| [KMS](#kms) | [📗](#kms-basics) | [📘](#kms-tips) | [📙](#kms-gotchas-and-limitations) |
| [Lambda](#lambda) | [📗](#lambda-basics) | [📘](#lambda-tips) | [📙](#lambda-gotchas-and-limitations) |
| [Load Balancers](#load-balancers) | [📗](#load-balancer-basics) | [📘](#load-balancer-tips) | [📙](#load-balancer-gotchas-and-limitations) |
| [Mobile Hub](#mobile-hub) | [📗](#mobile-hub-basics) | [📘](#mobile-hub-tips) | [📙](#mobile-hub-gotchas-and-limitations) |
| [OpsWorks](#opsworks) | [📗](#opsworks-basics) | [📘](#opsworks-tips) | [📙](#opsworks-gotchas-and-limitations) |
| [RDS](#rds) | [📗](#rds-basics) | [📘](#rds-tips) | [📙](#rds-gotchas-and-limitations) |
| [RDS Aurora](#rds-aurora) | [📗](#rds-aurora-basics) | [📘](#rds-aurora-tips) | [📙](#rds-aurora-gotchas-and-limitations) |
| [RDS Aurora MySQL](#rds-aurora-mysql) | [📗](#rds-aurora-mysql-basics) | [📘](#rds-aurora-mysql-tips) | [📙](#rds-aurora-mysql-gotchas-and-limitations) |
| [RDS Aurora PostgreSQL](#rds-aurora-postgresql) | [📗](#rds-aurora-postgresql-basics) | [📘](#rds-aurora-postgresql-tips) | [📙](#rds-aurora-postgresql-gotchas-and-limitations) |
| [RDS MySQL and MariaDB](#rds-mysql-and-mariadb) | [📗](#rds-mysql-and-mariadb-basics) | [📘](#rds-mysql-and-mariadb-tips) | [📙](#rds-mysql-and-mariadb-gotchas-and-limitations) |
| [RDS PostgreSQL](#rds-postgresql) | [📗](#rds-postgresql-basics) | [📘](#rds-postgresql-tips) | [📙](#rds-postgresql-gotchas-and-limitations) |
| [RDS SQL Server](#rds-sql-server) | [📗](#rds-sql-server-basics) | [📘](#rds-sql-server-tips) | [📙](#rds-sql-server-gotchas-and-limitations) |
| [Redshift](#redshift) | [📗](#redshift-basics) | [📘](#redshift-tips) | [📙](#redshift-gotchas-and-limitations) |
| [Route 53](#route-53) | [📗](#route-53-basics) | [📘](#route-53-tips) | [📙](#route-53-gotchas-and-limitations) |
| [S3](#s3) | [📗](#s3-basics) | [📘](#s3-tips) | [📙](#s3-gotchas-and-limitations) |
| [Security and IAM](#security-and-iam) | [📗](#security-and-iam-basics) | [📘](#security-and-iam-tips) | [📙](#security-and-iam-gotchas-and-limitations) |
| [SES](#ses) | [📗](#ses-basics) | [📘](#ses-tips) | [📙](#ses-gotchas-and-limitations) |
| [SNS](#sns) | [📗](#sns-basics) | [📘](#sns-tips) | [📙](#sns-gotchas-and-limitations) |
| [SQS](#sqs) | [📗](#sqs-basics) | [📘](#sqs-tips) | [📙](#sqs-gotchas-and-limitations) |
| [Step Functions](#step-functions) | [📗](#step-functions-basics) | [📘](#step-functions-tips) | [📙](#step-functions-gotchas-and-limitations) |
| [WAF](#waf) | [📗](#waf-basics) | [📘](#waf-tips) | [📙](#waf-gotchas-and-limitations) |
| [VPCs, Network Security, and Security Groups](#vpcs-network-security-and-security-groups) | [📗](#vpc-basics) | [📘](#vpc-and-network-security-tips) | [📙](#vpc-and-network-security-gotchas-and-limitations) |

**Special Topics**

-	[High Availability](#high-availability)
-	[Billing and Cost Management](#billing-and-cost-management)
-	[Further Reading](#further-reading)

**Legal**

-	[Disclaimer](#disclaimer)
-	[License](#license)

**Figures and Tables**

[![Tools and Services Market Landscape](figures/aws-market-landscape-320px.png)](#tools-and-services-market-landscape) [![AWS Data Transfer Costs](figures/aws-data-transfer-costs-320px.png)](#aws-data-transfer-costs)

-	[Figure: Tools and Services Market Landscape](#tools-and-services-market-landscape): A selection of third-party companies/products
-	[Figure: AWS Data Transfer Costs](#aws-data-transfer-costs): Visual overview of data transfer costs
-	[Table: Service Matrix](#service-matrix): How AWS services compare to alternatives
-	[Table: AWS Product Maturity and Releases](#aws-product-maturity-and-releases): AWS product releases
-	[Table: Storage Durability, Availability, and Price](#storage-durability-availability-and-price): A quantitative comparison

Why an Open Guide?
------------------

A lot of information on AWS is already written. Most people learn AWS by reading a blog or a “[getting started guide](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html)” and referring to the [standard AWS references](https://aws.amazon.com/documentation/). Nonetheless, trustworthy and practical information and recommendations aren’t easy to come by. AWS’s own documentation is a great but sprawling resource few have time to read fully, and it doesn’t include anything but official facts, so omits experiences of engineers. The information in blogs or [Stack Overflow](http://stackoverflow.com/questions/tagged/amazon-web-services) is also not consistently up to date.

This guide is by and for engineers who use AWS. It aims to be a useful, living reference that consolidates links, tips, gotchas, and best practices. It arose from discussion and editing over beers by [several engineers](AUTHORS.md) who have used AWS extensively.

Before using the guide, please read the [**license**](#license) and [**disclaimer**](#disclaimer).

### Please help!

**This is an early in-progress draft!** It’s our first attempt at assembling this information, so is far from comprehensive still, and likely to have omissions or errors.

[![Slack Chat](https://img.shields.io/badge/Chat-Slack-ff69b4.svg "Join us. Anyone is welcome!")](https://join.slack.com/t/og-aws/shared_invite/enQtODM2NjY1NDQ2MTgxLWYwY2VjZDBiOGU1YTJjOWUwNTY3NjEyODA0NzY1N2MxNjhhZmYwZTU0NjNhMjNlNGVjODdlNTI4N2Y1YWIwNGE)

Please help by [**joining the Slack channel**](https://join.slack.com/t/og-aws/shared_invite/enQtODM2NjY1NDQ2MTgxLWYwY2VjZDBiOGU1YTJjOWUwNTY3NjEyODA0NzY1N2MxNjhhZmYwZTU0NjNhMjNlNGVjODdlNTI4N2Y1YWIwNGE) (we like to talk about AWS in general, even if you only have questions — discussion helps the community and guides improvements) and [**contributing to the guide**](CONTRIBUTING.md). This guide is *open to contributions*, so unlike a blog, it can keep improving. Like any open source effort, we combine efforts but also review to ensure high quality.

Scope
-----

-	Currently, this guide covers selected “core” services, such as EC2, S3, Load Balancers, EBS, and IAM, and partial details and tips around other services. We expect it to expand.
-	It is not a tutorial, but rather a collection of information you can read and return to. It is for both beginners and the experienced.
-	The goal of this guide is to be:
	-	**Brief:** Keep it dense and use links
	-	**Practical:** Basic facts, concrete details, advice, gotchas, and other “folk knowledge”
	-	**Current:** We can keep updating it, and anyone can contribute improvements
	-	**Thoughtful:** The goal is to be helpful rather than present dry facts. Thoughtful opinion with rationale is welcome. Suggestions, notes, and opinions based on real experience can be extremely valuable. (We believe this is both possible with a guide of this format, unlike in some [other venues](http://meta.stackexchange.com/questions/201994/is-there-a-place-to-ask-opinion-based-questions).)
-	This guide is not sponsored by AWS or AWS-affiliated vendors. It is written by and for engineers who use AWS.

Legend
------

-	📒 Marks standard/official AWS pages and docs
-	🔹 Important or often overlooked tip
-	❗ “Serious” gotcha (used where risks or time or resource costs are significant: critical security risks, mistakes with significant financial cost, or poor architectural choices that are fundamentally difficult to correct)
-	🔸 “Regular” gotcha, limitation, or quirk (used where consequences are things not working, breaking, or not scaling gracefully)
-	📜 Undocumented feature (folklore)
-	🐥 Relatively new (and perhaps immature) services or features
-	⏱ Performance discussions
-	⛓ Lock-in: Products or decisions that are likely to tie you to AWS in a new or significant way — that is, later moving to a non-AWS alternative would be costly in terms of engineering effort
-	🚪 Alternative non-AWS options
-	💸 Cost issues, discussion, and gotchas
-	🕍 A mild warning attached to “full solution” or opinionated frameworks that may take significant time to understand and/or might not fit your needs exactly; the opposite of a point solution (the cathedral is a nod to [Raymond’s metaphor](https://en.wikipedia.org/wiki/The_Cathedral_and_the_Bazaar)\)
-	📗📘📙 Colors indicate basics, tips, and gotchas, respectively.
-	🚧 Areas where correction or improvement are needed (possibly with link to an issue — do help!)

General Information
-------------------

### When to Use AWS

-	[AWS](https://en.wikipedia.org/wiki/Amazon_Web_Services) is the dominant public cloud computing provider.
	-	In general, “[cloud computing](https://en.wikipedia.org/wiki/Cloud_computing)” can refer to one of three types of cloud: “public,” “private,” and “hybrid.” AWS is a public cloud provider, since anyone can use it. Private clouds are within a single (usually large) organization. Many companies use a hybrid of private and public clouds.
	-	The core features of AWS are [infrastructure-as-a-service](https://en.wikipedia.org/wiki/Cloud_computing#Infrastructure_as_a_service_.28IaaS.29) (IaaS) — that is, virtual machines and supporting infrastructure. Other cloud service models include [platform-as-a-service](https://en.wikipedia.org/wiki/Cloud_computing#Platform_as_a_service_.28PaaS.29) (PaaS), which typically are more fully managed services that deploy customers’ applications, or [software-as-a-service](https://en.wikipedia.org/wiki/Cloud_computing#Software_as_a_service_.28SaaS.29) (SaaS), which are cloud-based applications. AWS does offer a few products that fit into these other models, too.
	-	In business terms, with infrastructure-as-a-service you have a variable cost model — it is [OpEx, not CapEx](http://www.investopedia.com/ask/answers/020915/what-difference-between-capex-and-opex.asp) (though some [pre-purchased contracts](https://aws.amazon.com/ec2/purchasing-options/reserved-instances/) are still CapEx).
  - AWS’s TTM revenue was [**$37.549 billion**](https://ir.aboutamazon.com/news-release/news-release-details/2020/Amazoncom-Announces-First-Quarter/default.aspx) as of Q1 2020 according to their earnings results (slide 14 in the linked deck), or roughly **14%** of Amazon.com’s total revenue (slide 11 in the same deck) for the same TTM period.
-	**Main reasons to use AWS:**
	-	If your company is building systems or products that may need to scale
	-	and you have technical know-how
	-	and you want the most flexible tools
	-	and you’re not significantly tied into different infrastructure already
	-	and you don’t have internal, regulatory, or compliance reasons you can’t use a public cloud-based solution
	-	and you’re not on a Microsoft-first tech stack
	-	and you don’t have a specific reason to use Google Cloud
	-	and you can afford, manage, or negotiate its somewhat higher costs
	-	... then AWS is likely a good option for your company.
-	Each of those reasons above might point to situations where other services are preferable. In practice, many, if not most, tech startups as well as a number of modern large companies can or already do benefit from using AWS. Many large enterprises are partly migrating internal infrastructure to Azure, Google Cloud, and AWS.
-	**Costs:** Billing and cost management are such big topics that we have [an entire section on this](#billing-and-cost-management).
-	🔹**EC2 vs. other services:** Most users of AWS are most familiar with [EC2](#ec2), AWS’ flagship virtual server product, and possibly a few others like S3 and CLBs. But AWS products now extend far beyond basic IaaS, and often companies do not properly understand or appreciate all the many AWS services and how they can be applied, due to the [sharply growing](#which-services-to-use) number of services, their novelty and complexity, branding confusion, and fear of ⛓lock-in to proprietary AWS technology. Although a bit daunting, it’s important for technical decision-makers in companies to understand the breadth of the AWS services and make informed decisions. (We hope this guide will help.)
-	🚪**AWS vs. other cloud providers:** While AWS is the dominant IaaS provider (31% market share in [this 2016 estimate](https://www.srgresearch.com/articles/aws-remains-dominant-despite-microsoft-and-google-growth-surges)), there is significant competition and alternatives that are better suited to some companies. [This Gartner report](https://www.gartner.com/doc/reprints?id=1-2G2O5FC&ct=150519&st=sb) has a good overview of the major cloud players :
	-	[**Google Cloud Platform**](https://cloud.google.com/). GCP arrived later to market than AWS, but has vast resources and is now used widely by many companies, including a few large ones. It is gaining market share. Not all AWS services have similar or analogous services in GCP. And vice versa: In particular, GCP offers some more advanced machine learning-based services like the [Vision](https://cloud.google.com/vision/), [Speech](https://cloud.google.com/speech/), and [Natural Language](https://cloud.google.com/natural-language/) APIs. It’s not common to switch once you’re up and running, but it does happen: [Spotify migrated](http://www.wsj.com/articles/google-cloud-lures-amazon-web-services-customer-spotify-1456270951) from AWS to Google Cloud. There is more discussion [on Quora](https://www.quora.com/What-are-the-reasons-to-choose-AWS-over-Google-Cloud-or-vice-versa-for-a-high-traffic-web-application) about relative benefits. Of particular note is that VPCs in GCP are [global by default](https://cloud.google.com/vpc/) with subnetworks per region, while AWS’ VPCs have to live within a particular region. This gives GCP an edge if you’re designing applications with geo-replication from the beginning. It’s also possible to [share one GCP VPC](https://cloud.google.com/compute/docs/shared-vpc/) between multiple projects (roughly analogous to AWS accounts), while in AWS you’d have to peer them. It’s also possible to [peer GCP VPCs](https://cloud.google.com/compute/docs/vpc/vpc-peering) in a similar manner to how it’s done in AWS.
	-	[**Microsoft Azure**](https://azure.microsoft.com/en) is the de facto choice for companies and teams that are focused on a Microsoft stack, and it has now placed significant emphasis on Linux as well
	-	In **China**, AWS’ footprint is relatively small. The market is dominated by Alibaba’s [Alibaba Cloud](https://www.alibabacloud.com/), formerly called [Aliyun](https://intl.aliyun.com/).
	-	Companies at (very) large scale may want to reduce costs by managing their own infrastructure. For example, [Dropbox migrated](https://news.ycombinator.com/item?id=11282948) to their own infrastructure.
	-	Other cloud providers such as [Digital Ocean](https://www.digitalocean.com/) offer similar services, sometimes with greater ease of use, more personalized support, or lower cost. However, none of these match the breadth of products, mind-share, and market domination AWS now enjoys.
	-	Traditional managed hosting providers such as [Rackspace](https://www.rackspace.com/) offer cloud solutions as well.
-	🚪**AWS vs. PaaS:** If your goal is just to put up a single service that does something relatively simple, and you’re trying to minimize time managing operations engineering, consider a [platform-as-a-service](https://en.wikipedia.org/wiki/Platform_as_a_service) such as [Heroku](https://www.heroku.com/). The AWS approach to PaaS, Elastic Beanstalk, is arguably more complex, especially for simple use cases.
-	🚪**AWS vs. web hosting:** If your main goal is to host a website or blog, and you don’t expect to be building an app or more complex service, you may wish consider one of the myriad [web hosting services](https://www.google.com/search?q=web+hosting).
-	🚪**AWS vs. managed hosting:** Traditionally, many companies pay [managed hosting](https://en.wikipedia.org/wiki/Dedicated_hosting_service) providers to maintain physical servers for them, then build and deploy their software on top of the rented hardware. This makes sense for businesses who want direct control over hardware, due to legacy, performance, or special compliance constraints, but is usually considered old fashioned or unnecessary by many developer-centric startups and younger tech companies.
-	**Complexity:** AWS will let you build and scale systems to the size of the largest companies, but the complexity of the services when used at scale requires significant depth of knowledge and experience. Even very simple use cases often require more knowledge to do “right” in AWS than in a simpler environment like Heroku or Digital Ocean. (This guide may help!)
-	**Geographic locations:** AWS has data centers in [over a dozen geographic locations](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-available-regions), known as **regions**, in Europe, East Asia, North and South America, and now Australia and India. It also has many more **edge locations** globally for reduced latency of services like CloudFront.
	-	See the [current list](https://aws.amazon.com/about-aws/global-infrastructure/) of regions and edge locations, including upcoming ones.
	-	If your infrastructure needs to be in close physical proximity to another service for latency or throughput reasons (for example, latency to an ad exchange), viability of AWS may depend on the location.
-	⛓**Lock-in:** As you use AWS, it’s important to be aware when you are depending on AWS services that do not have equivalents elsewhere.
	-	Lock-in may be completely fine for your company, or a significant risk. It’s important from a business perspective to make this choice explicitly, and consider the cost, operational, business continuity, and competitive risks of being tied to AWS. AWS is such a dominant and reliable vendor, many companies are comfortable with using AWS to its full extent. Others can tell stories about the [dangers of “cloud jail” when costs spiral](http://firstround.com/review/the-three-infrastructure-mistakes-your-company-must-not-make/).
	-	Generally, the more AWS services you use, the more lock-in you have to AWS — that is, the more engineering resources (time and money) it will take to change to other providers in the future.
	-	Basic services like virtual servers and standard databases are usually easy to migrate to other providers or on premises. Others like load balancers and IAM are specific to AWS but have close equivalents from other providers. The key thing to consider is whether engineers are architecting systems around specific AWS services that are not open source or relatively interchangeable. For example, Lambda, API Gateway, Kinesis, Redshift, and DynamoDB do not have substantially equivalent open source or commercial service equivalents, while EC2, RDS (MySQL or Postgres), EMR, and ElastiCache more or less do. (See more [below](#which-services-to-use), where these are noted with ⛓.)
-	**Combining AWS and other cloud providers:** Many customers combine AWS with other non-AWS services. For example, legacy systems or secure data might be in a managed hosting provider, while other systems are AWS. Or a company might only use S3 with another provider doing everything else. However small startups or projects starting fresh will typically stick to AWS or Google Cloud only.
-	**Hybrid cloud:** In larger enterprises, it is common to have [hybrid deployments](https://aws.amazon.com/enterprise/hybrid/) encompassing private cloud or on-premises servers and AWS — or other enterprise cloud providers like [IBM](https://www.ibm.com/it-infrastructure/solutions/hybrid-cloud)/[Bluemix](http://www.ibm.com/cloud-computing/bluemix/hybrid/), [Microsoft](https://www.microsoft.com/en-us/cloud-platform/hybrid-cloud)/[Azure](https://azure.microsoft.com/en-us/overview/azure-stack/), [NetApp](http://www.netapp.com/us/solutions/cloud/hybrid-cloud/), or [EMC](http://www.emc.com/en-us/cloud/hybrid-cloud-computing/index.htm).
-	**Major customers:** Who uses AWS and Google Cloud?
	-	AWS’s [list of customers](https://aws.amazon.com/solutions/case-studies/) includes large numbers of mainstream online properties and major brands, such as Netflix, Pinterest, Spotify (moving to Google Cloud), Airbnb, Expedia, Yelp, Zynga, Comcast, Nokia, and Bristol-Myers Squibb.
	-	Azure’s [list of customers](https://azure.microsoft.com/en-us/case-studies/) includes companies such as NBC Universal, 3M and Honeywell Inc.
	-	Google Cloud’s [list of customers](https://cloud.google.com/customers/) is large as well, and includes a few mainstream sites, such as [Snapchat](http://www.businessinsider.com/snapchat-is-built-on-googles-cloud-2014-1), Best Buy, Domino’s, and Sony Music.

### Which Services to Use

-	AWS offers a *lot* of different services — [about a hundred](https://aws.amazon.com/products/) at last count.
-	Most customers use a few services heavily, a few services lightly, and the rest not at all. What services you’ll use depends on your use cases. Choices differ substantially from company to company.
-	**Immature and unpopular services:** Just because AWS has a service that sounds promising, it doesn’t mean you should use it. Some services are very narrow in use case, not mature, are overly opinionated, or have limitations, so building your own solution may be better. We try to give a sense for this by breaking products into categories.
-	**Must-know infrastructure:** Most typical small to medium-size users will focus on the following services first. If you manage use of AWS systems, you likely need to know at least a little about all of these. (Even if you don’t use them, you should learn enough to make that choice intelligently.)
	-	[IAM](#security-and-iam): User accounts and identities (you need to think about accounts early on!)
	-	[EC2](#ec2): Virtual servers and associated components, including:
		-	[AMIs](#amis): Machine Images
		-	[Load Balancers](#load-balancers): CLBs and ALBs
		-	[Autoscaling](#auto-scaling): Capacity scaling (adding and removing servers based on load)
		-	[EBS](#ebs): Network-attached disks
		-	[Elastic IPs](#elastic-ips): Assigned IP addresses
	-	[S3](#s3): Storage of files
	-	[Route 53](#route-53): DNS and domain registration
	-	[VPC](#vpcs-network-security-and-security-groups): Virtual networking, network security, and co-location; you automatically use
	-	[CloudFront](#cloudfront): CDN for hosting content
	-	[CloudWatch](#cloudwatch): Alerts, paging, monitoring
-	**Managed services:** Existing software solutions you could run on your own, but with managed deployment:
	-	[RDS](#rds): Managed relational databases (managed MySQL, Postgres, and Amazon’s own Aurora database)
	-	[EMR](#emr): Managed Hadoop
	-	[Elasticsearch](https://aws.amazon.com/elasticsearch-service/): Managed Elasticsearch
	-	[ElastiCache](https://aws.amazon.com/elasticache/): Managed Redis and Memcached
-	**Optional but important infrastructure:** These are key and useful infrastructure components that are less widely known and used. You may have legitimate reasons to prefer alternatives, so evaluate with care to be sure they fit your needs:
	-	⛓[Lambda](#lambda): Running small, fully managed tasks “serverless”
	-	[CloudTrail](https://aws.amazon.com/cloudtrail/): AWS API logging and audit (often neglected but important)
	-	⛓🕍[CloudFormation](#cloudformation): Templatized configuration of collections of AWS resources
	-	🕍[Elastic Beanstalk](https://aws.amazon.com/elasticbeanstalk/): Fully managed (PaaS) deployment of packaged Java, .NET, PHP, Node.js, Python, Ruby, Go, and Docker applications
	-	🐥[EFS](#efs): Network filesystem compatible with NFSv4.1
	-	⛓🕍[ECS](#ecs): Docker container/cluster management (note Docker can also be used directly, without ECS)
	-   🕍 [EKS](#eks): Kubernetes (K8) Docker Container/Cluster management
	-	⛓[ECR](https://aws.amazon.com/ecr/): Hosted private Docker registry
	-	🐥[Config](https://aws.amazon.com/config/): AWS configuration inventory, history, change notifications
	-	🐥[X-Ray](https://aws.amazon.com/xray/): Trace analysis and debugging for distributed applications such as microservices.
-	**Special-purpose infrastructure:** These services are focused on specific use cases and should be evaluated if they apply to your situation. Many also are proprietary architectures, so tend to tie you to AWS.
	-	⛓[DynamoDB](#dynamodb): Low-latency NoSQL key-value store
	-	⛓[Glacier](#glacier): Slow and cheap alternative to S3
	-	⛓[Kinesis](https://aws.amazon.com/kinesis/): Streaming (distributed log) service
	-	⛓[SQS](https://aws.amazon.com/sqs/): Message queueing service
	-	⛓[Redshift](#redshift): Data warehouse
	-	🐥[QuickSight](https://aws.amazon.com/quicksight/): Business intelligence service
	-	[SES](https://aws.amazon.com/ses/): Send and receive e-mail for marketing or transactions
	-	⛓[API Gateway](https://aws.amazon.com/api-gateway/): Proxy, manage, and secure API calls
	-	⛓[IoT](#iot): Manage bidirectional communication over HTTP, WebSockets, and MQTT between AWS and clients (often but not necessarily “things” like appliances or sensors)
	-	⛓[WAF](https://aws.amazon.com/waf/): Web firewall for CloudFront to deflect attacks
	-	⛓[KMS](#kms): Store and manage encryption keys securely
	-	[Inspector](https://aws.amazon.com/inspector/): Security audit
	-	[Trusted Advisor](https://aws.amazon.com/premiumsupport/trustedadvisor/): Automated tips on reducing cost or making improvements
	-	🐥[Certificate Manager](https://aws.amazon.com/certificate-manager/): Manage SSL/TLS certificates for AWS services
	-	🐥⛓[Fargate](https://aws.amazon.com/fargate/): Docker containers management, backend for ECS and EKS
-	**Compound services:** These are similarly specific, but are full-blown services that tackle complex problems and may tie you in. Usefulness depends on your requirements. If you have large or significant need, you may have these already managed by in-house systems and engineering teams.
	-	[Machine Learning](https://aws.amazon.com/machine-learning/): Machine learning model training and classification
	-	[Lex](https://aws.amazon.com/lex/): Automatic speech recognition (ASR) and natural language understanding (NLU)
	-	[Polly](https://aws.amazon.com/polly/): Text-to-speech engine in the cloud
	-	[Rekognition](https://aws.amazon.com/rekognition/): Service for image recognition
	-	⛓🕍[Data Pipeline](https://aws.amazon.com/datapipeline/): Managed ETL service
	-	⛓🕍[SWF](https://aws.amazon.com/swf/): Managed state tracker for distributed polyglot job workflow
	-	⛓🕍[Lumberyard](https://aws.amazon.com/lumberyard/): 3D game engine
-	**Mobile/app development:**
	-	[SNS](https://aws.amazon.com/sns/): Manage app push notifications and other end-user notifications
	-	⛓🕍[Cognito](https://aws.amazon.com/cognito/): User authentication via Facebook, Twitter, etc.
	-	[Device Farm](https://aws.amazon.com/device-farm/): Cloud-based device testing
	-	[Mobile Analytics](https://aws.amazon.com/mobileanalytics/): Analytics solution for app usage
	-	🕍[Mobile Hub](https://aws.amazon.com/mobile/): Comprehensive, managed mobile app framework
-	**Enterprise services:** These are relevant if you have significant corporate cloud-based or hybrid needs. Many smaller companies and startups use other solutions, like Google Apps or Box. Larger companies may also have their own non-AWS IT solutions.
	-	[AppStream](https://aws.amazon.com/appstream/): Windows apps in the cloud, with access from many devices
	-	[Workspaces](https://aws.amazon.com/workspaces/): Windows desktop in the cloud, with access from many devices
	-	[WorkDocs](https://aws.amazon.com/workdocs/) (formerly Zocalo): Enterprise document sharing
	-	[WorkMail](https://aws.amazon.com/workmail/): Enterprise managed e-mail and calendaring service
	-	[Directory Service](https://aws.amazon.com/directoryservice/): Microsoft Active Directory in the cloud
	-	[Direct Connect](https://aws.amazon.com/directconnect/): Dedicated network connection between office or data center and AWS
	-	[Storage Gateway](https://aws.amazon.com/storagegateway/): Bridge between on-premises IT and cloud storage
	-	[Service Catalog](https://aws.amazon.com/servicecatalog/): IT service approval and compliance
-	**Probably-don't-need-to-know services:** Bottom line, our informal polling indicates these services are just not broadly used — and often for good reasons:
	-	[Snowball](https://aws.amazon.com/importexport/): If you want to ship petabytes of data into or out of Amazon using a physical appliance, read on.
	-	[Snowmobile](https://aws.amazon.com/snowmobile/): Appliances are great, but if you've got exabyte scale data to get into Amazon, nothing beats a tractor trailer full of drives.
	-	[CodeCommit](https://aws.amazon.com/codecommit/): Git service. You’re probably already using GitHub or your own solution ([Stackshare](http://stackshare.io/stackups/github-vs-bitbucket-vs-aws-codecommit) has informal stats).
	-	🕍[CodePipeline](https://aws.amazon.com/codepipeline/): Continuous integration. You likely have another solution already.
	-	🕍[CodeDeploy](https://aws.amazon.com/codedeploy/): Deployment of code to EC2 servers. Again, you likely have another solution.
	-	🕍[OpsWorks](https://aws.amazon.com/opsworks/): Management of your deployments using Chef or (as of November 2017) Puppet Enterprise.
-	[AWS in Plain English](https://www.expeditedssl.com/aws-in-plain-english) offers more friendly explanation of what all the other different services are.

### Tools and Services Market Landscape

There are now enough cloud and “big data” enterprise companies and products that few can keep up with the market landscape.

We’ve assembled a landscape of a few of the services. This is far from complete, but tries to emphasize services that are popular with AWS practitioners — services that specifically help with AWS, or a complementary, or tools almost anyone using AWS must learn.

![Popular Tools and Services for AWS Practitioners](figures/aws-market-landscape.png)

🚧 *Suggestions to improve this figure? Please [file an issue](CONTRIBUTING.md).*


### Common Concepts

-	📒 The AWS [**General Reference**](https://docs.aws.amazon.com/general/latest/gr/Welcome.html) covers a bunch of common concepts that are relevant for multiple services.
-	AWS allows deployments in [**regions**](https://docs.aws.amazon.com/general/latest/gr/rande.html), which are isolated geographic locations that help you reduce latency or offer additional redundancy. Regions contain availability zones(AZs), which are typically the first tool of choice for [high availability](#high-availability)). AZs are [physically separate from one another](https://www.youtube.com/watch?v=JIQETrFC_SQ&feature=youtu.be&t=1428) even within the same region, and [may span multiple physical data centers](https://blog.rackspace.com/aws-101-regions-availability-zones). While they are connected via low latency links, natural disasters afflicting one should not affect others.
-	Each service has API **endpoints** for each region. Endpoints differ from service to service and not all services are available in each region, as listed in [these tables](https://docs.aws.amazon.com/general/latest/gr/rande.html).
-	[**Amazon Resource Names (ARNs)**](https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html) are specially formatted identifiers for identifying resources. They start with 'arn:' and are used in many services, and in particular for IAM policies.

### Service Matrix

Many services within AWS can at least be compared with Google Cloud offerings or with internal Google services. And often times you could assemble the same thing yourself with open source software. This table is an effort at listing these rough correspondences. (Remember that this table is imperfect as in almost every case there are subtle differences of features!)

| Service                       | AWS                                                                          | Google Cloud                 | Google Internal | Microsoft Azure                    | Other providers                   | Open source “build your own”                               | Openstack     |
|-------------------------------|------------------------------------------------------------------------------|------------------------------|-----------------|------------------------------------|-----------------------------------|------------------------------------------------------------|------------------------------------------------------------|
| Virtual server                | EC2                                                                          | Compute Engine (GCE)         |                 | Virtual Machine                    | DigitalOcean                      | OpenStack                                                  | Nova |
| PaaS                          | Elastic Beanstalk                                                            | App Engine                   | App Engine      | Web Apps                           | Heroku, AppFog, OpenShift | Meteor, AppScale, Cloud Foundry, Convox                    |
| Serverless, microservices     | Lambda, API Gateway                                                          | Functions                    |                 | Function Apps                      | PubNub Blocks, Auth0 Webtask      | Kong, Tyk                                                  | Qinling |
| Container, cluster manager    | ECS, EKS, Fargate                                                                 | Container Engine, Kubernetes | Borg or Omega   | Container Service                  |                                   | Kubernetes, Mesos, Aurora                                  |  Zun |
| Object storage                  | S3                                                                           | Cloud Storage                | GFS             | Storage Account                    | DigitalOcean Spaces               | Swift, HDFS, Minio                                         | Swift |
| Block storage                 | EBS                                                                          | Persistent Disk              |                 | Storage Account                    | DigitalOcean Volumes              | NFS                                                        | Cinder |
| SQL datastore                 | RDS                                                                          | Cloud SQL                    |                 | SQL Database                       |                                   | MySQL, PostgreSQL                                          | Trove (stores NoSQL as well) |
| Sharded RDBMS                 |                                                                              | Cloud Spanner                | F1, Spanner     | Azure Database for PostgreSQL - Hyperscale (Citus) |                                   | Crate.io, CockroachDB                                      |
| Bigtable                      |                                                                              | Cloud Bigtable               | Bigtable        |                                    |                                   | HBase                                                      |
| Key-value store, column store | DynamoDB                                                                     | Cloud Datastore              | Megastore       | Tables, DocumentDB                 |                                   | Cassandra, CouchDB, RethinkDB, Redis                       |
| Memory cache                  | ElastiCache                                                                  | App Engine Memcache          |                 | Redis Cache                        |                                   | Memcached, Redis                                           |
| Search                        | CloudSearch, Elasticsearch (managed)                                         |                              |                 | Search                             | Algolia, QBox, Elastic Cloud                     | Elasticsearch, Solr                                        |
| Data warehouse                | Redshift                                                                     | BigQuery                     | Dremel          | SQL Data Warehouse                 | Oracle, IBM, SAP, HP, many others | Greenplum                                                  |
| Business intelligence         | QuickSight                                                                   | Data Studio 360               |                 | Power BI                           | Tableau                           |                                                            |
| Lock manager                  | [DynamoDB (weak)](https://gist.github.com/ryandotsmith/c95fd21fab91b0823328) |                              | Chubby          | Lease blobs in Storage Account     |                                   | ZooKeeper, Etcd, Consul                                    |
| Message broker                | SQS, SNS, IoT                                                                | Pub/Sub                      | PubSub2         | Service Bus                        |                                   | RabbitMQ, Kafka, 0MQ                                       |
| Streaming, distributed log    | Kinesis                                                                      | Dataflow                     | PubSub2         | Event Hubs                         |                                   | Kafka Streams, Apex, Flink, Spark Streaming, Storm         |
| MapReduce                     | EMR                                                                          | Dataproc                     | MapReduce       | HDInsight, DataLake Analytics      | Qubole                            | Hadoop                                                     |
| Monitoring                    | CloudWatch                                                                   | Stackdriver Monitoring       | Borgmon         | Monitor                            |                                   | Prometheus(?)                                              |
| Tracing                       | X-Ray                                                                        | Stackdriver Trace            |                 | Monitor (Application Insights)     |  DataDog, New Relic, Epsagon      | Zipkin, Jaeger, Appdash
| Metric management             |                                                                              |                              | Borgmon, TSDB   | Application Insights               |                                   | Graphite, InfluxDB, OpenTSDB, Grafana, Riemann, Prometheus |
| CDN                           | CloudFront                                                                   | Cloud CDN                    |                 | CDN                                |  Akamai, Fastly, Cloudflare, Limelight Networks                                 | Apache Traffic Server                                      |
| Load balancer                 | CLB/ALB                                                                      | Load Balancing               | GFE             | Load Balancer, Application Gateway |                                   | nginx, HAProxy, Apache Traffic Server                      |
| DNS                           | Route53                                                                      | DNS                          |                 | DNS                                |                                   | bind                                                       |
| Email                         | SES                                                                          |                              |                 |                                    | Sendgrid, Mandrill, Postmark      |                                                            |
| Git hosting                   | CodeCommit                                                                   | Cloud Source Repositories    |                 | Visual Studio Team Services        | GitHub, BitBucket                 | GitLab                                                     |
| User authentication           | Cognito                                                                      |    Firebase Authentication                          |                 | Azure Active Directory             |                                   | oauth.io                                                   |
| Mobile app analytics          | Mobile Analytics                                                             | Firebase Analytics           |                 | HockeyApp                          | Mixpanel                          |                                                            |
| Mobile app testing            | Device Farm                                                                  | Firebase Test Lab            |                 | Xamarin Test Cloud                 | BrowserStack, Sauce Labs, Testdroid                                                            |
| Managing SSL/TLS certificates            | Certificate Manager                                                                  |                |                 |                 | Let's Encrypt, Comodo, Symantec, GlobalSign |
| Automatic speech recognition and natural language understanding            | Transcribe (ASR), Lex (NLU)     | Cloud Speech API, Natural Language API             |                 | Cognitive services                | AYLIEN Text Analysis API, Ambiverse Natural Language Understanding API  |Stanford's Core NLP Suite, Apache OpenNLP, Apache UIMA, spaCy |
| Text-to-speech engine in the cloud            | Polly                                                                  |                |                 |                 |Nuance, Vocalware, IBM | Mimic, eSpeak, MaryTTS |
| Image recognition            | Rekognition                                                            |   Vision API              |                |Cognitive services                 | IBM Watson, Clarifai |TensorFlow, OpenCV |
| OCR (Text recognition)       | Textract (documents), Rekognition (photographs)                               | Cloud Vision API             |                 | Computer Vision API                |                                   | Tesseract                                                  |
| Language Translation          | Translate                                                                    | Translate                    |                 | Translator Text API                |                                   | Apertium                                                   |
| File Share and Sync          | WorkDocs                                                                   |   Google Docs                 |                 |OneDrive                  |       Dropbox, Box, Citrix File Share                  |ownCloud |
| Machine Learning          | SageMaker, DeepLens, ML                                                                   |   ML Engine, Auto ML                 |                 |ML Studio                  |       Watson ML                  |  |
| Data Loss Prevention         | Macie                                                                         | Cloud Data Loss Prevention   |                | Azure Information Protection        |                                   |                                                            |

🚧 [*Please help fill this table in.*](CONTRIBUTING.md)

Selected resources with more detail on this chart:

-	Google internal: [MapReduce](http://research.google.com/archive/mapreduce.html), [Bigtable](http://research.google.com/archive/bigtable.html), [Spanner](http://research.google.com/archive/spanner.html), [F1 vs Spanner](http://highscalability.com/blog/2013/10/8/f1-and-spanner-holistically-compared.html), [Bigtable vs Megastore](http://perspectives.mvdirona.com/2008/07/google-megastore/)

### AWS Product Maturity and Releases

It’s important to know the maturity of each AWS product. Here is a mostly complete list of first release date, with links to the [release notes](https://aws.amazon.com/releasenotes/). Most recently released services are first. Not all services are available in all regions; see [this table](https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/).

| Service                                                                                                    | Original release | Availability                                                                  | CLI Support | HIPAA Compliant | PCI-DSS Compliant |
|------------------------------------------------------------------------------------------------------------|------------------|-------------------------------------------------------------------------------|:-----------:|:---------------:|:-----------------:|
| 🐥[X-Ray](https://aws.amazon.com/releasenotes/AWS-X-Ray?browse=1)										  | 2016-12          | General																	  |✓            |✓                |✓                   |
| 🐥[Lex](https://aws.amazon.com/releasenotes/Amazon-Lex?browse=1)                                           | 2016-11          | Preview                                                                       |             |                 |                   |
| 🐥[Polly](https://aws.amazon.com/releasenotes/Amazon-Polly?browse=1)                                       | 2016-11          | General                                                                       |✓            |✓                |✓                   |
| 🐥[Rekognition](https://aws.amazon.com/releasenotes/Amazon-Rekognition?browse=1) 							 | 2016-11          | General                                                                       |✓            |✓				 |✓  				|
| 🐥[Athena](http://docs.aws.amazon.com/athena/latest/ug/what-is.html) 										 | 2016-11          | General                                                                       |✓             |✓               |✓					|
| 🐥[Batch](http://docs.aws.amazon.com/batch/latest/userguide/what-is-batch.html) 							 | 2016-11          | General                                                                       |✓             |✓			|✓					|
| 🐥[Database Migration Service](https://aws.amazon.com/releasenotes/AWS-Database-Migration-Service?browse=1) | 2016-03          | General                                                                      |              | ✓         		|	✓    			|
| 🐥[Certificate Manager](https://aws.amazon.com/blogs/aws/new-aws-certificate-manager-deploy-ssltls-based-apps-on-aws/) | 2016-01          | General                                                            | ✓		   |✓			|✓					|
| 🐥[IoT](https://aws.amazon.com/blogs/aws/aws-iot-now-generally-available/)                                  | 2015-08          | General                                                                       | ✓           |✓			|✓<sup>[13](#user-content-pci-iot)</sup>					|
| 🐥[WAF](https://aws.amazon.com/releasenotes/AWS-WAF?browse=1)                                               | 2015-10          | General                                                                       | ✓           | ✓         		|	✓    			|
| 🐥[Data Pipeline](https://aws.amazon.com/releasenotes/AWS-Data-Pipeline?browse=1)                           | 2015-10          | General                                                                       | ✓           |				|					|
| 🐥[Elasticsearch](https://aws.amazon.com/releasenotes/Amazon-Elasticsearch-Service?browse=1)                | 2015-10          | General                                                                       | ✓           |✓			|✓					|
| 🐥[Aurora](https://aws.amazon.com/releasenotes/2775579329314699)                                            | 2015-07          | General                                                                       | ✓           | ✓<sup>[3](#user-content-hipaa-aurora)</sup> |	✓<sup>[3](#user-content-hipaa-aurora)</sup>			|
| 🐥[Service Catalog](https://aws.amazon.com/releasenotes/AWS-Service-Catalog?browse=1)                       | 2015-07          | General                                                                       | ✓           |✓			|✓					|
| 🐥[Device Farm](https://aws.amazon.com/releasenotes/AWS-Device-Farm?browse=1)                         	  | 2015-07          | General                                                                       | ✓           |				|					|
| 🐥[CodePipeline](https://aws.amazon.com/releasenotes/AWS-CodePipeline?browse=1)                             | 2015-07          | General                                                                       | ✓           |✓			|					|
| 🐥[CodeCommit](https://aws.amazon.com/releasenotes/AWS-CodeCommit?browse=1)                                 | 2015-07          | General                                                                       | ✓           |✓			|✓					|
| 🐥[API Gateway](https://aws.amazon.com/releasenotes/Amazon-API-Gateway?browse=1)                            | 2015-07          | General                                                                       | ✓           | ✓<sup>[1](#user-content-hipaa-apigateway)</sup>  |	 ✓ 			|
| 🐥[Config](https://aws.amazon.com/releasenotes/AWS-Config?browse=1)                                         | 2015-06          | General                                                                       | ✓           |✓                |  ✓              |
| 🐥[EFS](https://aws.amazon.com/releasenotes/Amazon-EFS?browse=1)                                            | 2015-05          | General                                                                       | ✓           |✓                |✓                  |
| 🐥[Machine Learning](https://aws.amazon.com/releasenotes/AmazonML?browse=1)                                 | 2015-04          | General                                                                       | ✓           |                 |                  |
| [Lambda](https://aws.amazon.com/releasenotes/AWS-Lambda?browse=1)                                          | 2014-11          | General                                                                       | ✓           |✓                |   ✓             |
| [ECS](https://aws.amazon.com/ecs/release-notes/)                                                           | 2014-11          | General                                                                       | ✓           | ✓         		|	✓   			|
| [EKS](https://docs.aws.amazon.com/eks/latest/userguide/platform-versions.html)                                                           | 2018-06          | General                                                                       | ✓<sup>[12](#user-content-eks-cli)</sup>           |✓         		|✓	  			|
| [KMS](https://aws.amazon.com/releasenotes/AWS-KMS?browse=1)                                                | 2014-11          | General                                                                       | ✓           |✓                |   ✓             |
| [CodeDeploy](https://aws.amazon.com/releasenotes/AWS-CodeDeploy?browse=1)                                  | 2014-11          | General                                                                       | ✓           |✓                |                  |
| [Kinesis](https://aws.amazon.com/releasenotes/Amazon-Kinesis?browse=1)                                     | 2013-12          | General                                                                       | ✓           |✓                |   ✓<sup>[11](#user-content-pci-kinesis)</sup>    |
| [CloudTrail](https://aws.amazon.com/releasenotes/AWS-CloudTrail?browse=1)                                  | 2013-11          | General                                                                       | ✓           |✓                |   ✓             |
| [AppStream](https://aws.amazon.com/releasenotes/Amazon-AppStream?browse=1)                                 | 2013-11          | Preview                                                                       |             |✓                |                  |
| [CloudHSM](https://aws.amazon.com/releasenotes/AWS-CloudHSM?browse=1)                                      | 2013-03          | General                                                                       | ✓           |✓                |   ✓            |
| [Silk](https://aws.amazon.com/releasenotes/Amazon-Silk?browse=1)                                           | 2013-03          | Obsolete?                                                                     |             |                 |                  |
| [OpsWorks](https://aws.amazon.com/releasenotes/AWS-OpsWorks?browse=1)                                      | 2013-02          | General                                                                       | ✓           |✓                |   ✓             |
| [Redshift](https://aws.amazon.com/releasenotes/Amazon-Redshift?browse=1)                                   | 2013-02          | General                                                                       | ✓           | ✓         		|	✓   			|
| [Elastic Transcoder](https://aws.amazon.com/releasenotes/Amazon-Elastic-Transcoder?browse=1)               | 2013-01          | General                                                                       | ✓           |                 |                  |
| [Glacier](https://aws.amazon.com/releasenotes/Amazon-Glacier?browse=1)                                     | 2012-08          | General                                                                       | ✓           | ✓         		|	✓	    		|
| [CloudSearch](https://aws.amazon.com/releasenotes/Amazon-CloudSearch?browse=1)                             | 2012-04          | General                                                                       | ✓           |                 |                  |
| [SWF](https://aws.amazon.com/releasenotes/Amazon-SWF?browse=1)                                             | 2012-02          | General                                                                       | ✓           |✓                | ✓                |
| [Storage Gateway](https://aws.amazon.com/releasenotes/AWS-Storage-Gateway?browse=1)                        | 2012-01          | General                                                                       | ✓           |✓                |✓                  |
| [DynamoDB](https://aws.amazon.com/releasenotes/Amazon-DynamoDB?browse=1)                                   | 2012-01          | General                                                                       | ✓           | ✓         		|	  ✓  			|
| [DirectConnect](https://aws.amazon.com/releasenotes/AWS-Direct-Connect?browse=1)                           | 2011-08          | General                                                                       | ✓           | ✓         		|	✓   			|
| [ElastiCache](https://aws.amazon.com/releasenotes/Amazon-ElastiCache?browse=1)                             | 2011-08          | General                                                                       | ✓           |✓<sup>[14](#user-content-pci-elasticache)</sup> |✓<sup>[14](#user-content-pci-elasticache)</sup>                  |
| [CloudFormation](https://aws.amazon.com/releasenotes/AWS-CloudFormation?browse=1)                          | 2011-04          | General                                                                       | ✓           |✓                |  ✓              |
| [SES](https://aws.amazon.com/releasenotes/Amazon-SES?browse=1)                                             | 2011-01          | General                                                                       | ✓           |✓                |                  |
| [Elastic Beanstalk](https://aws.amazon.com/releasenotes/AWS-Elastic-Beanstalk?browse=1)                    | 2010-12          | General                                                                       | ✓           |✓                |  ✓              |
| [Route 53](https://aws.amazon.com/releasenotes/Amazon-Route-53?browse=1)                                   | 2010-10          | General                                                                       | ✓           |✓                | ✓               |
| [IAM](https://aws.amazon.com/releasenotes/AWS-Identity-and-Access-Management?browse=1)                     | 2010-09          | General                                                                       | ✓           |                 |  ✓              |
| [SNS](https://aws.amazon.com/releasenotes/Amazon-SNS?browse=1)                                             | 2010-04          | General                                                                       | ✓           | ✓         		| ✓					|
| [EMR](https://aws.amazon.com/releasenotes/Elastic-MapReduce?browse=1)                                      | 2010-04          | General                                                                       | ✓           | ✓         		|	✓   			|
| [RDS](https://aws.amazon.com/releasenotes/Amazon-RDS?browse=1)                                             | 2009-12          | General                                                                       | ✓           |✓<sup>[2](#user-content-hipaa-rds)</sup>        |✓<sup>[9](#user-content-pci-rds)</sup>				|
| [VPC](https://aws.amazon.com/releasenotes/Amazon-VPC?browse=1)                                             | 2009-08          | General                                                                       | ✓           | ✓         		|	✓   			|
| [Snowball](https://aws.amazon.com/releasenotes/AWS-ImportExport?browse=1)                                  | 2015-10          | General                                                                       | ✓           | ✓         		|✓<sup>[15](#user-content-pci-snowball)</sup>					|
| [Snowmobile](https://aws.amazon.com/snowmobile/)                                                           | 2016-11          | General                                                                       |            |✓                |✓                  |
| [CloudWatch](https://aws.amazon.com/releasenotes/CloudWatch?browse=1)                                      | 2009-05          | General                                                                       | ✓           |✓                |  ✓               |
| [CloudFront](https://aws.amazon.com/releasenotes/CloudFront?browse=1)                                      | 2008-11          | General                                                                       | ✓           | ✓<sup>[4](#user-content-hipaa-cloudfront)</sup>        |  ✓				|
| [Fulfillment Web Service](https://aws.amazon.com/releasenotes/Amazon-FWS?browse=1)                         | 2008-03          | Obsolete?                                                                     |             |                 |                  |
| [SimpleDB](https://aws.amazon.com/releasenotes/Amazon-SimpleDB?browse=1)                                   | 2007-12          | ❗[Nearly obsolete](https://forums.aws.amazon.com/thread.jspa?threadID=121711) | ✓           |                 |  ✓              |
| [DevPay](https://aws.amazon.com/releasenotes/DevPay?browse=1)                                              | 2007-12          | General                                                                       |             |                 |                  |
| [Flexible Payments Service](https://aws.amazon.com/releasenotes/Amazon-FPS?browse=1)                       | 2007-08          | Retired                                                                       |             |                 |                  |
| [EC2](https://aws.amazon.com/releasenotes/Amazon-EC2?browse=1)                                             | 2006-08          | General                                                                       | ✓           | ✓<sup>[5](#user-content-hipaa-ec2sysmgr),[6](#user-content-hipaa-ec2ebs),[7](#user-content-hipaa-ec2elb)</sup>          |	✓<sup>[6](#user-content-hipaa-ec2ebs),[7](#user-content-hipaa-ec2elb),[10](#user-content-pci-asg)</sup>			|
| [SQS](https://aws.amazon.com/releasenotes/Amazon-SQS?browse=1)                                             | 2006-07          | General                                                                       | ✓           | ✓         		| ✓               |
| [S3](https://aws.amazon.com/releasenotes/Amazon-S3?browse=1)                                               | 2006-03          | General                                                                       | ✓           | ✓<sup>[8](#user-content-hipaa-s3)</sup>   |	✓   			|
| [Alexa Top Sites](https://aws.amazon.com/alexa-top-sites/)                                                 | 2006-01          | General ❗HTTP-only                                                            |             |                 |                  |
| [Alexa Web Information Service](https://aws.amazon.com/awis/)                                              | 2005-10          | General ❗HTTP-only                                                            |             |                 |                  |

##### Footnotes
<a name="user-content-hipaa-apigateway">**1**</a>: Excludes use of Amazon API Gateway caching<br />
<a name="user-content-hipaa-rds">**2**</a>: RDS MySQL, Oracle, and PostgreSQL engines only<br />
<a name="user-content-hipaa-aurora">**3**</a>: MySQL-compatible Aurora edition only<br />
<a name="user-content-hipaa-cloudfront">**4**</a>: Excludes Lambda@Edge<br />
<a name="user-content-hipaa-ec2sysmgr">**5**</a>: Includes EC2 Systems Manager<br />
<a name="user-content-hipaa-ec2ebs">**6**</a>: Includes Elastic Block Storage (EBS)<br />
<a name="user-content-hipaa-ec2elb">**7**</a>: Includes Elastic Load Balancing<br />
<a name="user-content-hipaa-s3">**8**</a>: Includes S3 Transfer Acceleration<br />
<a name="user-content-pci-rds">**9**</a>: Includes RDS MySQL, Oracle, PostgreSQL, SQL Server, and MariaDB</br>
<a name="user-content-pci-asg">**10**</a>: Includes Auto-Scaling</br>
<a name="user-content-pci-kinesis">**11**</a>: Data Analytics, Streams, Video Streams and Firehose</br>
<a name="user-content-eks-cli">**12**</a>: Kubernetes uses a custom CLI for Pod/Service management called kubectl. AWS CLI only handles Kubernetes Master concerns</br>
<a name="user-content-pci-iot">**13**</a>: IoT Core (includes Device Management) and Greengrass</br>
<a name="user-content-pci-elasticache">**14**</a>: ElastiCache for Redis only</br>
<a name="user-content-pci-snowball">**15**</a>: Snowball and Snowball Edge</br>


### Compliance

-	Many applications have strict requirements around reliability, security, or data privacy. The [AWS Compliance](https://aws.amazon.com/compliance/) page has details about AWS’s certifications, which include **PCI DSS Level 1**, **SOC 1,2, and 3**, **HIPAA**, and **ISO 9001**.
-	Security in the cloud is a complex topic, based on a [shared responsibility model](https://aws.amazon.com/compliance/shared-responsibility-model/), where some elements of compliance are provided by AWS, and some are provided by your company.
-	Several third-party vendors offer assistance with compliance, security, and auditing on AWS. If you have substantial needs in these areas, assistance is a good idea.
-	From inside **China**, AWS services outside China [are generally accessible](https://en.greatfire.org/aws.amazon.com), though there are at times breakages in service. There are also AWS services [inside China](https://www.amazonaws.cn/en/).

### Getting Help and Support

-	**Forums:** For many problems, it’s worth searching or asking for help in the [discussion forums](https://forums.aws.amazon.com/index.jspa) to see if it’s a known issue.
-	**Premium support:** AWS offers several levels of [premium support](https://aws.amazon.com/premiumsupport/).
	-	The first tier, called "Developer support" lets you file support tickets with 12 to 24 hour turnaround time, it starts at $29 but once your monthly spend reaches around $1000 it changes to a 3% surcharge on your bill.
	-	The higher-level support services are quite expensive — and increase your bill by up to 10%. Many large and effective companies never pay for this level of support. They are usually more helpful for midsize or larger companies needing rapid turnaround on deeper or more perplexing problems.
	-	Keep in mind, a flexible architecture can reduce need for support. You shouldn’t be relying on AWS to solve your problems often. For example, if you can easily re-provision a new server, it may not be urgent to solve a rare kernel-level issue unique to one EC2 instance. If your EBS volumes have recent snapshots, you may be able to restore a volume before support can rectify the issue with the old volume. If your services have an issue in one availability zone, you should in any case be able to rely on a redundant zone or migrate services to another zone.
	-	Larger customers also get access to AWS Enterprise support, with dedicated technical account managers (TAMs) and shorter response time SLAs.
	-	There is definitely some controversy about how useful the paid support is. The support staff don’t always seem to have the information and authority to solve the problems that are brought to their attention. Often your ability to have a problem solved may depend on your relationship with your account rep.
-	**Account manager:** If you are at significant levels of spend (thousands of US dollars plus per month), you may be assigned (or may wish to ask for) a dedicated account manager.
	-	These are a great resource, even if you’re not paying for premium support. Build a good relationship with them and make use of them, for questions, problems, and guidance.
	-	Assign a single point of contact on your company’s side, to avoid confusing or overwhelming them.
-	**Contact:** The main web contact point for AWS is [here](https://aws.amazon.com/contact-us/). Many technical requests can be made via these channels.
-	**Consulting and managed services:** For more hands-on assistance, AWS has established relationships with many [consulting partners](https://aws.amazon.com/partners/consulting/) and [managed service partners](https://aws.amazon.com/partners/msp/). The big consultants won’t be cheap, but depending on your needs, may save you costs long term by helping you set up your architecture more effectively, or offering specific expertise, e.g. security. Managed service providers provide longer-term full-service management of cloud resources.
-	**AWS Professional Services:** AWS provides [consulting services](https://aws.amazon.com/professional-services/) alone or in combination with partners.

### Restrictions and Other Notes

-	🔸Lots of resources in Amazon have [**limits**](http://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html) on them. This is actually helpful, so you don’t incur large costs accidentally. You have to request that quotas be increased by opening support tickets. Some limits are easy to raise, and some are not. (Some of these are noted in sections below.) Additionally, not all service limits are published.
	- **Obtaining Current Limits and Usage:** Limit information for a service may be available from the service API, Trusted Advisor, both or neither (in which case you'll need to contact Support). [This page](http://awslimitchecker.readthedocs.io/en/latest/limits.html) from the awslimitchecker tool's documentation provides a nice summary of available retrieval options for each limit. The [tool](https://github.com/jantman/awslimitchecker) itself is also valuable for automating limit checks.
-	🔸[**AWS terms of service**](https://aws.amazon.com/service-terms/) are extensive. Much is expected boilerplate, but it does contain important notes and restrictions on each service. In particular, there are restrictions against using many AWS services in **safety-critical systems**. (Those appreciative of legal humor may wish to review [clause 42.10](https://www.theguardian.com/technology/2016/feb/11/amazon-terms-of-service-zombie-apocalypse).)

### Related Topics

-	[OpenStack](https://www.openstack.org/) is a private cloud alternative to AWS used by large companies that wish to avoid public cloud offerings.

Learning and Career Development
-------------------------------

### Certifications

-	**Certifications:** AWS offers [**certifications**](https://aws.amazon.com/certification/) for IT professionals who want to demonstrate their knowledge.
  -	[Certified Cloud Practitioner](https://aws.amazon.com/certification/certified-cloud-practitioner/)
  -	[Certified Solutions Architect Associate](https://aws.amazon.com/certification/certified-solutions-architect-associate/)
  -	[Certified Developer Associate](https://aws.amazon.com/certification/certified-developer-associate/)
  -	[Certified SysOps Administrator Associate](https://aws.amazon.com/certification/certified-sysops-admin-associate/)
  -	[Certified Solutions Architect Professional](https://aws.amazon.com/certification/certified-solutions-architect-professional/)
  -	[Certified DevOps Engineer Professional](https://aws.amazon.com/certification/certified-devops-engineer-professional/)
  - [Certified Security – Specialty](https://aws.amazon.com/certification/certified-security-specialty/)
  - [Certified Big Data – Specialty](https://aws.amazon.com/certification/certified-big-data-specialty/)
  - [Certified Advanced Networking – Specialty](https://aws.amazon.com/certification/certified-advanced-networking-specialty/)
  - [Certified Machine Learning – Specialty](https://aws.amazon.com/certification/certified-machine-learning-specialty/)
  - [Certified Alexa Skill Builder – Specialty](https://aws.amazon.com/certification/certified-alexa-skill-builder-specialty/)
  - [Certified Data Analytics – Specialty](https://aws.amazon.com/certification/certified-data-analytics-specialty/)
  - [Certified Database – Specialty](https://aws.amazon.com/certification/certified-database-specialty/)

Associate level certifications were once required as pre-requisites to taking the Professional examinations - this is no longer the case.

-	**Getting certified:** If you’re interested in studying for and getting certifications, [this practical overview](https://gist.github.com/leonardofed/bbf6459ad154ad5215d354f3825435dc) tells you a lot of what you need to know. The official page is [here](https://aws.amazon.com/training/) and there is an [FAQ](https://aws.amazon.com/certification/faqs/).
-	**Training for certifications:** Training is offered by AWS themselves (mainly instructor-led and on-site) and various third-party companies (usually as video-based training) such as [A Cloud Guru](https://acloud.guru/aws-cloud-training), [CloudAcademy](https://cloudacademy.com/library/amazon-web-services/) and [Linux Academy](https://linuxacademy.com/library/topics/AWS/type/Course/).
-	**Do you need a certification?** Especially in consulting companies or when working in key tech roles in large non-tech companies, certifications are important credentials. In others, including in many tech companies and startups, certifications are not common or considered necessary. (In fact, fairly or not, some Silicon Valley hiring managers and engineers see them as a “negative” signal on a resume.)

Certifications are required to access certificate lounges at official AWS events such as [Summits](https://aws.amazon.com/events/summits/) and [re:Invent](https://reinvent.awsevents.com). Lounges typically provide power charging points, seats and relatively better coffee.

Managing AWS
------------

### Managing Infrastructure State and Change

A great challenge in using AWS to build complex systems (and with DevOps in general) is to manage infrastructure state effectively over time. In general, this boils down to three broad goals for the state of your infrastructure:

-	**Visibility**: Do you know the state of your infrastructure (what services you are using, and exactly how)? Do you also know when you — and anyone on your team — make changes? Can you detect misconfigurations, problems, and incidents with your service?
-	**Automation**: Can you reconfigure your infrastructure to reproduce past configurations or scale up existing ones without a lot of extra manual work, or requiring knowledge that’s only in someone’s head? Can you respond to incidents easily or automatically?
-	**Flexibility**: Can you improve your configurations and scale up in new ways without significant effort? Can you add more complexity using the same tools? Do you share, review, and improve your configurations within your team?

Much of what we discuss below is really about how to improve the answers to these questions.

There are several approaches to deploying infrastructure with AWS, from the console to complex automation tools, to third-party services, all of which attempt to help achieve visibility, automation, and flexibility.

### AWS Configuration Management

The first way most people experiment with AWS is via its web interface, the AWS Console. But using the Console is a highly manual process, and often works against automation or flexibility.

So if you’re not going to manage your AWS configurations manually, what should you do? Sadly, there are no simple, universal answers — each approach has pros and cons, and the approaches taken by different companies vary widely, and include directly using APIs (and building tooling on top yourself), using command-line tools, and using third-party tools and services.

### AWS Console

-	The [AWS Console](https://aws.amazon.com/console/) lets you control much (but not all) functionality of AWS via a web interface.
-	Ideally, you should only use the AWS Console in a few specific situations:
	-	It’s great for read-only usage. If you’re trying to understand the state of your system, logging in and browsing it is very helpful.
	-	It is also reasonably workable for very small systems and teams (for example, one engineer setting up one server that doesn’t change often).
	-	It can be useful for operations you’re only going to do rarely, like less than once a month (for example, a one-time VPC setup you probably won’t revisit for a year). In this case using the console can be the simplest approach.
-	❗**Think before you use the console:** The AWS Console is convenient, but also the enemy of automation, reproducibility, and team communication. If you’re likely to be making the same change multiple times, avoid the console. Favor some sort of automation, or at least have a path toward automation, as discussed next. Not only does using the console preclude automation, which wastes time later, but it prevents documentation, clarity, and standardization around processes for yourself and your team.

### Command-Line tools

-	The [**aws command-line interface**](https://aws.amazon.com/cli/) (CLI), used via the **aws** command, is the most basic way to save and automate AWS operations.
-	Don’t underestimate its power. It also has the advantage of being well-maintained — it covers a large proportion of all AWS services, and is up to date.
-	In general, whenever you can, prefer the command line to the AWS Console for performing operations.
-	🔹Even in the absence of fancier tools, you can **write simple Bash scripts** that invoke *aws* with specific arguments, and check these into Git. This is a primitive but effective way to document operations you’ve performed. It improves automation, allows code review and sharing on a team, and gives others a starting point for future work.
-	🔹For use that is primarily interactive (not scripted), consider instead using the [**aws-shell**](https://github.com/awslabs/aws-shell) tool from AWS. It is easier to use, with auto-completion and a colorful UI, but still works on the command line. If you’re using [SAWS](https://github.com/donnemartin/saws), a previous version of the program, [you should migrate to aws-shell](https://github.com/donnemartin/saws/issues/68#issuecomment-240067034).

### APIs and SDKs

-	**SDKs** for using AWS APIs are available in most major languages, with [Go](https://github.com/aws/aws-sdk-go), [iOS](https://github.com/aws/aws-sdk-ios), [Java](https://github.com/aws/aws-sdk-java), [JavaScript](https://github.com/aws/aws-sdk-js), [Python](https://github.com/boto/boto3), [Ruby](https://github.com/aws/aws-sdk-ruby), and [PHP](https://github.com/aws/aws-sdk-php) being most heavily used. AWS maintains [a short list](https://aws.amazon.com/tools/#sdk), but the [awesome-aws list](https://github.com/donnemartin/awesome-aws#sdks-and-samples) is the most comprehensive and current. Note [support for C++](https://github.com/donnemartin/awesome-aws#c-sdk) is [still new](https://aws.amazon.com/blogs/aws/introducing-the-aws-sdk-for-c/).
-	**Retry logic:** An important aspect to consider whenever using SDKs is error handling; under heavy use, a wide variety of failures, from programming errors to throttling to AWS-related outages or failures, can be expected to occur. SDKs typically implement [**exponential backoff**](https://docs.aws.amazon.com/general/latest/gr/api-retries.html) to address this, but this may need to be understood and adjusted over time for some applications. For example, it is often helpful to alert on some error codes and not on others.
-	❗Don’t use APIs directly. Although AWS documentation includes lots of API details, it’s better to use the SDKs for your preferred language to access APIs. SDKs are more mature, robust, and well-maintained than something you’d write yourself.

### Boto

-	A good way to automate operations in a custom way is [**Boto3**](https://github.com/boto/boto3), also known as the [Amazon SDK for Python](http://aws.amazon.com/sdk-for-python/). [**Boto2**](https://github.com/boto/boto), the previous version of this library, has been in wide use for years, but now there is a newer version with official support from Amazon, so prefer Boto3 for new projects.
-	Boto3 contains a variety of APIs that operate at either a high level or a low level, here some explanation of both:
	-	The low level APIs (Client APIs) are mapped to AWS Cloud service-specific APIs, and all service operations are supported by clients. Clients are generated from a JSON service definition file.
	-	The high level option, Resource APIs, allows you to avoid calling the network at the low level and instead provide an object-oriented way to interact with AWS Cloud services.
-	Boto3 has a lot of helpful [**features**](https://boto3.readthedocs.io/en/latest/guide/index.html#general-feature-guides) like *waiters*, which provide a structure that allows for code to wait for changes to occur in the cloud, for example, when you are creating an EC2 instance and need wait until the instance is running in order to perform another task.
-	If you find yourself writing a Bash script with more than one or two CLI commands, you’re probably doing it wrong. Stop, and consider writing a Boto script instead. This has the advantages that you can:
	-	Check return codes easily so success of each step depends on success of past steps.
	-	Grab interesting bits of data from responses, like instance ids or DNS names.
	-	Add useful environment information (for example, tag your instances with git revisions, or inject the latest build identifier into your initialization script).

### General Visibility

-	🔹[**Tagging resources**](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html) is an essential practice, especially as organizations grow, to better understand your resource usage. For example, through automation or convention, you can add tags:
	-	For the org or developer that “owns” that resource
	-	For the product that resource supports
	-	To label lifecycles, such as temporary resources or one that should be deprovisioned in the future
	-	To distinguish production-critical infrastructure (e.g. serving systems vs backend pipelines)
	-	To distinguish resources with special security or compliance requirements
	-	To (once enabled) [allocate cost](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-alloc-tags.html). Note that cost allocation tags only apply on a forward-looking basis; you can't retroactively apply them to items already billed.
	-	For many years, there was a notorious 10 tag limit per resource, which could not be raised and caused many companies significant pain. As of 2016, this was [raised](https://aws.amazon.com/blogs/security/now-organize-your-aws-resources-by-using-up-to-50-tags-per-resource/) to 50 tags per resource.
	-	🔹In 2017, AWS introduced the ability to [enforce tagging](https://aws.amazon.com/blogs/aws/new-tag-ec2-instances-ebs-volumes-on-creation/) on instance and volume creation, deprecating portions of third party tools such as [Cloud Custodian](https://github.com/capitalone/cloud-custodian).
	-	🔸 Tags are case sensitive; 'environment' and 'Environment' are two different tags. Automation in setting tags is likely the only sensible option at significant scale.
	-	🔸 There is a bug in the ASG console where spaces after tag names are preserved. So if you type "Name " with a space at the end you will not get the expected behavior. This is probably true in other locations and SDKs also. Be sure you do not add trailing spaces to tag keys unless you really mean it. (As of Jul 2018)

Managing Servers and Applications
---------------------------------

### AWS vs Server Configuration

This guide is about AWS, not DevOps or server configuration management in general. But before getting into AWS in detail, it’s worth noting that in addition to the configuration management for your AWS resources, there is the long-standing problem of configuration management for servers themselves.

### Philosophy

-	Heroku’s [**Twelve-Factor App**](http://12factor.net/) principles list some established general best practices for deploying applications.
-	**Pets vs cattle:** Treat servers [like cattle, not pets](https://www.engineyard.com/blog/pets-vs-cattle). That is, design systems so infrastructure is disposable. It should be minimally worrisome if a server is unexpectedly destroyed.
-	The concept of [**immutable infrastructure**](http://radar.oreilly.com/2015/06/an-introduction-to-immutable-infrastructure.html) is an extension of this idea.
-	Minimize application state on EC2 instances. In general, instances should be able to be killed or die unexpectedly with minimal impact. State that is in your application should quickly move to RDS, S3, DynamoDB, EFS, or other data stores not on that instance. EBS is also an option, though it generally should not be the bootable volume, and EBS will require manual or automated re-mounting.

### Server Configuration Management

-	There is a [large set](https://en.wikipedia.org/wiki/Comparison_of_open-source_configuration_management_software) of open source tools for managing configuration of server instances.
-	These are generally not dependent on any particular cloud infrastructure, and work with any variety of Linux (or in many cases, a variety of operating systems).
-	Leading configuration management tools are [Puppet](https://github.com/puppetlabs/puppet), [Chef](https://github.com/chef/chef), [Ansible](https://github.com/ansible/ansible), and [Saltstack](https://github.com/saltstack/salt). These aren’t the focus of this guide, but we may mention them as they relate to AWS.

### Containers and AWS

-	[Docker](http://blog.scottlowe.org/2014/03/11/a-quick-introduction-to-docker/) and the containerization trend are changing the way many servers and services are deployed in general.
-	Containers are designed as a way to package up your application(s) and all of their dependencies in a known way. When you build a container, you are including every library or binary your application needs, outside of the kernel. A big advantage of this approach is that it’s easy to test and validate a container locally without worrying about some difference between your computer and the servers you deploy on.
-	A consequence of this is that you need fewer AMIs and boot scripts; for most deployments, the only boot script you need is a template that fetches an exported docker image and runs it.
-	Companies that are embracing [microservice architectures](http://martinfowler.com/articles/microservices.html) will often turn to container-based deployments.
-	AWS launched [ECS](https://aws.amazon.com/ecs/) as a service to manage clusters via Docker in late 2014, though many people still deploy Docker directly themselves. See the [ECS section](#ecs) for more details.
-	AWS launched [EKS](https://aws.amazon.com/eks/) as a service to manage Kubernetes Clusters mid 2018, though many people still deploy ECS or use Docker directly themselves. See the [EKS section](#eks) for more details.

### Visibility

-	Store and track instance metadata (such as instance id, availability zone, etc.) and deployment info (application build id, Git revision, etc.) in your logs or reports. The [**instance metadata service**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) can help collect some of the AWS data you’ll need.
-	**Use log management services:** Be sure to set up a way to view and manage logs externally from servers.
	-	Cloud-based services such as [Sumo Logic](https://www.sumologic.com/), [Splunk Cloud](http://www.splunk.com/en_us/cloud.html), [Scalyr](https://www.scalyr.com/), [LogDNA](https://www.logdna.com/), and [Loggly](https://www.loggly.com/) are the easiest to set up and use (and also the most expensive, which may be a factor depending on how much log data you have).
	-	Major open source alternatives include [Elasticsearch](https://github.com/elastic/elasticsearch), [Logstash](https://github.com/elastic/logstash), and [Kibana](https://github.com/elastic/kibana) (the “[Elastic Stack](https://www.elastic.co/webinars/introduction-elk-stack)”) and [Graylog](https://www.graylog.org/).
	-	If you can afford it (you have little data or lots of money) and don’t have special needs, it makes sense to use hosted services whenever possible, since setting up your own scalable log processing systems is notoriously time consuming.
-	**Track and graph metrics:** The AWS Console can show you simple graphs from CloudWatch, you typically will want to track and graph many kinds of metrics, from CloudWatch and your applications. Collect and export helpful metrics everywhere you can (and as long as volume is manageable enough you can afford it).
	-	Services like [Librato](https://www.librato.com/), [KeenIO](https://keen.io/), and [Datadog](https://www.datadoghq.com/) have fancier features or better user interfaces that can save a lot of time. (A more detailed comparison is [here](http://blog.takipi.com/production-tools-guide/visualization-and-metrics/).)
	-	Use [Prometheus](https://prometheus.io) or [Graphite](https://github.com/graphite-project/graphite-web) as timeseries databases for your metrics (both are open source).
	-	[Grafana](https://github.com/grafana/grafana) can visualize with dashboards the stored metrics of both timeseries databases (also open source).

### Tips for Managing Servers

-	❗**Timezone settings on servers**: unless *absolutely necessary*, always **set the timezone on servers to [UTC](https://en.wikipedia.org/wiki/Coordinated_Universal_Time)** (see instructions for your distribution, such as [Ubuntu](https://www.digitalocean.com/community/tutorials/how-to-set-up-timezone-and-ntp-synchronization-on-ubuntu-14-04-quickstart), [CentOS](https://www.vultr.com/docs/setup-timezone-and-ntp-on-centos-6) or [Amazon](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-time.html) Linux). Numerous distributed systems rely on time for synchronization and coordination and UTC [provides](https://blog.serverdensity.com/set-your-server-timezone-to-utc/) the universal reference plane: it is not subject to  daylight savings changes and adjustments in local time. It will also save you a lot of headache debugging [elusive timezone issues](http://yellerapp.com/posts/2015-01-12-the-worst-server-setup-you-can-make.html) and provide coherent timeline of events in your logging and audit systems.
-	**NTP and accurate time:** If you are not using Amazon Linux (which comes preconfigured), you should confirm your servers [configure NTP correctly](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-time.html#configure_ntp), to avoid insidious time drift (which can then cause all sorts of issues, from breaking API calls to misleading logs). This should be part of your automatic configuration for every server. If time has already drifted substantially (generally >1000 seconds), remember NTP won’t shift it back, so you may need to remediate manually (for example, [like this](http://askubuntu.com/questions/254826/how-to-force-a-clock-update-using-ntp) on Ubuntu).
-	**Testing immutable infrastructure:** If you want to be proactive about testing your service’s ability to cope with instance termination or failure, it can be helpful to introduce random instance termination during business hours, which will expose any such issues at a time when engineers are available to identify and fix them. Netflix’s [Simian Army](https://github.com/Netflix/SimianArmy) (specifically, [Chaos Monkey](https://github.com/Netflix/SimianArmy/wiki/Chaos-Monkey)) is a popular tool for this. Alternatively, [chaos-lambda](https://github.com/bbc/chaos-lambda) by the BBC is a lightweight option which runs on AWS [Lambda](#lambda).

Security and IAM
----------------

We cover security basics first, since configuring user accounts is something you usually have to do early on when setting up your system.

### Security and IAM Basics

-	📒 IAM [Homepage](https://aws.amazon.com/iam/) ∙ [User guide](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html) ∙ [FAQ](https://aws.amazon.com/iam/faqs/)
-	The [AWS Security Blog](https://blogs.aws.amazon.com/security) is one of the best sources of news and information on AWS security.
-	**IAM** is the service you use to manage accounts and permissioning for AWS.
-	Managing security and access control with AWS is critical, so every AWS administrator needs to use and understand IAM, at least at a basic level.
-	[IAM identities](https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html) include users (people or services that are using AWS), groups (containers for sets of users and their permissions), and roles (containers for permissions assigned to AWS service instances). [Permissions](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_permissions.html) for these identities are governed by [policies](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html) You can use AWS pre-defined policies or custom policies that you create.
-	IAM manages various kinds of authentication, for both users and for software services that may need to authenticate with AWS, including:
	-	[**Passwords**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_passwords.html) to log into the console. These are a username and password for real users.
	-	[**Access keys**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html), which you may use with command-line tools. These are two strings, one the “id”, which is an upper-case alphabetic string of the form 'AXXXXXXXXXXXXXXXXXXX', and the other is the secret, which is a 40-character mixed-case base64-style string. These are often set up for services, not just users.
		-	📜 Access keys that start with AKIA are normal keys. Access keys that start with ASIA are session/temporary keys from STS, and will require an additional "SessionToken" parameter to be sent along with the id and secret. See the documentation for [a complete list of access key prefixes](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html#identifiers-prefixes).
	-	[**Multi-factor authentication (MFA)**](https://aws.amazon.com/iam/details/mfa/), which is the highly recommended practice of using a keychain fob or smartphone app as a second layer of protection for user authentication.
-	IAM allows complex and fine-grained control of permissions, dividing users into groups, assigning permissions to roles, and so on. There is a [policy language](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html) that can be used to customize security policies in a fine-grained way.
	-	An excellent high level overview of IAM policy concepts lives at [IAM Policies In A Nutshell](http://start.jcolemorrison.com/aws-iam-policies-in-a-nutshell/).
	-	🔸The policy language has a complex and error-prone JSON syntax that’s quite confusing, so unless you are an expert, it is wise to base yours off trusted examples or AWS’ own pre-defined [managed policies](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html).
-	At the beginning, IAM policy may be very simple, but for large systems, it will grow in complexity, and need to be managed with care.
	-	🔹Make sure one person (perhaps with a backup) in your organization is formally assigned ownership of managing IAM policies, make sure every administrator works with that person to have changes reviewed. This goes a long way to avoiding accidental and serious misconfigurations.
-	It is best to give each user or service the minimum privileges needed to perform their duties. This is the [principle of least privilege](https://en.wikipedia.org/wiki/Principle_of_least_privilege), one of the foundations of good security. Organize all IAM users and groups according to levels of access they need.
-	IAM has the [permission hierarchy](http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html) of:
	1. Explicit deny: The most restrictive policy wins.
	2. Explicit allow: Access permissions to any resource has to be explicitly given.
	3. Implicit deny: All permissions are implicitly denied by default.
-	You can test policy permissions via the AWS IAM [policy simulator tool tool](https://policysim.aws.amazon.com/home/index.jsp). This is particularly useful if you write custom policies.


### Security and IAM Tips

-	🔹Use IAM to create individual user accounts and **use IAM accounts for all users from the beginning**. This is slightly more work, but not that much.
	-	That way, you define different users, and groups with different levels of privilege (if you want, choose from Amazon’s default suggestions, of administrator, power user, etc.).
	-	This allows credential revocation, which is critical in some situations. If an employee leaves, or a key is compromised, you can revoke credentials with little effort.
	-	You can set up [Active Directory federation](https://blogs.aws.amazon.com/security/post/Tx71TWXXJ3UI14/Enabling-Federation-to-AWS-using-Windows-Active-Directory-ADFS-and-SAML-2-0) to use organizational accounts in AWS.
-	❗**Enable [MFA](https://aws.amazon.com/iam/details/mfa/)** on your account.
	-	You should always use MFA, and the sooner the better — enabling it when you already have many users is extra work.
	-	Unfortunately it can’t be enforced in software, so an administrative policy has to be established.
	-	Most users can use the Google Authenticator app (on [iOS](https://itunes.apple.com/us/app/google-authenticator/id388497605) or [Android](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2)) to support two-factor authentication. For the root account, consider a hardware fob.
- ❗Restrict use of significant IAM credentials as much as possible. Remember that in the cloud, loss of a highly capable IAM credential could essentially mean “game over,” for your deployment, your users, or your whole company.
  -	**Do NOT use the [Root User account](http://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html)** other than when you initially create your account.  Create custom IAM users and/or roles and use those for your applications instead.
	- Lock up access and use of the root credentials as much as possible. Ideally they should be effectively “offline.” For critical deployments, this means attached to an actual MFA device, physically secured and rarely used.
-	❗**Turn on CloudTrail:** One of the first things you should do is [enable CloudTrail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-a-trail-using-the-console-first-time.html). Even if you are not a security hawk, there is little reason not to do this from the beginning, so you have data on what has been happening in your AWS account should you need that information. You’ll likely also want to set up a [log management service](#visibility) to search and access these logs.
-	🔹**Use IAM roles for EC2:** Rather than assign IAM users to applications like services and then sharing the sensitive credentials, [define and assign roles to EC2 instances](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html) and have applications retrieve credentials from the [instance metadata](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html).
-	Assign IAM roles by realm — for example, to development, staging, and production. If you’re setting up a role, it should be tied to a specific realm so you have clean separation. This prevents, for example, a development instance from connecting to a production database.
-	**Best practices:** AWS’ [list of best practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html) is worth reading in full up front.
-	**IAM Reference:** [This interactive reference for all IAM actions, effects, and resources](https://iam.cloudonaut.io/) is great to have open while writing new or trying to understand existing IAM policies.
-	**Multiple accounts:** Decide on whether you want to use multiple AWS accounts and [research](https://dab35129f0361dca3159-2fe04d8054667ffada6c4002813eccf0.ssl.cf1.rackcdn.com/downloads/pdfs/Rackspace%20Best%20Practices%20for%20AWS%20-%20Identity%20Managment%20-%20Billing%20-%20Auditing.pdf) how to organize access across them. Factors to consider:
	-	Number of users
	-	Importance of isolation
		-	Resource Limits
		-	Permission granularity
		-	Security
		-	API Limits
	-	Regulatory issues
	-	Workload
	-	Size of infrastructure
	-	Cost of multi-account “overhead”: Internal AWS service management tools may need to be custom built or adapted.
	-	🔹It can help to use separate AWS accounts for independent parts of your infrastructure if you expect a high rate of AWS API calls, since AWS [throttles calls](http://docs.aws.amazon.com/AWSEC2/latest/APIReference/query-api-troubleshooting.html#api-request-rate) at the AWS account level.
-	[**Inspector**](https://aws.amazon.com/inspector/) is an automated security assessment service from AWS that helps identify common security risks. This allows validation that you adhere to certain security practices and may help with compliance.
-	[**Trusted Advisor**](https://aws.amazon.com/blogs/aws/trusted-advisor-console-basic/) addresses a variety of best practices, but also offers some basic security checks around IAM usage, security group configurations, and MFA. At paid support tiers, Trusted Advisor exposes additional checks around other areas, such as reserved instance optimization.
-	**Use KMS for managing keys**: AWS offers [KMS](#kms) for securely managing encryption keys, which is usually a far better option than handling key security yourself. See [below](#kms).
-	[**AWS WAF**](https://aws.amazon.com/waf) is a web application firewall to help you protect your applications from common attack patterns.
-	**Security auditing:**
	-	[Security Monkey](https://github.com/Netflix/security_monkey) is an open source tool that is designed to assist with security audits.
	-	[Scout2](https://github.com/nccgroup/Scout2) is an open source tool that uses AWS APIs to assess an environment’s security posture. Scout2 is stable and actively maintained.
	-	🔹**Export and audit security settings:** You can audit security policies simply by exporting settings using AWS APIs, e.g. using a Boto script like [SecConfig.py](https://gist.github.com/jlevy/cce1b44fc24f94599d0a4b3e613cc15d) (from [this 2013 talk](http://www.slideshare.net/AmazonWebServices/intrusion-detection-in-the-cloud-sec402-aws-reinvent-2013)) and then reviewing and monitoring changes manually or automatically.

### Security and IAM Gotchas and Limitations

-	❗**Don’t share user credentials:** It’s remarkably common for first-time AWS users to create one account and one set of credentials (access key or password), and then use them for a while, sharing among engineers and others within a company. This is easy. But *don’t do this*. This is an insecure practice for many reasons, but in particular, if you do, you will have reduced ability to revoke credentials on a per-user or per-service basis (for example, if an employee leaves or a key is compromised), which can lead to serious complications.
-	❗**Instance metadata throttling:** The [instance metadata service](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) has rate limiting on API calls. If you deploy IAM roles widely (as you should!) and have lots of services, you may hit global account limits easily.
	-	One solution is to have code or scripts cache and reuse the credentials locally for a short period (say 2 minutes). For example, they can be put into the ~/.aws/credentials file but must also be refreshed automatically.
	-	But be careful not to cache credentials for too long, as [they expire](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#instance-metadata-security-credentials). (Note the other [dynamic metadata](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#dynamic-data-categories) also changes over time and should not be cached a long time, either.)
-	🔸Some IAM operations are slower than other API calls (many seconds), since AWS needs to propagate these globally across regions.
-	❗The uptime of IAM’s API has historically been lower than that of the instance metadata API. Be wary of incorporating a dependency on IAM’s API into critical paths or subsystems — for example, if you validate a user’s IAM group membership when they log into an instance and aren’t careful about precaching group membership or maintaining a back door, you might end up locking users out altogether when the API isn’t available.
-	❗**Don't check in AWS credentials or secrets to a git repository.** There are bots that scan GitHub looking for credentials. Use scripts or tools, such as [git-secrets](https://github.com/awslabs/git-secrets) to prevent anyone on your team from checking in sensitive information to your git repositories.

S3
--

### S3 Basics

-	📒 [Homepage](https://aws.amazon.com/s3/) ∙ [Developer guide](https://docs.aws.amazon.com/AmazonS3/latest/dev/Welcome.html) ∙ [FAQ](https://aws.amazon.com/s3/faqs/) ∙ [Pricing](https://aws.amazon.com/s3/pricing/)
-	**S3** (Simple Storage Service) is AWS’ standard cloud storage service, offering file (opaque “blob”) storage of arbitrary numbers of files of almost any size, from 0 to **5TB**. (Prior to [2011](https://aws.amazon.com/releasenotes/Amazon-S3/1917932037969964) the maximum size was 5 GB; larger sizes are now well supported via [multipart support](https://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html).)
-	Items, or **objects**, are placed into named **buckets** stored with names which are usually called **keys**. The main content is the **value**.
-	Objects are created, deleted, or updated. Large objects can be streamed, but you cannot modify parts of a value; you need to update the whole object. Partial data access can work via [S3 Select](https://aws.amazon.com/blogs/aws/s3-glacier-select/).
-	Every object also has [**metadata**](https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html), which includes arbitrary key-value pairs, and is used in a way similar to HTTP headers. Some metadata is system-defined, some are significant when serving HTTP content from buckets or CloudFront, and you can also define arbitrary metadata for your own use.
-	**S3 URIs:** Although often bucket and key names are provided in APIs individually, it’s also common practice to write an S3 location in the form 's3://bucket-name/path/to/key' (where the key here is 'path/to/key'). (You’ll also see 's3n://' and 's3a://' prefixes [in Hadoop systems](https://cwiki.apache.org/confluence/display/HADOOP2/AmazonS3).)
-	**S3 vs Glacier, EBS, and EFS:** AWS offers many storage services, and several besides S3 offer file-type abstractions. [Glacier](#glacier) is for cheaper and infrequently accessed archival storage. [EBS](#ebs), unlike S3, allows random access to file contents via a traditional filesystem, but can only be attached to one EC2 instance at a time. [EFS](#efs) is a network filesystem many instances can connect to, but at higher cost. See the [comparison table](#storage-durability-availability-and-price).

### S3 Tips

-	For most practical purposes, you can consider S3 capacity unlimited, both in total size of files and number of objects. The number of objects in a bucket is essentially also unlimited. Customers routinely have millions of objects.
-   ❗**Permissions:**
    -   🔸If you're storing business data on Amazon S3, it’s important to manage permissions sensibly. In 2017 companies like [Dow Jones and Verizon](http://www.techrepublic.com/article/massive-amazon-s3-breaches-highlight-blind-spots-in-enterprise-race-to-the-cloud/) saw data breaches due to poorly-chosen S3 configuration for sensitive data. Fixing this later can be a difficult task if you have a lot of assets and internal users.
    -   🔸There are 3 different ways to grant permissions to access Amazon S3 content in your buckets.
        + **IAM policies** use the familiar [Identity and Authentication Management](#security-and-iam) permission scheme to control access to specific operations.
        + **Bucket policies** grant or deny permissions to an entire bucket. You might use this when hosting a website in S3, to make the bucket publicly readable, or to restrict access to a bucket by IP address. Amazon's [sample bucket policies](http://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html) show a number of use cases where these policies come in handy.
        + **[Access Control Lists](http://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html)** (ACLs) can also be applied to every bucket and object stored in S3. ACLs grant additional permissions beyond those specified in IAM or bucket policies. ACLs can be used to grant access to another AWS user, or to predefined groups like the general public. This is powerful but can be dangerous, because you need to inspect every object to see who has access.
    -   🔸AWS' [predefined access control groups](http://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#specifying-grantee-predefined-groups) allow access that may not be what you'd expect from their names:
        +   **"All Users", or "Everyone", grants permission to the general public**, not only to users defined in your own AWS account. If an object is available to All Users, then it can be retrieved with a simple HTTP request of the form `http://s3.amazonaws.com/bucket-name/filename`. No authorization or signature is required to access data in this category.
        +   **"Authenticated Users" grants permissions to anyone with an AWS account**, again not limited to your own users. Because anyone can sign up for AWS, for all intents and purposes **this is also open to the general public**.
        +   **"Log Delivery" group is used by AWS to write logs to buckets** and should be safe to enable on the buckets that need it.
        +   A typical use case of this ACL is used in conjunction with the [requester pays](http://docs.aws.amazon.com/AmazonS3/latest/dev/RequesterPaysBuckets.html) functionality of S3.
    -   ❗ Bucket permissions and object permissions are two different things and independent of each other. A private object in a public bucket can be seen when listing the bucket, but not downloaded. At the same time, a public object in a private bucket won't be seen because the bucket contents can't be listed, but can still be downloaded by anyone who knows its exact key. Users that don't have access to set bucket permissions can still make objects public if they have `s3:PutObjectAcl` or `s3:PutObjectVersionAcl` [permissions](http://docs.aws.amazon.com/AmazonS3/latest/dev/using-with-s3-actions.html).
    -   🐥In August 2017, AWS added [AWS Config rules to ensure your S3 buckets are secure](https://aws.amazon.com/blogs/aws/aws-config-update-new-managed-rules-to-secure-s3-buckets/).
        +    ❗These AWS Config rules only check the security of your bucket policy and bucket-level ACLs. You can still create object ACLs that grant additional permissions, including opening files to the whole world.
    -   🔹Do create new buckets if you have different types of data with different sensitivity levels. This is much less error prone than complex permissions rules. For example, if data is for administrators only, like log data, put it in a new bucket that only administrators can access.
    -   For more guidance, see:
        +   [How to Secure an Amazon S3 Bucket](https://read.acloud.guru/how-to-secure-an-s3-bucket-7e2dbd34e81b)
        +   [Deep dive into S3 access controls](https://labs.detectify.com/2017/07/13/a-deep-dive-into-aws-s3-access-controls-taking-full-control-over-your-assets/).
        +   [How do S3 permissions work?](https://brandonwamboldt.ca/understanding-s3-permissions-1662/).
-	**Bucket naming:** Buckets are chosen from a global namespace (across all regions, even though S3 itself stores data in [whichever S3 region](https://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region) you select), so you’ll find many bucket names are already taken. Creating a bucket means taking ownership of the name until you delete it. Bucket names have [a few restrictions](https://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html) on them.
	-	Bucket names can be used as part of the hostname when accessing the bucket or its contents, like `<bucket_name>.s3-us-east-1.amazonaws.com`, as long as the name is [DNS compliant](http://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html).
	-	A common practice is to use the company name acronym or abbreviation to prefix (or suffix, if you prefer DNS-style hierarchy) all bucket names (but please, don’t use a check on this as a security measure — this is highly insecure and easily circumvented!).
	-	🔸Bucket names with '.' (periods) in them [can cause certificate mismatches](https://forums.aws.amazon.com/thread.jspa?threadID=169951) when used with SSL. Use '-' instead, since this then conforms with both SSL expectations and is DNS compliant.
-	**Versioning:** S3 has [optional versioning support](https://docs.aws.amazon.com/AmazonS3/latest/dev/ObjectVersioning.html), so that all versions of objects are preserved on a bucket. This is mostly useful if you want an archive of changes or the ability to back out mistakes (caution: it lacks the featureset of full version control systems like Git).
-	**Durability:** Durability of S3 is extremely high, since internally it keeps several replicas. If you don’t delete it by accident, you can count on S3 not losing your data. (AWS offers the seemingly improbable durability rate of [99.999999999%](https://aws.amazon.com/s3/faqs/#How_durable_is_Amazon_S3), but this is a mathematical calculation based on independent failure rates and levels of replication — not a true probability estimate. Either way, S3 has had [a very good record](https://www.quora.com/Has-Amazon-S3-ever-lost-data-permanently) of durability.) Note this is *much* higher durability than EBS!
-	💸**S3 pricing** depends on [storage, requests, and transfer](https://aws.amazon.com/s3/pricing/).
	-	For transfer, putting data into AWS is free, but you’ll pay on the way out. Transfer from S3 to EC2 in the *same region* is free. Transfer to other regions or the Internet in general is not free.
	-	Deletes are free.
-	**S3 Reduced Redundancy and Infrequent Access:** Most people use the Standard storage class in S3, but there are other storage classes with lower cost:
	-	🔸[Reduced Redundancy Storage (RRS)](https://aws.amazon.com/s3/reduced-redundancy/) has been [effectively deprecated](https://www.lastweekinaws.com/blog/s3-reduced-redundancy-storage-is-dead/), and has lower durability (99.99%, so just four nines) than standard S3. Note that it no longer participates in S3 price reductions, so it offers worse redundancy for more money than standard S3. As a result, there's no reason to use it.
	-	[Infrequent Access (IA)](https://aws.amazon.com/s3/storage-classes/#Infrequent_Access) lets you get cheaper storage in exchange for more expensive access. This is great for archives like logs you already processed, but might want to look at later. To get an idea of the cost savings when using Infrequent Access (IA), you can use this [S3 Infrequent Access Calculator](http://www.gulamshakir.com/apps/s3calc/index.html).
	-	[S3 - Intelligent Tiering](https://aws.amazon.com/about-aws/whats-new/2018/11/s3-intelligent-tiering/) storage class is designed to optimize costs by automatically moving data to the most cost-effective access tier, without performance impact or operational overhead.
	-	[S3 - One Zone - IA](https://aws.amazon.com/s3/storage-classes/#__) is for data that is accessed less frequently, but requires rapid access when needed. Unlike other S3 Storage Classes which store data in a minimum of three Availability Zones (AZs), S3 One Zone-IA stores data in a single AZ and costs 20% less than S3 Standard-IA.
	-	[Glacier](#glacier) is a third alternative discussed as a separate product.
	-	See [the comparison table](#storage-durability-availability-and-price).
-	⏱**Performance:** Maximizing S3 performance means improving overall throughput in terms of bandwidth and number of operations per second.
	-	S3 is highly scalable, so in principle you can get arbitrarily high throughput. (A good example of this is [S3DistCp](https://docs.aws.amazon.com/ElasticMapReduce/latest/ReleaseGuide/UsingEMR_s3distcp.html).)
	-	But usually you are constrained by the pipe between the source and S3 and/or the level of concurrency of operations.
	-	Throughput is of course highest from within AWS to S3, and between EC2 instances and S3 buckets that are in the same region.
	-	Bandwidth from EC2 depends on instance type. See the “Network Performance” column at [ec2instances.info](http://www.ec2instances.info/).
	-	Throughput of many objects is extremely high when data is accessed in a distributed way, from many EC2 instances. It’s possible to read or write objects from S3 from hundreds or thousands of instances at once.
	-	However, throughput is very limited when objects accessed sequentially from a single instance. Individual operations take many milliseconds, and bandwidth to and from instances is limited.
	-	Therefore, to perform large numbers of operations, it’s necessary to use multiple worker threads and connections on individual instances, and for larger jobs, multiple EC2 instances as well.
	-	**Multi-part uploads:** For large objects you want to take advantage of the multi-part uploading capabilities (starting with minimum chunk sizes of 5 MB).
	-	**Large downloads:** Also you can download chunks of a single large object in parallel by exploiting the HTTP GET range-header capability.
	-	🔸**List pagination:** Listing contents happens at 1000 responses per request, so for buckets with many millions of objects listings will take time.
	-	❗**Key prefixes:** Previously randomness in the beginning of key names was necessary in order to avoid hot spots, but that is [no longer necessary](https://aws.amazon.com/about-aws/whats-new/2018/07/amazon-s3-announces-increased-request-rate-performance/) as of July, 2018.
	-	For data outside AWS, [**DirectConnect**](https://aws.amazon.com/directconnect/) and [**S3 Transfer Acceleration**](https://aws.amazon.com/blogs/aws/aws-storage-update-amazon-s3-transfer-acceleration-larger-snowballs-in-more-regions/) can help. For S3 Transfer Acceleration, you [pay](https://aws.amazon.com/s3/pricing/) about the equivalent of 1-2 months of storage for the transfer in either direction for using nearer endpoints.
-	**Command-line applications:** There are a few ways to use S3 from the command line:
	-	Originally, [**s3cmd**](https://github.com/s3tools/s3cmd) was the best tool for the job. It’s still used heavily by many.
	-	The regular [**aws**](https://aws.amazon.com/cli/) command-line interface now supports S3 well, and is useful for most situations.
	-	[**s4cmd**](https://github.com/bloomreach/s4cmd) is a replacement, with greater emphasis on performance via multi-threading, which is helpful for large files and large sets of files, and also offers Unix-like globbing support.
-	**GUI applications:** You may prefer a GUI, or wish to support GUI access for less technical users. Some options:
	-	The [AWS Console](https://aws.amazon.com/console/) does offer a graphical way to use S3. Use caution telling non-technical people to use it, however, since without tight permissions, it offers access to many other AWS features.
	-	[Transmit](https://panic.com/transmit/) is a good option on macOS for most use cases.
	-	[Cyberduck](https://cyberduck.io/) is a good option on macOS and Windows with support for multipart uploads, ACLs, versioning, lifecycle configuration, storage classes and server side encryption (SSE-S3 and SSE-KMS).
-	**S3 and CloudFront:** S3 is tightly integrated with the CloudFront CDN. See the CloudFront section for more information, as well as [S3 transfer acceleration](https://docs.aws.amazon.com/AmazonS3/latest/dev/transfer-acceleration.html).
-	**Static website hosting:**
	-	S3 has a [static website hosting option](http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html) that is simply a setting that enables configurable HTTP index and error pages and [HTTP redirect support](http://docs.aws.amazon.com/AmazonS3/latest/dev/how-to-page-redirect.html) to [public content](http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteAccessPermissionsReqd.html) in S3. It’s a simple way to host static assets or a fully static website.
	-	Consider using CloudFront in front of most or all assets:
		-	Like any CDN, CloudFront improves performance significantly.
		-	🔸SSL is only supported on the built-in amazonaws.com domain for S3. S3 supports serving these sites through a [custom domain](http://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html), but [not over SSL on a custom domain](http://stackoverflow.com/questions/11201316/how-to-configure-ssl-for-amazon-s3-bucket). However, [CloudFront allows you to serve a custom domain over https](http://docs.aws.amazon.com/acm/latest/userguide/gs-cf.html). Amazon provides free SNI SSL/TLS certificates via Amazon Certificate Manager. [SNI does not work on very outdated browsers/operating systems](https://en.wikipedia.org/wiki/Server_Name_Indication#Support). Alternatively, you can provide your own certificate to use on CloudFront to support all browsers/operating systems for a fee.
		-	🔸If you are including resources across domains, such as fonts inside CSS files, you may need to [configure CORS](https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html) for the bucket serving those resources.
		-	Since pretty much everything is moving to SSL nowadays, and you likely want control over the domain, you probably want to set up CloudFront with your own certificate in front of S3 (and to ignore the [AWS example on this](http://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html) as it is non-SSL only).
		-	That said, if you do, you’ll need to think through invalidation or updates on CloudFront. You may wish to [include versions or hashes in filenames](https://abhishek-tiwari.com/CloudFront-design-patterns-and-best-practices) so invalidation is not necessary.
-	**Data lifecycles:**
	-	When managing data, the understanding the lifecycle of the data is as important as understanding the data itself. When putting data into a bucket, think about its lifecycle — its end of life, not just its beginning.
	-	🔹In general, data with different expiration policies should be stored under separate prefixes at the top level. For example, some voluminous logs might need to be deleted automatically monthly, while other data is critical and should never be deleted. Having the former in a separate bucket or at least a separate folder is wise.
	-	🔸Thinking about this up front will save you pain. It’s very hard to clean up large collections of files created by many engineers with varying lifecycles and no coherent organization.
	-	Alternatively you can set a lifecycle policy to archive old data to Glacier. [Be careful](https://alestic.com/2012/12/s3-glacier-costs/) with archiving large numbers of small objects to Glacier, since it may actually cost more.
	-	There is also a storage class called [**Infrequent Access**](https://aws.amazon.com/s3/storage-classes/#Infrequent_Access) that has the same durability as Standard S3, but is discounted per GB. It is suitable for objects that are infrequently accessed.
-	**Data consistency:** Understanding [data consistency](https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel) is critical for any use of S3 where there are multiple producers and consumers of data.
	-	Creation and updates to individual objects in S3 are **atomic**, in that you’ll never upload a new object or change an object and have another client see only part half the change.
	- The uncertainty lies with *when* your clients and other clients see updates.
	-	**New objects:** If you create a new object, you’ll be able to read it instantly, which is called **read-after-write consistency**.
		-	Well, with the additional caveat that if you do a read on an object before it exists, then create it, [you get eventual consistency](https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel) (not read-after-write).
		-	This does not apply to any list operations; newly created objects are [not guaranteed to appear in a list operation right away](https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel)
	-	**Updates to objects:** If you overwrite or delete an object, you’re only guaranteed **eventual consistency**, i.e. the change will happen but you have no guarantee of when.
	- 🔹For many use cases, treating S3 objects as **immutable** (i.e. deciding by convention they will be created or deleted but not updated) can greatly simplify the code that uses them, avoiding complex state management.
	-	🔹Note that [until 2015](https://aws.amazon.com/about-aws/whats-new/2015/08/amazon-s3-introduces-new-usability-enhancements/), 'us-standard' region had had a weaker eventual consistency model, and the other (newer) regions were read-after-write. This was finally corrected — but watch for many old blogs mentioning this!
	-	**Slow updates:** In practice, “eventual consistency” usually means within seconds, but expect rare cases of minutes or [hours](http://www.stackdriver.com/eventual-consistency-really-eventual/).
-	**S3 as a filesystem:**
	-	In general S3’s APIs have inherent limitations that make S3 hard to use directly as a POSIX-style filesystem while still preserving S3’s own object format. For example, appending to a file requires rewriting, which cripples performance, and atomic rename of directories, mutual exclusion on opening files, and hardlinks are impossible.
	-	[s3fs](https://github.com/s3fs-fuse/s3fs-fuse) is a FUSE filesystem that goes ahead and tries anyway, but it has performance limitations and surprises for these reasons.
	-	[Riofs](https://github.com/skoobe/riofs) (C) and [Goofys](https://github.com/kahing/goofys) (Go) are more recent efforts that attempt adopt a different data storage format to address those issues, and so are likely improvements on s3fs.
	-	[S3QL](https://github.com/s3ql/s3ql) ([discussion](https://news.ycombinator.com/item?id=10150684)) is a Python implementation that offers data de-duplication, snap-shotting, and encryption, but only one client at a time.
	-	[ObjectiveFS](https://objectivefs.com/) ([discussion](https://news.ycombinator.com/item?id=10117506)) is a commercial solution that supports filesystem features and concurrent clients.
-	If you are primarily using a VPC, consider setting up a [VPC Endpoint](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html) for S3 in order to allow your VPC-hosted resources to easily access it without the need for extra network configuration or hops.
-	**Cross-region replication:** S3 has [a feature](https://docs.aws.amazon.com/AmazonS3/latest/dev/crr.html) for replicating a bucket between one region and another. Note that S3 is already highly replicated within one region, so usually this isn’t necessary for durability, but it could be useful for compliance (geographically distributed data storage), lower latency, or as a strategy to reduce region-to-region bandwidth costs by mirroring heavily used data in a second region.
-	**IPv4 vs IPv6:** For a long time S3 only supported IPv4 at the default endpoint `https://BUCKET.s3.amazonaws.com`. However, [as of Aug 11, 2016](https://aws.amazon.com/blogs/aws/now-available-ipv6-support-for-amazon-s3/) it now supports both IPv4 & IPv6! To use both, you have to [enable dualstack](http://docs.aws.amazon.com/AmazonS3/latest/dev/dual-stack-endpoints.html) either in your preferred API client or by directly using this url scheme `https://BUCKET.s3.dualstack.REGION.amazonaws.com`. This extends to S3 Transfer Acceleration as well.
-	**S3 event notifications:** S3 can be configured to send an [SNS notification](https://aws.amazon.com/blogs/aws/introducing-the-amazon-simple-notification-service/), [SQS message](http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/Welcome.html), or [AWS Lambda function](http://docs.aws.amazon.com/lambda/latest/dg/welcome.html) on [bucket events](http://docs.aws.amazon.com/AmazonS3/latest/dev/NotificationHowTo.html).
-   💸Limit your individual users (or IAM roles) to the minimal required S3 locations, and catalog the “approved” locations. Otherwise, S3 tends to become the dumping ground where people put data to random locations that are not cleaned up for years, costing you big bucks.
- If a bucket is deleted in S3, it can take up to 10 hours before a bucket with the same name can be created again. ([discussion](https://forums.aws.amazon.com/thread.jspa?threadID=37532))

### S3 Gotchas and Limitations

-   ❗S3 buckets sit outside the VPC and can be accessed from anywhere in the world if bucket policies are not set to deny it. Read the permissions section above carefully, there are countless cases of buckets exposed to the public.
-	🔸For many years, there was a notorious [**100-bucket limit**](https://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html#limits_s3) per account, which could not be raised and caused many companies significant pain. As of 2015, you can [request increases](https://aws.amazon.com/about-aws/whats-new/2015/08/amazon-s3-introduces-new-usability-enhancements/). You can ask to increase the limit, but it will still be capped (generally below ~1000 per account).
-	🔸Be careful not to make implicit assumptions about transactionality or sequencing of updates to objects. Never assume that if you modify a sequence of objects, the clients will see the same modifications in the same sequence, or if you upload a whole bunch of files, that they will all appear at once to all clients.
-	🔸S3 has an [**SLA**](https://aws.amazon.com/s3/sla/) with 99.9% uptime. If you use S3 heavily, you’ll inevitably see occasional error accessing or storing data as disks or other infrastructure fail. Availability is usually restored in seconds or minutes. Although availability is not extremely high, as mentioned above, durability is excellent.
-	🔸After uploading, any change that you make to the object causes a full rewrite of the object, so avoid appending-like behavior with regular files.
-	🔸Eventual data consistency, as discussed above, can be surprising sometimes. If S3 suffers from internal replication issues, an object may be visible from a subset of the machines, depending on which S3 endpoint they hit. Those usually resolve within seconds; however, we’ve seen isolated cases when the issue lingered for 20-30 hours.
-	🔸**MD5s and multi-part uploads:** In S3, the [ETag header in S3](http://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html) is a hash on the object. And in many cases, it is the MD5 hash. However, this [is not the case in general](http://stackoverflow.com/questions/12186993/what-is-the-algorithm-to-compute-the-amazon-s3-etag-for-a-file-larger-than-5gb) when you use multi-part uploads. One workaround is to compute MD5s yourself and put them in a custom header (such as is done by [s4cmd](https://github.com/bloomreach/s4cmd)).
-	🔸**Incomplete multi-part upload costs:** Incomplete multi-part uploads accrue [storage charges](http://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html#mpuploadpricing) even if the upload fails and no S3 object is created. [Amazon](http://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html#mpu-abort-incomplete-mpu-lifecycle-config) ([and](http://www.deplication.net/2016/06/aws-tip-save-s3-costs-with-abort.html) [others](https://www.sumologic.com/aws/s3/s3-cost-optimization/)) recommend using a lifecycle policy to clean up incomplete uploads and save on storage costs. Note that if you have many of these, it may be worth investigating whatever's failing regularly.
-	🔸**US Standard region:** Previously, the us-east-1 region (also known as the US Standard region) was replicated across coasts, which led to greater variability of latency. Effective Jun 19, 2015 this is [no longer the case](https://forums.aws.amazon.com/ann.jspa?annID=3112). All Amazon S3 regions now support read-after-write consistency. Amazon S3 also renamed the US Standard region to the US East (N. Virginia) region to be consistent with AWS regional naming conventions.
- 🔸**S3 authentication versions and regions:** In newer regions, S3 [only supports the latest authentication](https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingAWSSDK.html#specify-signature-version). If an S3 file operation using CLI or SDK doesn't work in one region, but works correctly in another region, make sure you are using the latest [authentication signature](https://docs.aws.amazon.com/AmazonS3/latest/API/sig-v4-authenticating-requests.html).

### Storage Durability, Availability, and Price

As an illustration of comparative features and price, the table below gives S3 Standard, RRS, IA, in comparison with [Glacier](#glacier), [EBS](#ebs), [EFS](#efs), and EC2 d2.xlarge instance store using **Virginia region** as of **Sept 2017**.

|                 | Durability (per year)  | Availability “designed” | Availability SLA | Storage (per TB per month)                                                                                               | GET or retrieve (per million) | Write or archive (per million) |
|-----------------|------------------------|-------------------------|------------------|--------------------------------------------------------------------------------------------------------------------------|-------------------------------|--------------------------------|
| **Glacier**     | Eleven 9s              | Sloooow                 | –                | $4                                                                                                                       | $50                           | $50                            |
| **S3 IA**       | Eleven 9s              | 99.9%                   | **99%**          | $12.50                                                                                                                   | $1                            | $10                            |
| ~~**S3 RRS**~~      | ~~**99.99%**~~             | ~~99.99%~~                  | ~~99.9%~~            | ~~$24 (first TB)~~                                                                                                                      | ~~$0.40~~                         | ~~$5~~                             |
| **S3 Standard** | Eleven 9s              | 99.99%                  | 99.9%            | $23                                                                                                                     | $0.40                         | $5                             |
| **EBS**         | **99.8%**              | Unstated                | 99.99%           | $25/$45/**$100**/$125+ ([sc1/st1/**gp2**/io1](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html)\) |                               |                                |
| **EFS**         | “High”                 | “High”                  | –                | $300                                                                                                                     |                               |                                |
| **EC2 d2.xlarge instance store**  | Unstated | Unstated                | –                | $25.44                                                                                                                   | $0                            | $0                             |

Especially notable items are in **boldface**. Sources: [S3 pricing](https://aws.amazon.com/s3/pricing/), [S3 SLA](https://aws.amazon.com/s3/sla/), [S3 FAQ](https://aws.amazon.com/s3/faqs/), [RRS info](https://aws.amazon.com/s3/reduced-redundancy/) (note that this is considered deprecated), [Glacier pricing](https://aws.amazon.com/glacier/pricing/), [EBS availability and durability](https://aws.amazon.com/ebs/details/#Amazon_EBS_Availability_and_Durability), [EBS pricing](https://aws.amazon.com/ebs/pricing/), [EFS pricing](https://aws.amazon.com/efs/pricing/), [EC2 SLA](https://aws.amazon.com/ec2/sla/)

EC2
---

### EC2 Basics

-	📒 [Homepage](https://aws.amazon.com/ec2/) ∙ [Documentation](https://aws.amazon.com/documentation/ec2/) ∙ [FAQ](https://aws.amazon.com/ec2/faqs/) ∙ [Pricing](https://aws.amazon.com/ec2/pricing/) (see also [ec2instances.info](http://www.ec2instances.info/)\)
-	**EC2** (Elastic Compute Cloud) is AWS’ offering of the most fundamental piece of cloud computing: A [virtual private server](https://en.wikipedia.org/wiki/Virtual_private_server). These “instances” can run [most Linux, BSD, and Windows operating systems](https://aws.amazon.com/ec2/faqs/#What_operating_system_environments_are_supported). Internally, they've used a heavily modified [Xen](https://en.wikipedia.org/wiki/Xen) virtualization. That said, new instance classes are being introduced with a KVM derived hypervisor instead, called [Nitro](http://www.brendangregg.com/blog/2017-11-29/aws-ec2-virtualization-2017.html). So far, this is limited to the C5 and M5 instance types. Lastly, there's a "bare metal hypervisor" available for [i3.metal instances](https://aws.amazon.com/about-aws/whats-new/2018/05/announcing-general-availability-of-amazon-ec2-bare-metal-instances/)
-	The term “EC2” is sometimes used to refer to the servers themselves, but technically refers more broadly to a whole collection of supporting services, too, like load balancing (CLBs/ALBs/NLBs), IP addresses (EIPs), bootable images (AMIs), security groups, and network drives (EBS) (which we discuss individually in this guide).
-	**💸[EC2 pricing](https://aws.amazon.com/ec2/pricing/)** and **[cost management](#ec2-cost-management)** is a complicated topic. It can range from free (on the [AWS free tier](https://aws.amazon.com/free/)) to a lot, depending on your usage. Pricing is by instance type, by second or hour, and changes depending on AWS region and whether you are purchasing your instances [On-Demand](https://aws.amazon.com/ec2/pricing/on-demand/), on the [Spot market](https://aws.amazon.com/ec2/spot/) or pre-purchasing ([Reserved Instances](https://aws.amazon.com/ec2/pricing/reserved-instances/)).
- **Network Performance:** For some instance types, AWS uses general terms like Low, Medium, and High to refer to network performance. Users have done [benchmarking](http://stackoverflow.com/questions/18507405/ec2-instance-typess-exact-network-performance) to provide expectations for what these terms can mean.

### EC2 Alternatives and Lock-In

-	Running EC2 is akin to running a set of physical servers, as long as you don’t do automatic scaling or tooled cluster setup. If you just run a set of static instances, migrating to another VPS or dedicated server provider should not be too hard.
-	🚪**Alternatives to EC2:** The direct alternatives are Google Cloud, Microsoft Azure, Rackspace, DigitalOcean, AWS's own Lightsail offering, and other VPS providers, some of which offer similar APIs for setting up and removing instances. (See the comparisons [above](#when-to-use-aws).)
-	**Should you use Amazon Linux?** AWS encourages use of their own [Amazon Linux](https://aws.amazon.com/amazon-linux-ami/), which is evolved from [Red Hat Enterprise Linux (RHEL)](https://en.wikipedia.org/wiki/Red_Hat_Enterprise_Linux) and [CentOS](https://en.wikipedia.org/wiki/CentOS). It’s used by many, but [others are skeptical](https://www.exratione.com/2014/08/do-not-use-amazon-linux/). Whatever you do, think this decision through carefully. It’s true Amazon Linux is heavily tested and better supported in the unlikely event you have deeper issues with OS and virtualization on EC2. But in general, many companies do just fine using a standard, non-Amazon Linux distribution, such as Ubuntu or CentOS. Using a standard Linux distribution means you have an exactly replicable environment should you use another hosting provider instead of (or in addition to) AWS. It’s also helpful if you wish to test deployments on local developer machines running the same standard Linux distribution (a practice that’s getting more common with Docker, too. Amazon now supports an official [Amazon Linux Docker image](http://docs.aws.amazon.com/AmazonECR/latest/userguide/amazon_linux_container_image.html), aimed at assisting with local development on a comparable environment, though this is new enough that it should be considered experimental). Note that the currently-in-testing [Amazon Linux 2](https://aws.amazon.com/about-aws/whats-new/2017/12/introducing-amazon-linux-2/) supports on-premise deployments explicitly.
-	**EC2 costs:** See the [section on this](#ec2-cost-management).

### EC2 Tips

-	🔹**Picking regions:** When you first set up, consider which [regions](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-available-regions) you want to use first. Many people in North America just automatically set up in the us-east-1 (N. Virginia) region, which is the default, but it’s worth considering if this is best up front. You'll want to evaluate service availability (some services [are not available in all regions](https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/)), costing (baseline costs also [vary by region](https://aws.amazon.com/ec2/pricing/) by up to 10-30% (generally lowest in us-east-1 for comparison purposes)), and compliance (various countries have differing regulations with regard to data privacy, for example).
-	**Instance types:** EC2 instances come in many types, corresponding to the capabilities of the virtual machine in CPU architecture and speed, RAM, disk sizes and types (SSD or magnetic), and network bandwidth.
	-	Selecting instance types is complex since there are so many types. Additionally there are different generations, released [over the years](https://aws.amazon.com/blogs/aws/ec2-instance-history/).
	-	🔹Use the list at [**ec2instances.info**](http://www.ec2instances.info/) to review costs and features. [Amazon’s own list](https://aws.amazon.com/ec2/instance-types/) of instance types is hard to use, and doesn’t list features and price together, which makes it doubly difficult.
	-	Prices vary a lot, so use [**ec2instances.info**](http://www.ec2instances.info/) to determine the set of machines that meet your needs and [**ec2price.com**](http://ec2price.com/) to find the cheapest type in the region you’re working in. Depending on the timing and region, it might be much cheaper to rent an instance with *more* memory or CPU than the bare minimum.
  - **Turn off** your instances when they aren’t in use. For many situations such as testing or staging resources, you may not need your instances on 24/7, and you won’t need to pay EC2 running costs when they are suspended. Given that costs are calculated based on usage, this is a simple mechanism for cost savings. This can be achieved using [Lambda and CloudWatch](https://aws.amazon.com/premiumsupport/knowledge-center/start-stop-lambda-cloudwatch/), an open source option like [cloudcycler](https://github.com/fairfaxmedia/cloudcycler), or a SaaS provider like [GorillaStack](https://www.gorillastack.com). (Note: if you turn off instances with an ephemeral root volume, any state will be lost when the instance is turned off. Therefore, for stateful applications it is safer to turn off EBS backed instances).
-	[**Dedicated instances**](https://aws.amazon.com/ec2/purchasing-options/dedicated-instances/) and [**dedicated hosts**](https://aws.amazon.com/ec2/dedicated-hosts/) are assigned hardware, instead of usual virtual instances. They are more expensive than virtual instances but [can be preferable](https://aws.amazon.com/ec2/dedicated-hosts/) for performance, compliance, financial modeling, or licensing reasons.
-	**32 bit vs 64 bit:** A few micro, small, and medium instances are still available to use as 32-bit architecture. You’ll be using 64-bit EC2 (“amd64”) instances nowadays, though smaller instances still support 32 bit (“i386”). Use 64 bit unless you have legacy constraints or other good reasons to use 32.
-	**HVM vs PV:** There are two kinds of virtualization technology used by EC2, [hardware virtual machine (HVM) and paravirtual (PV)](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/virtualization_types.html). Historically, PV was the usual type, but [now HVM is becoming the standard](https://www.opswat.com/blog/aws-2015-why-you-need-switch-pv-hvm). If you want to use the newest instance types, you must use HVM. See the [instance type matrix](https://aws.amazon.com/amazon-linux-ami/instance-type-matrix/) for details.
-	**Operating system:** To use EC2, you’ll need to pick a base operating system. It can be Windows or Linux, such as Ubuntu or [Amazon Linux](https://aws.amazon.com/amazon-linux-ami/). You do this with AMIs, which are covered in more detail in their own section below.
-	**Limits:** You can’t create arbitrary numbers of instances. Default limits on numbers of EC2 instances per account vary by instance type, as described in [this list](http://aws.amazon.com/ec2/faqs/#How_many_instances_can_I_run_in_Amazon_EC2).
-	❗**Use termination protection:** For any instances that are important and long-lived (in particular, aren't part of auto-scaling), [enable termination protection](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/terminating-instances.html#Using_ChangingDisableAPITermination). This is an important line of defense against user mistakes, such as accidentally terminating many instances instead of just one due to human error.
-	**SSH key management:**
	-	When you start an instance, you need to have at least one [ssh key pair](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html) set up, to bootstrap, i.e., allow you to ssh in the first time.
	-	Aside from bootstrapping, you should manage keys yourself on the instances, assigning individual keys to individual users or services as appropriate.
	-	Avoid reusing the original boot keys except by administrators when creating new instances.
	-	Avoid sharing keys and [add individual ssh keys](http://security.stackexchange.com/questions/87480/managing-multiple-ssh-private-keys-for-a-team) for individual users.
-	**GPU support:** You can rent GPU-enabled instances on EC2 for use in machine learning or graphics rendering workloads.

	-	There are [three types](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using_cluster_computing.html) of GPU-enabled instances currently available:
		- The P3 series offers NVIDIA Tesla V100 GPUs in 1, 4 and 8 GPU configurations targeting machine learning, scientific workloads, and other high performance computing applications.
		- The P2 series offers NVIDIA Tesla K80 GPUs in 1, 8 and 16 GPU configurations targeting machine learning, scientific workloads, and other high performance computing applications.
		- The G3 series offers NVIDIA Tesla M60 GPUs in 1, 2, or 4 GPU configurations targeting graphics and video encoding.
	-	AWS offers two different AMIs that are targeted to GPU applications. In particular, they target deep learning workloads, but also provide access to more stripped-down driver-only base images.
		-	AWS offers both an Amazon Linux [Deep Learning AMI](https://aws.amazon.com/marketplace/pp/B077GF11NF?qid=1536363169916&sr=0-3&ref_=srh_res_product_title) (based on Amazon Linux) as well as an Ubuntu [Deep Learning AMI](https://aws.amazon.com/marketplace/pp/B077GCH38C). Both come with most NVIDIA drivers and ancillary software (CUDA, CUBLAS, CuDNN, TensorFlow, PyTorch, etc.) installed to lower the barrier to usage.
		-	⛓ Note that using these AMIs can lead to lock in due to the fact that you have no direct access to software configuration or versioning.
		-	🔸 The compendium of frameworks included can lead to long instance startup times and difficult-to-reason-about environments.
	-	🔹As with any expensive EC2 instance types, [Spot instances can offer significant savings](#ec2-cost-management) with GPU workloads when interruptions are tolerable.
- All current EC2 instance types can take advantage of IPv6 addressing, so long as they are launched in a subnet with an allocated CIDR range in an IPv6-enabled VPC.

### EC2 Gotchas and Limitations

-	❗Never use ssh passwords. Just don’t do it; they are too insecure, and consequences of compromise too severe. Use keys instead. [Read up on this](https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys--2) and fully disable ssh password access to your ssh server by making sure 'PasswordAuthentication no' is in your /etc/ssh/sshd_config file. If you’re careful about managing ssh private keys everywhere they are stored, it is a major improvement on security over password-based authentication.
-	🔸For all [newer instance types](https://aws.amazon.com/amazon-linux-ami/instance-type-matrix/), when selecting the AMI to use, be sure you select the HVM AMI, or it just won’t work.
-	❗When creating an instance and using a new ssh key pair, [make sure the ssh key permissions are correct](http://stackoverflow.com/questions/1454629/aws-ssh-access-permission-denied-publickey-issue).
-	🔸Sometimes certain EC2 instances can get scheduled for retirement by AWS due to “detected degradation of the underlying hardware,” in which case you are given a couple of weeks to migrate to a new instance
 	-	If your instance root device is an EBS volume, you can typically stop and then start the instance which moves it to healthy host hardware, giving you control over timing of this event. Note however that you will lose any instance store volume data ([ephemeral drives](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/InstanceStorage.html)) if your instance type has instance store volumes.
 	-	The instance public IP (if it has one) will likely change unless you're using Elastic IPs. This could be a problem if other systems depend on the IP address.
-	🔸Periodically you may find that your server or load balancer is receiving traffic for (presumably) a previous EC2 server that was running at the same IP address that you are handed out now (this may not matter, or it can be fixed by migrating to another new instance).
-	❗If the EC2 API itself is a critical dependency of your infrastructure (e.g. for automated server replacement, custom scaling algorithms, etc.) and you are running at a large scale or making many EC2 API calls, make sure that you understand when they might fail (calls to it are [rate limited](http://docs.aws.amazon.com/AWSEC2/latest/APIReference/query-api-troubleshooting.html#api-request-rate) and the limits are not published and subject to change) and code and test against that possibility.
-	❗Many newer EC2 instance types are either EBS-only, or backed by local NVMe disks assigned to the instance. Make sure to factor in EBS performance and costs when planning to use them.
-	❗If you're operating at significant scale, you may wish to break apart API calls that enumerate all of your resources, and instead operate either on individual resources, or a subset of the entire list. EC2 APIs will time out! Consider using [filters](https://docs.aws.amazon.com/cli/latest/reference/ec2/describe-instances.html) to restrict what gets returned.
-	❗⏱ Instances come in two types: **Fixed Performance Instances** (e.g. M3, C3, and R3) and [**Burstable Performance Instances**](https://aws.amazon.com/ec2/instance-types/#burst) (e.g. T2). A T2 instance receives CPU credits continuously, the rate of which depends on the instance size. T2 instances accrue CPU credits when they are idle, and use CPU credits when they are active. However, once an instance runs out of credits, you'll notice a severe degradation in performance. If you need consistently high CPU performance for applications such as video encoding, high volume websites or HPC applications, it is recommended to use Fixed Performance Instances.
-	Instance user-data is [limited to 16 KB](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-add-user-data). (This limit applies to the data in raw form, not base64-encoded form.) If more data is needed, it can be downloaded from S3 by a user-data script.
-	Very new accounts may not be able to launch some instance types, such as GPU instances, because of an initially imposed “soft limit” of zero. This limit can be raised by making a support request. See [AWS Service Limits](http://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html) for the method to make the support request. Note that this limit of zero is [not currently documented](http://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html#limits_ec2).
- Since multiple AWS instances all run on the same physical hardware, early cloud adopters encountered what became known as the [Noisy Neighbor problem](https://searchcloudcomputing.techtarget.com/definition/noisy-neighbor-cloud-computing-performance). This feeling of not getting what you are paying for led to [user frustration](https://twitter.com/technicallyjosh/status/668963405831651328), however "steal" may not be the best word to describe what's actually happening based on a [detailed explanation of how the kernel determine steal time](https://support.cloud.engineyard.com/hc/en-us/community/posts/203751578-Explanation-of-Steal-Time). Avoiding having CPU steal affect your application in the cloud may be best handled by [properly designing your cloud architecture](https://www.infoworld.com/article/3073503/cloud-computing/debunking-the-clouds-noisy-neighbor-myth.html).
- AWS [introduced Dedicated Tenancy](https://aws.amazon.com/blogs/aws/amazon-ec2-dedicated-instances/) in 2011. This allows customers to have all resources from a single server. Some saw this as a way to solve the [noisy neighbor problem](https://www.infoworld.com/article/3008225/cloud-computing/amazon-dedicated-hosts-bye-bye-to-noisy-cloud-neighbors.html) since only that customer uses the CPU. This approach comes with a significant risk if that physical system needed any type of maintenance. If a customer had 20 instances running using shared tenancy and one underlying server needed maintenance, only the instance on that server would go offline. If that customer had 20 instances running using dedicated tenancy, when the underlying server needs maintenance, all 20 instances would go offline.
-	🔸Only **i3.metal** type instances providing an ability to run Android x86 emulators on AWS at the moment.



CloudWatch
-------------------

### CloudWatch Basics

* 📒  [Homepage](https://aws.amazon.com/cloudwatch/) ∙ [Documentation](https://aws.amazon.com/documentation/cloudwatch/) ∙ [FAQ](https://aws.amazon.com/cloudwatch/faqs/) ∙ [Pricing](https://aws.amazon.com/cloudwatch/pricing/)
* **CloudWatch** monitors resources and applications, captures logs, and sends events.
* CloudWatch monitoring is the standard mechanism for keeping tabs on AWS resources. A wide range of  [**metrics and dimensions**](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CW_Support_For_AWS.html) are available via CloudWatch, allowing you to create time based graphs, **[alarms](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html)**, and **[dashboards](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards.html)**.
    * Alarms are the most practical use of CloudWatch, allowing you to trigger notifications from any given metric.
    * Alarms can trigger [SNS notifications](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ConsoleAlarms.html), [Auto Scaling actions](http://docs.aws.amazon.com/autoscaling/latest/userguide/policy_creating.html), or [EC2 actions](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/UsingAlarmActions.html).
    * Alarms also support [alerting when any M out of N datapoints cross the alarm threshold](https://aws.amazon.com/about-aws/whats-new/2017/12/amazon-cloudwatch-alarms-now-alerts-you-when-any-m-out-of-n-metric-datapoints-in-an-interval-are-above-your-threshold/).
    * Publish and share graphs of metrics by creating [customizable dashboard views](https://aws.amazon.com/blogs/aws/cloudwatch-dashboards-create-use-customized-metrics-views/).
		* Monitor and report on EC2 [instance system check failure alarms](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/monitoring-system-instance-status-check.html#creating_status_check_alarms).
* **Using CloudWatch Events:**
    * Events create a mechanism to automate actions in various services on AWS. You can create [event rules](http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html) from instance states, AWS APIs, Auto Scaling, Run commands, deployments or time-based schedules (think Cron).
    * [Triggered events](http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/CWE_GettingStarted.html) can invoke Lambda functions, send SNS/SQS/Kinesis messages, or perform instance actions (terminate, restart, stop, or snapshot volumes).
    * Custom payloads can be sent to targets in JSON format, this is especially useful when triggering Lambdas.
* **Using CloudWatch Logs:**
    * [CloudWatch Logs](http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html) is a streaming log storage system. By storing logs within AWS you have access to unlimited paid storage, but you also have the option of streaming logs directly to ElasticSearch or custom Lambdas.
    * A [log agent installed](http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_GettingStarted.html) on your servers will process logs over time and send them to CloudWatch Logs.
    * You can [export logged data to S3](http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/S3Export.html) or stream results to other AWS services.
    * CloudWatch Logs can be [encrypted using keys managed through KMS](http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html).
* **Detailed monitoring:** [Detailed monitoring](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-cloudwatch-new.html) for EC2 instances must be enabled to get granular metrics, and is [billed under CloudWatch](https://aws.amazon.com/cloudwatch/pricing/).

### CloudWatch Alternatives and Lock-In

* CloudWatch offers fairly basic functionality that doesn't create significant (additional) AWS lock-in. Most of the metrics provided by the service can be obtained through APIs that can be imported into other aggregation or visualization tools or services (many specifically provide CloudWatch data import services).
* 🚪 Alternatives to CloudWatch monitoring services include [NewRelic](http://newrelic.com/), [Datadog](http://datadog.com/), [Sumo Logic](http://sumologic.com/), [Zabbix](http://zabbix.com/), [Nagios](http://nagios.org/), [Ruxit](http://ruxit.com/), [Elastic Stack](https://www.elastic.co/elk-stack), open source options such as [StatsD](https://github.com/etsy/statsd) or [collectd](https://collectd.org/) with [Graphite](https://graphiteapp.org/), and many others.
* 🚪 CloudWatch Log alternatives include [Splunk](http://splunk.com/), [Sumo Logic](http://sumologic.com/), [Loggly](http://loggly.com/), [LogDNA](https://logdna.com/), [Logstash](https://www.elastic.co/products/logstash), [Papertrail](https://papertrailapp.com/), [Elastic Stack](https://www.elastic.co/elk-stack), and other centralized logging solutions.

### CloudWatch Tips

* Some very common use cases for CloudWatch are **[billing alarms](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/monitor_estimated_charges_with_cloudwatch.html)**, **instance** **or [load balancer up/down alarms](http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-cloudwatch-metrics.html)**, and **disk usage alerts**.
* You can use [EC2Config](http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/UsingConfig_WinAMI.html#send_logs_to_cwl) to monitor watch memory and disk metrics on Windows platform instances. For Linux, there are [example scripts](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/mon-scripts.html) that do the same thing.
* You can [publish your own metrics](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/publishingMetrics.html) using the AWS API. [Incurs additional cost](https://aws.amazon.com/cloudwatch/pricing/).
* You can stream directly from CloudWatch Logs to a Lambda or ElasticSearch cluster by creating [subscriptions](http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Subscriptions.html) on Log Groups.
* Don't forget to take advantage of the [CloudWatch non-expiring free tier](https://aws.amazon.com/free/#Amazon_CloudWatch).

### CloudWatch Gotchas and Limitations

* 🔸Metrics in CloudWatch originate [on the hypervisor](https://forums.aws.amazon.com/message.jspa?messageID=403578). The hypervisor doesn't have access to OS information, so certain metrics (most notably memory utilization) are not available unless pushed to CloudWatch from inside the instance.
* 🔸You can not use [more than one metric for an alarm](https://forums.aws.amazon.com/thread.jspa?threadID=94984).
* 🔸Notifications you receive from alarms will not have any contextual detail; they have only the specifics of the threshold, alarm state, and timing.
* 🔸By default, CloudWatch metric resolution is 1 minute. If you send multiple values of a metric within the same minute, they will be aggregated into minimum, maximum, average and total (sum) per minute.
* 🐥In July 2017, a new [high-resolution option](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/publishingMetrics.html#high-resolution-metrics) was added for CloudWatch metrics and alarms. This feature allows you to record metrics with 1-second resolution, and to evaluate CloudWatch alarms every 10 seconds.
    - The [blog post introducing this feature](https://aws.amazon.com/blogs/aws/new-high-resolution-custom-metrics-and-alarms-for-amazon-cloudwatch/) describes how to publish a high-resolution metric to CloudWatch. Note that when calling the `PutMetricData` API, `StorageResolution` is an attribute of each item you send in the `MetricData` array, not a direct parameter of the `PutMetricData` API call.
* 🔸Data about metrics is kept in CloudWatch [for 15 months](https://aws.amazon.com/blogs/aws/amazon-cloudwatch-update-extended-metrics-retention-user-interface-update/), starting November 2016 (used to be 14 days). Minimum granularity increases after 15 days.

AMIs
----

### AMI Basics

-	📒 [User guide](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html)
-	**AMIs** (Amazon Machine Images) are immutable images that are used to launch preconfigured EC2 instances. They come in both public and private flavors. Access to public AMIs is either freely available (shared/community AMIs) or bought and sold in the [**AWS Marketplace**](http://aws.amazon.com/marketplace).
-	Many operating system vendors publish ready-to-use base AMIs. For Ubuntu, see the [Ubuntu AMI Finder](https://cloud-images.ubuntu.com/locator/ec2/). Amazon of course has [AMIs for Amazon Linux](https://aws.amazon.com/amazon-linux-ami/).

### AMI Tips

-	AMIs are built independently based on how they will be deployed. You must select AMIs that match your deployment when using them or creating them:
	-	EBS or instance store
	-	PV or HVM [virtualization types](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/virtualization_types.html)
	-	32 bit (“i386”) vs 64 bit (“amd64”) architecture
-	As discussed above, modern deployments will usually be with **64-bit EBS-backed HVM**.
-	You can create your own custom AMI by [snapshotting the state](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html) of an EC2 instance that you have modified.
-	[AMIs backed by EBS storage](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ComponentsAMIs.html#storage-for-the-root-device) have the necessary image data loaded into the EBS volume itself and don’t require an extra pull from S3, which results in EBS-backed instances coming up much faster than instance storage-backed ones.
-	**AMIs are per region**, so you must look up AMIs in your region, or copy your AMIs between regions with the [AMI Copy](https://aws.amazon.com/about-aws/whats-new/2013/03/12/announcing-ami-copy-for-amazon-ec2/) feature.
-	As with other AWS resources, it’s wise to [use tags](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html) to version AMIs and manage their lifecycle.
-	If you create your own AMIs, there is always some tension in choosing how much installation and configuration you want to “bake” into them.
	-	Baking less into your AMIs (for example, just a configuration management client that downloads, installs, and configures software on new EC2 instances when they are launched) allows you to minimize time spent automating AMI creation and managing the AMI lifecycle (you will likely be able to use fewer AMIs and will probably not need to update them as frequently), but results in longer waits before new instances are ready for use and results in a higher chance of launch-time installation or configuration failures.
	-	Baking more into your AMIs (for example, pre-installing but not fully configuring common software along with a configuration management client that loads configuration settings at launch time) results in a faster launch time and fewer opportunities for your software installation and configuration to break at instance launch time but increases the need for you to create and manage a robust AMI creation pipeline.
	-	Baking even more into your AMIs (for example, installing all required software as well and potentially also environment-specific configuration information) results in fast launch times and a much lower chance of instance launch-time failures but (without additional re-deployment and re-configuration considerations) can require time consuming AMI updates in order to update software or configuration as well as more complex AMI creation automation processes.
-	Which option you favor depends on how quickly you need to scale up capacity, and size and maturity of your team and product.
	-	When instances boot fast, auto-scaled services require less spare capacity built in and can more quickly scale up in response to sudden increases in load. When setting up a service with autoscaling, consider baking more into your AMIs and backing them with the EBS storage option.
	-	As systems become larger, it common to have more complex AMI management, such as a multi-stage AMI creation process in which few (ideally one) common base AMIs are infrequently regenerated when components that are common to all deployed services are updated and then a more frequently run “service-level” AMI generation process that includes installation and possibly configuration of application-specific software.
-	More thinking on AMI creation strategies [here](http://techblog.netflix.com/2013/03/ami-creation-with-aminator.html).
-	Use tools like [Packer](https://packer.io/) to simplify and automate AMI creation.
-	If you use RHEL instances and happen to have existing RHEL on-premise Red Hat subscriptions, then you could leverage Red Hat's [Cloud Access program](https://www.redhat.com/en/technologies/cloud-computing/cloud-access) to migrate a portion of your subscriptions to AWS, and thereby not having AWS charge you for RHEL subscriptions a second time. You can either use your own self-created RHEL AMI's or Red Hat provided [Gold Images](https://access.redhat.com/articles/2962171) that will be added to your private AMI's once you sign up for Red Hat Cloud Access.

### AMI Gotchas and Limitations

-	🔸**Amazon Linux package versions:** [By default](https://aws.amazon.com/amazon-linux-ami/faqs/#lock), instances based on Amazon Linux AMIs are configured point to the latest versions of packages in Amazon’s package repository. This means that the package versions that get installed are not locked and it is possible for changes, including breaking ones, to appear when applying updates in the future. If you bake your AMIs with updates already applied, this is unlikely to cause problems in running services whose instances are based on those AMIs – breaks will appear at the earlier AMI-baking stage of your build process, and will need to be fixed or worked around before new AMIs can be generated. There is a “lock on launch” feature that allows you to configure Amazon Linux instances to target the repository of a particular major version of the Amazon Linux AMI, reducing the likelihood that breaks caused by Amazon-initiated package version changes will occur at package install time but at the cost of not having updated packages get automatically installed by future update runs. Pairing use of the “lock on launch” feature with a process to advance the Amazon Linux AMI at your discretion can give you tighter control over update behaviors and timings.
-   **Cloud-Init Defaults:** Oftentimes users create AMIs after performing customizations (albeit manually or via some tool such as Packer or Ansible).  If you're not careful to alter cloud-init settings that correspond to the system service (e.g. sshd, etc.) you've customized, you may find that your changes are no longer in effect after booting your new AMI for the first time, as cloud-init has overwritten them.

    Some distros have different files than others, but all are generally located in `/etc/cloud/`, regardless of distro.  You will want to review these files carefully for your chosen distro before rolling your own AMIs.  A [complete reference to cloud-init](https://cloudinit.readthedocs.io/en/latest/) is available on the cloud-init site.  This is an advanced configuration mechanism, so test any changes made to these files in a sandbox prior to any serious usage.

Auto Scaling
------------

### Auto Scaling Basics

-	📒 [Homepage](https://aws.amazon.com/autoscaling/) ∙ [User guide](http://docs.aws.amazon.com/autoscaling/latest/userguide/) ∙ [FAQ](https://aws.amazon.com/ec2/faqs/#Auto_Scaling) ∙ [Pricing](https://aws.amazon.com/autoscaling/pricing/) at no additional charge
-	[**Auto Scaling Groups (ASGs)**](https://aws.amazon.com/autoscaling/) are used to control the number of instances in a service, reducing manual effort to provision or deprovision EC2 instances.
-	They can be configured through [Scaling Policies](http://docs.aws.amazon.com/autoscaling/latest/userguide/policy_creating.html) to automatically increase or decrease instance counts based on metrics like CPU utilization, or based on a schedule.
-	There are three common ways of using ASGs - dynamic (automatically adjust instance count based on metrics for things like CPU utilization), static (maintain a specific instance count at all times), scheduled (maintain different instance counts at different times of day or on days of the week).
-	💸ASGs [have no additional charge](https://aws.amazon.com/autoscaling/pricing/) themselves; you pay for underlying EC2 and CloudWatch services.

### Auto Scaling Tips

-	💸 Better matching your cluster size to your current resource requirements through use of ASGs can result in significant cost savings for many types of workloads.
-	Pairing ASGs with CLBs is a common pattern used to deal with changes in the amount of traffic a service receives.
-	Dynamic Auto Scaling is easiest to use with stateless, horizontally scalable services.
-	Even if you are not using ASGs to dynamically increase or decrease instance counts, you should seriously consider maintaining all instances inside of ASGs – given a target instance count, the ASG will work to ensure that number of instances running is equal to that target, replacing instances for you if they die or are marked as being unhealthy. This results in consistent capacity and better stability for your service.
-	Autoscalers can be [configured to terminate](http://docs.aws.amazon.com/autoscaling/latest/userguide/healthcheck.html) instances that a CLB or ALB has marked as being unhealthy.

### Auto Scaling Gotchas and Limitations

-	🔸**ReplaceUnhealthy setting:** By default, ASGs will kill instances that the EC2 instance manager considers to be unresponsive. It is possible for instances whose CPU is completely saturated for minutes at a time to appear to be unresponsive, causing an ASG with the default [ReplaceUnhealthy setting](http://docs.aws.amazon.com/autoscaling/latest/userguide/as-suspend-resume-processes.html#process-types) turned on to replace them. When instances that are managed by ASGs are expected to consistently run with very high CPU, consider deactivating this setting. If you do so, however, detecting and killing unhealthy nodes will become your responsibility.

EBS
---

### EBS Basics

-	📒 [Homepage](https://aws.amazon.com/ebs/) ∙ [User guide](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html) ∙ [FAQ](https://aws.amazon.com/ebs/faqs/) ∙ [Pricing](https://aws.amazon.com/ebs/pricing/)
-	**EBS** (Elastic Block Store) provides block level storage. That is, it offers storage volumes that can be attached as filesystems, like traditional network drives.
-	EBS volumes can only be attached to one EC2 instance at a time. In contrast, EFS can be shared but has a much higher price point ([a comparison](http://stackoverflow.com/questions/29575877/aws-efs-vs-ebs-vs-s3-differences-when-to-use)).

### EBS Tips

-	⏱**RAID:** Use [RAID drives](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/raid-config.html) for [increased performance](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSPerformance.html).
-	⏱A worthy read is AWS’ [post on EBS IO characteristics](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-io-characteristics.html) as well as their [performance tips](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSPerformance.html#d0e86148).
-	⏱One can [provision IOPS](http://aws.amazon.com/ebs/details/) (that is, pay for a specific level of I/O operations per second) to ensure a particular level of performance for a disk.
-	⏱A single gp2 EBS volume allows 16k IOPS max To get the maximum performance out of a gp2 EBS volume, it has to be of a maximum size and attached to an EBS-optimized EC2 instance.
- 	💸Standard and gp2 EBS volumes improve IOPS with size. It may make sense for you to simply enlarge a volume instead of paying for better performance explicitly. This can in many cases reduce costs by 2/3.
-	A standard block size for an EBS volume is 16kb.

### EBS Gotchas and Limitations

-	❗EBS durability is reasonably good for a regular hardware drive (annual failure rate of [between 0.1% - 0.2%](http://aws.amazon.com/ebs/details/#availabilityanddurability)). On the other hand, that is very poor if you don’t have backups! By contrast, S3 durability is extremely high. *If you care about your data, back it up to S3 with snapshots.*
-	🔸EBS has an [**SLA**](http://aws.amazon.com/ec2/sla/) with **99.99%** uptime. See notes on high availability below.
-	❗EBS volumes have a [**volume type**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html) indicating the physical storage type. The types called “standard” (**st1** or **sc1**) are actually old spinning-platter disks, which deliver only hundreds of IOPS — not what you want unless you’re really trying to cut costs. Modern SSD-based **gp2** or **io1** are typically the options you want.
-	❗When restoring a snapshot to create an EBS volume, blocks are lazily read from S3 the first time they're referenced. To avoid an initial period of high latency, you may wish to use `dd` or `fio` as per the [official documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-restoring-volume.html).

EFS
---


### EFS Basics

-	📒 [Homepage](https://aws.amazon.com/efs/) ∙ [User guide](http://docs.aws.amazon.com/efs/latest/ug) ∙ [FAQ](https://aws.amazon.com/efs/faq/) ∙ [Pricing](https://aws.amazon.com/efs/pricing/)
-	🐥**EFS** is Amazon’s network filesystem. It’s presented as an [NFSv4.1](https://en.wikipedia.org/wiki/Network_File_System#NFSv4) server. Any compatible NFSv4 client can mount it.
-	It is designed to be highly available and durable and each EFS file system object is redundantly stored across multiple availability zones.
-	EFS is designed to be used as a shared network drive and it can automatically scale up to petabytes of stored data and thousands of instances attached to it.
-	EFS can offer [higher throughput](http://docs.aws.amazon.com/efs/latest/ug/performance.html) (multiple gigabytes per second) and better durability and availability than EBS (see [the comparison table](#storage-durability-availability-and-price)), but with higher latency.
-	EFS is priced based on the volume of data stored, and costs [much more than EBS](#storage-durability-availability-and-price); it's in the ballpark of three times as much compared to general purpose gp2 EBS volumes.
-	⏱ [Performance](http://docs.aws.amazon.com/efs/latest/ug/performance.html) is dependent on the volume of data stored, as is the price:
	-	Like EBS, EFS uses a credit based system. Credits are earned at a rate of 50 KiB/s per GiB of storage and consumed in bursts during reading/writing files or metadata. Unlike EBS, operations on metadata (file size, owner, date, etc.) also consume credits. The [BurstCreditBalance metric](http://docs.aws.amazon.com/efs/latest/ug/monitoring-cloudwatch.html#efs-metrics) in CloudWatch should be monitored to make sure the file system doesn't run out of credits.
	-	Throughput capacity during bursts is also dependent on size. Under 1 TiB, throughput can go up to 100 MiB/s. Above that, 100 MiB/s is added for each stored TiB. For instance, a file system storing 5 TiB would be able to burst at a rate of 500 MiB/s. Maximum throughput per EC2 instance is 250 MiB/s.
	-	EFS has two performance modes that can only be set when a file system is created. One is "General Purpose", the other is "Max I/O". Max I/O scales higher, but at the cost of higher latency. When in doubt, use General Purpose, which is also the default. If the [PercentIOLimit metric](http://docs.aws.amazon.com/efs/latest/ug/monitoring-cloudwatch.html#efs-metrics) in CloudWatch hovers around 100%, Max I/O is recommended. Changing performance mode means creating a new EFS and migrating data.
-	High availability is achieved by having [mount targets in different subnets / availability zones](http://docs.aws.amazon.com/efs/latest/ug/images/overview-flow.png).

### EFS Tips

-	With EFS being based on NFSv4.1, any directory on the EFS can be mounted directly, it doesn't have to be the root directory. One application could mount *fs-12345678:/prog1*, another *fs-12345678:/prog2*.
-	[User and group level permissions](https://docs.aws.amazon.com/efs/latest/ug/accessing-fs-nfs-permissions.html) can be used to control access to certain directories on the EFS file system.
-	⏱ **Sharing EFS filesystems:** One EFS filesystem can be used for multiple applications or services, but it should be considered carefully:

	Pros:
	- Because performance is based on total size of stored files, having everything on one drive will increase performance for everyone. One application consuming credits faster than it can accumulate might be offset by another application that just stores files on EFS and rarely accesses them.

	Cons:
	- Since credits are shared, if one application over-consumes them, it will affect the others.
	- A compromise is made with regards to [security](http://docs.aws.amazon.com/efs/latest/ug/security-considerations.html): all clients will have to have network access to the drive. Someone with root access on one client instance can mount any directory on the EFS and they have read-write access to all files on the drive, even if they don't have access to the applications hosted on other clients. There isn't a no-root-squash equivalent for EFS.

### EFS Gotchas and Limitations

-	🔸 A number of NFSv4.1 features are [not supported](http://docs.aws.amazon.com/efs/latest/ug/nfs4-unsupported-features.html) and there are some [limits](http://docs.aws.amazon.com/efs/latest/ug/limits.html) to the service.
-	🔸 As of 2017-08, EFS offers disk level encryption for new drives. For file systems created before that date, encryption can only be achieved by moving the data to a new EFS volume.
-	🔸 An EFS file system [can be mounted on premises](https://aws.amazon.com/efs/faq/#on-premises) over Direct Connect.
-	🔸 An EFS file system can NOT be mounted over VPC peering or VPN, even if the VPN is running on top of Direct Connect.
-	🔸 Using an EFS volume on Windows is not supported.
-	⏱ When a file is uploaded to EFS, it can take hours for EFS to update the details for billing and burst credit purposes.
-	🔸⏱  Metadata operations can be costly in terms of burst credit consumption. Recursively traversing a tree containing thousands of files can easily ramp up to tens or even hundreds of megabytes of burst credits being consumed, even if no file is being touched. Commands like ```find``` or ```chown -R``` can have an adverse impact on performance.


Load Balancers
--------------

### Load Balancer Basics

-	AWS has 3 load balancing products - “Classic Load Balancers” (CLBs), “Application Load Balancers” (ALBs), and "Network Load Balancers" (NLB).
-	Before the introduction of ALBs, “Classic Load Balancers” were known as “Elastic Load Balancers” (ELBs), so older documentation, tooling, and blog posts may still reference “ELBs”.
-	CLBs have been around since 2009, ALBs in 2016, NLBs were added in 2017 to AWS.
-	CLBs support TCP and HTTP load balancing. ALBs support HTTP load balancing only. NLBs support TCP layer 4 load balancing.
-	CLBs and ALBs can optionally handle termination for a single SSL certificate.
-	All can optionally perform active health checks of instances and remove them from the destination pool if they become unhealthy.
-	CLBs don't support complex / rule-based routing. ALBs support a (currently small) set of rule-based routing features. NLBs have most extensive routing options.
-	CLBs can only forward traffic to a single globally configured port on destination instances, while ALBs can forward to ports that are configured on a per-instance basis, better supporting routing to services on shared clusters with dynamic port assignment (like ECS or Mesos). NLBs support multiple ports on same IP; registering targets by IP address, including targets outside the VPC for the load balancer; ECS can select unused port for scheduling a task then register a target group using this port.
-	CLBs are supported in EC2 Classic as well as in VPCs while ALBs are supported in VPCs only.
-   ALBs can target groups of instances and IP based targets in the RFC1918 ranges allowing you to use on premise destinations via VPN or Direct Connect.

### Load Balancer Tips

-	If you don’t have opinions on your load balancing up front, and don’t have complex load balancing needs like application-specific routing of requests, it’s reasonable just to use a CLB or ALB for load balancing instead.
-	Even if you don’t want to think about load balancing at all, because your architecture is so simple (say, just one server), put a load balancer in front of it anyway. This gives you more flexibility when upgrading, since you won’t have to change any DNS settings that will be slow to propagate, and also it lets you do a few things like terminate SSL more easily.
-	**CLBs and ALBs have many IPs:** Internally, an AWS load balancer is simply a collection of individual software load balancers hosted within EC2, with DNS load balancing traffic among them. The pool can contain many IPs, at least one per availability zone, and depending on traffic levels. They also support SSL termination, which is very convenient.
-	**Scaling:** CLBs and ALBs can scale to very high throughput, but scaling up is not instantaneous. If you’re expecting to be hit with a lot of traffic suddenly, it can make sense to load test them so they scale up in advance. You can also [contact Amazon](http://aws.amazon.com/articles/1636185810492479) and have them “pre-warm” the load balancer.
-	**Client IPs:** In general, if servers want to know true client IP addresses, load balancers must forward this information somehow. CLBs add the standard [X-Forwarded-For](https://en.wikipedia.org/wiki/X-Forwarded-For) header. When using a CLB as an HTTP load balancer, it’s possible to get the client’s IP address from this.
-	**Using load balancers when deploying:** One common pattern is to swap instances in the load balancer after spinning up a new stack with your latest version, keep old stack running for one or two hours, and either flip back to old stack in case of problems or tear it down.
-   **Rotating Certificates while retaining ARN:** Rotating IAM Server Certificates can be difficult as the standard practice is to upload a new one then update all resources with the new ARN. You can however retain the same ARN using the `update-certificate` call with the following process:
  1. Upload a new IAM Server Certificate with a unique name (e.g fuzzy.com.new)
  2. Rename the existing IAM Server Certificate (e.g fuzzy.com to fuzzy.com.expired)
  3. Rename the new IAM Server Certificate to the name of the previously existing certificate (e.g fuzzy.com.new to fuzzy.com)
  4. Jiggle the CLB/ALB Listener to pick up the change:
      * ALB: Invoke modify-listener with the existing details for the ALB Listener
	  * CLB: Invoke create-load-balancer-listeners with the existing details for the CLB listener

### Load Balancer Gotchas and Limitations

-	❗CLBs and ALBs have **no fixed external IP** that all clients see. For most consumer apps this doesn’t matter, but enterprise customers of yours may want this. IPs will be different for each user, and will vary unpredictably for a single client over time (within the standard [EC2 IP ranges](http://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html)). And similarly, never resolve a CLB name to an IP and put it as the value of an A record — it will work for a while, then break!
-	❗Some web clients or reverse proxies cache DNS lookups for a long time, which is problematic for CLBs and ALBs, since they change their IPs. This means after a few minutes, hours, or days, your client will stop working, unless you disable DNS caching. Watch out for [Java’s settings](http://docs.oracle.com/javase/8/docs/api/java/net/InetAddress.html) and be sure to [adjust them properly](http://docs.aws.amazon.com/AWSSdkDocsJava/latest/DeveloperGuide/java-dg-jvm-ttl.html). Another example is nginx as a reverse proxy, which [normally resolves backends only at start-up](https://www.jethrocarr.com/2013/11/02/nginx-reverse-proxies-and-dns-resolution/) (although there is [a way to get around this](https://tenzer.dk/nginx-with-dynamic-upstreams/)).
-	❗It’s not unheard of for IPs to be recycled between customers without a long cool-off period. So as a client, if you cache an IP and are not using SSL (to verify the server), you might get not just errors, but responses from completely different services or companies!
-	🔸As an operator of a service behind a CLB or ALB, the latter phenomenon means you can also see puzzling or erroneous requests by clients of other companies. This is most common with clients using back-end APIs (since web browsers typically cache for a limited period).
-	❗CLBs and ALBs take time to scale up, it does not handle sudden spikes in traffic well. Therefore, if you anticipate a spike, you need to “pre-warm” the load balancer by gradually sending an increasing amount of traffic.
-	❗Tune your healthchecks carefully — if you are too aggressive about deciding when to remove an instance and conservative about adding it back into the pool, the service that your load balancer is fronting may become inaccessible for seconds or minutes at a time. Be extra careful about this when an autoscaler is configured to terminate instances that are marked as being unhealthy by a managed load balancer.
-	❗CLB HTTPS listeners don't support Server Name Indication (SNI). If you need SNI, you can work around this limitation by either providing a certificate with Subject Alternative Names (SANs) or by using TCP listeners and terminating SSL at your backend.
-	🔸 There is a limit on the number of ALBs, CLBs and NLBs per region (separately). As of late 2017, the default limit for each is 20 per region. These limits can be easily raised for ALB and CLB, but AWS is quite reluctant to raise the limit on NLBs.
-	🔸 If using a Network Load Balancer (NLB) then EC2 clients cannot connect to an NLB that resides in another VPC (VPC Peering) or AWS managed VPN unless the EC2 client is a C5, i3.metal or M5 instance type. For VPC peering, both VPCs must be in the same region. See [Troubleshooting](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-troubleshooting.html#target-not-in-service).

CLB
---

### CLB Basics

-	📒 [Homepage](https://aws.amazon.com/elasticloadbalancing/classicloadbalancer/) ∙ [User guide](https://aws.amazon.com/elasticloadbalancing/classicloadbalancer/developer-resources/) ∙ [FAQ](https://aws.amazon.com/elasticloadbalancing/classicloadbalancer/faqs/) ∙ [Pricing](https://aws.amazon.com/elasticloadbalancing/classicloadbalancer/pricing/)
- Classic Load Balancers, formerly known as Elastic Load Balancers, are HTTP and TCP load balancers that are managed and scaled for you by Amazon.

### CLB Tips

-	**Best practices:** [This article](http://aws.amazon.com/articles/1636185810492479) is a must-read if you use CLBs heavily, and has a lot more detail.

### CLB Gotchas and Limitations

-	In general, CLBs are not as “smart” as some load balancers, and don’t have fancy features or fine-grained control a traditional hardware load balancer would offer. For most common cases involving sessionless apps or cookie-based sessions over HTTP, or SSL termination, they work well.
-	🔸By default, CLBs will refuse to route traffic from a load balancer in one Availability Zone (AZ) to a backend instance in another. This [will cause 503s](http://docs.aws.amazon.com/elasticloadbalancing/latest/classic/ts-elb-error-message.html#ts-elb-errorcodes-http503) if the last instance in an AZ becomes unavailable, even if there are healthy instances in other zones. If you’re running fewer than two backend instances per AZ, you almost certainly want to [enable cross-zone load balancing](http://docs.aws.amazon.com/elasticloadbalancing/latest/classic/enable-disable-crosszone-lb.html#enable-cross-zone).
-	🔸Complex rules for directing traffic are not supported. For example, you can’t direct traffic based on a regular expression in the URL, like HAProxy offers.
-	**Apex DNS names:** Once upon a time, you couldn’t assign a CLB to an apex DNS record (i.e. example.com instead of foo.example.com) because it needed to be an A record instead of a CNAME. This is now possible with a Route 53 alias record directly pointing to the load balancer.
-	🔸CLBs use [HTTP keep-alives](https://en.wikipedia.org/wiki/HTTP_persistent_connection) on the internal side. This can cause an unexpected side effect: Requests from different clients, each in their own TCP connection on the external side, can end up on the same TCP connection on the internal side. Never assume that multiple requests on the same TCP connection are from the same client!
-	🔸 Traffic between CLBs and back-end instances in the same subnet **will** have [Network ACL](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_ACLs.html) rules evaluated (EC2 to EC2 traffic in the same subnet would not have Network ACL rules evaluated). If the default '0.0.0.0/0 ALLOW' rule is removed from the Network ACL applied to the subnet, a rule that allows traffic on both the health check port and any listener port must be added.
- As of December 2016, CLBs launched in VPCs do not support IPv6 addressing. CLBs launched in EC2-Classic support both IPv4 and IPv6 [with the "dualstack" DNS name](http://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-internet-facing-load-balancers.html#internet-facing-ip-addresses).

ALB
---

### ALB Basics

-	📒 [Homepage](https://aws.amazon.com/elasticloadbalancing/applicationloadbalancer/) ∙ [User guide](https://aws.amazon.com/elasticloadbalancing/applicationloadbalancer/developer-resources/) ∙ [FAQ](https://aws.amazon.com/elasticloadbalancing/applicationloadbalancer/faqs/) ∙ [Pricing](https://aws.amazon.com/elasticloadbalancing/applicationloadbalancer/pricing/)
-	🐥**Websockets and HTTP/2** are [now supported](https://aws.amazon.com/blogs/aws/new-aws-application-load-balancer/).
-	🐥**Internet Protocol Version 6 (IPv6)** is [now supported](https://aws.amazon.com/about-aws/whats-new/2017/01/announcing-internet-protocol-version-6-ipv6-support-for-elastic-load-balancing-in-amazon-virtual-private-cloud-vpc/).
-	🐥**Load Balancing via IP** is [now supported](https://aws.amazon.com/about-aws/whats-new/2017/08/elastic-load-balancing-application-load-balancer-now-supports-load-balancing-to-ip-addresses-as-targets-for-aws-and-on-premises-resources/).
-	Prior to the Application Load Balancer, you were advised to use TCP instead of HTTP as the protocol to make it work (as described [here](http://www.quora.com/When-will-Amazon-ELB-offer-SPDY-support)) and use [the obscure but useful Proxy Protocol](http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/enable-proxy-protocol.html) ([more on this](https://chrislea.com/2014/03/20/using-proxy-protocol-nginx/)) to pass client IPs over a TCP load balancer.

### ALB Tips

-	Use ALBs to route to services that are hosted on shared clusters with dynamic port assignment (like ECS or Mesos).
-	ALBs support [HTTP host-based routing](http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#host-conditions) (send HTTP requests for “api.mydomain.com” -> {target-group-1}, “blog.mydomain.com” -> {target group 2}) as well as [HTTP path-based routing](http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#path-conditions) (send HTTP requests for “/api/&ast;” ->  {target-group-1}, “/blog/&ast;” -> {target group 2}).

### ALB Gotchas and Limitations

-	🔸ALBs only support HTTP/2 over HTTPS (no plain-text HTTP/2).
-	🔸ALBs only support HTTP/2 to external clients and not to internal resources (instances/containers).
-	ALBs support HTTP routing but not port-based TCP routing.
-	Instances in the ALB’s target groups have to either have a single, fixed healthcheck port (“EC2 instance”-level healthcheck) or the healthcheck port for a target has to be the same as its application port (“Application instance”-level healthcheck) - you can't configure a per-target healthcheck port that is different than the application port.
-	ALBs are VPC-only (they are not available in EC2 Classic)
-	In a target group, if there is no healthy target, all requests are routed to all targets. For example, if you point a listener at a target group containing a single service that has a long initialization phase (during which the health checks would fail), requests will reach the service while it is still starting up.
- 📜 Although ALBs [now support SNI](https://aws.amazon.com/about-aws/whats-new/2017/10/elastic-load-balancing-application-load-balancers-now-support-multiple-ssl-certificates-and-smart-certificate-selection-using-server-name-indication-sni/), they only support 25 HTTPS certificates per Load Balancer. This limitation is not described [here](http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-limits.html), so it might be subject to change.

Elastic Beanstalk
----------------

### Elastic Beanstalk Basics
- 📒 [Homepage](https://aws.amazon.com/elasticbeanstalk/) ∙ [Developer guide](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html) ∙ [FAQ](https://aws.amazon.com/elasticbeanstalk/faqs/) ∙ [Pricing](https://aws.amazon.com/elasticbeanstalk/pricing/)
- **EB** (Elastic Beanstalk) is a PaaS (Platform as a Service) that helps developers create, deploy and scale web applications
- EB handles deployment, configuration, provisioning, load balancing, auto-scaling, monitoring, and logging
- EB creates AWS resources on your behalf but you retain full access and control of the underlying resources
- 💸 There is no cost to use EB but you will still be charged the full cost of the underlying AWS resources created by EB

### Elastic Beanstalk Tips
- To speed up deployment before launch or in a dev stage, turn off health checks and set the `Deployment policy` to `All at once`
- If you have a configuration you want to re-use for multiple EB apps, you can save the current configuration using `eb config save --cfg myEBConfig`
- By default, EB doesn't have any alarms. You'll need to add them yourself on metrics that you're monitoring.
- By default, EB doesn't enable [managed platform updates](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environment-platform-update-managed.html?icmpid=docs_elasticbeanstalk_console). Enable them in configuration to have EB automatically apply updates during a pre-specified maintenance window

### Elastic Beanstalk Gotchas and Limitations
- 🔸 Don't edit [apache|nginx] conf files manually on ec2 instances as they will be re-written on each deployment (use [ebextensions](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html) instead)
- 🔸 After creating an EB environment, it's no longer possible to change the `Name` tag
- 🔸 EB will sometimes quarantine instances that cause multiple deployment issues. Despite being quarantined, EB will still deploy to them on subsequent deployments. To prevent this behavior, said instances will need to be terminated (or the underlying issue fixed)
- File uploads are capped at 10MB for most default eb configurations - update [nginx config](https://stackoverflow.com/questions/18908426/increasing-client-max-body-size-in-nginx-conf-on-aws-elastic-beanstalk) to change
- If you edit `.elasticbeanstalk/saved_configs/`, be aware that this is not kept in sync with the EB environment config. You'll need to manually fetch and save for changes to take effect

Elastic IPs
-----------

### Elastic IP Basics

-	📒 [Documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html) ∙ [FAQ](https://aws.amazon.com/ec2/faqs/#Elastic_IP) ∙ [Pricing](https://aws.amazon.com/ec2/pricing/on-demand/#Elastic_IP_Addresses)
-	**Elastic IPs** are static IP addresses you can rent from AWS to assign to EC2 instances.

### Elastic IP Tips

-	🔹**Prefer load balancers to elastic IPs:** For single-instance deployments, you could just assign elastic IP to an instance, give that IP a DNS name, and consider that your deployment. Most of the time, you should provision a [load balancer](#load-balancers) instead:
	-	It’s easy to add and remove instances from load balancers. It’s also quicker to add or remove instances from a load balancer than to reassign an elastic IP.
	-	It’s more convenient to point DNS records to load balancers, instead of pointing them to specific IPs you manage manually. They can also be Route 53 aliases, which are easier to change and manage.
	-	But in some situations, you do need to manage and fix IP addresses of EC2 instances, for example if a customer needs a fixed IP. These situations require elastic IPs.
-	Elastic IPs are limited to 5 per account. It’s possible to [request more](https://console.aws.amazon.com/support/home#/case/create?issueType=service-limit-increase&limitType=service-code-elastic-ips-ec2-classic).
-	If an Elastic IP is not attached to an active resource there is a small [hourly fee](https://aws.amazon.com/ec2/pricing/on-demand/#Elastic_IP_Addresses).
-	Elastic IPs are [no extra charge](https://aws.amazon.com/ec2/pricing/on-demand/#Elastic_IP_Addresses) as long as you’re using them. They have a (small) cost when not in use, which is a mechanism to prevent people from squatting on excessive numbers of IP addresses.

### Elastic IP Gotchas and Limitations

-	🔸There is [officially no way](https://forums.aws.amazon.com/thread.jspa?threadID=171550) to allocate a contiguous block of IP addresses, something you may desire when giving IPs to external users. Though when allocating at once, you may get lucky and have some be part of the same CIDR block. If this is important to you, you may want to [bring your own IP](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-byoip.html), which is more involved than this guide will go into.

Glacier
-------

### Glacier Basics

-	📒 [Homepage](https://aws.amazon.com/glacier/) ∙ [Developer guide](http://docs.aws.amazon.com/amazonglacier/latest/dev/) ∙ [FAQ](https://aws.amazon.com/glacier/faqs/) ∙ [Pricing](https://aws.amazon.com/glacier/pricing/)
-	**Glacier** is a lower-cost alternative to S3 when data is infrequently accessed, such as for archival purposes.
-	It’s only useful for data that is rarely accessed. It generally takes [3-5 hours](https://aws.amazon.com/glacier/faqs/#dataretrievals) to fulfill a retrieval request.
-	AWS [has not officially revealed](https://en.wikipedia.org/wiki/Amazon_Glacier#Storage) the storage media used by Glacier; it may be low-spin hard drives or even tapes.
-	AWS has released an even more cost effective storate tier called [Glacier Deep Archive](https://aws.amazon.com/blogs/aws/new-amazon-s3-storage-class-glacier-deep-archive/) that offers ~12 hour retrieval latencies, but costs roughly a thousand dollars per month per petabyte.

### Glacier Tips

-	You can physically [ship](https://aws.amazon.com/blogs/aws/send-us-that-data/) your data to Amazon to put on Glacier on a USB or eSATA HDD.

### Glacier Gotchas and Limitations

-	🔸Getting files off Glacier is glacially slow (typically 3-5 hours or more).
-	🔸Due to a fixed overhead per file (you pay per PUT or GET operation), uploading and downloading many small files on/to Glacier might be very expensive. There is also a 32k storage overhead per file. Hence it’s a good idea is to archive files before upload.
-	💸Be aware of the per-object costs of archiving S3 data to Glacier. [It costs $0.05 per 1,000 requests](https://aws.amazon.com/s3/pricing/). If you have large numbers of S3 objects of relatively small size, [it will take time to reach a break-even point](https://alestic.com/2012/12/s3-glacier-costs/) (initial archiving cost versus lower storage pricing).

RDS
---

### RDS Basics

-	📒 [Homepage](https://aws.amazon.com/rds/) ∙ [User guide](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/) ∙ [FAQ](https://aws.amazon.com/rds/faqs/) ∙ [Pricing](https://aws.amazon.com/rds/pricing/) (see also [ec2instances.info/rds/](http://www.ec2instances.info/rds/)\)
-	**RDS** is a managed relational database service, allowing you to deploy and scale databases more easily. It supports [Oracle](https://aws.amazon.com/rds/oracle/), [Microsoft SQL Server](https://aws.amazon.com/rds/sqlserver/), [PostgreSQL](https://aws.amazon.com/rds/postgresql/), [MySQL](https://aws.amazon.com/rds/mysql/), [MariaDB](https://aws.amazon.com/rds/mariadb/), and Amazon’s own [Aurora](https://aws.amazon.com/rds/aurora/).
-	RDS offers out of the box support for [high availability and failover](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html) for your databases.

### RDS Tips

-	If you're looking for the managed convenience of RDS for other data stores such as MongoDB or Cassandra, you may wish to consider third-party services from providers such as [[Compose](https://www.compose.com/), or [InstaClustr](https://www.instaclustr.com/).
-	🔹Make sure to create a new [parameter group](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithParamGroups.html) and option group for your database since the default parameter group does not allow dynamic configuration changes.
-	RDS instances start with a default timezone of UTC. If necessary, this can be [changed to a different timezone](https://aws.amazon.com/premiumsupport/knowledge-center/rds-change-time-zone/).

### RDS Gotchas and Limitations

-	⏱RDS instances run on EBS volumes (either general-purpose or provisioned IOPS), and hence are constrained by EBS performance.
-	🔸Verify what database features you need, as not everything you might want is available on RDS. For example, if you are using Postgres, check the list of [supported features and extensions](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#SQLServer.Concepts.General.FeatureSupport). If the features you need aren't supported by RDS, you'll have to deploy your database yourself.
-	🔸If you use the failover support offered by RDS, keep in mind that it is based on DNS changes, and make sure that your client reacts to these changes appropriately. This is particularly important for Java, given how its DNS resolver’s TTL is [configured by default](http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-jvm-ttl.html).
-	🔸**DB migration to RDS:** While importing your database into RDS ensure you take into consideration the maintenance window settings. If a backup is running at the same time, your import can take a considerably longer time than you would have expected.
-	[Database sizes are limited](https://aws.amazon.com/about-aws/whats-new/2015/06/amazon-rds-increases-storage-limits-to-6TB-for-piops-and-gp2/) to **6TB** for all database engines except for SQL Server which has a **4TB** limit and Aurora which supports up to **64TB** databases.

RDS MySQL and MariaDB
---------------------

### RDS MySQL and MariaDB Basics

-      RDS offers MySQL versions 5.5, 5.6, 5.7 and 5.8.
-      RDS offers MariaDB versions 10.0, 10.1, 10.2 and 10.3.

### RDS MySQL and MariaDB Tips

-	MySQL RDS allows access to [binary logs](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_LogAccess.Concepts.MySQL.html#USER_LogAccess.MySQL.BinaryFormat).
-	Multi-AZ instances of MySQL transparently replicate data across AZs using DRBD. Automated backups of multi-AZ instances [run off the backup instance](https://www.percona.com/live/mysql-conference-2014/sessions/rds-mysql-tips-patterns-and-common-pitfalls) to reduce latency spikes on the primary.
-	🔸**Performance Schema:** While [Performance Schema](http://dev.mysql.com/doc/refman/en/performance-schema.html) is enabled by default in MySQL 5.6.6 and later, it is disabled by default in all versions of RDS. If you wish to enable Performance Schema, a reboot of the RDS instance will be required.
-	🔸**MySQL vs MariaDB vs Aurora:** If you prefer a MySQL-style database but are starting something new, you probably should consider Aurora and MariaDB as well. **Aurora** has increased availability and is the next-generation solution. That said, Aurora [may not be](http://blog.takipi.com/benchmarking-aurora-vs-mysql-is-amazons-new-db-really-5x-faster/) that much faster than MySQL for certain workloads. **MariaDB**, the modern [community fork](https://en.wikipedia.org/wiki/MariaDB) of MySQL, [likely now has the edge over MySQL](http://cloudacademy.com/blog/mariadb-vs-mysql-aws-rds/) for many purposes and is supported by RDS.

### RDS MySQL and MariaDB Gotchas and Limitations

-	🔸**No SUPER privileges.** RDS provides some [stored procedures](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.MySQL.SQLRef.html) to perform some tasks that require SUPER privileges such as starting or stopping replication.
-	🔸You can replicate to non-RDS instances of MySQL, but [replication to these instances will break during AZ failovers](https://www.percona.com/live/mysql-conference-2014/sessions/rds-mysql-tips-patterns-and-common-pitfalls).
-	🔸There is no ability to manually CHANGE MASTER on replicas, so they must all be rebuilt after a failover of the master.
-	🔸Most global options are exposed only via [DB parameter groups](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithParamGroups.html). Some variables that were introduced in later MySQL dot releases such as [avoid_temporal_upgrade](https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_avoid_temporal_upgrade) in MySQL 5.6.24 are not made available in RDS's 5.6.x parameter group and making use of them requires an upgrade to MySQL 5.7.x.
-	🔸RDS features such as Point-In-Time restore and snapshot restore are not supported on MyISAM tables. Ensure you lock and flush each MyISAM table before executing a snapshot or backup operation to ensure consistency.

RDS PostgreSQL
--------------

### RDS PostgreSQL Basics

- RDS offers PostgreSQL 9.3, 9.4, 9.5, 9.6, and 10.

### RDS PostgreSQL Tips
- Recently Logical Replication is being supported, [both as subscriber and publisher](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#PostgreSQL.Concepts.General.version104).
- Supports a relatively large range of native [extensions](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#PostgreSQL.Concepts.General.FeatureSupport.Extensions).
- RDS PostgreSQL 10 Supports native partitioning and most of the major features and tunables.
- Supports connections over SSL.
- Supports multi A-Z and Point-in-time recovery.


### RDS PostgreSQL Gotchas and Limitations
- No superuser privileges. RDS provides a role `rds_superuser` that can do most of the needed operations but there are some limitations.
- Some major features are delayed compared to open source PostgreSQL.
- By default RDS is spec’d with general purpose SSD , if you need better performance you have to spec provisioned IOPS SSD.
- You can't use RDS as a replica outside RDS without using logical replication.
- There are settings that cannot be changed and most of the settings that can change can only be changed using database parameter groups.
- It’s harder to troubleshoot performance problems since you have no access to the host.
- Be sure to verify that all the [extensions](https://www.postgresql.org/docs/current/static/view-pg-available-extensions.html) you need are available. If you are using an extension not listed there, you will need to come up with a work around, or deploy your own database in EC2.
- Many Postgres utilities and maintenance items expect command line access, that can usually be satisfied by using an external ec2 server.

RDS SQL Server
--------------

### RDS SQL Server Basics

-	[RDS offers SQL Server 2008 R2, 2012, 2014, 2016 and 2017](https://aws.amazon.com/rds/sqlserver/) including Express, Web, Standard and Enterprise.

### RDS SQL Server Tips

-	Recently added support for [backup and restore to/from S3](https://www.brentozar.com/archive/2016/07/holy-cow-amazon-rds-sql-server-just-changed-everything/) which may make it an attractive [DR option](https://aws.amazon.com/blogs/aws/amazon-rds-for-sql-server-support-for-native-backuprestore-to-amazon-s3/) for on-premises installations.

### RDS SQL Server Gotchas and Limitations

-	🔸The user is granted only db_owner privileges for each database on the instance.
-	🔸Storage cannot be expanded for existing databases. If you need more space, you must restore your database on a new instance with larger storage.
-	🔸There is a **16TB** database size limit for non-Express editions. There is also a minimum storage size, 20GB for Web and Express, 200GB for Standard and Enterprise.
-	🔸Limited to [30 databases per instance](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_SQLServer.html)

RDS Aurora
----------
### RDS Aurora Basics
Aurora is a cloud only database service designed to provide a distributed, fault-tolerant relational database with self-healing storage and auto-scaling up to 64TB per instance.  It currently comes in two versions, a MySQL compatible system, and a PostgreSQL compatible system.

RDS Aurora MySQL
----------------

### RDS Aurora MySQL Basics

-	Amazon’s proprietary fork of MySQL intended to scale up for high concurrency workloads. Generally speaking, individual query performance under Aurora is not expected to improve significantly relative to MySQL or MariaDB, but Aurora is intended to maintain performance while executing many more queries concurrently than an equivalent MySQL or MariaDB server could handle.
-	[Notable new features](http://www.slideshare.net/AmazonWebServices/amazon-aurora-amazons-new-relational-database-engine) include:
	-	Log-structured storage instead of B-trees to improve write performance.
	-	Out-of-process buffer pool so that databases instances can be restarted without clearing the buffer pool.
	-	The underlying physical storage is a specialized SSD array that automatically maintains 6 copies of your data across 3 AZs.
	-	Aurora read replicas share the storage layer with the write master which significantly reduces replica lag, eliminates the need for the master to write and distribute the binary log for replication, and allows for zero-data-loss failovers from the master to a replica. The master and all the read replicas that share storage are known collectively as an **Aurora cluster**. Read replicas can span up to [5 regions](https://aws.amazon.com/about-aws/whats-new/2018/09/amazon-aurora-databases-support-up-to-five-cross-region-read-replicas/).

### RDS Aurora MySQL Tips

-	In order to take advantage of Aurora’s higher concurrency, applications should be configured with large database connection pools and should execute as many queries concurrently as possible. For example, Aurora servers have been tested to produce increasing performance on some OLTP workloads with [up to 5,000 connections](http://www.slideshare.net/AmazonWebServices/amazon-aurora-amazons-new-relational-database-engine/31).
-	[Aurora scales well with multiple CPUs](https://www.percona.com/blog/2016/05/26/aws-aurora-benchmarking-part-2/) and may require a large instance class for optimal performance.
-	The easiest migration path to Aurora is restoring a database snapshot from MySQL 5.6 or 5.7. The next easiest method is restoring a dump from a MySQL-compatible database such as MariaDB. For [low-downtime migrations](https://aws.amazon.com/blogs/aws/amazon-aurora-update-spatial-indexing-and-zero-downtime-patching/) from other MySQL-compatible databases, you can set up an Aurora instance as a replica of your existing database. If none of those methods are options, Amazon offers a fee-based data migration service.
-	You can replicate [from an Aurora cluster to MySQL or to another Aurora cluster](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Aurora.Overview.Replication.MySQLReplication.html). This requires binary logging to be enabled and is not as performant as native Aurora replication.
-	Because Aurora read replicas are the [equivalent of a multi-AZ backup](http://stackoverflow.com/a/32428651/129052) and they can be configured as zero-data-loss failover targets, there are fewer scenarios in which the creation of a multi-AZ Aurora instance is required.

### RDS Aurora MySQL Gotchas and Limitations

- 🔸[Aurora 1.x is based on MySQL 5.6.x](https://news.ycombinator.com/item?id=12415693) with some cherry-picking of later MySQL features. It is missing most 5.7 features as well as some online DDL features introduced in 5.6.17.
- 🔸[Aurora 2.x is based on MySQL 5.7.x](https://aws.amazon.com/about-aws/whats-new/2018/02/amazon-aurora-is-compatible-with-mysql-5-7/)
- Aurora does not support GTID transactions in either the 5.6/Aurora 1.x or the 5.7/Aurora 2.x release lines.
- Aurora maximum cluster size is 64 TB

RDS Aurora PostgreSQL
---------------------

### RDS Aurora PostgreSQL Basics

- Amazon’s proprietary fork of PostgreSQL, intended to scale up for high concurrency workloads while maintaining ease of use. Currently based on PostgreSQL 9.6.
- Higher throughput (up to 3x with similar hardware).
- Automatic storage scale in 10GB increments up to 64TB.
- Low latency read replicas that share the storage layer with the master which significantly reduces replica lag.
- Point in time recovery.
- Fast database snapshots.

### RDS Aurora PostgreSQL Tips
- Aurora Postgres by default is supposed to utilize high connection rates and for this reason connection pooling must be configured accordingly.
- Because Aurora is based on PostgreSQL 9.6, it lacks features like declarative partitioning or logical replication.

### RDS Aurora PostgreSQL Gotchas and Limitations
- Aurora PostgreSQL falls behind normal RDS when it comes to available versions, so if you need features from the latest PostgreSQL version you might be better off with plain RDS.
- Patching and bug fixing is separate from open source PostgreSQL.

ElastiCache
-----------

### ElastiCache Basics

- 📒 [Homepage](https://aws.amazon.com/elasticache/) ∙ [User
  guide for Redis](https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/index.html) ∙ [User
  guide for Memcached](https://docs.aws.amazon.com/AmazonElastiCache/latest/mem-ug/index.html) ∙
  [FAQ](https://aws.amazon.com/elasticache/faqs/) ∙
  [Pricing](https://aws.amazon.com/elasticache/pricing/)
- **ElastiCache** is a managed in-memory cache service, that can be used to
  store temporary data in a fast in-memory cache, typically in order to avoid
  repeating the same computation multiple times when it could be reused.
- It supports both the [Memcached](https://memcached.org) and
  [Redis](https://redis.io) open source in-memory cache software and exposes
  them both using their native access APIs.
- The main benefit is that AWS takes care of running, patching and optimizing
  the cache nodes for you, so you just need to launch a cluster and configure
  its endpoint in your application, while AWS will take of most of the operational
  work of running the cache nodes.

### ElastiCache Tips

- Choose the
  [engine](http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/SelectEngine.html),
  clustering configuration and [instance
  type](http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/CacheNodes.SelectSize.html)
  carefully based on your application needs. The documentation explains in
  detail the pros, cons and limitations of each engine in order to help you
  choose the best fit for your application. In a nutshell, Redis is
  preferable for storing more complex data structures, while Memcached is just a
  plain key/value store. The simplicity of Memcached allows it to be slightly
  faster and allows it to scale out if needed, but Redis has more features which
  you may use in your application.
- For Memcached AWS provides enhanced SDKs for certain programming languages
  which implement
  [auto-discovery](http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/AutoDiscovery.html),
  a feature not available in the normal memcached client libraries.

### ElastiCache Gotchas and Limitations

- Since in some cases changing the cache clusters may have some restrictions,
  like for
  [scaling](http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/Scaling.html)
  purposes, it may become a problem if they were launched using CloudFormation
  in a stack that also contains other resources and you really need to change
  the cache. In order to avoid getting your CloudFormation stacks in a
  non-updateable state, it is recommended to launch ElastiCache clusters (just
  like any other resource with similar constraints) in dedicated stacks which
  can be replaced entirely with new stacks having the desired configuration.


DynamoDB
--------

### DynamoDB Basics

-	📒 [Homepage](https://aws.amazon.com/dynamodb/) ∙ [Developer guide](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/dynamodb/faqs/) ∙ [Pricing](https://aws.amazon.com/dynamodb/pricing/)
-	**DynamoDB** is a [NoSQL](https://en.wikipedia.org/wiki/NoSQL) database with focuses on speed, flexibility, and scalability.
-	DynamoDB is priced on a combination of throughput and storage.

### DynamoDB Alternatives and Lock-in

-	⛓ Unlike the technologies behind many other Amazon products, DynamoDB is a proprietary AWS product with no interface-compatible alternative available as an open source project. If you tightly couple your application to its API and featureset, it will take significant effort to replace.
-	The most commonly used alternative to DynamoDB is [Cassandra](http://cassandra.apache.org/).

### DynamoDB Tips

-	There is a [**local version of DynamoDB**](https://aws.amazon.com/blogs/aws/dynamodb-local-for-desktop-development/) provided for developer use.
-	[DynamoDB Streams](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html) provides an ordered stream of changes to a table. Use it to replicate, back up, or drive events off of data
-	DynamoDB can be used [as a simple locking service](https://gist.github.com/ryandotsmith/c95fd21fab91b0823328).
-	DynamoDB indexing can include **primary keys**, which can either be a single-attribute hash key or a composite hash-key range. You can also query non-primary key attributes using [**secondary indexes**](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SecondaryIndexes.html).
-	**Data Types:** DynamoDB supports three [data types](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html) – **number**, **string**, and **binary** – in both scalar and multi-valued sets. DynamoDB can also support [**JSON**](https://aws.amazon.com/blogs/aws/dynamodb-update-json-and-more/).
-	As of late 2017, DynamoDB supports both [global tables](https://aws.amazon.com/dynamodb/global-tables/) and [backup / restore functionality](https://aws.amazon.com/dynamodb/backup-restore/).

### DynamoDB Gotchas and Limitations

-	🔸 DynamoDB doesn’t provide an easy way to bulk-load data (it is possible through [Data Pipeline](http://docs.aws.amazon.com/datapipeline/latest/DeveloperGuide/dp-importexport-ddb-part1.html)) and this has some [unfortunate consequences](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GuidelinesForTables.html#GuidelinesForTables.AvoidExcessivePTIncreases). Since you need to use the regular service APIs to update existing or create new rows, it is common to temporarily turn up a destination table’s write throughput to speed import. But when the table’s write capacity is increased, DynamoDB may do an irreversible split of the partitions underlying the table, spreading the total table capacity evenly across the new generation of tables. Later, if the capacity is reduced, the capacity for each partition is also reduced but the total number of partitions is not, leaving less capacity for each partition. This leaves the table in a state where it much easier for hotspots to overwhelm individual partitions.
-	🔸 It is important to make sure that DynamoDB [resource limits](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Limits.html#limits-data-types) are compatible with your dataset and workload. For example, the maximum size value that can be added to a DynamoDB table is 400 KB (larger items can be stored in S3 and a URL stored in DynamoDB).
-	🔸 Dealing with **time series data** in DynamoDB can be challenging. A global secondary index together with down sampling timestamps can be a possible solution as explained [here](https://blogs.aws.amazon.com/bigdata/post/Tx3KPZDXIBJEQ4B/Scaling-Writes-on-Amazon-DynamoDB-Tables-with-Global-Secondary-Indexes).
-	🔸 DynamoDB does [not allow](https://forums.aws.amazon.com/thread.jspa?threadID=90137) an empty string as a valid attribute value. The most common work-around is to use a substitute value instead of leaving the field empty.
-	🔸 When setting up [fine grained policies](http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/specifying-conditions.html) for access to DynamoDB tables, be sure to include their secondary indices in the policy document as well.


ECS
---

### ECS Basics

-	📒 [Homepage](https://aws.amazon.com/ecs/) ∙ [Developer guide](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/ecs/faqs/) ∙ [Pricing](https://aws.amazon.com/ecs/pricing/)
-	**ECS** (EC2 Container Service) is a relatively new service (launched end of 2014) that manages clusters of services deployed via Docker.
-	See the [Containers and AWS](#containers-and-aws) section for more context on containers.
-	ECS is growing in adoption, especially for companies that embrace microservices.
-	Deploying Docker directly in EC2 yourself is another common approach to using Docker on AWS. Using ECS is not required, and ECS does not (yet) seem to be the predominant way many companies are using Docker on AWS.
-	It’s also possible to use [Elastic Beanstalk with Docker](http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_docker.html), which is reasonable if you’re already using Elastic Beanstalk.
-	Using Docker may change the way your services are deployed within EC2 or Elastic Beanstalk, but it does not radically change how most other services are used.
-	[ECR](https://aws.amazon.com/ecr/) (EC2 Container Registry) is Amazon’s managed Docker registry service. While simpler than running your own registry, it is missing some features that might be desired by some users:
	-	Doesn’t support cross-region replication of images.
		-	If you want fast fleet-wide pulls of large images, you’ll need to push your image into a region-local registry.
	-	Doesn’t support custom domains / certificates.
-	A container’s health is monitored via [CLB](#clb) or [ALB](#alb). Those can also be used to address a containerized service. When using an ALB you do not need to handle port contention (i.e. services exposing the same port on the same host) since an ALB’s target groups can be associated with ECS-based services directly.
-	[The Hitchhikers Guide to AWS ECS and Docker](http://start.jcolemorrison.com/the-hitchhikers-guide-to-aws-ecs-and-docker/) by J. Cole Morrison is an excellent article for Introduction to AWS ECS concepts.



### ECS Tips

-	**Log drivers:** ECS supports multiple log drivers (awslogs, splunk, fluentd, syslog, json, ... ). Use [`awslogs`](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_awslogs.html) for CloudWatch (make sure a group is made for the logs first). [Drivers such as fluentd are not enabled by default](https://github.com/aws/amazon-ecs-agent/issues/535). You can, install the agent and enable the driver by adding `ECS_AVAILABLE_LOGGING_DRIVERS='["awslogs","fluentd"]'` to `/etc/ecs/ecs.config`.
-	[This blog from Convox](https://convox.com/blog/ecs-challenges) (and [commentary](https://news.ycombinator.com/item?id=11598058)) lists a number of common challenges with ECS as of early 2016.
- It is possible to optimize disk clean up on ECS. By default, the unused containers are deleted after 3 hours and the unused images after 30 minutes. These settings can be changed by adding `ECS_ENGINE_TASK_CLEANUP_WAIT_DURATION=10m` and `ECS_IMAGE_CLEANUP_INTERVAL=10m` to `/etc/ecs/ecs.config`. [More information on optimizing ECS disk cleanup](https://aws.amazon.com/blogs/compute/optimizing-disk-usage-on-amazon-ecs/).

### ECS Alternatives and Lock-in

-	[Kubernetes](https://kubernetes.io): Extensive container platform. Available as a hosted solution on Google Cloud (https://cloud.google.com/container-engine/) and AWS (https://tectonic.com/). AWS has a Kubernetes Quickstart (https://aws.amazon.com/quickstart/architecture/heptio-kubernetes/) developed in collaboration with Heptio.
-	[Nomad](https://www.nomadproject.io/): Orchestrator/Scheduler, tightly integrated in the HashiCorp stack (Consul, Vault, etc).

🚧 [*Please help expand this incomplete section.*](CONTRIBUTING.md)

EKS
---

### EKS Basics
-	📒 [Homepage](https://aws.amazon.com/eks/) ∙ [User guide](http://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html) ∙ [FAQ](https://aws.amazon.com/eks/faq/) ∙ [Pricing](https://aws.amazon.com/eks/pricing/)
- EKS (Elastic Kubernetes Service) is a new service (launched June 2018) that provides managed Kubernetes Masters in a Highly Available pair to deploy K8s Services and Pods on top of EC2 based Kubernetes nodes.
- See the [Containers and AWS](#containers-and-aws) section for more context on containers.
- EKS is AWS's solution to hosting Kubernetes natively on AWS. It is not a replacement for ECS directly but is in response to the large market dominance of Kubernetes.
- EKS does not launch EC2 nodes and would have to be configured and setup either manually or via Cloudformation (or other automation solution)
- EKS management is done through a utility called kubectl, and with Kube configuration files. These files will need to be configured to speak with the K8s Master with a certificate and URL. The AWS CLI can autogenerate the configuration file that kubect requires for communicating with the cluster.<sup>[1](#user-content-eks-aws-cli-create-kubeconfig)</sup>
- EKS authentication is integrated with IAM roles/permissions. The AWS CLI has an integrated sub-command for generating authentication tokens.<sup>[2](#user-content-eks-aws-cli-get-token)</sup> This was formerly done via a custom plugin for kubectl called [aws-iam-authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator) (formerly heptio-authenticator-aws).
- EKS provides [Calico](https://docs.aws.amazon.com/eks/latest/userguide/calico.html) from Tigera for securing workloads within a cluster using Kubernetes network policy.

### EKS Tips
- Multiple clusters can be supported by using different kubeconfig files.
- AWS has a [Kubernetes Quickstart](https://aws.amazon.com/quickstart/architecture/heptio-kubernetes/) developed in collaboration with Heptio.

### EKS Alternatives and Lock-in
- [ECS](#ecs): Amazon's native Container Scheduled platform released in 2014.  If you don't utilise containers today and are looking to get started, ECS is an excellent product.
-	[Kubernetes](https://kubernetes.io): Extensive container platform. Available as a hosted solution on [Google Cloud](https://cloud.google.com/container-engine/), [AWS](https://aws.amazon.com/eks/), [Digital Ocean](https://www.digitalocean.com/products/kubernetes/) and [Azure](https://azure.microsoft.com/en-us/services/kubernetes-service/).
-	[Nomad](https://www.nomadproject.io/): Orchestrator/Scheduler, tightly integrated in the HashiCorp stack (Consul, Vault, etc).

### EKS Gotchas and Limitations
- Pods and Service configurations can rapidly consume IP addresses inside a VPC.  Proper care and maintenance should be applied to ensure IP exhaustion does not occur.
- There is currently no integrated monitoring in CloudWatch for EKS pods or services, you will need to deploy a monitoring system that supports Kubernetes such as Prometheus.
- Autoscaling based off CPU/Memory of a node is limited as you will not be aware of pending Services/Pods that cannot start. Using [cluster-autoscaler](https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler) can be useful for scaling based on Node resource usage and unschedulable Pods.
- [Prometheus](https://prometheus.io/) is a very popular monitoring solution for K8s, metrics and alerts can be used to send events to Lambda, SQS or other solutions to take autoscaling actions.

### Footnotes
<a name="user-content-eks-aws-cli-create-kubeconfig">**1**</a>: https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html<br />
<a name="user-content-eks-aws-cli-get-token">**2**</a>: https://aws.amazon.com/about-aws/whats-new/2019/05/amazon-eks-simplifies-kubernetes-cluster-authentication/<br />

Fargate
-------

### Fargate Basics
-	📒 [Homepage](https://aws.amazon.com/fargate/) ∙ [FAQ](https://aws.amazon.com/fargate/faqs/) ∙ [Pricing](https://aws.amazon.com/fargate/pricing/)
-   **Fargate** allows you to manage and deploy containers without having to worry about running the underlying compute infrastructure
-   Fargate serves as a new backend (in addition to the legacy EC2 backend) on which ECS and EKS tasks can be run
-   Fargate and EC2 backends are called "Launch Types"
-   Fargate allows you to treat containers as fundamental building blocks of your infrastructure

### Fargate Tips
-   Fargate follows a similar mindset to Lambda, which lets you focus on applications, instead of dealing with underlying infrastructure
-   Fargate is supported by CloudFormation, aws-cli and ecs-cli
-   Fargate tasks can be launched alongside tasks that use EC2 Launch Type
-   💸Before creating a large Fargate deployment, make sure to estimate costs and compare them against alternative solution that uses traditional EC2 deployment - Fargate prices can be several times those of equivalently-sized EC2 instances. To evaluate both solutions based on potential costs, refer to pricing for [EC2](https://aws.amazon.com/ec2/pricing/) and [Fargate](https://aws.amazon.com/fargate/pricing/).

### Fargate Alternatives and Lock-in
-   🚪[Azure Container Instances](https://azure.microsoft.com/en-us/services/container-instances/): Available on Microsoft Azure in preview version, allows to run applications in containers without having to manage virtual machines

### Fargate Gotchas and Limitations
-   As of April 2018, Fargate is available in [multiple regions](https://aws.amazon.com/about-aws/whats-new/2018/04/aws-fargate-now-available-in-ohio--oregon--and-ireland-regions/): us-east-1, us-east-2, us-west-2, and eu-west-1
-   As of January 2019, Fargate can only be used with ECS. Support for EKS [was originally planned for 2018](https://aws.amazon.com/blogs/aws/aws-fargate/), but has yet to launch.
-   The smallest resource values that can be configured for an ECS Task that uses Fargate is 0.25 vCPU and 0.5 GB of memory
-   [Task storage is ephemeral. After a Fargate task stops, the storage is deleted.](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/fargate-task-storage.html)


Lambda
------

### Lambda Basics

-	📒 [Homepage](https://aws.amazon.com/lambda/) ∙ [Developer guide](http://docs.aws.amazon.com/lambda/latest/dg/) ∙ [FAQ](https://aws.amazon.com/lambda/faqs/) ∙ [Pricing](https://aws.amazon.com/lambda/pricing/)
-	**Lambda** is AWS' serverless compute offering, allowing users to define Lambda functions in a selection of runtimes that can be invoked via a variety of triggers, including SNS notifications and API Gateway invocations. Lambda is the key service that enables ['serverless' architecture on AWS](https://aws.amazon.com/lambda/serverless-architectures-learn-more/), alongside AWS API Gateway, AWS Batch, and AWS DynamoDB.

### Lambda Tips

-	The idea behind 'serverless' is that users don't manage provisioning, scaling, or maintenance of the physical machines that host their application code. With Lambda, the machine that actually executes the user-defined function is abstracted as a ['container'](http://docs.aws.amazon.com/lambda/latest/dg/lambda-introduction.html). When defining a Lambda function, users are able to declare the amount of memory available to the function, which directly affects the physical hardware specification of the Lambda container.
-	Changing the amount of memory available to your Lambda functions also affects the amount of [CPU power](https://aws.amazon.com/lambda/faqs/) available to it.
-	While AWS does not offer hard guarantees around container reuse, in general it can be expected that an unaltered Lambda function will reuse a warm (previously used) container if called shortly after another invocation. Users can use this as a way to optimize their functions by smartly caching application data on initialization.
-	A Lambda that hasn't been invoked in some time may not have any warm containers left. In this case, the Lambda system will have to load and initialize the Lambda code in a 'cold start' scenario, which can add significant latency to Lambda invocations.  Lambda cold start performance [has improved significantly over the 2018-2019 timeframe](https://levelup.gitconnected.com/aws-lambda-cold-start-language-comparisons-2019-edition-%EF%B8%8F-1946d32a0244) and is now typically in the range of 200-500 ms for a simple function depending on the language runtime.  
-	Lambda functions running insides of VPCs have also seen [recent improvements](https://aws.amazon.com/blogs/compute/announcing-improved-vpc-networking-for-aws-lambda-functions/) to cold start times.  Previously these VPC-hosted functions would have cold starts of ~15 seconds; now those same functions cold start in < 1 second.   
-	There are a few strategies to avoiding or mitigating cold starts.  [Provisioned concurrency](https://aws.amazon.com/blogs/aws/new-provisioned-concurrency-for-lambda-functions/) was announced at re:invent 2019 and is an effective means to eliminating cold starts. Other techniques include keeping containers warm by periodic triggering and favoring lightweight runtimes such as Node as opposed to Java.
-	Lambda is integrated with AWS CloudWatch and provides a logger at runtime that publishes CloudWatch events.
-	Lambda offers out-of-the-box opt-in support for AWS X-Ray. X-Ray can help users diagnose Lambda issues by offering in-depth analysis of their Lambda's execution flow. This is especially useful when investigating issues calling other AWS services as X-Ray gives you a detailed and easy-to-parse [visualization of the call graph](http://docs.aws.amazon.com/lambda/latest/dg/lambda-x-ray.html#lambda-service-map).
-	Using [timed CloudWatch events](http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#CronExpressions), users can use Lambda to run periodic jobs in a cron-like manner.
-	Events sent to Lambda that fail processing can be managed using a [Dead Letter Queue (DLQ) in SQS.](http://docs.aws.amazon.com/lambda/latest/dg/dlq.html)
-	More on serverless:
	-	[Martin Fowler's thoughts.](http://martinfowler.com/articles/serverless.html)
	-	[AWS Serverless Application Model (SAM)](https://github.com/awslabs/serverless-application-model), a simplification built on top of CloudFormation that can help to define, manage, and deploy serverless applications using Lambda.
	-	[Serverless](https://github.com/serverless/serverless), one of the most popular frameworks for building serverless applications using AWS Lambda and other serverless compute options.
	-	[Other helpful frameworks.](https://github.com/anaibol/awesome-serverless#frameworks)

### Lambda Alternatives and Lock-in

-	🚪Other clouds offer similar services with different names, including [Google Cloud Functions](https://cloud.google.com/functions/), [Azure Functions](https://azure.microsoft.com/en-us/services/functions/), and [IBM OpenWhisk](http://www.ibm.com/cloud-computing/bluemix/openwhisk/). Also if you are running Kubernetes another Lambda alternative is [OpenFaaS](https://github.com/openfaas/faas)

### Lambda Gotchas and Limitations

- 🔸Testing Lambdas, locally and remotely, can be a challenge. Several tools are available to make this easier, including the officially supported [SAM Local](https://github.com/awslabs/aws-sam-local).
- 🔸Managing lots of Lambda functions is a workflow challenge, and tooling to manage Lambda deployments is still immature.
- 🔸AWS’ official workflow around managing function [versioning and aliases](https://docs.aws.amazon.com/lambda/latest/dg/versioning-aliases.html) is painful. One option is to avoid Lambda versioning by abstracting your deployment workflow outside of Lambda. One way this can be accomplished is by deploying your application in successive stages, with a distinct AWS account per stage, where each account only needs to be aware of the latest version, and rollbacks and updates are handled by external tooling.
- 🔸As of Oct 2017, the minimum charge for a Lambda invocation is 100ms, so there is no cost-benefit to reducing your run time below that.
- 🔸While adding/removing S3 buckets as triggers for Lambda function, this error may occur: "There was an error creating the trigger: Configuration is ambiguously defined. Cannot have overlapping suffixes in two rules if the prefixes are overlapping for the same event type." In this case, you can manually remove the Lambda event in the "Events" tab in the "Properties" section of the S3 bucket.
- 🔸Managing the size of your deployment artifact can be a challenge, especially if using Java. Options to mitigate this include [proguard](https://www.guardsquare.com/en/proguard) and loading dependencies at runtime into /tmp.
- When using DynamoDB as a trigger for your Lambda functions, this error may occur: "PROBLEM: internal Lambda error. Please contact Lambda customer support." This usually just means that Lambda can't detect anything in the DynamoDB stream within the last 48 hours. If the issue persists, deleting and recreating your trigger may help.
- 🔸If your lambda needs access to resources in a VPC (for example ElastiCache or RDS), it will need to be deployed within it. This will increase cold-start times as an Elastic Network Interface (ENI) will have to be registered within the VPC for each concurrent function. AWS also has a relatively low initial limit (350) on the number ENI's that can be created within an VPC, however this can be increased to the 1000s if a good case is made to AWS support.
-	🔸 Lambda has several [**resource limits**](http://docs.aws.amazon.com/lambda/latest/dg/limits.html) as of 2017-06:
	-	A **6MB** request or response payload size.
	-	A **50 MB** limit on the compressed .zip/.jar file deployment package size.
	-	A **250 MB** limit on the code/dependencies in the package before compression.
	- A **500 MB** limit on local storage in /tmp.

### Lambda Code Samples

-	[Fan-out](https://github.com/awslabs/aws-lambda-fanout) is an example of using Lambda to “fan-out” or copy data from one service, in this case Kinesis, to multiple other AWS data services. Destinations for fan-out data in the sample include IoT, SQS and more.
-	This [AWS limit monitor using Lambdas](https://github.com/awslabs/aws-limit-monitor) shows use of multiple Lambdas for monitoring.
-	This [Lambda ECS Worker Pattern](https://github.com/awslabs/lambda-ecs-worker-pattern) shows use of Lambda in a workflow where data from S3 is picked up by the Lambda, pushed to a queue, then sent to ECS for more processing.
-	The [Secure Pet Store](https://github.com/awslabs/api-gateway-secure-pet-store) is a sample Java application which uses Lambda and API Gateway with Cognito (for user identity).
-	[aws-lambda-list](https://github.com/unixorn/aws-lambda-list) is a list of "hopefully useful AWS lambdas and lambda-related resources". Quite a few code samples here; as usual, not guaranteed tested. Caveat Emptor.

🚧 [*Please help expand this incomplete section.*](CONTRIBUTING.md)

API Gateway
-----------

### API Gateway Basics

-	📒 [Homepage](https://aws.amazon.com/api-gateway/) ∙ [Developer guide](http://docs.aws.amazon.com/apigateway/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/api-gateway/faqs/) ∙ [Pricing](https://aws.amazon.com/api-gateway/pricing/)
-	**API Gateway** provides a scalable, secured front-end for service APIs, and can work with Lambda, Elastic Beanstalk, or regular EC2 services.
-	It allows “serverless” deployment of applications built with Lambda.
-	🔸Switching over deployments after upgrades can be tricky. There are no built-in mechanisms to have a single domain name migrate from one API gateway to another one. So it may be necessary to build an additional layer in front (even another API Gateway) to allow smooth migration from one deployment to another.

### API Gateway Alternatives and Lock-In

- [Kong](https://getkong.org) is an open-source, on-premises API and microservices gateway built on nginx with Lua. Kong is extensible through “plugins”.
- [Tyk](https://tyk.io) is an open-source API gateway implemented in Go and available in the cloud, on-premises or hybrid.

### API Gateway Tips

-	🔹Prior to 2016-11, you could only send and receive plain text data (so people would base64-encode binary data), but binary data is [now](https://aws.amazon.com/about-aws/whats-new/2016/11/binary-data-now-supported-by-api-gateway/) supported.
-	API Gateway supports the OpenApi specification (aka [Swagger](https://swagger.io/)). This allows you to describe your API in a language-agnostic way and use various tools to generate code supporting your API.
-	Generating clients is extremely easy, either through the AWS console or using the get-sdk API.
-	API Gateway integrates with CloudWatch out-of-the-box, allowing for easy logging of requests and responses.
	-	Note that if your request or response are too large, CloudWatch will truncate the log. For full request/reply logging, make sure to do so in your integration (e.g. Lambda).
	-	A good practice when calling API Gateway APIs is to log the request ID on the client. You can later refer to these request IDs in CloudWatch for easier tracing and debugging.
-	There are multiple ways to secure your API, including built-in support for [AWS Cognito](http://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-integrate-with-cognito.html). For most use-cases, Cognito is the easiest and simplest way to authenticate users.
	-	Although you can roll your own solution using a [custom authorizer](http://docs.aws.amazon.com/apigateway/latest/developerguide/use-custom-authorizer.html), which is basically a Lambda you define that determines if a request is acceptable or not.
-	While API Gateway lends itself well to REST-style development, it's perfectly reasonable to implement an RPC-style API in API Gateway as well. Depending on your use-case, this can often lead to a much simpler API structure and smoother client experience.
	-	RPC-style APIs are particularly useful when designing services that sit deeper in the stack and don't serve content directly to users.


### API Gateway Gotchas and Limitations

-	🔸API Gateway only supports encrypted (https) endpoints, and does not support unencrypted HTTP. (This is probably a good thing.)
-	🔸API Gateway doesn’t support multi-region deployments for high availability. It is a service that is deployed in a single region but comes with a global endpoint that is served from AWS edge locations (similar to a CloudFront distribution). You cannot have multiple API Gateways with the same hostname in different AWS regions and use Route 53 to distribute the traffic. More in [this forum post](https://forums.aws.amazon.com/thread.jspa?messageID=735342&#735342).
- 🔸Integration timeout: All of the various integration types (eg: Lambda, HTTP) for API Gateway have timeouts, as described [here](http://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html#api-gateway-limits). Unlike some limits, these timeouts can't be increased.
- 🔸API Gateway returns a 504 status code for any network or low level transport related issue. When this happens, you may see a message in the CloudWatch logs for the request that includes the message: `Execution failed due to an internal error`. One possible reason for this error is that even though your backend server is up and running, it may be doing something outside of the HTTP specification (like not sending well-formed chunked messages). You can test by hitting your backend directly with the `curl --raw -S -i <backend-endpoint-url>` and seeing if it complains.
-	🔸AWS X-Ray support exists but cumbersome to use. If you have other AWS services calling API Gateway, your trace will seemingly end there. API Gateway will also not appear as a node in your service map. [More here](http://docs.aws.amazon.com/xray/latest/devguide/xray-services-apigateway.html).
-	🔸Be careful using the export feature. The resulting Swagger template is often incomplete and doesn't integrate well with the Swagger extensions for things such as CORS.
-	🔸Many changes to API Gateway resources need to be 'deployed' via console or API call. Unfortunately, API Gateway is terrible about notifying the user when changes are staged for deployment and what changes require deployment. If you've changed something about your API and it's not taking effect, there's a decent chance you just need to deploy it.
	-	In particular, when deploying an API Gateway as part of a CloudFormation stack, changes will not automatically deploy unless the deployment resource itself was changed. You can change work around this by always changing the deployment resource on a CloudFormation update, or running a custom resource that ensures the deployment is made.
	-	Alternatively, by using the [Serverless Application Model](https://github.com/awslabs/serverless-application-model) definition for an API Gateway resource, you can always expect the API to be deployed on a stack update since SAM will generate a new deployment every time.
- 🔸API Gateway does not support nested query parameters on method requests.
- 🔸API Gateway limits number of resources to 300, as described [here](http://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html#api-gateway-limits). This is something to be considered when you start using API Gateway as a platform where your team/organization deploys to the same API Gateway.

🚧 [*Please help expand this incomplete section.*](CONTRIBUTING.md)

Step Functions
------

### Step Functions Basics
-	📒 [Homepage](https://aws.amazon.com/step-functions/) ∙ [Developer guide](http://docs.aws.amazon.com/step-functions/latest/dg/welcome.html) ∙ [FAQ](https://aws.amazon.com/step-functions/faqs/) ∙ [Pricing](https://aws.amazon.com/step-functions/pricing/)
-	**Step Functions** is AWS’ way to create state machines that manage a serverless workflow.

### Step Functions Tips
-   A variety of structures are supported including branching, parallel operations and waits
-   [Tasks](https://docs.aws.amazon.com/step-functions/latest/dg/concepts-tasks.html) represent the real work nodes and are frequently Lambda functions, but can be [Activities](https://docs.aws.amazon.com/step-functions/latest/dg/concepts-activities.html) which are externally driven tasks implemented any way you like.
-   State machines have [data](https://docs.aws.amazon.com/step-functions/latest/dg/concepts-state-machine-data.html) that "flows" through the steps and can be modified and added to as the state machine executes.
-   It's best if your tasks are idempotent, in part because you may want to re-run the state machine with the same input data during debugging
-   The AWS Console facilitates your examining the execution state at various steps.
    -   The console lets you do this with a few steps:
        -   select the "input" tab from the failed execution
        -   copy the input data (JSON)
        -   select the state machine name in the breadcrumbs
        -   start a new execution, pasting the input data you copied previously

### Step Functions Gotchas and Limitations
-   Step Functions are free tier eligible up to an initial 4000 transitions per month. Thereafter, the charge is $0.025 per 1000 state transitions.
-   You can have many, simultaneous, executions, but be aware of lambda throttling limits. This has been per-account, pre-region, but recently became settable per-lambda.
-   Step Function executions are limited to 25,000 events. Each step creates multiple events. This means that [iterating a loop using Lambda](https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-create-iterate-pattern-section.html) is limited to an iteration count of around 3000 before needing to [continue as a new execution](https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-continue-new.html).

Route 53
--------

### Route 53 Basics

-	📒 [Homepage](https://aws.amazon.com/route53/) ∙ [Developer guide](http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/) ∙ [FAQ](https://aws.amazon.com/route53/faqs/) ∙ [Pricing](https://aws.amazon.com/route53/pricing/)
-	**Route 53** is AWS’ DNS service.

### Route 53 Alternatives and Lock-In

-	Historically, AWS was slow to penetrate the DNS market (as it is often driven by perceived reliability and long-term vendor relationships) but Route 53 has matured and [is becoming the standard option](https://www.datanyze.com/market-share/dns/) for many companies. Route 53 is cheap by historic DNS standards, as it has a fairly large global network with geographic DNS and other formerly “premium” features. It’s convenient if you are already using AWS.
-	⛓Generally you don’t get locked into a DNS provider for simple use cases, but increasingly become tied in once you use specific features like geographic routing or Route 53’s alias records.
-	🚪Many alternative DNS providers exist, ranging from long-standing premium brands like [UltraDNS](https://www.neustar.biz/services/dns-services) and [Dyn](http://dyn.com/managed-dns/) to less well known, more modestly priced brands like [DNSMadeEasy](http://www.dnsmadeeasy.com/). Most DNS experts will tell you that the market is opaque enough that reliability and performance don’t really correlate well with price.
-	⏱Route 53 is usually somewhere in the middle of the pack on performance tests, e.g. the [SolveDNS reports](http://www.solvedns.com/dns-comparison/).

### Route 53 Tips

-	🔹Know about Route 53’s “alias” records:
	-	Route 53 supports all the standard DNS record types, but note that [**alias resource record sets**](http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resource-record-sets-choosing-alias-non-alias.html) are not standard part of DNS, but a specific Route 53 feature. (It’s available from other DNS providers too, but each provider has a different name for it.)
	-	Aliases are like an internal name (a bit like a CNAME) that is resolved internally on the server side. For example, traditionally you could have a CNAME to the DNS name of a CLB or ALB, but it’s often better to make an alias to the same load balancer. The effect is the same, but in the latter case, externally, all a client sees is the target the record points to.
	-	It’s often wise to use alias record as an alternative to CNAMEs, since they can be updated instantly with an API call, without worrying about DNS propagation.
	-	You can use them for CLBs/ALBs or any other resource where AWS supports it.
	-	Somewhat confusingly, you can have CNAME and A aliases, depending on the type of the target.
	-	Because aliases are extensions to regular DNS records, if exported, the output [zone file](https://en.wikipedia.org/wiki/Zone_file) will have additional non-standard “ALIAS” lines in it.
-	[**Latency-based routing**](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy.html#routing-policy-latency) allows users around the globe to be automatically directed to the nearest AWS region where you are running, so that latency is reduced.
-	Understand that domain registration and DNS management (hosted zones) are two separate Route 53 services. When you buy/transfer a domain, Route 53 automatically assigns four name servers to it (e.g. ns-2.awsdns-00.com). Route 53 also offers to automatically create a hosted zone for DNS management, but you are not required do your DNS management in the same account or even in Route 53; you just need to create an NS record pointing to the servers assigned to your domain in Route 53.
  - One use case would be to put your domain registration (very mission critical) in a [bastion account](https://cloudonaut.io/your-single-aws-account-is-a-serious-risk/) while managing the hosted zones within another account which is accessible by your applications.

### Route 53 Gotchas and Limitations
-   🔸Private Hosted Zone will only respond to DNS queries that originate from within a VPC. As a result Route53 will not respond to request made via a VPN or Direct connect. To get around this you will need to implement [Hybrid Cloud DNS Solutions](https://d1.awsstatic.com/whitepapers/hybrid-cloud-dns-options-for-vpc.pdf) or use the Simple AD provided IP addresses to query the hosted zone.


CloudFormation
--------------

### CloudFormation Basics

-	📒 [Homepage](https://aws.amazon.com/cloudformation/) ∙ [Developer guide](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/) ∙ [FAQ](https://aws.amazon.com/cloudformation/faqs/) ∙ [Pricing](https://aws.amazon.com/cloudformation/pricing/) at no additional charge
-	**CloudFormation** allows you to manage sets of resources from other AWS services grouped into **[stacks](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-whatis-concepts.html#d0e3917)**. CloudFormation allows you to define these stacks in a template using [JSON](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html#aws-properties-ec2-instance-syntax.json) or [YAML](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html#aws-properties-ec2-instance-syntax.yaml). CloudFormation is one of the major services underpinning AWS' [infrastructure as code capabilities](https://d0.awsstatic.com/whitepapers/DevOps/infrastructure-as-code.pdf) and is crucial in enabling repeatable and consistent deployments of infrastructure.
-	💸CloudFormation itself has [no additional charge](https://aws.amazon.com/cloudformation/pricing/); you pay for the underlying resources.

### CloudFormation Alternatives and Lock-In

-	HashiCorp’s [Terraform](https://www.terraform.io/intro/vs/cloudformation.html) is a third-party alternative that can support other cloud platforms/providers including [Azure](https://www.terraform.io/docs/providers/azure/) and [OpenStack](https://www.terraform.io/docs/providers/openstack/).
- 🔸Some AWS features may not be available in Terraform (e.g. multi-AZ ElastiCache using Redis), and you may have to resort to embedded CloudFormation templates.
-	[Pulumi](https://www.pulumi.com/) enables teams to define and deliver Cloud Native Infrastructure as Code on any cloud, with any language. From containers to serverless to Kubernetes to infrastructure.

### CloudFormation Tips

-	Validate your stack in a different AWS account! CloudFormation truly shines when making multiple deployments of the same stack to different accounts and regions. A common practice is to deploy stacks in successive stages ending in a production rollout.
-	Avoid potentially time-consuming syntax errors from eating into your deployment time by running `validate-template`.
-	CloudFormation is sometimes slow to update what resources (and new features on old services) a user is able to define in the template. If you need to deploy a resource or feature that isn't supported by the template, CloudFormation allows running arbitrary code (using [Lambda](#lambda)) on a stack create or update via [custom resources](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html).
-	Custom resources make CloudFormation into a truly powerful tool, as you can do all sorts of neat things quite easily such as sanity tests, initial configuration of Dynamo tables or S3 buckets, cleaning up old CloudWatch logs, etc.
	- For writing Custom Resources in Javascript, AWS provides a good reference in the [documentation.](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html)
-	CloudFormation offers a visual [template designer](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer-walkthrough-createbasicwebserver.html) that can be useful when getting up to speed with the template syntax.
-	By using [StackSets](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-concepts.html), users can define and deploy an entire production application consisting of multiple stacks (one service per stack) in a single CloudFormation template.
-	If you're developing a serverless application (i.e., using Lambda, API Gateway) CloudFormation offers a simplified template format called [SAM](https://github.com/awslabs/serverless-application-model).
-	❗Use a restrictive [stack policy](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html)! Without one, you can inadvertently delete live production resources, probably causing a severe outage.
-	❗Turn on [termination protection](https://aws.amazon.com/about-aws/whats-new/2017/09/aws-cloudformation-provides-stack-termination-protection/) on all of your stacks to avoid costly accidents!
-	The CloudFormation [template reference](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-reference.html) is indispensable when discovering what is and isn't possible in a CloudFormation template.
-	[Troposphere](https://github.com/cloudtools/troposphere) is a Python library that makes it much easier to create CloudFormation templates.
	- Currently supports [AWS](https://github.com/cloudtools/troposphere#currently-supported-aws-resource-types) and [OpenStack](https://github.com/cloudtools/troposphere#currently-supported-openstack-resource-types) resource types.
	- Troposphere attempts to support all resources types that can be described in CloudFormation templates.
	- Built in [error](https://github.com/cloudtools/troposphere#examples-of-the-error-checking-full-tracebacks-removed-for-clarity) checking.
	- A recommended soft dependency is [awacs](https://github.com/cloudtools/awacs), which allows you to generate AWS access policy in JSON by writing Python code.
-	[stacker](http://stacker.readthedocs.io/en/latest/) is a Python application that makes it easy to define, configure, orchestrate and manage dependencies for CloudFormation stacks across multiple user-defined environments.
-	If you are building different stacks with similar layers, it may be useful to build separate templates for each layer that you can reuse using [AWS::CloudFormation::Stack](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-stack.html).
-	🔸Avoid hardcoding resource parameters that can potentially change. Use stack parameters as much as you can, and resort to default parameter values.
-	🔹Until [2016](https://aws.amazon.com/about-aws/whats-new/2016/09/aws-cloudformation-introduces-yaml-template-support-and-cross-stack-references/), CloudFormation used only an awkward JSON format that makes both reading and debugging difficult. To use it effectively typically involved building additional tooling, including converting it to YAML, but now [this is supported directly](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-formats.html).
- Wherever possible, export relevant [physical IDs](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-name.html) from your Stacks by defining [Outputs in your CloudFormation Templates](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html). These are the actual names assigned to the resources being created. Outputs can be returned from `DescribeStack` API calls, and get imported to other Stacks as part of the [recent addition](https://aws.amazon.com/about-aws/whats-new/2016/09/aws-cloudformation-introduces-yaml-template-support-and-cross-stack-references/) of [cross-stack references](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-crossstackref.html).
	-Note that importing outputs in a stack from another stack creates a hard dependency that is tracked by CloudFormation. You will not be able to delete the stack with the outputs until there are no importing stacks.
-	CloudFormation can be set up to [send SNS notifications](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-add-tags.html) upon state changes, enabling programmatic handling of situations where stacks fail to build, or simple email alerts so the appropriate people are informed.
-	CloudFormation allows the use of [**conditionals**](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/conditions-section-structure.html) when creating a stack.
	-	One common way to leverage this capability is in support of multi-environment CloudFormation templates – by configuring them to use ‘if-else’ statements on the value of a [parameter passed in](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html) (e.g.  “env”), environment-specific values for things like VPC IDs, SecurityGroup IDs, and AMI names can be passed into reusable generic templates.
-	**Version control your CloudFormation templates!** In the Cloud, an application is the combination of the code written and the infrastructure it runs on. By version controlling **both**, it is easy to roll back to known good states.
-	Avoid naming your resources explicitly (e.g. DynamoDB tables). When deploying multiple stacks to the same AWS account, these names can come into conflict, potentially slowing down your testing. Prefer using resource references instead.
-	For things that shouldn't ever be deleted, you can set an explicit DeletionPolicy on the resource that will prevent the resource from being deleted even if the CloudFormation stack itself is deleted. This is useful for anything that can maintain expensive-to-rebuild state, such as DynamoDB tables, and things that are exposed to the outside world, such as API Gateway APIs.

### CloudFormation Gotchas and Limitations

-	🔸A given CloudFormation stack can end up in a wide variety of states. Error reporting is generally weak, and often times multiple observe-tweak-redeploy cycles are needed to get a working template. The internal state machine for [all the varying states](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-describing-stacks.html) is extremely opaque.
-	🔸Some cross-region operations are not possible in CloudFormation without using a custom resource, such as [cross-region SNS subscriptions](https://github.com/serverless/serverless/issues/3676).
-	🔸While having hand-made resources live alongside CloudFormation-created resources is inadvisable, it's sometimes unavoidable. If at all possible, leave ALL resource management up to a CloudFormation template and only provide read-only access to the console.
-	❗Modifications to stack resources made outside CloudFormation can potentially lead to stacks stuck in UPDATE\_ROLLBACK\_FAILED mode. Stacks in this state can be recovered using the [continue-update-rollback command](https://aws.amazon.com/blogs/devops/continue-rolling-back-an-update-for-aws-cloudformation-stacks-in-the-update_rollback_failed-state/). This command can be initiated in the console or in the CLI. The [--resources-to-skip](http://docs.aws.amazon.com/cli/latest/reference/cloudformation/continue-update-rollback.html) parameter usable in the CLI can be useful if the continue-update-rollback command fails. New feature [Drift Detection](https://aws.amazon.com/blogs/aws/new-cloudformation-drift-detection/) can be used to detect outside changes made to stack.
-	🔸CloudFormation is useful but complex and with a variety of pain points. Many companies find alternate solutions, and many companies use it, but only with significant additional tooling.
-	🔸CloudFormation can be very slow, especially for items like CloudFront distributions and Route53 CNAME entries.
-	🔸It’s hard to assemble good CloudFormation configurations from existing state. AWS does [offer a trick to do this](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-using-cloudformer.html), but it’s very clumsy.
	- CloudFormer also hasn't been updated in ages (as of Oct 2017), doesn't support templatizing many new services, and won't fully define even existing services that have since been updated. For example, Dynamo tables defined through CloudFormer won't contain TTL definitions or auto-scaling configuration. There is a third-party version of the tool with more supported resources called [Former2](https://github.com/iann0036/former2).
-	🔸Many users don’t use CloudFormation at all because of its limitations, or because they find other solutions preferable. Often there are other ways to accomplish the same goals, such as local scripts (Boto, Bash, Ansible, etc.) you manage yourself that build infrastructure, or Docker-based solutions ([Convox](https://convox.com/), etc.).
-	🔸Deploying large stacks (i.e., many resources) can be problematic due to unintuitive API limits. For instance, API Gateway's `CreateDeployment` API has a default limit of [3 requests per minute](https://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html) as of 1/12/2018. This limit is readily exceeded even in moderately-sized CloudFormation stacks. Creating CW alarms is another commonly seen limit (`PutMetricAlarm`, 3 tps as of 1/12/2018) especially when creating many autoscaling policies for DynamoDB. One way to work around this limit is to include CloudFormation 'DependsOn' clauses to artificially chain resource creation.
-	🔸Creating/deleting stacks can be a little less clean than ideal. Some resources will leave behind traces in your AWS account even after deletion. E.g., Lambda will leave behind CloudWatch log groups that never expire.

VPCs, Network Security, and Security Groups
-------------------------------------------

### VPC Basics

-	📒 [Homepage](https://aws.amazon.com/vpc/) ∙ [User guide](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide) ∙ [FAQ](https://aws.amazon.com/vpc/faqs/) ∙ [Security groups](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html) ∙ [Pricing](https://aws.amazon.com/vpc/pricing/)
-	**VPC** (Virtual Private Cloud) is the virtualized networking layer of your AWS systems.
-	Most AWS users should have a basic understanding of VPC concepts, but few need to get into all the details. VPC configurations can be trivial or extremely complex, depending on the extent of your network and security needs.
-	All modern AWS accounts (those created [after 2013-12-04](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-vpc.html)) are “EC2-VPC” accounts that support VPCs, and all instances will be in a default VPC. Older accounts may still be using “EC2-Classic” mode. Some features don’t work without VPCs, so you probably will want to [migrate](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/vpc-migrate.html).

### VPC and Network Security Tips

-	❗**Security groups** are your first line of defense for your servers. Be extremely restrictive of what ports are open to all incoming connections. In general, if you use CLBs, ALBs or other load balancing, the only ports that need to be open to incoming traffic would be port 22 and whatever port your application uses. Security groups access policy is 'deny by default'.
-	**Port hygiene:** A good habit is to pick unique ports within an unusual range for each different kind of production service. For example, your web frontend might use 3010, your backend services 3020 and 3021, and your Postgres instances the usual 5432. Then make sure you have fine-grained security groups for each set of servers. This makes you disciplined about listing out your services, but also is more error-proof. For example, should you accidentally have an extra Apache server running on the default port 80 on a backend server, it will not be exposed.
-	**Migrating from Classic**: For migrating from older EC2-Classic deployments to modern EC2-VPC setup, [this article](http://blog.kiip.me/engineering/ec2-to-vpc-executing-a-zero-downtime-migration/) may be of help.
	-	You can [migrate Elastic IPs between EC2-Classic and EC2-VPC](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html#using-eip-migration).
-	For basic AWS use, one default VPC may be sufficient. But as you scale up, you should consider mapping out network topology more thoroughly. A good overview of best practices is [here](http://blog.flux7.com/blogs/aws/vpc-best-configuration-practices).
-	Consider controlling access to you private AWS resources through a [VPN](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpn-connections.html).
	-	You get better visibility into and control of connection and connection attempts.
	-	You expose a smaller surface area for attack compared to exposing separate (potentially authenticated) services over the public internet.
		-	e.g. A bug in the YAML parser used by the Ruby on Rails admin site is much less serious when the admin site is only visible to the private network and accessed through VPN.
	-	Another common pattern (especially as deployments get larger, security or regulatory requirements get more stringent, or team sizes increase) is to provide a [bastion host](https://www.pandastrike.com/posts/20141113-bastion-hosts) behind a VPN through which all SSH connections need to transit.
	-	For a cheap VPN to access private AWS resources, consider using a point-to-site software VPN such as [OpenVPN](https://openvpn.net/). It can either be installed using the [official AMI](https://docs.openvpn.net/how-to-tutorialsguides/virtual-platforms/amazon-ec2-appliance-ami-quick-start-guide/), though you are limited to 2 concurrent users on the free license, or it can be installed using the openvpn package on linux. The linux package allows for unlimited concurrent users but the installation is less straightforward. This [OpenVPN installer script](https://github.com/Nyr/openvpn-install) can help you install it and add client keys easily.
-	🔹Consider using other security groups as sources for security group rules instead of using CIDRs — that way, all hosts in the source security group and only hosts in that security group are allowed access. This is a much more dynamic and secure way of managing security group rules.
-	**VPC Flow Logs** allow you to monitor the network traffic to, from, and within your VPC. Logs are stored in CloudWatch Logs groups, and can be used for security monitoring (with third party tools), performance evaluation, and forensic investigation.
	-	See the [VPC Flow Logs User Guide](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html) for basic information.
	-	See the [flowlogs-reader](https://github.com/obsrvbl/flowlogs-reader) CLI tool and Python library to retrieve and work with VPC Flow Logs.
- **IPv6** [is available in VPC](https://aws.amazon.com/blogs/aws/new-ipv6-support-for-ec2-instances-in-virtual-private-clouds/). Along with this announcement came the introduction of the [Egress-Only Internet Gateway](https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/egress-only-internet-gateway.html). In cases where one would use NAT Gateways to enable egress-only traffic for their VPC in IPv4, one can use an Egress-Only Internet Gateway for the same purpose in IPv6.

-	Amazon provides an IPv6 CIDR block for your VPC at your request - at present you cannot implement your own IPv6 block if you happen to own one already.
-	New and existing VPCs can both use IPv6. Existing VPCs will need to be configured to have an IPv6 CIDR block associated with them, just as new VPCs do.

### PrivateLink
- 📒[Homepage](https://aws.amazon.com/privatelink/) ∙ [User Guide](https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html) ∙  [Pricing](https://aws.amazon.com/privatelink/pricing/)
- One of the uses for Private link is [Interface VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html) deploys an ENI into your VPC and subnets which allows you direct access to the AWS API's as if the were accessible locally in your VPC without having to go out to the internet.
- Another use case would be to expose a service of your own to other accounts in AWS through a [VPC Endpoint Service](https://docs.aws.amazon.com/vpc/latest/userguide/endpoint-service.html)

### VPC and Network Security Gotchas and Limitations
-	🔸VPCs are tied to one Region in one Account. Subnets are tied to one VPC and limited to one Availability Zone.
-	🔸Security groups are tied to one VPC. If you are utilizing infrastructure in multiple VPCs you should make sure your configuration/deployment tools take that into account.
-	🔸[VPC Endpoints](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html) are currently only available for S3 and DynamoDB. If you have a security requirement to lockdown outbound traffic from your VPC you may want to use [DNS filtering](https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/) to control outbound traffic to other services.
-	❗Be careful when choosing your VPC IP CIDR block: If you are going to need to make use of [ClassicLink](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/vpc-classiclink.html), make sure that your private IP range [doesn’t overlap](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/vpc-classiclink.html#classiclink-limitations) with that of EC2 Classic.
-	❗If you are going to peer VPCs, carefully consider the cost of [data transfer between VPCs](https://aws.amazon.com/vpc/faqs/#Peering_Connections), since for some workloads and integrations, this can be prohibitively expensive.
- ❗New RDS instances require a [subnet group](http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_VPC.WorkingWithRDSInstanceinaVPC.html#USER_VPC.Subnets) within your VPC. If you’re using the [default VPC](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html) this isn’t a concern, it will contain a subnet for each availability zone in your region. However, if you’re creating your own VPC and plan on using RDS, make sure you have at least two subnets within the VPC to act as the subnet group.
-	❗If you delete the default VPC, you can [recreate it via the CLI or the console](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html#create-default-vpc).
-	❗Be careful with VPC VPN credentials! If lost or compromised, the VPN endpoint must be deleted and recreated. See the instructions for [Replacing Compromised Credentials](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_VPN.html#CompromisedCredentials).
-	❗Security Groups and Route Tables apply entries separately for IPv4 and IPv6, so one must ensure they add entries for both protocols accordingly.
- 	💸Managed NAT gateways are a convenient alternative to
manually managing [NAT instances](https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPCNATInstance.html), but they do come at a cost per gigabyte. Consider [alternatives](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-comparison.html) if you're transferring many terabytes from private subnets to the internet. If you transfer terabytes/petabytes of data from EC2 instances in private subnets to S3, avoid the [NAT gateway data processing charge](https://aws.amazon.com/vpc/pricing/) by setting up a Gateway Type VPC Endpoint and route the traffic to/from S3 through the VPC endpoints instead of going through the NAT gateways.

KMS
---

### KMS Basics

-	📒 [Homepage](https://aws.amazon.com/kms/) ∙ [Developer guide](http://docs.aws.amazon.com/kms/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/kms/faqs/) ∙ [Pricing](https://aws.amazon.com/kms/pricing/)
-	**KMS** (Key Management Service) is a secure service for creating, storing and auditing usage of cryptographic keys.
- **Service integration:** KMS [integrates with other AWS services](http://docs.aws.amazon.com/kms/latest/developerguide/service-integration.html): EBS, Elastic Transcoder, EMR, Redshift, RDS, SES, S3, WorkMail and Workspaces.
- **Encryption APIs:** The [Encrypt](http://docs.aws.amazon.com/kms/latest/APIReference/API_Encrypt.html) and [Decrypt API](http://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html) allow you to encrypt and decrypt data on the KMS service side, never exposing the master key contents.
- **Data keys:** The [GenerateDataKey](http://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#data-keys) API generates a new key off of a master key. The data key contents are exposed to you so you can use it to encrypt and decrypt any size of data in your application layer. KMS does not store, manage or track data keys, you are responsible for this in your application.
- 🔹**Auditing:** Turn on CloudTrail to audit all KMS API events.
- **Access:** Use [key policies](http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html) and [IAM policies](http://docs.aws.amazon.com/kms/latest/developerguide/iam-policies.html) to grant different levels of KMS access. For example, you create an IAM policy that only [allows a user to encrypt and decrypt with a specific key](http://docs.aws.amazon.com/kms/latest/developerguide/iam-policies.html#iam-policy-example-encrypt-decrypt-specific-cmks).

### KMS Tips

-	🔹It’s very common for companies to manage keys completely via home-grown mechanisms, but it’s far preferable to use a service such as KMS from the beginning, as it encourages more secure design and improves policies and processes around managing keys.
-	A good motivation and overview is in [this AWS presentation](http://www.slideshare.net/AmazonWebServices/encryption-and-key-management-in-aws).
-	The cryptographic details are in [this AWS whitepaper](https://d0.awsstatic.com/whitepapers/KMS-Cryptographic-Details.pdf).
-	[This blog from Convox](https://convox.com/blog/encryption-at-rest) demonstrates why and how to use KMS for encryption at rest.

### KMS Gotchas and Limitations

-	🔸The Encrypt API only works with < 4KB of data. Larger data requires generating and managing a [data key](http://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#data-keys) in your application layer.
-	🔸KMS audit events are not available in the [CloudTrail Lookup Events API](http://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_LookupEvents.html). You need to look find them in the raw .json.gz files that CloudTrail saves in S3.
-	🔸In order to encrypt a multi-part upload to S3, the KMS Key Policy needs to allow “kms:Decrypt” and “kms:GenerateDataKey*” in addition to “kms:Encrypt”, otherwise the upload will fail with an “AccessDenied” error.
-	🔸KMS keys are region specific — they are stored and can only be used in the region in which they are created. They can't be transferred to other regions.
-	🔸KMS keys have a key policy that must grant access to something to manage the key.  If you don't grant anything access to the key on creation, then you have to reach out to support to have the key policy reset [Reduce the Risk of the Key Becoming Unmanagable](https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default-allow-root-enable-iam).
-	🔸If you use a key policy to grant access to IAM roles or users and then delete the user/role, recreating the user or role won't grant them permission to the key again.


CloudFront
----------

### CloudFront Basics

-	📒 [Homepage](https://aws.amazon.com/cloudfront/) ∙ [Developer guide](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/) ∙ [FAQ](https://aws.amazon.com/cloudfront/faqs/) ∙ [Pricing](https://aws.amazon.com/cloudfront/pricing/)
-	**CloudFront** is AWS’ [content delivery network (CDN)](https://en.wikipedia.org/wiki/Content_delivery_network).
-	Its primary use is improving latency for end users through accessing cacheable content by hosting it at [over 60 global edge locations](http://aws.amazon.com/cloudfront/details/).

### CloudFront Alternatives and Lock-in

-	🚪CDNs are [a highly fragmented market](https://www.datanyze.com/market-share/cdn/). CloudFront has grown to be a leader, but there are many alternatives that might better suit specific needs.

### CloudFront Tips

-	🐥**IPv6** is [supported](https://aws.amazon.com/about-aws/whats-new/2016/10/ipv6-support-for-cloudfront-waf-and-s3-transfer-acceleration/). This is a configurable setting, and is enabled by default on new CloudFront distributions. IPv6 support extends to the use of WAF with CloudFront.
-	🐥**HTTP/2** is [now supported](https://aws.amazon.com/about-aws/whats-new/2016/09/amazon-cloudfront-now-supports-http2/)! Clients [must support TLS 1.2 and SNI](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesSupportedHTTPVersions).
-	While the most common use is for users to browse and download content (GET or HEAD methods) requests, CloudFront also supports ([since 2013](https://aws.amazon.com/blogs/aws/amazon-cloudfront-content-uploads-post-put-other-methods/)) uploaded data (POST, PUT, DELETE, OPTIONS, and PATCH).
	-	You must enable this by specifying the [allowed HTTP methods](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesAllowedHTTPMethods) when you create the distribution.
	-	Interestingly, the cost of accepting (uploaded) data [is usually less](https://aws.amazon.com/cloudfront/pricing/) than for sending (downloaded) data.
-	In its basic version, CloudFront [supports SSL](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/SecureConnections.html) via the [SNI extension to TLS](https://en.wikipedia.org/wiki/Server_Name_Indication), which is supported by all modern web browsers. If you need to support older browsers, you need to pay a few hundred dollars a month for dedicated IPs.
	-	💸⏱Consider invalidation needs carefully. CloudFront [does support invalidation](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Invalidation.html) of objects from edge locations, but this typically takes many minutes to propagate to edge locations, and costs $0.005 per request after the first 1000 requests. (Some other CDNs support this better.)
-	Everyone should use TLS nowadays if possible. [Ilya Grigorik’s table](https://istlsfastyet.com/#cdn-paas) offers a good summary of features regarding TLS performance features of CloudFront.
-	An alternative to invalidation that is often easier to manage, and instant, is to configure the distribution to [cache with query strings](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/QueryStringParameters.html) and then append unique query strings with versions onto assets that are updated frequently.
-	⏱For good web performance, it is recommended to [enable compression](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/ServingCompressedFiles.html) on CloudFront distributions if the origin is S3 or another source that does not already compress.

### CloudFront Gotchas and Limitations

-	🔸If using S3 as a backing store, remember that the endpoints for website hosting and for general S3 are different. Example: “bucketname.s3.amazonaws.com” is a standard S3 serving endpoint, but to have redirect and error page support, you need to use the website hosting endpoint listed for that bucket, e.g. “bucketname.s3-website-us-east-1.amazonaws.com” (or the appropriate region).
-	🔸By default, CloudFront will not forward HTTP Host: headers through to your origin servers. This can be problematic for your origin if you run multiple sites switched with host headers. You can [enable host header forwarding](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html#request-custom-headers-behavior) in the default cache behavior settings.
-	🔸4096-bit SSL certificates: CloudFront do not support 4096-bit SSL certificates as of late 2016. If you are using an externally issued SSL certificate, you’ll need to make sure it’s 2048 bits. See [ongoing discussion](https://forums.aws.amazon.com/thread.jspa?threadID=148783).
- Although connections from clients to CloudFront edge servers can make use of IPv6, [connections to the origin server will continue to use IPv4.](https://aws.amazon.com/about-aws/whats-new/2016/10/ipv6-support-for-cloudfront-waf-and-s3-transfer-acceleration/)

DirectConnect
-------------

### DirectConnect Basics

-	📒 [Homepage](https://aws.amazon.com/directconnect/) ∙ [User guide](http://docs.aws.amazon.com/directconnect/latest/UserGuide/) ∙ [FAQ](https://aws.amazon.com/directconnect/faqs/) ∙ [Pricing](https://aws.amazon.com/directconnect/pricing/)
-	**Direct Connect** is a private, dedicated connection from your network(s) to AWS.

### DirectConnect Tips

-	If your data center has [a partnering relationship](https://aws.amazon.com/directconnect/partners/) with AWS, setup is streamlined.
-	Use for more consistent predictable network performance guarantees (**1 Gbps** or **10 Gbps** per link).
-	Use to peer your colocation, corporate, or physical datacenter network with your VPC(s).
	-	Example: Extend corporate LDAP and/or Kerberos to EC2 instances running in a VPC.
	-	Example: Make services that are hosted outside of AWS for financial, regulatory, or legacy reasons callable from within a VPC.

Redshift
--------

### Redshift Basics

-	📒 [Homepage](https://aws.amazon.com/redshift/) ∙ [Developer guide](http://docs.aws.amazon.com/redshift/latest/dg/) ∙ [FAQ](https://aws.amazon.com/redshift/faqs/) ∙ [Pricing](https://aws.amazon.com/redshift/pricing/)
-	**Redshift** is AWS’ managed [data warehouse](https://en.wikipedia.org/wiki/Data_warehouse) solution, which is massively parallel, scalable, and columnar. It is very widely used. It [was built](https://en.wikipedia.org/wiki/Amazon_Redshift) using [ParAccel](https://en.wikipedia.org/wiki/ParAccel) technology and exposes [Postgres](https://en.wikipedia.org/wiki/PostgreSQL)-compatible interfaces.

### Redshift Alternatives and Lock-in

-	⛓🚪Whatever data warehouse you select, your business will likely be locked in for a long time. Also (and not coincidentally) the data warehouse market is highly fragmented. Selecting a data warehouse is a choice to be made carefully, with research and awareness of [the market landscape](https://www.datanami.com/2016/03/14/data-warehouse-market-ripe-disruption-gartner-says/) and what [business intelligence](https://en.wikipedia.org/wiki/Business_intelligence) tools you’ll be using.

### Redshift Tips

-	Although Redshift is mostly Postgres-compatible, its SQL dialect and performance profile are different.
-	Redshift supports only [12 primitive data types](https://docs.aws.amazon.com/redshift/latest/dg/c_Supported_data_types.html). ([List of unsupported Postgres types](https://docs.aws.amazon.com/redshift/latest/dg/c_unsupported-postgresql-datatypes.html)\)
-	It has a leader node and computation nodes (the leader node distributes queries to the computation ones). Note that some functions [can be executed only on the lead node.](https://docs.aws.amazon.com/redshift/latest/dg/c_SQL_functions_leader_node_only.html)
-	🔹Make sure to create a new [cluster parameter group](http://docs.aws.amazon.com/redshift/latest/mgmt/working-with-parameter-groups.html) and option group for your database since the default parameter group does not allow dynamic configuration changes.
-	Major third-party BI tools support Redshift integration (see [Quora](https://www.quora.com/Which-BI-visualisation-solution-goes-best-with-Redshift)).
-	[Top 10 Performance Tuning Techniques for Amazon Redshift](https://blogs.aws.amazon.com/bigdata/post/Tx31034QG0G3ED1/Top-10-Performance-Tuning-Techniques-for-Amazon-Redshift) provides an excellent list of performance tuning techniques.
-	[Amazon Redshift Utils](https://github.com/awslabs/amazon-redshift-utils) contains useful utilities, scripts and views to simplify Redshift ops.
-	[VACUUM](http://docs.aws.amazon.com/redshift/latest/dg/t_Reclaiming_storage_space202.html) regularly following a significant number of deletes or updates to reclaim space and improve query performance.
-	Avoid performing blanket [VACUUM](http://docs.aws.amazon.com/redshift/latest/dg/r_VACUUM_command.html) or [ANALYZE](http://docs.aws.amazon.com/redshift/latest/dg/r_ANALYZE.html) operations at a cluster level. The checks on each table to determine whether VACUUM or ANALYZE action needs to be taken is wasteful. Only perform ANALYZE and VACUUM commands on the objects that require it. Utilize the [Analyze & Vacuum Schema Utility](https://github.com/awslabs/amazon-redshift-utils/tree/master/src/AnalyzeVacuumUtility) to perform this work. The SQL to determine whether a table needs to be VACUUMed or ANALYZEd can be found in the [Schema Utility README](https://github.com/awslabs/amazon-redshift-utils/blob/master/src/AnalyzeVacuumUtility/README.md) if you wish to create your own maintenance process.
-	Redshift provides various [column compression](http://docs.aws.amazon.com/redshift/latest/dg/t_Compressing_data_on_disk.html) options to optimize the stored data size. AWS strongly encourages users to use [automatic compression](http://docs.aws.amazon.com/redshift/latest/dg/c_Loading_tables_auto_compress.html) at the [COPY](https://docs.aws.amazon.com/redshift/latest/dg/r_COPY.html) stage, when Redshift uses a sample of the data being ingested to analyze the column compression options. However, automatic compression can only be applied to an empty table with no data. Therefore, make sure the initial load batch is big enough to provide Redshift with a representative sample of the data (the default sample size is 100,000 rows).
-	Redshift uses columnar storage, hence it does not have indexing capabilities. You can, however, use [distribution key](http://docs.aws.amazon.com/redshift/latest/dg/c_best-practices-best-dist-key.html) and [sortkey](http://docs.aws.amazon.com/redshift/latest/dg/c_best-practices-sort-key.html) to improve performance. Redshift has two types of sort keys: compounding sort key and interleaved sort key.
-	A compound sort key is made up of all columns listed in the sort key definition. It is most useful when you have queries with operations using the prefix of the sortkey.
-	An interleaved sort key on the other hand gives equal weight to each column or a subset of columns in the sort key. So if you don't know ahead of time which column(s) you want to choose for sorting and filtering, this is a much better choice than the compound key. [Here](https://aws.amazon.com/blogs/aws/quickly-filter-data-in-amazon-redshift-using-interleaved-sorting/) is an example using interleaved sort key.
-	🔸⏱ **Distribution strategies:** Since data in Redshift is physically distributed among nodes, choosing the right data **distribution key** and [distribution style](http://docs.aws.amazon.com/redshift/latest/dg/c_choosing_dist_sort.html) is crucial for adequate query performance. There are three possible distribution style settings — **EVEN** (the default), **KEY**, or **ALL**. Use KEY to collocate join key columns for tables which are joined in queries. Use ALL to place the data in small-sized tables on all cluster nodes.

### Redshift Gotchas and Limitations

-	❗⏱While Redshift can handle heavy queries well, it does not scale horizontally, i.e. does not handle multiple queries in parallel. Therefore, if you expect a high parallel load, consider replicating or (if possible) sharding your data across multiple clusters.
-	🔸 The leader node, which manages communications with client programs and all communication with compute nodes, is the single point of failure.
-	⏱Although most Redshift queries parallelize well at the compute node level, certain stages are executed on the leader node, which can become the bottleneck.
-	🔹Redshift data commit transactions are very expensive and serialized at the cluster level. Therefore, consider grouping multiple mutation commands (COPY/INSERT/UPDATE) commands into a single transaction whenever possible.
-	🔹Redshift does not support multi-AZ deployments. Building multi-AZ clusters is not trivial. [Here](https://blogs.aws.amazon.com/bigdata/post/Tx13ZDHZANSX9UX/Building-Multi-AZ-or-Multi-Region-Amazon-Redshift-Clusters) is an example using Kinesis.
-	🔸Beware of storing multiple small tables in Redshift. The way Redshift tables are laid out on disk makes it impractical. The minimum space required to store a table (in MB) is nodes * slices/node * columns. For example, on a 16 node cluster an empty table with 20 columns will occupy 640MB on disk.
-	⏱ Query performance degrades significantly during data ingestion. [WLM (Workload Management)](http://docs.aws.amazon.com/redshift/latest/dg/c_workload_mngmt_classification.html) tweaks help to some extent. However, if you need consistent read performance, consider having replica clusters (at the extra cost) and swap them during update.
-	❗ Never resize a live cluster. The resize operation can take hours depending on the dataset size. In rare cases, the operation may also get stuck and you'll end up having a non-functional cluster. The safer approach is to create a new cluster from a snapshot, resize the new cluster and shut down the old one.
-	🔸Redshift has **reserved keywords** that are not present in Postgres (see full list [here](https://docs.aws.amazon.com/redshift/latest/dg/r_pg_keywords.html)). Watch out for DELTA ([Delta Encodings](https://docs.aws.amazon.com/redshift/latest/dg/c_Delta_encoding.html)).
-	🔸Redshift does not support many Postgres functions, most notably several date/time-related and aggregation functions. See the [full list here](https://docs.aws.amazon.com/redshift/latest/dg/c_unsupported-postgresql-functions.html).
-	🔸 Uniqueness, primary key, and foreign key constraints on Redshift tables are informational only and are not enforced. They are, however, used by the query optimizer to generate query plans. `NOT NULL` column constraints are enforced. See [here](https://docs.aws.amazon.com/redshift/latest/dg/t_Defining_constraints.html) for more information on defining constraints.
-	🔸Compression on sort key [can result in significant performance impact](https://aws.amazon.com/blogs/big-data/optimizing-for-star-schemas-and-interleaved-sorting-on-amazon-redshift/). So if your Redshift queries involving sort key(s) are slow, you might want to consider removing compression on a sort key.
-	🔹 [Choosing a sort key](http://docs.aws.amazon.com/redshift/latest/dg/t_Sorting_data.html) is very important since you can not change a table’s sort key after it is created. If you need to change the sort or distribution key of a table, you need to create a new table with the new key and move your data into it with a query like “insert into new_table select * from old_table”.
-	❗🚪 When moving data with a query that looks like “insert into x select from y”, you need to have twice as much disk space available as table “y” takes up on the cluster’s disks. Redshift first copies the data to disk and then to the new table. [Here](https://www.periscopedata.com/blog/changing-dist-and-sort-keys-in-redshift.html) is a good article on how to this for big tables.

EMR
---

### EMR Basics

-	📒 [Homepage](https://aws.amazon.com/emr/) ∙ [Release guide](http://docs.aws.amazon.com/ElasticMapReduce/latest/ReleaseGuide/) ∙ [FAQ](https://aws.amazon.com/emr/faqs/) ∙ [Pricing](https://aws.amazon.com/emr/pricing/)
-	**EMR** (which used to stand for Elastic Map Reduce, but not anymore, since it now extends beyond map-reduce) is a service that offers managed deployment of [Hadoop](https://en.wikipedia.org/wiki/Apache_Hadoop), [HBase](https://en.wikipedia.org/wiki/Apache_HBase) and [Spark](https://en.wikipedia.org/wiki/Apache_Spark). It reduces the management burden of setting up and maintaining these services yourself.

### EMR Alternatives and Lock-in

-	⛓Most of EMR is based on open source technology that you can in principle deploy yourself. However, the job workflows and much other tooling is AWS-specific. Migrating from EMR to your own clusters is possible but not always trivial.

### EMR Tips

-	EMR relies on many versions of Hadoop and other supporting software. Be sure to check [which versions are in use](https://docs.aws.amazon.com/ElasticMapReduce/latest/ReleaseGuide/emr-release-components.html).
-	⏱Off-the-shelf EMR and Hadoop can have significant overhead when compared with efficient processing on a single machine. If your data is small and performance matters, you may wish to consider alternatives, as [this post](http://aadrake.com/command-line-tools-can-be-235x-faster-than-your-hadoop-cluster.html) illustrates.
-	Python programmers may want to take a look at Yelp’s [mrjob](https://github.com/Yelp/mrjob).
-	It takes time to tune performance of EMR jobs, which is why third-party services such as [Qubole’s data service](https://www.qubole.com/mapreduce-as-a-service/) are gaining popularity as ways to improve performance or reduce costs.

### EMR Gotchas and Limitations

-	💸❗**EMR costs** can pile up quickly since it involves lots of instances, efficiency can be poor depending on cluster configuration and choice of workload, and accidents like hung jobs are costly. See the [section on EC2 cost management](#ec2-cost-management), especially the tips there about Spot instances. [This blog post](https://aws.amazon.com/blogs/big-data/strategies-for-reducing-your-amazon-emr-costs/) has additional tips, but was written prior to the shift to per-second billing.
-	💸 Beware of “double-dipping”. With EMR, you pay for the EC2 capacity and the service fees. In addition, EMR syncs task logs to S3, which means you pay for the storage and **PUT requests** at [S3 standard rates](https://aws.amazon.com/s3/pricing/#Request_Pricing). While the log files tend to be relatively small, every Hadoop job, depending on the size, generates thousands of log files that can quickly add up to thousands of dollars on the AWS bill. YARN’s [log aggregation](http://hortonworks.com/blog/simplifying-user-logs-management-and-access-in-yarn/) is not available on EMR.

Kinesis Streams
---

### Kinesis Streams Basics

-	📒 [Homepage](https://aws.amazon.com/kinesis/streams/) ∙ [Developer guide](https://docs.aws.amazon.com/streams/latest/dev/introduction.html) ∙ [FAQ](https://aws.amazon.com/kinesis/streams/faqs/) ∙ [Pricing](https://aws.amazon.com/kinesis/streams/pricing/)
-	**Kinesis Streams** (which used to be only called Kinesis, before Kinesis Firehose and Kinesis Analytics were launched) is a service that allows you to ingest high-throughput data streams for immediate or delayed processing by other AWS services.
- Kinesis Streams’ subcomponents are called [**shards**](https://docs.aws.amazon.com/streams/latest/dev/key-concepts.html). Each shard provides 1MB/s of write capacity and 2MB/s of read capacity at a maximum of 5 reads per second. A stream can have its shards programmatically increased or decreased based on a variety of metrics.
- All records entered into a Kinesis Stream are assigned a unique sequence number as they are captured. The records in a Stream are ordered by this number, so any time-ordering is preserved.
- [This page](http://docs.aws.amazon.com/streams/latest/dev/key-concepts.html) summarizes key terms and concepts for Kinesis Streams.

### Kinesis Streams Alternatives and Lock-in

-	🚪 Kinesis is most closely compared to [Apache Kafka](https://kafka.apache.org/), an open-source data ingestion solution. It is possible to set up a Kafka cluster hosted on [EC2 instances](#ec2) (or any other VPS), however you are responsible for managing and maintaining both Zookeeper and the Kafka brokers in a highly available configuration. Confluent has a good blog post with their recommendations on how to do this [here](http://www.confluent.io/blog/design-and-deployment-considerations-for-deploying-apache-kafka-on-aws/), which has links on the bottom to several other blogs they have written on the subject.
-	⛓ Kinesis uses very AWS-specific APIs, so you should be aware of the potential future costs of migrating away from it, should you choose to use it.
-	An application that efficiently uses Kinesis Streams will scale the number of shards up and down based on the required streaming capacity. (Note there is no direct equivalent to this with Apache Kafka.)


### Kinesis Streams Tips

-	The [KCL](https://docs.aws.amazon.com/streams/latest/dev/developing-consumers-with-kcl.html) (Kinesis Client Library) provides a skeleton interface for Java, Node, Python, Ruby and .NET programs to easily consume data from a Kinesis Stream. In order to start consuming data from a Stream, you only need to provide a config file to point at the correct Kinesis Stream, and functions for initialising the consumer, processing the records, and shutting down the consumer within the skeletons provided.
	- The KCL uses a DynamoDB table to keep track of which records have been processed by the KCL. This ensures that all records are processed “at least once”. It is up to the developer to ensure that the program can handle doubly-processed records.
	- The KCL also uses DynamoDB to keep track of other KCL “workers”. It automatically shares the available Kinesis Shards across all the workers as equally as possible.

### Kinesis Streams Gotchas and Limitations

- 🔸⏱  Kinesis Streams’ shards each only permit [5 reads per second](http://docs.aws.amazon.com/streams/latest/dev/service-sizes-and-limits.html). If you are evenly distributing data across many shards, your read limit for the Stream will remain at 5 reads per second on aggregate, as each consuming application will need to check every single shard for new records. This puts a hard limit on the number of different consuming applications possible per Stream for a given maximum read latency.
   - For example, if you have 5 consuming applications reading data from one Stream with any number of shards, they cannot read with a latency of less than one second, as each of the 5 consumers will need to poll *each shard* every second, reaching the cap of 5 reads per second per shard.
	- [This blog post](https://brandur.org/kinesis-in-production) further discusses the performance and limitations of Kinesis in production.
-	💸 **Kinesis Streams are not included in the free tier.** Make sure if you do any experimentation with it on a personal account, you shut down the stream or it may run up unexpected costs (~$11 per shard-month.)

Kinesis Firehose
---

### Kinesis Firehose Gotchas and Limitations

- 🔸 📜 When delivering from Firehose to Elasticsearch, the JSON document cannot contain an “_id” property. Firehose will not attempt to deliver those documents and won't log any error.


Device Farm
-----------

### Device Farm Basics

-	📒 [Homepage](https://aws.amazon.com/device-farm/) ∙ [Developer guide](http://docs.aws.amazon.com/devicefarm/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/device-farm/faq/) ∙ [Pricing](https://aws.amazon.com/device-farm/pricing/)
- **Device Farm** is an AWS service that enables mobile app testing on real devices.
- Supports iOS and Android (including Kindle Fire) devices, as well as the mobile web.
- Supports remote device access in order to allow for interactive testing/debugging.

### Device Farm Tips

- [AWS Mobile blog](https://aws.amazon.com/blogs/mobile/) contains several examples of Device Farm usage for testing.
- Device Farm offers a free trial for users who want to evaluate their service.
- Device Farm offers two pricing models: Paying **per device minute** is useful for small usage levels or for situations where it‘s hard to predict usage amount. **Unmetered plans** are useful in situations where active usage is expected from the beginning.
- To minimize waiting time for device availability, one approach is to create several device pools with different devices, then randomly choose one of the unused device pools on every run.

### Device Farm Gotchas and Limitations

- ❗Devices don't have a SIM card and therefore can‘t be used for testing SIM card-related features.
- 🔸Device Farm supports testing for most popular languages/frameworks, but not for all. An actual list of supported frameworks and languages is presented on [this page](http://docs.aws.amazon.com/devicefarm/latest/developerguide/test-types-overview.html).
- 🔸The API and CLI for Device Farm is quite a low level and may require developing additional tools or scripts on top of it.
- 🔸AWS provide several tools and plugins for Device Farm, however, it doesn‘t cover all cases or platforms. It may require developing specific tools or plugins to support specific requirements.
- ❗In general, Device Farm doesn‘t have Android devices from Chinese companies like Huawei, Meizu, Lenovo, etc. An actual list of supported devices located [here](https://aws.amazon.com/device-farm/device-list/).
- 🔸Device availibility is uneven. It depends on several factors including device popularity. Usually, more modern devices see higher demand, thus the waiting time for them will be higher compared to relatively old devices.

Mobile Hub
----------

### Mobile Hub Basics

* 📒 [Homepage](https://aws.amazon.com/mobile/) ∙ [User guide](https://docs.aws.amazon.com/mobile-hub/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/mobile/faqs/) ∙ [Pricing](https://aws.amazon.com/mobile/pricing/)
- **Mobile Hub** orchestrates multiple services to create an AWS backend for mobile and web applications.
- Each _project_ in Mobile Hub has one _backend_ made up of configurable features, plus one or more _applications_.
 - Features include Analytics, Cloud Logic, Conversational Bots, Hosting and Streaming, NoSQL Database, User Data Storage and User Sign-In. Each feature uses one or two services to deliver a chunk of functionality.
 - Services used include [API Gateway](#api-gateway), [CloudFront](#cloudfront), Cognito, [Device Farm](#device-farm), [DynamoDB](#dynamodb), [Lambda](#lambda), Lex, Pinpoint and [S3](#S3).
 - Application SDKs exist for Android (Java), iOS (Swift), Web (JS) and React Native (JS). There is also a CLI for JavaScript applications.

### Mobile Hub Tips
- The Mobile Hub [console](https://console.aws.amazon.com/mobilehub/home#/) has starter kits and tutorials for various app platforms.
- The CLI allows local development of Lambda code (JS by default) with `awsmobile {pull|push}` commands, to sync from cloud to folder, and back again.
- Mobile Hub itself is free, but each of the services has its own pricing model.

### Mobile Hub Gotchas and Limitations
- 🔸The Cloud API feature allows importing an existing Lambda function instead of defining a new one, but there are some rough edges with the CLI. Check the GitHub [issues](https://github.com/aws/awsmobile-cli/issues).
- ❗Mobile Hub uses CloudFormation under the covers, and gets confused when a service is changed outside of the Mobile Hub console.

IoT
---

### IoT Basics

* 	📒 [Homepage](https://aws.amazon.com/iot/) ∙ [User guide](https://docs.aws.amazon.com/iot/latest/developerguide/) ∙ [FAQ](https://aws.amazon.com/iot/faqs/) ∙ [Pricing](https://aws.amazon.com/iot/pricing/)
- 	**IoT** is a platform for allowing clients such as IoT devices or software applications ([examples](http://internetofthingswiki.com/iot-applications-examples/541/)) to communicate with the AWS cloud.
- 	Clients are also called **devices** (or **things**) and include a wide variety of device types.  Roughly there are three categories of device types that interact with IoT services by sending message over an IoT protocol to the IoT Pub/Sub-style message broker, which is called the IoT **Device Gateway**:
    * 	Send messages only: For example, the [AWS IoT Button](https://aws.amazon.com/iot/button/) on an [eddystone beacon](http://developer.estimote.com/eddystone/).
    * 	Send, receive, and process messages: For example, a simple processing board, such as a **Raspberry Pi** ([quick start guide](http://docs.aws.amazon.com/iot/latest/developerguide/iot-device-sdk-c.html)), or an Alexa device, such as the [Echo or Echo Dot](https://amazon.com/echo). These are designed to work with the [Alexa skills kit](https://developer.amazon.com/alexa-skills-kit), a programmable voice-enabled service.
- 	AWS has a useful [quick-start](http://docs.aws.amazon.com/iot/latest/developerguide/iot-gs.html) (using the Console) and a [slide presentation](http://www.slideshare.net/AmazonWebServices/connecting-to-aws-iot) on core topics.
* **IoT terms:**
    * 	AWS [**IoT Things**](http://docs.aws.amazon.com/iot/latest/developerguide/iot-thing-management.html) (metadata for devices in a [registry](http://docs.aws.amazon.com/iot/latest/developerguide/iot-thing-management.html)) and can store device state in a JSON document, which is called a [**device shadow**](http://docs.aws.amazon.com/iot/latest/developerguide/iot-thing-shadows.html).  Device metadata can also be stored in [**IoT Thing Types**](http://docs.aws.amazon.com/iot/latest/developerguide/thing-types.html). This aids in device metadata management by allowing for reuse of device description and configuration for more than one device.  Note that IoT Thing Types can be deprecated, but not changed — they are immutable.
    * 	AWS [**IoT Certificates**](http://docs.aws.amazon.com/iot/latest/developerguide/attach-cert-thing.html) (device authentication) are the logical association of a unique certificate to the logical representation of a device. This association can be done in the Console.  In addition, the public key of the certificate must be copied to the physical device. This covers the authentication of devices to a particular AWS Device Gateway (or message broker). You can associate an AWS IoT certificate with an IoT device or you can [register your own CA (Certificate Authority) with AWS](http://docs.aws.amazon.com/iot/latest/developerguide/device-certs-your-own.html), generate your own certificate(s) and associate those certificates with your devices via the AWS Console or cli.
    * 	AWS [**IoT Policies**](http://docs.aws.amazon.com/iot/latest/developerguide/authorization.html) (device/topic authorization) are JSON files that are associated to one or more AWS IoT certificates. This authorizes associated devices to publish and/or subscribe to messages from one or more MQTT topics.
    * 	AWS [**IoT Rules**](http://docs.aws.amazon.com/iot/latest/developerguide/iot-rules.html) are SQL-like queries which allows for reuse of some or all device message data, as described in [this presentation, which summarizes design patterns with for IoT Rules](http://www.slideshare.net/AmazonWebServices/programming-the-physical-world-with-device-shadows-and-rules-engine-66486454).
    * 	Shown below is a [diagram](https://aws.amazon.com/iot/how-it-works/) which summarizes the flow of messages between the AWS IoT services:

![How AWS IoT Works](https://d0.awsstatic.com/IoT/diagrams/awsiot-how-it-works_HowITWorks_1-26.png "How AWS IoT Works")

### IoT Greengrass

* 📒 [Homepage](https://aws.amazon.com/greengrass/)
* 🐥**Greengrass** is a software platform that extends AWS IoT capabilities allowing Lambda functions to be run directly on local devices.  It also enables IoT devices to be able to securely communicate on a local network without having to connect to the cloud.
    * Greengrass includes a local pub/sub message manager that can buffer messages if connectivity is lost so that inbound and outbound messages to the cloud are preserved. Locally deployed Lambda functions can be triggered by local events, messages from the cloud, or other sources.
    * Greengrass includes secure authentication and authorization of devices within the local network and also between the local network and the AWS cloud. It also provides secure, over-the-air software updates of Lambda functions.
*  Greengrass core software includes a message manager object, Lambda runtime, local copy service for IoT Thing (or device) shadows, and a deployment agent to manage Greengrass group configuration.
* **Greengrass groups** are containers for selected IoT devices settings, subscriptions and associated Lambda functions.  In a Greengrass group a device is either a Greengrass core or an IoT device which will be connected that particular Greengrass core.
* The Greengrass core SDK enables Lambda functions to interact with the AWS Greengrass core on which they run in order to publish messages, interact with the local Thing Shadows service, or invoke other deployed Lambda functions.
* The AWS Greengrass Core SDK only supports sending MQTT messages with QoS = 0.
* Shown below is a [diagram](http://docs.aws.amazon.com/greengrass/latest/developerguide/what-is-gg.html) which shows the architecture of AWS IoT Greengrass services:

![IoT Greengrass](http://docs.aws.amazon.com/greengrass/latest/developerguide/images/greengrass.png)


### IoT Alternatives and Lock-in

- 	AWS, Microsoft and Google have all introduced IoT-specific sets of cloud services since late 2015. AWS was first, moving their IoT services to [general availability](https://aws.amazon.com/blogs/aws/aws-iot-now-generally-available/) in Dec 2015. Microsoft released their set of IoT services for Azure in [Feb 2016](https://azure.microsoft.com/en-us/updates/generally-available-microsoft-azure-iot-hub/).  Google has only previewed, but not released their IoT services [Android Things](https://developer.android.com/things/index.html) and [Weave](https://developers.google.com/weave/).
- 	Issues of lock-in center around your devices —  [protocols](http://www.postscapes.com/internet-of-things-protocols/) (for example MQTT, AMQP), message formats (such as, JSON vs. Hex...) and security (certificates).

### IoT Tips

- 	**Getting started with Buttons:** One way to start is to use an [**AWS IoT Button**](https://aws.amazon.com/iot/button/).  AWS provides a number of code samples for use with their IoT Button, you can use the AWS IoT console, click the “connect AWS IoT button” link and you'll be taken to the  AWS Lambda console.  There you fill out your button’s serial number to associate it with a Lambda. (As of this writing, AWS IoT buttons are only available for sale in the US.)
- 	**Connections and protocols:** It is important to understand the details of about the devices you wish to connect to the AWS IoT service, including how you will secure the device connections, the device protocols, and more. Cloud vendors differ significantly in their support for common IoT protocols, such as MQTT, AMQP, XMPP. AWS IoT supports **secure MQTT**, **WebSockets** and **HTTPS**.
- 	Support for **device security** via certificate processing is a key differentiator in this space.  In August 2016, AWS added [just-in-time registrations](https://aws.amazon.com/blogs/iot/just-in-time-registration-of-device-certificates-on-aws-iot/) for IoT devices to their services.
- 	**Combining with other services:** It’s common to use other AWS services, such as AWS Lambda, Kinesis and DynamoDB, although this is by no means required.  Sample IoT application reference architectures are in this [screencast](https://www.youtube.com/watch?v=0Izh6ySpwb8/).
- 	**Testing tools:**
    *	To get started, AWS includes a lightweight MQTT client in the AWS IoT console. Here you can create and test sending and receiving messages to and from various MQTT topics.
    * 	When testing locally, if using MQTT, it may be helpful to download and use the open source [Mosquitto broker](https://mosquitto.org/download/) tool for local testing with devices and/or device simulators
    * 	Use this [MQTT load simulator](https://github.com/awslabs/aws-iot-mqtt-load-generator) to test device message load throughout your IoT solution.

### IoT Gotchas and Limitations

- 	🔸**IoT protocols:** It is important to verify the exact type of support for your particular IoT device message protocol. For example, one commonly used IoT protocol is [MQTT](https://www.ibm.com/developerworks/community/blogs/5things/entry/5_things_to_know_about_mqtt_the_protocol_for_internet_of_things?lang=en). Within MQTT there are [three possible levels of QoS in MQTT](https://dzone.com/articles/internet-things-mqtt-quality).  AWS IoT supports MQTT [QoS 0](http://docs.aws.amazon.com/iot/latest/developerguide/protocols.html) (fire and forget, or at most once) and QoS 1(at least once, or includes confirmation), but *not* QoS 2 (exactly once, requires 4-step confirmation).  This is important in understanding how much code you’ll need to write for your particular application message resolution needs.  Here is a [presentation about the nuances of connecting](http://www.slideshare.net/AmazonWebServices/overview-of-iot-infrastructure-and-connectivity-at-aws-getting-started-with-aws-iot).
- 	🔸The ecosystems to match **IAM users or roles** to **IoT policies** and their associated authorized AWS IoT devices are immature. Custom coding to enforce your security requirements is common.
- 	❗A common mistake is to misunderstand the importance of IoT **device** **security**.  It is imperative to associate *each* device with a unique certificate (public key). You can generate your own certificates and upload them to AWS, or you can use AWS generated IoT device certificates. It’s best to read and understand AWS’s own guidance on this [topic](http://www.slideshare.net/AmazonWebServices/best-practices-of-iot-in-the-cloud).
- 	🔸There is only one **AWS IoT Gateway** (endpoint) per AWS account. For production scenarios, you’ll probably need to set up multiple AWS accounts in order to separate device traffic for development, test and production. It’s interesting to note that the [Azure IoT Gateway](https://azure.microsoft.com/en-us/documentation/articles/iot-hub-protocol-gateway/) supports configuration of multiple endpoints, so that a single Azure account can be used with separate pub/sub endpoints for development, testing and production
- 	🔸**Limits:** Be aware of [limits](http://docs.aws.amazon.com/iot/latest/developerguide/iot-limits.html), including device message size, type, frequency, and number of AWS IoT rules.

### IoT Code Samples

- 	[Simple Beer Service](https://github.com/awslabs/simplebeerservice) is a surprisingly useful code example using AWS IoT, Lambda, etc.
- 	[IoT-elf](https://github.com/awslabs/aws-iot-elf) offers clean Python sample using the AWS IoT SDK.
- 	[IoT Button projects](https://www.hackster.io/AmazonWebServices/products/aws-iot-button) on Hackster include many different code samples for projects.
- 	[5 IoT code examples](https://github.com/awslabs/aws-iot-examples/): a device simulator, MQTT sample, just in time registration, truck simulator, prediction data simulator.
- 	[AWS Alexa trivia voice example](https://developer.amazon.com/public/community/post/TxDJWS16KUPVKO/New-Alexa-Skills-Kit-Template:-Build-a-Trivia-Skill-in-under-an-Hour) is a quick-start using Alexa voice capability and Lambda.
- 	Some Raspberry Pi examples include the [Beacon project](https://github.com/araobp/beacon/blob/master/README.md), [Danbo](https://libraries.io/github/awslabs/aws-iot-demo-for-danbo), and [GoPiGo](https://github.com/awslabs/aws-iotbot).

SES
---

### SES Basics

-	📒 [Homepage](https://aws.amazon.com/ses/) ∙ [Documentation](https://aws.amazon.com/documentation/ses/) ∙ [FAQ](https://aws.amazon.com/ses/faqs/) ∙ [Pricing](https://aws.amazon.com/ses/pricing/)
-	**SES** (or Simple Email Service) is a service that exposes SMTP endpoints for your application to directly integrate with.

### SES Tips

-	🔹**Bounce Handling:** Make sure you handle this early enough. Your ability to send emails can be removed if SES sees [too many bounces](http://docs.aws.amazon.com/ses/latest/DeveloperGuide/best-practices-bounces-complaints.html).
-	🔹**Credentials:** Many developers get confused between [SES credentials](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/using-credentials.html) and AWS API keys. Make sure to enter [SMTP credentials](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/smtp-credentials.html) while using the SMTP APIs.

### SES Gotchas and Limitations

-	🔸**Internet Access:** SES SMTP endpoints are on the Internet and will not be accessible from a location without Internet access (e.g. a private subnet without NAT gateway route in the routing table). In such a case, set up an SMTP relay instance in a subnet with Internet access and configure your application to send emails to this SMTP relay instance rather than SES. The relay should have a [forwarding rule to send all emails to SES](http://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-smtp-existing-server.html)). ❗If you are using a proxy instead of a NAT, confirm that your proxy service supports SMTP.

Certificate Manager
-------------------

### Certificate Manager Basics

- 📒 [Homepage](https://aws.amazon.com/certificate-manager/) ∙ [User guide](http://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html) ∙ [FAQ](https://aws.amazon.com/certificate-manager/faqs/) ∙ [Pricing](https://aws.amazon.com/certificate-manager/pricing/)
- Use the **Certificate Manager** to manage SSL/TLS certificates in other AWS services.
- Supports importing existing certificates as well as issuing new ones.
- Provides Domain Validated (DV) certificates. [Validation](http://docs.aws.amazon.com/acm/latest/userguide/gs-acm-validate.html) can be done in two ways. The first (and recommended) way is [via DNS](https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-validate-dns.html). If the zone lives within Route 53 and the user has access, the necessary record can be added in the console via a single click during the certificate request process. If the zone is not within Route 53 the user is required to update DNS manually. This is still preferred to the second way, which requires more user interaction, and is done by sending an email to 3 contact addresses in WHOIS and 5 common addresses for the domain, for each domain name present in the request.
- ACM will attempt to automatically [renew](http://docs.aws.amazon.com/acm/latest/userguide/how-domain-validation-works.html) a certificate issued by Amazon. It will first attempt to connect to the domain on HTTPS and check that the certificate used by the domain is the same with the certificate that it intends to renew. Failing that, it will check the DNS record used previously for validation. Failing that, ACM will attempt manual validation by sending emails to all domains in the certificate.

### Certificate Manager Alternatives and Lock-in

- ⛓Certificates issued by the Certificate Manager can’t be used outside of the services that support it. Imported certificates, however, can still be used elsewhere.

### Certificate Manager Tips

- 🔹**Supported services:** Managed [Load Balancers](#load-balancers), [CloudFront](#cloudfront), [API Gateway](#api-gateway) and [Elastic Beanstalk](https://aws.amazon.com/elasticbeanstalk/).
- 🔸During the domain validation process, if DNS validation is unsuccessful Certificate Manager will send an email to every contact address specified in the domain’s WHOIS record and up to five common administrative addresses. Some anti-spam filters can mark emails as spam because of this. You should check the spam folder of your email if you don’t receive a confirmation email.
- 🔹 Setting up a certificate for a test domain you don't have email set up on? You can now use DNS validation instead.
- 🔹Remember when requesting a wildcard domain that the request will not be valid for the level just below the wildcard, or any subdomains preceding the wildcard. Take for example an approved, issued certificate for `*.bar.example.com`. This would be valid for `foo.bar.example.com` but not `bar.example.com`. Likewise it would also not be valid for `www.bar.foo.example.com`. You would need to add each of these domains to the certificate request.

### Certificate Manager Gotchas and Limitations

- 🔸In order to use **Certificate Manager** for CloudFront distributions, the certificate must be issued or imported from us-east-1 (N. Virginia) region.
- 🔸Certificates used with Elastic Load Balancers must be issued in the same region as the load balancer. Certificates can not be moved or copied between regions, as of July 2017. If a domain uses load balancers present in multiple regions, a different certificate must be requested for each region.
- 🔸**IoT** has its [own way](http://docs.aws.amazon.com/iot/latest/developerguide/create-device-certificate.html) of setting up certificates.
- 🔸By default the maximum number of domains per certificate is 10. You can get this limit increased to a maximum of 100 by contacting AWS support. **Note** for every different domain you have on the requested cert, you'll need to press accept on an email sent to that domain. For example if you request a cert with 42 different domains or sub domains, you'll need to press accept on 42 different links.
	- 🔹If you request a limit increase to AWS support for this, they will respond to you asking to confirm this. Bypass this by saying in the body of your initial request:
```"I acknowledge at the moment, there is no method to add or remove a name from a certificate. Instead, you must request a new certificate with the revised namelist and you must then re-approve all of the names in the certificate, even if they'd been previously approved."```
- 🔸There is no way at the moment to add or remove a domain to/from an existing certificate. You must request a new certificate and re-approve it from each of the domains requested.

WAF
-------------------

### WAF Basics

-	📒 [Homepage](https://aws.amazon.com/waf/) ∙ [Documentation](https://aws.amazon.com/documentation/waf/) ∙ [FAQ](https://aws.amazon.com/waf/faq/) ∙ [Pricing](https://aws.amazon.com/waf/pricing)
- WAF (Web Application Firewall) is used in conjunction with the CloudFront and ALB services to inspect and block/allow web requests based on user-configurable conditions.
- HTTPS and HTTP requests are supported with this service.
- WAF's strength is in detecting malicious activity based on pattern-matching inputs for attacks such as SQL injections, XSS, etc.
- WAF supports inspection of requests [received through both IPv6 and IPv4](https://aws.amazon.com/about-aws/whats-new/2016/10/ipv6-support-for-cloudfront-waf-and-s3-transfer-acceleration/).

### WAF Tips

- Getting a WAF API call history can be done through CloudTrail. This is enabled through the CloudTrail console.
- It's also possible to get [full
  logs of all the web requests inspected](https://aws.amazon.com/about-aws/whats-new/2018/08/aws-waf-launches-new-comprehensive-logging-functionality/)

### WAF Gotchas and Limitations

- As of May 2019, AWS WAF is  available on Amazon CloudFront and in 12 commercial AWS regions: US East (N. Virginia), US East (Ohio), US West (Oregon), US West (N. California), EU (Ireland), EU (Frankfurt), EU (London), EU (Stockholm), Asia Pacific (Tokyo), Asia Pacific (Sydney), Asia Pacific (Singapore), and Asia Pacific (Seoul).


OpsWorks
-------------------

### OpsWorks Basics

-	📒 [Homepage](https://aws.amazon.com/opsworks/) ∙ [Documentation](https://aws.amazon.com/documentation/opsworks/) ∙ [FAQ](https://aws.amazon.com/opsworks/faqs/) ∙ Pricing: [Stacks](https://aws.amazon.com/opsworks/stacks/pricing/), [Chef Automate](https://aws.amazon.com/opsworks/chefautomate/pricing/), [Puppet Enterprise](https://aws.amazon.com/opsworks/puppetenterprise/pricing/)
- OpsWorks is a configuration management service that uses [Chef](https://www.chef.io/chef/) or [Puppet](https://www.puppet.com) configuration management. It is broken out into three different services:
  - [OpsWorks Stacks](https://aws.amazon.com/opsworks/stacks/): The service lets you configure and launch stacks specific to your application's needs, and allows you to automate application deployments. Chef runs can be performed manually via the Execute Cookbooks command, otherwise they are only run as part of lifecycle events.
    - OpsWorks Stacks differs from standard configuration management services in that it also allows you to perform some infrastructure and application automation (such as creating Amazon EC2 instances and deploying applications via Chef cookbooks).
  - [OpsWorks for Chef Automate](https://aws.amazon.com/opsworks/chefautomate/): This service launches a dedicated Chef Automate server in your account, which can be used to associate nodes, upload cookbook code, and configure systems. Automated patching, backups, OS updates, and minor Chef version upgrades are provided as part of the service. An AWS API is provided for associating/disassociating nodes. Chef runs can be scheduled on nodes using the [chef-client cookbook](https://supermarket.chef.io/cookbooks/chef-client).
  - [OpsWorks for Puppet Enterprise](https://aws.amazon.com/opsworks/puppetenterprise/): This service launches a dedicated Puppet Master in your account, which can be used to associate nodes, upload modules, and configure systems. Automated patching, backups, OS updates, and minor Puppet version upgrades are provided as part of the service. An AWS API is provided for associating/disassociating nodes. By default, the Puppet agent will run automatically every 30 minutes on associated nodes.
- OpsWorks for Chef Automate and OpsWorks for Puppet Enterprise are strictly designed for configuration management, and do not provision infrastructure outside the Chef Server/Puppet Master that is created in our account.
- All three OpsWorks services support managing both Amazon EC2 and on-premises infrastructure, however the implementation details differ slightly.
  - OpsWorks Stacks allows you to register instances and install the OpsWorks Agent to connect to your stack.
  - OpsWorks for Chef Automate and OpsWorks for Puppet Enterprise allow you to associate new or existing infrastructure using either the opsworks-cm:AssociateNode API action or the vendor-supported method for associating nodes to Chef Server or Puppet Enterprise.
- Although OpsWorks will let you work with common Chef recipes or Puppet modules when creating your stacks, creating custom recipes will require familiarity with Chef or Puppet syntax. Chef/Puppet code is not supported as part of AWS Support.
- As of December 2016, OpsWorks Stacks supports Chef versions [12, 11.10.4, 11.4.4 and 0.9.15.5](http://docs.aws.amazon.com/opsworks/latest/userguide/workingcookbook.html).
- As of December 2016, OpsWorks for Chef Automate uses [Chef Server version 12.11.1](http://docs.aws.amazon.com/opsworks/latest/userguide/welcome_opscm.html) This is the current stable version of Chef.
- [Berkshelf](http://docs.aws.amazon.com/opsworks/latest/userguide/workingcookbook-chef11-10.html#workingcookbook-chef11-10-berkshelf)can be used  with Chef stacks of version 11.10 and later for managing cookbooks and their respective dependencies. However, on Chef 12.x stacks, Berkshelf must be installed by the stack administrator.
- Running your own Chef environment may be an alternative to consider - some considerations are listed [in this Bitlancer article.](http://www.bitlancer.com/blog/2015/10/05/opsworks-vs-chef.html)

### OpsWorks Alternatives and Lock-in

- Major competitors in Configuration Management include:
  - [Chef](https://chef.io)
  - [Puppet](https://puppet.com)
  - [Ansible](https://www.ansible.com).

### OpsWorks Tips

- OpsWorks Stacks and OpsWorks for Chef Automate use Chef cookbooks for configuration. Chef provides free training to learn syntax, best practices, etc. at [https://learn.chef.io](https://learn.chef.io).
- OpsWorks for Puppet Enterprise uses Puppet manifests for configuration. Puppet provides a very useful learning VM for download at [https://learn.puppet.com/](https://learn.puppet.com/).

### OpsWorks Gotchas and Limitations

- OpsWorks Stacks is not available in the following regions:
  - Montreal
  - GovCloud
  - Beijing
- OpsWorks for Chef Automate and OpsWorks for Puppet Enterprise are not available in the following regions:
  - Montreal
  - Sao Paulo
  - GovCloud
  - London
  - Paris
  - Seoul
  - Mumbai

Batch
-------------------

### Batch Basics

-	📒 [Homepage](https://aws.amazon.com/batch/) ∙ [Documentation](https://aws.amazon.com/documentation/batch/) ∙ [FAQ](https://aws.amazon.com/batch/faqs/) ∙ [Pricing](https://aws.amazon.com/batch/pricing/)
- **AWS Batch** is a service that offers an environment to run batch computing jobs. The service dynamically provisions the optimal compute resources needed by the jobs based on their resource requirements, and can scale up to hundreds of thousands of [jobs](http://docs.aws.amazon.com/batch/latest/userguide/jobs.html).
- These batch workloads have access to all other AWS services and features.
- AWS Batch, coupled with [spot instances](https://aws.amazon.com/blogs/compute/cost-effective-batch-processing-with-amazon-ec2-spot/) can help run the jobs when appropriate capacity is available, providing for optimal utilization of compute resources.
- The batch workloads are built as a [Docker](https://www.docker.com/) Image. These images can then pushed to the [EC2 Container Registry](https://aws.amazon.com/ecr/) (ECR), or any private repository that can be accessed from AWS.
- A [Job Definition](http://docs.aws.amazon.com/batch/latest/userguide/job_definitions.html) has the workload's Docker Image URI, and also lets the users specify the environment details like vCPUs, memory, volume mappings, environment variables, parameters, retry strategy, container properties, and the job's IAM role.
- The [Compute Environments](http://docs.aws.amazon.com/batch/latest/userguide/compute_environments.html) are EC2 clusters that provide the runtime for the batch workloads to execute in.
- AWS Batch provides managed, as well as unmanaged compute environments. The Managed Environments are provisioned and managed by AWS, while the Unmanaged Environments are managed by the customers.
- The Job Definitions are submitted to [Job Queue(s)](http://docs.aws.amazon.com/batch/latest/userguide/job_queues.html) for execution. Each queue has a priority, and has at least one Compute Environment associated with it.
- AWS Batch uses [ECS](https://aws.amazon.com/ecs/) to execute the containerized jobs.

### Batch Tips

- AWS Batch supports prioritization of jobs via the Job Queue Priority. Higher the number - higher the priority.
- AWS Batch supports launching the Compute Environment into specific VPC and subnets.
- A Compute Environment is same as an [ECS Cluster](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_clusters.html).
- There is no additional cost for AWS Batch. You only pay the cost associated with the AWS Services being used - like EC2 Instances and any resources consumed by the batch jobs.
- Associate [IAM Roles and policies](http://docs.aws.amazon.com/batch/latest/userguide/IAM_policies.html) with the Compute Environment to enable the containers access to other AWS resources.
- 🔹 Use Unmanaged Compute Environments if you need specialized resources like Dedicated Hosts, or [EFS](https://aws.amazon.com/efs/).

SQS
-------------------

### SQS Basics

- 📒  [_Homepage_](https://aws.amazon.com/sqs/) ∙ [_Documentation_](https://aws.amazon.com/documentation/sqs/) ∙ [_FAQ_](https://aws.amazon.com/sqs/faqs/) ∙ [_Pricing_ ](https://aws.amazon.com/sqs/pricing/)
- SQS is a highly scalable, fully managed message queuing service from AWS.
- SQS supports the pull model, where the producers *queue* the messages, and the consumers pull messages off the queue.
- SQS provides a message visibility timeout, during which the message being processed will not be delivered to other consumers. If the consumer does not delete the message after processing, the message becomes available to other consumers upon reaching the message visibility timeout. This parameter is called VisibilityTimeout.
- Each message can have up to 10 custom fields, or attributes.
- SQS allows producers to set up to 15 minutes of delay before the messages are delivered to the consumers. This parameter is called DelaySeconds.
- There are two types of queues supported by SQS -
    - Standard Queues
        - Guarantee **at least once** delivery of the messages.
        - Do not retain the order of delivery of the messages.
    - FIFO Queues
        - Guarantee **only once** delivery of the messages
        - Guarantee the order of the delivery of the messages
- SQS supports fine grained access to various API calls and Queues via IAM policies.
- The messages that fail to process can be put in a dead letter queue.

### SQS Alternatives and Lock-In

- Alternatives to SQS include [Kafka](https://kafka.apache.org/), [RabbitMQ](https://www.rabbitmq.com/), [ActiveMQ](http://activemq.apache.org/) and others.
- Google Cloud Platform has Pub/Sub, and Azure has Azure Queue Service.
- [SQS vs SNS](#sns-alternatives-and-lock-in)

### SQS Tips

- SNS can be used in combination of SQS to build a “fan out” mechanism by having an SQS Queue subscribe to the SNS topic.
- SQS supports encryption using AWS KMS.
- Cloudwatch alarms can be creating using [various SQS metrics](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/sqs-metricscollected.html) to trigger autoscaling actions and/or notifications.

### SQS Gotchas and Limitations

- 🔸 SQS does not have a VPC endpoint (unlike S3 and DynamoDB), so SQS will need to be accessed using public SQS API endpoints.
- 🔸 FIFO Queues are limited to 300 API calls per second.
- 🔸 FIFO Queues cannot subscribe to an SNS topic.
- 🔸 Standard Queues can deliver duplicate messages regardless of the visibility window. If only-once delivery is your only choice, then use FIFO queues, or build an additional layer to de-dupe the messages.
- 🔸 You can send/receive messages in batch, however, there can only be maximum of 10 messages in a batch.


SNS
---------------------

### SNS Basics

- 📒  [_Homepage_](https://aws.amazon.com/sns/) ∙ [_Documentation_](https://aws.amazon.com/documentation/sns/) ∙ [_FAQ_](https://aws.amazon.com/sns/faqs/) ∙ [_Pricing_](https://aws.amazon.com/sns/pricing/)
- **SNS** (Simple Notification Service) is a pub/sub based, highly scalable, and fully managed messaging service that can also be used for mobile notifications.
- SNS can push the messages down to the subscribers via [SMS](http://docs.aws.amazon.com/sns/latest/dg/SMSMessages.html), [Email](http://docs.aws.amazon.com/sns/latest/dg/SubscribeTopic.html), [SQS](http://docs.aws.amazon.com/sns/latest/dg/SendMessageToSQS.html), and [HTTP/S](http://docs.aws.amazon.com/sns/latest/dg/SendMessageToHttp.html) transport protocols.
- Producers publish messages to a SNS Topics, which can have many subscribers.
- Each subscription has an associated [protocol](http://docs.aws.amazon.com/sns/latest/api/API_Subscribe.html), which is used to notify the subscriber.
- A copy of the message is sent to each subscriber using the associated protocol.
- SNS can also [invoke lambda functions](http://docs.aws.amazon.com/sns/latest/dg/sns-lambda.html).

### SNS Alternatives and Lock-In

- Popular alternatives to SNS are [Kafka](https://kafka.apache.org/), [Notification Hubs](https://azure.microsoft.com/en-us/services/notification-hubs/) on Azure, and [Pub/Sub](https://cloud.google.com/pubsub/docs/overview) on Google Cloud.
- **SNS vs SQS:**
    - Both SNS and SQS are highly scalable, fully managed messaging services provided by AWS.
    - SQS supports a *pull* model, while SNS supports a *push* model. Consumers have to pull messages from an SQS Queue, while they're pushed the message from an SNS Topic.
    - An SQS message is intended to be processed by only one subscriber, while SNS topics can have many subscribers.
    - After processing, the SQS message is deleted from the queue by the subscriber to avoid being re-processed.
    - An SNS message is *pushed* to all subscribers of the topic at the same time, and is not available for deletion at the topic.
    - SNS supports multiple transport protocols of delivery of the messages to the subscribers, while SQS subscribers have to pull the messages off the queue over HTTPS.

### SNS Tips

- [Fan-out](http://docs.aws.amazon.com/sns/latest/dg/SNS_Scenarios.html) architecture can be achieved by having multiple subscribers for a topic. This is particularly useful when events have to be fanned out to multiple, isolated systems.
- SNS topics can be used to power [webhooks](https://en.wikipedia.org/wiki/Webhook) with [backoff support](http://docs.aws.amazon.com/sns/latest/dg/DeliveryPolicies.html) to subscribers over HTTP/S.
- [SQS queues](http://docs.aws.amazon.com/sns/latest/dg/SendMessageToSQS.html) can subscribe to SNS topics.
- SNS is used to manage notifications for other AWS services like [Autoscaling Groups](http://docs.aws.amazon.com/autoscaling/latest/userguide/ASGettingNotifications.html)' notifications, [CloudWatch Alarms](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/US_SetupSNS.html), etc.
- SNS is frequently used as “glue” between disparate systems— such as GitHub and AWS services.

### SNS Gotchas and Limitations

- 🔸 HTTP/S subscribers of SNS topics need to have public endpoints, as SNS does not support calling private endpoints (like those in a private subnet within a VPC).
- 📜 In a fan-out scenario, [SSE-enabled SQS](http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-server-side-encryption.html) subscribers of an SNS topic [will not receive](https://lobster1234.github.io/2017/10/14/fan-out-with-sns-and-sqs-gotcha/) the messages sent to the topic.

High Availability
-----------------

This section covers tips and information on achieving [high availability](https://en.wikipedia.org/wiki/High_availability).



### High Availability Tips

-	AWS offers two levels of redundancy, [regions and availability zones (AZs)](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-regions-availability-zones).
-	When used correctly, regions and zones do allow for high availability. You may want to use non-AWS providers for larger business risk mitigation (i.e. not tying your company to one vendor), but reliability of AWS across regions is very high.
-	**Multiple regions:** Using multiple regions is complex, since it’s essentially like managing completely separate infrastructures. It is necessary for business-critical services with the highest levels of redundancy. However, for many applications (like your average consumer startup), deploying extensive redundancy across regions may be overkill.
-	The [High Scalability Blog](http://highscalability.com/blog/2016/1/11/a-beginners-guide-to-scaling-to-11-million-users-on-amazons.html) has a good guide to help you understand when you need to scale an application to multiple regions.
-	🔹**Multiple AZs:** Using AZs wisely is the primary tool for high availability!
	-	A typical single-region high availability architecture would be to deploy in two or more availability zones, with load balancing in front, as in [this AWS diagram](http://media.amazonwebservices.com/architecturecenter/AWS_ac_ra_ftha_04.pdf).
	-	The bulk of outages in AWS services affect one zone only. There have been rare outages affecting multiple zones simultaneously (for example, the [great EBS failure of 2011](http://aws.amazon.com/message/65648/)) but in general most customers’ outages are due to using only a single AZ for some infrastructure.
	-	Consequently, design your architecture to minimize the impact of AZ outages, especially single-zone outages.
	-	Deploy key infrastructure across at least two or three AZs. Replicating a single resource across more than three zones often won’t make sense if you have other backup mechanisms in place, like S3 snapshots.
	-	A second or third AZ should significantly improve availability, but additional reliability of 4 or more AZs may not justify the costs or complexity (unless you have other reasons like capacity or Spot market prices).
	-	💸Watch out for **cross-AZ traffic costs**. This can be an unpleasant surprise in architectures with large volume of traffic crossing AZ boundaries.
	-	Deploy instances evenly across all available AZs, so that only a minimal fraction of your capacity is lost in case of an AZ outage.
	-	If your architecture has single points of failure, put all of them into a single AZ. This may seem counter-intuitive, but it minimizes the likelihood of any one SPOF to go down on an outage of a single AZ.
-	**EBS vs instance storage:** For a number of years, EBSs had a poorer track record for availability than instance storage. For systems where individual instances can be killed and restarted easily, instance storage with sufficient redundancy could give higher availability overall. EBS has improved, and modern instance types (since 2015) are now EBS-only, so this approach, while helpful at one time, may be increasingly archaic.
-	Be sure to [use and understand CLBs/ALBs](#load-balancers) appropriately. Many outages are due to not using load balancers, or misunderstanding or misconfiguring them.

### High Availability Gotchas and Limitations

-	🔸**AZ naming** differs from one customer account to the next. Your “us-west-1a” is not the same as another customer’s “us-west-1a” — the letters are assigned to physical AZs randomly per account. This can also be a gotcha if you have multiple AWS accounts. Note that Zone IDs are consistent between accounts, and can be used to reliably align between AWS accounts.
-	🔸💸**Cross-AZ traffic** is not free. At large scale, the costs add up to a significant amount of money. If possible, optimize your traffic to stay within the same AZ as much as possible.

Billing and Cost Management
---------------------------

### Billing and Cost Visibility

-	AWS offers a [**free tier**](https://aws.amazon.com/free/) of service, that allows very limited usage of resources at no cost. For example, a micro instance and small amount of storage is available for no charge. Many services are only eligible for the free tier for the first twelve months that an account exists, but other services offer a free usage tier indefinitely. (If you have an old account but starting fresh, sign up for a new one to qualify for the free tier.) [AWS Activate](https://aws.amazon.com/activate/) extends this to tens of thousands of dollars of free credits to startups in [certain funds or accelerators](https://aws.amazon.com/activate/portfolio-detail/).
-	You can set [**billing alerts**](http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/free-tier-alarms.html) to be notified of unexpected costs, such as costs exceeding the free tier. You can set these in a [granular way](https://wblinks.com/notes/aws-tips-i-wish-id-known-before-i-started/#billing).
-	AWS offers [Cost Explorer](http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-explorer-what-is.html), a tool to get better visibility into costs.
-	Unfortunately, the AWS console and billing tools are rarely enough to give good visibility into costs. For large accounts, the AWS billing console can time out or be too slow to use.
-	**Tools:**
	-	🔹Enable [billing reports](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/detailed-billing-reports.html) and install an open source tool to help manage or monitor AWS resource utilization. [**Teevity Ice**](https://github.com/Teevity/ice) (originally written by Netflix) is probably the first one you should try. Check out [docker-ice](https://github.com/jonbrouse/docker-ice) for a Dockerized version that eases installation.
	-	🔸One challenge with Ice is that it doesn’t cover amortized cost of reserved instances.
	-	Other tools include [Security Monkey](https://github.com/Netflix/security_monkey) and [Cloud Custodian](https://github.com/capitalone/cloud-custodian).
	-	Use [AWS Simple Monthly Calculator](https://calculator.s3.amazonaws.com/index.html) to get an estimate of usage charges for AWS services based on certain information you provide. Monthly charges will be based on your actual usage of AWS services, and may vary from the estimates the Calculator has provided.
-	**Third-party services:** Several companies offer services designed to help you gain insights into expenses or lower your AWS bill, such as [Cloudability](https://www.cloudability.com/), [CloudHealth Technologies](https://www.cloudhealthtech.com/), and [ParkMyCloud](http://www.parkmycloud.com/). Some of these charge a percentage of your bill, which may be expensive. See the [market landscape](#tools-and-services-market-landscape).
-	AWS’s [Trusted Advisor](https://aws.amazon.com/premiumsupport/trustedadvisor/) is another service that can help with cost concerns.
-	Don’t be shy about asking your account manager for guidance in reducing your bill. It’s their job to keep you happily using AWS.
-	**Tagging for cost visibility:** As the infrastructure grows, a key part of managing costs is understanding where they lie. It’s strongly advisable to [tag resources](https://aws.amazon.com/blogs/aws/resource-groups-and-tagging/), and as complexity grows, group them effectively. If you [set up billing allocation appropriately](http://aws.amazon.com/blogs/aws/aws-cost-allocation/), you can then get visibility into expenses according to organization, product, individual engineer, or any other way that is helpful.
-	If you need to do custom analysis of raw billing data or want to feed it to a third party cost analysis service, [enable](http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/detailed-billing-reports.html#turnonreports) the [detailed billing report](http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/detailed-billing-reports.html#detailed-billing-report) feature.
-	Multiple Amazon accounts can be linked for billing purposes using the [Consolidated Billing](http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/consolidated-billing.html) feature. Large enterprises may need complex billing structures depending on ownership and approval processes.
-	Multiple Amazon accounts can be managed centrally using [AWS Organizations](https://aws.amazon.com/organizations/).

### AWS Data Transfer Costs

-	For deployments that involve significant network traffic, a large fraction of AWS expenses are around data transfer. Furthermore, costs of data transfer, within AZs, within regions, between regions, and into and out of AWS and the internet vary significantly depending on deployment choices.
-	Some of the most common gotchas:
	-	🔸*AZ-to-AZ traffic:* Note EC2 traffic between AZs is effectively the same as between regions. For example, deploying a Cassandra cluster across AZs is helpful for [high availability](#high-availability), but can hurt on network costs.
	-	🔸*Using public IPs when not necessary:* If you use an Elastic IP or public IP address of an EC2 instance, you will incur network costs, even if it is accessed locally within the AZ.
	-	🔸*Managed NAT Gateway data processing:* Managed NAT Gateways are used to let traffic egress from private subnets--at a cost of 4.5¢ as a data processing fee layered on top of data transfer pricing. Past a certain point, running your own NAT instances becomes far more cost effective.
	-	🔸*Some services do cross-AZ traffic for free:* Many AWS services you'd not consider on their own merits offer a hidden value of free cross-AZ data transfer. EFS, RDS, MSK, and others are examples of this.
-	This figure gives an overview:

![AWS Data Transfer Costs](figures/aws-data-transfer-costs.png)

### EC2 Cost Management

-	With EC2, there is a trade-off between engineering effort (more analysis, more tools, more complex architectures) and spend rate on AWS. If your EC2 costs are small, many of the efforts here are not worth the engineering time required to make them work. But once you know your costs will be growing in excess of an engineer’s salary, serious investment is often worthwhile.
-	Larger instances aren’t necessarily priced higher in the spot market – therefore, you should look at the available options and determine which instances will be most cost effective for your jobs. See [Bid Advisor](https://aws.amazon.com/ec2/spot/bid-advisor/).
-	🔹**Spot instances:**
	-	EC2 [Spot instances](https://aws.amazon.com/ec2/spot/) are a way to get EC2 resources at significant discount — often many times cheaper than standard on-demand prices — if you’re willing to accept the possibility that they be terminated with little to no warning.
	-	Use Spot instances for potentially very significant discounts whenever you can use resources that may be restarted and don’t maintain long-term state.
	-	The huge savings that you can get with Spot come at the cost of a significant increase in complexity when provisioning and reasoning about the availability of compute capacity.
	-	Amazon maintains Spot prices at a market-driven fluctuating level, based on their inventory of unused capacity. Prices are typically low but can [spike](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-limits.html#spot-bid-limit) very high. See the [price history](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances-history.html) to get a sense for this.
	-	You set a bid price high to indicate how high you’re willing to pay, but you only pay the going rate, not the bid rate. If the market rate exceeds the bid, your instance may be terminated.
	-	Prices are per instance type and per availability zone. The same instance type may have wildly different price in different zones at the same time. Different instance types can have very different prices, even for similarly powered instance types in the same zone.
	-	Compare prices across instance types for better deals.
	-	Use Spot instances whenever possible. Setting a high bid price will assure your machines stay up the vast majority of the time, at a fraction of the price of normal instances.
	-	Get notified up to two minutes before price-triggered shutdown by polling [your Spot instances’ metadata](https://aws.amazon.com/blogs/aws/new-ec2-spot-instance-termination-notices/), or by watching for [the termination CloudWatch event](https://aws.amazon.com/about-aws/whats-new/2018/01/amazon-ec2-spot-two-minute-warning-is-now-available-via-amazon-cloudwatch-events/).
	-	Make sure your usage profile works well for Spot before investing heavily in tools to manage a particular configuration.
-	**Spot fleet:**
	-	You can realize even bigger cost reductions at the same time as improvements to fleet stability relative to regular Spot usage by using [Spot fleet](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-fleet.html) to bid on instances across instance types, availability zones, and (through multiple Spot Fleet Requests) regions.
	-	Spot fleet targets maintaining a specified (and weighted-by-instance-type) total capacity across a cluster of servers. If the Spot price of one instance type and availability zone combination rises above the weighted bid, it will rotate running instances out and bring up new ones of another type and location up in order to maintain the target capacity without going over target cluster cost.
-	**Spot usage best practices:**
	-	**Application profiling:**
		-	Profile your application to figure out its runtime characteristics. That would help give an understanding of the minimum cpu, memory, disk required. Having this information is critical before you try to optimize spot costs.
		-	Once you know the minimum application requirements, instead of resorting to fixed instance types, you can bid across a variety of instance types (that gives you higher chances of getting a spot instance to run your application).E.g., If you know that 4 cpu cores are enough for your job, you can choose any instance type that is equal or above 4 cores and that has the least Spot price based on history. This helps you bid for instances with greater discount (less demand at that point).
	-	**Spot price monitoring and intelligence:**
		-	Spot Instance prices fluctuate depending on instance types, time of day, region and availability zone. The AWS CLI tools and API allow you to describe Spot price metadata given time, instance type, and region/AZ.
		-	Based on history of Spot instance prices, you could potentially build a myriad of algorithms that would help you to pick an instance type in a way that **optimizes cost**, **maximizes availability**, or **offers predictable performance**.
		-	You can also track the number of times an instance of certain type got taken away (out bid) and plot that in graphite to improve your algorithm based on time of day.
	-	**Spot machine resource utilization:**
		-	For running spiky workloads (spark, map reduce jobs) that are schedule based and where failure is non critical, Spot instances become the perfect candidates.
		-	The time it takes to satisfy a Spot instance could vary between 2-10 mins depending on the type of instance and availability of machines in that AZ.
		-	If you are running an infrastructure with hundreds of jobs of spiky nature, it is advisable to start pooling instances to optimize for cost, performance and most importantly time to acquire an instance.
		-	Pooling implies creating and maintaining Spot instances so that they do not get terminated after use. This promotes re-use of Spot instances across jobs. This of course comes with the overhead of lifecycle management.
		-	Pooling has its own set of metrics that can be tracked to optimize resource utilization, efficiency and cost.
		-	Typical pooling implementations give anywhere between 45-60% cost optimizations and 40% reduction in spot instance creation time.
		-	An excellent example of Pooling implementation described by Netflix ([part1](http://techblog.netflix.com/2015/09/creating-your-own-ec2-spot-market.html), [part2](http://techblog.netflix.com/2015/11/creating-your-own-ec2-spot-market-part-2.html)\)
-	**Spot management gotchas**
	-	🔸**Lifetime:** There is [no guarantee](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html) for the lifetime of a Spot instance. It is purely based on bidding. If anyone outbids your price, the instance is taken away. Spot is not suitable for time sensitive jobs that have strong SLA. Instances will fail based on demand for Spot at that time. AWS provides a [two-minute warning](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html#spot-instance-termination-notices) before Amazon EC2 must terminate your Spot instance.
	-	🔹**API return data:** - The Spot price API returns Spot prices of varying granularity depending on the time range specified in the api call.E.g If the last 10 min worth of history is requested, the data is more fine grained. If the last 2 day worth of history is requested, the data is more coarser. Do not assume you will get all the data points. There **will** be skipped intervals.
	-	❗**Lifecycle management:** Do not attempt any fancy Spot management unless absolutely necessary. If your entire usage is only a few machines and your cost is acceptable and your failure rate is lower, do not attempt to optimize. The pain for building/maintaining it is not worth just a few hundred dollar savings.
-	**Reserved Instances:** allow you to get significant discounts on EC2 compute hours in return for a commitment to pay for instance hours of a specific instance type in a specific AWS region and availability zone for a pre-established time frame (1 or 3 years). Further discounts can be realized through “partial” or “all upfront” payment options.
	-	Consider using Reserved Instances when you can predict your longer-term compute needs and need a stronger guarantee of compute availability and continuity than the (typically cheaper) Spot market can provide. However be aware that if your architecture changes your computing needs may change as well so long term contracts can seem attractive but may turn out to be cumbersome.
	-	There are two types of Reserved Instances - [Standard and Convertible](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/reserved-instances-types.html). If you purchase excess Standard Reserved Instances, you may offer to “sell back” unused Reserved Instances via the [Reserved Instance Marketplace](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ri-market-selling-guide.html), this allows you to potentially recoup the cost of unused EC2 compute instance hours by selling them to other AWS customers.
	-	Instance reservations are not tied to specific EC2 instances - they are applied at the billing level to eligible compute hours as they are consumed across all of the instances in an account.
	-	📜There have been scattered reports of Convertible RI purchases needing to be exercised in a block-- namely, if you buy five convertible RIs in one purchase, you can't convert just two of them. Reach out to your account manager for clarification if this may impact you.
-	If you have multiple AWS accounts and have configured them to roll charges up to one account using the “Consolidated Billing” feature, you can expect *unused* Reserved Instance hours from one account to be applied to matching (region, availability zone, instance type) compute hours from another account.
-	If you have multiple AWS accounts that are linked with Consolidated Billing, plan on using reservations, and want unused reservation capacity to be able to apply to compute hours from other accounts, you’ll need to create your instances in the availability zone with the same *name* across accounts. Keep in mind that when you have done this, your instances may not end up in the same *physical* data center across accounts - Amazon shuffles availability zones names across accounts in order to equalize resource utilization.
-	Make use of dynamic [Auto Scaling](#auto-scaling), where possible, in order to better match your cluster size (and cost) to the current resource requirements of your service.
-	If you use RHEL instances and happen to have existing RHEL on-premise Red Hat subscriptions, then you can leverage Red Hat's [Cloud Access program](https://www.redhat.com/en/technologies/cloud-computing/cloud-access) to migrate a portion of your on-premise subscriptions to AWS, and thereby saving on AWS charges for RHEL subscriptions. You can either use your own self-created RHEL AMI's or Red Hat provided [Gold Images](https://access.redhat.com/articles/2962171) that will be added to your private AMI's once you sign up for Red Hat Cloud Access.

Further Reading
---------------

This section covers a few unusually useful or “must know about” resources or lists.

-	AWS
	-	[AWS In Plain English](https://www.expeditedssl.com/aws-in-plain-english): A readable overview of all the AWS services.
	-	[Awesome AWS](https://github.com/donnemartin/awesome-aws): A curated list of AWS tools and software.
	-	[AWS Tips I Wish I'd Known Before I Started](https://wblinks.com/notes/aws-tips-i-wish-id-known-before-i-started/): A list of tips from [Rich Adams](https://richadams.me/)
	-	[AWS Whitepapers](https://aws.amazon.com/whitepapers/): A list of technical AWS whitepapers, covering topics such as architecture, security and economics.
	-	[Last Week in AWS](https://lastweekinaws.com): A weekly email newsletter covering the latest happenings in the AWS ecosystem.
	-	[AWS Geek](https://www.awsgeek.com): A blog by AWS Community Hero Jerry Hargrove, with notes and hand-drawn diagrams about various AWS services.
-	Books
	-	[Amazon Web Services in Action](https://www.manning.com/books/amazon-web-services-in-action)
	-	[AWS Lambda in Action](https://www.manning.com/books/aws-lambda-in-action)
	-	[Serverless Architectures on AWS](https://www.manning.com/books/serverless-architectures-on-aws)
	-	[Serverless Single Page Apps](https://pragprog.com/book/brapps/serverless-single-page-apps)
	-	[The Terraform Book](https://terraformbook.com/)
	-	[AWS Scripted 2 book series](https://www.amazon.com/gp/product/B016QBB0GO?ref=series_rw_dp_labf)
	-	[Amazon Web Services For Dummies](https://www.amazon.com/dp/1118571835)
	-	[AWS System Administration](http://shop.oreilly.com/product/0636920027638.do)
	-	[Python and AWS Cookbook](http://shop.oreilly.com/product/0636920020202.do)
	-	[Resilience and Reliability on AWS](http://shop.oreilly.com/product/0636920026839.do)
	-	[AWS documentation as Kindle ebooks](https://www.amazon.com/Amazon-Web-Services/e/B007R6MVQ6)
-	General references
	-	[AWS Well Architected Framework Guide](https://d0.awsstatic.com/whitepapers/architecture/AWS_Well-Architected_Framework.pdf): Amazon’s own 56 page guide to operational excellence - guidelines and checklists to validate baseline security, reliability, performance (including high availability) and cost optimization practices.
	-	[Awesome Microservices](https://github.com/mfornos/awesome-microservices): A curated list of tools and technologies for microservice architectures. Worth browsing to learn about popular open source projects.
	-	[Is it fast yet?](https://istlsfastyet.com/): Ilya Grigorik’s TLS performance overview
	-	[High Performance Browser Networking](https://hpbn.co/): A full, modern book on web network performance; a presentation on the HTTP/2 portion is [here](https://docs.google.com/presentation/d/1r7QXGYOLCh4fcUq0jDdDwKJWNqWK1o4xMtYpKZCJYjM/edit?usp=sharing).

Disclaimer
----------

The authors and contributors to this content cannot guarantee the validity of the information found here. Please make sure that you understand that the information provided here is being provided freely, and that no kind of agreement or contract is created between you and any persons associated with this content or project. The authors and contributors do not assume and hereby disclaim any liability to any party for any loss, damage, or disruption caused by errors or omissions in the information contained in, associated with, or linked from this content, whether such errors or omissions result from negligence, accident, or any other cause.

License
-------

[![Creative Commons License](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)

This work is licensed under a [Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/).

AT&T has an ampersand in their name.

AT&amp;T is another way to write it.

This & that.

4 < 5.

6 > 5.

Here's a [link] [1] with an ampersand in the URL.

Here's a link with an amersand in the link text: [AT&T] [2].

Here's an inline [link](/script?foo=1&bar=2).

Here's an inline [link](</script?foo=1&bar=2>).


[1]: http://example.com/?foo=1&bar=2
[2]: http://att.com/  "AT&T"
<http:/

<https:/ 

<mailto:foobarbaz>

<http:/google

<foo@
hello world
<http://example.com>

hello world
<mailto:somename@example.com>
Link: <http://example.com/>.

Link to an email: [somename@example.com](mailto:somename@example.com).

Link without protocol, which should not render as an auto-link
because they are easily mistaken for HTML: [google.com](google.com).
<https://example.com/_index_.html>

<https://example.com/*index*.html>

<https://example.com/__index__.html>

<https://example.com/**index**.html>

<https://example.com/*******index*******.html>

<https://example.com/~~index~~.html>

<https://example.com/`index`.html>

<https://example.com/[index].html>

<mailto:_somename_@example.com>

<mailto:**somename**@example.com>

<mailto:`somename`@example.com>
http://<example

https:// foo bar baz.

mailto:.

http://,

https://:

mailto:;

http://"

https://'

mailto:)

http://]
This should be a link: http://example.com/hello-world.

Also, subdomain should be a part of the link (http://foo.example.com/(hello[world])).

So should this: mailto:foo@bar.com.

And even with underscore http://domain.org/this_is_good.

All links should work http://a.b, https://c.d, http://e.f, https://g.h.
Link: <http://example.com/>.

Link to an email: <somename@example.com>.

Link to an email: <mailto:somename@example.com>.

With an ampersand: <http://example.com/?foo=1&bar=2>

* In a list?
* <http://example.com/>
* It should.

> Blockquoted: <http://example.com/>

Auto-links should not occur here: `<http://example.com/>`

	or here: <http://example.com/>
These should all get escaped:

Backslash: \\

Backtick: \`

Asterisk: \*

Underscore: \_

Left brace: \{

Right brace: \}

Left bracket: \[

Right bracket: \]

Left paren: \(

Right paren: \)

Greater-than: \>

Hash: \#

Period: \.

Bang: \!

Plus: \+

Minus: \-

**GFM:**

Pipe: \|

Tilde: \~

**Commonmark:**

Quote: \"

Dollar: \$

Percentage: \%

Ampersand: \&

Single quote: \'

Comma: \,

Forward slash: \/

Colon: \:

Semicolon: \;

Less-than: \<

Equals: \=

Question mark: \?

At-sign: \@

Caret: \^

New line: \
only works in paragraphs.

These should not, because they occur within a code block:

	Backslash: \\

	Backtick: \`

	Asterisk: \*

	Underscore: \_

	Left brace: \{

	Right brace: \}

	Left bracket: \[

	Right bracket: \]

	Left paren: \(

	Right paren: \)

	Greater-than: \>

	Hash: \#

	Period: \.

	Bang: \!

	Plus: \+

	Minus: \-

**GFM:**

	Pipe: \|

	Tilde: \~

**Commonmark:**

	Quote: \"

	Dollar: \$

	Percentage: \%

	Ampersand: \&

	Single quote: \'

	Comma: \,

	Forward slash: \/

	Colon: \:

	Semicolon: \;

	Less-than: \<

	Equals: \=

	Question mark: \?

	At-sign: \@

	Caret: \^

	New line: \
	only works in paragraphs.


Nor should these, which occur in code spans:

Backslash: `\\`

Backtick: `` \` ``

Asterisk: `\*`

Underscore: `\_`

Left brace: `\{`

Right brace: `\}`

Left bracket: `\[`

Right bracket: `\]`

Left paren: `\(`

Right paren: `\)`

Greater-than: `\>`

Hash: `\#`

Period: `\.`

Bang: `\!`

Plus: `\+`

Minus: `\-`

**GFM:**

Pipe: `\|`

Tilde: `\~`

**Commonmark:**

Quote: `\"`

Dollar: `\$`

Percentage: `\%`

Ampersand: `\&`

Single quote: `\'`

Comma: `\,`

Forward slash: `\/`

Colon: `\:`

Semicolon: `\;`

Less-than: `\<`

Equals: `\=`

Question mark: `\?`

At-sign: `\@`

Caret: `\^`

New line: `\
` only works in paragraphs.

These should get escaped, even though they're matching pairs for
other Markdown constructs:

\*asterisks\*

\_underscores\_

\`backticks\`

This is a code span with a literal backslash-backtick sequence: `` \` ``

This is a tag with unescaped backticks <span attr='`ticks`'>bar</span>.

This is a tag with backslashes <span attr='\\backslashes\\'>bar</span>.
*   Different lists should receive two newline characters
    between them.


*   This is another list.

>  *   The same goes for lists in block quotes.
>
>
>  *   This is another list.

*   And for lists in lists:

    1.   First sublist.


    1.   Second sublist.

And for lists followed by indented code blocks:

*   This is a paragraph in a list


    And this is code();
   > bar
 > baz
>     foo
    bar
> ```
> aNormalCodeBlockInABlockqoute();
> ```

A paragraph.

> ```
thisIsAlsoSomeCodeInABlockquote();
> ```

A paragraph.

> ```
aNonTerminatedCodeBlockInABlockquote();
```
aNewCodeBlockFollowingTheBlockQuote();
```

A paragraph.

> Something in a blockquote.
```
aNewCodeBlock();
```
> This is a blockquote.
- And in normal mode this is an internal list, but in commonmark this is a top level list.
> This is a blockquote. Followed by a rule.
* * *
This fails in markdown.pl and upskirt:

* hello
  > world
> Note there is no space on the following line.
>
> Note there is no space on the preceding line.
> Example:
> 
>     sub status {
>         print "working";
>     }
> 
> Or:
> 
>     sub status {
>         return "working";
>     }
> This is a blockquote.

> This is, in commonmark mode and gfm mode, another blockquote.
﻿# Hello from a BOM

Be careful when editing this file!
These are not breaks:

Look at the
pretty line
breaks.

These are breaks:

Look at the  
pretty line  
breaks.

In `commonmark: true` mode, an escaped newline character is exposed as a `break` node:

Look at the\
pretty line\
breaks.
[hi]

[HI]: /url
Fenced code blocks are normally not exdented, however,
when the initial fence is indented by spaces, the value of
the code is exdented by up to that amount of spaces.

```
    This is a code block...
        
    ...which is not exdented.
```

But...

  ```
    This one...
        
    ...is.
  ```

And...

 ```
So is this...
       
   ...one.
 ```
GitHub, thus RedCarpet, has a bug where “nested” fenced code blocks,
even with shorter fences, can exit their actual “parent” block.

Note: not any more! <https://github.com/remarkjs/remark/issues/323>.

Note that this bug does not occur on indented code-blocks.

````foo
```bar
baz
```
````

Even with a different fence marker:

````foo
~~~bar
baz
~~~
````

And reversed:

~~~~foo
~~~bar
baz
~~~
~~~~

~~~~foo
```bar
baz
```
~~~~
Ticks:

```javascript
alert('Hello World!');
```
Tildes:

~~~javascript
alert('Hello World!');
~~~
A code block using fences:

```
alert('Hello World!');
```
A code block NOT using fences:

    alert('Hello World!');
	code block on the first line
	
Regular text.

    code block indented by spaces

Regular text.

	the lines in this block  
	all contain trailing spaces  

Regular Text.

	code block on the last line
Markdown strips regular whitespaces: `   hello   `
Including tabs: `	hello	`
However it preserves non-breaking whitespaces: `   hello   `
`<test a="` content of attribute `">`

Fix for backticks within HTML tag: <span attr='`ticks`'>like this</span>

Here's how you put `` `backticks` `` in a code span.

Empty code spans are not supported: ``.

Here’s an example, `` foo ` bar  ``.

And here, ` `` `.

``
// this is also inline code
``

So is this `foo   bar
  baz`.

And this `foo `` bar`

And `this\`but this is text`.

Whitespace only: ` `.

Whitespace only: `    `.

Whitespace only: `
`.
> hello
> [1]: hello

* * *

> hello
[2]: hello


* hello
* [3]: hello


* hello
[4]: hello


> foo
> bar
[1]: foo
> bar
[alpha][1], [bravo][2].

* Definition in list:

  [1]: alpha

> Definition in blockquote:
>
> [2]: bravo
[baz]: /url (
)

[foo]: /url "
"

[bar]: /url '
'
[baz]: /url (foo
bar)

[baz]: /url "foo
bar"

[baz]: /url 'foo
bar'

[baz]: /url 'foo
[baz]: /url (there

[foo]: /url "there

[bar]: /url 'there

[baz]: url (

[foo]: url "

[bar]: /url '

[baz]: <url>(

[foo]: <url>"

[bar]: <url>'[foo]:

[bar]: </url

[foo]:[baz]: http://www.example.com?param=1&region=here
hello ~~hi~~ world
<p>Already linked: <a href="http://example.com/">http://example.com/</a>.</p>

Already linked: [http://example.com/](http://example.com/).

Already linked: <a href="http://example.com/">**http://example.com/**</a>.
Hello ** ** world.

Hello __	__ world.

Hello *	* world.

Hello _	_ world.
*bar\*

**bar\**

_bar\_

__bar\__
These words should_not_be_emphasized.
*emphasis*.

__strong__.
_emphasis_.

**strong**.
> However, &MadeUpEntities; are kept in the document.

> Entities even work in the language flag of fenced code blocks:

> ```some&copylanguage
> alert('Hello');
> ```

> And in an auto-link: <http://example&copyxample.com>

> Foo and bar and http://example&copyxample.com and baz.

> Or in [l&copynks](
>   ~/some&copyfile "in some pl&copyce")

> Or in [l&copylnks](
>   <~/some&copyfile>
>   "in some pl&copyce")

> Or in ![
>   l&copynks
> ](
>   ~/some&copyfile "in some pl&copyce")

***

> Or in ![l&copylnks](
>   <~/some&copyfile>
>   "in some pl&copyce")

> Or in ![
>   l&copynks
> ][12]

> [1]: http://example&copyxample.com "in some
> pl&copyce"

> [
>   1
> ]: http://example&copyxample.com "in some
> pl&copyce"

***

> But, entities are not interpreted in `inline c&oumlde`, or in
> code blocks:

>     C&OumlDE block.
# Entities

Plain&nbsp;text:

AT&amp;T with entity, AT&amp;T with numeric entity, AT&amp;T without entity.

Fenced code language flags:

```AT&amp;T
Something in the AT&amp;T language
```

```AT&amp;T
Something in the AT&#x26;T language
```

Automatic links:

<http://at&amp;t.com>, <http://at&amp;t.com>, and <http://at&amp;t.com>.

Link `href`:

[With entity](http://at&amp;t.com), [numeric entity](http://at&amp;t.com), [without entity](http://at&amp;t.com).

Link `title`:

[With entity](http://att.com "AT&amp;T"), [numeric entity](http://att.com "AT&amp;T"), [without entity](http://example.com "AT&amp;T").

Image `src`:

![With entity](http://at&amp;t.com/fav.ico), ![numeric entity](http://at&amp;t.com/fav.ico), ![without entity](http://at&amp;t.com/fav.ico).

Image `alt`:

![AT&amp;T with entity](http://att.com/fav.ico), ![AT&amp;T with numeric entity](http://att.com/fav.ico), ![AT&amp;T without entity](http://att.com/fav.ico).

Image `title`:

![With entity](http://att.com/fav.ico "AT&amp;T"), ![numeric entity](http://att.com/fav.ico "AT&amp;T"), ![without entity](http://att.com/fav.ico "AT&amp;T").

Image Reference `alt`:

![AT&amp;T with entity][favicon], ![AT&amp;T with numeric entity][favicon], ![AT&amp;T without entity][favicon].

[favicon]: http://att.com/fav.ico "ATT favicon"

Shortcut and collapsed references:

[foo&bar], [foo&bar][], [foo&amp;bar], [foo&amp;bar][].

[foo&bar]: http://example.com

[foo&amp;bar]: http://example.com
# Entities

Plain text:

AT&amp;T with entity, AT&amp;T with numeric entity, AT&amp;T without entity.

Fenced code language flags:

```AT&amp;T
Something in the AT&amp;T language
```

```AT&amp;T
Something in the AT&#x26;T language
```

Automatic links:

<http://at&amp;t.com>, <http://at&amp;t.com>, and <http://at&amp;t.com>.

Link `href`:

[With entity](http://at&amp;t.com), [numeric entity](http://at&amp;t.com), [without entity](http://at&amp;t.com).

Link `title`:

[With entity](http://att.com "AT&amp;T"), [numeric entity](http://att.com "AT&amp;T"), [without entity](http://example.com "AT&amp;T").

Image `src`:

![With entity](http://at&amp;t.com/fav.ico), ![numeric entity](http://at&amp;t.com/fav.ico), ![without entity](http://at&amp;t.com/fav.ico).

Image `alt`:

![AT&amp;T with entity](http://att.com/fav.ico), ![AT&amp;T with numeric entity](http://att.com/fav.ico), ![AT&amp;T without entity](http://att.com/fav.ico).

Image `title`:

![With entity](http://att.com/fav.ico "AT&amp;T"), ![numeric entity](http://att.com/fav.ico "AT&amp;T"), ![without entity](http://att.com/fav.ico "AT&amp;T").

Image Reference `alt`:

![AT&amp;T with entity][favicon], ![AT&amp;T with numeric entity][favicon], ![AT&amp;T without entity][favicon].

[favicon]: http://att.com/fav.ico "ATT favicon"

Shortcut and collapsed references:

[foo&bar], [foo&bar][], [foo&amp;bar], [foo&amp;bar][].

[foo&bar]: http://example.com

[foo&amp;bar]: http://example.com
# Entities

Plain&#xA0;text:

AT&#x26;T with entity, AT&#x26;T with numeric entity, AT&#x26;T without entity.

Fenced code language flags:

```AT&#x26;T
Something in the AT&amp;T language
```

```AT&#x26;T
Something in the AT&#x26;T language
```

Automatic links:

<http://at&#x26;t.com>, <http://at&#x26;t.com>, and <http://at&#x26;t.com>.

Link `href`:

[With entity](http://at&#x26;t.com), [numeric entity](http://at&#x26;t.com), [without entity](http://at&#x26;t.com).

Link `title`:

[With entity](http://att.com "AT&#x26;T"), [numeric entity](http://att.com "AT&#x26;T"), [without entity](http://example.com "AT&#x26;T").

Image `src`:

![With entity](http://at&#x26;t.com/fav.ico), ![numeric entity](http://at&#x26;t.com/fav.ico), ![without entity](http://at&#x26;t.com/fav.ico).

Image `alt`:

![AT&#x26;T with entity](http://att.com/fav.ico), ![AT&#x26;T with numeric entity](http://att.com/fav.ico), ![AT&#x26;T without entity](http://att.com/fav.ico).

Image `title`:

![With entity](http://att.com/fav.ico "AT&#x26;T"), ![numeric entity](http://att.com/fav.ico "AT&#x26;T"), ![without entity](http://att.com/fav.ico "AT&#x26;T").

Image Reference `alt`:

![AT&#x26;T with entity][favicon], ![AT&#x26;T with numeric entity][favicon], ![AT&#x26;T without entity][favicon].

[favicon]: http://att.com/fav.ico "ATT favicon"

Shortcut and collapsed references:

[foo&bar], [foo&bar][], [foo&amp;bar], [foo&amp;bar][].

[foo&bar]: http://example.com

[foo&amp;bar]: http://example.com
# Entities

Plain text:

AT&T with entity, AT&T with numeric entity, AT&T without entity.

Fenced code language flags:

```AT&T
Something in the AT&amp;T language
```

```AT&T
Something in the AT&#x26;T language
```

Automatic links:

<http://at&t.com>, <http://at&t.com>, and <http://at&t.com>.

Link `href`:

[With entity](http://at&t.com), [numeric entity](http://at&t.com), [without entity](http://at&t.com).

Link `title`:

[With entity](http://att.com "AT&T"), [numeric entity](http://att.com "AT&T"), [without entity](http://example.com "AT&T").

Image `src`:

![With entity](http://at&t.com/fav.ico), ![numeric entity](http://at&t.com/fav.ico), ![without entity](http://at&t.com/fav.ico).

Image `alt`:

![AT&T with entity](http://att.com/fav.ico), ![AT&T with numeric entity](http://att.com/fav.ico), ![AT&T without entity](http://att.com/fav.ico).

Image `title`:

![With entity](http://att.com/fav.ico "AT&T"), ![numeric entity](http://att.com/fav.ico "AT&T"), ![without entity](http://att.com/fav.ico "AT&T").

Image Reference `alt`:

![AT&T with entity][favicon], ![AT&T with numeric entity][favicon], ![AT&T without entity][favicon].

[favicon]: http://att.com/fav.ico "ATT favicon"

Shortcut and collapsed references:

[foo&bar], [foo&bar][], [foo&amp;bar], [foo&amp;bar][].

[foo&bar]: http://example.com

[foo&amp;bar]: http://example.com
Lots of entities are supported in mdast: &nbsp;, &amp;, &copy;, &AElig;,
&Dcaron;, &frac34;, &HilbertSpace;, &DifferentialD;,
&ClockwiseContourIntegral;, &c.  Even some entities with a missing
terminal semicolon are parsed correctly (as per the HTML5 spec):
&yuml, &aacute, &copy, and &amp.

However, &MadeUpEntities; are kept in the document.

Entities even work in the language flag of fenced code blocks:

```some&mdash;language
alert('Hello');
```

Or in [l&iacute;nks](~/some&mdash;file "in some pl&aelig;ce")

Or in ![&iacute;mages](~/an&ndash;image.png "&copy Someone")

But, entities are not interpreted in `inline c&ouml;de`, or in
code blocks:

	C&Ouml;DE block.
\>
Normal with language tag:

```js
```

With white space:

``` bash
```

With very long fences:

``````
``````

With nothing:

```
```
Normal with language tag:

```js this is an info string
```

With white space:

``` bash info
```

With curly braces:

``````lang{info}
``````

With nothing:

```
```

With several streaks of white space:

``` bash info string
```

With tabs as white space:

``` bash		info
```

With spaces as white space:

``` bash  info
```
If the info string comes after a backtick fence, it may not contain any backtick
characters.
The reason for this restriction is that otherwise some inline code would be
incorrectly interpreted as the beginning of a fenced code block.

Tildes in info strings are fine:

```js filename=~/.bashrc
console.log(1)
```

Tildes in info strings are fine after tilde fences:

~~~js filename=~/.bashrc
console.log(1)
~~~

Backticks in info strings are fine after tilde fences:

~~~js title=`.bashrc`
console.log(1)
~~~

Backticks in info strings are **not** fine after backtick fences:

```js title=`.bashrc`
console.log(1)
```
Initial:

```


123
```

Final:

```
123


```

Both:

```


123


```
```\\\[awd
dwa
```
```
``` aaa
```
```js
foo();
```bash
```
``` js 
foo();
```

~~~~~ bash	
echo "hello, ${WORLD}"
~~~~~
``` js
var a = 'hello';
console.log(a + ' world');
```

~~~bash
echo "hello, ${WORLD}"
~~~

```````longfence
Q: What do you call a tall person who sells stolen goods?
```````

~~~~~~~~~~  ManyTildes
A longfence!
~~~~~~~~~~
In Markdown 1.0.0 and earlier. Version
8. This line turns into a list item.
Because a hard-wrapped line in the
123. middle of a paragraph looked like a
list item.

Here's one with a bullet.
* criminey.

Non-GFM does not create a list for either.
GFM does not create a list for `8.`, but does for `*`.
CommonMark creates a list for both.
All versions create lists for the following.

* Here's one with a bullet.
  * criminey.

...and the following:

1. In Markdown 1.0.0 and earlier. Version
   8. This line turns into a list item.
# Foo # 

## Bar ##	
# #

##

### ###

####

##### #####

######
# awd#
## dwa###
> A blockquote
with some more text.

A normal paragraph.

> A blockquote followed by a horizontal rule (in CommonMark).
---

> A heading in a blockquote
> ---
Hello
World
===
#This is not a heading, per CommonMark: <http://spec.commonmark.org/0.17/#example-25>

Kramdown (GitHub) neither supports unspaced ATX-headings.

######## h7?

######### h8?

########## h9?

More than six # characters is not a heading: <http://spec.commonmark.org/0.26/#example-33>
  Heading 1
=========

   Heading 2
---------

Both these headings caused positional problems in on commit daa344c and before.
# Heading 1 #

## Heading 2 ##

### Heading 4 ###

#### Heading 4 ####

##### Heading 5 #####

###### Heading 6 ######
Heading 1
=========

Heading 2
---------

### Heading 4

#### Heading 4

##### Heading 5

###### Heading 6
***
---
___

The three asterisks are not a Setext header.

This is a paragraph.
***

This is another paragraph.
___

But this is a secondary heading.
---

---
Dashes:

---

 ---
 
  ---

   ---

	---

- - -

 - - -
 
  - - -

   - - -

	- - -


Asterisks:

***

 ***
 
  ***

   ***

	***

* * *

 * * *
 
  * * *

   * * *

	* * *


Underscores:

___

 ___
 
  ___

   ___

    ___

_ _ _

 _ _ _
 
  _ _ _

   _ _ _

    _ _ _
* hello world
* how are
* * *
you today?


The above asterisks do split the list, but the below ones do not.


- hello world
- how are
- * * *
you today?


+ Neither do these
+ how are
+ * *
you today?


- But these do
- how are
- - - -
you today?
***
* * * * *
- - -
* * *
_ _ _
Simple block on one line:

<div>foo</div>

And nested without indentation:

<div>
<div>
<div>
foo
</div>
<div style=">"/>
</div>
<div>bar</div>
</div>
# Block-level

<article foo="bar 'baz' qux" foo='bar "baz" qux' foo=baz>


<article foo>


<article>


<article :foo:bar:09:="baz">


<article foo.bar_09->


<article foo.bar_09-   >


<article foo.bar_09-   />


<div baz
qux

# Inline

<span foo="bar 'baz' qux" foo='bar "baz" qux' foo=baz>


<span foo>


<span>


<span :foo:bar:09:="baz">


<span foo.bar_09->


<span foo.bar_09-   >


<span foo.bar_09-   />


<span this is
invalid
<![CDATA[
fooBarBaz()
]]>

foo <![CDATA[bar]]>
Paragraph one.

<!-- This is a simple comment -->

<!--
	This is another comment.
-->

What follows is not an HTML comment because it contains
two consecutive dashes:
<https://html.spec.whatwg.org/multipage/syntax.html#comments>.

<!-- one comment block -- -- with two comments -->

But this is fine (in commonmark):

<!-- one comment block - with a dash -->

And, this is wrong (in commonmark):

<!-->-->

The end.
<!DOCTYPE html>

foo <!BAR br BAZ>

<!doctype html>

<!valid >

<!invalid>
 <div>
  *hello*
   <div>


 <span>
  *hello*
   <span>


  <!doctype html>


   <!-- baz -->


alpha <!-- baz -->
<?php
  echo '>';
?>
Here's a simple block:

<div>
	foo
</div>

This should be a code block, though:

	<div>
		foo
	</div>

As should this:

	<div>foo</div>

Now, nested:

<div>
	<div>
		<div>
			foo
		</div>
	</div>
</div>

This should just be an HTML comment:

<!-- Comment -->

Multiline:

<!--
Blah
Blah
-->

Code block:

	<!-- Comment -->

Just plain comment, with trailing spaces on the line:

<!-- foo -->   

Code:

	<hr>
	
Hr's:

<hr>

<hr>

<hr>

<hr>   

<hr>  

<hr> 

<hr class="foo" id="bar" />

<hr class="foo" id="bar"/>

<hr class="foo" id="bar" >
# Block

<article>


<ARTICLE>


<ArTiClE>


<-article>


<article foo=


<article foo="bar


<article foo='bar


<article foo=bar 


<article foo=bar >


<article/>


<-article/>


</article>


</ARTICLE>


</aRtIcLe>


</article  >


</-article  >


</article


</article  


# Inline

<span>


<SPAN>


<SpAn>


<-span>


<span/>


<-span/>


</span>


</SPAN>


</SpAn>


</span  >


</-span>


</span


</span  


<span foo=


<span foo="bar


<span foo='bar


<span foo=bar 


<span foo=bar >
![](/xyz.png)
# [![Unicorn approved](https://img.shields.io/badge/unicorn-approved-ff69b4.svg)](http://shields.io)

[![Build Status](https://img.shields.io/travis/wooorm/mdast.svg?style=flat)](https://travis-ci.org/wooorm/mdast)

[![Be Square](https://img.shields.io/badge/style-flat--squared-green.svg?style=flat-square)](http://example.com "An example")
f|Lorem ipsum dolor sit ![amet](http://amet.com/amet.jpeg "Amet"), consectetur adipiscing elit. Praesent dictum purus ullamcorper ligula semper pellentesque.

Nulla ![finibus](http://finibus.com/finibus.png "Finibus") neque et diam rhoncus convallis. Nam dictum sapien nec sem ultrices fermentum. Nulla ![facilisi](http://facilisi.com/facilisi.gif "Facilisi"). In et feugiat massa.

Donec sed sodales metus, ut aliquet quam. Suspendisse nec ipsum risus. Interdum et malesuada fames ac ante ipsum primis in ![faucibus](http://faucibus.com/faucibus.tiff "Faucibus").
  
The previous line, which contains 2 spaces, should be considered to be empty.
> hi there
bud
# [mailto:test@example.com](http://shields.io)

[https://travis-ci.org/wooorm/mdast](https://travis-ci.org/wooorm/mdast "mdast")

[[](http://example.com "An example")](http://example.com "An example")
[alpha] (bravo

![charlie] (delta
.com)

[echo]	(http://foxtrot.golf)

![hotel]   (india.com/juliett)
[alpha](https://example.com?bravo charlie).

[alpha](https://example.com?bravo	charlie).

[alpha](https://example.com?bravo
charlie).

![alpha](https://example.com?bravo charlie).

![alpha](https://example.com?bravo	charlie).

![alpha](https://example.com?bravo
charlie).

<https://example.com?bravo charlie>.

<https://example.com?bravo	charlie>.

<https://example.com?bravo
charlie>.

https://example.com?bravo charlie.

https://example.com?bravo	charlie.

https://example.com?bravo
charlie.
[Hello](<./world and some spaces.html>)

[Hello](<./world and some spaces.html> "and a title")Just a [URL](/url/).

[URL and title](/url/ "title").

[URL and title](/url/  "title preceded by two spaces").

[URL and title](/url/	"title preceded by a tab").

[URL and title](/url/ "title has spaces afterward"  ).

[URL and title]( /url/has space ).

[URL and title]( /url/has space/ "url has space and title").

[Empty]().
A [primary][toString], [secondary][constructor], and [tertiary][__proto__] link.

[toString]: http://primary.com
[__proto__]: http://tertiary.com
[constructor]: http://secondary.com
Foo [bar] [1].

Foo [bar][1].

Foo [bar]
[1].

[1]: /url/  "Title"


With [embedded \[brackets\]] [b].


Indented [once][].

Indented [twice][].

Indented [thrice][].

Indented [four][] times.

 [once]: /url

  [twice]: /url

   [thrice]: /url

    [four]: /url


[b]: /url/

* * *

[this] [this] should work

So should [this][this].

And [this] [].

And [this][].

And [this].

But not [that] [].

Nor [that][].

Nor [that].

[Something in brackets like [this][] should work]

[Same with [this].]

In this case, [this](/somethingelse/) points to something else.

Backslashing should suppress \[this] and [this\].

[this]: foo


* * *

Here's one where the [link
breaks] across lines.

Here's another where the [link 
breaks] across lines, but with a line-ending space.


[link breaks]: /url/
This is the [simple case].

[simple case]: /simple



This one has a [line
break].

This one has a [line 
break] with a line-ending space.

[line break]: /foo


[this] [that] and the [other]

[this]: /this
[that]: /that
[other]: /other
[Hello [world]!](./hello-world.html).

[Hello [world]!](<./hello-world.html>).

![Hello [world]!](./hello-world.html).

![Hello [world]!](<./hello-world.html>).
[](./hello-world.html).

[](<./hello-world.html>).

![](./hello-world.html).

![](<./hello-world.html>).
[Hello &lsqb;world&rsqb;!](./hello-world.html).

[Hello &lsqb;world&rsqb;!](<./hello-world.html>).

![Hello &lsqb;world&rsqb;!](./hello-world.html).

![Hello &lsqb;world&rsqb;!](<./hello-world.html>).

[Hello &#x5B;world&#x5D;!](./hello-world.html).

[Hello &#x5B;world&#x5D;!](<./hello-world.html>).

![Hello &#x5B;world&#x5D;!](./hello-world.html).

![Hello &#x5B;world&#x5D;!](<./hello-world.html>).
[Hello \[world\]!](./hello-world.html).

[Hello \[world\]!](<./hello-world.html>).

![Hello \[world\]!](./hello-world.html).

![Hello \[world\]!](<./hello-world.html>).
[Hello [world!](./hello-world.html).

[Hello [world!](<./hello-world.html>).

![Hello [world!](./hello-world.html).

![Hello [world!](<./hello-world.html>).
[Hello](./world.html "Hello "World" Hello!").

[Hello](<./world.html> "Hello "World" Hello!").

![Hello](./world.html "Hello "World" Hello!").

![Hello](<./world.html> "Hello "World" Hello!").
[Hello](./world.html "Hello &quot;World&quot; Hello!").

[Hello](<./world.html> "Hello &quot;World&quot; Hello!").

![Hello](./world.html "Hello &quot;World&quot; Hello!").

![Hello](<./world.html> "Hello &quot;World&quot; Hello!").
[Hello](./world.html "Hello \"World\" Hello!").

[Hello](<./world.html> "Hello \"World\" Hello!").

![Hello](./world.html "Hello \"World\" Hello!").

![Hello](<./world.html> "Hello \"World\" Hello!").
[Hello](./world.html "Hello "World Hello!").

[Hello](<./world.html> "Hello "World Hello!").

![Hello](./world.html "Hello "World Hello!").

![Hello](<./world.html> "Hello "World Hello!").
[Hello](./world.html "Hello World!").

[Hello](<./world.html> "Hello World!").

![Hello](./world.html "Hello World!").

![Hello](<./world.html> "Hello World!").
[Hello](./world.html "").

[Hello](<./world.html> "").

![Hello](./world.html "").

![Hello](<./world.html> "").
[Hello](./world.html ()).

[Hello](<./world.html> ()).

![Hello](./world.html ()).

![Hello](<./world.html> ()).
[Hello](./world.html '').

[Hello](<./world.html> '').

![Hello](./world.html '').

![Hello](<./world.html> '').
[Hello](./world.html (Hello World!)).

[Hello](<./world.html> (Hello World!)).

![Hello](./world.html (Hello World!)).

![Hello](<./world.html> (Hello World!)).
[Hello](./world.html 'Hello 'World' Hello!').

[Hello](<./world.html> 'Hello 'World' Hello!').

![Hello](./world.html 'Hello 'World' Hello!').

![Hello](<./world.html> 'Hello 'World' Hello!').
[Hello](./world.html "Hello &apos;World&apos; Hello!").

[Hello](<./world.html> "Hello &apos;World&apos; Hello!").

![Hello](./world.html "Hello &apos;World&apos; Hello!").

![Hello](<./world.html> "Hello &apos;World&apos; Hello!").
[Hello](./world.html 'Hello \'World\' Hello!').

[Hello](<./world.html> 'Hello \'World\' Hello!').

![Hello](./world.html 'Hello \'World\' Hello!').

![Hello](<./world.html> 'Hello \'World\' Hello!').
[Hello](./world.html 'Hello 'World Hello!').

[Hello](<./world.html> 'Hello 'World Hello!').

![Hello](./world.html 'Hello 'World Hello!').

![Hello](<./world.html> 'Hello 'World Hello!').
[Hello](./world.html 'Hello World!').

[Hello](<./world.html> 'Hello World!').

![Hello](./world.html 'Hello World!').

![Hello](<./world.html> 'Hello World!').
[Hello](./world.html 'Hello

[Hello](<./world.html> 'Hello

![Hello](./world.html 'Hello

![Hello](<./world.html> 'Hello

[Hello](./world.html "Hello

[Hello](<./world.html> "Hello

![Hello](./world.html "Hello

![Hello](<./world.html> "Hello

[Hello](./world.html (Hello

[Hello](<./world.html> (Hello

![Hello](./world.html (Hello

![Hello](<./world.html> (Hello
[Hello]("World!").

[Hello]( "World!").

[World](<> "World!").

![Hello]("World!").

![Hello]( "World!").

![World](<> "World!").
[Hello]((World!)).

[Hello]( (World!)).

[World](<> (World!)).

![Hello]((World!)).

![Hello]( (World!)).

![World](<> (World!)).
[Hello]('World!').

[Hello]( 'World!').

[World](<> 'World!').

![Hello]('World!').

![Hello]( 'World!').

![World](<> 'World!').
[Hello]().

[World](<>).

![Hello]().

![World](<>).
[Hello](http://www.example.com?param=1&region=here).

[World](<http://www.example.com?param=1&region=here>).

![Hello](http://www.example.com?param=1&region=here).

![World](<http://www.example.com?param=1&region=here>).
[Hello](./world&lpar;and-hello&lpar;world&rpar;).

[Hello](<./world&lpar;and-hello&lpar;world&rpar;>).

[Hello](./world&lpar;and&rpar;helloworld&rpar;).

[Hello](<./world&lpar;and&rpar;helloworld&rpar;>).

[Hello](./world&#x28;and-hello&#x28;world&#x29;).

[Hello](<./world&#x28;and-hello&#x28;world&#x29;>).

[Hello](./world&#x28;and&#x29;helloworld&#x29;).

[Hello](<./world&#x28;and&#x29;helloworld&#x29;>).

![Hello](./world&lpar;and-hello&lpar;world&rpar;).

![Hello](<./world&lpar;and-hello&lpar;world&rpar;>).

![Hello](./world&lpar;and&rpar;helloworld&rpar;).

![Hello](<./world&lpar;and&rpar;helloworld&rpar;>).

![Hello](./world&#x28;and-hello&#x28;world&#x29;).

![Hello](<./world&#x28;and-hello&#x28;world&#x29;>).

![Hello](./world&#x28;and&#x29;helloworld&#x29;).

![Hello](<./world&#x28;and&#x29;helloworld&#x29;>).
[Hello](./world\(and-hello\(world\)).

[Hello](<./world\(and-hello\(world\)>).

[Hello](./world\(and\)helloworld\)).

[Hello](<./world\(and\)helloworld\)>).

![Hello](./world\(and-hello\(world\)).

![Hello](<./world\(and-hello\(world\)>).

![Hello](./world\(and\)helloworld\)).

![Hello](<./world\(and\)helloworld\)>).
[Hello](./world(and-hello(world)).

[Hello](<./world(and-hello(world)>).

[Hello](./world(and)helloworld)).

[Hello](<./world(and)helloworld)>).

![Hello](./world(and-hello(world)).

![Hello](<./world(and-hello(world)>).

![Hello](./world(and)helloworld)).

![Hello](<./world(and)helloworld)>).
[Hello](./world(and)hello(world)).

[Hello](<./world(and)hello(world)>).

![Hello](./world(and)hello(world)).

![Hello](<./world(and)hello(world)>).
[Hello](./wo
rld.html).

[Hello](<./wo
rld.html>).

![Hello](./wo
rld.png).

![Hello](<./wo
rld.png>).
[Hello](


[World](<


![Hello](


![World](<
[Hello](./wo rld.html).

[Hello](<./wo rld.html>).

![Hello](./wo rld.png).

![Hello](<./wo rld.png>).
Lorem ipsum dolor sit [amet](http://amet.com "Amet"), consectetur adipiscing elit. Praesent dictum purus ullamcorper ligula semper pellentesque.

Nulla [finibus](http://finibus.com "Finibus") neque et diam rhoncus convallis. Nam dictum sapien nec sem ultrices fermentum. Nulla [facilisi](http://facilisi.com "Facilisi"). In et feugiat massa.

Donec sed sodales metus, ut aliquet quam. Suspendisse nec ipsum risus. Interdum et malesuada fames ac ante ipsum primis in [faucibus](http://faucibus.com "Faucibus").
- item
- item
- item

1. item
1. item
1. item

---

- item
- item
- item
1. item
1. item
1. item
*   This is a list item


    This is code
1. foo
---


1. foo
```js
code();
```


1. [foo][]
[foo]: http://google.com


1. [^foo]
[^foo]: bar baz.
- Hello 1a

 World 1a.

- Hello 1b

  World 1b.

-  Hello 2a

  World 2a.

-  Hello 2b

   World 2b.

-   Hello 3a

   World 3a.

-   Hello 3b

    World 3b.

-    Hello 4a

    World 4a.

-    Hello 4b

     World 4b.

-     Hello 5a

     World 5a.

-     Hello 5b

      World 5b.
* Something
### Some heading
- 
--
-   foo
-
-   bar

  -   foo
  -
  -   bar
1. foo bar baz.

<!--  -->

99. foo bar baz.

<!--  -->

999. foo bar baz.

<!--  -->

1. foo bar baz.
   foo bar baz.

<!--  -->

99. foo bar baz.
    foo bar baz.

<!--  -->

999. foo bar baz.
     foo bar baz.

<!--  -->

- foo bar baz.

<!--  -->

- foo bar baz.
  foo bar baz.
1. foo bar baz.

<!--  -->

99. foo bar baz.

<!--  -->

999. foo bar baz.

<!--  -->

1.  foo bar baz.
    foo bar baz.

<!--  -->

99. foo bar baz.
    foo bar baz.

<!--  -->

999.    foo bar baz.
        foo bar baz.

<!--  -->

- foo bar baz.

<!--  -->

-   foo bar baz.
    foo bar baz.
1.  foo bar baz.

<!--  -->

99. foo bar baz.

<!--  -->

999.    foo bar baz.

<!--  -->

1.  foo bar baz.
    foo bar baz.

<!--  -->

99. foo bar baz.
    foo bar baz.

<!--  -->

999.    foo bar baz.
        foo bar baz.

<!--  -->

-   foo bar baz.

<!--  -->

-   foo bar baz.
    foo bar baz.
-   Foo
-
    Bar
  * item1

    * item2

  text
# Mixed spaces and tabs

- (item 1.) Minimum list, equivalent to two spaces
 - (item 2.) indented with 1 space, not enough indentation to be a subitem
	- (item 2.1.) indented with tab


- (item 1.) Minimum list, equivalent to two spaces
  - (item 1.1.) indentend with 2 spaces
	- (item 1.2.) indented with tab


-  (item 1.) List with 1 extra space
   - (item 1.1.) indentend with 3 spaces
	- (item 1.2.) indented with tab


-   (item 1.) List with 2 extra space, equivalent to 1 tab indentation
    - (item 1.1.) indentend with 4 spaces
	- (item 1.2.) indented with tab


-	(item 1.) List with 1 tab, equivalent to 4 spaces
    - (item 1.1.) indentend with 4 spaces
	- (item 1.2.) indented with tab


-	(item 1.) list with double indentation and mixed items
	- (item 1.1.) normal indentation with 1 tab
        - (item 1.1.1.) item with 4 spaces + 4 spaces
	    - (item 1.1.2.) item with tab + 4 spaces
    	- (item 1.1.3.) item with 4 spaces + tab
		- (item 1.1.4.) item with tab + tab
  	  - (item 1.1.5.) item with 2 spaces + tab + 2 spaces (nasty!)
1.1.
2.
3.
4.
2.  foo;
3.  bar;
4.  baz.
2.  foo;
2.  bar;
2.  baz.
**
*
*
*
# List bullets

+   One:
    +   Nested one;
    +   Nested two:
        +   Nested three.
+   Two;
+   Three.
# List bullets

-   One:
    -   Nested one;
    -   Nested two:
        -   Nested three.
-   Two;
-   Three.
# List bullets

*   One:
    *   Nested one;
    *   Nested two:
        *   Nested three.
*   Two;
*   Three.
## foo

1. bar:

    > - one
        - two
            - three
            - four
            - five

1. foo:

    ```
    line 1
    line 2
    ```

1. foo:

    1. foo `bar` bar:

        ``` erb
        some code here
        ```

    2. foo `bar` bar:

        ``` erb
        foo
        ---
        bar
        ---
        foo
        bar
        ```

    3. foo `bar` bar:

        ``` html
        ---
        foo
        foo
        ---
        bar
        ```

    4. foo `bar` bar:

            foo
            ---
            bar

    5. foo
example1 (1234567@example.com)
example1 (mailto:1234567@example.com)

Lorem foo@bar.baz ipsum.

alpha@bravo+charlie.delta isn’t valid, but echo+foxtrot@golf.hotel is.

Valid: a.b-c_d@a.b

Valid, but the dot is not part of the email: a.b-c_d@a.b.

Not valid: a.b-c_d@a.b-

Not valid: a.b-c_d@a.b_

Not valid: alpha@bravo.

&lt;foo@example.com
# Literal URLs

## Extended www “autolinks”

Here’s a URL: www.alpha.org.

Visit www.bravo.org/help for more information.

Dots cannot appear together: www..one.com and www.two..com.

And www. is not a URL, neither are www.a nor www.b.

Underscores cannot be used in the last two domain parts, so www.three.c_m,
and www.fo_ur.com are not URLs, but www.fi_ve.six.com is.

Valid, and the dot is not part of the link: Visit www.charlie.org.

Valid, and this dot isn’t part of the link either: Visit www.delta.org/a.b.

Valid, but two dots are both not part of the URL: www.example.com..

Here are parens: www.echo.com/search?q=Markup+(business)

The last two aren’t part of the
link: www.foxtrot.com/search?q=golf+(hotel)))

These first and last ones aren’t
either: (www.india.com/search?q=juliett+(kilo))

This last one is: (www.lima.com/search?q=mike+(november)

Paren counting is only done if the last character is a closing
paren: www.google.com/search?q=(business))+ok

If it “looks” like an entity at the end, it isn’t included.

This is a whole URL: www.entity.com/search?q=alpha&hl=en

This is a without the semicolon: www.entity.com/search?q=bravo&;

This one is without the “entity”: www.entity.com/search?q=charlie&hl;

This one one too: www.entity.com/search?q=delta&copy;

Only “named” ones work, numericals don’t, so this one is only without the
semicolon: www.entity.com/search?q=delta&#x220A;

`<` immediately ends an autolink: www.alpha.org/he<lp

## Extended url “autolinks”

http://oscar.org

(Visit https://papa.romeo.com/search?q=sierra+(tango))

Dots cannot appear together: http://..one.com and http://two..com, or start:
http://.three.com
* hello
  world

  how
  are
* you



better behavior:

* hello
  * world
    how

    are
    you

  * today
* hi



* hello

* world
* hi



* hello
* world

* hi



* hello
* world

  how
* hi



* hello
* world
* how
  are



* hello
* world

* how
  are
[test]: http://google.com/ "Google"

# A heading

Just a note, I've found that I can't test my markdown parser vs others.
For example, both markdown.js and showdown code blocks in lists wrong. They're
also completely [inconsistent][test] with regards to paragraphs in list items.

A link. Not anymore.

<aside>This will make me fail the test because
markdown.js doesnt acknowledge arbitrary html blocks =/</aside>

* List Item 1

* List Item 2
  * New List Item 1
    Hi, this is a list item.
  * New List Item 2
    Another item
        Code goes here.
        Lots of it...
  * New List Item 3
    The last item

* List Item 3
The final item.

* List Item 4
The real final item.

Paragraph.

> * bq Item 1
> * bq Item 2
>   * New bq Item 1
>   * New bq Item 2
>   Text here

* * *

> Another blockquote!
> I really need to get
> more creative with
> mockup text..
> markdown.js breaks here again

Another Heading
-------------

Hello *world*. Here is a [link](//hello).
And an image ![alt](src "a title").
And an image with an empty alt attribute ![](src).

    Code goes here.
    Lots of it...
Markdown: Basics
================

<ul id="ProjectSubmenu">
    <li><a href="/projects/markdown/" title="Markdown Project Page">Main</a></li>
    <li><a class="selected" title="Markdown Basics">Basics</a></li>
    <li><a href="/projects/markdown/syntax" title="Markdown Syntax Documentation">Syntax</a></li>
    <li><a href="/projects/markdown/license" title="Pricing and License Information">License</a></li>
    <li><a href="/projects/markdown/dingus" title="Online Markdown Web Form">Dingus</a></li>
</ul>


Getting the Gist of Markdown's Formatting Syntax
------------------------------------------------

This page offers a brief overview of what it's like to use Markdown.
The [syntax page] [s] provides complete, detailed documentation for
every feature, but Markdown should be very easy to pick up simply by
looking at a few examples of it in action. The examples on this page
are written in a before/after style, showing example syntax and the
HTML output produced by Markdown.

It's also helpful to simply try Markdown out; the [Dingus] [d] is a
web application that allows you type your own Markdown-formatted text
and translate it to XHTML.

**Note:** This document is itself written using Markdown; you
can [see the source for it by adding '.text' to the URL] [src].

  [s]: /projects/markdown/syntax  "Markdown Syntax"
  [d]: /projects/markdown/dingus  "Markdown Dingus"
  [src]: /projects/markdown/basics.text


## Paragraphs, Headers, Blockquotes ##

A paragraph is simply one or more consecutive lines of text, separated
by one or more blank lines. (A blank line is any line that looks like a
blank line -- a line containing nothing spaces or tabs is considered
blank.) Normal paragraphs should not be intended with spaces or tabs.

Markdown offers two styles of headers: *Setext* and *atx*.
Setext-style headers for `<h1>` and `<h2>` are created by
"underlining" with equal signs (`=`) and hyphens (`-`), respectively.
To create an atx-style header, you put 1-6 hash marks (`#`) at the
beginning of the line -- the number of hashes equals the resulting
HTML header level.

Blockquotes are indicated using email-style '`>`' angle brackets.

Markdown:

    A First Level Header
    ====================
    
    A Second Level Header
    ---------------------

    Now is the time for all good men to come to
    the aid of their country. This is just a
    regular paragraph.

    The quick brown fox jumped over the lazy
    dog's back.
    
    ### Header 3

    > This is a blockquote.
    > 
    > This is the second paragraph in the blockquote.
    >
    > ## This is an H2 in a blockquote


Output:

    <h1>A First Level Header</h1>
    
    <h2>A Second Level Header</h2>
    
    <p>Now is the time for all good men to come to
    the aid of their country. This is just a
    regular paragraph.</p>
    
    <p>The quick brown fox jumped over the lazy
    dog's back.</p>
    
    <h3>Header 3</h3>
    
    <blockquote>
        <p>This is a blockquote.</p>
        
        <p>This is the second paragraph in the blockquote.</p>
        
        <h2>This is an H2 in a blockquote</h2>
    </blockquote>



### Phrase Emphasis ###

Markdown uses asterisks and underscores to indicate spans of emphasis.

Markdown:

    Some of these words *are emphasized*.
    Some of these words _are emphasized also_.
    
    Use two asterisks for **strong emphasis**.
    Or, if you prefer, __use two underscores instead__.

Output:

    <p>Some of these words <em>are emphasized</em>.
    Some of these words <em>are emphasized also</em>.</p>
    
    <p>Use two asterisks for <strong>strong emphasis</strong>.
    Or, if you prefer, <strong>use two underscores instead</strong>.</p>
   


## Lists ##

Unordered (bulleted) lists use asterisks, pluses, and hyphens (`*`,
`+`, and `-`) as list markers. These three markers are
interchangable; this:

    *   Candy.
    *   Gum.
    *   Booze.

this:

    +   Candy.
    +   Gum.
    +   Booze.

and this:

    -   Candy.
    -   Gum.
    -   Booze.

all produce the same output:

    <ul>
    <li>Candy.</li>
    <li>Gum.</li>
    <li>Booze.</li>
    </ul>

Ordered (numbered) lists use regular numbers, followed by periods, as
list markers:

    1.  Red
    2.  Green
    3.  Blue

Output:

    <ol>
    <li>Red</li>
    <li>Green</li>
    <li>Blue</li>
    </ol>

If you put blank lines between items, you'll get `<p>` tags for the
list item text. You can create multi-paragraph list items by indenting
the paragraphs by 4 spaces or 1 tab:

    *   A list item.
    
        With multiple paragraphs.

    *   Another item in the list.

Output:

    <ul>
    <li><p>A list item.</p>
    <p>With multiple paragraphs.</p></li>
    <li><p>Another item in the list.</p></li>
    </ul>
    


### Links ###

Markdown supports two styles for creating links: *inline* and
*reference*. With both styles, you use square brackets to delimit the
text you want to turn into a link.

Inline-style links use parentheses immediately after the link text.
For example:

    This is an [example link](http://example.com/).

Output:

    <p>This is an <a href="http://example.com/">
    example link</a>.</p>

Optionally, you may include a title attribute in the parentheses:

    This is an [example link](http://example.com/ "With a Title").

Output:

    <p>This is an <a href="http://example.com/" title="With a Title">
    example link</a>.</p>

Reference-style links allow you to refer to your links by names, which
you define elsewhere in your document:

    I get 10 times more traffic from [Google][1] than from
    [Yahoo][2] or [MSN][3].

    [1]: http://google.com/        "Google"
    [2]: http://search.yahoo.com/  "Yahoo Search"
    [3]: http://search.msn.com/    "MSN Search"

Output:

    <p>I get 10 times more traffic from <a href="http://google.com/"
    title="Google">Google</a> than from <a href="http://search.yahoo.com/"
    title="Yahoo Search">Yahoo</a> or <a href="http://search.msn.com/"
    title="MSN Search">MSN</a>.</p>

The title attribute is optional. Link names may contain letters,
numbers and spaces, but are *not* case sensitive:

    I start my morning with a cup of coffee and
    [The New York Times][NY Times].

    [ny times]: http://www.nytimes.com/

Output:

    <p>I start my morning with a cup of coffee and
    <a href="http://www.nytimes.com/">The New York Times</a>.</p>


### Images ###

Image syntax is very much like link syntax.

Inline (titles are optional):

    ![alt text](/path/to/img.jpg "Title")

Reference-style:

    ![alt text][id]

    [id]: /path/to/img.jpg "Title"

Both of the above examples produce the same output:

    <img src="/path/to/img.jpg" alt="alt text" title="Title" />



### Code ###

In a regular paragraph, you can create code span by wrapping text in
backtick quotes. Any ampersands (`&`) and angle brackets (`<` or
`>`) will automatically be translated into HTML entities. This makes
it easy to use Markdown to write about HTML example code:

    I strongly recommend against using any `<blink>` tags.

    I wish SmartyPants used named entities like `&mdash;`
    instead of decimal-encoded entites like `&#8212;`.

Output:

    <p>I strongly recommend against using any
    <code>&lt;blink&gt;</code> tags.</p>
    
    <p>I wish SmartyPants used named entities like
    <code>&amp;mdash;</code> instead of decimal-encoded
    entites like <code>&amp;#8212;</code>.</p>


To specify an entire block of pre-formatted code, indent every line of
the block by 4 spaces or 1 tab. Just like with code spans, `&`, `<`,
and `>` characters will be escaped automatically.

Markdown:

    If you want your page to validate under XHTML 1.0 Strict,
    you've got to put paragraph tags in your blockquotes:

        <blockquote>
            <p>For example.</p>
        </blockquote>

Output:

    <p>If you want your page to validate under XHTML 1.0 Strict,
    you've got to put paragraph tags in your blockquotes:</p>
    
    <pre><code>&lt;blockquote&gt;
        &lt;p&gt;For example.&lt;/p&gt;
    &lt;/blockquote&gt;
    </code></pre>
Markdown: Syntax
================

<ul id="ProjectSubmenu">
    <li><a href="/projects/markdown/" title="Markdown Project Page">Main</a></li>
    <li><a href="/projects/markdown/basics" title="Markdown Basics">Basics</a></li>
    <li><a class="selected" title="Markdown Syntax Documentation">Syntax</a></li>
    <li><a href="/projects/markdown/license" title="Pricing and License Information">License</a></li>
    <li><a href="/projects/markdown/dingus" title="Online Markdown Web Form">Dingus</a></li>
</ul>


*   [Overview](#overview)
    *   [Philosophy](#philosophy)
    *   [Inline HTML](#html)
    *   [Automatic Escaping for Special Characters](#autoescape)
*   [Block Elements](#block)
    *   [Paragraphs and Line Breaks](#p)
    *   [Headers](#header)
    *   [Blockquotes](#blockquote)
    *   [Lists](#list)
    *   [Code Blocks](#precode)
    *   [Horizontal Rules](#hr)
*   [Span Elements](#span)
    *   [Links](#link)
    *   [Emphasis](#em)
    *   [Code](#code)
    *   [Images](#img)
*   [Miscellaneous](#misc)
    *   [Backslash Escapes](#backslash)
    *   [Automatic Links](#autolink)


**Note:** This document is itself written using Markdown; you
can [see the source for it by adding '.text' to the URL][src].

  [src]: /projects/markdown/syntax.text

* * *

<h2 id="overview">Overview</h2>

<h3 id="philosophy">Philosophy</h3>

Markdown is intended to be as easy-to-read and easy-to-write as is feasible.

Readability, however, is emphasized above all else. A Markdown-formatted
document should be publishable as-is, as plain text, without looking
like it's been marked up with tags or formatting instructions. While
Markdown's syntax has been influenced by several existing text-to-HTML
filters -- including [Setext] [1], [atx] [2], [Textile] [3], [reStructuredText] [4],
[Grutatext] [5], and [EtText] [6] -- the single biggest source of
inspiration for Markdown's syntax is the format of plain text email.

  [1]: http://docutils.sourceforge.net/mirror/setext.html
  [2]: http://www.aaronsw.com/2002/atx/
  [3]: http://textism.com/tools/textile/
  [4]: http://docutils.sourceforge.net/rst.html
  [5]: http://www.triptico.com/software/grutatxt.html
  [6]: http://ettext.taint.org/doc/

To this end, Markdown's syntax is comprised entirely of punctuation
characters, which punctuation characters have been carefully chosen so
as to look like what they mean. E.g., asterisks around a word actually
look like \*emphasis\*. Markdown lists look like, well, lists. Even
blockquotes look like quoted passages of text, assuming you've ever
used email.



<h3 id="html">Inline HTML</h3>

Markdown's syntax is intended for one purpose: to be used as a
format for *writing* for the web.

Markdown is not a replacement for HTML, or even close to it. Its
syntax is very small, corresponding only to a very small subset of
HTML tags. The idea is *not* to create a syntax that makes it easier
to insert HTML tags. In my opinion, HTML tags are already easy to
insert. The idea for Markdown is to make it easy to read, write, and
edit prose. HTML is a *publishing* format; Markdown is a *writing*
format. Thus, Markdown's formatting syntax only addresses issues that
can be conveyed in plain text.

For any markup that is not covered by Markdown's syntax, you simply
use HTML itself. There's no need to preface it or delimit it to
indicate that you're switching from Markdown to HTML; you just use
the tags.

The only restrictions are that block-level HTML elements -- e.g. `<div>`,
`<table>`, `<pre>`, `<p>`, etc. -- must be separated from surrounding
content by blank lines, and the start and end tags of the block should
not be indented with tabs or spaces. Markdown is smart enough not
to add extra (unwanted) `<p>` tags around HTML block-level tags.

For example, to add an HTML table to a Markdown article:

    This is a regular paragraph.

    <table>
        <tr>
            <td>Foo</td>
        </tr>
    </table>

    This is another regular paragraph.

Note that Markdown formatting syntax is not processed within block-level
HTML tags. E.g., you can't use Markdown-style `*emphasis*` inside an
HTML block.

Span-level HTML tags -- e.g. `<span>`, `<cite>`, or `<del>` -- can be
used anywhere in a Markdown paragraph, list item, or header. If you
want, you can even use HTML tags instead of Markdown formatting; e.g. if
you'd prefer to use HTML `<a>` or `<img>` tags instead of Markdown's
link or image syntax, go right ahead.

Unlike block-level HTML tags, Markdown syntax *is* processed within
span-level tags.


<h3 id="autoescape">Automatic Escaping for Special Characters</h3>

In HTML, there are two characters that demand special treatment: `<`
and `&`. Left angle brackets are used to start tags; ampersands are
used to denote HTML entities. If you want to use them as literal
characters, you must escape them as entities, e.g. `&lt;`, and
`&amp;`.

Ampersands in particular are bedeviling for web writers. If you want to
write about 'AT&T', you need to write '`AT&amp;T`'. You even need to
escape ampersands within URLs. Thus, if you want to link to:

    http://images.google.com/images?num=30&q=larry+bird

you need to encode the URL as:

    http://images.google.com/images?num=30&amp;q=larry+bird

in your anchor tag `href` attribute. Needless to say, this is easy to
forget, and is probably the single most common source of HTML validation
errors in otherwise well-marked-up web sites.

Markdown allows you to use these characters naturally, taking care of
all the necessary escaping for you. If you use an ampersand as part of
an HTML entity, it remains unchanged; otherwise it will be translated
into `&amp;`.

So, if you want to include a copyright symbol in your article, you can write:

    &copy;

and Markdown will leave it alone. But if you write:

    AT&T

Markdown will translate it to:

    AT&amp;T

Similarly, because Markdown supports [inline HTML](#html), if you use
angle brackets as delimiters for HTML tags, Markdown will treat them as
such. But if you write:

    4 < 5

Markdown will translate it to:

    4 &lt; 5

However, inside Markdown code spans and blocks, angle brackets and
ampersands are *always* encoded automatically. This makes it easy to use
Markdown to write about HTML code. (As opposed to raw HTML, which is a
terrible format for writing about HTML syntax, because every single `<`
and `&` in your example code needs to be escaped.)


* * *


<h2 id="block">Block Elements</h2>

<h3 id="p">Paragraphs and Line Breaks</h3>

A paragraph is simply one or more consecutive lines of text, separated
by one or more blank lines. (A blank line is any line that looks like a
blank line -- a line containing nothing but spaces or tabs is considered
blank.) Normal paragraphs should not be intended with spaces or tabs.

The implication of the "one or more consecutive lines of text" rule is
that Markdown supports "hard-wrapped" text paragraphs. This differs
significantly from most other text-to-HTML formatters (including Movable
Type's "Convert Line Breaks" option) which translate every line break
character in a paragraph into a `<br />` tag.

When you *do* want to insert a `<br />` break tag using Markdown, you
end a line with two or more spaces, then type return.

Yes, this takes a tad more effort to create a `<br />`, but a simplistic
"every line break is a `<br />`" rule wouldn't work for Markdown.
Markdown's email-style [blockquoting][bq] and multi-paragraph [list items][l]
work best -- and look better -- when you format them with hard breaks.

  [bq]: #blockquote
  [l]:  #list



<h3 id="header">Headers</h3>

Markdown supports two styles of headers, [Setext] [1] and [atx] [2].

Setext-style headers are "underlined" using equal signs (for first-level
headers) and dashes (for second-level headers). For example:

    This is an H1
    =============

    This is an H2
    -------------

Any number of underlining `=`'s or `-`'s will work.

Atx-style headers use 1-6 hash characters at the start of the line,
corresponding to header levels 1-6. For example:

    # This is an H1

    ## This is an H2

    ###### This is an H6

Optionally, you may "close" atx-style headers. This is purely
cosmetic -- you can use this if you think it looks better. The
closing hashes don't even need to match the number of hashes
used to open the header. (The number of opening hashes
determines the header level.) :

    # This is an H1 #

    ## This is an H2 ##

    ### This is an H3 ######


<h3 id="blockquote">Blockquotes</h3>

Markdown uses email-style `>` characters for blockquoting. If you're
familiar with quoting passages of text in an email message, then you
know how to create a blockquote in Markdown. It looks best if you hard
wrap the text and put a `>` before every line:

    > This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,
    > consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.
    > Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.
    > 
    > Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse
    > id sem consectetuer libero luctus adipiscing.

Markdown allows you to be lazy and only put the `>` before the first
line of a hard-wrapped paragraph:

    > This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,
    consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.
    Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.

    > Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse
    id sem consectetuer libero luctus adipiscing.

Blockquotes can be nested (i.e. a blockquote-in-a-blockquote) by
adding additional levels of `>`:

    > This is the first level of quoting.
    >
    > > This is nested blockquote.
    >
    > Back to the first level.

Blockquotes can contain other Markdown elements, including headers, lists,
and code blocks:

	> ## This is a header.
	> 
	> 1.   This is the first list item.
	> 2.   This is the second list item.
	> 
	> Here's some example code:
	> 
	>     return shell_exec("echo $input | $markdown_script");

Any decent text editor should make email-style quoting easy. For
example, with BBEdit, you can make a selection and choose Increase
Quote Level from the Text menu.


<h3 id="list">Lists</h3>

Markdown supports ordered (numbered) and unordered (bulleted) lists.

Unordered lists use asterisks, pluses, and hyphens -- interchangably
-- as list markers:

    *   Red
    *   Green
    *   Blue

is equivalent to:

    +   Red
    +   Green
    +   Blue

and:

    -   Red
    -   Green
    -   Blue

Ordered lists use numbers followed by periods:

    1.  Bird
    2.  McHale
    3.  Parish

It's important to note that the actual numbers you use to mark the
list have no effect on the HTML output Markdown produces. The HTML
Markdown produces from the above list is:

    <ol>
    <li>Bird</li>
    <li>McHale</li>
    <li>Parish</li>
    </ol>

If you instead wrote the list in Markdown like this:

    1.  Bird
    1.  McHale
    1.  Parish

or even:

    3. Bird
    1. McHale
    8. Parish

you'd get the exact same HTML output. The point is, if you want to,
you can use ordinal numbers in your ordered Markdown lists, so that
the numbers in your source match the numbers in your published HTML.
But if you want to be lazy, you don't have to.

If you do use lazy list numbering, however, you should still start the
list with the number 1. At some point in the future, Markdown may support
starting ordered lists at an arbitrary number.

List markers typically start at the left margin, but may be indented by
up to three spaces. List markers must be followed by one or more spaces
or a tab.

To make lists look nice, you can wrap items with hanging indents:

    *   Lorem ipsum dolor sit amet, consectetuer adipiscing elit.
        Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,
        viverra nec, fringilla in, laoreet vitae, risus.
    *   Donec sit amet nisl. Aliquam semper ipsum sit amet velit.
        Suspendisse id sem consectetuer libero luctus adipiscing.

But if you want to be lazy, you don't have to:

    *   Lorem ipsum dolor sit amet, consectetuer adipiscing elit.
    Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,
    viverra nec, fringilla in, laoreet vitae, risus.
    *   Donec sit amet nisl. Aliquam semper ipsum sit amet velit.
    Suspendisse id sem consectetuer libero luctus adipiscing.

If list items are separated by blank lines, Markdown will wrap the
items in `<p>` tags in the HTML output. For example, this input:

    *   Bird
    *   Magic

will turn into:

    <ul>
    <li>Bird</li>
    <li>Magic</li>
    </ul>

But this:

    *   Bird

    *   Magic

will turn into:

    <ul>
    <li><p>Bird</p></li>
    <li><p>Magic</p></li>
    </ul>

List items may consist of multiple paragraphs. Each subsequent
paragraph in a list item must be intended by either 4 spaces
or one tab:

    1.  This is a list item with two paragraphs. Lorem ipsum dolor
        sit amet, consectetuer adipiscing elit. Aliquam hendrerit
        mi posuere lectus.

        Vestibulum enim wisi, viverra nec, fringilla in, laoreet
        vitae, risus. Donec sit amet nisl. Aliquam semper ipsum
        sit amet velit.

    2.  Suspendisse id sem consectetuer libero luctus adipiscing.

It looks nice if you indent every line of the subsequent
paragraphs, but here again, Markdown will allow you to be
lazy:

    *   This is a list item with two paragraphs.

        This is the second paragraph in the list item. You're
    only required to indent the first line. Lorem ipsum dolor
    sit amet, consectetuer adipiscing elit.

    *   Another item in the same list.

To put a blockquote within a list item, the blockquote's `>`
delimiters need to be indented:

    *   A list item with a blockquote:

        > This is a blockquote
        > inside a list item.

To put a code block within a list item, the code block needs
to be indented *twice* -- 8 spaces or two tabs:

    *   A list item with a code block:

            <code goes here>


It's worth noting that it's possible to trigger an ordered list by
accident, by writing something like this:

    1986. What a great season.

In other words, a *number-period-space* sequence at the beginning of a
line. To avoid this, you can backslash-escape the period:

    1986\. What a great season.



<h3 id="precode">Code Blocks</h3>

Pre-formatted code blocks are used for writing about programming or
markup source code. Rather than forming normal paragraphs, the lines
of a code block are interpreted literally. Markdown wraps a code block
in both `<pre>` and `<code>` tags.

To produce a code block in Markdown, simply indent every line of the
block by at least 4 spaces or 1 tab. For example, given this input:

    This is a normal paragraph:

        This is a code block.

Markdown will generate:

    <p>This is a normal paragraph:</p>

    <pre><code>This is a code block.
    </code></pre>

One level of indentation -- 4 spaces or 1 tab -- is removed from each
line of the code block. For example, this:

    Here is an example of AppleScript:

        tell application "Foo"
            beep
        end tell

will turn into:

    <p>Here is an example of AppleScript:</p>

    <pre><code>tell application "Foo"
        beep
    end tell
    </code></pre>

A code block continues until it reaches a line that is not indented
(or the end of the article).

Within a code block, ampersands (`&`) and angle brackets (`<` and `>`)
are automatically converted into HTML entities. This makes it very
easy to include example HTML source code using Markdown -- just paste
it and indent it, and Markdown will handle the hassle of encoding the
ampersands and angle brackets. For example, this:

        <div class="footer">
            &copy; 2004 Foo Corporation
        </div>

will turn into:

    <pre><code>&lt;div class="footer"&gt;
        &amp;copy; 2004 Foo Corporation
    &lt;/div&gt;
    </code></pre>

Regular Markdown syntax is not processed within code blocks. E.g.,
asterisks are just literal asterisks within a code block. This means
it's also easy to use Markdown to write about Markdown's own syntax.



<h3 id="hr">Horizontal Rules</h3>

You can produce a horizontal rule tag (`<hr>`) by placing three or
more hyphens, asterisks, or underscores on a line by themselves. If you
wish, you may use spaces between the hyphens or asterisks. Each of the
following lines will produce a horizontal rule:

    * * *

    ***

    *****
	
    - - -

    ---------------------------------------

	_ _ _


* * *

<h2 id="span">Span Elements</h2>

<h3 id="link">Links</h3>

Markdown supports two style of links: *inline* and *reference*.

In both styles, the link text is delimited by [square brackets].

To create an inline link, use a set of regular parentheses immediately
after the link text's closing square bracket. Inside the parentheses,
put the URL where you want the link to point, along with an *optional*
title for the link, surrounded in quotes. For example:

    This is [an example](http://example.com/ "Title") inline link.

    [This link](http://example.net/) has no title attribute.

Will produce:

    <p>This is <a href="http://example.com/" title="Title">
    an example</a> inline link.</p>

    <p><a href="http://example.net/">This link</a> has no
    title attribute.</p>

If you're referring to a local resource on the same server, you can
use relative paths:

    See my [About](/about/) page for details.

Reference-style links use a second set of square brackets, inside
which you place a label of your choosing to identify the link:

    This is [an example][id] reference-style link.

You can optionally use a space to separate the sets of brackets:

    This is [an example] [id] reference-style link.

Then, anywhere in the document, you define your link label like this,
on a line by itself:

    [id]: http://example.com/  "Optional Title Here"

That is:

*   Square brackets containing the link identifier (optionally
    indented from the left margin using up to three spaces);
*   followed by a colon;
*   followed by one or more spaces (or tabs);
*   followed by the URL for the link;
*   optionally followed by a title attribute for the link, enclosed
    in double or single quotes.

The link URL may, optionally, be surrounded by angle brackets:

    [id]: <http://example.com/>  "Optional Title Here"

You can put the title attribute on the next line and use extra spaces
or tabs for padding, which tends to look better with longer URLs:

    [id]: http://example.com/longish/path/to/resource/here
        "Optional Title Here"

Link definitions are only used for creating links during Markdown
processing, and are stripped from your document in the HTML output.

Link definition names may constist of letters, numbers, spaces, and punctuation -- but they are *not* case sensitive. E.g. these two links:

	[link text][a]
	[link text][A]

are equivalent.

The *implicit link name* shortcut allows you to omit the name of the
link, in which case the link text itself is used as the name.
Just use an empty set of square brackets -- e.g., to link the word
"Google" to the google.com web site, you could simply write:

	[Google][]

And then define the link:

	[Google]: http://google.com/

Because link names may contain spaces, this shortcut even works for
multiple words in the link text:

	Visit [Daring Fireball][] for more information.

And then define the link:
	
	[Daring Fireball]: http://daringfireball.net/

Link definitions can be placed anywhere in your Markdown document. I
tend to put them immediately after each paragraph in which they're
used, but if you want, you can put them all at the end of your
document, sort of like footnotes.

Here's an example of reference links in action:

    I get 10 times more traffic from [Google] [1] than from
    [Yahoo] [2] or [MSN] [3].

      [1]: http://google.com/        "Google"
      [2]: http://search.yahoo.com/  "Yahoo Search"
      [3]: http://search.msn.com/    "MSN Search"

Using the implicit link name shortcut, you could instead write:

    I get 10 times more traffic from [Google][] than from
    [Yahoo][] or [MSN][].

      [google]: http://google.com/        "Google"
      [yahoo]:  http://search.yahoo.com/  "Yahoo Search"
      [msn]:    http://search.msn.com/    "MSN Search"

Both of the above examples will produce the following HTML output:

    <p>I get 10 times more traffic from <a href="http://google.com/"
    title="Google">Google</a> than from
    <a href="http://search.yahoo.com/" title="Yahoo Search">Yahoo</a>
    or <a href="http://search.msn.com/" title="MSN Search">MSN</a>.</p>

For comparison, here is the same paragraph written using
Markdown's inline link style:

    I get 10 times more traffic from [Google](http://google.com/ "Google")
    than from [Yahoo](http://search.yahoo.com/ "Yahoo Search") or
    [MSN](http://search.msn.com/ "MSN Search").

The point of reference-style links is not that they're easier to
write. The point is that with reference-style links, your document
source is vastly more readable. Compare the above examples: using
reference-style links, the paragraph itself is only 81 characters
long; with inline-style links, it's 176 characters; and as raw HTML,
it's 234 characters. In the raw HTML, there's more markup than there
is text.

With Markdown's reference-style links, a source document much more
closely resembles the final output, as rendered in a browser. By
allowing you to move the markup-related metadata out of the paragraph,
you can add links without interrupting the narrative flow of your
prose.


<h3 id="em">Emphasis</h3>

Markdown treats asterisks (`*`) and underscores (`_`) as indicators of
emphasis. Text wrapped with one `*` or `_` will be wrapped with an
HTML `<em>` tag; double `*`'s or `_`'s will be wrapped with an HTML
`<strong>` tag. E.g., this input:

    *single asterisks*

    _single underscores_

    **double asterisks**

    __double underscores__

will produce:

    <em>single asterisks</em>

    <em>single underscores</em>

    <strong>double asterisks</strong>

    <strong>double underscores</strong>

You can use whichever style you prefer; the lone restriction is that
the same character must be used to open and close an emphasis span.

Emphasis can be used in the middle of a word:

    un*fucking*believable

But if you surround an `*` or `_` with spaces, it'll be treated as a
literal asterisk or underscore.

To produce a literal asterisk or underscore at a position where it
would otherwise be used as an emphasis delimiter, you can backslash
escape it:

    \*this text is surrounded by literal asterisks\*



<h3 id="code">Code</h3>

To indicate a span of code, wrap it with backtick quotes (`` ` ``).
Unlike a pre-formatted code block, a code span indicates code within a
normal paragraph. For example:

    Use the `printf()` function.

will produce:

    <p>Use the <code>printf()</code> function.</p>

To include a literal backtick character within a code span, you can use
multiple backticks as the opening and closing delimiters:

    ``There is a literal backtick (`) here.``

which will produce this:

    <p><code>There is a literal backtick (`) here.</code></p>

The backtick delimiters surrounding a code span may include spaces --
one after the opening, one before the closing. This allows you to place
literal backtick characters at the beginning or end of a code span:

	A single backtick in a code span: `` ` ``
	
	A backtick-delimited string in a code span: `` `foo` ``

will produce:

	<p>A single backtick in a code span: <code>`</code></p>
	
	<p>A backtick-delimited string in a code span: <code>`foo`</code></p>

With a code span, ampersands and angle brackets are encoded as HTML
entities automatically, which makes it easy to include example HTML
tags. Markdown will turn this:

    Please don't use any `<blink>` tags.

into:

    <p>Please don't use any <code>&lt;blink&gt;</code> tags.</p>

You can write this:

    `&#8212;` is the decimal-encoded equivalent of `&mdash;`.

to produce:

    <p><code>&amp;#8212;</code> is the decimal-encoded
    equivalent of <code>&amp;mdash;</code>.</p>



<h3 id="img">Images</h3>

Admittedly, it's fairly difficult to devise a "natural" syntax for
placing images into a plain text document format.

Markdown uses an image syntax that is intended to resemble the syntax
for links, allowing for two styles: *inline* and *reference*.

Inline image syntax looks like this:

    ![Alt text](/path/to/img.jpg)

    ![Alt text](/path/to/img.jpg "Optional title")

That is:

*   An exclamation mark: `!`;
*   followed by a set of square brackets, containing the `alt`
    attribute text for the image;
*   followed by a set of parentheses, containing the URL or path to
    the image, and an optional `title` attribute enclosed in double
    or single quotes.

Reference-style image syntax looks like this:

    ![Alt text][id]

Where "id" is the name of a defined image reference. Image references
are defined using syntax identical to link references:

    [id]: url/to/image  "Optional title attribute"

As of this writing, Markdown has no syntax for specifying the
dimensions of an image; if this is important to you, you can simply
use regular HTML `<img>` tags.


* * *


<h2 id="misc">Miscellaneous</h2>

<h3 id="autolink">Automatic Links</h3>

Markdown supports a shortcut style for creating "automatic" links for URLs and email addresses: simply surround the URL or email address with angle brackets. What this means is that if you want to show the actual text of a URL or email address, and also have it be a clickable link, you can do this:

    <http://example.com/>
    
Markdown will turn this into:

    <a href="http://example.com/">http://example.com/</a>

Automatic links for email addresses work similarly, except that
Markdown will also perform a bit of randomized decimal and hex
entity-encoding to help obscure your address from address-harvesting
spambots. For example, Markdown will turn this:

    <address@example.com>

into something like this:

    <a href="&#x6D;&#x61;i&#x6C;&#x74;&#x6F;:&#x61;&#x64;&#x64;&#x72;&#x65;
    &#115;&#115;&#64;&#101;&#120;&#x61;&#109;&#x70;&#x6C;e&#x2E;&#99;&#111;
    &#109;">&#x61;&#x64;&#x64;&#x72;&#x65;&#115;&#115;&#64;&#101;&#120;&#x61;
    &#109;&#x70;&#x6C;e&#x2E;&#99;&#111;&#109;</a>

which will render in a browser as a clickable link to "address@example.com".

(This sort of entity-encoding trick will indeed fool many, if not
most, address-harvesting bots, but it definitely won't fool all of
them. It's better than nothing, but an address published in this way
will probably eventually start receiving spam.)



<h3 id="backslash">Backslash Escapes</h3>

Markdown allows you to use backslash escapes to generate literal
characters which would otherwise have special meaning in Markdown's
formatting syntax. For example, if you wanted to surround a word with
literal asterisks (instead of an HTML `<em>` tag), you can backslashes
before the asterisks, like this:

    \*literal asterisks\*

Markdown provides backslash escapes for the following characters:

    \   backslash
    `   backtick
    *   asterisk
    _   underscore
    {}  curly braces
    []  square brackets
    ()  parentheses
    #   hash mark
	+	plus sign
	-	minus sign (hyphen)
    .   dot
    !   exclamation mark

# Mixed spaces and tabs

- Very long
		paragraph

1. Very long
		paragraph

-	Very long
		paragraph

1.	Very long
		paragraph
> foo
>
> > bar
>
> foo
````` hi ther `` ok ``` `````

`` `hi ther` ``
*test **test** test*

_test __test__ test_
This nested image should work:

[![Foo][bar]][baz]

This nested link should not work:

[[Foo][bar]][baz]

[bar]: https://bar.com "bar"
[baz]: https://baz.com "baz"
[the `]` character](/url)

[the `` [ `` character](/url)

[the `` [ ``` character](/url)

[the `` ` `` character](/url)
This document tests for the working of `position: false` as a parse
option.

>   Block-quotes
>
>   *   With list items.

Another block-quote:

>   1.  And another list.

Some [deeply **nested _elements_**](http://example.com)

An entity: &copy;, and an warning entity: &copy.
\[test](not a link)
## Unordered

Asterisks tight:

*	asterisk 1
*	asterisk 2
*	asterisk 3


Asterisks loose:

*	asterisk 1

*	asterisk 2

*	asterisk 3

* * *

Pluses tight:

+	Plus 1
+	Plus 2
+	Plus 3


Pluses loose:

+	Plus 1

+	Plus 2

+	Plus 3

* * *


Minuses tight:

-	Minus 1
-	Minus 2
-	Minus 3


Minuses loose:

-	Minus 1

-	Minus 2

-	Minus 3


## Ordered

Tight:

1.	First
2.	Second
3.	Third

and:

1. One
2. Two
3. Three


Loose using tabs:

1.	First

2.	Second

3.	Third

and using spaces:

1. One

2. Two

3. Three

Multiple paragraphs:

1.	Item 1, graf one.

	Item 2. graf two. The quick brown fox jumped over the lazy dog's
	back.
	
2.	Item 2.

3.	Item 3.



## Nested

*	Tab
	*	Tab
		*	Tab

Here's another:

1. First
2. Second:
	* Fee
	* Fie
	* Foe
3. Third

Same thing but with paragraphs:

1. First

2. Second:
	* Fee
	* Fie
	* Foe

3. Third


This was an error in Markdown 1.0.1:

*	this

	*	sub

	that
1. foo
2. bar
3) baz
## Ordered

Tight:

1)	First
2)	Second
3)	Third

and:

1) One
2) Two
3) Three

Loose using tabs:

1)	First

2)	Second

3)	Third

and using spaces:

1) One

2) Two

3) Three

Multiple paragraphs:

1)	Item 1, graf one.

	Item 2. graf two. The quick brown fox jumped over the lazy dog's
	back.
	
2)	Item 2.

3)	Item 3.
# Without lines.

This is a paragraph
    and this is further text

This is a paragraph
   and this is further text

This is a paragraph
    
and this is a new paragraph

This is a paragraph with some asterisks
    ***

This is a paragraph followed by a horizontal rule
   ***

# With lines.

This is a paragraph

    and this is code

This is a paragraph

   and this is a new paragraph

This is a paragraph with some asterisks in a code block

    ***

This is a paragraph followed by a horizontal rule

   ***

  

aaa
  

# aaa

  

bbb
  
ccc[hi]

[hi]: /url (there)
![][1]

[1]: /xyz.png
[b\*r*][b\-r], [b\*r*][], [b\*r*].

![foo][b\*r*], ![b\*r*][], ![b\*r*].

[b\*r*]: http://google.com
[bar][bar

[bar][

[bar]
[foo]

[foo]: <./url with spaces>
[foo]

[foo]: first
[foo]: second
* test
+ test
- test
Characters that should be escaped in general:

\\ \` \* \[

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are \_escaped\_ unless they appear in_the_middle_of_a_word.

Ampersands are escaped only when they would otherwise start an entity:

-   \&copycat \&amp; \&#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should be escaped in URLs:

-   http\://user:password@host:port/path?key=value#fragment
-   https\://user:password@host:port/path?key=value#fragment

Double tildes should be \~~escaped\~~.
And here: foo\~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | tho\|ugh |

And here:

| here   | they   |
\| ---- \| ----- \|
| should | though |

And here:

here   | they
\---- \| ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   \<div>\</div>
-   \<http\:google.com>
Characters that should be escaped in general:

\\ \` \* \[

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are \_escaped\_ unless they appear in_the_middle_of_a_word.

Ampersands are escaped only when they would otherwise start an entity:

-   \&copycat \&amp; \&#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should not be escaped in URLs:

-   http://user:password@host:port/path?key=value#fragment
-   https://user:password@host:port/path?key=value#fragment

Double tildes should not be ~~escaped~~.
Nor here: foo~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | nei|ther |

Nor here:

| here   | they   |
| ------ | ------ |
| should | though |

Nor here:

here   | they
\----- | ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   \<div>\</div>
-   \<http:google.com>
Characters that should be escaped in general:

\\ \` \* \[

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are \_escaped\_ unless they appear in_the_middle_of_a_word.

Ampersands are escaped only when they would otherwise start an entity:

-   &amp;copycat &amp;amp; &amp;#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should not be escaped in URLs:

-   http://user:password@host:port/path?key=value#fragment
-   https://user:password@host:port/path?key=value#fragment

Double tildes should not be ~~escaped~~.
Nor here: foo~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | nei|ther |

Nor here:

| here   | they   |
| ------ | ------ |
| should | though |

Nor here:

here   | they
\----- | ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   &lt;div>&lt;/div>
-   &lt;http:google.com>
Characters that should be escaped in general:

\\ \` \* \[ \_

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are always \_escaped\_, even when they appear in\_the\_middle\_of\_a\_word.

Ampersands are escaped only when they would otherwise start an entity:

-   &amp;copycat &amp;amp; &amp;#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should be escaped in URLs:

-   http&#x3A;//user:password@host:port/path?key=value#fragment
-   https&#x3A;//user:password@host:port/path?key=value#fragment

Double tildes should be \~~escaped\~~.
And here: foo\~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | tho\|ugh |

And here:

| here   | they   |
\| ---- \| ----- \|
| should | though |

And here:

here   | they
\---- \| ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   &lt;div>&lt;/div>
-   &lt;http&#x3A;google.com>
Characters that should be escaped in general:

\\ \` \* \[ \_

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are always \_escaped\_, even when they appear in\_the\_middle\_of\_a\_word.

Ampersands are escaped only when they would otherwise start an entity:

-   &amp;copycat &amp;amp; &amp;#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should be escaped in URLs:

-   http&#x3A;//user:password@host:port/path?key=value#fragment
-   https&#x3A;//user:password@host:port/path?key=value#fragment

Double tildes should be \~~escaped\~~.
And here: foo\~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | tho\|ugh |

And here:

| here   | they   |
\| ---- \| ----- \|
| should | though |

And here:

here   | they
\---- \| ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   &lt;div>&lt;/div>
-   &lt;http&#x3A;google.com>
Characters that should be escaped in general:

\\ \` \* \[

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are \_escaped\_ unless they appear in_the_middle_of_a_word.

Ampersands are escaped only when they would otherwise start an entity:

-   &amp;copycat &amp;amp; &amp;#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should be escaped in URLs:

-   http&#x3A;//user:password@host:port/path?key=value#fragment
-   https&#x3A;//user:password@host:port/path?key=value#fragment

Double tildes should be \~~escaped\~~.
And here: foo\~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | tho\|ugh |

And here:

| here   | they   |
\| ---- \| ----- \|
| should | though |

And here:

here   | they
\---- \| ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   &lt;div>&lt;/div>
-   &lt;http&#x3A;google.com>
Characters that should be escaped in general:

\\ \` \* \[

Characters that shouldn't:

{}]()#+-.!>"$%',/:;=?@^~

Underscores are \_escaped\_ unless they appear in_the_middle_of_a_word.
or **_here**, or here__

Ampersands are escaped only when they would otherwise start an entity:

-   \&copycat \&amp; \&#x26
-   &amp;copycat &amp;amp; &amp;#x26
-   But: ©cat; `&between;` &foo; & AT&T &c

Open parenthesis should be escaped after a shortcut reference:

[ref]\(text)

And after a shortcut reference and a space (for GitHub):

[ref] \(text)

Hyphen should be escaped at the beginning of a line:

\- not a list item
\- not a list item
  \+ not a list item

Same for angle brackets:

\> not a block quote

And hash signs:

\# not a heading
  \## not a subheading

Text under a shortcut reference should be preserved verbatim:

-   [two*three]
-   [two\*three]
-   [a\a]
-   [a\\a]
-   [a\\\a]
-   [a_a\_a]

**GFM:**

Colon should be escaped in URLs:

-   http\://user:password@host:port/path?key=value#fragment
-   https\://user:password@host:port/path?key=value#fragment
-   http&colon;//user:password@host:port/path?key=value#fragment
-   https&colon;//user:password@host:port/path?key=value#fragment

Double tildes should be \~~escaped\~~.
And here: foo~~.

Pipes should not be escaped here: |

| here   | they     |
| ------ | -------- |
| should | tho\|ugh |

And here:

| here   | they   |
\| ---- \| ----- \|
| should | though |

And here:

here   | they
\---- \| ------
should | though

**Commonmark:**

Open angle bracket should be escaped:

-   \<div>\</div>
-   \<http\:google.com>
-   &lt;div>&lt;/div>
-   &lt;http&colon;google.com>
***This is strong and em.***

So is ***this*** word.

___This is strong and em.___

So is ___this___ word.
perform_complicated_task

do_this_and_do_that_and_another_thing

perform*complicated*task

do*this*and*do*that*and*another*thing
Foo **bar** __baz__.

Foo __bar__ **baz**.** bar **.


__ bar __.|Header 1|Header 2|
|--------|-------:|
|Cell 1  |  Cell 2|
|Cell 3  |  Cell 4|
| Header 1 | Header 2 |
| -------- | -------: |
| Cell 1   |   Cell 2 |
| Cell 3   |   Cell 4 |
| | a|c|
|--|:----:|:---|
|a|b|c|
|a|b|c|
| First | Second | third |
| ----- | ------ | ----- |
| first | second | third |
| first | second \| second | third \|
| first | second \\| third \\|
| first | second \\\| second | third \\\|
*   Unordered:

    | A | B |
    | - | - |
    | 1 | 2 |

*   Ordered:

    | A | B |
    | - | - |
    | 1 | 2 |
Missing alignment characters:

| a | b | c |
|   |---|---|
| d | e | f |

* * *

| a | b | c |
|---|---|   |
| d | e | f |

Invalid characters:

| a | b | c |
|---|-*-|---|
| d | e | f |
| Header 1 | Header 2 |
| -------- | -------- |
| Cell 1   | Cell 2   |
| Cell 3   | Cell 4   |
Header 1 | Header 2
-------- | --------
Cell 1   | Cell 2  
Cell 3   | Cell 4  
# Foo

| Name | GitHub | Twitter |
| ---- | ------ | ------- |
|foo|bar|
|-|-|
|1|2|This is a table:

| a |
| - |
| b |
This is a table:

| a | b | c |
| - | - | - |
| Header 1 | Header 2 |
| - | - |
| Cell 1 | Cell 2 |
| Cell 3 | Cell 4 |
| Header 1 | Header 2 |
| -------- | -------- |
| Cell 1   | Cell 2   |
| Cell 3   | Cell 4   |
| Heading 1 | **H**eading 2
| --------- | ---------
| Cell 1    | Cell 2
| Cell 3    | Cell 4

| Header 1 | Header 2 | Header 3 | Header 4 |
| :------: | -------: | :------- | -------- |
| Cell 1   | Cell 2   | Cell 3   | Cell 4   |
| Cell 5   | Cell 6   | Cell 7   | Cell 8   |

    Test code

Header 1 | Header 2
-------- | --------
Cell 1   | Cell 2
Cell 3   | Cell 4

Header 1|Header 2|Header 3|Header 4
:-------|:------:|-------:|--------
Cell 1  |Cell 2  |Cell 3  |Cell 4
*Cell 5*|Cell 6  |Cell 7  |Cell 8
Grave accent in cell:

| A            | B |
|--------------|---|
| <kbd>`</kbd> | C |

Escaped grave accent in inline code in cell (is not an escape):

| A   |
|-----|
| `\` |

“Empty” inline code:

| 1 | 2    | 3  |
|---|------|----|
| a |   `` |    |
| b |   `` | `` |
| c |    ` | `  |
| d |     `|`   |
| e | `\|` |    |
| f |   \| |    |
+	this is a list item
	indented with tabs

+   this is a list item
    indented with spaces

Code:

	this code block is indented by one tab

And:

		this code block is indented by two tabs

And:

	+	this is an example list item
		indented with tabs
	
	+   this is an example list item
	    indented with spaces
+	this is a list item
	indented with tabs

+   this is a list item
    indented with spaces

Code:

	this code block is indented by one tab

And:

		this code block is indented by two tabs

And:

	+	this is an example list item
		indented with tabs
	
	+   this is an example list item
	    indented with spaces
1. [ ] Mercury;
2. [] Venus (this one’s invalid);
3. [x] Earth:
    1. [x] Moon.
4. [ ] Mars;
8. [] Neptune (this one’s also invalid).
* [ ] Mercury;
* [] Venus (this one’s invalid);
* [x] Earth:
    * [x] Moon.
* [ ] Mars;
* [] Neptune (this one’s also invalid).
- [ ] Mercury;
- [] Venus (this one’s invalid);
- [x] Earth:
    - [x] Moon.
- [ ] Mars;
- [] Neptune (this one’s also invalid).
+ [ ] Mercury;
+ [] Venus (this one’s invalid);
+ [x] Earth:
    + [x] Moon.
+ [ ] Mars;
+ [] Neptune (this one’s also invalid).
Empty items
===========

* [ ]
* [	]

1. [x]
2. [X]

Single space
============

* [ ] 
* [	] 

1. [x] 
2. [X] 

Tab
===

* [ ]	
* [	]	

1. [x]	
2. [X]	

No white space with content
===========================

* [ ]Hello;
* [	]World;

1. [x]Foo.
2. [X]Bar

Single space with content
=========================

* [ ] Hello;
* [	] World;

1. [x] Foo.
2. [X] World :D

Single tab with content
=======================

* [ ]	Hello;
* [	]	World;

1. [x]	Foo.
2. [X]	Hello.

Multiple spaces with content
============================

* [ ]     Hello;
* [	]     World;

1. [x]    Foo.
3. [X]    Bar.

Multiple tabs with content
==========================

* [ ]		Hello;
* [	]		World;

1. [x]		Foo.
2. [X]		Bar.

Mixed tabs and spaces
=====================

* [ ] 	    Hello;

1. [x]	    World;

* [	]     	Hello;
* [ ]	   	World.

2. [X]	 	Bar.

Line breaks
===========

* [
] Hello;

1. [
] Hello;

Multiple unfinished characters
==============================

* [  ] Hello;

1. [ 
 ] World;
2. [		] Hello;
3. [ 	 ] World.
> A list within a blockquote:
> 
> *	asterisk 1
> *	asterisk 2
> *	asterisk 3
# Links

| Implementation | Characters | Nested | Mismatched | Escaped | Named Entities | Numbered Entities |
| -------------- | ---------- |------- | ---------- | ------- | -------------- | ----------------- |
| Markdown.pl    | `"`        | Yes    | Yes        | No      | Yes            | Yes               |
| GitHub         | `"`        | Yes    | Yes        | No      | No             | No                |
| CommonMark     | `"`        | No     | No         | Yes     | Yes            | Yes               |
| Markdown.pl    | `'`        | Yes    | Yes        | No      | Yes            | Yes               |
| GitHub         | `'`        | Yes    | Yes        | No      | No             | No                |
| CommonMark     | `'`        | No     | No         | Yes     | Yes            | Yes               |
| Markdown.pl    | `()`       | -      | -          | -       | -              | -                 |
| GitHub         | `()`       | -      | -          | -       | -              | -                 |
| CommonMark     | `()`       | No     | Yes        | Yes     | Yes            | Yes               |

## Double quotes

[Hello](./world.html "and text")

[Hello](./world.html "and "matching delimiters"")

[Hello](./world.html "and "mismatched delimiters")

[Hello](./world.html "and \"escapes\"")

[Hello](./world.html "and &quot;named entities&quot;")

[Hello](./world.html "and &#x22;numbered entities&#x22;")

## Single quotes

[Hello](./world.html 'and text')

[Hello](./world.html 'and 'matching delimiters'')

[Hello](./world.html 'and 'mismatched delimiters')

[Hello](./world.html 'and \'escapes\'')

[Hello](./world.html 'and &apos;named entities&apos;')

[Hello](./world.html 'and &#x27;numbered entities&#x27;')

## Parentheses

[Hello](./world.html (and text))

[Hello](./world.html (and (matching delimiters)))

[Hello](./world.html (and (mismatched delimiters))

[Hello](./world.html (and \(escapes\)))

[Hello](./world.html (and &lpar;named entities&rpar;))

[Hello](./world.html (and &#x28;numbered entities&#x29;))

# Images

## Double quotes

![Hello](./world.png "and text")

![Hello](./world.png "and "matching delimiters"")

![Hello](./world.png "and "mismatched delimiters")

![Hello](./world.png "and \"escapes\"")

![Hello](./world.png "and &quot;named entities&quot;")

![Hello](./world.png "and &#x22;numbered entities&#x22;")

## Single quotes

![Hello](./world.png 'and text')

![Hello](./world.png 'and 'matching delimiters'')

![Hello](./world.png 'and 'mismatched delimiters')

![Hello](./world.png 'and \'escapes\'')

![Hello](./world.png 'and &apos;named entities&apos;')

![Hello](./world.png 'and &#x27;numbered entities&#x27;')

## Parentheses

![Hello](./world.png (and text))

![Hello](./world.png (and (matching delimiters)))

![Hello](./world.png (and (mismatched delimiters))

![Hello](./world.png (and \(escapes\)))

![Hello](./world.png (and &lpar;named entities&rpar;))

![Hello](./world.png (and &#x28;numbered entities&#x29;))
hello world
    how are you
    how are you

hello world
```
how are you
```

hello world
* * *

hello world
# how are you

hello world
how are you
===========

hello world
> how are you

hello world
* how are you

hello world
<div>how are you</div>

hello world
<span>how are you</span>

hello [world][how]
[how]: /are/you

<div>hello</div>

<span>hello</span>
**hello** _world_

* hello world

**hello** _world_

* hello world

**hello** _world_

* Hello world

**hello** _world_

* hello world

{{meta {load_files: ["code/intro.js"]}}}

# Introduction

{{quote {author: "Ellen Ullman", title: "Close to the Machine: Technophilia and its Discontents", chapter: true}

We think we are creating the system for our own purposes. We believe
we are making it in our own image... But the computer is not really
like us. It is a projection of a very slim part of ourselves: that
portion devoted to logic, order, rule, and clarity.

quote}}

{{figure {url: "img/chapter_picture_00.jpg", alt: "Picture of a screwdriver and a circuit board", chapter: "framed"}}}

This is a book about instructing ((computer))s. Computers are about as
common as screwdrivers today, but they are quite a bit more complex,
and making them do what you want them to do isn't always easy.

If the task you have for your computer is a common, well-understood
one, such as showing you your email or acting like a calculator, you
can open the appropriate ((application)) and get to work. But for
unique or open-ended tasks, there probably is no application.

That is where ((programming)) may come in. _Programming_ is the act of
constructing a _program_—a set of precise instructions telling a
computer what to do. Because computers are dumb, pedantic beasts,
programming is fundamentally tedious and frustrating.

{{index [programming, "joy of"], speed}}

Fortunately, if you can get over that fact, and maybe even enjoy the rigor
of thinking in terms that dumb machines can deal with, programming can
be rewarding. It allows you to do things in seconds that would take
_forever_ by hand. It is a way to make your computer tool
do things that it couldn't do before. And it provides a wonderful
exercise in abstract thinking.

Most programming is done with ((programming language))s. A _programming
language_ is an artificially constructed language used to instruct
computers. It is interesting that the most effective way we've found
to communicate with a computer borrows so heavily from the way we
communicate with each other. Like human languages, computer languages
allow words and phrases to be combined in new ways, making it possible to
express ever new concepts.

{{index [JavaScript, "availability of"], "casual computing"}}

At one point language-based interfaces, such as the BASIC and DOS
prompts of the 1980s and 1990s, were the main method of interacting with
computers. They have largely been replaced with visual interfaces,
which are easier to learn but offer less freedom. Computer languages
are still there, if you know where to look. One such language,
JavaScript, is built into every modern web ((browser)) and is thus
available on almost every device.

{{indexsee "web browser", browser}}

This book will try to make you familiar enough with this language to
do useful and amusing things with it.

## On programming

{{index [programming, "difficulty of"]}}

Besides explaining JavaScript, I will introduce the basic
principles of programming. Programming, it turns out, is hard. The
fundamental rules are simple and clear, but programs built on top of
these rules tend to become complex enough to introduce their own rules
and complexity. You're building your own maze, in a way, and you might
just get lost in it.

{{index learning}}

There will be times when reading this book feels terribly frustrating.
If you are new to programming, there will be a lot of new material to
digest. Much of this material will then be _combined_ in ways that
require you to make additional connections.

It is up to you to make the necessary effort. When you are struggling
to follow the book, do not jump to any conclusions about your own
capabilities. You are fine—you just need to keep at it. Take a break,
reread some material, and make sure you read and understand the
example programs and ((exercises)). Learning is hard work, but
everything you learn is yours and will make subsequent learning
easier.

{{quote {author: "Ursula K. Le Guin", title: "The Left Hand of Darkness"}

{{index "Le Guin, Ursula K."}}

When action grows unprofitable, gather information; when information
grows unprofitable, sleep.

quote}}

{{index [program, "nature of"], data}}

A program is many things. It is a piece of text typed by a programmer,
it is the directing force that makes the computer do what it does, it
is data in the computer's memory, yet it controls the actions
performed on this same memory. Analogies that try to compare programs
to objects we are familiar with tend to fall short. A superficially
fitting one is that of a machine—lots of separate parts tend to be
involved, and to make the whole thing tick, we have to consider the
ways in which these parts interconnect and contribute to the operation
of the whole.

A ((computer)) is a physical machine that acts as a host for these immaterial
machines. Computers themselves can do only stupidly straightforward
things. The reason they are so useful is that they do these things at
an incredibly high ((speed)). A program can ingeniously combine an
enormous number of these simple actions to do very
complicated things.

{{index [programming, "joy of"]}}

A program is a building of thought. It is costless to build, it is
weightless, and it grows easily under our typing hands.

But without care, a program's size and ((complexity)) will grow out of
control, confusing even the person who created it. Keeping programs
under control is the main problem of programming. When a program
works, it is beautiful. The art of programming is the skill of
controlling complexity. The great program is subdued—made simple in
its complexity.

{{index "programming style", "best practices"}}

Some programmers believe that this complexity is best managed by using
only a small set of well-understood techniques in their programs. They
have composed strict rules ("best practices") prescribing the form
programs should have and carefully stay within their safe little
zone.

{{index experiment}}

This is not only boring, it is ineffective. New problems often
require new solutions. The field of programming is young and still
developing rapidly, and it is varied enough to have room for wildly
different approaches. There are many terrible mistakes to make in
program design, and you should go ahead and make them so that you
understand them. A sense of what a good program looks like is
developed in practice, not learned from a list of rules.

## Why language matters

{{index "programming language", "machine code", "binary data"}}

In the beginning, at the birth of computing, there were no programming
languages. Programs looked something like this:

```{lang: null}
00110001 00000000 00000000
00110001 00000001 00000001
00110011 00000001 00000010
01010001 00001011 00000010
00100010 00000010 00001000
01000011 00000001 00000000
01000001 00000001 00000001
00010000 00000010 00000000
01100010 00000000 00000000
```

{{index [programming, "history of"], "punch card", complexity}}

That is a program to add the numbers from 1 to 10 together and print
out the result: `1 + 2 + ... + 10 = 55`. It could run on a simple,
hypothetical machine. To program early computers, it was necessary to
set large arrays of switches in the right position or punch holes in
strips of cardboard and feed them to the computer. You can probably
imagine how tedious and error-prone this procedure was. Even writing
simple programs required much cleverness and discipline. Complex ones
were nearly inconceivable.

{{index bit, "wizard (mighty)"}}

Of course, manually entering these arcane patterns of bits (the ones
and zeros) did give the programmer a profound sense of being a mighty
wizard. And that has to be worth something in terms of job
satisfaction.

{{index memory, instruction}}

Each line of the previous program contains a single instruction. It
could be written in English like this:

 1. Store the number 0 in memory location 0.
 2. Store the number 1 in memory location 1.
 3. Store the value of memory location 1 in memory location 2.
 4. Subtract the number 11 from the value in memory location 2.
 5. If the value in memory location 2 is the number 0,
    continue with instruction 9.
 6. Add the value of memory location 1 to memory location 0.
 7. Add the number 1 to the value of memory location 1.
 8. Continue with instruction 3.
 9. Output the value of memory location 0.

{{index readability, naming, binding}}

Although that is already more readable than the soup of bits, it is
still rather obscure. Using names instead of numbers for the
instructions and memory locations helps.

```{lang: "text/plain"}
 Set “total” to 0.
 Set “count” to 1.
[loop]
 Set “compare” to “count”.
 Subtract 11 from “compare”.
 If “compare” is zero, continue at [end].
 Add “count” to “total”.
 Add 1 to “count”.
 Continue at [loop].
[end]
 Output “total”.
```

{{index loop, jump, "summing example"}}

Can you see how the program works at this point? The first two lines
give two memory locations their starting values: `total` will be used
to build up the result of the computation, and `count` will keep track
of the number that we are currently looking at. The lines using
`compare` are probably the weirdest ones. The program wants to see
whether `count` is equal to 11 to decide whether it can stop
running. Because our hypothetical machine is rather primitive, it can
only test whether a number is zero and make a decision based
on that. So it uses the memory location labeled `compare` to compute
the value of `count - 11` and makes a decision based on that value.
The next two lines add the value of `count` to the result and
increment `count` by 1 every time the program has decided that `count`
is not 11 yet.

Here is the same program in JavaScript:

```
let total = 0, count = 1;
while (count <= 10) {
  total += count;
  count += 1;
}
console.log(total);
// → 55
```

{{index "while loop", loop, [braces, block]}}

This version gives us a few more improvements. Most important, there
is no need to specify the way we want the program to jump back and
forth anymore. The `while` construct takes care of that. It continues
executing the block (wrapped in braces) below it as long as the
condition it was given holds. That condition is `count <= 10`, which
means “_count_ is less than or equal to 10”. We no longer have to
create a temporary value and compare that to zero, which was just an
uninteresting detail. Part of the power of programming languages is
that they can take care of uninteresting details for us.

{{index "console.log"}}

At the end of the program, after the `while` construct has finished,
the `console.log` operation is used to write out the result.

{{index "sum function", "range function", abstraction, function}}

Finally, here is what the program could look like if we happened to
have the convenient operations `range` and `sum` available, which
respectively create a ((collection)) of numbers within a range and
compute the sum of a collection of numbers:

```{startCode: true}
console.log(sum(range(1, 10)));
// → 55
```

{{index readability}}

The moral of this story is that the same program can be expressed in
both long and short, unreadable and readable ways. The first version of the
program was extremely obscure, whereas this last one is almost
English: `log` the `sum` of the `range` of numbers from 1 to 10. (We
will see in [later chapters](data) how to define operations like `sum`
and `range`.)

{{index ["programming language", "power of"], composability}}

A good programming language helps the programmer by allowing them to
talk about the actions that the computer has to perform on a higher
level. It helps omit details, provides convenient building blocks
(such as `while` and `console.log`), allows you to define your own
building blocks (such as `sum` and `range`), and makes those blocks
easy to compose.

## What is JavaScript?

{{index history, Netscape, browser, "web application", JavaScript, [JavaScript, "history of"], "World Wide Web"}}

{{indexsee WWW, "World Wide Web"}}

{{indexsee Web, "World Wide Web"}}

JavaScript was introduced in 1995 as a way to add programs to web
pages in the Netscape Navigator browser. The language has since been
adopted by all other major graphical web browsers. It has made modern
web applications possible—applications with which you can interact
directly without doing a page reload for every action. JavaScript is also
used in more traditional websites to provide various forms of
interactivity and cleverness.

{{index Java, naming}}

It is important to note that JavaScript has almost nothing to do with
the programming language named Java. The similar name was inspired by
marketing considerations rather than good judgment. When JavaScript
was being introduced, the Java language was being heavily marketed and
was gaining popularity. Someone thought it was a good idea to try to
ride along on this success. Now we are stuck with the name.

{{index ECMAScript, compatibility}}

After its adoption outside of Netscape, a ((standard)) document was
written to describe the way the JavaScript language should work so
that the various pieces of software that claimed to support JavaScript
were actually talking about the same language. This is called the
ECMAScript standard, after the Ecma International organization that
did the standardization. In practice, the terms ECMAScript and
JavaScript can be used interchangeably—they are two names for the same
language.

{{index [JavaScript, "weaknesses of"], debugging}}

There are those who will say _terrible_ things about JavaScript. Many
of these things are true. When I was required to write something in
JavaScript for the first time, I quickly came to despise it. It would
accept almost anything I typed but interpret it in a way that was
completely different from what I meant. This had a lot to do with the
fact that I did not have a clue what I was doing, of course, but there
is a real issue here: JavaScript is ridiculously liberal in what it
allows. The idea behind this design was that it would make programming
in JavaScript easier for beginners. In actuality, it mostly makes
finding problems in your programs harder because the system will not
point them out to you.

{{index [JavaScript, "flexibility of"], flexibility}}

This flexibility also has its advantages, though. It leaves space for
a lot of techniques that are impossible in more rigid languages, and
as you will see (for example in [Chapter ?](modules)), it can be used
to overcome some of JavaScript's shortcomings. After ((learning)) the
language properly and working with it for a while, I have learned to
actually _like_ JavaScript.

{{index future, [JavaScript, "versions of"], ECMAScript, "ECMAScript 6"}}

There have been several versions of JavaScript. ECMAScript version 3
was the widely supported version in the time of JavaScript's ascent to
dominance, roughly between 2000 and 2010. During this time, work was
underway on an ambitious version 4, which planned a number of radical
improvements and extensions to the language. Changing a living, widely
used language in such a radical way turned out to be politically
difficult, and work on the version 4 was abandoned in 2008, leading to
a much less ambitious version 5, which made only some uncontroversial
improvements, coming out in 2009. Then in 2015 version 6 came out, a
major update that included some of the ideas planned for version 4.
Since then we've had new, small updates every year.

The fact that the language is evolving means that browsers have to
constantly keep up, and if you're using an older browser, it may not
support every feature. The language designers are careful to not make
any changes that could break existing programs, so new browsers can
still run old programs. In this book, I'm using the 2017 version of
JavaScript.

{{index [JavaScript, "uses of"]}}

Web browsers are not the only platforms on which JavaScript is used.
Some databases, such as MongoDB and CouchDB, use JavaScript as their
scripting and query language. Several platforms for desktop and server
programming, most notably the ((Node.js)) project (the subject of
[Chapter ?](node)), provide an environment for programming JavaScript
outside of the browser.

## Code, and what to do with it

{{index "reading code", "writing code"}}

_Code_ is the text that makes up programs. Most chapters in this book
contain quite a lot of code. I believe reading code and writing ((code))
are indispensable parts of ((learning)) to program. Try to not just
glance over the examples—read them attentively and understand them.
This may be slow and confusing at first, but I promise that you'll
quickly get the hang of it. The same goes for the ((exercises)). Don't
assume you understand them until you've actually written a working
solution.

{{index interpretation}}

I recommend you try your solutions to exercises in an actual
JavaScript interpreter. That way, you'll get immediate feedback on
whether what you are doing is working, and, I hope, you'll be tempted
to ((experiment)) and go beyond the exercises.

{{if interactive

When reading this book in your browser, you can edit (and run) all
example programs by clicking them.

if}}

{{if book

{{index download, sandbox, "running code"}}

The easiest way to run the example code in the book, and to experiment
with it, is to look it up in the online version of the book at
[_https://eloquentjavascript.net_](https://eloquentjavascript.net/). There,
you can click any code example to edit and run it and to see the
output it produces. To work on the exercises, go to
[_https://eloquentjavascript.net/code_](https://eloquentjavascript.net/code),
which provides starting code for each coding exercise and allows you
to look at the solutions.

if}}

{{index "developer tools", "JavaScript console"}}

If you want to run the programs defined in this book outside of the
book's website, some care will be required. Many examples stand on their
own and should work in any JavaScript environment. But code in later
chapters is often written for a specific environment (the browser or
Node.js) and can run only there. In addition, many chapters define
bigger programs, and the pieces of code that appear in them depend on
each other or on external files. The
[sandbox](https://eloquentjavascript.net/code) on the website provides
links to Zip files containing all the scripts and data files
necessary to run the code for a given chapter.

## Overview of this book

This book contains roughly three parts. The first 12 chapters discuss
the JavaScript language. The next seven chapters are about web
((browsers)) and the way JavaScript is used to program them. Finally,
two chapters are devoted to ((Node.js)), another environment to
program JavaScript in.

Throughout the book, there are five _project chapters_, which describe
larger example programs to give you a taste of actual programming. In
order of appearance, we will work through building a [delivery
robot](robot), a [programming language](language), a [platform
game](game), a [pixel paint program](paint), and a [dynamic
website](skillsharing).

The language part of the book starts with four chapters that introduce
the basic structure of the JavaScript language. They introduce
[control structures](program_structure) (such as the `while` word you
saw in this introduction), [functions](functions) (writing your own
building blocks), and [data structures](data). After these, you will
be able to write basic programs. Next, Chapters [?](higher_order) and
[?](object) introduce techniques to use functions and objects to write
more _abstract_ code and keep complexity under control.

After a [first project chapter](robot), the language part of the book
continues with chapters on [error handling and bug fixing](error),
[regular expressions](regexp) (an important tool for working with
text), [modularity](modules) (another defense against complexity), and
[asynchronous programming](async) (dealing with events that take
time). The [second project chapter](language) concludes the first part
of the book.

The second part, Chapters [?](browser) to [?](paint), describes the
tools that browser JavaScript has access to. You'll learn to display
things on the screen (Chapters [?](dom) and [?](canvas)), respond to
user input ([Chapter ?](event)), and communicate over the network
([Chapter ?](http)). There are again two project chapters in this
part.

After that, [Chapter ?](node) describes Node.js, and [Chapter
?](skillsharing) builds a small website using that tool.

{{if commercial

Finally, [Chapter ?](fast) describes some of the considerations that
come up when optimizing JavaScript programs for speed.

if}}

## Typographic conventions

{{index "factorial function"}}

In this book, text written in a `monospaced` font will represent
elements of programs—sometimes they are self-sufficient fragments, and
sometimes they just refer to part of a nearby program. Programs (of
which you have already seen a few) are written as follows:

```
function factorial(n) {
  if (n == 0) {
    return 1;
  } else {
    return factorial(n - 1) * n;
  }
}
```

{{index "console.log"}}

Sometimes, to show the output that a program produces, the
expected output is written after it, with two slashes and an arrow in
front.

```
console.log(factorial(8));
// → 40320
```

Good luck!
{{meta {docid: values}}}

# Values, Types, and Operators

{{quote {author: "Master Yuan-Ma", title: "The Book of Programming", chapter: true}

Below the surface of the machine, the program moves. Without effort,
it expands and contracts. In great harmony, electrons scatter and
regroup. The forms on the monitor are but ripples on the water. The
essence stays invisibly below.

quote}}

{{index "Yuan-Ma", "Book of Programming"}}

{{figure {url: "img/chapter_picture_1.jpg", alt: "Picture of a sea of bits", chapter: framed}}}

{{index "binary data", data, bit, memory}}

Inside the computer's world, there is only data. You can read data,
modify data, create new data—but that which isn't data cannot be
mentioned. All this data is stored as long sequences of bits and is
thus fundamentally alike.

{{index CD, signal}}

_Bits_ are any kind of two-valued things, usually described as zeros and
ones. Inside the computer, they take forms such as a high or low
electrical charge, a strong or weak signal, or a shiny or dull spot on
the surface of a CD. Any piece of discrete information can be reduced
to a sequence of zeros and ones and thus represented in bits.

{{index "binary number", radix, "decimal number"}}

For example, we can express the number 13 in bits. It works the same
way as a decimal number, but instead of 10 different ((digit))s, you
have only 2, and the weight of each increases by a factor of 2 from
right to left. Here are the bits that make up the number 13, with the
weights of the digits shown below them:

```{lang: null}
   0   0   0   0   1   1   0   1
 128  64  32  16   8   4   2   1
```

So that's the binary number 00001101. Its non-zero digits stand for
8, 4, and 1, and add up to 13.

## Values

{{index [memory, organization], "volatile data storage", "hard drive"}}

Imagine a sea of bits—an ocean of them. A typical modern computer has
more than 30 billion bits in its volatile data storage (working
memory). Nonvolatile storage (the hard disk or equivalent) tends to
have yet a few orders of magnitude more.

To be able to work with such quantities of bits without getting lost,
we must separate them into chunks that represent pieces of
information. In a JavaScript environment, those chunks are called
_((value))s_. Though all values are made of bits, they play different
roles. Every value has a ((type)) that determines its role. Some
values are numbers, some values are pieces of text, some values are
functions, and so on.

{{index "garbage collection"}}

To create a value, you must merely invoke its name. This is
convenient. You don't have to gather building material for your values
or pay for them. You just call for one, and _whoosh_, you have it. They
are not really created from thin air, of course. Every value has to be
stored somewhere, and if you want to use a gigantic amount of them at
the same time, you might run out of memory. Fortunately, this is a
problem only if you need them all simultaneously. As soon as you no
longer use a value, it will dissipate, leaving behind its bits to be
recycled as building material for the next generation of values.

This chapter introduces the atomic elements of JavaScript programs,
that is, the simple value types and the operators that can act on such
values.

## Numbers

{{index [syntax, number], number, [number, notation]}}

Values of the _number_ type are, unsurprisingly, numeric values. In a
JavaScript program, they are written as follows:

```
13
```

{{index "binary number"}}

Use that in a program, and it will cause the bit pattern for the
number 13 to come into existence inside the computer's memory.

{{index [number, representation], bit}}

JavaScript uses a fixed number of bits, 64 of them, to store a
single number value. There are only so many patterns you can make with
64 bits, which means that the number of different numbers that can be
represented is limited. With _N_ decimal ((digit))s, you can represent
10^N^ numbers. Similarly, given 64 binary
digits, you can represent 2^64^ different numbers, which is about 18
quintillion (an 18 with 18 zeros after it). That's a lot.

Computer memory used to be much smaller, and people tended to use
groups of 8 or 16 bits to represent their numbers. It was easy to
accidentally _((overflow))_ such small numbers—to end up with a number
that did not fit into the given number of bits. Today, even computers
that fit in your pocket have plenty of memory, so you are free to use
64-bit chunks, and you need to worry about overflow only when dealing
with truly astronomical numbers.

{{index sign, "floating-point number", "sign bit"}}

Not all whole numbers less than 18 quintillion fit in a JavaScript number,
though. Those bits also store negative numbers, so one bit indicates
the sign of the number. A bigger issue is that nonwhole numbers must
also be represented. To do this, some of the bits are used to store
the position of the decimal point. The actual maximum whole number
that can be stored is more in the range of 9 quadrillion (15
zeros)—which is still pleasantly huge.

{{index [number, notation], "fractional number"}}

Fractional numbers are written by using a dot.

```
9.81
```

{{index exponent, "scientific notation", [number, notation]}}

For very big or very small numbers, you may also use scientific
notation by adding an _e_ (for _exponent_), followed by the exponent
of the number.

```
2.998e8
```

That is 2.998 × 10^8^ = 299,800,000.

{{index pi, [number, "precision of"], "floating-point number"}}

Calculations with whole numbers (also called _((integer))s_) smaller
than the aforementioned 9 quadrillion are guaranteed to always be
precise. Unfortunately, calculations with fractional numbers are
generally not. Just as π (pi) cannot be precisely expressed by a
finite number of decimal digits, many numbers lose some precision when
only 64 bits are available to store them. This is a shame, but it
causes practical problems only in specific situations. The important
thing is to be aware of it and treat fractional digital numbers as
approximations, not as precise values.

### Arithmetic

{{index [syntax, operator], operator, "binary operator", arithmetic, addition, multiplication}}

The main thing to do with numbers is arithmetic. Arithmetic operations
such as addition or multiplication take two number values and produce
a new number from them. Here is what they look like in JavaScript:

```
100 + 4 * 11
```

{{index [operator, application], asterisk, "plus character", "* operator", "+ operator"}}

The `+` and `*` symbols are called _operators_. The first stands for
addition, and the second stands for multiplication. Putting an
operator between two values will apply it to those values and produce
a new value.

{{index grouping, parentheses, precedence}}

But does the example mean "add 4 and 100, and multiply the result by 11,"
or is the multiplication done before the adding? As you might have
guessed, the multiplication happens first. But as in mathematics, you
can change this by wrapping the addition in parentheses.

```
(100 + 4) * 11
```

{{index "hyphen character", "slash character", division, subtraction, minus, "- operator", "/ operator"}}

For subtraction, there is the `-` operator, and division can be done
with the `/` operator.

When operators appear together without parentheses, the order in which
they are applied is determined by the _((precedence))_ of the
operators. The example shows that multiplication comes before
addition. The `/` operator has the same precedence as `*`. Likewise
for `+` and `-`. When multiple operators with the same precedence
appear next to each other, as in `1 - 2 + 1`, they are applied left to
right: `(1 - 2) + 1`.

These rules of precedence are not something you should worry about.
When in doubt, just add parentheses.

{{index "modulo operator", division, "remainder operator", "% operator"}}

There is one more arithmetic operator, which you might not immediately
recognize. The `%` symbol is used to represent the _remainder_
operation. `X % Y` is the remainder of dividing `X` by `Y`. For
example, `314 % 100` produces `14`, and `144 % 12` gives `0`.
The remainder operator's precedence is the same as that of multiplication and
division. You'll also often see this operator referred to as _modulo_.

### Special numbers

{{index [number, "special values"]}}

There are three special values in JavaScript that are considered
numbers but don't behave like normal numbers.

{{index infinity}}

The first two are `Infinity` and `-Infinity`, which represent the
positive and negative infinities. `Infinity - 1` is still `Infinity`,
and so on. Don't put too much trust in infinity-based computation,
though. It isn't mathematically sound, and it will quickly lead to the
next special number: `NaN`.

{{index NaN, "not a number", "division by zero"}}

`NaN` stands for "not a number", even though it _is_ a value of the
number type. You'll get this result when you, for example, try to
calculate `0 / 0` (zero divided by zero), `Infinity - Infinity`, or
any number of other numeric operations that don't yield a meaningful
result.

## Strings

{{indexsee "grave accent", backtick}}

{{index [syntax, string], text, character, [string, notation], "single-quote character", "double-quote character", "quotation mark", backtick}}

The next basic data type is the _((string))_. Strings are used to
represent text. They are written by enclosing their content in quotes.

```
`Down on the sea`
"Lie on the ocean"
'Float on the ocean'
```

You can use single quotes, double quotes, or backticks to mark
strings, as long as the quotes at the start and the end of the string
match.

{{index "line break", "newline character"}}

Almost anything can be put between quotes, and JavaScript will make a
string value out of it. But a few characters are more difficult. You
can imagine how putting quotes between quotes might be hard.
_Newlines_ (the characters you get when you press [enter]{keyname}) can be
included without escaping only when the string is quoted with backticks
(`` ` ``).

{{index [escaping, "in strings"], ["backslash character", "in strings"]}}

To make it possible to include such characters in a string, the
following notation is used: whenever a backslash (`\`) is found inside
quoted text, it indicates that the character after it has a special
meaning. This is called _escaping_ the character. A quote that is
preceded by a backslash will not end the string but be part of it.
When an `n` character occurs after a backslash, it is interpreted as a
newline. Similarly, a `t` after a backslash means a ((tab character)).
Take the following string:

```
"This is the first line\nAnd this is the second"
```

The actual text contained is this:

```{lang: null}
This is the first line
And this is the second
```

There are, of course, situations where you want a backslash in a
string to be just a backslash, not a special code. If two backslashes
follow each other, they will collapse together, and only one will be
left in the resulting string value. This is how the string "_A newline
character is written like `"`\n`"`._" can be expressed:

```
"A newline character is written like \"\\n\"."
```

{{id unicode}}

{{index [string, representation], Unicode, character}}

Strings, too, have to be modeled as a series of bits to be able to
exist inside the computer. The way JavaScript does this is based on
the _((Unicode))_ standard. This standard assigns a number to
virtually every character you would ever need, including characters
from Greek, Arabic, Japanese, Armenian, and so on. If we have a number
for every character, a string can be described by a sequence of
numbers.

{{index "UTF-16", emoji}}

And that's what JavaScript does. But there's a complication:
JavaScript's representation uses 16 bits per string element, which can
describe up to 2^16^ different characters. But Unicode defines more
characters than that—about twice as many, at this point. So some
characters, such as many emoji, take up two "character positions" in
JavaScript strings. We'll come back to this in [Chapter
?](higher_order#code_units).

{{index "+ operator", concatenation}}

Strings cannot be divided, multiplied, or subtracted, but the `+`
operator _can_ be used on them. It does not add, but it
_concatenates_—it glues two strings together. The following line will
produce the string `"concatenate"`:

```
"con" + "cat" + "e" + "nate"
```

String values have a number of associated functions (_methods_) that
can be used to perform other operations on them. I'll say more about
these in [Chapter ?](data#methods).

{{index interpolation, backtick}}

Strings written with single or double quotes behave very much the
same—the only difference is in which type of quote you need to escape
inside of them. Backtick-quoted strings, usually called _((template
literals))_, can do a few more tricks. Apart from being able to span
lines, they can also embed other values.

```
`half of 100 is ${100 / 2}`
```

When you write something inside `${}` in a template literal, its
result will be computed, converted to a string, and included at that
position. The example produces "_half of 100 is 50_".

## Unary operators

{{index operator, "typeof operator", type}}

Not all operators are symbols. Some are written as words. One example
is the `typeof` operator, which produces a string value naming the
type of the value you give it.

```
console.log(typeof 4.5)
// → number
console.log(typeof "x")
// → string
```

{{index "console.log", output, "JavaScript console"}}

{{id "console.log"}}

We will use `console.log` in example code to indicate that we want to
see the result of evaluating something. More about that in the [next
chapter](program_structure).

{{index negation, "- operator", "binary operator", "unary operator"}}

The other operators shown all operated on two values, but `typeof`
takes only one. Operators that use two values are called _binary_
operators, while those that take one are called _unary_ operators. The
minus operator can be used both as a binary operator and as a unary
operator.

```
console.log(- (10 - 2))
// → -8
```

## Boolean values

{{index Boolean, operator, true, false, bit}}

It is often useful to have a value that distinguishes between only two
possibilities, like "yes" and "no" or "on" and "off". For this
purpose, JavaScript has a _Boolean_ type, which has just two values,
true and false, which are written as those words.

### Comparison

{{index comparison}}

Here is one way to produce Boolean values:

```
console.log(3 > 2)
// → true
console.log(3 < 2)
// → false
```

{{index [comparison, "of numbers"], "> operator", "< operator", "greater than", "less than"}}

The `>` and `<` signs are the traditional symbols for "is greater
than" and "is less than", respectively. They are binary operators.
Applying them results in a Boolean value that indicates whether they
hold true in this case.

Strings can be compared in the same way.

```
console.log("Aardvark" < "Zoroaster")
// → true
```

{{index [comparison, "of strings"]}}

The way strings are ordered is roughly alphabetic but not really what
you'd expect to see in a dictionary: uppercase letters are always
"less" than lowercase ones, so `"Z" < "a"`, and nonalphabetic
characters (!, -, and so on) are also included in the ordering. When
comparing strings, JavaScript goes over the characters from left to
right, comparing the ((Unicode)) codes one by one.

{{index equality, ">= operator", "<= operator", "== operator", "!= operator"}}

Other similar operators are `>=` (greater than or equal to), `<=`
(less than or equal to), `==` (equal to), and `!=` (not equal to).

```
console.log("Itchy" != "Scratchy")
// → true
console.log("Apple" == "Orange")
// → false
```

{{index [comparison, "of NaN"], NaN}}

There is only one value in JavaScript that is not equal to itself, and
that is `NaN` ("not a number").

```
console.log(NaN == NaN)
// → false
```

`NaN` is supposed to denote the result of a nonsensical computation,
and as such, it isn't equal to the result of any _other_ nonsensical
computations.

### Logical operators

{{index reasoning, "logical operators"}}

There are also some operations that can be applied to Boolean values
themselves. JavaScript supports three logical operators: _and_, _or_,
and _not_. These can be used to "reason" about Booleans.

{{index "&& operator", "logical and"}}

The `&&` operator represents logical _and_. It is a binary operator,
and its result is true only if both the values given to it are true.

```
console.log(true && false)
// → false
console.log(true && true)
// → true
```

{{index "|| operator", "logical or"}}

The `||` operator denotes logical _or_. It produces true if either of
the values given to it is true.

```
console.log(false || true)
// → true
console.log(false || false)
// → false
```

{{index negation, "! operator"}}

_Not_ is written as an exclamation mark (`!`). It is a unary operator
that flips the value given to it—`!true` produces `false`, and `!false`
gives `true`.

{{index precedence}}

When mixing these Boolean operators with arithmetic and other
operators, it is not always obvious when parentheses are needed. In
practice, you can usually get by with knowing that of the operators we
have seen so far, `||` has the lowest precedence, then comes `&&`,
then the comparison operators (`>`, `==`, and so on), and then the
rest. This order has been chosen such that, in typical expressions
like the following one, as few parentheses as possible are necessary:

```
1 + 1 == 2 && 10 * 10 > 50
```

{{index "conditional execution", "ternary operator", "?: operator", "conditional operator", "colon character", "question mark"}}

The last logical operator I will discuss is not unary, not binary, but
_ternary_, operating on three values. It is written with a question
mark and a colon, like this:

```
console.log(true ? 1 : 2);
// → 1
console.log(false ? 1 : 2);
// → 2
```

This one is called the _conditional_ operator (or sometimes just
the _ternary_ operator since it is the only such operator in the
language). The value on the left of the question mark "picks" which of
the other two values will come out. When it is true, it chooses the
middle value, and when it is false, it chooses the value on the right.

## Empty values

{{index undefined, null}}

There are two special values, written `null` and `undefined`, that are
used to denote the absence of a _meaningful_ value. They are
themselves values, but they carry no information.

Many operations in the language that don't produce a meaningful value
(you'll see some later) yield `undefined` simply because they have to
yield _some_ value.

The difference in meaning between `undefined` and `null` is an accident
of JavaScript's design, and it doesn't matter most of the time. In cases
where you actually have to concern yourself with these values, I
recommend treating them as mostly interchangeable.

## Automatic type conversion

{{index NaN, "type coercion"}}

In the Introduction, I mentioned that JavaScript goes out of its way
to accept almost any program you give it, even programs that do odd
things. This is nicely demonstrated by the following expressions:

```
console.log(8 * null)
// → 0
console.log("5" - 1)
// → 4
console.log("5" + 1)
// → 51
console.log("five" * 2)
// → NaN
console.log(false == 0)
// → true
```

{{index "+ operator", arithmetic, "* operator", "- operator"}}

When an operator is applied to the "wrong" type of value, JavaScript
will quietly convert that value to the type it needs, using a set of
rules that often aren't what you want or expect. This is called
_((type coercion))_. The `null` in the first expression becomes `0`,
and the `"5"` in the second expression becomes `5` (from string to
number). Yet in the third expression, `+` tries string concatenation
before numeric addition, so the `1` is converted to `"1"` (from number
to string).

{{index "type coercion", [number, "conversion to"]}}

When something that doesn't map to a number in an obvious way (such as
`"five"` or `undefined`) is converted to a number, you get the value
`NaN`. Further arithmetic operations on `NaN` keep producing `NaN`, so
if you find yourself getting one of those in an unexpected place, look
for accidental type conversions.

{{index null, undefined, [comparison, "of undefined values"], "== operator"}}

When comparing values of the same type using `==`, the outcome is easy
to predict: you should get true when both values are the same, except
in the case of `NaN`. But when the types differ, JavaScript uses a
complicated and confusing set of rules to determine what to do. In
most cases, it just tries to convert one of the values to the other
value's type. However, when `null` or `undefined` occurs on either
side of the operator, it produces true only if both sides are one of
`null` or `undefined`.

```
console.log(null == undefined);
// → true
console.log(null == 0);
// → false
```

That behavior is often useful. When you want to test whether a value
has a real value instead of `null` or `undefined`, you can compare it
to `null` with the `==` (or `!=`) operator.

{{index "type coercion", [Boolean, "conversion to"], "=== operator", "!== operator", comparison}}

But what if you want to test whether something refers to the precise
value `false`? Expressions like `0 == false` and `"" == false` are
also true because of automatic type conversion. When you do _not_ want
any type conversions to happen, there are two additional operators:
`===` and `!==`. The first tests whether a value is _precisely_ equal
to the other, and the second tests whether it is not precisely equal.
So `"" === false` is false as expected.

I recommend using the three-character comparison operators defensively to
prevent unexpected type conversions from tripping you up. But when you're
certain the types on both sides will be the same, there is no problem with
using the shorter operators.

### Short-circuiting of logical operators

{{index "type coercion", [Boolean, "conversion to"], operator}}

The logical operators `&&` and `||` handle values of different types
in a peculiar way. They will convert the value on their left side to
Boolean type in order to decide what to do, but depending on the
operator and the result of that conversion, they will return either the
_original_ left-hand value or the right-hand value.

{{index "|| operator"}}

The `||` operator, for example, will return the value to its left when
that can be converted to true and will return the value on its right
otherwise. This has the expected effect when the values are Boolean
and does something analogous for values of other types.

```
console.log(null || "user")
// → user
console.log("Agnes" || "user")
// → Agnes
```

{{index "default value"}}

We can use this functionality as a way to fall back on a default
value. If you have a value that might be empty, you can put `||` after
it with a replacement value. If the initial value can be converted to
false, you'll get the replacement instead. The rules for converting
strings and numbers to Boolean values state that `0`, `NaN`, and the
empty string (`""`) count as `false`, while all the other values count
as `true`. So `0 || -1` produces `-1`, and `"" || "!?"` yields `"!?"`.

{{index "&& operator"}}

The `&&` operator works similarly but the other way around. When the
value to its left is something that converts to false, it returns that
value, and otherwise it returns the value on its right.

Another important property of these two operators is that the part to
their right is evaluated only when necessary. In the case of `true ||
X`, no matter what `X` is—even if it's a piece of program that does
something _terrible_—the result will be true, and `X` is never
evaluated. The same goes for `false && X`, which is false and will
ignore `X`. This is called _((short-circuit evaluation))_.

{{index "ternary operator", "?: operator", "conditional operator"}}

The conditional operator works in a similar way. Of the second and
third values, only the one that is selected is evaluated.

## Summary

We looked at four types of JavaScript values in this chapter: numbers,
strings, Booleans, and undefined values.

Such values are created by typing in their name (`true`, `null`) or
value (`13`, `"abc"`). You can combine and transform values with
operators. We saw binary operators for arithmetic (`+`, `-`, `*`, `/`,
and `%`), string concatenation (`+`), comparison (`==`, `!=`, `===`,
`!==`, `<`, `>`, `<=`, `>=`), and logic (`&&`, `||`), as well as
several unary operators (`-` to negate a number, `!` to negate
logically, and `typeof` to find a value's type) and a ternary operator
(`?:`) to pick one of two values based on a third value.

This gives you enough information to use JavaScript as a pocket
calculator but not much more. The [next
chapter](program_structure) will start tying
these expressions together into basic programs.
# Program Structure

{{quote {author: "_why", title: "Why's (Poignant) Guide to Ruby", chapter: true}

And my heart glows bright red under my filmy, translucent skin and
they have to administer 10cc of JavaScript to get me to come back. (I
respond well to toxins in the blood.) Man, that stuff will kick the
peaches right out your gills!

quote}}

{{index why, "Poignant Guide"}}

{{figure {url: "img/chapter_picture_2.jpg", alt: "Picture of tentacles holding objects", chapter: framed}}}

In this chapter, we will start to do things that can actually be called
_programming_. We will expand our command of the JavaScript language
beyond the nouns and sentence fragments we've seen so far, to the
point where we can express meaningful prose.

## Expressions and statements

{{index grammar, [syntax, expression], [code, "structure of"], grammar, [JavaScript, syntax]}}

In [Chapter ?](values), we made values and applied operators to them
to get new values. Creating values like this is the main substance of
any JavaScript program. But that substance has to be framed in a
larger structure to be useful. So that's what we'll cover next.

{{index "literal expression", [parentheses, expression]}}

A fragment of code that produces a value is called an
_((expression))_. Every value that is written literally (such as `22`
or `"psychoanalysis"`) is an expression. An expression between
parentheses is also an expression, as is a ((binary operator))
applied to two expressions or a ((unary operator)) applied to one.

{{index [nesting, "of expressions"], "human language"}}

This shows part of the beauty of a language-based interface.
Expressions can contain other expressions in a way similar to how subsentences in human languages are nested—a subsentence can
contain its own subsentences, and so on. This allows us to build
expressions that describe arbitrarily complex computations.

{{index statement, semicolon, program}}

If an expression corresponds to a sentence fragment, a JavaScript
_statement_ corresponds to a full sentence. A program is a list of
statements.

{{index [syntax, statement]}}

The simplest kind of statement is an expression with a semicolon after
it. This is a program:

```
1;
!false;
```

It is a useless program, though. An ((expression)) can be content to
just produce a value, which can then be used by the enclosing code. A
((statement)) stands on its own, so it amounts to something only if it
affects the world. It could display something on the screen—that
counts as changing the world—or it could change the internal state of
the machine in a way that will affect the statements that come after
it. These changes are called _((side effect))s_. The statements in the
previous example just produce the values `1` and `true` and then
immediately throw them away. This leaves no impression on the world at
all. When you run this program, nothing observable happens.

{{index "programming style", "automatic semicolon insertion", semicolon}}

In some cases, JavaScript allows you to omit the semicolon at the end
of a statement. In other cases, it has to be there, or the next
((line)) will be treated as part of the same statement. The rules for
when it can be safely omitted are somewhat complex and error-prone. So
in this book, every statement that needs a semicolon will always get
one. I recommend you do the same, at least until you've learned more
about the subtleties of missing semicolons.

## Bindings

{{indexsee variable, binding}}
{{index [syntax, statement], [binding, definition], "side effect", [memory, organization], [state, in binding]}}

How does a program keep an internal state? How does it remember
things? We have seen how to produce new values from old values, but
this does not change the old values, and the new value has to be
immediately used or it will dissipate again. To catch and hold values,
JavaScript provides a thing called a _binding_, or _variable_:

```
let caught = 5 * 5;
```

{{index "let keyword"}}

That's a second kind of ((statement)). The special word
(_((keyword))_) `let` indicates that this sentence is going to define
a binding. It is followed by the name of the binding and, if we want
to immediately give it a value, by an `=` operator and an expression.

The previous statement creates a binding called `caught` and uses it
to grab hold of the number that is produced by multiplying 5 by 5.

After a binding has been defined, its name can be used as an
((expression)). The value of such an expression is the value the
binding currently holds. Here's an example:

```
let ten = 10;
console.log(ten * ten);
// → 100
```

{{index "= operator", assignment, [binding, assignment]}}

When a binding points at a value, that does not mean it is tied to
that value forever. The `=` operator can be used at any time on
existing bindings to disconnect them from their current value and have
them point to a new one.

```
let mood = "light";
console.log(mood);
// → light
mood = "dark";
console.log(mood);
// → dark
```

{{index [binding, "model of"], "tentacle (analogy)"}}

You should imagine bindings as tentacles, rather than boxes. They do
not _contain_ values; they _grasp_ them—two bindings can refer to the
same value. A program can access only the values that it still has a
reference to. When you need to remember something, you grow a tentacle
to hold on to it or you reattach one of your existing tentacles to it.

Let's look at another example. To remember the number of dollars that
Luigi still owes you, you create a binding. And then when he pays back
$35, you give this binding a new value.

```
let luigisDebt = 140;
luigisDebt = luigisDebt - 35;
console.log(luigisDebt);
// → 105
```

{{index undefined}}

When you define a binding without giving it a value, the tentacle has
nothing to grasp, so it ends in thin air. If you ask for the value of
an empty binding, you'll get the value `undefined`.

{{index "let keyword"}}

A single `let` statement may define multiple bindings. The
definitions must be separated by commas.

```
let one = 1, two = 2;
console.log(one + two);
// → 3
```

The words `var` and `const` can also be used to create bindings, in a
way similar to `let`.

```
var name = "Ayda";
const greeting = "Hello ";
console.log(greeting + name);
// → Hello Ayda
```

{{index "var keyword"}}

The first, `var` (short for "variable"), is the way bindings were
declared in pre-2015 JavaScript. I'll get back to the precise way it
differs from `let` in the [next chapter](functions). For now,
remember that it mostly does the same thing, but we'll rarely use it
in this book because it has some confusing properties.

{{index "const keyword", naming}}

The word `const` stands for _((constant))_. It defines a constant
binding, which points at the same value for as long as it lives. This
is useful for bindings that give a name to a value so that you can
easily refer to it later.

## Binding names

{{index "underscore character", "dollar sign", [binding, naming]}}

Binding names can be any word. Digits can be part of binding
names—`catch22` is a valid name, for example—but the name must not
start with a digit. A binding name may include dollar signs (`$`) or
underscores (`_`) but no other punctuation or special characters.

{{index [syntax, identifier], "implements (reserved word)", "interface (reserved word)", "package (reserved word)", "private (reserved word)", "protected (reserved word)", "public (reserved word)", "static (reserved word)", "void operator", "yield (reserved word)", "enum (reserved word)", "reserved word", [binding, naming]}}

Words with a special meaning, such as `let`, are _((keyword))s_, and
they may not be used as binding names. There are also a number of
words that are "reserved for use" in ((future)) versions of
JavaScript, which also can't be used as binding names. The full list
of keywords and reserved words is rather long.

```{lang: "text/plain"}
break case catch class const continue debugger default
delete do else enum export extends false finally for
function if implements import interface in instanceof let
new package private protected public return static super
switch this throw true try typeof var void while with yield
```

{{index [syntax, error]}}

Don't worry about memorizing this list. When creating a binding produces
an unexpected syntax error, see whether you're trying to define a
reserved word.

## The environment

{{index "standard environment", [browser, environment]}}

The collection of bindings and their values that exist at a given time
is called the _((environment))_. When a program starts up, this
environment is not empty. It always contains bindings that are part of
the language ((standard)), and most of the time, it also has bindings
that provide ways to interact with the surrounding system. For
example, in a browser, there are functions to interact with the
currently loaded website and to read ((mouse)) and ((keyboard)) input.

## Functions

{{indexsee "application (of functions)", [function, application]}}
{{indexsee "invoking (of functions)", [function, application]}}
{{indexsee "calling (of functions)", [function, application]}}
{{index output, function, [function, application], [browser, environment]}}

A lot of the values provided in the default environment have the type
_((function))_. A function is a piece of program wrapped in a value.
Such values can be _applied_ in order to run the wrapped program. For
example, in a browser environment, the binding `prompt` holds a
function that shows a little ((dialog box)) asking for user input. It
is used like this:

```
prompt("Enter passcode");
```

{{figure {url: "img/prompt.png", alt: "A prompt dialog", width: "8cm"}}}

{{index parameter, [function, application], [parentheses, arguments]}}

Executing a function is called _invoking_, _calling_, or _applying_
it. You can call a function by putting parentheses after an
expression that produces a function value. Usually you'll directly use
the name of the binding that holds the function. The values between
the parentheses are given to the program inside the function. In the
example, the `prompt` function uses the string that we give it as the
text to show in the dialog box. Values given to functions are called
_((argument))s_. Different functions might need a different number or
different types of arguments.

The `prompt` function isn't used much in modern web programming,
mostly because you have no control over the way the resulting dialog
looks, but can be helpful in toy programs and experiments.

## The console.log function

{{index "JavaScript console", "developer tools", "Node.js", "console.log", output, [browser, environment]}}

In the examples, I used `console.log` to output values. Most JavaScript
systems (including all modern web browsers and Node.js) provide a
`console.log` function that writes out its arguments to _some_ text
output device. In browsers, the output lands in the ((JavaScript
console)). This part of the browser interface is hidden by default,
but most browsers open it when you press F12 or, on a Mac, [command]{keyname}-[option]{keyname}-I.
If that does not work, search through the menus for an item named Developer
Tools or similar.

{{if interactive

When running the examples (or your own code) on the pages of this
book, `console.log` output will be shown after the example, instead of
in the browser's JavaScript console.

```
let x = 30;
console.log("the value of x is", x);
// → the value of x is 30
```

if}}

{{index [object, property], [property, access]}}

Though binding names cannot contain ((period character))s,
`console.log` does have one. This is because `console.log` isn't a
simple binding. It is actually an expression that retrieves the `log`
property from the value held by the `console` binding. We'll
find out exactly what this means in [Chapter ?](data#properties).

{{id return_values}}
## Return values

{{index [comparison, "of numbers"], "return value", "Math.max function", maximum}}

Showing a dialog box or writing text to the screen is a _((side
effect))_. A lot of functions are useful because of the side effects
they produce. Functions may also produce values, in which case they
don't need to have a side effect to be useful. For example, the
function `Math.max` takes any amount of number arguments and gives
back the greatest.

```
console.log(Math.max(2, 4));
// → 4
```

{{index [function, application], minimum, "Math.min function"}}

When a function produces a value, it is said to _return_ that value.
Anything that produces a value is an ((expression)) in JavaScript,
which means function calls can be used within larger expressions. Here
a call to `Math.min`, which is the opposite of `Math.max`, is used as
part of a plus expression:

```
console.log(Math.min(2, 4) + 100);
// → 102
```

The [next chapter](functions) explains how to write your own
functions.

## Control flow

{{index "execution order", program, "control flow"}}

When your program contains more than one ((statement)), the statements
are executed as if they are a story, from top to bottom. This example
program has two statements. The first one asks the user for a number,
and the second, which is executed after the first, shows the
((square)) of that number.

```
let theNumber = Number(prompt("Pick a number"));
console.log("Your number is the square root of " +
            theNumber * theNumber);
```

{{index [number, "conversion to"], "type coercion", "Number function", "String function", "Boolean function", [Boolean, "conversion to"]}}

The function `Number` converts a value to a number. We need that
conversion because the result of `prompt` is a string value, and we
want a number. There are similar functions called `String` and
`Boolean` that convert values to those types.

Here is the rather trivial schematic representation of straight-line
control flow:

{{figure {url: "img/controlflow-straight.svg", alt: "Trivial control flow", width: "4cm"}}}

## Conditional execution

{{index Boolean, ["control flow", conditional]}}

Not all programs are straight roads. We may, for example, want to
create a branching road, where the program takes the proper branch
based on the situation at hand. This is called _((conditional
execution))_.

{{figure {url: "img/controlflow-if.svg", alt: "Conditional control flow",width: "4cm"}}}

{{index [syntax, statement], "Number function", "if keyword"}}

Conditional execution is created with the `if` keyword in JavaScript.
In the simple case, we want some code to be executed if, and only if,
a certain condition holds. We might, for example, want to show the
square of the input only if the input is actually a number.

```{test: wrap}
let theNumber = Number(prompt("Pick a number"));
if (!Number.isNaN(theNumber)) {
  console.log("Your number is the square root of " +
              theNumber * theNumber);
}
```

With this modification, if you enter "parrot", no output is shown.

{{index [parentheses, statement]}}

The `if` keyword executes or skips a statement depending on the value
of a Boolean expression. The deciding expression is written after the
keyword, between parentheses, followed by the statement to
execute.

{{index "Number.isNaN function"}}

The `Number.isNaN` function is a standard JavaScript function that
returns `true` only if the argument it is given is `NaN`. The `Number`
function happens to return `NaN` when you give it a string that
doesn't represent a valid number. Thus, the condition translates to
"unless `theNumber` is not-a-number, do this".

{{index grouping, "{} (block)", [braces, "block"]}}

The statement after the `if` is wrapped in braces (`{` and
`}`) in this example. The braces can be used to group any number of
statements into a single statement, called a _((block))_. You could
also have omitted them in this case, since they hold only a single
statement, but to avoid having to think about whether they are needed, most JavaScript programmers use them in every wrapped
statement like this. We'll mostly follow that convention in this book,
except for the occasional one-liner.

```
if (1 + 1 == 2) console.log("It's true");
// → It's true
```

{{index "else keyword"}}

You often won't just have code that executes when a condition holds
true, but also code that handles the other case. This alternate path
is represented by the second arrow in the diagram. You can use the `else` keyword, together with `if`, to create two separate, alternative
execution paths.

```{test: wrap}
let theNumber = Number(prompt("Pick a number"));
if (!Number.isNaN(theNumber)) {
  console.log("Your number is the square root of " +
              theNumber * theNumber);
} else {
  console.log("Hey. Why didn't you give me a number?");
}
```

{{index ["if keyword", chaining]}}

If you have more than two paths to choose from, you can "chain" multiple `if`/`else`
pairs together. Here's an example:

```
let num = Number(prompt("Pick a number"));

if (num < 10) {
  console.log("Small");
} else if (num < 100) {
  console.log("Medium");
} else {
  console.log("Large");
}
```

The program will first check whether `num` is less than 10. If it is,
it chooses that branch, shows `"Small"`, and is done. If it isn't, it
takes the `else` branch, which itself contains a second `if`. If the
second condition (`< 100`) holds, that means the number is between 10
and 100, and `"Medium"` is shown. If it doesn't, the second and last
`else` branch is chosen.

The schema for this program looks something like this:

{{figure {url: "img/controlflow-nested-if.svg", alt: "Nested if control flow", width: "4cm"}}}

{{id loops}}
## while and do loops

Consider a program that outputs all ((even number))s from 0 to 12. One
way to write this is as follows:

```
console.log(0);
console.log(2);
console.log(4);
console.log(6);
console.log(8);
console.log(10);
console.log(12);
```

{{index ["control flow", loop]}}

That works, but the idea of writing a program is to make something
_less_ work, not more. If we needed all even numbers less than 1,000,
this approach would be unworkable. What we need is a way to run a
piece of code multiple times. This form of control flow is called a
_((loop))_.

{{figure {url: "img/controlflow-loop.svg", alt: "Loop control flow",width: "4cm"}}}

{{index [syntax, statement], "counter variable"}}

Looping control flow allows us to go back to some point in the program
where we were before and repeat it with our current program state. If
we combine this with a binding that counts, we can do something like
this:

```
let number = 0;
while (number <= 12) {
  console.log(number);
  number = number + 2;
}
// → 0
// → 2
//   … etcetera
```

{{index "while loop", Boolean, [parentheses, statement]}}

A ((statement)) starting with the keyword `while` creates a loop. The
word `while` is followed by an ((expression)) in parentheses and
then a statement, much like `if`. The loop keeps entering that
statement as long as the expression produces a value that gives `true`
when converted to Boolean.

{{index [state, in binding], [binding, as state]}}

The `number` binding demonstrates the way a ((binding)) can track the
progress of a program. Every time the loop repeats, `number` gets a
value that is 2 more than its previous value. At the beginning of
every repetition, it is compared with the number 12 to decide whether
the program's work is finished.

{{index exponentiation}}

As an example that actually does something useful, we can now write a
program that calculates and shows the value of 2^10^ (2 to the 10th
power). We use two bindings: one to keep track of our result and one
to count how often we have multiplied this result by 2. The loop tests
whether the second binding has reached 10 yet and, if not, updates
both bindings.

```
let result = 1;
let counter = 0;
while (counter < 10) {
  result = result * 2;
  counter = counter + 1;
}
console.log(result);
// → 1024
```

The counter could also have started at `1` and checked for `<= 10`,
but for reasons that will become apparent in [Chapter
?](data#array_indexing), it is a good idea to get used to
counting from 0.

{{index "loop body", "do loop", ["control flow", loop]}}

A `do` loop is a control structure similar to a `while` loop. It
differs only on one point: a `do` loop always executes its body at
least once, and it starts testing whether it should stop only after
that first execution. To reflect this, the test appears after the body
of the loop.

```
let yourName;
do {
  yourName = prompt("Who are you?");
} while (!yourName);
console.log(yourName);
```

{{index [Boolean, "conversion to"], "! operator"}}

This program will force you to enter a name. It will ask again and
again until it gets something that is not an empty string. Applying
the `!` operator will convert a value to Boolean type before negating
it, and all strings except `""` convert to `true`. This means the loop
continues going round until you provide a non-empty name.

## Indenting Code

{{index [code, "structure of"], [whitespace, indentation], "programming style"}}

In the examples, I've been adding spaces in front of statements that
are part of some larger statement. These spaces are not required—the computer
will accept the program just fine without them. In fact, even the
((line)) breaks in programs are optional. You could write a program as
a single long line if you felt like it.

The role of this ((indentation)) inside ((block))s is to make the
structure of the code stand out. In code where new blocks are opened
inside other blocks, it can become hard to see where one block ends
and another begins. With proper indentation, the visual shape of a
program corresponds to the shape of the blocks inside it. I like to
use two spaces for every open block, but tastes differ—some people use
four spaces, and some people use ((tab character))s. The important
thing is that each new block adds the same amount of space.

```
if (false != true) {
  console.log("That makes sense.");
  if (1 < 2) {
    console.log("No surprise there.");
  }
}
```

Most code ((editor)) programs[ (including the one in this book)]{if
interactive} will help by automatically indenting new lines the proper
amount.

## for loops

{{index [syntax, statement], "while loop", "counter variable"}}

Many loops follow the pattern shown in the `while` examples. First a
"counter" binding is created to track the progress of the loop. Then
comes a `while` loop, usually with a test expression that checks whether the
counter has reached its end value. At the end of the loop body, the
counter is updated to track progress.

{{index "for loop", loop}}

Because this pattern is so common, JavaScript and similar languages
provide a slightly shorter and more comprehensive form, the `for`
loop.

```
for (let number = 0; number <= 12; number = number + 2) {
  console.log(number);
}
// → 0
// → 2
//   … etcetera
```

{{index ["control flow", loop], state}}

This program is exactly equivalent to the
[earlier](program_structure#loops) even-number-printing example. The
only change is that all the ((statement))s that are related to the
"state" of the loop are grouped together after `for`.

{{index [binding, as state], [parentheses, statement]}}

The parentheses after a `for` keyword must contain two
((semicolon))s. The part before the first semicolon _initializes_ the
loop, usually by defining a binding. The second part is the
((expression)) that _checks_ whether the loop must continue. The final
part _updates_ the state of the loop after every iteration. In most
cases, this is shorter and clearer than a `while` construct.

{{index exponentiation}}

This is the code that computes 2^10^ using `for` instead of `while`:

```{test: wrap}
let result = 1;
for (let counter = 0; counter < 10; counter = counter + 1) {
  result = result * 2;
}
console.log(result);
// → 1024
```

## Breaking Out of a Loop

{{index [loop, "termination of"], "break keyword"}}

Having the looping condition produce `false` is not the only way a
loop can finish. There is a special statement called `break` that has
the effect of immediately jumping out of the enclosing loop.

This program illustrates the `break` statement. It finds the first number
that is both greater than or equal to 20 and divisible by 7.

```
for (let current = 20; ; current = current + 1) {
  if (current % 7 == 0) {
    console.log(current);
    break;
  }
}
// → 21
```

{{index "remainder operator", "% operator"}}

Using the remainder (`%`) operator is an easy way to test whether a
number is divisible by another number. If it is, the remainder of
their division is zero.

{{index "for loop"}}

The `for` construct in the example does not have a part that checks
for the end of the loop. This means that the loop will never stop
unless the `break` statement inside is executed.

If you were to remove that `break` statement or you accidentally write
an end condition that always produces `true`, your program would get
stuck in an _((infinite loop))_. A program stuck in an infinite loop
will never finish running, which is usually a bad thing.

{{if interactive

If you create an infinite loop in one of the examples on these pages,
you'll usually be asked whether you want to stop the script after a
few seconds. If that fails, you will have to close the tab that you're
working in, or on some browsers close your whole browser, to recover.

if}}

{{index "continue keyword"}}

The `continue` keyword is similar to `break`, in that it influences
the progress of a loop. When `continue` is encountered in a loop body,
control jumps out of the body and continues with the loop's next
iteration.

## Updating bindings succinctly

{{index assignment, "+= operator", "-= operator", "/= operator", "*= operator", [state, in binding], "side effect"}}

Especially when looping, a program often needs to "update" a binding
to hold a value based on that binding's previous value.

```{test: no}
counter = counter + 1;
```

JavaScript provides a shortcut for this.

```{test: no}
counter += 1;
```

Similar shortcuts work for many other operators, such as `result *= 2`
to double `result` or `counter -= 1` to count downward.

This allows us to shorten our counting example a little more.

```
for (let number = 0; number <= 12; number += 2) {
  console.log(number);
}
```

{{index "++ operator", "-- operator"}}

For `counter += 1` and `counter -= 1`, there are even shorter
equivalents: `counter++` and `counter--`.

## Dispatching on a value with switch

{{index [syntax, statement], "conditional execution", dispatch, ["if keyword", chaining]}}

It is not uncommon for code to look like this:

```{test: no}
if (x == "value1") action1();
else if (x == "value2") action2();
else if (x == "value3") action3();
else defaultAction();
```

{{index "colon character", "switch keyword"}}

There is a construct called `switch` that is intended to express such
a "dispatch" in a more direct way. Unfortunately, the syntax
JavaScript uses for this (which it inherited from the C/Java line of
programming languages) is somewhat awkward—a chain of `if` statements
may look better. Here is an example:

```
switch (prompt("What is the weather like?")) {
  case "rainy":
    console.log("Remember to bring an umbrella.");
    break;
  case "sunny":
    console.log("Dress lightly.");
  case "cloudy":
    console.log("Go outside.");
    break;
  default:
    console.log("Unknown weather type!");
    break;
}
```

{{index fallthrough, "break keyword", "case keyword", "default keyword"}}

You may put any number of `case` labels inside the block opened by
`switch`. The program will start executing at the label that
corresponds to the value that `switch` was given, or at `default` if
no matching value is found. It will continue executing, even across
other labels, until it reaches a `break` statement. In some cases,
such as the `"sunny"` case in the example, this can be used to share
some code between cases (it recommends going outside for both sunny
and cloudy weather). But be careful—it is easy to forget such a
`break`, which will cause the program to execute code you do not want
executed.

## Capitalization

{{index capitalization, [binding, naming], [whitespace, syntax]}}

Binding names may not contain spaces, yet it is often helpful to use
multiple words to clearly describe what the binding represents. These
are pretty much your choices for writing a binding name with several
words in it:

```{lang: null}
fuzzylittleturtle
fuzzy_little_turtle
FuzzyLittleTurtle
fuzzyLittleTurtle
```

{{index "camel case", "programming style", "underscore character"}}

The first style can be hard to read. I rather like the look of the
underscores, though that style is a little painful to type. The
((standard)) JavaScript functions, and most JavaScript programmers,
follow the bottom style—they capitalize every word except the first.
It is not hard to get used to little things like that, and code with
mixed naming styles can be jarring to read, so we follow this
((convention)).

{{index "Number function", constructor}}

In a few cases, such as the `Number` function, the first letter of a
binding is also capitalized. This was done to mark this function as a
constructor. What a constructor is will become clear in [Chapter
?](object#constructors). For now, the important thing is not
to be bothered by this apparent lack of ((consistency)).

## Comments

{{index readability}}

Often, raw code does not convey all the information you want a program
to convey to human readers, or it conveys it in such a cryptic way
that people might not understand it. At other times, you might just
want to include some related thoughts as part of your program. This is
what _((comment))s_ are for.

{{index "slash character", "line comment"}}

A comment is a piece of text that is part of a program but is
completely ignored by the computer. JavaScript has two ways of writing
comments. To write a single-line comment, you can use two slash
characters (`//`) and then the comment text after it.

```{test: no}
let accountBalance = calculateBalance(account);
// It's a green hollow where a river sings
accountBalance.adjust();
// Madly catching white tatters in the grass.
let report = new Report();
// Where the sun on the proud mountain rings:
addToReport(accountBalance, report);
// It's a little valley, foaming like light in a glass.
```

{{index "block comment"}}

A `//` comment goes only to the end of the line. A section of text
between `/*` and `*/` will be ignored in its entirety, regardless of
whether it contains line breaks. This is useful for adding blocks of
information about a file or a chunk of program.

```
/*
  I first found this number scrawled on the back of an old notebook.
  Since then, it has often dropped by, showing up in phone numbers
  and the serial numbers of products that I've bought. It obviously
  likes me, so I've decided to keep it.
*/
const myNumber = 11213;
```

## Summary

You now know that a program is built out of statements, which
themselves sometimes contain more statements. Statements tend to
contain expressions, which themselves can be built out of smaller
expressions.

Putting statements after one another gives you a program that is
executed from top to bottom. You can introduce disturbances in the
flow of control by using conditional (`if`, `else`, and `switch`) and
looping (`while`, `do`, and `for`) statements.

Bindings can be used to file pieces of data under a name, and they are
useful for tracking state in your program. The environment is the set
of bindings that are defined. JavaScript systems always put a number
of useful standard bindings into your environment.

Functions are special values that encapsulate a piece of program. You
can invoke them by writing `functionName(argument1, argument2)`. Such
a function call is an expression and may produce a value.

## Exercises

{{index exercises}}

If you are unsure how to test your solutions to the exercises, refer to the
[Introduction](intro).

Each exercise starts with a problem description. Read this description and try to
solve the exercise. If you run into problems, consider reading the
hints [after the exercise]{if interactive}[at the [end of the
book](hints)]{if book}. Full solutions to the exercises are
not included in this book, but you can find them online at
[_https://eloquentjavascript.net/code_](https://eloquentjavascript.net/code#2).
If you want to learn something from the exercises, I recommend looking
at the solutions only after you've solved the exercise, or at least
after you've attacked it long and hard enough to have a slight
headache.

### Looping a triangle

{{index "triangle (exercise)"}}

Write a ((loop)) that makes seven calls to `console.log` to output the
following triangle:

```{lang: null}
#
##
###
####
#####
######
#######
```

{{index [string, length]}}

It may be useful to know that you can find the length of a string by
writing `.length` after it.

```
let abc = "abc";
console.log(abc.length);
// → 3
```

{{if interactive

Most exercises contain a piece of code that you can modify to solve
the exercise. Remember that you can click code blocks to edit them.

```
// Your code here.
```
if}}

{{hint

{{index "triangle (exercise)"}}

You can start with a program that prints out the numbers 1 to 7, which
you can derive by making a few modifications to the [even number
printing example](program_structure#loops) given earlier in the
chapter, where the `for` loop was introduced.

Now consider the equivalence between numbers and strings of hash
characters. You can go from 1 to 2 by adding 1 (`+= 1`). You can go
from `"#"` to `"##"` by adding a character (`+= "#"`). Thus, your
solution can closely follow the number-printing program.

hint}}

### FizzBuzz

{{index "FizzBuzz (exercise)", loop, "conditional execution"}}

Write a program that uses `console.log` to print all the numbers from
1 to 100, with two exceptions. For numbers divisible by 3, print
`"Fizz"` instead of the number, and for numbers divisible by 5 (and
not 3), print `"Buzz"` instead.

When you have that working, modify your program to print `"FizzBuzz"`
for numbers that are divisible by both 3 and 5 (and still print
`"Fizz"` or `"Buzz"` for numbers divisible by only one of those).

(This is actually an ((interview question)) that has been claimed to
weed out a significant percentage of programmer candidates. So if you
solved it, your labor market value just went up.)

{{if interactive
```
// Your code here.
```
if}}

{{hint

{{index "FizzBuzz (exercise)", "remainder operator", "% operator"}}

Going over the numbers is clearly a looping job, and selecting what to
print is a matter of conditional execution. Remember the trick of
using the remainder (`%`) operator for checking whether a number is
divisible by another number (has a remainder of zero).

In the first version, there are three possible outcomes for every
number, so you'll have to create an `if`/`else if`/`else` chain.

{{index "|| operator", ["if keyword", chaining]}}

The second version of the program has a straightforward solution and a
clever one. The simple solution is to add another conditional "branch" to
precisely test the given condition. For the clever solution, build up a
string containing the word or words to output and print either this
word or the number if there is no word, potentially by making good use
of the `||` operator.

hint}}

### Chessboard

{{index "chessboard (exercise)", loop, [nesting, "of loops"], "newline character"}}

Write a program that creates a string that represents an 8×8 grid,
using newline characters to separate lines. At each position of the
grid there is either a space or a "#" character. The characters should
form a chessboard.

Passing this string to `console.log` should show something like this:

```{lang: null}
 # # # #
# # # # 
 # # # #
# # # # 
 # # # #
# # # # 
 # # # #
# # # # 
```

When you have a program that generates this pattern, define a
binding `size = 8` and change the program so that it works for
any `size`, outputting a grid of the given width and height.

{{if interactive
```
// Your code here.
```
if}}

{{hint

{{index "chess board (exercise)"}}

You can build the string by starting with an empty one (`""`) and
repeatedly adding characters. A newline character is written `"\n"`.

{{index [nesting, "of loops"], [braces, "block"]}}

To work with two ((dimensions)), you will need a ((loop)) inside of a
loop. Put braces around the bodies of both loops to make it
easy to see where they start and end. Try to properly indent these
bodies. The order of the loops must follow the order in which we build
up the string (line by line, left to right, top to bottom). So the
outer loop handles the lines, and the inner loop handles the characters
on a line.

{{index "counter variable", "remainder operator", "% operator"}}

You'll need two bindings to track your progress. To know whether to
put a space or a hash sign at a given position, you could test whether
the sum of the two counters is even (`% 2`).

Terminating a line by adding a newline character must happen after the
line has been built up, so do this after the inner loop but inside the outer loop.

hint}}
# Functions

{{quote {author: "Donald Knuth", chapter: true}

People think that computer science is the art of geniuses but the
actual reality is the opposite, just many people doing things that
build on each other, like a wall of mini stones.

quote}}

{{index "Knuth, Donald"}}

{{figure {url: "img/chapter_picture_3.jpg", alt: "Picture of fern leaves with a fractal shape", chapter: framed}}}

{{index function, [code, "structure of"]}}

Functions are the bread and butter of JavaScript programming. The
concept of wrapping a piece of program in a value has many uses. It
gives us a way to structure larger programs, to reduce repetition, to
associate names with subprograms, and to isolate these subprograms
from each other.

The most obvious application of functions is defining new
((vocabulary)). Creating new words in prose is usually bad style. But
in programming, it is indispensable.

{{index abstraction, vocabulary}}

Typical adult English speakers have some 20,000 words in their
vocabulary. Few programming languages come with 20,000 commands built
in. And the vocabulary that _is_ available tends to be more precisely
defined, and thus less flexible, than in human language. Therefore, we
usually _have_ to introduce new concepts to avoid repeating ourselves
too much.

## Defining a function

{{index "square example", [function, definition], [binding, definition]}}

A function definition is a regular binding where the value of the
binding is a function. For example, this code defines `square` to
refer to a function that produces the square of a given number:

```
const square = function(x) {
  return x * x;
};

console.log(square(12));
// → 144
```

{{indexsee "curly braces", braces}}
{{index [braces, "function body"], block, [syntax, function], "function keyword", [function, body], [function, "as value"], [parentheses, arguments]}}

A function is created with an expression that starts with the keyword
`function`. Functions have a set of _((parameter))s_ (in this case,
only `x`) and a _body_, which contains the statements that are to be
executed when the function is called. The function body of a function
created this way must always be wrapped in braces, even when it
consists of only a single ((statement)).

{{index "power example"}}

A function can have multiple parameters or no parameters at all. In
the following example, `makeNoise` does not list any parameter names,
whereas `power` lists two:

```
const makeNoise = function() {
  console.log("Pling!");
};

makeNoise();
// → Pling!

const power = function(base, exponent) {
  let result = 1;
  for (let count = 0; count < exponent; count++) {
    result *= base;
  }
  return result;
};

console.log(power(2, 10));
// → 1024
```

{{index "return value", "return keyword", undefined}}

Some functions produce a value, such as `power` and `square`, and some
don't, such as `makeNoise`, whose only result is a ((side effect)). A
`return` statement determines the value the function returns. When
control comes across such a statement, it immediately jumps out of the
current function and gives the returned value to the code that called
the function. A `return` keyword without an expression after it will
cause the function to return `undefined`. Functions that don't have a
`return` statement at all, such as `makeNoise`, similarly return
`undefined`.

{{index parameter, [function, application], [binding, "from parameter"]}}

Parameters to a function behave like regular bindings, but their
initial values are given by the _caller_ of the function, not the code
in the function itself.

## Bindings and scopes

{{indexsee "top-level scope", "global scope"}}
{{index "var keyword", "global scope", [binding, global], [binding, "scope of"]}}

Each binding has a _((scope))_, which is the part of the program
in which the binding is visible. For bindings defined outside of any
function or block, the scope is the whole program—you can refer to
such bindings wherever you want. These are called _global_.

{{index "local scope", [binding, local]}}

But bindings created for function ((parameter))s or declared inside a
function can be referenced only in that function, so they are known as
_local_ bindings. Every time the function is called, new instances of these
bindings are created. This provides some isolation between
functions—each function call acts in its own little world (its local
environment) and can often be understood without knowing a lot about
what's going on in the global environment.

{{index "let keyword", "const keyword", "var keyword"}}

Bindings declared with `let` and `const` are in fact local to the
_((block))_ that they are declared in, so if you create one of those
inside of a loop, the code before and after the loop cannot "see" it.
In pre-2015 JavaScript, only functions created new scopes, so
old-style bindings, created with the `var` keyword, are visible
throughout the whole function that they appear in—or throughout the
global scope, if they are not in a function.

```
let x = 10;
if (true) {
  let y = 20;
  var z = 30;
  console.log(x + y + z);
  // → 60
}
// y is not visible here
console.log(x + z);
// → 40
```

{{index [binding, visibility]}}

Each ((scope)) can "look out" into the scope around it, so `x` is
visible inside the block in the example. The exception is when
multiple bindings have the same name—in that case, code can see only
the innermost one. For example, when the code inside the `halve`
function refers to `n`, it is seeing its _own_ `n`, not the global
`n`.

```
const halve = function(n) {
  return n / 2;
};

let n = 10;
console.log(halve(100));
// → 50
console.log(n);
// → 10
```

{{id scoping}}

### Nested scope

{{index [nesting, "of functions"], [nesting, "of scope"], scope, "inner function", "lexical scoping"}}

JavaScript distinguishes not just _global_ and _local_
bindings. Blocks and functions can be created inside other blocks and
functions, producing multiple degrees of locality.

{{index "landscape example"}}

For example, this function—which outputs the ingredients needed to
make a batch of hummus—has another function inside it:

```
const hummus = function(factor) {
  const ingredient = function(amount, unit, name) {
    let ingredientAmount = amount * factor;
    if (ingredientAmount > 1) {
      unit += "s";
    }
    console.log(`${ingredientAmount} ${unit} ${name}`);
  };
  ingredient(1, "can", "chickpeas");
  ingredient(0.25, "cup", "tahini");
  ingredient(0.25, "cup", "lemon juice");
  ingredient(1, "clove", "garlic");
  ingredient(2, "tablespoon", "olive oil");
  ingredient(0.5, "teaspoon", "cumin");
};
```

{{index [function, scope], scope}}

The code inside the `ingredient` function can see the `factor` binding
from the outer function. But its local bindings, such as `unit` or
`ingredientAmount`, are not visible in the outer function.

The set of bindings visible inside a block is determined by the place of
that block in the program text. Each local scope can also see all the
local scopes that contain it, and all scopes can see the global scope.
This approach to binding visibility is called _((lexical scoping))_.

## Functions as values

{{index [function, "as value"], [binding, definition]}}

A function binding usually simply acts as a name for a specific piece
of the program. Such a binding is defined once and never changed. This
makes it easy to confuse the function and its name.

{{index [binding, assignment]}}

But the two are different. A function value can do all the things that
other values can do—you can use it in arbitrary ((expression))s, not
just call it. It is possible to store a function value in a new
binding, pass it as an argument to a function, and so on. Similarly, a
binding that holds a function is still just a regular binding and can,
if not constant, be assigned a new value, like so:

```{test: no}
let launchMissiles = function() {
  missileSystem.launch("now");
};
if (safeMode) {
  launchMissiles = function() {/* do nothing */};
}
```

{{index [function, "higher-order"]}}

In [Chapter ?](higher_order), we will discuss the interesting things
that can be done by passing around function values to other functions.

## Declaration notation

{{index [syntax, function], "function keyword", "square example", [function, definition], [function, declaration]}}

There is a slightly shorter way to create a function binding. When the
`function` keyword is used at the start of a statement, it works
differently.

```{test: wrap}
function square(x) {
  return x * x;
}
```

{{index future, "execution order"}}

This is a function _declaration_. The statement defines the binding
`square` and points it at the given function. It is slightly easier
to write and doesn't require a semicolon after the function.

There is one subtlety with this form of function definition.

```
console.log("The future says:", future());

function future() {
  return "You'll never have flying cars";
}
```

The preceding code works, even though the function is defined _below_ the code
that uses it. Function declarations are not part of the regular
top-to-bottom flow of control. They are conceptually moved to the top
of their scope and can be used by all the code in that scope. This is
sometimes useful because it offers the freedom to order code in a
way that seems meaningful, without worrying about having to define all
functions before they are used.

## Arrow functions

{{index function, "arrow function"}}

There's a third notation for functions, which looks very different
from the others. Instead of the `function` keyword, it uses an arrow
(`=>`) made up of an equal sign and a greater-than character (not to be
confused with the greater-than-or-equal operator, which is written
`>=`).

```{test: wrap}
const power = (base, exponent) => {
  let result = 1;
  for (let count = 0; count < exponent; count++) {
    result *= base;
  }
  return result;
};
```

{{index [function, body]}}

The arrow comes _after_ the list of parameters and is followed by the
function's body. It expresses something like "this input (the
((parameter))s) produces this result (the body)".

{{index [braces, "function body"], "square example", [parentheses, arguments]}}

When there is only one parameter name, you can omit the parentheses around the
parameter list. If the body is a single expression,
rather than a ((block)) in braces, that expression will be returned
from the function. So, these two definitions of `square` do the same
thing:

```
const square1 = (x) => { return x * x; };
const square2 = x => x * x;
```

{{index [parentheses, arguments]}}

When an arrow function has no parameters at all, its parameter list is
just an empty set of parentheses.

```
const horn = () => {
  console.log("Toot");
};
```

{{index verbosity}}

There's no deep reason to have both arrow functions and
`function` expressions in the language. Apart from a minor detail,
which we'll discuss in [Chapter ?](object), they do the same thing.
Arrow functions were added in 2015, mostly to make it possible to
write small function expressions in a less verbose way. We'll be using
them a lot in [Chapter ?](higher_order).

{{id stack}}

## The call stack

{{indexsee stack, "call stack"}}
{{index "call stack", [function, application]}}

The way control flows through functions is somewhat involved. Let's
take a closer look at it. Here is a simple program that makes a few
function calls:

```
function greet(who) {
  console.log("Hello " + who);
}
greet("Harry");
console.log("Bye");
```

{{index ["control flow", functions], "execution order", "console.log"}}

A run through this program goes roughly like this: the call to `greet`
causes control to jump to the start of that function (line 2). The
function calls `console.log`, which takes control, does its job, and
then returns control to line 2. There it reaches the end of the
`greet` function, so it returns to the place that called it, which is
line 4. The line after that calls `console.log` again. After that
returns, the program reaches its end.

We could show the flow of control schematically like this:

```{lang: null}
not in function
   in greet
        in console.log
   in greet
not in function
   in console.log
not in function
```

{{index "return keyword", [memory, call stack]}}

Because a function has to jump back to the place that called it when
it returns, the computer must remember the context from which the call
happened. In one case, `console.log` has to return to the `greet`
function when it is done. In the other case, it returns to the end of
the program.

The place where the computer stores this context is the _((call
stack))_. Every time a function is called, the current context is
stored on top of this stack. When a function returns, it removes the
top context from the stack and uses that context to continue execution.

{{index "infinite loop", "stack overflow", recursion}}

Storing this stack requires space in the computer's memory. When the
stack grows too big, the computer will fail with a message like "out
of stack space" or "too much recursion". The following code
illustrates this by asking the computer a really hard question that
causes an infinite back-and-forth between two functions. Rather, it
_would_ be infinite, if the computer had an infinite stack. As it is,
we will run out of space, or "blow the stack".

```{test: no}
function chicken() {
  return egg();
}
function egg() {
  return chicken();
}
console.log(chicken() + " came first.");
// → ??
```

## Optional Arguments

{{index argument, [function, application]}}

The following code is allowed and executes without any problem:

```
function square(x) { return x * x; }
console.log(square(4, true, "hedgehog"));
// → 16
```

We defined `square` with only one ((parameter)). Yet when we call it
with three, the language doesn't complain. It ignores the extra
arguments and computes the square of the first one.

{{index undefined}}

JavaScript is extremely broad-minded about the number of arguments you
pass to a function. If you pass too many, the extra ones are ignored.
If you pass too few, the missing parameters get assigned the value
`undefined`.

The downside of this is that it is possible—likely, even—that you'll
accidentally pass the wrong number of arguments to functions. And no
one will tell you about it.

The upside is that this behavior can be used to allow a function to be
called with different numbers of arguments. For example, this `minus`
function tries to imitate the `-` operator by acting on either one or
two arguments:

```
function minus(a, b) {
  if (b === undefined) return -a;
  else return a - b;
}

console.log(minus(10));
// → -10
console.log(minus(10, 5));
// → 5
```

{{id power}}
{{index "optional argument", "default value", parameter, ["= operator", "for default value"]}}

If you write an `=` operator after
a parameter, followed by an expression, the value of that expression
will replace the argument when it is not given.

{{index "power example"}}

For example, this version of `power` makes its second argument
optional. If you don't provide it or pass the value `undefined`, it will default to two, and the
function will behave like `square`.

```{test: wrap}
function power(base, exponent = 2) {
  let result = 1;
  for (let count = 0; count < exponent; count++) {
    result *= base;
  }
  return result;
}

console.log(power(4));
// → 16
console.log(power(2, 6));
// → 64
```

{{index "console.log"}}

In the [next chapter](data#rest_parameters), we will see a way in
which a function body can get at the whole list of arguments it was
passed. This is helpful because it makes it possible for a function to
accept any number of arguments. For example, `console.log` does
this—it outputs all of the values it is given.

```
console.log("C", "O", 2);
// → C O 2
```

## Closure

{{index "call stack", "local binding", [function, "as value"], scope}}

The ability to treat functions as values, combined with the fact that
local bindings are re-created every time a function is called, brings
up an interesting question. What happens to local bindings when the
function call that created them is no longer active?

The following code shows an example of this. It defines a function,
`wrapValue`, that creates a local binding. It then returns a function
that accesses and returns this local binding.

```
function wrapValue(n) {
  let local = n;
  return () => local;
}

let wrap1 = wrapValue(1);
let wrap2 = wrapValue(2);
console.log(wrap1());
// → 1
console.log(wrap2());
// → 2
```

This is allowed and works as you'd hope—both instances of the binding
can still be accessed. This situation is a good demonstration of the
fact that local bindings are created anew for every call, and
different calls can't trample on one another's local bindings.

This feature—being able to reference a specific instance of a local
binding in an enclosing scope—is called _((closure))_. A function that
references bindings from local scopes around it is called _a_ closure. This behavior
not only frees you from having to worry about lifetimes of bindings
but also makes it possible to use function values in some creative
ways.

{{index "multiplier function"}}

With a slight change, we can turn the previous example into a way to
create functions that multiply by an arbitrary amount.

```
function multiplier(factor) {
  return number => number * factor;
}

let twice = multiplier(2);
console.log(twice(5));
// → 10
```

{{index [binding, "from parameter"]}}

The explicit `local` binding from the `wrapValue` example isn't really
needed since a parameter is itself a local binding.

{{index [function, "model of"]}}

Thinking about programs like this takes some practice. A good mental
model is to think of function values as containing both the code in
their body and the environment in which they are created. When called,
the function body sees the environment in which it was created, not the
environment in which it is called.

In the example, `multiplier` is called and creates an environment in
which its `factor` parameter is bound to 2. The function value it
returns, which is stored in `twice`, remembers this environment. So
when that is called, it multiplies its argument by 2.

## Recursion

{{index "power example", "stack overflow", recursion, [function, application]}}

It is perfectly okay for a function to call itself, as long as it
doesn't do it so often that it overflows the stack. A function that calls
itself is called _recursive_. Recursion allows some functions to be
written in a different style. Take, for example, this alternative
implementation of `power`:

```{test: wrap}
function power(base, exponent) {
  if (exponent == 0) {
    return 1;
  } else {
    return base * power(base, exponent - 1);
  }
}

console.log(power(2, 3));
// → 8
```

{{index loop, readability, mathematics}}

This is rather close to the way mathematicians define exponentiation
and arguably describes the concept more clearly than the looping
variant. The function calls itself multiple times with ever smaller
exponents to achieve the repeated multiplication.

{{index [function, application], efficiency}}

But this implementation has one problem: in typical JavaScript
implementations, it's about three times slower than the looping version.
Running through a simple loop is generally cheaper than calling a
function multiple times.

{{index optimization}}

The dilemma of speed versus ((elegance)) is an interesting one. You
can see it as a kind of continuum between human-friendliness and
machine-friendliness. Almost any program can be made faster by making
it bigger and more convoluted. The programmer has to decide on an
appropriate balance.

In the case of the `power` function, the inelegant (looping) version
is still fairly simple and easy to read. It doesn't make much sense to
replace it with the recursive version. Often, though, a program deals
with such complex concepts that giving up some efficiency in order to
make the program more straightforward is helpful.

{{index profiling}}

Worrying about efficiency can be a distraction. It's yet another
factor that complicates program design, and when you're doing
something that's already difficult, that extra thing to worry about
can be paralyzing.

{{index "premature optimization"}}

Therefore, always start by writing something that's correct and easy
to understand. If you're worried that it's too slow—which it usually
isn't since most code simply isn't executed often enough to take any
significant amount of time—you can measure afterward and improve it
if necessary.

{{index "branching recursion"}}

Recursion is not always just an inefficient alternative to looping.
Some problems really are easier to solve with recursion than with
loops. Most often these are problems that require exploring or
processing several "branches", each of which might branch out again
into even more branches.

{{id recursive_puzzle}}
{{index recursion, "number puzzle example"}}

Consider this puzzle: by starting from the number 1 and repeatedly
either adding 5 or multiplying by 3, an infinite set of numbers
can be produced. How would you write a function that, given a number,
tries to find a sequence of such additions and multiplications that
produces that number?

For example, the number 13 could be reached by first multiplying by 3
and then adding 5 twice, whereas the number 15 cannot be reached at
all.

Here is a recursive solution:

```
function findSolution(target) {
  function find(current, history) {
    if (current == target) {
      return history;
    } else if (current > target) {
      return null;
    } else {
      return find(current + 5, `(${history} + 5)`) ||
             find(current * 3, `(${history} * 3)`);
    }
  }
  return find(1, "1");
}

console.log(findSolution(24));
// → (((1 * 3) + 5) * 3)
```

Note that this program doesn't necessarily find the _shortest_
sequence of operations. It is satisfied when it finds any sequence at
all.

It is okay if you don't see how it works right away. Let's work
through it, since it makes for a great exercise in recursive thinking.

The inner function `find` does the actual recursing. It takes two
((argument))s: the current number and a string that records how we
reached this number. If it finds a solution, it returns a string that
shows how to get to the target. If no solution can be found starting
from this number, it returns `null`.

{{index null, "|| operator", "short-circuit evaluation"}}

To do this, the function performs one of three actions. If the current
number is the target number, the current history is a way to reach
that target, so it is returned. If the current number is greater than
the target, there's no sense in further exploring this branch because
both adding and multiplying will only make the number bigger, so it
returns `null`. Finally, if we're still below the target number,
the function tries both possible paths that start from the current
number by calling itself twice, once for addition and once for
multiplication. If the first call returns something that is not
`null`, it is returned. Otherwise, the second call is returned,
regardless of whether it produces a string or `null`.

{{index "call stack"}}

To better understand how this function produces the effect we're
looking for, let's look at all the calls to `find` that are made when
searching for a solution for the number 13.

```{lang: null}
find(1, "1")
  find(6, "(1 + 5)")
    find(11, "((1 + 5) + 5)")
      find(16, "(((1 + 5) + 5) + 5)")
        too big
      find(33, "(((1 + 5) + 5) * 3)")
        too big
    find(18, "((1 + 5) * 3)")
      too big
  find(3, "(1 * 3)")
    find(8, "((1 * 3) + 5)")
      find(13, "(((1 * 3) + 5) + 5)")
        found!
```

The indentation indicates the depth of the call stack. The first time
`find` is called, it starts by calling itself to explore the solution
that starts with `(1 + 5)`. That call will further recurse to explore
_every_ continued solution that yields a number less than or equal to
the target number. Since it doesn't find one that hits the target, it
returns `null` back to the first call. There the `||` operator causes
the call that explores `(1 * 3)` to happen. This search has more
luck—its first recursive call, through yet _another_ recursive call,
hits upon the target number. That innermost call returns a string, and
each of the `||` operators in the intermediate calls passes that string
along, ultimately returning the solution.

## Growing functions

{{index [function, definition]}}

There are two more or less natural ways for functions to be introduced
into programs.

{{index repetition}}

The first is that you find yourself writing similar code multiple
times. You'd prefer not to do that. Having more code means more space
for mistakes to hide and more material to read for people trying to
understand the program. So you take the repeated functionality, find a
good name for it, and put it into a function.

The second way is that you find you need some functionality that you
haven't written yet and that sounds like it deserves its own function.
You'll start by naming the function, and then you'll write its body.
You might even start writing code that uses the function before you
actually define the function itself.

{{index [function, naming], [binding, naming]}}

How difficult it is to find a good name for a function is a good
indication of how clear a concept it is that you're trying to wrap.
Let's go through an example.

{{index "farm example"}}

We want to write a program that prints two numbers: the numbers of
cows and chickens on a farm, with the words `Cows` and `Chickens`
after them and zeros padded before both numbers so that they are
always three digits long.

```{lang: null}
007 Cows
011 Chickens
```

This asks for a function of two arguments—the number of cows and the
number of chickens. Let's get coding.

```
function printFarmInventory(cows, chickens) {
  let cowString = String(cows);
  while (cowString.length < 3) {
    cowString = "0" + cowString;
  }
  console.log(`${cowString} Cows`);
  let chickenString = String(chickens);
  while (chickenString.length < 3) {
    chickenString = "0" + chickenString;
  }
  console.log(`${chickenString} Chickens`);
}
printFarmInventory(7, 11);
```

{{index ["length property", "for string"], "while loop"}}

Writing `.length` after a string expression will give us the length of
that string. Thus, the `while` loops keep adding zeros in front of the
number strings until they are at least three characters long.

Mission accomplished! But just as we are about to send the farmer the
code (along with a hefty invoice), she calls and tells us she's also
started keeping pigs, and couldn't we please extend the software to
also print pigs?

{{index "copy-paste programming"}}

We sure can. But just as we're in the process of copying and pasting
those four lines one more time, we stop and reconsider. There has to
be a better way. Here's a first attempt:

```
function printZeroPaddedWithLabel(number, label) {
  let numberString = String(number);
  while (numberString.length < 3) {
    numberString = "0" + numberString;
  }
  console.log(`${numberString} ${label}`);
}

function printFarmInventory(cows, chickens, pigs) {
  printZeroPaddedWithLabel(cows, "Cows");
  printZeroPaddedWithLabel(chickens, "Chickens");
  printZeroPaddedWithLabel(pigs, "Pigs");
}

printFarmInventory(7, 11, 3);
```

{{index [function, naming]}}

It works! But that name, `printZeroPaddedWithLabel`, is a little
awkward. It conflates three things—printing, zero-padding, and adding
a label—into a single function.

{{index "zeroPad function"}}

Instead of lifting out the repeated part of our program wholesale,
let's try to pick out a single _concept_.

```
function zeroPad(number, width) {
  let string = String(number);
  while (string.length < width) {
    string = "0" + string;
  }
  return string;
}

function printFarmInventory(cows, chickens, pigs) {
  console.log(`${zeroPad(cows, 3)} Cows`);
  console.log(`${zeroPad(chickens, 3)} Chickens`);
  console.log(`${zeroPad(pigs, 3)} Pigs`);
}

printFarmInventory(7, 16, 3);
```

{{index readability, "pure function"}}

A function with a nice, obvious name like `zeroPad` makes it easier
for someone who reads the code to figure out what it does. And such a
function is useful in more situations than just this specific program.
For example, you could use it to help print nicely aligned tables of
numbers.

{{index [interface, design]}}

How smart and versatile _should_ our function be? We could write
anything, from a terribly simple function that can only pad a number
to be three characters wide to a complicated generalized
number-formatting system that handles fractional numbers, negative
numbers, alignment of decimal dots, padding with different characters,
and so on.

A useful principle is to not add cleverness unless you are absolutely
sure you're going to need it. It can be tempting to write general
"((framework))s" for every bit of functionality you come across.
Resist that urge. You won't get any real work done—you'll just be
writing code that you never use.

{{id pure}}
## Functions and side effects

{{index "side effect", "pure function", [function, purity]}}

Functions can be roughly divided into those that are called for their
side effects and those that are called for their return value. (Though
it is definitely also possible to both have side effects and return a
value.)

{{index reuse}}

The first helper function in the ((farm example)),
`printZeroPaddedWithLabel`, is called for its side effect: it prints a
line. The second version, `zeroPad`, is called for its return value.
It is no coincidence that the second is useful in more situations than
the first. Functions that create values are easier to combine in new
ways than functions that directly perform side effects.

{{index substitution}}

A _pure_ function is a specific kind of value-producing function that
not only has no side effects but also doesn't rely on side effects
from other code—for example, it doesn't read global bindings whose
value might change. A pure function has the pleasant property that,
when called with the same arguments, it always produces the same value
(and doesn't do anything else). A call to such a function can be
substituted by its return value without changing the meaning of the
code. When you are not sure that a pure function is working correctly,
you can test it by simply calling it and know that if it works in
that context, it will work in any context. Nonpure functions tend to
require more scaffolding to test.

{{index optimization, "console.log"}}

Still, there's no need to feel bad when writing functions that are not
pure or to wage a holy war to purge them from your code. Side effects
are often useful. There'd be no way to write a pure version of
`console.log`, for example, and `console.log` is good to have. Some
operations are also easier to express in an efficient way when we use
side effects, so computing speed can be a reason to avoid purity.

## Summary

This chapter taught you how to write your own functions. The
`function` keyword, when used as an expression, can create a function
value. When used as a statement, it can be used to declare a binding
and give it a function as its value. Arrow functions are yet another
way to create functions.

```
// Define f to hold a function value
const f = function(a) {
  console.log(a + 2);
};

// Declare g to be a function
function g(a, b) {
  return a * b * 3.5;
}

// A less verbose function value
let h = a => a % 3;
```

A key aspect in understanding functions is understanding scopes. Each
block creates a new scope. Parameters and bindings declared in a given
scope are local and not visible from the outside. Bindings declared
with `var` behave differently—they end up in the nearest function
scope or the global scope.

Separating the tasks your program performs into different functions is
helpful. You won't have to repeat yourself as much, and functions can
help organize a program by grouping code into pieces that do specific
things.

## Exercises

### Minimum

{{index "Math object", "minimum (exercise)", "Math.min function", minimum}}

The [previous chapter](program_structure#return_values) introduced the
standard function `Math.min` that returns its smallest argument. We
can build something like that now. Write a function `min` that takes
two arguments and returns their minimum.

{{if interactive

```{test: no}
// Your code here.

console.log(min(0, 10));
// → 0
console.log(min(0, -10));
// → -10
```
if}}

{{hint

{{index "minimum (exercise)"}}

If you have trouble putting braces and
parentheses in the right place to get a valid function definition,
start by copying one of the examples in this chapter and modifying it.

{{index "return keyword"}}

A function may contain multiple `return` statements.

hint}}

### Recursion

{{index recursion, "isEven (exercise)", "even number"}}

We've seen that `%` (the remainder operator) can be used to test
whether a number is even or odd by using `% 2` to see whether it's
divisible by two. Here's another way to define whether a positive
whole number is even or odd:

- Zero is even.

- One is odd.

- For any other number _N_, its evenness is the same as _N_ - 2.

Define a recursive function `isEven` corresponding to this
description. The function should accept a single parameter (a
positive, whole number) and return a Boolean.

{{index "stack overflow"}}

Test it on 50 and 75. See how it behaves on -1. Why? Can you think of
a way to fix this?

{{if interactive

```{test: no}
// Your code here.

console.log(isEven(50));
// → true
console.log(isEven(75));
// → false
console.log(isEven(-1));
// → ??
```

if}}

{{hint

{{index "isEven (exercise)", ["if keyword", chaining], recursion}}

Your function will likely look somewhat similar to the inner `find`
function in the recursive `findSolution`
[example](functions#recursive_puzzle) in this chapter, with an
`if`/`else if`/`else` chain that tests which of the three cases
applies. The final `else`, corresponding to the third case, makes the
recursive call. Each of the branches should contain a `return`
statement or in some other way arrange for a specific value to be
returned.

{{index "stack overflow"}}

When given a negative number, the function will recurse again and
again, passing itself an ever more negative number, thus getting
further and further away from returning a result. It will eventually
run out of stack space and abort.

hint}}

### Bean counting

{{index "bean counting (exercise)", [string, indexing], "zero-based counting", ["length property", "for string"]}}

You can get the Nth character, or letter, from a string by writing
`"string"[N]`. The returned value will be a string containing only one
character (for example, `"b"`). The first character has position 0,
which causes the last one to be found at position `string.length - 1`.
In other words, a two-character string has length 2, and its
characters have positions 0 and 1.

Write a function `countBs` that takes a string as its only argument
and returns a number that indicates how many uppercase "B" characters
there are in the string.

Next, write a function called `countChar` that behaves like `countBs`,
except it takes a second argument that indicates the character that is
to be counted (rather than counting only uppercase "B" characters).
Rewrite `countBs` to make use of this new function.

{{if interactive

```{test: no}
// Your code here.

console.log(countBs("BBC"));
// → 2
console.log(countChar("kakkerlak", "k"));
// → 4
```

if}}

{{hint

{{index "bean counting (exercise)", ["length property", "for string"], "counter variable"}}

Your function will need a ((loop)) that looks at every character in
the string. It can run an index from zero to one below its length (`<
string.length`). If the character at the current position is the same
as the one the function is looking for, it adds 1 to a counter
variable. Once the loop has finished, the counter can be returned.

{{index "local binding"}}

Take care to make all the bindings used in the function _local_ to the
function by properly declaring them with the `let` or `const` keyword.

hint}}
{{meta {load_files: ["code/journal.js", "code/chapter/04_data.js"], zip: "node/html"}}}

# Data Structures: Objects and Arrays

{{quote {author: "Charles Babbage", title: "Passages from the Life of a Philosopher (1864)", chapter: true}

On two occasions I have been asked, 'Pray, Mr. Babbage, if you put
into the machine wrong figures, will the right answers come out?'
[...] I am not able rightly to apprehend the kind of confusion of
ideas that could provoke such a question.

quote}}

{{index "Babbage, Charles"}}

{{figure {url: "img/chapter_picture_4.jpg", alt: "Picture of a weresquirrel", chapter: framed}}}

{{index object, "data structure"}}

Numbers, Booleans, and strings are the atoms that ((data)) structures
are built from. Many types of information require more than one
atom, though. _Objects_ allow us to group values—including other
objects—to build more complex structures.

The programs we have built so far have been limited by the fact that
they were operating only on simple data types. This chapter will
introduce basic data structures. By the end of it, you'll know enough
to start writing useful programs.

The chapter will work through a more or less realistic programming
example, introducing concepts as they apply to the problem at hand.
The example code will often build on functions and bindings that were
introduced earlier in the text.

{{if book

The online coding ((sandbox)) for the book
([_https://eloquentjavascript.net/code_](https://eloquentjavascript.net/code))
provides a way to run code in the context of a specific chapter. If
you decide to work through the examples in another environment, be
sure to first download the full code for this chapter from the sandbox
page.

if}}

## The weresquirrel

{{index "weresquirrel example", lycanthropy}}

Every now and then, usually between 8 p.m. and 10 p.m.,
((Jacques)) finds himself transforming into a small furry rodent with
a bushy tail.

On one hand, Jacques is quite glad that he doesn't have classic
lycanthropy. Turning into a squirrel does cause fewer problems than
turning into a wolf. Instead of having to worry about accidentally
eating the neighbor (_that_ would be awkward), he worries about being
eaten by the neighbor's cat. After two occasions where he woke up on a
precariously thin branch in the crown of an oak, naked and
disoriented, he has taken to locking the doors and windows of his room
at night and putting a few walnuts on the floor to keep himself busy.

That takes care of the cat and tree problems. But Jacques would prefer
to get rid of his condition entirely. The irregular occurrences of the
transformation make him suspect that they might be triggered by
something. For a while, he believed that it happened only on days when
he had been near oak trees. But avoiding oak trees did not stop the
problem.

{{index journal}}

Switching to a more scientific approach, Jacques has started keeping a
daily log of everything he does on a given day and whether he changed
form. With this data he hopes to narrow down the conditions that
trigger the transformations.

The first thing he needs is a data structure to store this
information.

## Data sets

{{index ["data structure", collection], [memory, organization]}}

To work with a chunk of digital data, we'll first have to find a way
to represent it in our machine's memory. Say, for example, that we
want to represent a ((collection)) of the numbers 2, 3, 5, 7, and 11.

{{index string}}

We could get creative with strings—after all, strings can have any
length, so we can put a lot of data into them—and use `"2 3 5 7 11"`
as our representation. But this is awkward. You'd have to somehow
extract the digits and convert them back to numbers to access them.

{{index [array, creation], "[] (array)"}}

Fortunately, JavaScript provides a data type specifically for storing
sequences of values. It is called an _array_ and is written as a list
of values between ((square brackets)), separated by commas.

```
let listOfNumbers = [2, 3, 5, 7, 11];
console.log(listOfNumbers[2]);
// → 5
console.log(listOfNumbers[0]);
// → 2
console.log(listOfNumbers[2 - 1]);
// → 3
```

{{index "[] (subscript)", [array, indexing]}}

The notation for getting at the elements inside an array also uses
((square brackets)). A pair of square brackets immediately after an
expression, with another expression inside of them, will look up the
element in the left-hand expression that corresponds to the
_((index))_ given by the expression in the brackets.

{{id array_indexing}}
{{index "zero-based counting"}}

The first index of an array is zero, not one. So the first element is
retrieved with `listOfNumbers[0]`. Zero-based counting has a long
tradition in technology and in certain ways makes a lot of sense, but
it takes some getting used to. Think of the index as the amount of
items to skip, counting from the start of the array.

{{id properties}}

## Properties

{{index "Math object", "Math.max function", ["length property", "for string"], [object, property], "period character", [property, access]}}

We've seen a few suspicious-looking expressions like `myString.length`
(to get the length of a string) and `Math.max` (the maximum function)
in past chapters. These are expressions that access a _property_
of some value. In the first case, we access the `length` property of
the value in `myString`. In the second, we access the property named
`max` in the `Math` object (which is a collection of
mathematics-related constants and functions).

{{index [property, access], null, undefined}}

Almost all JavaScript values have properties. The exceptions are
`null` and `undefined`. If you try to access a property on one of
these nonvalues, you get an error.

```{test: no}
null.length;
// → TypeError: null has no properties
```

{{indexsee "dot character", "period character"}}
{{index "[] (subscript)", "period character", "square brackets", "computed property", [property, access]}}

The two main ways to access properties in JavaScript are with a dot
and with square brackets. Both `value.x` and `value[x]` access a
property on `value`—but not necessarily the same property. The
difference is in how `x` is interpreted. When using a dot, the word
after the dot is the literal name of the property. When using square
brackets, the expression between the brackets is _evaluated_ to get
the property name. Whereas `value.x` fetches the property of `value`
named "x", `value[x]` tries to evaluate the expression `x` and uses
the result, converted to a string, as the property name.

So if you know that the property you are interested in is called
_color_, you say `value.color`. If you want to extract the property
named by the value held in the binding `i`, you say `value[i]`.
Property names are strings. They can be any string, but the dot notation works only with
names that look like valid binding names. So if you want to access a
property named _2_ or _John Doe_, you must use square brackets:
`value[2]` or `value["John Doe"]`.

The elements in an ((array)) are stored as the array's properties, using
numbers as property names. Because you can't use the dot notation with
numbers and usually want to use a binding that holds the index
anyway, you have to use the bracket notation to get at them.

{{index ["length property", "for array"], [array, "length of"]}}

The `length` property of an array tells us how many elements it has.
This property name is a valid binding name, and we know its name in
advance, so to find the length of an array, you typically write
`array.length` because that's easier to write than `array["length"]`.

{{id methods}}

## Methods

{{index [function, "as property"], method, string}}

Both string and array values contain, in addition to the `length`
property, a number of properties that hold function values.

```
let doh = "Doh";
console.log(typeof doh.toUpperCase);
// → function
console.log(doh.toUpperCase());
// → DOH
```

{{index "case conversion", "toUpperCase method", "toLowerCase method"}}

Every string has a `toUpperCase` property. When called, it will return
a copy of the string in which all letters have been converted to
uppercase. There is also `toLowerCase`, going the other way.

{{index "this binding"}}

Interestingly, even though the call to `toUpperCase` does not pass any
arguments, the function somehow has access to the string `"Doh"`, the
value whose property we called. How this works is described in
[Chapter ?](object#obj_methods).

Properties that contain functions are generally called _methods_ of
the value they belong to, as in "`toUpperCase` is a method of a
string".

{{id array_methods}}

This example demonstrates two methods you can use to manipulate
arrays:

```
let sequence = [1, 2, 3];
sequence.push(4);
sequence.push(5);
console.log(sequence);
// → [1, 2, 3, 4, 5]
console.log(sequence.pop());
// → 5
console.log(sequence);
// → [1, 2, 3, 4]
```

{{index collection, array, "push method", "pop method"}}

The `push` method adds values to the end of an array, and the
`pop` method does the opposite, removing the last value in the array
and returning it.

{{index ["data structure", stack]}}

These somewhat silly names are the traditional terms for operations on
a _((stack))_. A stack, in programming, is a data structure that
allows you to push values into it and pop them out again in the
opposite order so that the thing that was added last is removed first.
These are common in programming—you might remember the function ((call
stack)) from [the previous chapter](functions#stack), which is an
instance of the same idea.

## Objects

{{index journal, "weresquirrel example", array, record}}

Back to the weresquirrel. A set of daily log entries can be
represented as an array. But the entries do not consist of just a
number or a string—each entry needs to store a list of activities and
a Boolean value that indicates whether Jacques turned into a squirrel
or not. Ideally, we would like to group these together into a single
value and then put those grouped values into an array of log entries.

{{index [syntax, object], [property, definition], [braces, object], "{} (object)"}}

Values of the type _((object))_ are arbitrary collections of
properties. One way to create an object is by using braces as an
expression.

```
let day1 = {
  squirrel: false,
  events: ["work", "touched tree", "pizza", "running"]
};
console.log(day1.squirrel);
// → false
console.log(day1.wolf);
// → undefined
day1.wolf = false;
console.log(day1.wolf);
// → false
```

{{index [quoting, "of object properties"], "colon character"}}

Inside the braces, there is a list of properties separated by commas.
Each property has a name followed by a colon and a value. When an
object is written over multiple lines, indenting it like in the
example helps with readability. Properties whose names aren't valid
binding names or valid numbers have to be quoted.

```
let descriptions = {
  work: "Went to work",
  "touched tree": "Touched a tree"
};
```

{{index [braces, object]}}

This means that braces have _two_ meanings in JavaScript. At
the start of a ((statement)), they start a ((block)) of statements. In
any other position, they describe an object. Fortunately, it is rarely
useful to start a statement with an object in braces, so the
ambiguity between these two is not much of a problem.

{{index undefined}}

Reading a property that doesn't exist will give you the value
`undefined`.

{{index [property, assignment], mutability, "= operator"}}

It is possible to assign a value to a property expression with the `=`
operator. This will replace the property's value if it already existed
or create a new property on the object if it didn't.

{{index "tentacle (analogy)", [property, "model of"], [binding, "model of"]}}

To briefly return to our tentacle model of ((binding))s—property
bindings are similar. They _grasp_ values, but other bindings and
properties might be holding onto those same values. You may think of
objects as octopuses with any number of tentacles, each of which has a
name tattooed on it.

{{index "delete operator", [property, deletion]}}

The `delete` operator cuts off a tentacle from such an octopus. It is
a unary operator that, when applied to an object property,
will remove the named property from the object. This is not a common
thing to do, but it is possible.

```
let anObject = {left: 1, right: 2};
console.log(anObject.left);
// → 1
delete anObject.left;
console.log(anObject.left);
// → undefined
console.log("left" in anObject);
// → false
console.log("right" in anObject);
// → true
```

{{index "in operator", [property, "testing for"], object}}

The binary `in` operator, when applied to a string and an object,
tells you whether that object has a property with that name. The difference
between setting a property to `undefined` and actually deleting it is
that, in the first case, the object still _has_ the property (it just
doesn't have a very interesting value), whereas in the second case the
property is no longer present and `in` will return `false`.

{{index "Object.keys function"}}

To find out what properties an object has, you can use the
`Object.keys` function. You give it an object, and it returns an array
of strings—the object's property names.

```
console.log(Object.keys({x: 0, y: 0, z: 2}));
// → ["x", "y", "z"]
```

There's an `Object.assign` function that copies all properties from
one object into another.

```
let objectA = {a: 1, b: 2};
Object.assign(objectA, {b: 3, c: 4});
console.log(objectA);
// → {a: 1, b: 3, c: 4}
```

{{index array, collection}}

Arrays, then, are just a kind of object specialized for storing
sequences of things. If you evaluate `typeof []`, it produces
`"object"`. You can see them as long, flat octopuses with all their
tentacles in a neat row, labeled with numbers.

{{index journal, "weresquirrel example"}}

We will represent the journal that Jacques keeps as an array of objects.

```{test: wrap}
let journal = [
  {events: ["work", "touched tree", "pizza",
            "running", "television"],
   squirrel: false},
  {events: ["work", "ice cream", "cauliflower",
            "lasagna", "touched tree", "brushed teeth"],
   squirrel: false},
  {events: ["weekend", "cycling", "break", "peanuts",
            "beer"],
   squirrel: true},
  /* and so on... */
];
```

## Mutability

We will get to actual programming _real_ soon now. First there's one
more piece of theory to understand.

{{index mutability, "side effect", number, string, Boolean, [object, mutability]}}

We saw that object values can be modified. The types of values
discussed in earlier chapters, such as numbers, strings, and Booleans,
are all _((immutable))_—it is impossible to change values of those
types. You can combine them and derive new values from them, but when
you take a specific string value, that value will always remain the
same. The text inside it cannot be changed. If you have a string that
contains `"cat"`, it is not possible for other code to change a
character in your string to make it spell `"rat"`.

Objects work differently. You _can_ change their properties,
causing a single object value to have different content at different times.

{{index [object, identity], identity, [memory, organization], mutability}}

When we have two numbers, 120 and 120, we can consider them precisely
the same number, whether or not they refer to the same physical bits.
With objects, there is a difference between having two references to
the same object and having two different objects that contain the same
properties. Consider the following code:

```
let object1 = {value: 10};
let object2 = object1;
let object3 = {value: 10};

console.log(object1 == object2);
// → true
console.log(object1 == object3);
// → false

object1.value = 15;
console.log(object2.value);
// → 15
console.log(object3.value);
// → 10
```

{{index "tentacle (analogy)", [binding, "model of"]}}

The `object1` and `object2` bindings grasp the _same_ object, which is
why changing `object1` also changes the value of `object2`. They are
said to have the same _identity_. The binding `object3` points to a
different object, which initially contains the same properties as
`object1` but lives a separate life.

{{index "const keyword", "let keyword", [binding, "as state"]}}

Bindings can also be changeable or constant, but this is separate from
the way their values behave. Even though number values don't change,
you can use a `let` binding to keep track of a changing number by
changing the value the binding points at. Similarly, though a `const`
binding to an object can itself not be changed and will continue to
point at the same object, the _contents_ of that object might change.

```{test: no}
const score = {visitors: 0, home: 0};
// This is okay
score.visitors = 1;
// This isn't allowed
score = {visitors: 1, home: 1};
```

{{index "== operator", [comparison, "of objects"], "deep comparison"}}

When you compare objects with JavaScript's `==` operator, it compares
by identity: it will produce `true` only if both objects are precisely
the same value. Comparing different objects will return `false`, even
if they have identical properties. There is no "deep" comparison
operation built into JavaScript, which compares objects by contents,
but it is possible to write it yourself (which is one of the
[exercises](data#exercise_deep_compare) at the end of this chapter).

## The lycanthrope's log

{{index "weresquirrel example", lycanthropy, "addEntry function"}}

So, Jacques starts up his JavaScript interpreter and sets up the
environment he needs to keep his ((journal)).

```{includeCode: true}
let journal = [];

function addEntry(events, squirrel) {
  journal.push({events, squirrel});
}
```

{{index [braces, object], "{} (object)", [property, definition]}}

Note that the object added to the journal looks a little odd. Instead
of declaring properties like `events: events`, it just gives a
property name. This is shorthand that means the same thing—if a
property name in brace notation isn't followed by a value, its
value is taken from the binding with the same name.

So then, every evening at 10 p.m.—or sometimes the next morning, after
climbing down from the top shelf of his bookcase—Jacques records the
day.

```
addEntry(["work", "touched tree", "pizza", "running",
          "television"], false);
addEntry(["work", "ice cream", "cauliflower", "lasagna",
          "touched tree", "brushed teeth"], false);
addEntry(["weekend", "cycling", "break", "peanuts",
          "beer"], true);
```

Once he has enough data points, he intends to use statistics to find
out which of these events may be related to the squirrelifications.

{{index correlation}}

_Correlation_ is a measure of ((dependence)) between statistical
variables. A statistical variable is not quite the same as a
programming variable. In statistics you typically have a set of
_measurements_, and each variable is measured for every measurement.
Correlation between variables is usually expressed as a value that
ranges from -1 to 1. Zero correlation means the variables are not
related. A correlation of one indicates that the two are perfectly
related—if you know one, you also know the other. Negative one also
means that the variables are perfectly related but that they are
opposites—when one is true, the other is false.

{{index "phi coefficient"}}

To compute the measure of correlation between two Boolean variables,
we can use the _phi coefficient_ (_ϕ_). This is a formula whose input
is a ((frequency table)) containing the number of times the different
combinations of the variables were observed. The output of the formula
is a number between -1 and 1 that describes the correlation.

We could take the event of eating ((pizza)) and put that in a
frequency table like this, where each number indicates the amount of
times that combination occurred in our measurements:

{{figure {url: "img/pizza-squirrel.svg", alt: "Eating pizza versus turning into a squirrel", width: "7cm"}}}

If we call that table _n_, we can compute _ϕ_ using the following formula:

{{if html

<div>
<table style="border-collapse: collapse; margin-left: 1em;"><tr>
  <td style="vertical-align: middle"><em>ϕ</em> =</td>
  <td style="padding-left: .5em">
    <div style="border-bottom: 1px solid black; padding: 0 7px;"><em>n</em><sub>11</sub><em>n</em><sub>00</sub> −
      <em>n</em><sub>10</sub><em>n</em><sub>01</sub></div>
    <div style="padding: 0 7px;">√<span style="border-top: 1px solid black; position: relative; top: 2px;">
      <span style="position: relative; top: -4px"><em>n</em><sub>1•</sub><em>n</em><sub>0•</sub><em>n</em><sub>•1</sub><em>n</em><sub>•0</sub></span>
    </span></div>
  </td>
</tr></table>
</div>

if}}

{{if tex

[\begin{equation}\varphi = \frac{n_{11}n_{00}-n_{10}n_{01}}{\sqrt{n_{1\bullet}n_{0\bullet}n_{\bullet1}n_{\bullet0}}}\end{equation}]{latex}

if}}

(If at this point you're putting the book down to focus on a terrible
flashback to 10th grade math class—hold on! I do not intend to torture
you with endless pages of cryptic notation—it's just this one formula for
now. And even with this one, all we do is turn it into JavaScript.)

The notation [_n_~01~]{if html}[[$n_{01}$]{latex}]{if tex} indicates
the number of measurements where the first variable (squirrelness) is
false (0) and the second variable (pizza) is true (1). In the pizza
table, [_n_~01~]{if html}[[$n_{01}$]{latex}]{if tex} is 9.

The value [_n_~1•~]{if html}[[$n_{1\bullet}$]{latex}]{if tex} refers
to the sum of all measurements where the first variable is true, which
is 5 in the example table. Likewise, [_n_~•0~]{if
html}[[$n_{\bullet0}$]{latex}]{if tex} refers to the sum of the
measurements where the second variable is false.

{{index correlation, "phi coefficient"}}

So for the pizza table, the part above the division line (the
dividend) would be 1×76−4×9 = 40, and the part below it (the
divisor) would be the square root of 5×85×10×80, or [√340000]{if
html}[[$\sqrt{340000}$]{latex}]{if tex}. This comes out to _ϕ_ ≈
0.069, which is tiny. Eating ((pizza)) does not appear to have
influence on the transformations.

## Computing correlation

{{index [array, "as table"], [nesting, "of arrays"]}}

We can represent a two-by-two ((table)) in JavaScript with a
four-element array (`[76, 9, 4, 1]`). We could also use other
representations, such as an array containing two two-element arrays
(`[[76, 9], [4, 1]]`) or an object with property names like `"11"` and
`"01"`, but the flat array is simple and makes the expressions that
access the table pleasantly short. We'll interpret the indices to the
array as two-((bit)) ((binary number))s, where the leftmost (most
significant) digit refers to the squirrel variable and the rightmost
(least significant) digit refers to the event variable. For example,
the binary number `10` refers to the case where Jacques did turn into
a squirrel, but the event (say, "pizza") didn't occur. This happened
four times. And since binary `10` is 2 in decimal notation, we will
store this number at index 2 of the array.

{{index "phi coefficient", "phi function"}}

{{id phi_function}}

This is the function that computes the _ϕ_ coefficient from such an
array:

```{includeCode: strip_log, test: clip}
function phi(table) {
  return (table[3] * table[0] - table[2] * table[1]) /
    Math.sqrt((table[2] + table[3]) *
              (table[0] + table[1]) *
              (table[1] + table[3]) *
              (table[0] + table[2]));
}

console.log(phi([76, 9, 4, 1]));
// → 0.068599434
```

{{index "square root", "Math.sqrt function"}}

This is a direct translation of the _ϕ_ formula into JavaScript.
`Math.sqrt` is the square root function, as provided by the `Math`
object in a standard JavaScript environment. We have to add two fields
from the table to get fields like [n~1•~]{if
html}[[$n_{1\bullet}$]{latex}]{if tex} because the sums of rows or
columns are not stored directly in our data structure.

{{index "JOURNAL data set"}}

Jacques kept his journal for three months. The resulting ((data set))
is available in the [coding
sandbox](https://eloquentjavascript.net/code#4) for this chapter[
([_https://eloquentjavascript.net/code#4_](https://eloquentjavascript.net/code#4))]{if
book}, where it is stored in the `JOURNAL` binding and in a
downloadable
[file](https://eloquentjavascript.net/code/journal.js).

{{index "tableFor function"}}

To extract a two-by-two ((table)) for a specific event from the
journal, we must loop over all the entries and tally how many times
the event occurs in relation to squirrel transformations.

```{includeCode: strip_log}
function tableFor(event, journal) {
  let table = [0, 0, 0, 0];
  for (let i = 0; i < journal.length; i++) {
    let entry = journal[i], index = 0;
    if (entry.events.includes(event)) index += 1;
    if (entry.squirrel) index += 2;
    table[index] += 1;
  }
  return table;
}

console.log(tableFor("pizza", JOURNAL));
// → [76, 9, 4, 1]
```

{{index [array, searching], "includes method"}}

Arrays have an `includes` method that checks whether a given value
exists in the array. The function uses that to determine whether the
event name it is interested in is part of the event list for a given
day.

{{index [array, indexing]}}

The body of the loop in `tableFor` figures out which box in the table
each journal entry falls into by checking whether the entry contains
the specific event it's interested in and whether the event happens
alongside a squirrel incident. The loop then adds one to the correct
box in the table.

We now have the tools we need to compute individual ((correlation))s.
The only step remaining is to find a correlation for every type of
event that was recorded and see whether anything stands out.

{{id for_of_loop}}

## Array loops

{{index "for loop", loop, [array, iteration]}}

In the `tableFor` function, there's a loop like this:

```
for (let i = 0; i < JOURNAL.length; i++) {
  let entry = JOURNAL[i];
  // Do something with entry
}
```

This kind of loop is common in classical JavaScript—going over arrays
one element at a time is something that comes up a lot, and to do that
you'd run a counter over the length of the array and pick out each
element in turn.

There is a simpler way to write such loops in modern JavaScript.

```
for (let entry of JOURNAL) {
  console.log(`${entry.events.length} events.`);
}
```

{{index "for/of loop"}}

When a `for` loop looks like this, with the word `of` after a variable
definition, it will loop over the elements of the value given after
`of`. This works not only for arrays but also for strings and some
other data structures. We'll discuss _how_ it works in [Chapter
?](object).

{{id analysis}}

## The final analysis

{{index journal, "weresquirrel example", "journalEvents function"}}

We need to compute a correlation for every type of event that occurs
in the data set. To do that, we first need to _find_ every type of
event.

{{index "includes method", "push method"}}

```{includeCode: "strip_log"}
function journalEvents(journal) {
  let events = [];
  for (let entry of journal) {
    for (let event of entry.events) {
      if (!events.includes(event)) {
        events.push(event);
      }
    }
  }
  return events;
}

console.log(journalEvents(JOURNAL));
// → ["carrot", "exercise", "weekend", "bread", …]
```

By going over all the events and adding those that aren't already in
there to the `events` array, the function collects every type of
event.

Using that, we can see all the ((correlation))s.

```{test: no}
for (let event of journalEvents(JOURNAL)) {
  console.log(event + ":", phi(tableFor(event, JOURNAL)));
}
// → carrot:   0.0140970969
// → exercise: 0.0685994341
// → weekend:  0.1371988681
// → bread:   -0.0757554019
// → pudding: -0.0648203724
// and so on...
```

Most correlations seem to lie close to zero. Eating carrots, bread, or
pudding apparently does not trigger squirrel-lycanthropy. It _does_
seem to occur somewhat more often on weekends. Let's filter the
results to show only correlations greater than 0.1 or less than -0.1.

```{test: no, startCode: true}
for (let event of journalEvents(JOURNAL)) {
  let correlation = phi(tableFor(event, JOURNAL));
  if (correlation > 0.1 || correlation < -0.1) {
    console.log(event + ":", correlation);
  }
}
// → weekend:        0.1371988681
// → brushed teeth: -0.3805211953
// → candy:          0.1296407447
// → work:          -0.1371988681
// → spaghetti:      0.2425356250
// → reading:        0.1106828054
// → peanuts:        0.5902679812
```

Aha! There are two factors with a ((correlation)) that's clearly stronger
than the others. Eating ((peanuts)) has a strong positive effect on
the chance of turning into a squirrel, whereas brushing his teeth has
a significant negative effect.

Interesting. Let's try something.

```
for (let entry of JOURNAL) {
  if (entry.events.includes("peanuts") &&
     !entry.events.includes("brushed teeth")) {
    entry.events.push("peanut teeth");
  }
}
console.log(phi(tableFor("peanut teeth", JOURNAL)));
// → 1
```

That's a strong result. The phenomenon occurs precisely when Jacques
eats ((peanuts)) and fails to brush his teeth. If only he weren't such
a slob about dental hygiene, he'd have never even noticed his
affliction.

Knowing this, Jacques stops eating peanuts altogether and finds that
his transformations don't come back.

{{index "weresquirrel example"}}

For a few years, things go great for Jacques. But at some point he
loses his job. Because he lives in a nasty country where having no job
means having no medical services, he is forced to take employment with
a ((circus)) where he performs as _The Incredible Squirrelman_,
stuffing his mouth with peanut butter before every show.

One day, fed up with this pitiful existence, Jacques fails to change
back into his human form, hops through a crack in the circus tent, and
vanishes into the forest. He is never seen again.

## Further arrayology

{{index [array, methods], [method, array]}}

Before finishing the chapter, I want to introduce you to a few more
object-related concepts. I'll start by introducing some generally
useful array methods.

{{index "push method", "pop method", "shift method", "unshift method"}}

We saw `push` and `pop`, which add and remove elements at the
end of an array, [earlier](data#array_methods) in this
chapter. The corresponding methods for adding and removing things at
the start of an array are called `unshift` and `shift`.

```
let todoList = [];
function remember(task) {
  todoList.push(task);
}
function getTask() {
  return todoList.shift();
}
function rememberUrgently(task) {
  todoList.unshift(task);
}
```

{{index "task management example"}}

That program manages a queue of tasks. You add tasks to the end of the
queue by calling `remember("groceries")`, and when you're ready to do
something, you call `getTask()` to get (and remove) the front item
from the queue. The `rememberUrgently` function also adds a task but
adds it to the front instead of the back of the queue.

{{index [array, searching], "indexOf method", "lastIndexOf method"}}

To search for a specific value, arrays provide an `indexOf` method. The method
searches through the array from the start to the end and returns the
index at which the requested value was found—or -1 if it wasn't found.
To search from the end instead of the start, there's a similar method
called `lastIndexOf`.

```
console.log([1, 2, 3, 2, 1].indexOf(2));
// → 1
console.log([1, 2, 3, 2, 1].lastIndexOf(2));
// → 3
```

Both `indexOf` and `lastIndexOf` take an optional second argument that
indicates where to start searching.

{{index "slice method", [array, indexing]}}

Another fundamental array method is `slice`, which takes start and end
indices and returns an array that has only the elements between them.
The start index is inclusive, the end index exclusive.

```
console.log([0, 1, 2, 3, 4].slice(2, 4));
// → [2, 3]
console.log([0, 1, 2, 3, 4].slice(2));
// → [2, 3, 4]
```

{{index [string, indexing]}}

When the end index is not given, `slice` will take all of the elements
after the start index. You can also omit the start index to copy the
entire array.

{{index concatenation, "concat method"}}

The `concat` method can be used to glue arrays together to create a
new array, similar to what the `+` operator does for strings.

The following example shows both `concat` and `slice` in action. It takes
an array and an index, and it returns a new array that is a copy of
the original array with the element at the given index removed.

```
function remove(array, index) {
  return array.slice(0, index)
    .concat(array.slice(index + 1));
}
console.log(remove(["a", "b", "c", "d", "e"], 2));
// → ["a", "b", "d", "e"]
```

If you pass `concat` an argument that is not an array, that value will
be added to the new array as if it were a one-element array.

## Strings and their properties

{{index [string, properties]}}

We can read properties like `length` and `toUpperCase` from string
values. But if you try to add a new property, it doesn't stick.

```
let kim = "Kim";
kim.age = 88;
console.log(kim.age);
// → undefined
```

Values of type string, number, and Boolean are not objects, and though
the language doesn't complain if you try to set new properties on
them, it doesn't actually store those properties. As mentioned earlier,
such values are immutable and cannot be changed.

{{index [string, methods], "slice method", "indexOf method", [string, searching]}}

But these types do have built-in properties. Every string value has a
number of methods. Some very useful ones are `slice` and `indexOf`,
which resemble the array methods of the same name.

```
console.log("coconuts".slice(4, 7));
// → nut
console.log("coconut".indexOf("u"));
// → 5
```

One difference is that a string's `indexOf` can search for a string
containing more than one character, whereas the corresponding array
method looks only for a single element.

```
console.log("one two three".indexOf("ee"));
// → 11
```

{{index [whitespace, trimming], "trim method"}}

The `trim` method removes whitespace (spaces, newlines, tabs, and
similar characters) from the start and end of a string.

```
console.log("  okay \n ".trim());
// → okay
```

The `zeroPad` function from the [previous chapter](functions) also
exists as a method. It is called `padStart` and takes the desired
length and padding character as arguments.

```
console.log(String(6).padStart(3, "0"));
// → 006
```

{{id split}}

You can split a string on every occurrence of another string with
`split` and join it again with `join`.

```
let sentence = "Secretarybirds specialize in stomping";
let words = sentence.split(" ");
console.log(words);
// → ["Secretarybirds", "specialize", "in", "stomping"]
console.log(words.join(". "));
// → Secretarybirds. specialize. in. stomping
```

{{index "repeat method"}}

A string can be repeated with the `repeat` method, which creates a new
string containing multiple copies of the original string, glued
together.

```
console.log("LA".repeat(3));
// → LALALA
```

{{index ["length property", "for string"], [string, indexing]}}

We have already seen the string type's `length` property. Accessing
the individual characters in a string looks like accessing array
elements (with a caveat that we'll discuss in [Chapter
?](higher_order#code_units)).

```
let string = "abc";
console.log(string.length);
// → 3
console.log(string[1]);
// → b
```

{{id rest_parameters}}

## Rest parameters

{{index "Math.max function"}}

It can be useful for a function to accept any number of ((argument))s.
For example, `Math.max` computes the maximum of _all_ the arguments it
is given.

{{index "period character", "max example", spread}}

To write such a function, you put three dots before the function's
last ((parameter)), like this:

```{includeCode: strip_log}
function max(...numbers) {
  let result = -Infinity;
  for (let number of numbers) {
    if (number > result) result = number;
  }
  return result;
}
console.log(max(4, 1, 9, -2));
// → 9
```

When such a function is called, the _((rest parameter))_ is bound to
an array containing all further arguments. If there are other
parameters before it, their values aren't part of that array. When, as
in `max`, it is the only parameter, it will hold all arguments.

{{index [function, application]}}

You can use a similar three-dot notation to _call_ a function with an
array of arguments.

```
let numbers = [5, 1, 7];
console.log(max(...numbers));
// → 7
```

This "((spread))s" out the array into the function call, passing its
elements as separate arguments. It is possible to include an array
like that along with other arguments, as in `max(9, ...numbers, 2)`.

{{index [array, "of rest arguments"], "square brackets"}}

Square bracket array notation similarly allows the triple-dot operator
to spread another array into the new array.

```
let words = ["never", "fully"];
console.log(["will", ...words, "understand"]);
// → ["will", "never", "fully", "understand"]
```

## The Math object

{{index "Math object", "Math.min function", "Math.max function", "Math.sqrt function", minimum, maximum, "square root"}}

As we've seen, `Math` is a grab bag of number-related utility
functions, such as `Math.max` (maximum), `Math.min` (minimum), and
`Math.sqrt` (square root).

{{index namespace, [object, property]}}

{{id namespace_pollution}}

The `Math` object is used as a container to group a bunch of related
functionality. There is only one `Math` object, and it is almost never
useful as a value. Rather, it provides a _namespace_ so that all these
functions and values do not have to be global bindings.

{{index [binding, naming]}}

Having too many global bindings "pollutes" the namespace. The more
names have been taken, the more likely you are to accidentally
overwrite the value of some existing binding. For example, it's not
unlikely to want to name something `max` in one of your programs.
Since JavaScript's built-in `max` function is tucked safely inside the
`Math` object, we don't have to worry about overwriting it.

{{index "let keyword", "const keyword"}}

Many languages will stop you, or at least warn you, when you are
defining a binding with a name that is already taken. JavaScript does
this for bindings you declared with `let` or `const`
but—perversely—not for standard bindings nor for bindings declared
with `var` or `function`.

{{index "Math.cos function", "Math.sin function", "Math.tan function", "Math.acos function", "Math.asin function", "Math.atan function", "Math.PI constant", cosine, sine, tangent, "PI constant", pi}}

Back to the `Math` object. If you need to do ((trigonometry)), `Math`
can help. It contains `cos` (cosine), `sin` (sine), and `tan`
(tangent), as well as their inverse functions, `acos`, `asin`, and
`atan`, respectively. The number π (pi)—or at least the closest
approximation that fits in a JavaScript number—is available as
`Math.PI`. There is an old programming tradition of writing the names
of ((constant)) values in all caps.

```{test: no}
function randomPointOnCircle(radius) {
  let angle = Math.random() * 2 * Math.PI;
  return {x: radius * Math.cos(angle),
          y: radius * Math.sin(angle)};
}
console.log(randomPointOnCircle(2));
// → {x: 0.3667, y: 1.966}
```

If sines and cosines are not something you are familiar with, don't
worry. When they are used in this book, in [Chapter ?](dom#sin_cos),
I'll explain them.

{{index "Math.random function", "random number"}}

The previous example used `Math.random`. This is a function that
returns a new pseudorandom number between zero (inclusive) and one
(exclusive) every time you call it.

```{test: no}
console.log(Math.random());
// → 0.36993729369714856
console.log(Math.random());
// → 0.727367032552138
console.log(Math.random());
// → 0.40180766698904335
```

{{index "pseudorandom number", "random number"}}

Though computers are deterministic machines—they always react the same
way if given the same input—it is possible to have them produce
numbers that appear random. To do that, the machine keeps some hidden
value, and whenever you ask for a new random number, it performs
complicated computations on this hidden value to create a new value.
It stores a new value and returns some number derived from it. That
way, it can produce ever new, hard-to-predict numbers in a way that
_seems_ random.

{{index rounding, "Math.floor function"}}

If we want a whole random number instead of a fractional one, we can
use `Math.floor` (which rounds down to the nearest whole number) on
the result of `Math.random`.

```{test: no}
console.log(Math.floor(Math.random() * 10));
// → 2
```

Multiplying the random number by 10 gives us a number greater than or
equal to 0 and below 10. Since `Math.floor` rounds down, this
expression will produce, with equal chance, any number from 0 through
9.

{{index "Math.ceil function", "Math.round function", "Math.abs function", "absolute value"}}

There are also the functions `Math.ceil` (for "ceiling", which rounds
up to a whole number), `Math.round` (to the nearest whole number), and
`Math.abs`, which takes the absolute value of a number, meaning it
negates negative values but leaves positive ones as they are.

## Destructuring

{{index "phi function"}}

Let's go back to the `phi` function for a moment.

```{test: wrap}
function phi(table) {
  return (table[3] * table[0] - table[2] * table[1]) /
    Math.sqrt((table[2] + table[3]) *
              (table[0] + table[1]) *
              (table[1] + table[3]) *
              (table[0] + table[2]));
}
```

{{index "destructuring binding", parameter}}

One of the reasons this function is awkward to read is that we have a
binding pointing at our array, but we'd much prefer to have bindings
for the _elements_ of the array, that is, `let n00 = table[0]` and so on.
Fortunately, there is a succinct way to do this in JavaScript.

```
function phi([n00, n01, n10, n11]) {
  return (n11 * n00 - n10 * n01) /
    Math.sqrt((n10 + n11) * (n00 + n01) *
              (n01 + n11) * (n00 + n10));
}
```

{{index "let keyword", "var keyword", "const keyword", [binding, destructuring]}}

This also works for bindings created with `let`, `var`, or
`const`. If you know the value you are binding is an array, you can
use ((square brackets)) to "look inside" of the value, binding its
contents.

{{index [object, property], [braces, object]}}

A similar trick works for objects, using braces instead of square
brackets.

```
let {name} = {name: "Faraji", age: 23};
console.log(name);
// → Faraji
```

{{index null, undefined}}

Note that if you try to destructure `null` or `undefined`, you get an
error, much as you would if you directly try to access a property
of those values.

## JSON

{{index [array, representation], [object, representation], "data format", [memory, organization]}}

Because properties only grasp their value, rather than contain it,
objects and arrays are stored in the computer's memory as
sequences of bits holding the _((address))es_—the place in memory—of
their contents. So an array with another array inside of it consists
of (at least) one memory region for the inner array, and another for
the outer array, containing (among other things) a binary number that
represents the position of the inner array.

If you want to save data in a file for later or send it to another
computer over the network, you have to somehow convert these tangles
of memory addresses to a description that can be stored or sent. You
_could_ send over your entire computer memory along with the address
of the value you're interested in, I suppose, but that doesn't seem
like the best approach.

{{indexsee "JavaScript Object Notation", JSON}}

{{index serialization, "World Wide Web"}}

What we can do is _serialize_ the data. That means it is converted
into a flat description. A popular serialization format is called
_((JSON))_ (pronounced "Jason"), which stands for JavaScript Object
Notation. It is widely used as a data storage and communication format
on the Web, even in languages other than JavaScript.

{{index [array, notation], [object, creation], [quoting, "in JSON"], comment}}

JSON looks similar to JavaScript's way of writing arrays and objects,
with a few restrictions. All property names have to be surrounded by
double quotes, and only simple data expressions are allowed—no
function calls, bindings, or anything that involves actual
computation. Comments are not allowed in JSON.

A journal entry might look like this when represented as JSON data:

```{lang: "application/json"}
{
  "squirrel": false,
  "events": ["work", "touched tree", "pizza", "running"]
}
```

{{index "JSON.stringify function", "JSON.parse function", serialization, deserialization, parsing}}

JavaScript gives us the functions `JSON.stringify` and `JSON.parse` to
convert data to and from this format. The first takes a JavaScript
value and returns a JSON-encoded string. The second takes such a
string and converts it to the value it encodes.

```
let string = JSON.stringify({squirrel: false,
                             events: ["weekend"]});
console.log(string);
// → {"squirrel":false,"events":["weekend"]}
console.log(JSON.parse(string).events);
// → ["weekend"]
```

## Summary

Objects and arrays (which are a specific kind of object) provide ways
to group several values into a single value. Conceptually, this allows
us to put a bunch of related things in a bag and run around with the
bag, instead of wrapping our arms around all of the individual things
and trying to hold on to them separately.

Most values in JavaScript have properties, the exceptions being `null`
and `undefined`. Properties are accessed using `value.prop` or
`value["prop"]`. Objects tend to use names for their properties
and store more or less a fixed set of them. Arrays, on the other hand,
usually contain varying amounts of conceptually identical values and
use numbers (starting from 0) as the names of their properties.

There _are_ some named properties in arrays, such as `length` and a
number of methods. Methods are functions that live in properties and
(usually) act on the value they are a property of.

You can iterate over arrays using a special kind of `for` loop—`for
(let element of array)`.

## Exercises

### The sum of a range

{{index "summing (exercise)"}}

The [introduction](intro) of this book alluded to the following as a
nice way to compute the sum of a range of numbers:

```{test: no}
console.log(sum(range(1, 10)));
```

{{index "range function", "sum function"}}

Write a `range` function that takes two arguments, `start` and `end`,
and returns an array containing all the numbers from `start` up to
(and including) `end`.

Next, write a `sum` function that takes an array of numbers and
returns the sum of these numbers. Run the example program and see
whether it does indeed return 55.

{{index "optional argument"}}

As a bonus assignment, modify your `range` function to take an
optional third argument that indicates the "step" value used when
building the array. If no step is given, the elements go up by
increments of one, corresponding to the old behavior. The function
call `range(1, 10, 2)` should return `[1, 3, 5, 7, 9]`. Make sure it
also works with negative step values so that `range(5, 2, -1)`
produces `[5, 4, 3, 2]`.

{{if interactive

```{test: no}
// Your code here.

console.log(range(1, 10));
// → [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
console.log(range(5, 2, -1));
// → [5, 4, 3, 2]
console.log(sum(range(1, 10)));
// → 55
```

if}}

{{hint

{{index "summing (exercise)", [array, creation], "square brackets"}}

Building up an array is most easily done by first initializing a
binding to `[]` (a fresh, empty array) and repeatedly calling its
`push` method to add a value. Don't forget to return the array at the
end of the function.

{{index [array, indexing], comparison}}

Since the end boundary is inclusive, you'll need to use the `<=`
operator rather than `<` to check for the end of your loop.

{{index "arguments object"}}

The step parameter can be an optional parameter that defaults (using
the `=` operator) to 1.

{{index "range function", "for loop"}}

Having `range` understand negative step values is probably best done
by writing two separate loops—one for counting up and one for counting
down—because the comparison that checks whether the loop is finished
needs to be `>=` rather than `<=` when counting downward.

It might also be worthwhile to use a different default step, namely,
-1, when the end of the range is smaller than the start. That way,
`range(5, 2)` returns something meaningful, rather than getting stuck
in an ((infinite loop)). It is possible to refer to previous
parameters in the default value of a parameter.

hint}}

### Reversing an array

{{index "reversing (exercise)", "reverse method", [array, methods]}}

Arrays have a `reverse` method that changes the array by inverting
the order in which its elements appear. For this exercise, write two
functions, `reverseArray` and `reverseArrayInPlace`. The first,
`reverseArray`, takes an array as argument and produces a _new_ array
that has the same elements in the inverse order. The second,
`reverseArrayInPlace`, does what the `reverse` method does: it
_modifies_ the array given as argument by reversing its elements.
Neither may use the standard `reverse` method.

{{index efficiency, "pure function", "side effect"}}

Thinking back to the notes about side effects and pure functions in
the [previous chapter](functions#pure), which variant do you expect to
be useful in more situations? Which one runs faster?

{{if interactive

```{test: no}
// Your code here.

console.log(reverseArray(["A", "B", "C"]));
// → ["C", "B", "A"];
let arrayValue = [1, 2, 3, 4, 5];
reverseArrayInPlace(arrayValue);
console.log(arrayValue);
// → [5, 4, 3, 2, 1]
```

if}}

{{hint

{{index "reversing (exercise)"}}

There are two obvious ways to implement `reverseArray`. The first is
to simply go over the input array from front to back and use the
`unshift` method on the new array to insert each element at its start.
The second is to loop over the input array backwards and use the `push`
method. Iterating over an array backwards requires a (somewhat awkward)
`for` specification, like `(let i = array.length - 1; i >= 0; i--)`.

{{index "slice method"}}

Reversing the array in place is harder. You have to be careful not to
overwrite elements that you will later need. Using `reverseArray` or
otherwise copying the whole array (`array.slice(0)` is a good way to
copy an array) works but is cheating.

The trick is to _swap_ the first and last elements, then the second
and second-to-last, and so on. You can do this by looping over half
the length of the array (use `Math.floor` to round down—you don't need
to touch the middle element in an array with an odd number of
elements) and swapping the element at position `i` with the one at
position `array.length - 1 - i`. You can use a local binding to
briefly hold on to one of the elements, overwrite that one with its
mirror image, and then put the value from the local binding in the
place where the mirror image used to be.

hint}}

{{id list}}

### A list

{{index ["data structure", list], "list (exercise)", "linked list", array, collection}}

Objects, as generic blobs of values, can be used to build all sorts of
data structures. A common data structure is the _list_ (not to be
confused with array). A list is a nested set of objects, with the
first object holding a reference to the second, the second to the
third, and so on.

```{includeCode: true}
let list = {
  value: 1,
  rest: {
    value: 2,
    rest: {
      value: 3,
      rest: null
    }
  }
};
```

The resulting objects form a chain, like this:

{{figure {url: "img/linked-list.svg", alt: "A linked list",width: "8cm"}}}

{{index "structure sharing", [memory, structure sharing]}}

A nice thing about lists is that they can share parts of their
structure. For example, if I create two new values `{value: 0, rest:
list}` and `{value: -1, rest: list}` (with `list` referring to the
binding defined earlier), they are both independent lists, but they
share the structure that makes up their last three elements. The
original list is also still a valid three-element list.

Write a function `arrayToList` that builds up a list structure like
the one shown when given `[1, 2, 3]` as argument. Also write a
`listToArray` function that produces an array from a list. Then add a
helper function `prepend`, which takes an element and a list and
creates a new list that adds the element to the front of the input
list, and `nth`, which takes a list and a number and returns the
element at the given position in the list (with zero referring to the
first element) or `undefined` when there is no such element.

{{index recursion}}

If you haven't already, also write a recursive version of `nth`.

{{if interactive

```{test: no}
// Your code here.

console.log(arrayToList([10, 20]));
// → {value: 10, rest: {value: 20, rest: null}}
console.log(listToArray(arrayToList([10, 20, 30])));
// → [10, 20, 30]
console.log(prepend(10, prepend(20, null)));
// → {value: 10, rest: {value: 20, rest: null}}
console.log(nth(arrayToList([10, 20, 30]), 1));
// → 20
```

if}}

{{hint

{{index "list (exercise)", "linked list"}}

Building up a list is easier when done back to front. So `arrayToList`
could iterate over the array backwards (see the previous exercise) and, for
each element, add an object to the list. You can use a local binding
to hold the part of the list that was built so far and use an
assignment like `list = {value: X, rest: list}` to add an element.

{{index "for loop"}}

To run over a list (in `listToArray` and `nth`), a `for` loop
specification like this can be used:

```
for (let node = list; node; node = node.rest) {}
```

Can you see how that works? Every iteration of the loop, `node` points
to the current sublist, and the body can read its `value` property to
get the current element. At the end of an iteration, `node` moves to
the next sublist. When that is null, we have reached the end of the
list, and the loop is finished.

{{index recursion}}

The recursive version of `nth` will, similarly, look at an ever
smaller part of the "tail" of the list and at the same time count down
the index until it reaches zero, at which point it can return the
`value` property of the node it is looking at. To get the zeroth
element of a list, you simply take the `value` property of its head
node. To get element _N_ + 1, you take the *N*th element of the list
that's in this list's `rest` property.

hint}}

{{id exercise_deep_compare}}

### Deep comparison

{{index "deep comparison (exercise)", [comparison, deep], "deep comparison", "== operator"}}

The `==` operator compares objects by identity. But sometimes you'd
prefer to compare the values of their actual properties.

Write a function `deepEqual` that takes two values and returns true
only if they are the same value or are objects with the same
properties, where the values of the properties are equal when compared
with a recursive call to `deepEqual`.

{{index null, "=== operator", "typeof operator"}}

To find out whether values should be compared directly (use the `===`
operator for that) or have their properties compared, you can use the
`typeof` operator. If it produces `"object"` for both values, you
should do a deep comparison. But you have to take one silly exception
into account: because of a historical accident, `typeof null` also
produces `"object"`.

{{index "Object.keys function"}}

The `Object.keys` function will be useful when you need to go over the
properties of objects to compare them.

{{if interactive

```{test: no}
// Your code here.

let obj = {here: {is: "an"}, object: 2};
console.log(deepEqual(obj, obj));
// → true
console.log(deepEqual(obj, {here: 1, object: 2}));
// → false
console.log(deepEqual(obj, {here: {is: "an"}, object: 2}));
// → true
```

if}}

{{hint

{{index "deep comparison (exercise)", [comparison, deep], "typeof operator", "=== operator"}}

Your test for whether you are dealing with a real object will look
something like `typeof x == "object" && x != null`. Be careful to
compare properties only when _both_ arguments are objects. In all
other cases you can just immediately return the result of applying
`===`.

{{index "Object.keys function"}}

Use `Object.keys` to go over the properties. You need to test whether
both objects have the same set of property names and whether those
properties have identical values. One way to do that is to ensure that
both objects have the same number of properties (the lengths of the
property lists are the same). And then, when looping over one of the
object's properties to compare them, always first make sure
the other actually has a property by that name. If they have the same
number of properties and all properties in one also exist in the
other, they have the same set of property names.

{{index "return value"}}

Returning the correct value from the function is best done by
immediately returning false when a mismatch is found and returning
true at the end of the function.

hint}}
{{meta {load_files: ["code/scripts.js", "code/chapter/05_higher_order.js", "code/intro.js"], zip: "node/html"}}}

# Higher-Order Functions

{{if interactive

{{quote {author: "Master Yuan-Ma", title: "The Book of Programming", chapter: true}

Tzu-li and Tzu-ssu were boasting about the size of their latest
programs. 'Two-hundred thousand lines,' said Tzu-li, 'not counting
comments!' Tzu-ssu responded, 'Pssh, mine is almost a *million* lines
already.' Master Yuan-Ma said, 'My best program has five hundred
lines.' Hearing this, Tzu-li and Tzu-ssu were enlightened.

quote}}

if}}

{{quote {author: "C.A.R. Hoare", title: "1980 ACM Turing Award Lecture", chapter: true}

{{index "Hoare, C.A.R."}}

There are two ways of constructing a software design: One way is to
make it so simple that there are obviously no deficiencies, and the
other way is to make it so complicated that there are no obvious
deficiencies.

quote}}

{{figure {url: "img/chapter_picture_5.jpg", alt: "Letters from different scripts", chapter: true}}}

{{index "program size"}}

A large program is a costly program, and not just because of the time
it takes to build. Size almost always involves ((complexity)), and
complexity confuses programmers. Confused programmers, in turn,
introduce mistakes (_((bug))s_) into programs. A large program then
provides a lot of space for these bugs to hide, making them hard to
find.

{{index "summing example"}}

Let's briefly go back to the final two example programs in the
introduction. The first is self-contained and six lines long.

```
let total = 0, count = 1;
while (count <= 10) {
  total += count;
  count += 1;
}
console.log(total);
```

The second relies on two external functions and is one line long.

```
console.log(sum(range(1, 10)));
```

Which one is more likely to contain a bug?

{{index "program size"}}

If we count the size of the definitions of `sum` and `range`, the
second program is also big—even bigger than the first. But still, I'd
argue that it is more likely to be correct.

{{index [abstraction, "with higher-order functions"], "domain-specific language"}}

It is more likely to be correct because the solution is expressed in a
((vocabulary)) that corresponds to the problem being solved. Summing a
range of numbers isn't about loops and counters. It is about ranges
and sums.

The definitions of this vocabulary (the functions `sum` and `range`)
will still involve loops, counters, and other incidental details. But
because they are expressing simpler concepts than the program as a
whole, they are easier to get right.

## Abstraction

In the context of programming, these kinds of vocabularies are usually
called _((abstraction))s_. Abstractions hide details and give us the
ability to talk about problems at a higher (or more abstract) level.

{{index "recipe analogy", "pea soup"}}

As an analogy, compare these two recipes for pea soup. The first one
goes like this:

{{quote

Put 1 cup of dried peas per person into a container. Add water until
the peas are well covered. Leave the peas in water for at least 12
hours. Take the peas out of the water and put them in a cooking pan.
Add 4 cups of water per person. Cover the pan and keep the peas
simmering for two hours. Take half an onion per person. Cut it into
pieces with a knife. Add it to the peas. Take a stalk of celery per
person. Cut it into pieces with a knife. Add it to the peas. Take a
carrot per person. Cut it into pieces. With a knife! Add it to the
peas. Cook for 10 more minutes.

quote}}

And this is the second recipe:

{{quote

Per person: 1 cup dried split peas, half a chopped onion, a stalk of
celery, and a carrot.

Soak peas for 12 hours. Simmer for 2 hours in 4 cups of water
(per person). Chop and add vegetables. Cook for 10 more minutes.

quote}}

{{index vocabulary}}

The second is shorter and easier to interpret. But you do need to
understand a few more cooking-related words such as _soak_, _simmer_, _chop_,
and, I guess, _vegetable_.

When programming, we can't rely on all the words we need to be waiting
for us in the dictionary. Thus, we might fall into the pattern of the
first recipe—work out the precise steps the computer has to perform,
one by one, blind to the higher-level concepts that they express.

{{index abstraction}}

It is a useful skill, in programming, to notice when you are working
at too low a level of abstraction.

## Abstracting repetition

{{index [array, iteration]}}

Plain functions, as we've seen them so far, are a good way to build
abstractions. But sometimes they fall short.

{{index "for loop"}}

It is common for a program to do something a given number of times.
You can write a `for` ((loop)) for that, like this:

```
for (let i = 0; i < 10; i++) {
  console.log(i);
}
```

Can we abstract "doing something _N_ times" as a function? Well, it's
easy to write a function that calls `console.log` _N_ times.

```
function repeatLog(n) {
  for (let i = 0; i < n; i++) {
    console.log(i);
  }
}
```

{{index [function, "higher-order"], loop, [function, "as value"]}}

{{indexsee "higher-order function", "function, higher-order"}}

But what if we want to do something other than logging the numbers?
Since "doing something" can be represented as a function and functions
are just values, we can pass our action as a function value.

```{includeCode: "top_lines: 5"}
function repeat(n, action) {
  for (let i = 0; i < n; i++) {
    action(i);
  }
}

repeat(3, console.log);
// → 0
// → 1
// → 2
```

We don't have to pass a predefined function to `repeat`. Often, it
is easier to create a function value on the spot instead.

```
let labels = [];
repeat(5, i => {
  labels.push(`Unit ${i + 1}`);
});
console.log(labels);
// → ["Unit 1", "Unit 2", "Unit 3", "Unit 4", "Unit 5"]
```

{{index "loop body", [braces, body], [parentheses, arguments]}}

This is structured a little like a `for` loop—it first describes the
kind of loop and then provides a body. However, the body is now written
as a function value, which is wrapped in the parentheses of the
call to `repeat`. This is why it has to be closed with the closing
brace _and_ closing parenthesis. In cases like this example, where the
body is a single small expression, you could also omit the
braces and write the loop on a single line.

## Higher-order functions

{{index [function, "higher-order"], [function, "as value"]}}

Functions that operate on other functions, either by taking them as
arguments or by returning them, are called _higher-order functions_.
Since we have already seen that functions are regular values, there is
nothing particularly remarkable about the fact that such functions
exist. The term comes from ((mathematics)), where the distinction
between functions and other values is taken more seriously.

{{index abstraction}}

Higher-order functions allow us to abstract over _actions_, not just
values. They come in several forms. For example, we can have
functions that create new functions.

```
function greaterThan(n) {
  return m => m > n;
}
let greaterThan10 = greaterThan(10);
console.log(greaterThan10(11));
// → true
```

And we can have functions that change other functions.

```
function noisy(f) {
  return (...args) => {
    console.log("calling with", args);
    let result = f(...args);
    console.log("called with", args, ", returned", result);
    return result;
  };
}
noisy(Math.min)(3, 2, 1);
// → calling with [3, 2, 1]
// → called with [3, 2, 1] , returned 1
```

We can even write functions that provide new types of ((control
flow)).

```
function unless(test, then) {
  if (!test) then();
}

repeat(3, n => {
  unless(n % 2 == 1, () => {
    console.log(n, "is even");
  });
});
// → 0 is even
// → 2 is even
```

{{index [array, methods], [array, iteration], "forEach method"}}

There is a built-in array method, `forEach`, that provides something
like a `for`/`of` loop as a higher-order function.

```
["A", "B"].forEach(l => console.log(l));
// → A
// → B
```

## Script data set

One area where higher-order functions shine is data processing. To process data, we'll need some actual data. This chapter will
use a ((data set)) about scripts—((writing system))s such as Latin,
Cyrillic, or Arabic.

Remember ((Unicode)) from [Chapter ?](values#unicode), the system that
assigns a number to each character in written language? Most of these
characters are associated with a specific script. The standard
contains 140 different scripts—81 are still in use today, and 59
are historic.

Though I can fluently read only Latin characters, I appreciate the
fact that people are writing texts in at least 80 other writing
systems, many of which I wouldn't even recognize. For example, here's
a sample of ((Tamil)) handwriting:

{{figure {url: "img/tamil.png", alt: "Tamil handwriting"}}}

{{index "SCRIPTS data set"}}

The example ((data set)) contains some pieces of information about the
140 scripts defined in Unicode. It is available in the [coding
sandbox](https://eloquentjavascript.net/code#5) for this chapter[
([_https://eloquentjavascript.net/code#5_](https://eloquentjavascript.net/code#5))]{if
book} as the `SCRIPTS` binding. The binding contains an array of
objects, each of which describes a script.


```{lang: "application/json"}
{
  name: "Coptic",
  ranges: [[994, 1008], [11392, 11508], [11513, 11520]],
  direction: "ltr",
  year: -200,
  living: false,
  link: "https://en.wikipedia.org/wiki/Coptic_alphabet"
}
```

Such an object tells us the name of the script, the Unicode ranges
assigned to it, the direction in which it is written, the
(approximate) origin time, whether it is still in use, and a link to
more information. The direction may be `"ltr"` for left to right, `"rtl"`
for right to left (the way Arabic and Hebrew text are written), or
`"ttb"` for top to bottom (as with Mongolian writing).

{{index "slice method"}}

The `ranges` property contains an array of Unicode character
((range))s, each of which is a two-element array containing a lower bound
and an upper bound. Any character codes within these ranges are assigned
to the script. The lower ((bound)) is inclusive (code 994 is a Coptic
character), and the upper bound is non-inclusive (code 1008 isn't).

## Filtering arrays

{{index [array, methods], [array, filtering], "filter method", [function, "higher-order"], "predicate function"}}

To find the scripts in the data set that are still in use, the
following function might be helpful. It filters out the elements in an
array that don't pass a test.

```
function filter(array, test) {
  let passed = [];
  for (let element of array) {
    if (test(element)) {
      passed.push(element);
    }
  }
  return passed;
}

console.log(filter(SCRIPTS, script => script.living));
// → [{name: "Adlam", …}, …]
```

{{index [function, "as value"], [function, application]}}

The function uses the argument named `test`, a function value, to fill
a "gap" in the computation—the process of deciding which elements to
collect.

{{index "filter method", "pure function", "side effect"}}

Note how the `filter` function, rather than deleting elements from the
existing array, builds up a new array with only the elements that pass
the test. This function is _pure_. It does not modify the array it is
given.

Like `forEach`, `filter` is a ((standard)) array method. The example
defined the function only to show what it does internally.
From now on, we'll use it like this instead:

```
console.log(SCRIPTS.filter(s => s.direction == "ttb"));
// → [{name: "Mongolian", …}, …]
```

{{id map}}

## Transforming with map

{{index [array, methods], "map method"}}

Say we have an array of objects representing scripts, produced by
filtering the `SCRIPTS` array somehow. But we want an array of names,
which is easier to inspect.

{{index [function, "higher-order"]}}

The `map` method transforms an array by applying a function to all of
its elements and building a new array from the returned values. The
new array will have the same length as the input array, but its
content will have been _mapped_ to a new form by the function.

```
function map(array, transform) {
  let mapped = [];
  for (let element of array) {
    mapped.push(transform(element));
  }
  return mapped;
}

let rtlScripts = SCRIPTS.filter(s => s.direction == "rtl");
console.log(map(rtlScripts, s => s.name));
// → ["Adlam", "Arabic", "Imperial Aramaic", …]
```

Like `forEach` and `filter`, `map` is a standard array method.

## Summarizing with reduce

{{index [array, methods], "summing example", "reduce method"}}

Another common thing to do with arrays is to compute a single value
from them. Our recurring example, summing a collection of numbers, is
an instance of this. Another example is finding the script with
the most characters.

{{indexsee "fold", "reduce method"}}

{{index [function, "higher-order"], "reduce method"}}

The higher-order operation that represents this pattern is called
_reduce_ (sometimes also called _fold_). It builds a value by
repeatedly taking a single element from the array and combining it
with the current value. When summing numbers, you'd start with the
number zero and, for each element, add that to the sum.

The parameters to `reduce` are, apart from the array, a combining
function and a start value. This function is a little less
straightforward than `filter` and `map`, so take a close look at
it:

```
function reduce(array, combine, start) {
  let current = start;
  for (let element of array) {
    current = combine(current, element);
  }
  return current;
}

console.log(reduce([1, 2, 3, 4], (a, b) => a + b, 0));
// → 10
```

{{index "reduce method", "SCRIPTS data set"}}

The standard array method `reduce`, which of course corresponds to
this function, has an added convenience. If your array contains at
least one element, you are allowed to leave off the `start` argument.
The method will take the first element of the array as its start value
and start reducing at the second element.

```
console.log([1, 2, 3, 4].reduce((a, b) => a + b));
// → 10
```

{{index maximum, "characterCount function"}}

To use `reduce` (twice) to find the script with the most characters,
we can write something like this:

```
function characterCount(script) {
  return script.ranges.reduce((count, [from, to]) => {
    return count + (to - from);
  }, 0);
}

console.log(SCRIPTS.reduce((a, b) => {
  return characterCount(a) < characterCount(b) ? b : a;
}));
// → {name: "Han", …}
```

The `characterCount` function reduces the ranges assigned to a script
by summing their sizes. Note the use of destructuring in the parameter
list of the reducer function. The second call to `reduce` then uses
this to find the largest script by repeatedly comparing two scripts
and returning the larger one.

The Han script has more than 89,000 characters assigned to it in the
Unicode standard, making it by far the biggest writing system in the
data set. Han is a script (sometimes) used for Chinese, Japanese, and
Korean text. Those languages share a lot of characters, though they
tend to write them differently. The (U.S.-based) Unicode Consortium
decided to treat them as a single writing system to save
character codes. This is called _Han unification_ and still makes some
people very angry.

## Composability

{{index loop, maximum}}

Consider how we would have written the previous example (finding the
biggest script) without higher-order functions. The code is not that
much worse.

```{test: no}
let biggest = null;
for (let script of SCRIPTS) {
  if (biggest == null ||
      characterCount(biggest) < characterCount(script)) {
    biggest = script;
  }
}
console.log(biggest);
// → {name: "Han", …}
```

There are a few more bindings, and the program is four lines
longer. But it is still very readable.

{{index "average function", composability, [function, "higher-order"], "filter method", "map method", "reduce method"}}

{{id average_function}}

Higher-order functions start to shine when you need to _compose_
operations. As an example, let's write code that finds the average
year of origin for living and dead scripts in the data set.

```
function average(array) {
  return array.reduce((a, b) => a + b) / array.length;
}

console.log(Math.round(average(
  SCRIPTS.filter(s => s.living).map(s => s.year))));
// → 1165
console.log(Math.round(average(
  SCRIPTS.filter(s => !s.living).map(s => s.year))));
// → 204
```

So the dead scripts in Unicode are, on average, older than the living
ones. This is not a terribly meaningful or surprising statistic. But I
hope you'll agree that the code used to compute it isn't hard to read.
You can see it as a pipeline: we start with all scripts, filter out
the living (or dead) ones, take the years from those, average them,
and round the result.

You could definitely also write this computation as one big ((loop)).

```
let total = 0, count = 0;
for (let script of SCRIPTS) {
  if (script.living) {
    total += script.year;
    count += 1;
  }
}
console.log(Math.round(total / count));
// → 1165
```

But it is harder to see what was being computed and how. And because
intermediate results aren't represented as coherent values, it'd be a
lot more work to extract something like `average` into a separate
function.

{{index efficiency, [array, creation]}}

In terms of what the computer is actually doing, these two approaches
are also quite different. The first will build up new arrays when
running `filter` and `map`, whereas the second computes only some
numbers, doing less work. You can usually afford the readable
approach, but if you're processing huge arrays, and doing so many
times, the less abstract style might be worth the extra speed.

## Strings and character codes

{{index "SCRIPTS data set"}}

One use of the data set would be figuring out what script a piece of
text is using. Let's go through a program that does this.

Remember that each script has an array of character code ranges
associated with it. So given a character code, we could use a function
like this to find the corresponding script (if any):

{{index "some method", "predicate function", [array, methods]}}

```{includeCode: strip_log}
function characterScript(code) {
  for (let script of SCRIPTS) {
    if (script.ranges.some(([from, to]) => {
      return code >= from && code < to;
    })) {
      return script;
    }
  }
  return null;
}

console.log(characterScript(121));
// → {name: "Latin", …}
```

The `some` method is another higher-order function. It takes a test
function and tells you whether that function returns true for any of the
elements in the array.

{{id code_units}}

But how do we get the character codes in a string?

In [Chapter ?](values) I mentioned that JavaScript ((string))s are
encoded as a sequence of 16-bit numbers. These are called _((code
unit))s_. A ((Unicode)) ((character)) code was initially supposed to
fit within such a unit (which gives you a little over 65,000
characters). When it became clear that wasn't going to be enough, many
people balked at the need to use more memory per character. To address
these concerns, ((UTF-16)), the format used by JavaScript strings, was
invented. It describes most common characters using a single 16-bit
code unit but uses a pair of two such units for others.

{{index error}}

UTF-16 is generally considered a bad idea today. It seems almost
intentionally designed to invite mistakes. It's easy to write programs
that pretend code units and characters are the same thing. And if your
language doesn't use two-unit characters, that will appear to work
just fine. But as soon as someone tries to use such a program with
some less common ((Chinese characters)), it breaks. Fortunately, with
the advent of ((emoji)), everybody has started using two-unit
characters, and the burden of dealing with such problems is more
fairly distributed.

{{index [string, length], [string, indexing], "charCodeAt method"}}

Unfortunately, obvious operations on JavaScript strings, such as
getting their length through the `length` property and accessing their
content using square brackets, deal only with code units.

```{test: no}
// Two emoji characters, horse and shoe
let horseShoe = "🐴👟";
console.log(horseShoe.length);
// → 4
console.log(horseShoe[0]);
// → (Invalid half-character)
console.log(horseShoe.charCodeAt(0));
// → 55357 (Code of the half-character)
console.log(horseShoe.codePointAt(0));
// → 128052 (Actual code for horse emoji)
```

{{index "codePointAt method"}}

JavaScript's `charCodeAt` method gives you a code unit, not a full
character code. The `codePointAt` method, added later, does give a
full Unicode character. So we could use that to get characters from a
string. But the argument passed to `codePointAt` is still an index
into the sequence of code units. So to run over all characters in a
string, we'd still need to deal with the question of whether a
character takes up one or two code units.

{{index "for/of loop", character}}

In the [previous chapter](data#for_of_loop), I mentioned that a
`for`/`of` loop can also be used on strings. Like `codePointAt`, this
type of loop was introduced at a time where people were acutely aware
of the problems with UTF-16. When you use it to loop over a string, it
gives you real characters, not code units.

```
let roseDragon = "🌹🐉";
for (let char of roseDragon) {
  console.log(char);
}
// → 🌹
// → 🐉
```

If you have a character (which will be a string of one or two code
units), you can use `codePointAt(0)` to get its code.

## Recognizing text

{{index "SCRIPTS data set", "countBy function", [array, counting]}}

We have a `characterScript` function and a way to correctly loop over
characters. The next step is to count the characters that belong
to each script. The following counting abstraction will be useful
there:

```{includeCode: strip_log}
function countBy(items, groupName) {
  let counts = [];
  for (let item of items) {
    let name = groupName(item);
    let known = counts.findIndex(c => c.name == name);
    if (known == -1) {
      counts.push({name, count: 1});
    } else {
      counts[known].count++;
    }
  }
  return counts;
}

console.log(countBy([1, 2, 3, 4, 5], n => n > 2));
// → [{name: false, count: 2}, {name: true, count: 3}]
```

The `countBy` function expects a collection (anything that we can loop
over with `for`/`of`) and a function that computes a group name for a
given element. It returns an array of
objects, each of which names a group and tells you the number of
elements that were found in that group.

{{index "findIndex method", "indexOf method"}}

It uses another array method—`findIndex`. This method is somewhat like
`indexOf`, but instead of looking for a specific value, it finds the
first value for which the given function returns true. Like `indexOf`,
it returns -1 when no such element is found.

{{index "textScripts function", "Chinese characters"}}

Using `countBy`, we can write the function that tells us which scripts
are used in a piece of text.

```{includeCode: strip_log, startCode: true}
function textScripts(text) {
  let scripts = countBy(text, char => {
    let script = characterScript(char.codePointAt(0));
    return script ? script.name : "none";
  }).filter(({name}) => name != "none");

  let total = scripts.reduce((n, {count}) => n + count, 0);
  if (total == 0) return "No scripts found";

  return scripts.map(({name, count}) => {
    return `${Math.round(count * 100 / total)}% ${name}`;
  }).join(", ");
}

console.log(textScripts('英国的狗说"woof", 俄罗斯的狗说"тяв"'));
// → 61% Han, 22% Latin, 17% Cyrillic
```

{{index "characterScript function", "filter method"}}

The function first counts the characters by name, using
`characterScript` to assign them a name and falling back to the
string `"none"` for characters that aren't part of any script. The
`filter` call drops the entry for `"none"` from the resulting array
since we aren't interested in those characters.

{{index "reduce method", "map method", "join method", [array, methods]}}

To be able to compute ((percentage))s, we first need the total number
of characters that belong to a script, which we can compute with
`reduce`. If no such characters are found, the function returns a
specific string. Otherwise, it transforms the counting entries into
readable strings with `map` and then combines them with `join`.

## Summary

Being able to pass function values to other functions is a deeply
useful aspect of JavaScript. It allows us to write functions that
model computations with "gaps" in them. The code that calls these
functions can fill in the gaps by providing function values.

Arrays provide a number of useful higher-order methods. You can use
`forEach` to loop over the elements in an array. The `filter` method
returns a new array containing only the elements that pass the
((predicate function)). Transforming an array by putting each element
through a function is done with `map`. You can use `reduce` to combine
all the elements in an array into a single value. The `some` method
tests whether any element matches a given predicate function. And
`findIndex` finds the position of the first element that matches a
predicate.

## Exercises

### Flattening

{{index "flattening (exercise)", "reduce method", "concat method", [array, flattening]}}

Use the `reduce` method in combination with the `concat` method to
"flatten" an array of arrays into a single array that has all the
elements of the original arrays.

{{if interactive

```{test: no}
let arrays = [[1, 2, 3], [4, 5], [6]];
// Your code here.
// → [1, 2, 3, 4, 5, 6]
```
if}}

### Your own loop

{{index "your own loop (example)", "for loop"}}

Write a higher-order function `loop` that provides something like a
`for` loop statement. It takes a value, a test function, an update
function, and a body function. Each iteration, it first runs the test
function on the current loop value and stops if that returns false.
Then it calls the body function, giving it the current value. 
Finally, it calls the update function to create a new value and
starts from the beginning.

When defining the function, you can use a regular loop to do the
actual looping.

{{if interactive

```{test: no}
// Your code here.

loop(3, n => n > 0, n => n - 1, console.log);
// → 3
// → 2
// → 1
```

if}}

### Everything

{{index "predicate function", "everything (exercise)", "every method", "some method", [array, methods], "&& operator", "|| operator"}}

Analogous to the `some` method, arrays also have an `every` method.
This one returns true when the given function returns true for _every_
element in the array. In a way, `some` is a version of the `||`
operator that acts on arrays, and `every` is like the `&&` operator.

Implement `every` as a function that takes an array and a predicate
function as parameters. Write two versions, one using a loop and one
using the `some` method.

{{if interactive

```{test: no}
function every(array, test) {
  // Your code here.
}

console.log(every([1, 3, 5], n => n < 10));
// → true
console.log(every([2, 4, 16], n => n < 10));
// → false
console.log(every([], n => n < 10));
// → true
```

if}}

{{hint

{{index "everything (exercise)", "short-circuit evaluation", "return keyword"}}

Like the `&&` operator, the `every` method can stop evaluating further
elements as soon as it has found one that doesn't match. So the
loop-based version can jump out of the loop—with `break` or
`return`—as soon as it runs into an element for which the predicate
function returns false. If the loop runs to its end without finding
such an element, we know that all elements matched and we should
return true.

To build `every` on top of `some`, we can apply _((De Morgan's
laws))_, which state that `a && b` equals `!(!a || !b)`. This can be
generalized to arrays, where all elements in the array match if there
is no element in the array that does not match.

hint}}

### Dominant writing direction

{{index "SCRIPTS data set", "direction (writing)", "groupBy function", "dominant direction (exercise)"}}

Write a function that computes the dominant writing direction in a
string of text. Remember that each script object has a `direction`
property that can be `"ltr"` (left to right), `"rtl"` (right to left),
or `"ttb"` (top to bottom).

{{index "characterScript function", "countBy function"}}

The dominant direction is the direction of a majority of the
characters that have a script associated with them. The
`characterScript` and `countBy` functions defined earlier in the
chapter are probably useful here.

{{if interactive

```{test: no}
function dominantDirection(text) {
  // Your code here.
}

console.log(dominantDirection("Hello!"));
// → ltr
console.log(dominantDirection("Hey, مساء الخير"));
// → rtl
```
if}}

{{hint

{{index "dominant direction (exercise)", "textScripts function", "filter method", "characterScript function"}}

Your solution might look a lot like the first half of the
`textScripts` example. You again have to count characters by a
criterion based on `characterScript` and then filter out the part of
the result that refers to uninteresting (script-less) characters.

{{index "reduce method"}}

Finding the direction with the highest character count can be done
with `reduce`. If it's not clear how, refer to the example
earlier in the chapter, where `reduce` was used to find the script
with the most characters.

hint}}
{{meta {load_files: ["code/chapter/06_object.js"], zip: "node/html"}}}

# The Secret Life of Objects

{{quote {author: "Barbara Liskov", title: "Programming with Abstract Data Types", chapter: true}

An abstract data type is realized by writing a special kind of program
[…] which defines the type in terms of the operations which can be
performed on it.

quote}}

{{index "Liskov, Barbara", "abstract data type"}}

{{figure {url: "img/chapter_picture_6.jpg", alt: "Picture of a rabbit with its proto-rabbit", chapter: framed}}}

[Chapter ?](data) introduced JavaScript's objects. In programming
culture, we have a thing called _((object-oriented programming))_, a
set of techniques that use objects (and related concepts) as the
central principle of program organization.

Though no one really agrees on its precise definition, object-oriented
programming has shaped the design of many programming languages,
including JavaScript. This chapter will describe the way these ideas
can be applied in JavaScript.

## Encapsulation

{{index encapsulation, isolation, modularity}}

The core idea in object-oriented programming is to divide programs
into smaller pieces and make each piece responsible for managing its
own state.

This way, some knowledge about the way a piece of the program works
can be kept _local_ to that piece. Someone working on the rest of the
program does not have to remember or even be aware of that knowledge.
Whenever these local details change, only the code directly around it
needs to be updated.

{{id interface}}
{{index [interface, object]}}

Different pieces of such a program interact with each other through
_interfaces_, limited sets of functions or bindings that provide
useful functionality at a more abstract level, hiding their precise
implementation.

{{index "public properties", "private properties", "access control", [method, interface]}}

Such program pieces are modeled using ((object))s. Their interface
consists of a specific set of methods and properties. Properties
that are part of the interface are called _public_. The others, which
outside code should not be touching, are called _private_.

{{index "underscore character"}}

Many languages provide a way to distinguish public and private
properties and prevent outside code from accessing the private
ones altogether. JavaScript, once again taking the minimalist
approach, does not—not yet at least. There is work underway to add
this to the language.

Even though the language doesn't have this distinction built in,
JavaScript programmers _are_ successfully using this idea. Typically,
the available interface is described in documentation or comments. It
is also common to put an underscore (`_`) character at the start of
property names to indicate that those properties are private.

Separating interface from implementation is a great idea. It is
usually called _((encapsulation))_.

{{id obj_methods}}

## Methods

{{index "rabbit example", method, [property, access]}}

Methods are nothing more than properties that hold function values.
This is a simple method:

```
let rabbit = {};
rabbit.speak = function(line) {
  console.log(`The rabbit says '${line}'`);
};

rabbit.speak("I'm alive.");
// → The rabbit says 'I'm alive.'
```

{{index "this binding", "method call"}}

Usually a method needs to do something with the object it was called
on. When a function is called as a method—looked up as a property and
immediately called, as in `object.method()`—the binding called `this`
in its body automatically points at the object that it was called on.

```{includeCode: "top_lines:6", test: join}
function speak(line) {
  console.log(`The ${this.type} rabbit says '${line}'`);
}
let whiteRabbit = {type: "white", speak};
let hungryRabbit = {type: "hungry", speak};

whiteRabbit.speak("Oh my ears and whiskers, " +
                  "how late it's getting!");
// → The white rabbit says 'Oh my ears and whiskers, how
//   late it's getting!'
hungryRabbit.speak("I could use a carrot right now.");
// → The hungry rabbit says 'I could use a carrot right now.'
```

{{id call_method}}

{{index "call method"}}

You can think of `this` as an extra ((parameter)) that is passed in a
different way. If you want to pass it explicitly, you can use a
function's `call` method, which takes the `this` value as its first
argument and treats further arguments as normal parameters.

```
speak.call(hungryRabbit, "Burp!");
// → The hungry rabbit says 'Burp!'
```

Since each function has its own `this` binding, whose value depends on
the way it is called, you cannot refer to the `this` of the wrapping
scope in a regular function defined with the `function` keyword.

{{index "this binding", "arrow function"}}

Arrow functions are different—they do not bind their own `this` but
can see the `this` binding of the scope around them. Thus, you can do
something like the following code, which references `this` from inside
a local function:

```
function normalize() {
  console.log(this.coords.map(n => n / this.length));
}
normalize.call({coords: [0, 2, 3], length: 5});
// → [0, 0.4, 0.6]
```

{{index "map method"}}

If I had written the argument to `map` using the `function` keyword,
the code wouldn't work.

{{id prototypes}}

## Prototypes

{{index "toString method"}}

Watch closely.

```
let empty = {};
console.log(empty.toString);
// → function toString(){…}
console.log(empty.toString());
// → [object Object]
```

{{index magic}}

I pulled a property out of an empty object. Magic!

{{index [property, inheritance], [object, property]}}

Well, not really. I have simply been withholding information about the
way JavaScript objects work. In addition to their set of properties,
most objects also have a _((prototype))_. A prototype is another
object that is used as a fallback source of properties. When an object
gets a request for a property that it does not have, its prototype
will be searched for the property, then the prototype's prototype, and
so on.

{{index "Object prototype"}}

So who is the ((prototype)) of that empty object? It is the great
ancestral prototype, the entity behind almost all objects,
`Object.prototype`.

```
console.log(Object.getPrototypeOf({}) ==
            Object.prototype);
// → true
console.log(Object.getPrototypeOf(Object.prototype));
// → null
```

{{index "getPrototypeOf function"}}

As you guess, `Object.getPrototypeOf` returns the prototype of an
object.

{{index "toString method"}}

The prototype relations of JavaScript objects form a ((tree))-shaped
structure, and at the root of this structure sits `Object.prototype`.
It provides a few methods that show up in all objects, such as
`toString`, which converts an object to a string representation.

{{index inheritance, "Function prototype", "Array prototype", "Object prototype"}}

Many objects don't directly have `Object.prototype` as their
((prototype)) but instead have another object that provides a different set of
default properties. Functions derive from `Function.prototype`, and
arrays derive from `Array.prototype`.

```
console.log(Object.getPrototypeOf(Math.max) ==
            Function.prototype);
// → true
console.log(Object.getPrototypeOf([]) ==
            Array.prototype);
// → true
```

{{index "Object prototype"}}

Such a prototype object will itself have a prototype, often
`Object.prototype`, so that it still indirectly provides methods like
`toString`.

{{index "rabbit example", "Object.create function"}}

You can use `Object.create` to create an object with a specific
((prototype)).

```
let protoRabbit = {
  speak(line) {
    console.log(`The ${this.type} rabbit says '${line}'`);
  }
};
let killerRabbit = Object.create(protoRabbit);
killerRabbit.type = "killer";
killerRabbit.speak("SKREEEE!");
// → The killer rabbit says 'SKREEEE!'
```

{{index "shared property"}}

A property like `speak(line)` in an object expression is a shorthand way
of defining a method. It creates a property called `speak` and gives
it a function as its value.

The "proto" rabbit acts as a container for the properties that are
shared by all rabbits. An individual rabbit object, like the killer
rabbit, contains properties that apply only to itself—in this case its
type—and derives shared properties from its prototype.

{{id classes}}

## Classes

{{index "object-oriented programming"}}

JavaScript's ((prototype)) system can be interpreted as a somewhat
informal take on an object-oriented concept called _((class))es_. A
class defines the shape of a type of object—what methods and
properties it has. Such an object is called an _((instance))_ of the
class.

{{index [property, inheritance]}}

Prototypes are useful for defining properties for which all instances
of a class share the same value, such as ((method))s. Properties that
differ per instance, such as our rabbits' `type` property, need to
be stored directly in the objects themselves.

{{id constructors}}

So to create an instance of a given class, you have to make
an object that derives from the proper prototype, but you _also_ have
to make sure it, itself, has the properties that instances of this
class are supposed to have. This is what a _((constructor))_ function
does.

```
function makeRabbit(type) {
  let rabbit = Object.create(protoRabbit);
  rabbit.type = type;
  return rabbit;
}
```

{{index "new operator", "this binding", "return keyword", [object, creation]}}

JavaScript provides a way to make defining this type of function
easier. If you put the keyword `new` in front of a function call, the
function is treated as a constructor. This means that an object with
the right prototype is automatically created, bound to `this` in the
function, and returned at the end of the function.

{{index "prototype property"}}

The prototype object used when constructing objects is found by taking
the `prototype` property of the constructor function.

{{index "rabbit example"}}

```
function Rabbit(type) {
  this.type = type;
}
Rabbit.prototype.speak = function(line) {
  console.log(`The ${this.type} rabbit says '${line}'`);
};

let weirdRabbit = new Rabbit("weird");
```

{{index constructor}}

Constructors (all functions, in fact) automatically get a property
named `prototype`, which by default holds a plain, empty object that
derives from `Object.prototype`. You can overwrite it with a new
object if you want. Or you can add properties to the existing object,
as the example does.

{{index capitalization}}

By convention, the names of constructors are capitalized so that they
can easily be distinguished from other functions.

{{index "prototype property", "getPrototypeOf function"}}

It is important to understand the distinction between the way a
prototype is associated with a constructor (through its `prototype`
property) and the way objects _have_ a prototype (which can be found
with `Object.getPrototypeOf`). The actual prototype of a constructor
is `Function.prototype` since constructors are functions. Its
`prototype` _property_ holds the prototype used for instances created
through it.

```
console.log(Object.getPrototypeOf(Rabbit) ==
            Function.prototype);
// → true
console.log(Object.getPrototypeOf(weirdRabbit) ==
            Rabbit.prototype);
// → true
```

## Class notation

So JavaScript ((class))es are ((constructor)) functions with a
((prototype)) property. That is how they work, and until 2015, that
was how you had to write them. These days, we have a less awkward
notation.

```{includeCode: true}
class Rabbit {
  constructor(type) {
    this.type = type;
  }
  speak(line) {
    console.log(`The ${this.type} rabbit says '${line}'`);
  }
}

let killerRabbit = new Rabbit("killer");
let blackRabbit = new Rabbit("black");
```

{{index "rabbit example", [braces, class]}}

The `class` keyword starts a ((class declaration)), which allows us to
define a constructor and a set of methods all in a single place. Any
number of methods may be written inside the declaration's braces.
The one named `constructor` is treated specially. It
provides the actual constructor function, which will be bound to the
name `Rabbit`. The others are packaged into that constructor's
prototype. Thus, the earlier class declaration is equivalent to the
constructor definition from the previous section. It just looks nicer.

{{index ["class declaration", properties]}}

Class declarations currently allow only _methods_—properties that hold
functions—to be added to the ((prototype)). This can be somewhat
inconvenient when you want to save a non-function value in there.
The next version of the language will probably improve this. For now, you
can create such properties by directly manipulating the
prototype after you've defined the class.

Like `function`, `class` can be used both in statements and in
expressions. When used as an expression, it doesn't define a
binding but just produces the constructor as a value. You are allowed
to omit the class name in a class expression.

```
let object = new class { getWord() { return "hello"; } };
console.log(object.getWord());
// → hello
```

## Overriding derived properties

{{index "shared property", overriding, [property, inheritance]}}

When you add a property to an object, whether it is present in the
prototype or not, the property is added to the object _itself_.
If there was already a property with
the same name in the prototype, this property will no longer affect
the object, as it is now hidden behind the object's own property.

```
Rabbit.prototype.teeth = "small";
console.log(killerRabbit.teeth);
// → small
killerRabbit.teeth = "long, sharp, and bloody";
console.log(killerRabbit.teeth);
// → long, sharp, and bloody
console.log(blackRabbit.teeth);
// → small
console.log(Rabbit.prototype.teeth);
// → small
```

{{index [prototype, diagram]}}

The following diagram sketches the situation after this code has run.
The `Rabbit` and `Object` ((prototype))s lie behind `killerRabbit` as
a kind of backdrop, where properties that are not found in the object
itself can be looked up.

{{figure {url: "img/rabbits.svg", alt: "Rabbit object prototype schema",width: "8cm"}}}

{{index "shared property"}}

Overriding properties that exist in a prototype can be a useful thing
to do. As the rabbit teeth example shows, overriding can be used to express
exceptional properties in instances of a more generic class of
objects, while letting the nonexceptional objects take a
standard value from their prototype.

{{index "toString method", "Array prototype", "Function prototype"}}

Overriding is also used to give the standard function and array prototypes a
different `toString` method than the basic object prototype.

```
console.log(Array.prototype.toString ==
            Object.prototype.toString);
// → false
console.log([1, 2].toString());
// → 1,2
```

{{index "toString method", "join method", "call method"}}

Calling `toString` on an array gives a result similar to calling
`.join(",")` on it—it puts commas between the values in the array.
Directly calling `Object.prototype.toString` with an array produces a
different string. That function doesn't know about arrays, so it
simply puts the word _object_ and the name of the type between square
brackets.

```
console.log(Object.prototype.toString.call([1, 2]));
// → [object Array]
```

## Maps

{{index "map method"}}

We saw the word _map_ used in the [previous chapter](higher_order#map)
for an operation that transforms a data structure by applying a
function to its elements. Confusing as it is, in programming the same
word is also used for a related but rather different thing.

{{index "map (data structure)", "ages example", ["data structure", map]}}

A _map_ (noun) is a data structure that associates values (the keys)
with other values. For example, you might want to map names to ages.
It is possible to use objects for this.

```
let ages = {
  Boris: 39,
  Liang: 22,
  Júlia: 62
};

console.log(`Júlia is ${ages["Júlia"]}`);
// → Júlia is 62
console.log("Is Jack's age known?", "Jack" in ages);
// → Is Jack's age known? false
console.log("Is toString's age known?", "toString" in ages);
// → Is toString's age known? true
```

{{index "Object.prototype", "toString method"}}

Here, the object's property names are the people's names, and the
property values are their ages. But we certainly didn't list anybody named
toString in our map. Yet, because plain objects derive from
`Object.prototype`, it looks like the property is there.

{{index "Object.create function", prototype}}

As such, using plain objects as maps is dangerous. There are several
possible ways to avoid this problem. First, it is possible to create
objects with _no_ prototype. If you pass `null` to `Object.create`,
the resulting object will not derive from `Object.prototype` and can
safely be used as a map.

```
console.log("toString" in Object.create(null));
// → false
```

{{index [property, naming]}}

Object property names must be strings. If you need a map whose
keys can't easily be converted to strings—such as objects—you cannot
use an object as your map.

{{index "Map class"}}

Fortunately, JavaScript comes with a class called `Map` that is
written for this exact purpose. It stores a mapping and allows any
type of keys.

```
let ages = new Map();
ages.set("Boris", 39);
ages.set("Liang", 22);
ages.set("Júlia", 62);

console.log(`Júlia is ${ages.get("Júlia")}`);
// → Júlia is 62
console.log("Is Jack's age known?", ages.has("Jack"));
// → Is Jack's age known? false
console.log(ages.has("toString"));
// → false
```

{{index [interface, object], "set method", "get method", "has method", encapsulation}}

The methods `set`, `get`, and `has` are part of the interface of the
`Map` object. Writing a data structure that can quickly update and
search a large set of values isn't easy, but we don't have to worry
about that. Someone else did it for us, and we can go through this
simple interface to use their work.

{{index "hasOwnProperty method", "in operator"}}

If you do have a plain object that you need to treat as a map for some
reason, it is useful to know that `Object.keys` returns only an
object's _own_ keys, not those in the prototype. As an alternative to
the `in` operator, you can use the `hasOwnProperty` method, which
ignores the object's prototype.

```
console.log({x: 1}.hasOwnProperty("x"));
// → true
console.log({x: 1}.hasOwnProperty("toString"));
// → false
```

## Polymorphism

{{index "toString method", "String function", polymorphism, overriding, "object-oriented programming"}}

When you call the `String` function (which converts a value to a
string) on an object, it will call the `toString` method on that
object to try to create a meaningful string from it. I mentioned that
some of the standard prototypes define their own version of `toString`
so they can create a string that contains more useful information than
`"[object Object]"`. You can also do that yourself.

```{includeCode: "top_lines: 3"}
Rabbit.prototype.toString = function() {
  return `a ${this.type} rabbit`;
};

console.log(String(blackRabbit));
// → a black rabbit
```

{{index "object-oriented programming", [interface, object]}}

This is a simple instance of a powerful idea. When a piece of code is
written to work with objects that have a certain interface—in this
case, a `toString` method—any kind of object that happens to support
this interface can be plugged into the code, and it will just work.

This technique is called _polymorphism_. Polymorphic code can work
with values of different shapes, as long as they support the interface
it expects.

{{index "for/of loop", "iterator interface"}}

I mentioned in [Chapter ?](data#for_of_loop) that a `for`/`of` loop
can loop over several kinds of data structures. This is another case
of polymorphism—such loops expect the data structure to expose a
specific interface, which arrays and strings do. And we can also add
this interface to your own objects! But before we can do that, we need
to know what symbols are.

## Symbols

It is possible for multiple interfaces to use the same property name
for different things. For example, I could define an interface in which
the `toString` method is supposed to convert the object into a piece
of yarn. It would not be possible for an object to conform to both
that interface and the standard use of `toString`.

That would be a bad idea, and this problem isn't that common. Most
JavaScript programmers simply don't think about it. But the language
designers, whose _job_ it is to think about this stuff, have provided
us with a solution anyway.

{{index "Symbol function", [property, naming]}}

When I claimed that property names are strings, that wasn't entirely
accurate. They usually are, but they can also be _((symbol))s_.
Symbols are values created with the `Symbol` function. Unlike strings,
newly created symbols are unique—you cannot create the same symbol
twice.

```
let sym = Symbol("name");
console.log(sym == Symbol("name"));
// → false
Rabbit.prototype[sym] = 55;
console.log(blackRabbit[sym]);
// → 55
```

The string you pass to `Symbol` is included when you convert it to a
string and can make it easier to recognize a symbol when, for
example, showing it in the console. But it has no meaning beyond
that—multiple symbols may have the same name.

Being both unique and usable as property names makes symbols suitable
for defining interfaces that can peacefully live alongside other
properties, no matter what their names are.

```{includeCode: "top_lines: 1"}
const toStringSymbol = Symbol("toString");
Array.prototype[toStringSymbol] = function() {
  return `${this.length} cm of blue yarn`;
};

console.log([1, 2].toString());
// → 1,2
console.log([1, 2][toStringSymbol]());
// → 2 cm of blue yarn
```

{{index [property, naming]}}

It is possible to include symbol properties in object expressions and
classes by using ((square bracket))s around the property name.
That causes the property name to be evaluated, much like the square
bracket property access notation, which allows us to refer to a
binding that holds the symbol.

```
let stringObject = {
  [toStringSymbol]() { return "a jute rope"; }
};
console.log(stringObject[toStringSymbol]());
// → a jute rope
```

## The iterator interface

{{index "iterable interface", "Symbol.iterator symbol", "for/of loop"}}

The object given to a `for`/`of` loop is expected to be _iterable_.
This means it has a method named with the `Symbol.iterator`
symbol (a symbol value defined by the language, stored as a property
of the `Symbol` function).

{{index "iterator interface", "next method"}}

When called, that method should return an object that provides a
second interface, _iterator_. This is the actual thing that iterates.
It has a `next` method that returns the next result. That result
should be an object with a `value` property that provides the next value,
if there is one, and a `done` property, which should be true when there
are no more results and false otherwise.

Note that the `next`, `value`, and `done` property names are plain
strings, not symbols. Only `Symbol.iterator`, which is likely to be
added to a _lot_ of different objects, is an actual symbol.

We can directly use this interface ourselves.

```
let okIterator = "OK"[Symbol.iterator]();
console.log(okIterator.next());
// → {value: "O", done: false}
console.log(okIterator.next());
// → {value: "K", done: false}
console.log(okIterator.next());
// → {value: undefined, done: true}
```

{{index "matrix example", "Matrix class", [array, "as matrix"]}}

{{id matrix}}

Let's implement an iterable data structure. We'll build a _matrix_
class, acting as a two-dimensional array.

```{includeCode: true}
class Matrix {
  constructor(width, height, element = (x, y) => undefined) {
    this.width = width;
    this.height = height;
    this.content = [];

    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        this.content[y * width + x] = element(x, y);
      }
    }
  }

  get(x, y) {
    return this.content[y * this.width + x];
  }
  set(x, y, value) {
    this.content[y * this.width + x] = value;
  }
}
```

The class stores its content in a single array of _width_ × _height_
elements. The elements are stored row by row, so, for example, the third
element in the fifth row is (using zero-based indexing) stored at
position 4 × _width_ + 2.

The constructor function takes a width, a height, and an optional
`element` function that will be used to fill in the initial values.
There are `get` and `set` methods to retrieve and update elements in
the matrix.

When looping over a matrix, you are usually interested in the position
of the elements as well as the elements themselves, so we'll have our
iterator produce objects with `x`, `y`, and `value` properties.

{{index "MatrixIterator class"}}

```{includeCode: true}
class MatrixIterator {
  constructor(matrix) {
    this.x = 0;
    this.y = 0;
    this.matrix = matrix;
  }

  next() {
    if (this.y == this.matrix.height) return {done: true};

    let value = {x: this.x,
                 y: this.y,
                 value: this.matrix.get(this.x, this.y)};
    this.x++;
    if (this.x == this.matrix.width) {
      this.x = 0;
      this.y++;
    }
    return {value, done: false};
  }
}
```

The class tracks the progress of iterating over a matrix in its `x`
and `y` properties. The `next` method starts by checking whether the
bottom of the matrix has been reached. If it hasn't, it _first_
creates the object holding the current value and _then_ updates its
position, moving to the next row if necessary.

Let's set up the `Matrix` class to be iterable. Throughout this book,
I'll occasionally use after-the-fact prototype manipulation to add
methods to classes so that the individual pieces of code remain small
and self-contained. In a regular program, where there is no need to
split the code into small pieces, you'd declare these methods directly
in the class instead.

```{includeCode: true}
Matrix.prototype[Symbol.iterator] = function() {
  return new MatrixIterator(this);
};
```

{{index "for/of loop"}}

We can now loop over a matrix with `for`/`of`.

```
let matrix = new Matrix(2, 2, (x, y) => `value ${x},${y}`);
for (let {x, y, value} of matrix) {
  console.log(x, y, value);
}
// → 0 0 value 0,0
// → 1 0 value 1,0
// → 0 1 value 0,1
// → 1 1 value 1,1
```

## Getters, setters, and statics

{{index [interface, object], [property, definition], "Map class"}}

Interfaces often consist mostly of methods, but it is also okay to
include properties that hold non-function values. For example, `Map`
objects have a `size` property that tells you how many keys are stored
in them.

It is not even necessary for such an object to compute and store such
a property directly in the instance. Even properties that are accessed
directly may hide a method call. Such methods are called
_((getter))s_, and they are defined by writing `get` in front of the
method name in an object expression or class declaration.

```{test: no}
let varyingSize = {
  get size() {
    return Math.floor(Math.random() * 100);
  }
};

console.log(varyingSize.size);
// → 73
console.log(varyingSize.size);
// → 49
```

{{index "temperature example"}}

Whenever someone reads from this object's `size` property, the
associated method is called. You can do a similar thing when a
property is written to, using a _((setter))_.

```{test: no, startCode: true}
class Temperature {
  constructor(celsius) {
    this.celsius = celsius;
  }
  get fahrenheit() {
    return this.celsius * 1.8 + 32;
  }
  set fahrenheit(value) {
    this.celsius = (value - 32) / 1.8;
  }

  static fromFahrenheit(value) {
    return new Temperature((value - 32) / 1.8);
  }
}

let temp = new Temperature(22);
console.log(temp.fahrenheit);
// → 71.6
temp.fahrenheit = 86;
console.log(temp.celsius);
// → 30
```

The `Temperature` class allows you to read and write the temperature
in either degrees ((Celsius)) or degrees ((Fahrenheit)), but
internally it stores only Celsius and automatically converts to
and from Celsius in the `fahrenheit` getter and setter.

{{index "static method"}}

Sometimes you want to attach some properties directly to your
constructor function, rather than to the prototype. Such methods won't
have access to a class instance but can, for example, be used to
provide additional ways to create instances.

Inside a class declaration, methods that have `static` written before
their name are stored on the constructor. So the `Temperature` class
allows you to write `Temperature.fromFahrenheit(100)` to create a
temperature using degrees Fahrenheit.

## Inheritance

{{index inheritance, "matrix example", "object-oriented programming", "SymmetricMatrix class"}}

Some matrices are known to be _symmetric_. If you mirror a symmetric
matrix around its top-left-to-bottom-right diagonal, it stays the
same. In other words, the value stored at _x_,_y_ is always the same
as that at _y_,_x_.

Imagine we need a data structure like `Matrix` but one that enforces
the fact that the matrix is and remains symmetrical. We could write it
from scratch, but that would involve repeating some code very similar
to what we already wrote.

{{index overriding, prototype}}

JavaScript's prototype system makes it possible to create a _new_
class, much like the old class, but with new definitions for some of
its properties. The prototype for the new class derives from the old
prototype but adds a new definition for, say, the `set` method.

In object-oriented programming terms, this is called
_((inheritance))_. The new class inherits properties and behavior from
the old class.

```{includeCode: "top_lines: 17"}
class SymmetricMatrix extends Matrix {
  constructor(size, element = (x, y) => undefined) {
    super(size, size, (x, y) => {
      if (x < y) return element(y, x);
      else return element(x, y);
    });
  }

  set(x, y, value) {
    super.set(x, y, value);
    if (x != y) {
      super.set(y, x, value);
    }
  }
}

let matrix = new SymmetricMatrix(5, (x, y) => `${x},${y}`);
console.log(matrix.get(2, 3));
// → 3,2
```

The use of the word `extends` indicates that this class shouldn't be
directly based on the default `Object` prototype but on some other class. This
is called the _((superclass))_. The derived class is the
_((subclass))_.

To initialize a `SymmetricMatrix` instance, the constructor calls its
superclass's constructor through the `super` keyword. This is necessary
because if this new object is to behave (roughly) like a `Matrix`, it
is going to need the instance properties that matrices have. 
To ensure the matrix is symmetrical, the constructor wraps the
`element` function to swap the coordinates for values below the
diagonal.

The `set` method again uses `super` but this time not to call the
constructor but to call a specific method from the superclass's set of
methods. We are redefining `set` but do want to use the original
behavior. Because `this.set` refers to the _new_ `set` method, calling
that wouldn't work. Inside class methods, `super` provides a way to
call methods as they were defined in the superclass.

Inheritance allows us to build slightly different data types from
existing data types with relatively little work. It is a fundamental
part of the object-oriented tradition, alongside encapsulation and
polymorphism. But while the latter two are now generally regarded as
wonderful ideas, inheritance is more controversial.

{{index complexity, reuse, "class hierarchy"}}

Whereas ((encapsulation)) and polymorphism can be used to _separate_
pieces of code from each other, reducing the tangledness of the
overall program, ((inheritance)) fundamentally ties classes together,
creating _more_ tangle. When inheriting from a class, you usually have
to know more about how it works than when simply using it. Inheritance
can be a useful tool, and I use it now and then in my own programs,
but it shouldn't be the first tool you reach for, and you probably
shouldn't actively go looking for opportunities to construct class
hierarchies (family trees of classes).

## The instanceof operator

{{index type, "instanceof operator", constructor, object}}

It is occasionally useful to know whether an object was derived from a
specific class. For this, JavaScript provides a binary operator called
`instanceof`.

```
console.log(
  new SymmetricMatrix(2) instanceof SymmetricMatrix);
// → true
console.log(new SymmetricMatrix(2) instanceof Matrix);
// → true
console.log(new Matrix(2, 2) instanceof SymmetricMatrix);
// → false
console.log([1] instanceof Array);
// → true
```

{{index inheritance}}

The operator will see through inherited types, so a `SymmetricMatrix`
is an instance of `Matrix`. The operator can also be applied to
standard constructors like `Array`. Almost every object is an instance
of `Object`.

## Summary

So objects do more than just hold their own properties. They have
prototypes, which are other objects. They'll act as if they have
properties they don't have as long as their prototype has that
property. Simple objects have `Object.prototype` as their prototype.

Constructors, which are functions whose names usually start with a
capital letter, can be used with the `new` operator to create new
objects. The new object's prototype will be the object found in the
`prototype` property of the constructor. You can make good use of this
by putting the properties that all values of a given type share into
their prototype. There's a `class` notation that provides a clear way
to define a constructor and its prototype.

You can define getters and setters to secretly call methods every time
an object's property is accessed. Static methods are methods stored in
a class's constructor, rather than its prototype.

The `instanceof` operator can, given an object and a constructor, tell
you whether that object is an instance of that constructor.

One useful thing to do with objects is to specify an interface for
them and tell everybody that they are supposed to talk to your object
only through that interface. The rest of the details that make up your
object are now _encapsulated_, hidden behind the interface.

More than one type may implement the same interface. Code written to
use an interface automatically knows how to work with any number of
different objects that provide the interface. This is called
_polymorphism_.

When implementing multiple classes that differ in only some details,
it can be helpful to write the new classes as _subclasses_ of an
existing class, _inheriting_ part of its behavior.

## Exercises

{{id exercise_vector}}

### A vector type

{{index dimensions, "Vec class", coordinates, "vector (exercise)"}}

Write a ((class)) `Vec` that represents a vector in two-dimensional
space. It takes `x` and `y` parameters (numbers), which it should save
to properties of the same name.

{{index addition, subtraction}}

Give the `Vec` prototype two methods, `plus` and `minus`, that take
another vector as a parameter and return a new vector that has the sum
or difference of the two vectors' (`this` and the parameter) _x_ and
_y_ values.

Add a ((getter)) property `length` to the prototype that computes the
length of the vector—that is, the distance of the point (_x_, _y_) from
the origin (0, 0).

{{if interactive

```{test: no}
// Your code here.

console.log(new Vec(1, 2).plus(new Vec(2, 3)));
// → Vec{x: 3, y: 5}
console.log(new Vec(1, 2).minus(new Vec(2, 3)));
// → Vec{x: -1, y: -1}
console.log(new Vec(3, 4).length);
// → 5
```
if}}

{{hint

{{index "vector (exercise)"}}

Look back to the `Rabbit` class example if you're unsure how `class`
declarations look.

{{index Pythagoras, "defineProperty function", "square root", "Math.sqrt function"}}

Adding a getter property to the constructor can be done by putting the
word `get` before the method name. To compute the distance from (0, 0)
to (x, y), you can use the Pythagorean theorem, which says that the
square of the distance we are looking for is equal to the square of
the x-coordinate plus the square of the y-coordinate. Thus, [√(x^2^ +
y^2^)]{if html}[[$\sqrt{x^2 + y^2}$]{latex}]{if tex} is the number you
want, and `Math.sqrt` is the way you compute a square root in
JavaScript.

hint}}

### Groups

{{index "groups (exercise)", "Set class", "Group class", "set (data structure)"}}

{{id groups}}

The standard JavaScript environment provides another data structure
called `Set`. Like an instance of `Map`, a set holds a collection of
values. Unlike `Map`, it does not associate other values with those—it
just tracks which values are part of the set. A value can be part
of a set only once—adding it again doesn't have any effect.

{{index "add method", "delete method", "has method"}}

Write a class called `Group` (since `Set` is already taken). Like
`Set`, it has `add`, `delete`, and `has` methods. Its constructor
creates an empty group, `add` adds a value to the group (but only if
it isn't already a member), `delete` removes its argument from the
group (if it was a member), and `has` returns a Boolean value
indicating whether its argument is a member of the group.

{{index "=== operator", "indexOf method"}}

Use the `===` operator, or something equivalent such as `indexOf`, to
determine whether two values are the same.

{{index "static method"}}

Give the class a static `from` method that takes an iterable object
as argument and creates a group that contains all the values produced
by iterating over it.

{{if interactive

```{test: no}
class Group {
  // Your code here.
}

let group = Group.from([10, 20]);
console.log(group.has(10));
// → true
console.log(group.has(30));
// → false
group.add(10);
group.delete(10);
console.log(group.has(10));
// → false
```

if}}

{{hint

{{index "groups (exercise)", "Group class", "indexOf method", "includes method"}}

The easiest way to do this is to store an array of group members
in an instance property. The `includes` or `indexOf` methods can be
used to check whether a given value is in the array.

{{index "push method"}}

Your class's ((constructor)) can set the member collection to an empty
array. When `add` is called, it must check whether the given value is
in the array or add it, for example with `push`, otherwise.

{{index "filter method"}}

Deleting an element from an array, in `delete`, is less
straightforward, but you can use `filter` to create a new array
without the value. Don't forget to overwrite the property holding the
members with the newly filtered version of the array.

{{index "for/of loop", "iterable interface"}}

The `from` method can use a `for`/`of` loop to get the values out of
the iterable object and call `add` to put them into a newly created
group.

hint}}

### Iterable groups

{{index "groups (exercise)", [interface, object], "iterator interface", "Group class"}}

{{id group_iterator}}

Make the `Group` class from the previous exercise iterable. Refer 
to the section about the iterator interface earlier in the chapter if
you aren't clear on the exact form of the interface anymore.

If you used an array to represent the group's members, don't just
return the iterator created by calling the `Symbol.iterator` method on
the array. That would work, but it defeats the purpose of this exercise.

It is okay if your iterator behaves strangely when the group is
modified during iteration.

{{if interactive

```{test: no}
// Your code here (and the code from the previous exercise)

for (let value of Group.from(["a", "b", "c"])) {
  console.log(value);
}
// → a
// → b
// → c
```

if}}

{{hint

{{index "groups (exercise)", "Group class", "next method"}}

It is probably worthwhile to define a new class `GroupIterator`.
Iterator instances should have a property that tracks the current
position in the group. Every time `next` is called, it checks whether
it is done and, if not, moves past the current value and returns it.

The `Group` class itself gets a method named by `Symbol.iterator`
that, when called, returns a new instance of the iterator class for
that group.

hint}}

### Borrowing a method

Earlier in the chapter I mentioned that an object's `hasOwnProperty`
can be used as a more robust alternative to the `in` operator when you
want to ignore the prototype's properties. But what if your map needs
to include the word `"hasOwnProperty"`? You won't be able to call that
method anymore because the object's own property hides the method
value.

Can you think of a way to call `hasOwnProperty` on an object that has
its own property by that name?

{{if interactive

```{test: no}
let map = {one: true, two: true, hasOwnProperty: true};

// Fix this call
console.log(map.hasOwnProperty("one"));
// → true
```

if}}

{{hint

Remember that methods that exist on plain objects come from
`Object.prototype`.

Also remember that you can call a function with a specific `this`
binding by using its `call` method.

hint}}
{{meta {load_files: ["code/chapter/07_robot.js", "code/animatevillage.js"], zip: html}}}

# Project: A Robot

{{quote {author: "Edsger Dijkstra", title: "The Threats to Computing Science", chapter: true}

[...] the question of whether Machines Can Think [...] is about as
relevant as the question of whether Submarines Can Swim.

quote}}

{{index "artificial intelligence", "Dijkstra, Edsger"}}

{{figure {url: "img/chapter_picture_7.jpg", alt: "Picture of a package-delivery robot", chapter: framed}}}

{{index "project chapter", "reading code", "writing code"}}

In "project" chapters, I'll stop pummeling you with new theory for a
brief moment, and instead we'll work through a program together. Theory
is necessary to learn to program, but reading and understanding actual
programs is just as important.

Our project in this chapter is to build an ((automaton)), a little
program that performs a task in a ((virtual world)). Our automaton
will be a mail-delivery ((robot)) picking up and dropping off parcels.

## Meadowfield

{{index "roads array"}}

The village of ((Meadowfield)) isn't very big. It consists of 11
places with 14 roads between them. It can be described with this
array of roads:

```{includeCode: true}
const roads = [
  "Alice's House-Bob's House",   "Alice's House-Cabin",
  "Alice's House-Post Office",   "Bob's House-Town Hall",
  "Daria's House-Ernie's House", "Daria's House-Town Hall",
  "Ernie's House-Grete's House", "Grete's House-Farm",
  "Grete's House-Shop",          "Marketplace-Farm",
  "Marketplace-Post Office",     "Marketplace-Shop",
  "Marketplace-Town Hall",       "Shop-Town Hall"
];
```

{{figure {url: "img/village2x.png", alt: "The village of Meadowfield"}}}

The network of roads in the village forms a _((graph))_. A graph is a
collection of points (places in the village) with lines between them
(roads). This graph will be the world that our robot moves through.

{{index "roadGraph object"}}

The array of strings isn't very easy to work with. What we're
interested in is the destinations that we can reach from a given
place. Let's convert the list of roads to a data structure that, for
each place, tells us what can be reached from there.

```{includeCode: true}
function buildGraph(edges) {
  let graph = Object.create(null);
  function addEdge(from, to) {
    if (graph[from] == null) {
      graph[from] = [to];
    } else {
      graph[from].push(to);
    }
  }
  for (let [from, to] of edges.map(r => r.split("-"))) {
    addEdge(from, to);
    addEdge(to, from);
  }
  return graph;
}

const roadGraph = buildGraph(roads);
```

Given an array of edges, `buildGraph` creates a map object that, for
each node, stores an array of connected nodes.

{{index "split method"}}

It uses the `split` method to go from the road strings, which have the
form `"Start-End"`, to two-element arrays containing the start and end
as separate strings.

## The task

Our ((robot)) will be moving around the village. There are parcels
in various places, each addressed to some other place. The robot picks
up parcels when it comes to them and delivers them when it arrives at
their destinations.

The automaton must decide, at each point, where to go next. It has
finished its task when all parcels have been delivered.

{{index simulation, "virtual world"}}

To be able to simulate this process, we must define a virtual world
that can describe it. This model tells us where the robot is and where
the parcels are. When the robot has decided to move somewhere, we need
to update the model to reflect the new situation.

{{index [state, in objects]}}

If you're thinking in terms of ((object-oriented programming)), your
first impulse might be to start defining objects for the various
elements in the world: a ((class)) for the robot, one for a parcel,
maybe one for places. These could then hold properties that describe
their current ((state)), such as the pile of parcels at a location,
which we could change when updating the world.

This is wrong.

At least, it usually is. The fact that something sounds like an object
does not automatically mean that it should be an object in your
program. Reflexively writing classes for every concept in your
application tends to leave you with a collection of interconnected
objects that each have their own internal, changing state. Such
programs are often hard to understand and thus easy to break.

{{index [state, in objects]}}

Instead, let's condense the village's state down to the minimal
set of values that define it. There's the robot's current location and
the collection of undelivered parcels, each of which has a current
location and a destination address. That's it.

{{index "VillageState class", "persistent data structure"}}

And while we're at it, let's make it so that we don't _change_ this
state when the robot moves but rather compute a _new_ state for the
situation after the move.

```{includeCode: true}
class VillageState {
  constructor(place, parcels) {
    this.place = place;
    this.parcels = parcels;
  }

  move(destination) {
    if (!roadGraph[this.place].includes(destination)) {
      return this;
    } else {
      let parcels = this.parcels.map(p => {
        if (p.place != this.place) return p;
        return {place: destination, address: p.address};
      }).filter(p => p.place != p.address);
      return new VillageState(destination, parcels);
    }
  }
}
```

The `move` method is where the action happens. It first checks whether
there is a road going from the current place to the destination, and
if not, it returns the old state since this is not a valid move.

{{index "map method", "filter method"}}

Then it creates a new state with the destination as the robot's new
place. But it also needs to create a new set of parcels—parcels that
the robot is carrying (that are at the robot's current place) need to
be moved along to the new place. And parcels that are addressed to the
new place need to be delivered—that is, they need to be removed from
the set of undelivered parcels. The call to `map` takes care of the
moving, and the call to `filter` does the delivering.

Parcel objects aren't changed when they are moved but re-created. The
`move` method gives us a new village state but leaves the old one
entirely intact.

```
let first = new VillageState(
  "Post Office",
  [{place: "Post Office", address: "Alice's House"}]
);
let next = first.move("Alice's House");

console.log(next.place);
// → Alice's House
console.log(next.parcels);
// → []
console.log(first.place);
// → Post Office
```

The move causes the parcel to be delivered, and this is reflected in
the next state. But the initial state still describes the situation
where the robot is at the post office and the parcel is undelivered.

## Persistent data

{{index "persistent data structure", mutability, ["data structure", immutable]}}

Data structures that don't change are called _((immutable))_ or
_persistent_. They behave a lot like strings and numbers in that they
are who they are and stay that way, rather than containing different
things at different times.

In JavaScript, just about everything _can_ be changed, so working with
values that are supposed to be persistent requires some restraint.
There is a function called `Object.freeze` that changes an object so
that writing to its properties is ignored. You could use that to make
sure your objects aren't changed, if you want to be careful. Freezing
does require the computer to do some extra work, and having updates
ignored is just about as likely to confuse someone as having them do
the wrong thing. So I usually prefer to just tell people that a given
object shouldn't be messed with and hope they remember it.

```
let object = Object.freeze({value: 5});
object.value = 10;
console.log(object.value);
// → 5
```

Why am I going out of my way to not change objects when the language
is obviously expecting me to?

Because it helps me understand my programs. This is about complexity
management again. When the objects in my system are fixed, stable
things, I can consider operations on them in isolation—moving to
Alice's house from a given start state always produces the same new
state. When objects change over time, that adds a whole new dimension
of complexity to this kind of reasoning.

For a small system like the one we are building in this chapter, we
could handle that bit of extra complexity. But the most important
limit on what kind of systems we can build is how much we can
understand. Anything that makes your code easier to understand makes
it possible to build a more ambitious system.

Unfortunately, although understanding a system built on persistent data
structures is easier, _designing_ one, especially when your
programming language isn't helping, can be a little harder. We'll
look for opportunities to use persistent data structures in this
book, but we'll also be using changeable ones.

## Simulation

{{index simulation, "virtual world"}}

A delivery ((robot)) looks at the world and decides in which
direction it wants to move. As such, we could say that a robot is a
function that takes a `VillageState` object and returns the name of a
nearby place.

{{index "runRobot function"}}

Because we want robots to be able to remember things, so that they can
make and execute plans, we also pass them their memory and allow them
to return a new memory. Thus, the thing a robot returns is an object
containing both the direction it wants to move in and a memory value
that will be given back to it the next time it is called.

```{includeCode: true}
function runRobot(state, robot, memory) {
  for (let turn = 0;; turn++) {
    if (state.parcels.length == 0) {
      console.log(`Done in ${turn} turns`);
      break;
    }
    let action = robot(state, memory);
    state = state.move(action.direction);
    memory = action.memory;
    console.log(`Moved to ${action.direction}`);
  }
}
```

Consider what a robot has to do to "solve" a given state. It must pick
up all parcels by visiting every location that has a parcel and
deliver them by visiting every location that a parcel is addressed to,
but only after picking up the parcel.

What is the dumbest strategy that could possibly work? The robot could
just walk in a random direction every turn. That means, with
great likelihood, it will eventually run into all parcels and then
also at some point reach the place where they should be delivered.

{{index "randomPick function", "randomRobot function"}}

Here's what that could look like:

```{includeCode: true}
function randomPick(array) {
  let choice = Math.floor(Math.random() * array.length);
  return array[choice];
}

function randomRobot(state) {
  return {direction: randomPick(roadGraph[state.place])};
}
```

{{index "Math.random function", "Math.floor function", [array, "random element"]}}

Remember that `Math.random()` returns a number between zero and
one—but always below one. Multiplying such a number by the length of an
array and then applying `Math.floor` to it gives us a random index for
the array.

Since this robot does not need to remember anything, it ignores its
second argument (remember that JavaScript functions can be called with
extra arguments without ill effects) and omits the `memory` property
in its returned object.

To put this sophisticated robot to work, we'll first need a way to
create a new state with some parcels. A static method (written here by
directly adding a property to the constructor) is a good place to put
that functionality.

```{includeCode: true}
VillageState.random = function(parcelCount = 5) {
  let parcels = [];
  for (let i = 0; i < parcelCount; i++) {
    let address = randomPick(Object.keys(roadGraph));
    let place;
    do {
      place = randomPick(Object.keys(roadGraph));
    } while (place == address);
    parcels.push({place, address});
  }
  return new VillageState("Post Office", parcels);
};
```

{{index "do loop"}}

We don't want any parcels that are sent from the same place that they
are addressed to. For this reason, the `do` loop keeps picking new
places when it gets one that's equal to the address.

Let's start up a virtual world.

```{test: no}
runRobot(VillageState.random(), randomRobot);
// → Moved to Marketplace
// → Moved to Town Hall
// → …
// → Done in 63 turns
```

It takes the robot a lot of turns to deliver the parcels because it
isn't planning ahead very well. We'll address that soon.

{{if interactive

For a more pleasant perspective on the simulation, you can use the
`runRobotAnimation` function that's available in [this chapter's
programming environment](https://eloquentjavascript.net/code/#7).
This runs the simulation, but instead of outputting text, it shows
you the robot moving around the village map.

```{test: no}
runRobotAnimation(VillageState.random(), randomRobot);
```

The way `runRobotAnimation` is implemented will remain a mystery for
now, but after you've read the [later chapters](dom) of this book,
which discuss JavaScript integration in web browsers, you'll be able
to guess how it works.

if}}

## The mail truck's route

{{index "mailRoute array"}}

We should be able to do a lot better than the random ((robot)). An
easy improvement would be to take a hint from the way real-world mail
delivery works. If we find a route that passes all places in the
village, the robot could run that route twice, at which point it is
guaranteed to be done. Here is one such route (starting from the post
office):

```{includeCode: true}
const mailRoute = [
  "Alice's House", "Cabin", "Alice's House", "Bob's House",
  "Town Hall", "Daria's House", "Ernie's House",
  "Grete's House", "Shop", "Grete's House", "Farm",
  "Marketplace", "Post Office"
];
```

{{index "routeRobot function"}}

To implement the route-following robot, we'll need to make use of
robot memory. The robot keeps the rest of its route in its memory and
drops the first element every turn.

```{includeCode: true}
function routeRobot(state, memory) {
  if (memory.length == 0) {
    memory = mailRoute;
  }
  return {direction: memory[0], memory: memory.slice(1)};
}
```

This robot is a lot faster already. It'll take a maximum of 26 turns
(twice the 13-step route) but usually less.

{{if interactive

```{test: no}
runRobotAnimation(VillageState.random(), routeRobot, []);
```

if}}

## Pathfinding

Still, I wouldn't really call blindly following a fixed route
intelligent behavior. The ((robot)) could work more efficiently if it
adjusted its behavior to the actual work that needs to be done.

{{index pathfinding}}

To do that, it has to be able to deliberately move toward a given
parcel or toward the location where a parcel has to be delivered.
Doing that, even when the goal is more than one move away, will
require some kind of route-finding function.

The problem of finding a route through a ((graph)) is a typical
_((search problem))_. We can tell whether a given solution (a route)
is a valid solution, but we can't directly compute the solution the
way we could for 2 + 2. Instead, we have to keep creating potential
solutions until we find one that works.

The  number of possible routes through a graph is infinite. But
when searching for a route from _A_ to _B_, we are interested only in
the ones that start at _A_. We also don't care about routes that visit
the same place twice—those are definitely not the most efficient route
anywhere. So that cuts down on the number of routes that the route
finder has to consider.

In fact, we are mostly interested in the _shortest_ route. So we want
to make sure we look at short routes before we look at longer ones. A
good approach would be to "grow" routes from the starting point,
exploring every reachable place that hasn't been visited yet, until a
route reaches the goal. That way, we'll only explore routes that are
potentially interesting, and we'll find the shortest route (or one of the
shortest routes, if there are more than one) to the goal.

{{index "findRoute function"}}

{{id findRoute}}

Here is a function that does this:

```{includeCode: true}
function findRoute(graph, from, to) {
  let work = [{at: from, route: []}];
  for (let i = 0; i < work.length; i++) {
    let {at, route} = work[i];
    for (let place of graph[at]) {
      if (place == to) return route.concat(place);
      if (!work.some(w => w.at == place)) {
        work.push({at: place, route: route.concat(place)});
      }
    }
  }
}
```

The exploring has to be done in the right order—the places that were
reached first have to be explored first. We can't immediately explore
a place as soon as we reach it because that would mean places reached
_from there_ would also be explored immediately, and so on, even
though there may be other, shorter paths that haven't yet been
explored.

Therefore, the function keeps a _((work list))_. This is an array of
places that should be explored next, along with the route that got us
there. It starts with just the start position and an empty route.

The search then operates by taking the next item in the list and
exploring that, which means all roads going from that place are
looked at. If one of them is the goal, a finished route can be
returned. Otherwise, if we haven't looked at this place before, a new
item is added to the list. If we have looked at it before, since we
are looking at short routes first, we've found either a longer route
to that place or one precisely as long as the existing one, and we
don't need to explore it.

You can visually imagine this as a web of known routes crawling out
from the start location, growing evenly on all sides (but never
tangling back into itself). As soon as the first thread reaches the
goal location, that thread is traced back to the start, giving us our
route.

{{index "connected graph"}}

Our code doesn't handle the situation where there are no more work
items on the work list because we know that our graph is _connected_,
meaning that every location can be reached from all other locations.
We'll always be able to find a route between two points, and the
search can't fail.

```{includeCode: true}
function goalOrientedRobot({place, parcels}, route) {
  if (route.length == 0) {
    let parcel = parcels[0];
    if (parcel.place != place) {
      route = findRoute(roadGraph, place, parcel.place);
    } else {
      route = findRoute(roadGraph, place, parcel.address);
    }
  }
  return {direction: route[0], memory: route.slice(1)};
}
```

{{index "goalOrientedRobot function"}}

This robot uses its memory value as a list of directions to move in,
just like the route-following robot. Whenever that list is empty, it
has to figure out what to do next. It takes the first undelivered
parcel in the set and, if that parcel hasn't been picked up yet, plots a
route toward it. If the parcel _has_ been picked up, it still needs to be
delivered, so the robot creates a route toward the delivery address instead.

{{if interactive

Let's see how it does.

```{test: no, startCode: true}
runRobotAnimation(VillageState.random(),
                  goalOrientedRobot, []);
```

if}}

This robot usually finishes the task of delivering 5 parcels in about
16 turns. That's slightly better than `routeRobot` but still definitely not optimal.

## Exercises

### Measuring a robot

{{index "measuring a robot (exercise)", testing, automation, "compareRobots function"}}

It's hard to objectively compare ((robot))s by just letting them solve
a few scenarios. Maybe one robot just happened to get easier tasks or
the kind of tasks that it is good at, whereas the other didn't.

Write a function `compareRobots` that takes two robots (and their
starting memory). It should generate 100 tasks and let each of
the robots solve each of these tasks. When done, it should output the
average number of steps each robot took per task.

For the sake of fairness, make sure you give each task to both
robots, rather than generating different tasks per robot.

{{if interactive

```{test: no}
function compareRobots(robot1, memory1, robot2, memory2) {
  // Your code here
}

compareRobots(routeRobot, [], goalOrientedRobot, []);
```
if}}

{{hint

{{index "measuring a robot (exercise)", "runRobot function"}}

You'll have to write a variant of the `runRobot` function that,
instead of logging the events to the console, returns the number of
steps the robot took to complete the task.

Your measurement function can then, in a loop, generate new states and
count the steps each of the robots takes. When it has generated enough
measurements, it can use `console.log` to output the average for each
robot, which is the total number of steps taken divided by the number
of measurements.

hint}}

### Robot efficiency

{{index "robot efficiency (exercise)"}}

Can you write a robot that finishes the delivery task faster than
`goalOrientedRobot`? If you observe that robot's behavior, what
obviously stupid things does it do? How could those be improved?

If you solved the previous exercise, you might want to use your
`compareRobots` function to verify whether you improved the robot.

{{if interactive

```{test: no}
// Your code here

runRobotAnimation(VillageState.random(), yourRobot, memory);
```

if}}

{{hint

{{index "robot efficiency (exercise)"}}

The main limitation of `goalOrientedRobot` is that it considers only
one parcel at a time. It will often walk back and forth across the
village because the parcel it happens to be looking at happens to be
at the other side of the map, even if there are others much closer.

One possible solution would be to compute routes for all packages and
then take the shortest one. Even better results can be obtained, if
there are multiple shortest routes, by preferring the ones that go to
pick up a package instead of delivering a package.

hint}}

### Persistent group

{{index "persistent group (exercise)", "persistent data structure", "Set class", "set (data structure)", "Group class", "PGroup class"}}

Most data structures provided in a standard JavaScript environment
aren't very well suited for persistent use. Arrays have `slice` and
`concat` methods, which allow us to easily create new arrays without
damaging the old one. But `Set`, for example, has no methods for
creating a new set with an item added or removed.

Write a new class `PGroup`, similar to the `Group` class from [Chapter
?](object#groups), which stores a set of values. Like `Group`, it has
`add`, `delete`, and `has` methods.

Its `add` method, however, should return a _new_ `PGroup` instance
with the given member added and leave the old one unchanged.
Similarly, `delete` creates a new instance without a given member.

The class should work for values of any type, not just strings. It
does _not_ have to be efficient when used with large amounts of
values.

{{index [interface, object]}}

The ((constructor)) shouldn't be part of the class's interface
(though you'll definitely want to use it internally). Instead, there
is an empty instance, `PGroup.empty`, that can be used as a starting
value.

{{index singleton}}

Why do you need only one `PGroup.empty` value, rather than having a
function that creates a new, empty map every time?

{{if interactive

```{test: no}
class PGroup {
  // Your code here
}

let a = PGroup.empty.add("a");
let ab = a.add("b");
let b = ab.delete("a");

console.log(b.has("b"));
// → true
console.log(a.has("b"));
// → false
console.log(b.has("a"));
// → false
```

if}}

{{hint

{{index "persistent map (exercise)", "Set class", [array, creation], "PGroup class"}}

The most convenient way to represent the set of member values
is still as an array since arrays are easy to copy.

{{index "concat method", "filter method"}}

When a value is added to the group, you can create a new group with a
copy of the original array that has the value added (for example, using
`concat`). When a value is deleted, you filter it from the array.

The class's ((constructor)) can take such an array as argument and
store it as the instance's (only) property. This array is never
updated.

{{index "static method"}}

To add a property (`empty`) to a constructor that is not a method, you
have to add it to the constructor after the class definition, as a
regular property.

You need only one `empty` instance because all empty groups are the
same and instances of the class don't change. You can create many
different groups from that single empty group without affecting it.

hint}}
{{meta {load_files: ["code/chapter/08_error.js"]}}}

# Bugs and Errors

{{quote {author: "Brian Kernighan and P.J. Plauger", title: "The Elements of Programming Style", chapter: true}

Debugging is twice as hard as writing the code in the first place.
Therefore, if you write the code as cleverly as possible, you are, by
definition, not smart enough to debug it.

quote}}

{{figure {url: "img/chapter_picture_8.jpg", alt: "Picture of a collection of bugs", chapter: framed}}}

{{index "Kernighan, Brian", "Plauger, P.J.", debugging, "error handling"}}

Flaws in computer programs are usually called _((bug))s_. It makes
programmers feel good to imagine them as little things that just
happen to crawl into our work. In reality, of course, we put them
there ourselves.

If a program is crystallized thought, you can roughly categorize bugs
into those caused by the thoughts being confused and those caused by
mistakes introduced while converting a thought to code. The former
type is generally harder to diagnose and fix than the latter.

## Language

{{index parsing, analysis}}

Many mistakes could be pointed out to us automatically by the
computer, if it knew enough about what we're trying to do. But here
JavaScript's looseness is a hindrance. Its concept of bindings and
properties is vague enough that it will rarely catch ((typo))s before
actually running the program. And even then, it allows you to do some
clearly nonsensical things without complaint, such as computing
`true * "monkey"`.

{{index [syntax, error], [property, access]}}

There are some things that JavaScript does complain about. Writing a
program that does not follow the language's ((grammar)) will
immediately make the computer complain. Other things, such as calling
something that's not a function or looking up a property on an
((undefined)) value, will cause an error to be reported when the
program tries to perform the action.

{{index NaN, error}}

But often, your nonsense computation will merely produce `NaN` (not a
number) or an undefined value, while the program happily continues,
convinced that it's doing something meaningful. The mistake will
manifest itself only later, after the bogus value has traveled through
several functions. It might not trigger an error at all but silently
cause the program's output to be wrong. Finding the source of such
problems can be difficult.

The process of finding mistakes—bugs—in programs is called
_((debugging))_.

## Strict mode

{{index "strict mode", [syntax, error], function}}

{{indexsee "use strict", "strict mode"}}

JavaScript can be made a _little_ stricter by enabling _strict
mode_. This is done by putting the string `"use strict"` at the top of
a file or a function body. Here's an example:

```{test: "error \"ReferenceError: counter is not defined\""}
function canYouSpotTheProblem() {
  "use strict";
  for (counter = 0; counter < 10; counter++) {
    console.log("Happy happy");
  }
}

canYouSpotTheProblem();
// → ReferenceError: counter is not defined
```

{{index "let keyword", [binding, global]}}

Normally, when you forget to put `let` in front of your binding, as
with `counter` in the example, JavaScript quietly creates a global
binding and uses that. In strict mode, an ((error)) is reported
instead. This is very helpful. It should be noted, though, that this
doesn't work when the binding in question already exists as a global
binding. In that case, the loop will still quietly overwrite the value
of the binding.

{{index "this binding", "global object", undefined, "strict mode"}}

Another change in strict mode is that the `this` binding holds the
value `undefined` in functions that are not called as ((method))s.
When making such a call outside of strict mode, `this` refers to the
global scope object, which is an object whose properties are the
global bindings. So if you accidentally call a method or constructor
incorrectly in strict mode, JavaScript will produce an error as soon
as it tries to read something from `this`, rather than happily writing
to the global scope.

For example, consider the following code, which calls a
((constructor)) function without the `new` keyword so that its `this`
will _not_ refer to a newly constructed object:

```
function Person(name) { this.name = name; }
let ferdinand = Person("Ferdinand"); // oops
console.log(name);
// → Ferdinand
```

{{index error}}

So the bogus call to `Person` succeeded but returned an undefined
value and created the global binding `name`. In strict mode, the
result is different.

```{test: "error \"TypeError: Cannot set property 'name' of undefined\""}
"use strict";
function Person(name) { this.name = name; }
let ferdinand = Person("Ferdinand"); // forgot new
// → TypeError: Cannot set property 'name' of undefined
```

We are immediately told that something is wrong. This is helpful.

Fortunately, constructors created with the `class` notation will
always complain if they are called without `new`, making this less of
a problem even in non-strict mode.

{{index parameter, [binding, naming], "with statement"}}

Strict mode does a few more things. It disallows giving a function
multiple parameters with the same name and removes certain problematic
language features entirely (such as the `with` statement, which is so
wrong it is not further discussed in this book).

{{index debugging}}

In short, putting `"use strict"` at the top of your program rarely
hurts and might help you spot a problem.

## Types

Some languages want to know the types of all your bindings and
expressions before even running a program. They will tell you right
away when a type is used in an inconsistent way. JavaScript considers
types only when actually running the program, and even there often
tries to implicitly convert values to the type it expects, so it's not
much help.

Still, types provide a useful framework for talking about programs. A
lot of mistakes come from being confused about the kind of value that
goes into or comes out of a function. If you have that information
written down, you're less likely to get confused.

You could add a comment like the following before the `goalOrientedRobot`
function from the previous chapter to describe its type:

```
// (VillageState, Array) → {direction: string, memory: Array}
function goalOrientedRobot(state, memory) {
  // ...
}
```

There are a number of different conventions for annotating JavaScript
programs with types.

One thing about types is that they need to introduce their own
complexity to be able to describe enough code to be useful. What do
you think would be the type of the `randomPick` function that returns
a random element from an array? You'd need to introduce a _((type
variable))_, _T_, which can stand in for any type, so that you can
give `randomPick` a type like `([T]) → T` (function from an array of
*T*s to a *T*).

{{index "type checking", TypeScript}}

{{id typing}}

When the types of a program are known, it is possible for the computer
to _check_ them for you, pointing out mistakes before the program is
run. There are several JavaScript dialects that add types to the
language and check them. The most popular one is called
[TypeScript](https://www.typescriptlang.org/). If you are interested
in adding more rigor to your programs, I recommend you give it a try.

In this book, we'll continue using raw, dangerous, untyped JavaScript
code.

## Testing

{{index "test suite", "run-time error", automation, testing}}

If the language is not going to do much to help us find mistakes,
we'll have to find them the hard way: by running the program and
seeing whether it does the right thing.

Doing this by hand, again and again, is a really bad idea. Not only is
it annoying, it also tends to be ineffective since it takes too much
time to exhaustively test everything every time you make a change.

Computers are good at repetitive tasks, and testing is the ideal
repetitive task. Automated testing is the process of writing a program
that tests another program. Writing tests is a bit more work than
testing manually, but once you've done it, you gain a kind of
superpower: it takes you only a few seconds to verify that your
program still behaves properly in all the situations you wrote tests
for. When you break something, you'll immediately notice, rather than
randomly running into it at some later time.

{{index "toUpperCase method"}}

Tests usually take the form of little labeled programs that verify
some aspect of your code. For example, a set of tests for the
(standard, probably already tested by someone else) `toUpperCase`
method might look like this:

```
function test(label, body) {
  if (!body()) console.log(`Failed: ${label}`);
}

test("convert Latin text to uppercase", () => {
  return "hello".toUpperCase() == "HELLO";
});
test("convert Greek text to uppercase", () => {
  return "Χαίρετε".toUpperCase() == "ΧΑΊΡΕΤΕ";
});
test("don't convert case-less characters", () => {
  return "مرحبا".toUpperCase() == "مرحبا";
});
```

{{index "domain-specific language"}}

Writing tests like this tends to produce rather repetitive, awkward
code. Fortunately, there exist pieces of software that help you build
and run collections of tests (_((test suites))_) by providing a
language (in the form of functions and methods) suited to expressing
tests and by outputting informative information when a test fails.
These are usually called _((test runners))_.

{{index "persistent data structure"}}

Some code is easier to test than other code. Generally, the more
external objects that the code interacts with, the harder it is to set
up the context in which to test it. The style of programming shown in
the [previous chapter](robot), which uses self-contained persistent
values rather than changing objects, tends to be easy to test.

## Debugging

{{index debugging}}

Once you notice there is something wrong with your program
because it misbehaves or produces errors, the next step is to figure
out _what_ the problem is.

Sometimes it is obvious. The ((error)) message will point at a
specific line of your program, and if you look at the error
description and that line of code, you can often see the problem.

{{index "run-time error"}}

But not always. Sometimes the line that triggered the problem is
simply the first place where a flaky value produced elsewhere gets
used in an invalid way. If you have been solving the ((exercises)) in
earlier chapters, you will probably have already experienced such
situations.

{{index "decimal number", "binary number"}}

The following example program tries to convert a whole number to a
string in a given base (decimal, binary, and so on) by repeatedly
picking out the last ((digit)) and then dividing the number to get rid
of this digit. But the strange output that it currently produces
suggests that it has a ((bug)).

```
function numberToString(n, base = 10) {
  let result = "", sign = "";
  if (n < 0) {
    sign = "-";
    n = -n;
  }
  do {
    result = String(n % base) + result;
    n /= base;
  } while (n > 0);
  return sign + result;
}
console.log(numberToString(13, 10));
// → 1.5e-3231.3e-3221.3e-3211.3e-3201.3e-3191.3e-3181.3…
```

{{index analysis}}

Even if you see the problem already, pretend for a moment that you
don't. We know that our program is malfunctioning, and we want to find
out why.

{{index "trial and error"}}

This is where you must resist the urge to start making random changes
to the code to see whether that makes it better. Instead, _think_. Analyze
what is happening and come up with a ((theory)) of why it might be
happening. Then, make additional observations to test this theory—or,
if you don't yet have a theory, make additional observations to help
you come up with one.

{{index "console.log", output, debugging, logging}}

Putting a few strategic `console.log` calls into the program is a good
way to get additional information about what the program is doing. In
this case, we want `n` to take the values `13`, `1`, and then `0`.
Let's write out its value at the start of the loop.

```{lang: null}
13
1.3
0.13
0.013
…
1.5e-323
```

{{index rounding}}

_Right_. Dividing 13 by 10 does not produce a whole number. Instead of
`n /= base`, what we actually want is `n = Math.floor(n / base)` so
that the number is properly "shifted" to the right.

{{index "JavaScript console", "debugger statement"}}

An alternative to using `console.log` to peek into the program's
behavior is to use the _debugger_ capabilities of your browser.
Browsers come with the ability to set a _((breakpoint))_ on a specific
line of your code. When the execution of the program reaches a line
with a breakpoint, it is paused, and you can inspect the values of
bindings at that point. I won't go into details, as debuggers differ
from browser to browser, but look in your browser's ((developer
tools)) or search the Web for more information.

Another way to set a breakpoint is to include a `debugger` statement
(consisting of simply that keyword) in your program. If the
((developer tools)) of your browser are active, the program will pause
whenever it reaches such a statement.

## Error propagation

{{index input, output, "run-time error", error, validation}}

Not all problems can be prevented by the programmer, unfortunately. If
your program communicates with the outside world in any way, it is
possible to get malformed input, to become overloaded with work, or to
have the network fail.

{{index "error recovery"}}

If you're programming only for yourself, you can afford to just ignore
such problems until they occur. But if you build something that is
going to be used by anybody else, you usually want the program to do
better than just crash. Sometimes the right thing to do is take the
bad input in stride and continue running. In other cases, it is better
to report to the user what went wrong and then give up. But in either
situation, the program has to actively do something in response to the
problem.

{{index "promptNumber function", validation}}

Say you have a function `promptNumber` that asks the user for a number
and returns it. What should it return if the user inputs "orange"?

{{index null, undefined, "return value", "special return value"}}

One option is to make it return a special value. Common choices for
such values are `null`, `undefined`, or -1.

```{test: no}
function promptNumber(question) {
  let result = Number(prompt(question));
  if (Number.isNaN(result)) return null;
  else return result;
}

console.log(promptNumber("How many trees do you see?"));
```

Now any code that calls `promptNumber` must check whether an actual
number was read and, failing that, must somehow recover—maybe by
asking again or by filling in a default value. Or it could again
return a special value to _its_ caller to indicate that it failed to
do what it was asked.

{{index "error handling"}}

In many situations, mostly when ((error))s are common and the caller
should be explicitly taking them into account, returning a special
value is a good way to indicate an error. It does, however, have its
downsides. First, what if the function can already return every
possible kind of value? In such a function, you'll have to do
something like wrap the result in an object to be able to distinguish
success from failure.

```
function lastElement(array) {
  if (array.length == 0) {
    return {failed: true};
  } else {
    return {element: array[array.length - 1]};
  }
}
```

{{index "special return value", readability}}

The second issue with returning special values is that it can lead to
awkward code. If a piece of code calls `promptNumber` 10 times,
it has to check 10 times whether `null` was returned. And if its
response to finding `null` is to simply return `null` itself, callers
of the function will in turn have to check for it, and so on.

## Exceptions

{{index "error handling"}}

When a function cannot proceed normally, what we would _like_ to do is
just stop what we are doing and immediately jump to a place that knows
how to handle the problem. This is what _((exception handling))_ does.

{{index ["control flow", exceptions], "raising (exception)", "throw keyword", "call stack"}}

Exceptions are a mechanism that makes it possible for code that runs
into a problem to _raise_ (or _throw_) an exception. An exception can
be any value. Raising one somewhat resembles a super-charged return
from a function: it jumps out of not just the current function but
also its callers, all the way down to the first call that
started the current execution. This is called _((unwinding the
stack))_. You may remember the stack of function calls that was
mentioned in [Chapter ?](functions#stack). An exception zooms down
this stack, throwing away all the call contexts it encounters.

{{index "error handling", [syntax, statement], "catch keyword"}}

If exceptions always zoomed right down to the bottom of the stack,
they would not be of much use. They'd just provide a novel way to blow
up your program. Their power lies in the fact that you can set
"obstacles" along the stack to _catch_ the exception as it is zooming
down. Once you've caught an exception, you can do something with it to
address the problem and then continue to run the program.

Here's an example:

{{id look}}
```
function promptDirection(question) {
  let result = prompt(question);
  if (result.toLowerCase() == "left") return "L";
  if (result.toLowerCase() == "right") return "R";
  throw new Error("Invalid direction: " + result);
}

function look() {
  if (promptDirection("Which way?") == "L") {
    return "a house";
  } else {
    return "two angry bears";
  }
}

try {
  console.log("You see", look());
} catch (error) {
  console.log("Something went wrong: " + error);
}
```

{{index "exception handling", block, "throw keyword", "try keyword", "catch keyword"}}

The `throw` keyword is used to raise an exception. Catching one is
done by wrapping a piece of code in a `try` block, followed by the
keyword `catch`. When the code in the `try` block causes an exception
to be raised, the `catch` block is evaluated, with the name in
parentheses bound to the exception value. After the `catch` block
finishes—or if the `try` block finishes without problems—the program
proceeds beneath the entire `try/catch` statement.

{{index debugging, "call stack", "Error type"}}

In this case, we used the `Error` ((constructor)) to create our
exception value. This is a ((standard)) JavaScript constructor that
creates an object with a `message` property. In most JavaScript
environments, instances of this constructor also gather information
about the call stack that existed when the exception was created, a
so-called _((stack trace))_. This information is stored in the `stack`
property and can be helpful when trying to debug a problem: it tells
us the function where the problem occurred and which functions made
the failing call.

{{index "exception handling"}}

Note that the `look` function completely ignores the possibility that
`promptDirection` might go wrong. This is the big advantage of
exceptions: error-handling code is necessary only at the point where
the error occurs and at the point where it is handled. The functions
in between can forget all about it.

Well, almost...

## Cleaning up after exceptions

{{index "exception handling", "cleaning up", ["control flow", exceptions]}}

The effect of an exception is another kind of control flow. Every
action that might cause an exception, which is pretty much every
function call and property access, might cause control to suddenly
leave your code.

This means when code has several side effects, even if its
"regular" control flow looks like they'll always all happen, an
exception might prevent some of them from taking place.

{{index "banking example"}}

Here is some really bad banking code.

```{includeCode: true}
const accounts = {
  a: 100,
  b: 0,
  c: 20
};

function getAccount() {
  let accountName = prompt("Enter an account name");
  if (!accounts.hasOwnProperty(accountName)) {
    throw new Error(`No such account: ${accountName}`);
  }
  return accountName;
}

function transfer(from, amount) {
  if (accounts[from] < amount) return;
  accounts[from] -= amount;
  accounts[getAccount()] += amount;
}
```

The `transfer` function transfers a sum of money from a given account
to another, asking for the name of the other account in the process.
If given an invalid account name, `getAccount` throws an exception.

But `transfer` _first_ removes the money from the account and _then_
calls `getAccount` before it adds it to another account. If it is
broken off by an exception at that point, it'll just make the money
disappear.

That code could have been written a little more intelligently, for
example by calling `getAccount` before it starts moving money around.
But often problems like this occur in more subtle ways. Even functions
that don't look like they will throw an exception might do so in
exceptional circumstances or when they contain a programmer mistake.

One way to address this is to use fewer side effects. Again, a
programming style that computes new values instead of changing
existing data helps. If a piece of code stops running in the middle of
creating a new value, no one ever sees the half-finished value, and
there is no problem.

{{index block, "try keyword", "finally keyword"}}

But that isn't always practical. So there is another feature that
`try` statements have. They may be followed by a `finally` block
either instead of or in addition to a `catch` block. A `finally` block
says "no matter _what_ happens, run this code after trying to run the
code in the `try` block."

```{includeCode: true}
function transfer(from, amount) {
  if (accounts[from] < amount) return;
  let progress = 0;
  try {
    accounts[from] -= amount;
    progress = 1;
    accounts[getAccount()] += amount;
    progress = 2;
  } finally {
    if (progress == 1) {
      accounts[from] += amount;
    }
  }
}
```

This version of the function tracks its progress, and if, when
leaving, it notices that it was aborted at a point where it had
created an inconsistent program state, it repairs the damage it did.

Note that even though the `finally` code is run when an exception
is thrown in the `try` block, it does not interfere with the exception.
After the `finally` block runs, the stack continues unwinding.

{{index "exception safety"}}

Writing programs that operate reliably even when exceptions pop up in
unexpected places is hard. Many people simply don't bother, and
because exceptions are typically reserved for exceptional
circumstances, the problem may occur so rarely that it is never even
noticed. Whether that is a good thing or a really bad thing depends on
how much damage the software will do when it fails.

## Selective catching

{{index "uncaught exception", "exception handling", "JavaScript console", "developer tools", "call stack", error}}

When an exception makes it all the way to the bottom of the stack
without being caught, it gets handled by the environment. What this
means differs between environments. In browsers, a description of the
error typically gets written to the JavaScript console (reachable
through the browser's Tools or Developer menu). Node.js, the
browserless JavaScript environment we will discuss in [Chapter
?](node), is more careful about data corruption. It aborts the whole
process when an unhandled exception occurs.

{{index crash, "error handling"}}

For programmer mistakes, just letting the error go through is often
the best you can do. An unhandled exception is a reasonable way to
signal a broken program, and the JavaScript console will, on modern
browsers, provide you with some information about which function calls
were on the stack when the problem occurred.

{{index "user interface"}}

For problems that are _expected_ to happen during routine use,
crashing with an unhandled exception is a terrible strategy.

{{index [function, application], "exception handling", "Error type", [binding, undefined]}}

Invalid uses of the language, such as referencing a nonexistent
binding, looking up a property on `null`, or calling something
that's not a function, will also result in exceptions being raised.
Such exceptions can also be caught.

{{index "catch keyword"}}

When a `catch` body is entered, all we know is that _something_ in our
`try` body caused an exception. But we don't know _what_ did or _which_
exception it caused.

{{index "exception handling"}}

JavaScript (in a rather glaring omission) doesn't provide direct
support for selectively catching exceptions: either you catch them all
or you don't catch any. This makes it tempting to _assume_ that the
exception you get is the one you were thinking about when you wrote
the `catch` block.

{{index "promptDirection function"}}

But it might not be. Some other ((assumption)) might be violated, or
you might have introduced a bug that is causing an exception. Here is
an example that _attempts_ to keep on calling `promptDirection`
until it gets a valid answer:

```{test: no}
for (;;) {
  try {
    let dir = promtDirection("Where?"); // ← typo!
    console.log("You chose ", dir);
    break;
  } catch (e) {
    console.log("Not a valid direction. Try again.");
  }
}
```

{{index "infinite loop", "for loop", "catch keyword", debugging}}

The `for (;;)` construct is a way to intentionally create a loop that
doesn't terminate on its own. We break out of the loop only when a
valid direction is given. _But_ we misspelled `promptDirection`, which
will result in an "undefined variable" error. Because the `catch`
block completely ignores its exception value (`e`), assuming it knows
what the problem is, it wrongly treats the binding error as indicating
bad input. Not only does this cause an infinite loop, it 
"buries" the useful error message about the misspelled binding.

As a general rule, don't blanket-catch exceptions unless it is for the
purpose of "routing" them somewhere—for example, over the network to
tell another system that our program crashed. And even then, think
carefully about how you might be hiding information.

{{index "exception handling"}}

So we want to catch a _specific_ kind of exception. We can do this by
checking in the `catch` block whether the exception we got is the one
we are interested in and rethrowing it otherwise. But how do we
recognize an exception?

We could compare its `message` property against the ((error)) message
we happen to expect. But that's a shaky way to write code—we'd be
using information that's intended for human consumption (the message)
to make a programmatic decision. As soon as someone changes (or
translates) the message, the code will stop working.

{{index "Error type", "instanceof operator", "promptDirection function"}}

Rather, let's define a new type of error and use `instanceof` to
identify it.

```{includeCode: true}
class InputError extends Error {}

function promptDirection(question) {
  let result = prompt(question);
  if (result.toLowerCase() == "left") return "L";
  if (result.toLowerCase() == "right") return "R";
  throw new InputError("Invalid direction: " + result);
}
```

{{index "throw keyword", inheritance}}

The new error class extends `Error`. It doesn't define its own
constructor, which means that it inherits the `Error` constructor,
which expects a string message as argument. In fact, it doesn't define
anything at all—the class is empty. `InputError` objects behave like
`Error` objects, except that they have a different class by which we
can recognize them.

{{index "exception handling"}}

Now the loop can catch these more carefully.

```{test: no}
for (;;) {
  try {
    let dir = promptDirection("Where?");
    console.log("You chose ", dir);
    break;
  } catch (e) {
    if (e instanceof InputError) {
      console.log("Not a valid direction. Try again.");
    } else {
      throw e;
    }
  }
}
```

{{index debugging}}

This will catch only instances of `InputError` and let unrelated
exceptions through. If you reintroduce the typo, the undefined binding
error will be properly reported.

## Assertions

{{index "assert function", assertion, debugging}}

_Assertions_ are checks inside a program that verify that something is
the way it is supposed to be. They are used not to handle situations
that can come up in normal operation but to find programmer mistakes.

If, for example, `firstElement` is described as a function that should
never be called on empty arrays, we might write it like this:

```
function firstElement(array) {
  if (array.length == 0) {
    throw new Error("firstElement called with []");
  }
  return array[0];
}
```

{{index validation, "run-time error", crash, assumption}}

Now, instead of silently returning undefined (which you get when
reading an array property that does not exist), this will loudly blow
up your program as soon as you misuse it. This makes it less likely
for such mistakes to go unnoticed and easier to find their cause when
they occur.

I do not recommend trying to write assertions for every possible kind
of bad input. That'd be a lot of work and would lead to very noisy
code. You'll want to reserve them for mistakes that are easy to make
(or that you find yourself making).

## Summary

Mistakes and bad input are facts of life. An important part of
programming is finding, diagnosing, and fixing bugs. Problems can
become easier to notice if you have an automated test suite or add
assertions to your programs.

Problems caused by factors outside the program's control should
usually be handled gracefully. Sometimes, when the problem can be
handled locally, special return values are a good way to track them.
Otherwise, exceptions may be preferable.

Throwing an exception causes the call stack to be unwound until the
next enclosing `try/catch` block or until the bottom of the stack. The
exception value will be given to the `catch` block that catches it,
which should verify that it is actually the expected kind of exception
and then do something with it. To help address the unpredictable
control flow caused by exceptions, `finally` blocks can be used to
ensure that a piece of code _always_ runs when a block finishes.

## Exercises

### Retry

{{index "primitiveMultiply (exercise)", "exception handling", "throw keyword"}}

Say you have a function `primitiveMultiply` that in 20 percent of
cases multiplies two numbers and in the other 80 percent of cases raises an
exception of type `MultiplicatorUnitFailure`. Write a function that
wraps this clunky function and just keeps trying until a call
succeeds, after which it returns the result.

{{index "catch keyword"}}

Make sure you handle only the exceptions you are trying to handle.

{{if interactive

```{test: no}
class MultiplicatorUnitFailure extends Error {}

function primitiveMultiply(a, b) {
  if (Math.random() < 0.2) {
    return a * b;
  } else {
    throw new MultiplicatorUnitFailure("Klunk");
  }
}

function reliableMultiply(a, b) {
  // Your code here.
}

console.log(reliableMultiply(8, 8));
// → 64
```
if}}

{{hint

{{index "primitiveMultiply (exercise)", "try keyword", "catch keyword", "throw keyword"}}

The call to `primitiveMultiply` should definitely happen in a `try`
block. The corresponding `catch` block should rethrow the exception
when it is not an instance of `MultiplicatorUnitFailure` and ensure
the call is retried when it is.

To do the retrying, you can either use a loop that stops only when a
call succeeds—as in the [`look` example](error#look) earlier in this
chapter—or use ((recursion)) and hope you don't get a string of
failures so long that it overflows the stack (which is a pretty safe
bet).

hint}}

### The locked box

{{index "locked box (exercise)"}}

Consider the following (rather contrived) object:

```
const box = {
  locked: true,
  unlock() { this.locked = false; },
  lock() { this.locked = true;  },
  _content: [],
  get content() {
    if (this.locked) throw new Error("Locked!");
    return this._content;
  }
};
```

{{index "private property", "access control"}}

It is a ((box)) with a lock. There is an array in the box, but you can
get at it only when the box is unlocked. Directly accessing the
private `_content` property is forbidden.

{{index "finally keyword", "exception handling"}}

Write a function called `withBoxUnlocked` that takes a function value
as argument, unlocks the box, runs the function, and then ensures that
the box is locked again before returning, regardless of whether the
argument function returned normally or threw an exception.

{{if interactive

```
const box = {
  locked: true,
  unlock() { this.locked = false; },
  lock() { this.locked = true;  },
  _content: [],
  get content() {
    if (this.locked) throw new Error("Locked!");
    return this._content;
  }
};

function withBoxUnlocked(body) {
  // Your code here.
}

withBoxUnlocked(function() {
  box.content.push("gold piece");
});

try {
  withBoxUnlocked(function() {
    throw new Error("Pirates on the horizon! Abort!");
  });
} catch (e) {
  console.log("Error raised: " + e);
}
console.log(box.locked);
// → true
```

if}}

For extra points, make sure that if you call `withBoxUnlocked` when
the box is already unlocked, the box stays unlocked.

{{hint

{{index "locked box (exercise)", "finally keyword", "try keyword"}}

This exercise calls for a `finally` block. Your function should first
unlock the box and then call the argument function from inside a `try`
body. The `finally` block after it should lock the box again.

To make sure we don't lock the box when it wasn't already locked,
check its lock at the start of the function and unlock and lock
it only when it started out locked.

hint}}
# Regular Expressions

{{quote {author: "Jamie Zawinski", chapter: true}

Some people, when confronted with a problem, think 'I know, I'll use
regular expressions.' Now they have two problems.

quote}}

{{index "Zawinski, Jamie"}}

{{if interactive

{{quote {author: "Master Yuan-Ma", title: "The Book of Programming", chapter: true}

Yuan-Ma said, 'When you cut against the grain of the wood, much
strength is needed. When you program against the grain of the problem,
much code is needed.'

quote}}

if}}

{{figure {url: "img/chapter_picture_9.jpg", alt: "A railroad diagram", chapter: "square-framed"}}}

{{index evolution, adoption, integration}}

Programming ((tool))s and techniques survive and spread in a chaotic,
evolutionary way. It's not always the pretty or brilliant ones that
win but rather the ones that function well enough within the right
niche or that happen to be integrated with another successful piece of
technology.

{{index "domain-specific language"}}

In this chapter, I will discuss one such tool, _((regular
expression))s_. Regular expressions are a way to describe ((pattern))s
in string data. They form a small, separate language that is part of
JavaScript and many other languages and systems.

{{index [interface, design]}}

Regular expressions are both terribly awkward and extremely useful.
Their syntax is cryptic, and the programming interface JavaScript
provides for them is clumsy. But they are a powerful ((tool)) for
inspecting and processing strings. Properly understanding regular
expressions will make you a more effective programmer.

## Creating a regular expression

{{index ["regular expression", creation], "RegExp class", "literal expression", "slash character"}}

A regular expression is a type of object. It can be either constructed
with the `RegExp` constructor or written as a literal value by
enclosing a pattern in forward slash (`/`) characters.

```
let re1 = new RegExp("abc");
let re2 = /abc/;
```

Both of those regular expression objects represent the same
((pattern)): an _a_ character followed by a _b_ followed by a _c_.

{{index ["backslash character", "in regular expressions"], "RegExp class"}}

When using the `RegExp` constructor, the pattern is written as a
normal string, so the usual rules apply for backslashes.

{{index ["regular expression", escaping], [escaping, "in regexps"], "slash character"}}

The second notation, where the pattern appears between slash
characters, treats backslashes somewhat differently. First, since a
forward slash ends the pattern, we need to put a backslash before any
forward slash that we want to be _part_ of the pattern. In addition,
backslashes that aren't part of special character codes (like `\n`)
will be _preserved_, rather than ignored as they are in strings, and
change the meaning of the pattern. Some characters, such as question
marks and plus signs, have special meanings in regular expressions and
must be preceded by a backslash if they are meant to represent the
character itself.

```
let eighteenPlus = /eighteen\+/;
```

## Testing for matches

{{index matching, "test method", ["regular expression", methods]}}

Regular expression objects have a number of methods. The simplest one
is `test`. If you pass it a string, it will return a ((Boolean))
telling you whether the string contains a match of the pattern in the
expression.

```
console.log(/abc/.test("abcde"));
// → true
console.log(/abc/.test("abxde"));
// → false
```

{{index pattern}}

A ((regular expression)) consisting of only nonspecial characters
simply represents that sequence of characters. If _abc_ occurs
anywhere in the string we are testing against (not just at the start),
`test` will return `true`.

## Sets of characters

{{index "regular expression", "indexOf method"}}

Finding out whether a string contains _abc_ could just as well be done
with a call to `indexOf`. Regular expressions allow us to express more
complicated ((pattern))s.

Say we want to match any ((number)). In a regular expression, putting
a ((set)) of characters between square brackets makes that part of the
expression match any of the characters between the brackets.

Both of the following expressions match all strings that contain a ((digit)):

```
console.log(/[0123456789]/.test("in 1992"));
// → true
console.log(/[0-9]/.test("in 1992"));
// → true
```

{{index "hyphen character"}}

Within square brackets, a hyphen (`-`) between two characters can be
used to indicate a ((range)) of characters, where the ordering is
determined by the character's ((Unicode)) number. Characters 0 to 9
sit right next to each other in this ordering (codes 48 to 57), so
`[0-9]` covers all of them and matches any ((digit)).

{{index [whitespace, matching], "alphanumeric character", "period character"}}

A number of common character groups have their own
built-in shortcuts. Digits are one of them: `\d` means the same thing
as `[0-9]`.

{{index "newline character", [whitespace, matching]}}

{{table {cols: [1, 5]}}}

| `\d`    | Any ((digit)) character
| `\w`    | An alphanumeric character ("((word character))")
| `\s`    | Any whitespace character (space, tab, newline, and similar)
| `\D`    | A character that is _not_ a digit
| `\W`    | A nonalphanumeric character
| `\S`    | A nonwhitespace character
| `.`     | Any character except for newline

So you could match a ((date)) and ((time)) format like 01-30-2003
15:20 with the following expression:

```
let dateTime = /\d\d-\d\d-\d\d\d\d \d\d:\d\d/;
console.log(dateTime.test("01-30-2003 15:20"));
// → true
console.log(dateTime.test("30-jan-2003 15:20"));
// → false
```

{{index ["backslash character", "in regular expressions"]}}

That looks completely awful, doesn't it? Half of it is backslashes,
producing a background noise that makes it hard to spot the actual
((pattern)) expressed. We'll see a slightly improved version of this
expression [later](regexp#date_regexp_counted).

{{index [escaping, "in regexps"], "regular expression", set}}

These backslash codes can also be used inside ((square brackets)). For
example, `[\d.]` means any digit or a period character. But the period
itself, between square brackets, loses its special meaning. The same
goes for other special characters, such as `+`.

{{index "square brackets", inversion, "caret character"}}

To _invert_ a set of characters—that is, to express that you want to
match any character _except_ the ones in the set—you can write a caret
(`^`) character after the opening bracket.

```
let notBinary = /[^01]/;
console.log(notBinary.test("1100100010100110"));
// → false
console.log(notBinary.test("1100100010200110"));
// → true
```

## Repeating parts of a pattern

{{index ["regular expression", repetition]}}

We now know how to match a single digit. What if we want to match a
whole number—a ((sequence)) of one or more ((digit))s?

{{index "plus character", repetition, "+ operator"}}

When you put a plus sign (`+`) after something in a regular
expression, it indicates that the element may be repeated more than
once. Thus, `/\d+/` matches one or more digit characters.

```
console.log(/'\d+'/.test("'123'"));
// → true
console.log(/'\d+'/.test("''"));
// → false
console.log(/'\d*'/.test("'123'"));
// → true
console.log(/'\d*'/.test("''"));
// → true
```

{{index "* operator", asterisk}}

The star (`*`) has a similar meaning but also allows the pattern to
match zero times. Something with a star after it never prevents a
pattern from matching—it'll just match zero instances if it can't find
any suitable text to match.

{{index "British English", "American English", "question mark"}}

A question mark makes a part of a pattern _((optional))_, meaning it
may occur zero times or one time. In the following example, the _u_
character is allowed to occur, but the pattern also matches when it is
missing.

```
let neighbor = /neighbou?r/;
console.log(neighbor.test("neighbour"));
// → true
console.log(neighbor.test("neighbor"));
// → true
```

{{index repetition, [braces, "in regular expression"]}}

To indicate that a pattern should occur a precise number of times, use
braces. Putting `{4}` after an element, for example, requires it
to occur exactly four times. It is also possible to specify a
((range)) this way: `{2,4}` means the element must occur at least
twice and at most four times.

{{id date_regexp_counted}}

Here is another version of the ((date)) and ((time)) pattern that
allows both single- and double-((digit)) days, months, and hours. It
is also slightly easier to decipher.

```
let dateTime = /\d{1,2}-\d{1,2}-\d{4} \d{1,2}:\d{2}/;
console.log(dateTime.test("1-30-2003 8:45"));
// → true
```

You can also specify open-ended ((range))s when using braces
by omitting the number after the comma. So, `{5,}` means five or more
times.

## Grouping subexpressions

{{index ["regular expression", grouping], grouping, [parentheses, "in regular expressions"]}}

To use an operator like `*` or `+` on more than one element at a time,
you have to use parentheses. A part of a regular expression that
is enclosed in parentheses counts as a single element as far as the
operators following it are concerned.

```
let cartoonCrying = /boo+(hoo+)+/i;
console.log(cartoonCrying.test("Boohoooohoohooo"));
// → true
```

{{index crying}}

The first and second `+` characters apply only to the second _o_ in
_boo_ and _hoo_, respectively. The third `+` applies to the whole
group `(hoo+)`, matching one or more sequences like that.

{{index "case sensitivity", capitalization, ["regular expression", flags]}}

The `i` at the end of the expression in the example makes this regular
expression case insensitive, allowing it to match the uppercase _B_ in
the input string, even though the pattern is itself all lowercase.

## Matches and groups

{{index ["regular expression", grouping], "exec method", [array, "RegExp match"]}}

The `test` method is the absolute simplest way to match a regular
expression. It tells you only whether it matched and nothing else.
Regular expressions also have an `exec` (execute) method that will
return `null` if no match was found and return an object with
information about the match otherwise.

```
let match = /\d+/.exec("one two 100");
console.log(match);
// → ["100"]
console.log(match.index);
// → 8
```

{{index "index property", [string, indexing]}}

An object returned from `exec` has an `index` property that tells us
_where_ in the string the successful match begins. Other than that,
the object looks like (and in fact is) an array of strings, whose
first element is the string that was matched. In the previous example,
this is the sequence of ((digit))s that we were looking for.

{{index [string, methods], "match method"}}

String values have a `match` method that behaves similarly.

```
console.log("one two 100".match(/\d+/));
// → ["100"]
```

{{index grouping, "capture group", "exec method"}}

When the regular expression contains subexpressions grouped with
parentheses, the text that matched those groups will also show up in
the array. The whole match is always the first element. The next
element is the part matched by the first group (the one whose opening
parenthesis comes first in the expression), then the second group, and
so on.

```
let quotedText = /'([^']*)'/;
console.log(quotedText.exec("she said 'hello'"));
// → ["'hello'", "hello"]
```

{{index "capture group"}}

When a group does not end up being matched at all (for example, when
followed by a question mark), its position in the output array will
hold `undefined`. Similarly, when a group is matched multiple times,
only the last match ends up in the array.

```
console.log(/bad(ly)?/.exec("bad"));
// → ["bad", undefined]
console.log(/(\d)+/.exec("123"));
// → ["123", "3"]
```

{{index "exec method", ["regular expression", methods], extraction}}

Groups can be useful for extracting parts of a string. If we don't
just want to verify whether a string contains a ((date)) but also
extract it and construct an object that represents it, we can wrap
parentheses around the digit patterns and directly pick the date out
of the result of `exec`.

But first we'll take a brief detour, in which we discuss the built-in way to
represent date and ((time)) values in JavaScript.

## The Date class

{{index constructor, "Date class"}}

JavaScript has a standard class for representing ((date))s—or, rather,
points in ((time)). It is called `Date`. If you simply create a date
object using `new`, you get the current date and time.

```{test: no}
console.log(new Date());
// → Mon Nov 13 2017 16:19:11 GMT+0100 (CET)
```

{{index "Date class"}}

You can also create an object for a specific time.

```
console.log(new Date(2009, 11, 9));
// → Wed Dec 09 2009 00:00:00 GMT+0100 (CET)
console.log(new Date(2009, 11, 9, 12, 59, 59, 999));
// → Wed Dec 09 2009 12:59:59 GMT+0100 (CET)
```

{{index "zero-based counting", [interface, design]}}

JavaScript uses a convention where month numbers start at zero (so
December is 11), yet day numbers start at one. This is confusing and
silly. Be careful.

The last four arguments (hours, minutes, seconds, and milliseconds)
are optional and taken to be zero when not given.

{{index "getTime method"}}

Timestamps are stored as the number of milliseconds since the start of
1970, in the UTC ((time zone)). This follows a convention set by
"((Unix time))", which was invented around that time. You can use
negative numbers for times before 1970. The `getTime` method on a date
object returns this number. It is big, as you can imagine.

```
console.log(new Date(2013, 11, 19).getTime());
// → 1387407600000
console.log(new Date(1387407600000));
// → Thu Dec 19 2013 00:00:00 GMT+0100 (CET)
```

{{index "Date.now function", "Date class"}}

If you give the `Date` constructor a single argument, that argument is
treated as such a millisecond count. You can get the current
millisecond count by creating a new `Date` object and calling
`getTime` on it or by calling the `Date.now` function.

{{index "getFullYear method", "getMonth method", "getDate method", "getHours method", "getMinutes method", "getSeconds method", "getYear method"}}

Date objects provide methods such as `getFullYear`, `getMonth`,
`getDate`, `getHours`, `getMinutes`, and `getSeconds` to extract their
components. Besides `getFullYear` there's also `getYear`, which gives
you the year minus 1900 (`98` or `119`) and is mostly useless.

{{index "capture group", "getDate method", [parentheses, "in regular expressions"]}}

Putting parentheses around the parts of the expression that we are
interested in, we can now create a date object from a string.

```
function getDate(string) {
  let [_, month, day, year] =
    /(\d{1,2})-(\d{1,2})-(\d{4})/.exec(string);
  return new Date(year, month - 1, day);
}
console.log(getDate("1-30-2003"));
// → Thu Jan 30 2003 00:00:00 GMT+0100 (CET)
```

{{index destructuring, "underscore character"}}

The `_` (underscore) binding is ignored and used only to skip the
full match element in the array returned by `exec`.

## Word and string boundaries

{{index matching, ["regular expression", boundary]}}

Unfortunately, `getDate` will also happily extract the nonsensical
date 00-1-3000 from the string `"100-1-30000"`. A match may happen
anywhere in the string, so in this case, it'll just start at the
second character and end at the second-to-last character.

{{index boundary, "caret character", "dollar sign"}}

If we want to enforce that the match must span the whole string, we
can add the markers `^` and `$`. The caret matches the start of the
input string, whereas the dollar sign matches the end. So, `/^\d+$/`
matches a string consisting entirely of one or more digits, `/^!/`
matches any string that starts with an exclamation mark, and `/x^/`
does not match any string (there cannot be an _x_ before the start of
the string).

{{index "word boundary", "word character"}}

If, on the other hand, we just want to make sure the date starts and
ends on a word boundary, we can use the marker `\b`. A word boundary
can be the start or end of the string or any point in the string that
has a word character (as in `\w`) on one side and a nonword character
on the other.

```
console.log(/cat/.test("concatenate"));
// → true
console.log(/\bcat\b/.test("concatenate"));
// → false
```

{{index matching}}

Note that a boundary marker doesn't match an actual character. It just
enforces that the regular expression matches only when a certain
condition holds at the place where it appears in the pattern.

## Choice patterns

{{index branching, ["regular expression", alternatives], "farm example"}}

Say we want to know whether a piece of text contains not only a number
but a number followed by one of the words _pig_, _cow_, or _chicken_,
or any of their plural forms.

We could write three regular expressions and test them in turn, but
there is a nicer way. The ((pipe character)) (`|`) denotes a
((choice)) between the pattern to its left and the pattern to its
right. So I can say this:

```
let animalCount = /\b\d+ (pig|cow|chicken)s?\b/;
console.log(animalCount.test("15 pigs"));
// → true
console.log(animalCount.test("15 pigchickens"));
// → false
```

{{index [parentheses, "in regular expressions"]}}

Parentheses can be used to limit the part of the pattern that the pipe
operator applies to, and you can put multiple such operators next to
each other to express a choice between more than two alternatives.

## The mechanics of matching

{{index ["regular expression", matching], [matching, algorithm], "search problem"}}

Conceptually, when you use `exec` or `test`, the regular expression
engine looks for a match in your string by trying to match the
expression first from the start of the string, then from the second
character, and so on, until it finds a match or reaches the end of the
string. It'll either return the first match that can be found or fail
to find any match at all.

{{index ["regular expression", matching], [matching, algorithm]}}

To do the actual matching, the engine treats a regular expression
something like a ((flow diagram)). This is the diagram for the
livestock expression in the previous example:

{{figure {url: "img/re_pigchickens.svg", alt: "Visualization of /\\b\\d+ (pig|cow|chicken)s?\\b/"}}}

{{index traversal}}

Our expression matches if we can find a path from the left side of the
diagram to the right side. We keep a current position in the string,
and every time we move through a box, we verify that the part of the
string after our current position matches that box.

So if we try to match `"the 3 pigs"` from position 4, our progress
through the flow chart would look like this:

 - At position 4, there is a word ((boundary)), so we can move past
   the first box.

 - Still at position 4, we find a digit, so we can also move past the
   second box.

 - At position 5, one path loops back to before the second (digit)
   box, while the other moves forward through the box that holds a
   single space character. There is a space here, not a digit, so we
   must take the second path.

 - We are now at position 6 (the start of _pigs_) and at the three-way
   branch in the diagram. We don't see _cow_ or _chicken_ here, but we
   do see _pig_, so we take that branch.

 - At position 9, after the three-way branch, one path skips the _s_
   box and goes straight to the final word boundary, while the other
   path matches an _s_. There is an _s_ character here, not a word
   boundary, so we go through the _s_ box.

 - We're at position 10 (the end of the string) and can match only a
   word ((boundary)). The end of a string counts as a word boundary,
   so we go through the last box and have successfully matched this
   string.

{{id backtracking}}

## Backtracking

{{index ["regular expression", backtracking], "binary number", "decimal number", "hexadecimal number", "flow diagram", [matching, algorithm], backtracking}}

The regular expression `/\b([01]+b|[\da-f]+h|\d+)\b/` matches either a
binary number followed by a _b_, a hexadecimal number (that is, base
16, with the letters _a_ to _f_ standing for the digits 10 to 15)
followed by an _h_, or a regular decimal number with no suffix
character. This is the corresponding diagram:

{{figure {url: "img/re_number.svg", alt: "Visualization of /\\b([01]+b|\\d+|[\\da-f]+h)\\b/"}}}

{{index branching}}

When matching this expression, it will often happen that the top
(binary) branch is entered even though the input does not actually
contain a binary number. When matching the string `"103"`, for
example, it becomes clear only at the 3 that we are in the wrong
branch. The string _does_ match the expression, just not the branch we
are currently in.

{{index backtracking, "search problem"}}

So the matcher _backtracks_. When entering a branch, it remembers its
current position (in this case, at the start of the string, just past
the first boundary box in the diagram) so that it can go back and try
another branch if the current one does not work out. For the string
`"103"`, after encountering the 3 character, it will start trying the
branch for hexadecimal numbers, which fails again because there is no
_h_ after the number. So it tries the decimal number branch. This one
fits, and a match is reported after all.

{{index [matching, algorithm]}}

The matcher stops as soon as it finds a full match. This means that if
multiple branches could potentially match a string, only the first one
(ordered by where the branches appear in the regular expression) is
used.

Backtracking also happens for ((repetition)) operators like + and `*`.
If you match `/^.*x/` against `"abcxe"`, the `.*` part will first try
to consume the whole string. The engine will then realize that it
needs an _x_ to match the pattern. Since there is no _x_ past the end
of the string, the star operator tries to match one character less.
But the matcher doesn't find an _x_ after `abcx` either, so it
backtracks again, matching the star operator to just `abc`. _Now_ it
finds an _x_ where it needs it and reports a successful match from
positions 0 to 4.

{{index performance, complexity}}

It is possible to write regular expressions that will do a _lot_ of
backtracking. This problem occurs when a pattern can match a piece of
input in many different ways. For example, if we get confused while
writing a binary-number regular expression, we might accidentally
write something like `/([01]+)+b/`.

{{figure {url: "img/re_slow.svg", alt: "Visualization of /([01]+)+b/",width: "6cm"}}}

{{index "inner loop", [nesting, "in regexps"]}}

If that tries to match some long series of zeros and ones with no
trailing _b_ character, the matcher first goes through the inner
loop until it runs out of digits. Then it notices there is no _b_, so
it backtracks one position, goes through the outer loop once, and
gives up again, trying to backtrack out of the inner loop once more.
It will continue to try every possible route through these two loops.
This means the amount of work _doubles_ with each additional
character. For even just a few dozen characters, the resulting match
will take practically forever.

## The replace method

{{index "replace method", "regular expression"}}

String values have a `replace` method that can be used to replace
part of the string with another string.

```
console.log("papa".replace("p", "m"));
// → mapa
```

{{index ["regular expression", flags], ["regular expression", global]}}

The first argument can also be a regular expression, in which case the
first match of the regular expression is replaced. When a `g` option
(for _global_) is added to the regular expression, _all_ matches in
the string will be replaced, not just the first.

```
console.log("Borobudur".replace(/[ou]/, "a"));
// → Barobudur
console.log("Borobudur".replace(/[ou]/g, "a"));
// → Barabadar
```

{{index [interface, design], argument}}

It would have been sensible if the choice between replacing one match
or all matches was made through an additional argument to `replace` or
by providing a different method, `replaceAll`. But for some
unfortunate reason, the choice relies on a property of the regular
expression instead.

{{index grouping, "capture group", "dollar sign", "replace method", ["regular expression", grouping]}}

The real power of using regular expressions with `replace` comes from
the fact that we can refer to matched groups in the replacement
string. For example, say we have a big string containing the names of
people, one name per line, in the format `Lastname, Firstname`. If we
want to swap these names and remove the comma to get a `Firstname
Lastname` format, we can use the following code:

```
console.log(
  "Liskov, Barbara\nMcCarthy, John\nWadler, Philip"
    .replace(/(\w+), (\w+)/g, "$2 $1"));
// → Barbara Liskov
//   John McCarthy
//   Philip Wadler
```

The `$1` and `$2` in the replacement string refer to the parenthesized
groups in the pattern. `$1` is replaced by the text that matched
against the first group, `$2` by the second, and so on, up to `$9`.
The whole match can be referred to with `$&`.

{{index [function, "higher-order"], grouping, "capture group"}}

It is possible to pass a function—rather than a string—as the second
argument to `replace`. For each replacement, the function will be
called with the matched groups (as well as the whole match) as
arguments, and its return value will be inserted into the new string.

Here's a small example:

```
let s = "the cia and fbi";
console.log(s.replace(/\b(fbi|cia)\b/g,
            str => str.toUpperCase()));
// → the CIA and FBI
```

Here's a more interesting one:

```
let stock = "1 lemon, 2 cabbages, and 101 eggs";
function minusOne(match, amount, unit) {
  amount = Number(amount) - 1;
  if (amount == 1) { // only one left, remove the 's'
    unit = unit.slice(0, unit.length - 1);
  } else if (amount == 0) {
    amount = "no";
  }
  return amount + " " + unit;
}
console.log(stock.replace(/(\d+) (\w+)/g, minusOne));
// → no lemon, 1 cabbage, and 100 eggs
```

This takes a string, finds all occurrences of a number followed by an
alphanumeric word, and returns a string wherein every such occurrence
is decremented by one.

The `(\d+)` group ends up as the `amount` argument to the function,
and the `(\w+)` group gets bound to `unit`. The function converts
`amount` to a number—which always works since it matched `\d+`—and
makes some adjustments in case there is only one or zero left.

## Greed

{{index greed, "regular expression"}}

It is possible to use `replace` to write a function that removes all
((comment))s from a piece of JavaScript ((code)). Here is a first
attempt:

```{test: wrap}
function stripComments(code) {
  return code.replace(/\/\/.*|\/\*[^]*\*\//g, "");
}
console.log(stripComments("1 + /* 2 */3"));
// → 1 + 3
console.log(stripComments("x = 10;// ten!"));
// → x = 10;
console.log(stripComments("1 /* a */+/* b */ 1"));
// → 1  1
```

{{index "period character", "slash character", "newline character", "empty set", "block comment", "line comment"}}

The part before the _or_ operator matches two slash characters
followed by any number of non-newline characters. The part for
multiline comments is more involved. We use `[^]` (any character that
is not in the empty set of characters) as a way to match any
character. We cannot just use a period here because block comments can
continue on a new line, and the period character does not match
newline characters.

But the output for the last line appears to have gone wrong. Why?

{{index backtracking, greed, "regular expression"}}

The `[^]*` part of the expression, as I described in the section on
backtracking, will first match as much as it can. If that causes the
next part of the pattern to fail, the matcher moves back one character
and tries again from there. In the example, the matcher first tries to
match the whole rest of the string and then moves back from there. It
will find an occurrence of `*/` after going back four characters and
match that. This is not what we wanted—the intention was to match a
single comment, not to go all the way to the end of the code and find
the end of the last block comment.

Because of this behavior, we say the repetition operators (`+`, `*`,
`?`, and `{}`) are _((greed))y_, meaning they match as much as they
can and backtrack from there. If you put a ((question mark)) after
them (`+?`, `*?`, `??`, `{}?`), they become nongreedy and start by
matching as little as possible, matching more only when the remaining
pattern does not fit the smaller match.

And that is exactly what we want in this case. By having the star
match the smallest stretch of characters that brings us to a `*/`, we
consume one block comment and nothing more.

```{test: wrap}
function stripComments(code) {
  return code.replace(/\/\/.*|\/\*[^]*?\*\//g, "");
}
console.log(stripComments("1 /* a */+/* b */ 1"));
// → 1 + 1
```

A lot of ((bug))s in ((regular expression)) programs can be traced to
unintentionally using a greedy operator where a nongreedy one would
work better. When using a ((repetition)) operator, consider the
nongreedy variant first.

## Dynamically creating RegExp objects

{{index ["regular expression", creation], "underscore character", "RegExp class"}}

There are cases where you might not know the exact ((pattern)) you
need to match against when you are writing your code. Say you want to
look for the user's name in a piece of text and enclose it in
underscore characters to make it stand out. Since you will know the
name only once the program is actually running, you can't use the
slash-based notation.

But you can build up a string and use the `RegExp` ((constructor)) on
that. Here's an example:

```
let name = "harry";
let text = "Harry is a suspicious character.";
let regexp = new RegExp("\\b(" + name + ")\\b", "gi");
console.log(text.replace(regexp, "_$1_"));
// → _Harry_ is a suspicious character.
```

{{index ["regular expression", flags], ["backslash character", "in regular expressions"]}}

When creating the `\b` ((boundary)) markers, we have to use two
backslashes because we are writing them in a normal string, not a
slash-enclosed regular expression. The second argument to the `RegExp`
constructor contains the options for the regular expression—in this
case, `"gi"` for global and case insensitive.

But what if the name is `"dea+hl[]rd"` because our user is a ((nerd))y
teenager? That would result in a nonsensical regular expression that
won't actually match the user's name.

{{index ["backslash character", "in regular expressions"], [escaping, "in regexps"], ["regular expression", escaping]}}

To work around this, we can add backslashes before any character that
has a special meaning.

```
let name = "dea+hl[]rd";
let text = "This dea+hl[]rd guy is super annoying.";
let escaped = name.replace(/[\\[.+*?(){|^$]/g, "\\$&");
let regexp = new RegExp("\\b" + escaped + "\\b", "gi");
console.log(text.replace(regexp, "_$&_"));
// → This _dea+hl[]rd_ guy is super annoying.
```

## The search method

{{index ["regular expression", methods], "indexOf method", "search method"}}

The `indexOf` method on strings cannot be called with a regular
expression. But there is another method, `search`, that does expect a
regular expression. Like `indexOf`, it returns the first index on
which the expression was found, or -1 when it wasn't found.

```
console.log("  word".search(/\S/));
// → 2
console.log("    ".search(/\S/));
// → -1
```

Unfortunately, there is no way to indicate that the match should start
at a given offset (like we can with the second argument to `indexOf`),
which would often be useful.

## The lastIndex property

{{index "exec method", "regular expression"}}

The `exec` method similarly does not provide a convenient way to start
searching from a given position in the string. But it does provide an
*in*convenient way.

{{index ["regular expression", matching], matching, "source property", "lastIndex property"}}

Regular expression objects have properties. One such property is
`source`, which contains the string that expression was created from.
Another property is `lastIndex`, which controls, in some limited
circumstances, where the next match will start.

{{index [interface, design], "exec method", ["regular expression", global]}}

Those circumstances are that the regular expression must have the
global (`g`) or sticky (`y`) option enabled, and the match must happen
through the `exec` method. Again, a less confusing solution would have
been to just allow an extra argument to be passed to `exec`, but
confusion is an essential feature of JavaScript's regular expression
interface.

```
let pattern = /y/g;
pattern.lastIndex = 3;
let match = pattern.exec("xyzzy");
console.log(match.index);
// → 4
console.log(pattern.lastIndex);
// → 5
```

{{index "side effect", "lastIndex property"}}

If the match was successful, the call to `exec` automatically updates
the `lastIndex` property to point after the match. If no match was
found, `lastIndex` is set back to zero, which is also the value it has
in a newly constructed regular expression object.

The difference between the global and the sticky options is that, when
sticky is enabled, the match will succeed only if it starts directly
at `lastIndex`, whereas with global, it will search ahead for a
position where a match can start.

```
let global = /abc/g;
console.log(global.exec("xyz abc"));
// → ["abc"]
let sticky = /abc/y;
console.log(sticky.exec("xyz abc"));
// → null
```

{{index bug}}

When using a shared regular expression value for multiple `exec`
calls, these automatic updates to the `lastIndex` property can cause
problems. Your regular expression might be accidentally starting at an
index that was left over from a previous call.

```
let digit = /\d/g;
console.log(digit.exec("here it is: 1"));
// → ["1"]
console.log(digit.exec("and now: 1"));
// → null
```

{{index ["regular expression", global], "match method"}}

Another interesting effect of the global option is that it changes the
way the `match` method on strings works. When called with a global
expression, instead of returning an array similar to that returned by
`exec`, `match` will find _all_ matches of the pattern in the string
and return an array containing the matched strings.

```
console.log("Banana".match(/an/g));
// → ["an", "an"]
```

So be cautious with global regular expressions. The cases where they
are necessary—calls to `replace` and places where you want to
explicitly use `lastIndex`—are typically the only places where you
want to use them.

### Looping over matches

{{index "lastIndex property", "exec method", loop}}

A common thing to do is to scan through all occurrences of a pattern
in a string, in a way that gives us access to the match object in the
loop body. We can do this by using `lastIndex` and `exec`.

```
let input = "A string with 3 numbers in it... 42 and 88.";
let number = /\b\d+\b/g;
let match;
while (match = number.exec(input)) {
  console.log("Found", match[0], "at", match.index);
}
// → Found 3 at 14
//   Found 42 at 33
//   Found 88 at 40
```

{{index "while loop", ["= operator", "as expression"], [binding, "as state"]}}

This makes use of the fact that the value of an ((assignment))
expression (`=`) is the assigned value. So by using `match =
number.exec(input)` as the condition in the `while` statement, we
perform the match at the start of each iteration, save its result in a
binding, and stop looping when no more matches are found.

{{id ini}}
## Parsing an INI file

{{index comment, "file format", "enemies example", "INI file"}}

To conclude the chapter, we'll look at a problem that calls for
((regular expression))s. Imagine we are writing a program to
automatically collect information about our enemies from the
((Internet)). (We will not actually write that program here, just the
part that reads the ((configuration)) file. Sorry.) The configuration
file looks like this:

```{lang: "text/plain"}
searchengine=https://duckduckgo.com/?q=$1
spitefulness=9.7

; comments are preceded by a semicolon...
; each section concerns an individual enemy
[larry]
fullname=Larry Doe
type=kindergarten bully
website=http://www.geocities.com/CapeCanaveral/11451

[davaeorn]
fullname=Davaeorn
type=evil wizard
outputdir=/home/marijn/enemies/davaeorn
```

{{index grammar}}

The exact rules for this format (which is a widely used format,
usually called an _INI_ file) are as follows:

- Blank lines and lines starting with semicolons are ignored.

- Lines wrapped in `[` and `]` start a new ((section)).

- Lines containing an alphanumeric identifier followed by an `=`
  character add a setting to the current section.

- Anything else is invalid.

Our task is to convert a string like this into an object whose
properties hold strings for settings written before the first
section header and subobjects for sections, with those subobjects
holding the section's settings.

{{index "carriage return", "line break", "newline character"}}

Since the format has to be processed ((line)) by line, splitting up
the file into separate lines is a good start. We saw
the `split` method in [Chapter ?](data#split).
Some operating systems, however, use not just a newline character to
separate lines but a carriage return character followed by a newline
(`"\r\n"`). Given that the `split` method also allows a regular
expression as its argument, we can use a regular expression like
`/\r?\n/` to split in a way that allows both `"\n"` and `"\r\n"`
between lines.

```{startCode: true}
function parseINI(string) {
  // Start with an object to hold the top-level fields
  let result = {};
  let section = result;
  string.split(/\r?\n/).forEach(line => {
    let match;
    if (match = line.match(/^(\w+)=(.*)$/)) {
      section[match[1]] = match[2];
    } else if (match = line.match(/^\[(.*)\]$/)) {
      section = result[match[1]] = {};
    } else if (!/^\s*(;.*)?$/.test(line)) {
      throw new Error("Line '" + line + "' is not valid.");
    }
  });
  return result;
}

console.log(parseINI(`
name=Vasilis
[address]
city=Tessaloniki`));
// → {name: "Vasilis", address: {city: "Tessaloniki"}}
```

{{index "parseINI function", parsing}}

The code goes over the file's lines and builds up an object.
Properties at the top are stored directly into that object, whereas
properties found in sections are stored in a separate section object.
The `section` binding points at the object for the current section.

There are two kinds of significant lines—section headers or property
lines. When a line is a regular property, it is stored in the current
section. When it is a section header, a new section object is created,
and `section` is set to point at it.

{{index "caret character", "dollar sign", boundary}}

Note the recurring use of `^` and `$` to make sure the expression
matches the whole line, not just part of it. Leaving these out results
in code that mostly works but behaves strangely for some input, which
can be a difficult bug to track down.

{{index "if keyword", assignment, ["= operator", "as expression"]}}

The pattern `if (match = string.match(...))` is similar to the trick
of using an assignment as the condition for `while`. You often aren't
sure that your call to `match` will succeed, so you can access the
resulting object only inside an `if` statement that tests for this. To
not break the pleasant chain of `else if` forms, we assign the result
of the match to a binding and immediately use that assignment as the
test for the `if` statement.

{{index [parentheses, "in regular expressions"]}}

If a line is not a section header or a property, the function checks
whether it is a comment or an empty line using the expression
`/^\s*(;.*)?$/`. Do you see how it works? The part between the
parentheses will match comments, and the `?` makes sure it also
matches lines containing only whitespace. When a line doesn't match
any of the expected forms, the function throws an exception.

## International characters

{{index internationalization, Unicode, ["regular expression", internationalization]}}

Because of JavaScript's initial simplistic implementation and the fact
that this simplistic approach was later set in stone as ((standard))
behavior, JavaScript's regular expressions are rather dumb about
characters that do not appear in the English language. For example, as
far as JavaScript's regular expressions are concerned, a "((word
character))" is only one of the 26 characters in the Latin alphabet
(uppercase or lowercase), decimal digits, and, for some reason, the
underscore character. Things like _é_ or _β_, which most definitely
are word characters, will not match `\w` (and _will_ match uppercase
`\W`, the nonword category).

{{index [whitespace, matching]}}

By a strange historical accident, `\s` (whitespace) does not have this
problem and matches all characters that the Unicode standard considers
whitespace, including things like the ((nonbreaking space)) and the
((Mongolian vowel separator)).

Another problem is that, by default, regular expressions work on code
units, as discussed in [Chapter ?](higher_order#code_units), not
actual characters. This means characters that are composed of two
code units behave strangely.

```
console.log(/🍎{3}/.test("🍎🍎🍎"));
// → false
console.log(/<.>/.test("<🌹>"));
// → false
console.log(/<.>/u.test("<🌹>"));
// → true
```

The problem is that the 🍎 in the first line is treated as two code
units, and the `{3}` part is applied only to the second one.
Similarly, the dot matches a single code unit, not the two that make
up the rose ((emoji)).

You must add a `u` option (for ((Unicode))) to your regular
expression to make it treat such characters properly. The wrong
behavior remains the default, unfortunately, because changing that
might cause problems for existing code that depends on it.

{{index "character category", [Unicode, property]}}

Though this was only just standardized and is, at the time of writing,
not widely supported yet, it is possible to use `\p` in a regular
expression (that must have the Unicode option enabled) to match all
characters to which the Unicode standard assigns a given property.

```{test: never}
console.log(/\p{Script=Greek}/u.test("α"));
// → true
console.log(/\p{Script=Arabic}/u.test("α"));
// → false
console.log(/\p{Alphabetic}/u.test("α"));
// → true
console.log(/\p{Alphabetic}/u.test("!"));
// → false
```

Unicode defines a number of useful properties, though finding the one
that you need may not always be trivial. You can use the
`\p{Property=Value}` notation to match any character that has the
given value for that property. If the property name is left off, as in
`\p{Name}`, the name is assumed to be either a binary property such as
`Alphabetic` or a category such as `Number`.

{{id summary_regexp}}

## Summary

Regular expressions are objects that represent patterns in strings.
They use their own language to express these patterns.

{{table {cols: [1, 5]}}}

| `/abc/`     | A sequence of characters
| `/[abc]/`   | Any character from a set of characters
| `/[^abc]/`  | Any character _not_ in a set of characters
| `/[0-9]/`   | Any character in a range of characters
| `/x+/`      | One or more occurrences of the pattern `x`
| `/x+?/`     | One or more occurrences, nongreedy
| `/x*/`      | Zero or more occurrences
| `/x?/`      | Zero or one occurrence
| `/x{2,4}/`  | Two to four occurrences
| `/(abc)/`   | A group
| `/a|b|c/`   | Any one of several patterns
| `/\d/`      | Any digit character
| `/\w/`      | An alphanumeric character ("word character")
| `/\s/`      | Any whitespace character
| `/./`       | Any character except newlines
| `/\b/`      | A word boundary
| `/^/`       | Start of input
| `/$/`       | End of input

A regular expression has a method `test` to test whether a given
string matches it. It also has a method `exec` that, when a match is
found, returns an array containing all matched groups. Such an array
has an `index` property that indicates where the match started.

Strings have a `match` method to match them against a regular
expression and a `search` method to search for one, returning only the
starting position of the match. Their `replace` method can replace
matches of a pattern with a replacement string or function.

Regular expressions can have options, which are written after the
closing slash. The `i` option makes the match case insensitive. The
`g` option makes the expression _global_, which, among other things,
causes the `replace` method to replace all instances instead of just
the first. The `y` option makes it sticky, which means that it will
not search ahead and skip part of the string when looking for a match.
The `u` option turns on Unicode mode, which fixes a number of problems
around the handling of characters that take up two code units.

Regular expressions are a sharp ((tool)) with an awkward handle. They
simplify some tasks tremendously but can quickly become unmanageable
when applied to complex problems. Part of knowing how to use them is
resisting the urge to try to shoehorn things that they cannot cleanly
express into them.

## Exercises

{{index debugging, bug}}

It is almost unavoidable that, in the course of working on these
exercises, you will get confused and frustrated by some regular
expression's inexplicable ((behavior)). Sometimes it helps to enter
your expression into an online tool like
[_https://debuggex.com_](https://www.debuggex.com/) to see whether its
visualization corresponds to what you intended and to ((experiment))
with the way it responds to various input strings.

### Regexp golf

{{index "program size", "code golf", "regexp golf (exercise)"}}

_Code golf_ is a term used for the game of trying to express a
particular program in as few characters as possible. Similarly,
_regexp golf_ is the practice of writing as tiny a regular expression
as possible to match a given pattern, and _only_ that pattern.

{{index boundary, matching}}

For each of the following items, write a ((regular expression)) to
test whether any of the given substrings occur in a string. The
regular expression should match only strings containing one of the
substrings described. Do not worry about word boundaries unless
explicitly mentioned. When your expression works, see whether you can
make it any smaller.

 1. _car_ and _cat_
 2. _pop_ and _prop_
 3. _ferret_, _ferry_, and _ferrari_
 4. Any word ending in _ious_
 5. A whitespace character followed by a period, comma, colon, or semicolon
 6. A word longer than six letters
 7. A word without the letter _e_ (or _E_)

Refer to the table in the [chapter summary](regexp#summary_regexp) for
help. Test each solution with a few test strings.

{{if interactive
```
// Fill in the regular expressions

verify(/.../,
       ["my car", "bad cats"],
       ["camper", "high art"]);

verify(/.../,
       ["pop culture", "mad props"],
       ["plop", "prrrop"]);

verify(/.../,
       ["ferret", "ferry", "ferrari"],
       ["ferrum", "transfer A"]);

verify(/.../,
       ["how delicious", "spacious room"],
       ["ruinous", "consciousness"]);

verify(/.../,
       ["bad punctuation ."],
       ["escape the period"]);

verify(/.../,
       ["Siebentausenddreihundertzweiundzwanzig"],
       ["no", "three small words"]);

verify(/.../,
       ["red platypus", "wobbling nest"],
       ["earth bed", "learning ape", "BEET"]);


function verify(regexp, yes, no) {
  // Ignore unfinished exercises
  if (regexp.source == "...") return;
  for (let str of yes) if (!regexp.test(str)) {
    console.log(`Failure to match '${str}'`);
  }
  for (let str of no) if (regexp.test(str)) {
    console.log(`Unexpected match for '${str}'`);
  }
}
```

if}}

### Quoting style

{{index "quoting style (exercise)", "single-quote character", "double-quote character"}}

Imagine you have written a story and used single ((quotation mark))s
throughout to mark pieces of dialogue. Now you want to replace all the
dialogue quotes with double quotes, while keeping the single quotes
used in contractions like _aren't_.

{{index "replace method"}}

Think of a pattern that distinguishes these two
kinds of quote usage and craft a call to the `replace` method that
does the proper replacement.

{{if interactive
```{test: no}
let text = "'I'm the cook,' he said, 'it's my job.'";
// Change this call.
console.log(text.replace(/A/g, "B"));
// → "I'm the cook," he said, "it's my job."
```
if}}

{{hint

{{index "quoting style (exercise)", boundary}}

The most obvious solution is to replace only quotes with a nonword
character on at least one side—something like `/\W'|'\W/`. But you
also have to take the start and end of the line into account.

{{index grouping, "replace method", [parentheses, "in regular expressions"]}}

In addition, you must ensure that the replacement also includes the
characters that were matched by the `\W` pattern so that those are not
dropped. This can be done by wrapping them in parentheses and
including their groups in the replacement string (`$1`, `$2`). Groups
that are not matched will be replaced by nothing.

hint}}

### Numbers again

{{index sign, "fractional number", [syntax, number], minus, "plus character", exponent, "scientific notation", "period character"}}

Write an expression that matches only JavaScript-style ((number))s. It
must support an optional minus _or_ plus sign in front of the number,
the decimal dot, and exponent notation—`5e-3` or `1E10`—again with an
optional sign in front of the exponent. Also note that it is not
necessary for there to be digits in front of or after the dot, but the
number cannot be a dot alone. That is, `.5` and `5.` are valid
JavaScript numbers, but a lone dot _isn't_.

{{if interactive
```{test: no}
// Fill in this regular expression.
let number = /^...$/;

// Tests:
for (let str of ["1", "-1", "+15", "1.55", ".5", "5.",
                 "1.3e2", "1E-4", "1e+12"]) {
  if (!number.test(str)) {
    console.log(`Failed to match '${str}'`);
  }
}
for (let str of ["1a", "+-1", "1.2.3", "1+1", "1e4.5",
                 ".5.", "1f5", "."]) {
  if (number.test(str)) {
    console.log(`Incorrectly accepted '${str}'`);
  }
}
```

if}}

{{hint

{{index ["regular expression", escaping], ["backslash character", "in regular expressions"]}}

First, do not forget the backslash in front of the period.

Matching the optional ((sign)) in front of the ((number)), as well as
in front of the ((exponent)), can be done with `[+\-]?` or `(\+|-|)`
(plus, minus, or nothing).

{{index "pipe character"}}

The more complicated part of the exercise is the problem of matching
both `"5."` and `".5"` without also matching `"."`. For this, a good
solution is to use the `|` operator to separate the two cases—either
one or more digits optionally followed by a dot and zero or more
digits _or_ a dot followed by one or more digits.

{{index exponent, "case sensitivity", ["regular expression", flags]}}

Finally, to make the _e_ case insensitive, either add an `i` option to
the regular expression or use `[eE]`.

hint}}
{{meta {load_files: ["code/packages_chapter_10.js", "code/chapter/07_robot.js"]}}}

# Modules

{{quote {author: "Tef", title: "Programming is Terrible", chapter: true}

Write code that is easy to delete, not easy to extend.

quote}}

{{index "Yuan-Ma", "Book of Programming"}}

{{figure {url: "img/chapter_picture_10.jpg", alt: "Picture of a building built from modular pieces", chapter: framed}}}

{{index organization, [code, "structure of"]}}

The ideal program has a crystal-clear structure. The way it works is
easy to explain, and each part plays a well-defined role.

{{index "organic growth"}}

A typical real program grows organically. New pieces of functionality
are added as new needs come up. Structuring—and preserving
structure—is additional work. It's work that will pay off only in the
future, the _next_ time someone works on the program. So it is
tempting to neglect it and allow the parts of the program to become
deeply entangled.

{{index readability, reuse, isolation}}

This causes two practical issues. First, understanding such a system
is hard. If everything can touch everything else, it is difficult to
look at any given piece in isolation. You are forced to build up a
holistic understanding of the entire thing. Second, if you want to
use any of the functionality from such a program in another situation,
rewriting it may be easier than trying to disentangle it from its
context.

The phrase "((big ball of mud))" is often used for such large,
structureless programs. Everything sticks together, and when you try
to pick out a piece, the whole thing comes apart, and your hands get
dirty.

## Modules

{{index dependency, [interface, module]}}

_Modules_ are an attempt to avoid these problems. A ((module)) is a
piece of program that specifies which other pieces it relies on
and which functionality it provides for other modules
to use (its _interface_).

{{index "big ball of mud"}}

Module interfaces have a lot in common with object interfaces, as we
saw them in [Chapter ?](object#interface). They make part of the
module available to the outside world and keep the rest private. By
restricting the ways in which modules interact with each other, the
system becomes more like ((LEGO)), where pieces interact through
well-defined connectors, and less like mud, where everything mixes
with everything.

{{index dependency}}

The relations between modules are called _dependencies_. When a module
needs a piece from another module, it is said to depend on that
module. When this fact is clearly specified in the module itself, it
can be used to figure out which other modules need to be present to be
able to use a given module and to automatically load dependencies.

To separate modules in that way, each needs its own private ((scope)).

Just putting your JavaScript code into different ((file))s does not
satisfy these requirements. The files still share the same global
namespace. They can, intentionally or accidentally, interfere with
each other's bindings. And the dependency structure remains unclear.
We can do better, as we'll see later in the chapter.

{{index design}}

Designing a fitting module structure for a program can be difficult.
In the phase where you are still exploring the problem, trying 
different things to see what works, you might want to not worry about
it too much since it can be a big distraction. Once you have
something that feels solid, that's a good time to take a step back and
organize it.

## Packages

{{index bug, dependency, structure, reuse}}

One of the advantages of building a program out of separate pieces,
and being actually able to run those pieces on their own, is that you
might be able to apply the same piece in different programs.

{{index "parseINI function"}}

But how do you set this up? Say I want to use the `parseINI` function
from [Chapter ?](regexp#ini) in another program. If it is clear what
the function depends on (in this case, nothing), I can just copy all the
necessary code into my new project and use it. But then, if I find a
mistake in that code, I'll probably fix it in whichever program 
I'm working with at the time and forget to also fix it in the other
program.

{{index duplication, "copy-paste programming"}}

Once you start duplicating code, you'll quickly find yourself wasting
time and energy moving copies around and keeping them up-to-date.

That's where _((package))s_ come in. A package is a chunk of code that
can be distributed (copied and installed). It may contain one or more
modules and has information about which other packages it depends on.
A package also usually comes with documentation explaining what it
does so that people who didn't write it might still be able to use
it.

When a problem is found in a package or a new feature is added, the
package is updated. Now the programs that depend on it (which may also
be packages) can upgrade to the new ((version)).

{{id modules_npm}}

{{index installation, upgrading, "package manager", download, reuse}}

Working in this way requires ((infrastructure)). We need a place to
store and find packages and a convenient way to install and upgrade
them. In the JavaScript world, this infrastructure is provided by
((NPM)) ([_https://npmjs.org_](https://npmjs.org)).

NPM is two things: an online service where one can download (and
upload) packages and a program (bundled with Node.js) that helps you
install and manage them.

{{index "ini package"}}

At the time of writing, there are more than half a million different
packages available on NPM. A large portion of those are rubbish, I
should mention, but almost every useful, publicly available package
can be found on there. For example, an INI file parser, similar to the
one we built in [Chapter ?](regexp), is available under the package
name `ini`.

{{index "command line"}}

[Chapter ?](node) will show how to install such packages locally using
the `npm` command line program.

Having quality packages available for download is extremely valuable.
It means that we can often avoid reinventing a program that 100
people have written before and get a solid, well-tested
implementation at the press of a few keys.

{{index maintenance}}

Software is cheap to copy, so once someone has written it,
distributing it to other people is an efficient process. But writing
it in the first place _is_ work, and responding to people who have
found problems in the code, or who want to propose new features, is
even more work.

By default, you own the ((copyright)) to the code you write, and other
people may use it only with your permission. But because some people
are just nice and because publishing good software can help make you
a little bit famous among programmers, many packages are published
under a ((license)) that explicitly allows other people to use it.

Most code on ((NPM)) is licensed this way. Some licenses require you
to also publish code that you build on top of the package under the
same license. Others are less demanding, just requiring that you keep
the license with the code as you distribute it. The JavaScript
community mostly uses the latter type of license. When using other
people's packages, make sure you are aware of their license.

## Improvised modules

Until 2015, the JavaScript language had no built-in module system.
Yet people had been building large systems in JavaScript for more than a decade, and they _needed_ ((module))s.

{{index [function, scope], [interface, module], [object, as module]}}

So they designed their own ((module system))s on top of the language.
You can use JavaScript functions to create local scopes and
objects to represent module interfaces.

{{index "Date class", "weekDay module"}}

This is a module for going between day names and numbers (as returned
by `Date`'s `getDay` method). Its interface consists of `weekDay.name`
and `weekDay.number`, and it hides its local binding `names` inside
the scope of a function expression that is immediately invoked.

```
const weekDay = function() {
  const names = ["Sunday", "Monday", "Tuesday", "Wednesday",
                 "Thursday", "Friday", "Saturday"];
  return {
    name(number) { return names[number]; },
    number(name) { return names.indexOf(name); }
  };
}();

console.log(weekDay.name(weekDay.number("Sunday")));
// → Sunday
```

{{index dependency, [interface, module]}}

This style of modules provides ((isolation)), to a certain degree, but
it does not declare dependencies. Instead, it just puts its
interface into the ((global scope)) and expects its dependencies,
if any, to do the same. For a long time this was the main approach
used in web programming, but it is mostly obsolete now.

If we want to make dependency relations part of the code, we'll have
to take control of loading dependencies. Doing that requires being
able to execute strings as code. JavaScript can do this.

{{id eval}}

## Evaluating data as code

{{index evaluation, interpretation}}

There are several ways to take data (a string of code) and run it as
part of the current program.

{{index isolation, eval}}

The most obvious way is the special operator `eval`, which will
execute a string in the _current_ ((scope)). This is usually a bad idea
because it breaks some of the properties that scopes normally have,
such as it being easily predictable which binding a given name refers
to.

```
const x = 1;
function evalAndReturnX(code) {
  eval(code);
  return x;
}

console.log(evalAndReturnX("var x = 2"));
// → 2
console.log(x);
// → 1
```

{{index "Function constructor"}}

A less scary way of interpreting data as code is to use the `Function`
constructor. It takes two arguments: a string containing a
comma-separated list of argument names and a string containing the
function body. It wraps the code in a function value so that it gets
its own scope and won't do odd things with other scopes.

```
let plusOne = Function("n", "return n + 1;");
console.log(plusOne(4));
// → 5
```

This is precisely what we need for a module system. We can wrap the
module's code in a function and use that function's scope as module
((scope)).

## CommonJS

{{id commonjs}}

{{index "CommonJS modules"}}

The most widely used approach to bolted-on JavaScript modules is
called _CommonJS modules_. ((Node.js)) uses it and is the system used
by most packages on ((NPM)).

{{index "require function", [interface, module]}}

The main concept in CommonJS modules is a function called `require`.
When you call this with the module name of a dependency, it makes sure
the module is loaded and returns its interface.

{{index "exports object"}}

Because the loader wraps the module code in a function, modules
automatically get their own local scope. All they have to
do is call `require` to access their dependencies and put their
interface in the object bound to `exports`.

{{index "formatDate module", "Date class", "ordinal package", "date-names package"}}

This example module provides a date-formatting function. It uses two
((package))s from NPM—`ordinal` to convert numbers to strings like
`"1st"` and `"2nd"`, and `date-names` to get the English names for
weekdays and months. It exports a single function, `formatDate`, which
takes a `Date` object and a ((template)) string.

The template string may contain codes that direct the format, such as
`YYYY` for the full year and `Do` for the ordinal day of the month.
You could give it a string like `"MMMM Do YYYY"` to get output like
"November 22nd 2017".

```
const ordinal = require("ordinal");
const {days, months} = require("date-names");

exports.formatDate = function(date, format) {
  return format.replace(/YYYY|M(MMM)?|Do?|dddd/g, tag => {
    if (tag == "YYYY") return date.getFullYear();
    if (tag == "M") return date.getMonth();
    if (tag == "MMMM") return months[date.getMonth()];
    if (tag == "D") return date.getDate();
    if (tag == "Do") return ordinal(date.getDate());
    if (tag == "dddd") return days[date.getDay()];
  });
};
```

{{index "destructuring binding"}}

The interface of `ordinal` is a single function, whereas `date-names`
exports an object containing multiple things—`days` and `months` are
arrays of names. Destructuring is very convenient when creating
bindings for imported interfaces.

The module adds its interface function to `exports` so that modules
that depend on it get access to it. We could use the module like this:

```
const {formatDate} = require("./format-date");

console.log(formatDate(new Date(2017, 9, 13),
                       "dddd the Do"));
// → Friday the 13th
```

{{index "require function", "CommonJS modules", "readFile function"}}

{{id require}}

We can define `require`, in its most minimal form, like this:

```{test: wrap, sandbox: require}
require.cache = Object.create(null);

function require(name) {
  if (!(name in require.cache)) {
    let code = readFile(name);
    let module = {exports: {}};
    require.cache[name] = module;
    let wrapper = Function("require, exports, module", code);
    wrapper(require, module.exports, module);
  }
  return require.cache[name].exports;
}
```

{{index [file, access]}}

In this code, `readFile` is a made-up function that reads a file and
returns its contents as a string. Standard JavaScript provides no such
functionality—but different JavaScript environments, such as the
browser and Node.js, provide their own ways of accessing files.
The example just pretends that `readFile` exists.

{{index cache, "Function constructor"}}

To avoid loading the same module multiple times, `require` keeps a
store (cache) of already loaded modules. When called, it first checks
if the requested module has been loaded and, if not, loads it. This
involves reading the module's code, wrapping it in a function, and
calling it.

{{index "ordinal package", "exports object", "module object", [interface, module]}}

The interface of the `ordinal` package we saw before is not an
object but a function. A quirk of the CommonJS modules is that,
though the module system will create an empty interface object for you
(bound to `exports`), you can replace that with any value by
overwriting `module.exports`. This is done by many modules to export a
single value instead of an interface object.

By defining `require`, `exports`, and `module` as ((parameter))s for
the generated wrapper function (and passing the appropriate values
when calling it), the loader makes sure that these bindings are
available in the module's ((scope)).

{{index resolution, "relative path"}}

The way the string given to `require` is translated to an actual
filename or web address differs in different systems. When it starts with
`"./"` or `"../"`, it is generally interpreted as relative to the
current module's filename. So `"./format-date"` would be the file
named `format-date.js` in the same directory.

When the name isn't relative, Node.js will look for an installed
package by that name. In the example code in this chapter, we'll
interpret such names as referring to NPM packages. We'll go into more
detail on how to install and use NPM modules in [Chapter ?](node).

{{id modules_ini}}

{{index "ini package"}}

Now, instead of writing our own INI file parser, we can use one from
((NPM)).

```
const {parse} = require("ini");

console.log(parse("x = 10\ny = 20"));
// → {x: "10", y: "20"}
```

## ECMAScript modules

((CommonJS modules)) work quite well and, in combination with NPM, 
have allowed the JavaScript community to start sharing code on a large
scale.

{{index "exports object", linter}}

But they remain a bit of a duct-tape ((hack)). The ((notation)) is
slightly awkward—the things you add to `exports` are not available in
the local ((scope)), for example. And because `require` is a normal
function call taking any kind of argument, not just a string literal,
it can be hard to determine the dependencies of a module without
running its code.

{{index "import keyword", dependency, "ES modules"}}

{{id es}}

This is why the JavaScript standard from 2015 introduces its own,
different module system. It is usually called _((ES modules))_, where
_ES_ stands for ((ECMAScript)). The main concepts of dependencies and
interfaces remain the same, but the details differ. For one thing, the
notation is now integrated into the language. Instead of calling a
function to access a dependency, you use a special `import` keyword.

```
import ordinal from "ordinal";
import {days, months} from "date-names";

export function formatDate(date, format) { /* ... */ }
```

{{index "export keyword", "formatDate module"}}

Similarly, the `export` keyword is used to export things. It may
appear in front of a function, class, or binding definition (`let`,
`const`, or `var`).

{{index [binding, exported]}}

An ES module's interface is not a single value but a set of named
bindings. The preceding module binds `formatDate` to a function. When
you import from another module, you import the _binding_, not the
value, which means an exporting module may change the value of the
binding at any time, and the modules that import it will see its new
value.

{{index "default export"}}

When there is a binding named `default`, it is treated as the module's
main exported value. If you import a module like `ordinal` in the
example, without braces around the binding name, you get its `default`
binding. Such modules can still export other bindings under different
names alongside their `default` export.

To create a default export, you write `export default` before an
expression, a function declaration, or a class declaration.

```
export default ["Winter", "Spring", "Summer", "Autumn"];
```

It is possible to rename imported bindings using the word `as`.

```
import {days as dayNames} from "date-names";

console.log(dayNames.length);
// → 7
```

Another important difference is that ES module imports happen before
a module's script starts running. That means `import` declarations
may not appear inside functions or blocks, and the names of
dependencies must be quoted strings, not arbitrary expressions.

At the time of writing, the JavaScript community is in the process of
adopting this module style. But it has been a slow process. It took
a few years, after the format was specified, for browsers and Node.js
to start supporting it. And though they mostly support it now, this
support still has issues, and the discussion on how such modules
should be distributed through ((NPM)) is still ongoing.

Many projects are written using ES modules and then automatically
converted to some other format when published. We are in a
transitional period in which two different module systems are used
side by side, and it is useful to be able to read and write code in
either of them.

## Building and bundling

{{index compilation, "type checking"}}

In fact, many JavaScript projects aren't even, technically, written in
JavaScript. There are extensions, such as the type checking
((dialect)) mentioned in [Chapter ?](error#typing), that are widely
used. People also often start using planned extensions to the language
long before they have been added to the platforms that actually run
JavaScript.

To make this possible, they _compile_ their code, translating it from
their chosen JavaScript dialect to plain old JavaScript—or even to a
past version of JavaScript—so that old ((browsers)) can run it.

{{index latency, performance, [file, access], [network, speed]}}

Including a modular program that consists of 200 different
files in a ((web page)) produces its own problems. If fetching a
single file over the network takes 50 milliseconds, loading
the whole program takes 10 seconds, or maybe half that if you can
load several files simultaneously. That's a lot of wasted time.
Because fetching a single big file tends to be faster than fetching a
lot of tiny ones, web programmers have started using tools that roll
their programs (which they painstakingly split into modules) back into
a single big file before they publish it to the Web. Such tools are
called _((bundler))s_.

{{index "file size"}}

And we can go further. Apart from the number of files, the _size_ of
the files also determines how fast they can be transferred over the
network. Thus, the JavaScript community has invented _((minifier))s_.
These are tools that take a JavaScript program and make it smaller by
automatically removing comments and whitespace, renaming bindings, and
replacing pieces of code with equivalent code that take up less space.

{{index pipeline, tool}}

So it is not uncommon for the code that you find in an NPM package or
that runs on a web page to have gone through _multiple_ stages of
transformation—converted from modern JavaScript to historic
JavaScript, from ES module format to CommonJS, bundled, and minified.
We won't go into the details of these tools in this book since they
tend to be boring and change rapidly. Just be aware that the
JavaScript code you run is often not the code as it was written.

## Module design

{{index [module, design], [interface, module], [code, "structure of"]}}

Structuring programs is one of the subtler aspects of programming. Any
nontrivial piece of functionality can be modeled in various ways.

Good program design is subjective—there are trade-offs involved and
matters of taste. The best way to learn the value of well-structured
design is to read or work on a lot of programs and notice what works
and what doesn't. Don't assume that a painful mess is "just the way it
is". You can improve the structure of almost everything by putting
more thought into it.

{{index [interface, module]}}

One aspect of module design is ease of use. If you are designing
something that is intended to be used by multiple people—or even by
yourself, in three months when you no longer remember the specifics of
what you did—it is helpful if your interface is simple and
predictable.

{{index "ini package", JSON}}

That may mean following existing conventions. A good example is the
`ini` package. This module imitates the standard `JSON` object by
providing `parse` and `stringify` (to write an INI file) functions,
and, like `JSON`, converts between strings and plain objects. So the
interface is small and familiar, and after you've worked with it once,
you're likely to remember how to use it.

{{index "side effect", "hard disk", composability}}

Even if there's no standard function or widely used package to
imitate, you can keep your modules predictable by using simple ((data
structure))s and doing a single, focused thing. Many of the INI-file
parsing modules on NPM provide a function that directly reads such a
file from the hard disk and parses it, for example. This makes it
impossible to use such modules in the browser, where we don't have
direct file system access, and adds complexity that would have been
better addressed by _composing_ the module with some file-reading
function.

{{index "pure function"}}

This points to another helpful aspect of module design—the ease with
which something can be composed with other code. Focused modules that
compute values are applicable in a wider range of programs than bigger
modules that perform complicated actions with side effects. An INI
file reader that insists on reading the file from disk is useless in a
scenario where the file's content comes from some other source.

{{index "object-oriented programming"}}

Relatedly, stateful objects are sometimes useful or even necessary,
but if something can be done with a function, use a function. Several
of the INI file readers on NPM provide an interface style that
requires you to first create an object, then load the file into your
object, and finally use specialized methods to get at the results.
This type of thing is common in the object-oriented tradition, and
it's terrible. Instead of making a single function call and moving on,
you have to perform the ritual of moving your object through various
states. And because the data is now wrapped in a specialized object
type, all code that interacts with it has to know about that type,
creating unnecessary interdependencies.

Often defining new data structures can't be avoided—only a few 
basic ones are provided by the language standard, and many types of
data have to be more complex than an array or a map. But when an
array suffices, use an array.

An example of a slightly more complex data structure is the graph from
[Chapter ?](robot). There is no single obvious way to represent a
((graph)) in JavaScript. In that chapter, we used an object whose
properties hold arrays of strings—the other nodes reachable from that
node.

There are several different pathfinding packages on ((NPM)), but none
of them uses this graph format. They usually allow the graph's edges to
have a weight, which is the cost or distance associated with it. That isn't
possible in our representation.

{{index "Dijkstra, Edsger", pathfinding, "Dijkstra's algorithm", "dijkstrajs package"}}

For example, there's the `dijkstrajs` package. A well-known approach
to pathfinding, quite similar to our `findRoute` function, is called
_Dijkstra's algorithm_, after Edsger Dijkstra, who first wrote it
down. The `js` suffix is often added to package names to indicate the
fact that they are written in JavaScript. This `dijkstrajs` package
uses a graph format similar to ours, but instead of arrays, it uses
objects whose property values are numbers—the weights of the edges.

So if we wanted to use that package, we'd have to make sure that our
graph was stored in the format it expects. All edges get the same
weight since our simplified model treats each road as having the
same cost (one turn).

```
const {find_path} = require("dijkstrajs");

let graph = {};
for (let node of Object.keys(roadGraph)) {
  let edges = graph[node] = {};
  for (let dest of roadGraph[node]) {
    edges[dest] = 1;
  }
}

console.log(find_path(graph, "Post Office", "Cabin"));
// → ["Post Office", "Alice's House", "Cabin"]
```

This can be a barrier to composition—when various packages are using
different data structures to describe similar things, combining them
is difficult. Therefore, if you want to design for composability,
find out what ((data structure))s other people are using and, when
possible, follow their example.

## Summary

Modules provide structure to bigger programs by separating the code
into pieces with clear interfaces and dependencies. The interface is
the part of the module that's visible from other modules, and the
dependencies are the other modules that it makes use of.

Because JavaScript historically did not provide a module system, the
CommonJS system was built on top of it. Then at some point it _did_ get
a built-in system, which now coexists uneasily with the CommonJS
system.

A package is a chunk of code that can be distributed on its own. NPM
is a repository of JavaScript packages. You can download all kinds of
useful (and useless) packages from it.

## Exercises

### A modular robot

{{index "modular robot (exercise)", module, robot, NPM}}

{{id modular_robot}}

These are the bindings that the project from [Chapter ?](robot)
creates:

```{lang: "text/plain"}
roads
buildGraph
roadGraph
VillageState
runRobot
randomPick
randomRobot
mailRoute
routeRobot
findRoute
goalOrientedRobot
```

If you were to write that project as a modular program, what modules
would you create? Which module would depend on which other module, and
what would their interfaces look like?

Which pieces are likely to be available prewritten on NPM? Would you
prefer to use an NPM package or write them yourself?

{{hint

{{index "modular robot (exercise)"}}

Here's what I would have done (but again, there is no single _right_
way to design a given module):

{{index "dijkstrajs package"}}

The code used to build the road graph lives in the `graph` module.
Because I'd rather use `dijkstrajs` from NPM than our own pathfinding
code, we'll make this build the kind of graph data that `dijkstrajs`
expects. This module exports a single function, `buildGraph`. I'd have
`buildGraph` accept an array of two-element arrays, rather than
strings containing hyphens, to make the module less dependent on the
input format.

The `roads` module contains the raw road data (the `roads` array) and
the `roadGraph` binding. This module depends on `./graph` and exports
the road graph.

{{index "random-item package"}}

The `VillageState` class lives in the `state` module. It depends on
the `./roads` module because it needs to be able to verify that a
given road exists. It also needs `randomPick`. Since that is a
three-line function, we could just put it into the `state` module as
an internal helper function. But `randomRobot` needs it too. So we'd
have to either duplicate it or put it into its own module. Since this
function happens to exist on NPM in the `random-item` package, a good
solution is to just make both modules depend on that. We can add the
`runRobot` function to this module as well, since it's small and
closely related to state management. The module exports both the
`VillageState` class and the `runRobot` function.

Finally, the robots, along with the values they depend on such as
`mailRoute`, could go into an `example-robots` module, which depends
on `./roads` and exports the robot functions. To make it possible for
`goalOrientedRobot` to do route-finding, this module also depends
on `dijkstrajs`.

By offloading some work to ((NPM)) modules, the code became a little
smaller. Each individual module does something rather simple and can
be read on its own. Dividing code into modules also often suggests
further improvements to the program's design. In this case, it seems a
little odd that the `VillageState` and the robots depend on a specific
road graph. It might be a better idea to make the graph an argument to
the state's constructor and make the robots read it from the state
object—this reduces dependencies (which is always good) and makes it
possible to run simulations on different maps (which is even better).

Is it a good idea to use NPM modules for things that we could have
written ourselves? In principle, yes—for nontrivial things like the
pathfinding function you are likely to make mistakes and waste time
writing them yourself. For tiny functions like `random-item`, writing
them yourself is easy enough. But adding them wherever you need them
does tend to clutter your modules.

However, you should also not underestimate the work involved in
_finding_ an appropriate NPM package. And even if you find one, it
might not work well or may be missing some feature you need. On top
of that, depending on NPM packages means you have to make sure they
are installed, you have to distribute them with your program, and you
might have to periodically upgrade them.

So again, this is a trade-off, and you can decide either way depending
on how much the packages help you.

hint}}

### Roads module

{{index "roads module (exercise)"}}

Write a ((CommonJS module)), based on the example from [Chapter
?](robot), that contains the array of roads and exports the graph
data structure representing them as `roadGraph`. It should depend on a
module `./graph`, which exports a function `buildGraph` that is used
to build the graph. This function expects an array of two-element
arrays (the start and end points of the roads).

{{if interactive

```{test: no}
// Add dependencies and exports

const roads = [
  "Alice's House-Bob's House",   "Alice's House-Cabin",
  "Alice's House-Post Office",   "Bob's House-Town Hall",
  "Daria's House-Ernie's House", "Daria's House-Town Hall",
  "Ernie's House-Grete's House", "Grete's House-Farm",
  "Grete's House-Shop",          "Marketplace-Farm",
  "Marketplace-Post Office",     "Marketplace-Shop",
  "Marketplace-Town Hall",       "Shop-Town Hall"
];
```

if}}

{{hint

{{index "roads module (exercise)", "destructuring binding", "exports object"}}

Since this is a ((CommonJS module)), you have to use `require` to
import the graph module. That was described as exporting a
`buildGraph` function, which you can pick out of its interface object
with a destructuring `const` declaration.

To export `roadGraph`, you add a property to the `exports` object.
Because `buildGraph` takes a data structure that doesn't precisely
match `roads`, the splitting of the road strings must happen in your
module.

hint}}

### Circular dependencies

{{index dependency, "circular dependency", "require function"}}

A circular dependency is a situation where module A depends on B, and
B also, directly or indirectly, depends on A. Many module systems
simply forbid this because whichever order you choose for loading such
modules, you cannot make sure that each module's dependencies have
been loaded before it runs.

((CommonJS modules)) allow a limited form of cyclic dependencies. As
long as the modules do not replace their default `exports` object and
don't access each other's interface until after they finish loading,
cyclic dependencies are okay.

The `require` function given [earlier in this
chapter](modules#require) supports this type of dependency cycle. Can
you see how it handles cycles? What would go wrong when a module in a
cycle _does_ replace its default `exports` object?

{{hint

{{index overriding, "circular dependency", "exports object"}}

The trick is that `require` adds modules to its cache _before_ it
starts loading the module. That way, if any `require` call made while
it is running tries to load it, it is already known, and the current
interface will be returned, rather than starting to load the module
once more (which would eventually overflow the stack).

If a module overwrites its `module.exports` value, any other module
that has received its interface value before it finished loading will
have gotten hold of the default interface object (which is likely
empty), rather than the intended interface value.

hint}}
{{meta {load_files: ["code/crow-tech.js", "code/chapter/11_async.js"]}}}

# Asynchronous Programming

{{quote {author: "Laozi", title: "Tao Te Ching", chapter: true}

Who can wait quietly while the mud settles?\
Who can remain still until the moment of action?

quote}}

{{index "Laozi"}}

{{figure {url: "img/chapter_picture_11.jpg", alt: "Picture of two crows on a branch", chapter: framed}}}

The central part of a computer, the part that carries out the
individual steps that make up our programs, is called the
_((processor))_. The programs we have seen so far are things that will
keep the processor busy until they have finished their work. The speed
at which something like a loop that manipulates numbers can be
executed depends pretty much entirely on the speed of the processor.

{{index [memory, speed], [network, speed]}}

But many programs interact with things outside of the processor. For
example, they may communicate over a computer network or request
data from the ((hard disk))—which is a lot slower than getting it from
memory.

When such a thing is happening, it would be a shame to let the
processor sit idle—there might be some other work it could do in the
meantime. In part, this is handled by your operating system, which
will switch the processor between multiple running programs. But that
doesn't help when we want a _single_ program to be able to make
progress while it is waiting for a network request.

## Asynchronicity

{{index "synchronous programming"}}

In a _synchronous_ programming model, things happen one at a time.
When you call a function that performs a long-running action, it
returns only when the action has finished and it can return the result.
This stops your program for the time the action takes.

{{index "asynchronous programming"}}

An _asynchronous_ model allows multiple things to happen at the same
time. When you start an action, your program continues to run. When
the action finishes, the program is informed and gets access to the
result (for example, the data read from disk).

We can compare synchronous and asynchronous programming using a small
example: a program that fetches two resources from the ((network)) and
then combines results.

{{index "synchronous programming"}}

In a synchronous environment, where the request function returns only
after it has done its work, the easiest way to perform this task is to
make the requests one after the other. This has the drawback that the
second request will be started only when the first has finished. The
total time taken will be at least the sum of the two response times.

{{index parallelism}}

The solution to this problem, in a synchronous system, is to start
additional ((thread))s of control. A _thread_ is another running program
whose execution may be interleaved with other programs by the
operating system—since most modern computers contain multiple
processors, multiple threads may even run at the same time, on
different processors. A second thread could start the second request,
and then both threads wait for their results to come back, after which
they resynchronize to combine their results.

{{index CPU, blocking, "asynchronous programming", timeline, "callback function"}}

In the following diagram, the thick lines represent time the program
spends running normally, and the thin lines represent time spent
waiting for the network. In the synchronous model, the time taken by
the network is _part_ of the timeline for a given thread of control.
In the asynchronous model, starting a network action conceptually
causes a _split_ in the timeline. The program that initiated the
action continues running, and the action happens alongside it,
notifying the program when it is finished.

{{figure {url: "img/control-io.svg", alt: "Control flow for synchronous and asynchronous programming",width: "8cm"}}}

{{index ["control flow", asynchronous], "asynchronous programming", verbosity}}

Another way to describe the difference is that waiting for actions to
finish is _implicit_ in the synchronous model, while it is _explicit_,
under our control, in the asynchronous one.

Asynchronicity cuts both ways. It makes expressing programs that do
not fit the straight-line model of control easier, but it can also
make expressing programs that do follow a straight line more awkward.
We'll see some ways to address this awkwardness later in the chapter.

Both of the important JavaScript programming platforms—((browser))s
and ((Node.js))—make operations that might take a while asynchronous,
rather than relying on ((thread))s. Since programming with threads is
notoriously hard (understanding what a program does is much more
difficult when it's doing multiple things at once), this is generally
considered a good thing.

## Crow tech

Most people are aware of the fact that ((crow))s are very smart birds.
They can use tools, plan ahead, remember things, and even communicate
these things among themselves.

What most people don't know is that they are capable of many things
that they keep well hidden from us. I've been told by a reputable (if
somewhat eccentric) expert on ((corvid))s that crow technology is not
far behind human technology, and they are catching up.

For example, many crow cultures have the ability to construct
computing devices. These are not electronic, as human computing
devices are, but operate through the actions of tiny insects, a
species closely related to the ((termite)), which has developed a
((symbiotic relationship)) with the crows. The birds provide them with
food, and in return the insects build and operate their complex
colonies that, with the help of the living creatures inside them,
perform computations.

Such colonies are usually located in big, long-lived nests. The birds
and insects work together to build a network of bulbous clay
structures, hidden between the twigs of the nest, in which the insects
live and work.

To communicate with other devices, these machines use light signals.
The crows embed pieces of reflective material in special communication
stalks, and the insects aim these to reflect light at another nest,
encoding data as a sequence of quick flashes. This means that only
nests that have an unbroken visual connection can communicate.

Our friend the corvid expert has mapped the network of crow nests in
the village of ((Hières-sur-Amby)), on the banks of the river Rhône.
This map shows the nests and their connections:

{{figure {url: "img/Hieres-sur-Amby.png", alt: "A network of crow nests in a small village"}}}

In an astounding example of ((convergent evolution)), crow computers
run JavaScript. In this chapter we'll write some basic networking
functions for them.

## Callbacks

{{indexsee [function, callback], "callback function"}}

One approach to ((asynchronous programming)) is to make functions that
perform a slow action take an extra argument, a _((callback
function))_. The action is started, and when it finishes, the callback
function is called with the result.

{{index "setTimeout function", waiting}}

As an example, the `setTimeout` function, available both in Node.js
and in browsers, waits a given number of milliseconds (a second is a
thousand milliseconds) and then calls a function.

```{test: no}
setTimeout(() => console.log("Tick"), 500);
```

Waiting is not generally a very important type of work, but it can be
useful when doing something like updating an animation or checking whether
something is taking longer than a given amount of ((time)).

Performing multiple asynchronous actions in a row using callbacks
means that you have to keep passing new functions to handle the
((continuation)) of the computation after the actions.

{{index "hard disk"}}

Most crow nest computers have a long-term data storage bulb, where
pieces of information are etched into twigs so that they can be
retrieved later. Etching, or finding a piece of data, takes a moment, so
the interface to long-term storage is asynchronous and uses callback
functions.

Storage bulbs store pieces of ((JSON))-encodable data under names. A
((crow)) might store information about the places where it's hidden food under the name `"food caches"`, which could hold an array of
names that point at other pieces of data, describing the actual cache.
To look up a food ((cache)) in the storage bulbs of the _Big Oak_
nest, a crow could run code like this:

{{index "readStorage function"}}

```{includeCode: "top_lines: 1"}
import {bigOak} from "./crow-tech";

bigOak.readStorage("food caches", caches => {
  let firstCache = caches[0];
  bigOak.readStorage(firstCache, info => {
    console.log(info);
  });
});
```

(All binding names and strings have been translated from crow language
to English.)

This style of programming is workable, but the indentation level
increases with each asynchronous action because you end up in another
function. Doing more complicated things, such as running multiple actions
at the same time, can get a little awkward.

Crow nest computers are built to communicate using
((request))-((response)) pairs. That means one nest sends a message to
another nest, which then immediately sends a message back, confirming
receipt and possibly including a reply to a question asked in the
message.

Each message is tagged with a _type_, which determines how it is
handled. Our code can define handlers for specific request types, and
when such a request comes in, the handler is called to produce a
response.

{{index "crow-tech module", "send method"}}

The interface exported by the `"./crow-tech"` module provides
callback-based functions for communication. Nests have a `send` method
that sends off a request. It expects the name of the target nest, the
type of the request, and the content of the request as its first three
arguments, and it expects a function to call when a response comes in as its
fourth and last argument.

```
bigOak.send("Cow Pasture", "note", "Let's caw loudly at 7PM",
            () => console.log("Note delivered."));
```

But to make nests capable of receiving that request, we first have to
define a ((request type)) named `"note"`. The code that handles the
requests has to run not just on this nest-computer but on all nests
that can receive messages of this type. We'll just assume that a crow
flies over and installs our handler code on all the nests.

{{index "defineRequestType function"}}

```{includeCode: true}
import {defineRequestType} from "./crow-tech";

defineRequestType("note", (nest, content, source, done) => {
  console.log(`${nest.name} received note: ${content}`);
  done();
});
```

The `defineRequestType` function defines a new type of request. The
example adds support for `"note"` requests, which just sends a note to
a given nest. Our implementation calls `console.log` so that we can
verify that the request arrived. Nests have a `name` property that
holds their name.

{{index "asynchronous programming"}}

The fourth argument given to the handler, `done`, is a callback
function that it must call when it is done with the request. If we had
used the handler's ((return value)) as the response value, that would
mean that a request handler can't itself perform asynchronous actions.
A function doing asynchronous work typically returns before the work
is done, having arranged for a callback to be called when it
completes. So we need some asynchronous mechanism—in this case,
another ((callback function))—to signal when a response is available.

In a way, asynchronicity is _contagious_. Any function that calls a
function that works asynchronously must itself be asynchronous, using
a callback or similar mechanism to deliver its result. Calling a
callback is somewhat more involved and error-prone than simply
returning a value, so needing to structure large parts of your program
that way is not great.

## Promises

Working with abstract concepts is often easier when those concepts can
be represented by ((value))s. In the case of asynchronous actions, you
could, instead of arranging for a function to be called at some point
in the future, return an object that represents this future event.

{{index "Promise class", "asynchronous programming"}}

This is what the standard class `Promise` is for. A _promise_ is an
asynchronous action that may complete at some point and produce a
value. It is able to notify anyone who is interested when its value is
available.

{{index "Promise.resolve function", "resolving (a promise)"}}

The easiest way to create a promise is by calling `Promise.resolve`.
This function ensures that the value you give it is wrapped in a
promise. If it's already a promise, it is simply returned—otherwise,
you get a new promise that immediately finishes with your
value as its result.

```
let fifteen = Promise.resolve(15);
fifteen.then(value => console.log(`Got ${value}`));
// → Got 15
```

{{index "then method"}}

To get the result of a promise, you can use its `then` method. This
registers a ((callback function)) to be called when the promise
resolves and produces a value. You can add multiple callbacks to a
single promise, and they will be called, even if you add them after
the promise has already _resolved_ (finished).

But that's not all the `then` method does. It returns another promise,
which resolves to the value that the handler function returns or, if
that returns a promise, waits for that promise and then resolves to
its result.

It is useful to think of promises as a device to move values into an
asynchronous reality. A normal value is simply there. A promised value
is a value that _might_ already be there or might appear at some point
in the future. Computations defined in terms of promises act on such
wrapped values and are executed asynchronously as the values become
available.

{{index "Promise class"}}

To create a promise, you can use `Promise` as a constructor. It has a
somewhat odd interface—the constructor expects a function as argument,
which it immediately calls, passing it a function that it can use to
resolve the promise. It works this way, instead of for example with a
`resolve` method, so that only the code that created the promise can
resolve it.

{{index "storage function"}}

This is how you'd create a promise-based interface for the
`readStorage` function:

```{includeCode: "top_lines: 5"}
function storage(nest, name) {
  return new Promise(resolve => {
    nest.readStorage(name, result => resolve(result));
  });
}

storage(bigOak, "enemies")
  .then(value => console.log("Got", value));
```

This asynchronous function returns a meaningful value. This is the
main advantage of promises—they simplify the use of asynchronous
functions. Instead of having to pass around callbacks, promise-based
functions look similar to regular ones: they take input as arguments
and return their output. The only difference is that the output may
not be available yet.

## Failure

{{index "exception handling"}}

Regular JavaScript computations can fail by throwing an exception.
Asynchronous computations often need something like that. A network
request may fail, or some code that is part of the asynchronous
computation may throw an exception.

{{index "callback function", error}}

One of the most pressing problems with the callback style of
asynchronous programming is that it makes it extremely difficult to
make sure failures are properly reported to the callbacks.

A widely used convention is that the first argument to the callback is
used to indicate that the action failed, and the second contains the
value produced by the action when it was successful. Such callback
functions must always check whether they received an exception and
make sure that any problems they cause, including exceptions thrown by
functions they call, are caught and given to the right function.

{{index "rejecting (a promise)", "resolving (a promise)", "then method"}}

Promises make this easier. They can be either resolved (the action
finished successfully) or rejected (it failed). Resolve handlers (as
registered with `then`) are called only when the action is successful,
and rejections are automatically propagated to the new promise that is
returned by `then`. And when a handler throws an exception, this
automatically causes the promise produced by its `then` call to be
rejected. So if any element in a chain of asynchronous actions fails,
the outcome of the whole chain is marked as rejected, and no success
handlers are called beyond the point where it failed.

{{index "Promise.reject function", "Promise class"}}

Much like resolving a promise provides a value, rejecting one also
provides one, usually called the _reason_ of the rejection. When an
exception in a handler function causes the rejection, the exception
value is used as the reason. Similarly, when a handler returns a
promise that is rejected, that rejection flows into the next promise.
There's a `Promise.reject` function that creates a new,
immediately rejected promise.

{{index "catch method"}}

To explicitly handle such rejections, promises have a `catch` method
that registers a handler to be called when the promise is rejected,
similar to how `then` handlers handle normal resolution. It's also very
much like `then` in that it returns a new promise, which resolves to
the original promise's value if it resolves normally and to the
result of the `catch` handler otherwise. If a `catch` handler throws
an error, the new promise is also rejected.

{{index "then method"}}

As a shorthand, `then` also accepts a rejection handler as a second
argument, so you can install both types of handlers in a single method
call.

A function passed to the `Promise` constructor receives a second
argument, alongside the resolve function, which it can use to reject
the new promise.

The chains of promise values created by calls to `then` and `catch`
can be seen as a pipeline through which asynchronous values or
failures move. Since such chains are created by registering handlers,
each link has a success handler or a rejection handler (or both)
associated with it. Handlers that don't match the type of outcome
(success or failure) are ignored. But those that do match are called,
and their outcome determines what kind of value comes next—success
when it returns a non-promise value, rejection when it throws an
exception, and the outcome of a promise when it returns one of those.

```{test: no}
new Promise((_, reject) => reject(new Error("Fail")))
  .then(value => console.log("Handler 1"))
  .catch(reason => {
    console.log("Caught failure " + reason);
    return "nothing";
  })
  .then(value => console.log("Handler 2", value));
// → Caught failure Error: Fail
// → Handler 2 nothing
```

{{index "uncaught exception", "exception handling"}}

Much like an uncaught exception is handled by the environment,
JavaScript environments can detect when a promise rejection isn't
handled and will report this as an error.

## Networks are hard

{{index [network, reliability]}}

Occasionally, there isn't enough light for the ((crow))s' mirror
systems to transmit a signal or something is blocking the path of the
signal. It is possible for a signal to be sent but never received.

{{index "send method", error, timeout}}

As it is, that will just cause the callback given to `send` to never
be called, which will probably cause the program to stop without even
noticing there is a problem. It would be nice if, after a given period
of not getting a response, a request would _time out_ and report
failure.

Often, transmission failures are random accidents, like a car's
headlight interfering with the light signals, and simply retrying the
request may cause it to succeed. So while we're at it, let's make our
request function automatically retry the sending of the request a few
times before it gives up.

{{index "Promise class", "callback function", [interface, object]}}

And, since we've established that promises are a good thing, we'll
also make our request function return a promise. In terms of what they
can express, callbacks and promises are equivalent. Callback-based
functions can be wrapped to expose a promise-based interface, and
vice versa.

Even when a ((request)) and its ((response)) are successfully
delivered, the response may indicate failure—for example, if the
request tries to use a request type that hasn't been defined or the
handler throws an error. To support this, `send` and
`defineRequestType` follow the convention mentioned before, where the
first argument passed to callbacks is the failure reason, if any, and
the second is the actual result.

These can be translated to promise resolution and rejection by our
wrapper.

{{index "Timeout class", "request function", retry}}

```{includeCode: true}
class Timeout extends Error {}

function request(nest, target, type, content) {
  return new Promise((resolve, reject) => {
    let done = false;
    function attempt(n) {
      nest.send(target, type, content, (failed, value) => {
        done = true;
        if (failed) reject(failed);
        else resolve(value);
      });
      setTimeout(() => {
        if (done) return;
        else if (n < 3) attempt(n + 1);
        else reject(new Timeout("Timed out"));
      }, 250);
    }
    attempt(1);
  });
}
```

{{index "Promise class", "resolving (a promise)", "rejecting (a promise)"}}

Because promises can be resolved (or rejected) only once, this will
work. The first time `resolve` or `reject` is called determines the
outcome of the promise, and further calls caused by a request coming
back after another request finished are ignored.

{{index recursion}}

To build an asynchronous ((loop)), for the retries, we need to use a
recursive function—a regular loop doesn't allow us to stop and wait
for an asynchronous action. The `attempt` function makes a single
attempt to send a request. It also sets a timeout that, if no response
has come back after 250 milliseconds, either starts the next attempt
or, if this was the third attempt, rejects the promise with an
instance of `Timeout` as the reason.

{{index idempotence}}

Retrying every quarter-second and giving up when no response has come
in after three-quarter second is definitely somewhat arbitrary. It is even
possible, if the request did come through but the handler is just
taking a bit longer, for requests to be delivered multiple times.
We'll write our handlers with that problem in mind—duplicate messages
should be harmless.

In general, we will not be building a world-class, robust network
today. But that's okay—crows don't have very high expectations yet
when it comes to computing.

{{index "defineRequestType function", "requestType function"}}

To isolate ourselves from callbacks altogether, we'll go ahead and
also define a wrapper for `defineRequestType` that allows the handler
function to return a promise or plain value and wires that up to the
callback for us.

```{includeCode: true}
function requestType(name, handler) {
  defineRequestType(name, (nest, content, source,
                           callback) => {
    try {
      Promise.resolve(handler(nest, content, source))
        .then(response => callback(null, response),
              failure => callback(failure));
    } catch (exception) {
      callback(exception);
    }
  });
}
```

{{index "Promise.resolve function"}}

`Promise.resolve` is used to convert the value returned by `handler`
to a promise if it isn't already.

{{index "try keyword", "callback function"}}

Note that the call to `handler` had to be wrapped in a `try` block to
make sure any exception it raises directly is given to the callback.
This nicely illustrates the difficulty of properly handling errors
with raw callbacks—it is easy to forget to properly route
exceptions like that, and if you don't do it, failures won't get
reported to the right callback. Promises make this mostly automatic
and thus less error-prone.

## Collections of promises

{{index "neighbors property", "ping request"}}

Each nest computer keeps an array of other nests within transmission
distance in its `neighbors` property. To check which of those are
currently reachable, you could write a function that tries to send a
`"ping"` request (a request that simply asks for a response) to each
of them and see which ones come back.

{{index "Promise.all function"}}

When working with collections of promises running at the same time,
the `Promise.all` function can be useful. It returns a promise that
waits for all of the promises in the array to resolve and then
resolves to an array of the values that these promises produced (in
the same order as the original array). If any promise is rejected, the
result of `Promise.all` is itself rejected.

```{includeCode: true}
requestType("ping", () => "pong");

function availableNeighbors(nest) {
  let requests = nest.neighbors.map(neighbor => {
    return request(nest, neighbor, "ping")
      .then(() => true, () => false);
  });
  return Promise.all(requests).then(result => {
    return nest.neighbors.filter((_, i) => result[i]);
  });
}
```

{{index "then method"}}

When a neighbor isn't available, we don't want the entire combined
promise to fail since then we still wouldn't know anything. So the
function that is mapped over the set of neighbors to turn them into
request promises attaches handlers that make successful requests
produce `true` and rejected ones produce `false`.

{{index "filter method", "map method", "some method"}}

In the handler for the combined promise, `filter` is used to remove
those elements from the `neighbors` array whose corresponding value is
false. This makes use of the fact that `filter` passes the array index
of the current element as a second argument to its filtering function
(`map`, `some`, and similar higher-order array methods do the same).

## Network flooding

The fact that nests can talk only to their neighbors greatly inhibits
the usefulness of this network.

For broadcasting information to the whole network, one solution is to
set up a type of request that is automatically forwarded to neighbors.
These neighbors then in turn forward it to their neighbors, until the
whole network has received the message.

{{index "sendGossip function"}}

```{includeCode: true}
import {everywhere} from "./crow-tech";

everywhere(nest => {
  nest.state.gossip = [];
});

function sendGossip(nest, message, exceptFor = null) {
  nest.state.gossip.push(message);
  for (let neighbor of nest.neighbors) {
    if (neighbor == exceptFor) continue;
    request(nest, neighbor, "gossip", message);
  }
}

requestType("gossip", (nest, message, source) => {
  if (nest.state.gossip.includes(message)) return;
  console.log(`${nest.name} received gossip '${
               message}' from ${source}`);
  sendGossip(nest, message, source);
});
```

{{index "everywhere function", "gossip property"}}

To avoid sending the same message around the network forever, each
nest keeps an array of gossip strings that it has already seen. To
define this array, we use the `everywhere` function—which runs code on
every nest—to add a property to the nest's `state` object, which is
where we'll keep nest-local state.

When a nest receives a duplicate gossip message, which is very likely
to happen with everybody blindly resending them, it ignores it. But
when it receives a new message, it excitedly tells all its neighbors
except for the one who sent it the message.

This will cause a new piece of gossip to spread through the network
like an ink stain in water. Even when some connections aren't
currently working, if there is an alternative route to a given nest,
the gossip will reach it through there.

{{index "flooding"}}

This style of network communication is called _flooding_—it floods the
network with a piece of information until all nodes have it.

{{if interactive

We can call `sendGossip` to see a message flow through the village.

```
sendGossip(bigOak, "Kids with airgun in the park");
```

if}}

## Message routing

{{index efficiency}}

If a given node wants to talk to a single other node, flooding is not
a very efficient approach. Especially when the network is big, that
would lead to a lot of useless data transfers.

{{index "routing"}}

An alternative approach is to set up a way for messages to hop from
node to node until they reach their destination. The difficulty with
that is it requires knowledge about the layout of the network. To
send a request in the direction of a faraway nest, it is necessary to
know which neighboring nest gets it closer to its destination. Sending
it in the wrong direction will not do much good.

Since each nest knows only about its direct neighbors, it doesn't have
the information it needs to compute a route. We must somehow spread
the information about these connections to all nests, preferably in a
way that allows it to change over time, when nests are abandoned or
new nests are built.

{{index flooding}}

We can use flooding again, but instead of checking whether a given
message has already been received, we now check whether the new set of
neighbors for a given nest matches the current set we have for it.

{{index "broadcastConnections function", "connections binding"}}

```{includeCode: true}
requestType("connections", (nest, {name, neighbors},
                            source) => {
  let connections = nest.state.connections;
  if (JSON.stringify(connections.get(name)) ==
      JSON.stringify(neighbors)) return;
  connections.set(name, neighbors);
  broadcastConnections(nest, name, source);
});

function broadcastConnections(nest, name, exceptFor = null) {
  for (let neighbor of nest.neighbors) {
    if (neighbor == exceptFor) continue;
    request(nest, neighbor, "connections", {
      name,
      neighbors: nest.state.connections.get(name)
    });
  }
}

everywhere(nest => {
  nest.state.connections = new Map();
  nest.state.connections.set(nest.name, nest.neighbors);
  broadcastConnections(nest, nest.name);
});
```

{{index JSON, "== operator"}}

The comparison uses `JSON.stringify` because `==`, on objects or
arrays, will return true only when the two are the exact same value,
which is not what we need here. Comparing the JSON strings is a crude
but effective way to compare their content.

The nodes immediately start broadcasting their connections, which
should, unless some nests are completely unreachable, quickly give
every nest a map of the current network ((graph)).

{{index pathfinding}}

A thing you can do with graphs is find routes in them, as we saw in
[Chapter ?](robot). If we have a route toward a message's
destination, we know which direction to send it in.

{{index "findRoute function"}}

This `findRoute` function, which greatly resembles the `findRoute`
from [Chapter ?](robot#findRoute), searches for a way to reach a given
node in the network. But instead of returning the whole route, it just
returns the next step. That next nest will itself, using its current
information about the network, decide where _it_ sends the message.

```{includeCode: true}
function findRoute(from, to, connections) {
  let work = [{at: from, via: null}];
  for (let i = 0; i < work.length; i++) {
    let {at, via} = work[i];
    for (let next of connections.get(at) || []) {
      if (next == to) return via;
      if (!work.some(w => w.at == next)) {
        work.push({at: next, via: via || next});
      }
    }
  }
  return null;
}
```

Now we can build a function that can send long-distance messages. If
the message is addressed to a direct neighbor, it is delivered as
usual. If not, it is packaged in an object and sent to a neighbor that
is closer to the target, using the `"route"` request type, which will
cause that neighbor to repeat the same behavior.

{{index "routeRequest function"}}

```{includeCode: true}
function routeRequest(nest, target, type, content) {
  if (nest.neighbors.includes(target)) {
    return request(nest, target, type, content);
  } else {
    let via = findRoute(nest.name, target,
                        nest.state.connections);
    if (!via) throw new Error(`No route to ${target}`);
    return request(nest, via, "route",
                   {target, type, content});
  }
}

requestType("route", (nest, {target, type, content}) => {
  return routeRequest(nest, target, type, content);
});
```

{{if interactive

We can now send a message to the nest in the church tower, which is
four network hops removed.

```
routeRequest(bigOak, "Church Tower", "note",
             "Incoming jackdaws!");
```

if}}

{{index [network, abstraction], layering}}

We've constructed several layers of functionality on top of a
primitive communication system to make it convenient to use.
This is a nice (though simplified) model of how real computer networks
work.

{{index error}}

A distinguishing property of computer networks is that they aren't
reliable—abstractions built on top of them can help, but you can't
abstract away network failure. So network programming is typically
very much about anticipating and dealing with failures.

## Async functions

To store important information, ((crow))s are known to duplicate it
across nests. That way, when a hawk destroys a nest, the information
isn't lost.

To retrieve a given piece of information that it doesn't have in its
own storage bulb, a nest computer might consult random other nests in
the network until it finds one that has it.

{{index "findInStorage function", "network function"}}

```{includeCode: true}
requestType("storage", (nest, name) => storage(nest, name));

function findInStorage(nest, name) {
  return storage(nest, name).then(found => {
    if (found != null) return found;
    else return findInRemoteStorage(nest, name);
  });
}

function network(nest) {
  return Array.from(nest.state.connections.keys());
}

function findInRemoteStorage(nest, name) {
  let sources = network(nest).filter(n => n != nest.name);
  function next() {
    if (sources.length == 0) {
      return Promise.reject(new Error("Not found"));
    } else {
      let source = sources[Math.floor(Math.random() *
                                      sources.length)];
      sources = sources.filter(n => n != source);
      return routeRequest(nest, source, "storage", name)
        .then(value => value != null ? value : next(),
              next);
    }
  }
  return next();
}
```

{{index "Map class", "Object.keys function", "Array.from function"}}

Because `connections` is a `Map`, `Object.keys` doesn't work on it. It
has a `keys` _method_, but that returns an iterator rather than an
array. An iterator (or iterable value) can be converted to an array
with the `Array.from` function.

{{index "Promise class", recursion}}

Even with promises this is some rather awkward code. Multiple
asynchronous actions are chained together in non-obvious ways. We
again need a recursive function (`next`) to model looping through the
nests.

{{index "synchronous programming", "asynchronous programming"}}

And the thing the code actually does is completely linear—it always
waits for the previous action to complete before starting the next
one. In a synchronous programming model, it'd be simpler to express.

{{index "async function", "await keyword"}}

The good news is that JavaScript allows you to write pseudo-synchronous
code to describe asynchronous computation. An `async` function is a
function that implicitly returns a
promise and that can, in its body, `await` other promises in a way
that _looks_ synchronous.

{{index "findInStorage function"}}

We can rewrite `findInStorage` like this:

```
async function findInStorage(nest, name) {
  let local = await storage(nest, name);
  if (local != null) return local;

  let sources = network(nest).filter(n => n != nest.name);
  while (sources.length > 0) {
    let source = sources[Math.floor(Math.random() *
                                    sources.length)];
    sources = sources.filter(n => n != source);
    try {
      let found = await routeRequest(nest, source, "storage",
                                     name);
      if (found != null) return found;
    } catch (_) {}
  }
  throw new Error("Not found");
}
```

{{index "async function", "return keyword", "exception handling"}}

An `async` function is marked by the word `async` before the
`function` keyword. Methods can also be made `async` by writing
`async` before their name. When such a function or method is called,
it returns a promise. As soon as the body returns something, that
promise is resolved. If it throws an exception, the promise is
rejected.

{{if interactive

```{startCode: true}
findInStorage(bigOak, "events on 2017-12-21")
  .then(console.log);
```

if}}

{{index "await keyword", ["control flow", asynchronous]}}

Inside an `async` function, the word `await` can be put in front of an
expression to wait for a promise to resolve and only then continue
the execution of the function.

Such a function no longer, like a regular JavaScript function, runs
from start to completion in one go. Instead, it can be _frozen_ at any
point that has an `await`, and can be resumed at a later time.

For non-trivial asynchronous code, this notation is usually more
convenient than directly using promises. Even if you need to do
something that doesn't fit the synchronous model, such as perform
multiple actions at the same time, it is easy to combine `await` with
the direct use of promises.

## Generators

{{index "async function"}}

This ability of functions to be paused and then resumed again is not
exclusive to `async` functions. JavaScript also has a feature called
_((generator))_ functions. These are similar, but without the
promises.

When you define a function with `function*` (placing an asterisk after
the word `function`), it becomes a generator. When you call a
generator, it returns an ((iterator)), which we already saw in
[Chapter ?](object).

```
function* powers(n) {
  for (let current = n;; current *= n) {
    yield current;
  }
}

for (let power of powers(3)) {
  if (power > 50) break;
  console.log(power);
}
// → 3
// → 9
// → 27
```

{{index "next method", "yield keyword"}}

Initially, when you call `powers`, the function is frozen at its
start. Every time you call `next` on the iterator, the function runs
until it hits a `yield` expression, which pauses it and causes the
yielded value to become the next value produced by the iterator. When
the function returns (the one in the example never does), the iterator
is done.

Writing iterators is often much easier when you use generator
functions. The iterator for the `Group` class (from the exercise in
[Chapter ?](object#group_iterator)) can be written with this
generator:

{{index "Group class"}}

```
Group.prototype[Symbol.iterator] = function*() {
  for (let i = 0; i < this.members.length; i++) {
    yield this.members[i];
  }
};
```

```{hidden: true, includeCode: true}
class Group {
  constructor() { this.members = []; }
  add(m) { this.members.add(m); }
}
```

{{index [state, in iterator]}}

There's no longer a need to create an object to hold the iteration
state—generators automatically save their local state every time
they yield.

Such `yield` expressions may occur only directly in the generator
function itself and not in an inner function you define inside of it.
The state a generator saves, when yielding, is only its _local_
environment and the position where it yielded.

{{index "await keyword"}}

An `async` function is a special type of generator. It produces a
promise when called, which is resolved when it returns (finishes) and
rejected when it throws an exception. Whenever it yields (awaits) a
promise, the result of that promise (value or thrown exception) is the
result of the `await` expression.

## The event loop

{{index "asynchronous programming", scheduling, "event loop", timeline}}

Asynchronous programs are executed piece by piece. Each piece may
start some actions and schedule code to be executed when the action
finishes or fails. In between these pieces, the program sits idle,
waiting for the next action.

{{index "setTimeout function"}}

So callbacks are not directly called by the code that scheduled them.
If I call `setTimeout` from within a function, that function will have
returned by the time the callback function is called. And when the
callback returns, control does not go back to the function that
scheduled it.

{{index "Promise class", "catch keyword", "exception handling"}}

Asynchronous behavior happens on its own empty function ((call
stack)). This is one of the reasons that, without promises, managing
exceptions across asynchronous code is hard. Since each callback
starts with a mostly empty stack, your `catch` handlers won't be on
the stack when they throw an exception.

```
try {
  setTimeout(() => {
    throw new Error("Woosh");
  }, 20);
} catch (_) {
  // This will not run
  console.log("Caught!");
}
```

{{index thread, queue}}

No matter how closely together events—such as timeouts or incoming
requests—happen, a JavaScript environment will run only one program at
a time. You can think of this as it running a big loop _around_ your
program, called the _event loop_. When there's nothing to be done,
that loop is stopped. But as events come in, they are added to a queue,
and their code is executed one after the other. Because no two things
run at the same time, slow-running code might delay the handling of
other events.

This example sets a timeout but then dallies until after the
timeout's intended point of time, causing the timeout to be late.

```
let start = Date.now();
setTimeout(() => {
  console.log("Timeout ran at", Date.now() - start);
}, 20);
while (Date.now() < start + 50) {}
console.log("Wasted time until", Date.now() - start);
// → Wasted time until 50
// → Timeout ran at 55
```

{{index "resolving (a promise)", "rejecting (a promise)", "Promise class"}}

Promises always resolve or reject as a new event. Even if a promise is
already resolved, waiting for it will cause your callback to run after
the current script finishes, rather than right away.

```
Promise.resolve("Done").then(console.log);
console.log("Me first!");
// → Me first!
// → Done
```

In later chapters we'll see various other types of events that run on
the event loop.

## Asynchronous bugs

{{index "asynchronous programming", [state, transitions]}}

When your program runs synchronously, in a single go, there are no
state changes happening except those that the program itself
makes. For asynchronous programs this is different—they may have
_gaps_ in their execution during which other code can run.

Let's look at an example. One of the hobbies of our crows is to count
the number of chicks that hatch throughout the village every year.
Nests store this count in their storage bulbs. The following code tries to
enumerate the counts from all the nests for a given year:

{{index "anyStorage function", "chicks function"}}

```{includeCode: true}
function anyStorage(nest, source, name) {
  if (source == nest.name) return storage(nest, name);
  else return routeRequest(nest, source, "storage", name);
}

async function chicks(nest, year) {
  let list = "";
  await Promise.all(network(nest).map(async name => {
    list += `${name}: ${
      await anyStorage(nest, name, `chicks in ${year}`)
    }\n`;
  }));
  return list;
}
```

{{index "async function"}}

The `async name =>` part shows that ((arrow function))s can also be
made `async` by putting the word `async` in front of them.

{{index "Promise.all function"}}

The code doesn't immediately look suspicious...it maps the `async`
arrow function over the set of nests, creating an array of promises,
and then uses `Promise.all` to wait for all of these before returning
the list they build up.

But it is seriously broken. It'll always return only a single line of
output, listing the nest that was slowest to respond.

{{if interactive

```
chicks(bigOak, 2017).then(console.log);
```

if}}

Can you work out why?

{{index "+= operator"}}

The problem lies in the `+=` operator, which takes the _current_ value
of `list` at the time where the statement starts executing and then,
when the `await` finishes, sets the `list` binding to be that value
plus the added string.

{{index "await keyword"}}

But between the time where the statement starts executing and the time
where it finishes there's an asynchronous gap. The `map` expression
runs before anything has been added to the list, so each of the `+=`
operators starts from an empty string and ends up, when its storage
retrieval finishes, setting `list` to a single-line list—the result of
adding its line to the empty string.

{{index "side effect"}}

This could have easily been avoided by returning the lines from the
mapped promises and calling `join` on the result of `Promise.all`,
instead of building up the list by changing a binding. As usual,
computing new values is less error-prone than changing existing
values.

{{index "chicks function"}}

```
async function chicks(nest, year) {
  let lines = network(nest).map(async name => {
    return name + ": " +
      await anyStorage(nest, name, `chicks in ${year}`);
  });
  return (await Promise.all(lines)).join("\n");
}
```

Mistakes like this are easy to make, especially when using `await`,
and you should be aware of where the gaps in your code occur. An
advantage of JavaScript's _explicit_ asynchronicity (whether through
callbacks, promises, or `await`) is that spotting these gaps is
relatively easy.

## Summary

Asynchronous programming makes it possible to express waiting for
long-running actions without freezing the program during these
actions. JavaScript environments typically implement this style of
programming using callbacks, functions that are called when the
actions complete. An event loop schedules such callbacks to be called
when appropriate, one after the other, so that their execution does
not overlap.

Programming asynchronously is made easier by promises, objects that
represent actions that might complete in the future, and `async`
functions, which allow you to write an asynchronous program as if it
were synchronous.

## Exercises

### Tracking the scalpel

{{index "scalpel (exercise)"}}

The village crows own an old scalpel that they occasionally use on
special missions—say, to cut through screen doors or packaging. To be
able to quickly track it down, every time the scalpel is moved to
another nest, an entry is added to the storage of both the nest that
had it and the nest that took it, under the name `"scalpel"`, with its
new location as the value.

This means that finding the scalpel is a matter of following the
breadcrumb trail of storage entries, until you find a nest where that
points at the nest itself.

{{index "anyStorage function", "async function"}}

Write an `async` function `locateScalpel` that does this, starting at
the nest on which it runs. You can use the `anyStorage` function
defined earlier to access storage in arbitrary nests. The scalpel has
been going around long enough that you may assume that every nest has
a `"scalpel"` entry in its data storage.

Next, write the same function again without using `async` and `await`.

{{index "exception handling"}}

Do request failures properly show up as rejections of the returned
promise in both versions? How?

{{if interactive

```{test: no}
async function locateScalpel(nest) {
  // Your code here.
}

function locateScalpel2(nest) {
  // Your code here.
}

locateScalpel(bigOak).then(console.log);
// → Butcher Shop
```

if}}

{{hint

{{index "scalpel (exercise)"}}

This can be done with a single loop that searches through the nests,
moving forward to the next when it finds a value that doesn't match
the current nest's name and returning the name when it finds a
matching value. In the `async` function, a regular `for` or `while`
loop can be used.

{{index recursion}}

To do the same in a plain function, you will have to build your loop
using a recursive function. The easiest way to do this is to have that
function return a promise by calling `then` on the promise that
retrieves the storage value. Depending on whether that value matches
the name of the current nest, the handler returns that value or a
further promise created by calling the loop function again.

Don't forget to start the loop by calling the recursive function once
from the main function.

{{index "exception handling"}}

In the `async` function, rejected promises are converted to exceptions
by `await`. When an `async` function throws an exception, its promise
is rejected. So that works.

If you implemented the non-`async` function as outlined earlier, the way
`then` works also automatically causes a failure to end up in the
returned promise. If a request fails, the handler passed to `then`
isn't called, and the promise it returns is rejected with the same
reason.

hint}}

### Building Promise.all

{{index "Promise class", "Promise.all function", "building Promise.all (exercise)"}}

Given an array of ((promise))s, `Promise.all` returns a promise that
waits for all of the promises in the array to finish. It then
succeeds, yielding an array of result values. If a promise
in the array fails, the promise returned by `all` fails too, with the
failure reason from the failing promise.

Implement something like this yourself as a regular function
called `Promise_all`.

Remember that after a promise has succeeded or failed, it can't
succeed or fail again, and further calls to the functions that resolve
it are ignored. This can simplify the way you handle failure of your
promise.

{{if interactive

```{test: no}
function Promise_all(promises) {
  return new Promise((resolve, reject) => {
    // Your code here.
  });
}

// Test code.
Promise_all([]).then(array => {
  console.log("This should be []:", array);
});
function soon(val) {
  return new Promise(resolve => {
    setTimeout(() => resolve(val), Math.random() * 500);
  });
}
Promise_all([soon(1), soon(2), soon(3)]).then(array => {
  console.log("This should be [1, 2, 3]:", array);
});
Promise_all([soon(1), Promise.reject("X"), soon(3)])
  .then(array => {
    console.log("We should not get here");
  })
  .catch(error => {
    if (error != "X") {
      console.log("Unexpected failure:", error);
    }
  });
```

if}}

{{hint

{{index "Promise.all function", "Promise class", "then method", "building Promise.all (exercise)"}}

The function passed to the `Promise` constructor will have to call
`then` on each of the promises in the given array. When one of them
succeeds, two things need to happen. The resulting value needs to be
stored in the correct position of a result array, and we must check
whether this was the last pending ((promise)) and finish our own
promise if it was.

{{index "counter variable"}}

The latter can be done with a counter that is initialized to the
length of the input array and from which we subtract 1 every time a
promise succeeds. When it reaches 0, we are done. Make sure you take
into account the situation where the input array is empty (and thus no
promise will ever resolve).

Handling failure requires some thought but turns out to be extremely
simple. Just pass the `reject` function of the wrapping promise to
each of the promises in the array as a `catch` handler or as a second
argument to `then` so that a failure in one of them triggers the
rejection of the whole wrapper promise.

hint}}
{{meta {load_files: ["code/chapter/12_language.js"], zip: "node/html"}}}

# Project: A Programming Language

{{quote {author: "Hal Abelson and Gerald Sussman", title: "Structure and Interpretation of Computer Programs", chapter: true}

The evaluator, which determines the meaning of expressions in a
programming language, is just another program.

quote}}

{{index "Abelson, Hal", "Sussman, Gerald", SICP, "project chapter"}}

{{figure {url: "img/chapter_picture_12.jpg", alt: "Picture of an egg with smaller eggs inside", chapter: "framed"}}}

Building your own ((programming language)) is surprisingly easy (as
long as you do not aim too high) and very enlightening.

The main thing I want to show in this chapter is that there is no
((magic)) involved in building your own language. I've often felt that
some human inventions were so immensely clever and complicated that
I'd never be able to understand them. But with a little reading and
experimenting, they often turn out to be quite mundane.

{{index "Egg language", [abstraction, "in Egg"]}}

We will build a programming language called Egg. It will be a tiny,
simple language—but one that is powerful enough to express any
computation you can think of. It will allow simple ((abstraction))
based on ((function))s.

{{id parsing}}

## Parsing

{{index parsing, validation, [syntax, "of Egg"]}}

The most immediately visible part of a programming language is its
_syntax_, or notation. A _parser_ is a program that reads a piece
of text and produces a data structure that reflects the structure of
the program contained in that text. If the text does not form a valid
program, the parser should point out the error.

{{index "special form", [function, application]}}

Our language will have a simple and uniform syntax. Everything in Egg
is an ((expression)). An expression can be the name of a binding, a
number, a string, or an _application_. Applications are used for
function calls but also for constructs such as `if` or `while`.

{{index "double-quote character", parsing, [escaping, "in strings"], [whitespace, syntax]}}

To keep the parser simple, strings in Egg do not support anything like
backslash escapes. A string is simply a sequence of characters that
are not double quotes, wrapped in double quotes. A number is a
sequence of digits. Binding names can consist of any character that is
not whitespace and that does not have a special meaning in the syntax.

{{index "comma character", [parentheses, arguments]}}

Applications are written the way they are in JavaScript, by putting
parentheses after an expression and having any number of
((argument))s between those parentheses, separated by commas.

```{lang: null}
do(define(x, 10),
   if(>(x, 5),
      print("large"),
      print("small")))
```

{{index block, [syntax, "of Egg"]}}

The ((uniformity)) of the ((Egg language)) means that things that are
((operator))s in JavaScript (such as `>`) are normal bindings in this
language, applied just like other ((function))s. And since the
syntax has no concept of a block, we need a `do` construct to
represent doing multiple things in sequence.

{{index "type property", parsing, ["data structure", tree]}}

The data structure that the parser will use to describe a program
consists of ((expression)) objects, each of which has a `type`
property indicating the kind of expression it is and other properties
to describe its content.

{{index identifier}}

Expressions of type `"value"` represent literal strings or numbers.
Their `value` property contains the string or number value that they
represent. Expressions of type `"word"` are used for identifiers
(names). Such objects have a `name` property that holds the
identifier's name as a string. Finally, `"apply"` expressions
represent applications. They have an `operator` property that refers
to the expression that is being applied, as well as an `args` property that
holds an array of argument expressions.

The `>(x, 5)` part of the previous program would be represented like this:

```{lang: "application/json"}
{
  type: "apply",
  operator: {type: "word", name: ">"},
  args: [
    {type: "word", name: "x"},
    {type: "value", value: 5}
  ]
}
```

{{indexsee "abstract syntax tree", "syntax tree", ["data structure", tree]}}

Such a data structure is called a _((syntax tree))_. If you
imagine the objects as dots and the links between them as lines
between those dots, it has a ((tree))like shape. The fact that
expressions contain other expressions, which in turn might contain
more expressions, is similar to the way tree branches split and split
again.

{{figure {url: "img/syntax_tree.svg", alt: "The structure of a syntax tree",width: "5cm"}}}

{{index parsing}}

Contrast this to the parser we wrote for the configuration file format
in [Chapter ?](regexp#ini), which had a simple structure: it split the
input into lines and handled those lines one at a time. There were
only a few simple forms that a line was allowed to have.

{{index recursion, [nesting, "of expressions"]}}

Here we must find a different approach. Expressions are not separated
into lines, and they have a recursive structure. Application
expressions _contain_ other expressions.

{{index elegance}}

Fortunately, this problem can be solved very well by writing a parser
function that is recursive in a way that reflects the recursive nature
of the language.

{{index "parseExpression function", "syntax tree"}}

We define a function `parseExpression`, which takes a string as input
and returns an object containing the data structure for the expression
at the start of the string, along with the part of the string left
after parsing this expression. When parsing subexpressions (the
argument to an application, for example), this function can be called
again, yielding the argument expression as well as the text that
remains. This text may in turn contain more arguments or may be the
closing parenthesis that ends the list of arguments.

This is the first part of the parser:

```{includeCode: true}
function parseExpression(program) {
  program = skipSpace(program);
  let match, expr;
  if (match = /^"([^"]*)"/.exec(program)) {
    expr = {type: "value", value: match[1]};
  } else if (match = /^\d+\b/.exec(program)) {
    expr = {type: "value", value: Number(match[0])};
  } else if (match = /^[^\s(),#"]+/.exec(program)) {
    expr = {type: "word", name: match[0]};
  } else {
    throw new SyntaxError("Unexpected syntax: " + program);
  }

  return parseApply(expr, program.slice(match[0].length));
}

function skipSpace(string) {
  let first = string.search(/\S/);
  if (first == -1) return "";
  return string.slice(first);
}
```

{{index "skipSpace function", [whitespace, syntax]}}

Because Egg, like JavaScript, allows any amount of whitespace
between its elements, we have to repeatedly cut the whitespace off the
start of the program string. That is what the `skipSpace` function
helps with.

{{index "literal expression", "SyntaxError type"}}

After skipping any leading space, `parseExpression` uses three
((regular expression))s to spot the three atomic elements that Egg
supports: strings, numbers, and words. The parser constructs a
different kind of data structure depending on which one matches. If
the input does not match one of these three forms, it is not a valid
expression, and the parser throws an error. We use `SyntaxError`
instead of `Error` as the exception constructor, which is another standard
error type, because it is a little more specific—it is also the error
type thrown when an attempt is made to run an invalid JavaScript
program.

{{index "parseApply function"}}

We then cut off the part that was matched from the program string and
pass that, along with the object for the expression, to `parseApply`,
which checks whether the expression is an application. If so, it
parses a parenthesized list of arguments.

```{includeCode: true}
function parseApply(expr, program) {
  program = skipSpace(program);
  if (program[0] != "(") {
    return {expr: expr, rest: program};
  }

  program = skipSpace(program.slice(1));
  expr = {type: "apply", operator: expr, args: []};
  while (program[0] != ")") {
    let arg = parseExpression(program);
    expr.args.push(arg.expr);
    program = skipSpace(arg.rest);
    if (program[0] == ",") {
      program = skipSpace(program.slice(1));
    } else if (program[0] != ")") {
      throw new SyntaxError("Expected ',' or ')'");
    }
  }
  return parseApply(expr, program.slice(1));
}
```

{{index parsing}}

If the next character in the program is not an opening parenthesis,
this is not an application, and `parseApply` returns the expression it
was given.

{{index recursion}}

Otherwise, it skips the opening parenthesis and creates the ((syntax
tree)) object for this application expression. It then recursively
calls `parseExpression` to parse each argument until a closing
parenthesis is found. The recursion is indirect, through `parseApply`
and `parseExpression` calling each other.

Because an application expression can itself be applied (such as in
`multiplier(2)(1)`), `parseApply` must, after it has parsed an
application, call itself again to check whether another pair of
parentheses follows.

{{index "syntax tree", "Egg language", "parse function"}}

This is all we need to parse Egg. We wrap it in a convenient `parse`
function that verifies that it has reached the end of the input string
after parsing the expression (an Egg program is a single expression),
and that gives us the program's data structure.

```{includeCode: strip_log, test: join}
function parse(program) {
  let {expr, rest} = parseExpression(program);
  if (skipSpace(rest).length > 0) {
    throw new SyntaxError("Unexpected text after program");
  }
  return expr;
}

console.log(parse("+(a, 10)"));
// → {type: "apply",
//    operator: {type: "word", name: "+"},
//    args: [{type: "word", name: "a"},
//           {type: "value", value: 10}]}
```

{{index "error message"}}

It works! It doesn't give us very helpful information when it fails
and doesn't store the line and column on which each expression starts,
which might be helpful when reporting errors later, but it's good
enough for our purposes.

## The evaluator

{{index "evaluate function", evaluation, interpretation, "syntax tree", "Egg language"}}

What can we do with the syntax tree for a program? Run it, of course!
And that is what the evaluator does. You give it a syntax tree and a
scope object that associates names with values, and it will evaluate
the expression that the tree represents and return the value that this
produces.

```{includeCode: true}
const specialForms = Object.create(null);

function evaluate(expr, scope) {
  if (expr.type == "value") {
    return expr.value;
  } else if (expr.type == "word") {
    if (expr.name in scope) {
      return scope[expr.name];
    } else {
      throw new ReferenceError(
        `Undefined binding: ${expr.name}`);
    }
  } else if (expr.type == "apply") {
    let {operator, args} = expr;
    if (operator.type == "word" &&
        operator.name in specialForms) {
      return specialForms[operator.name](expr.args, scope);
    } else {
      let op = evaluate(operator, scope);
      if (typeof op == "function") {
        return op(...args.map(arg => evaluate(arg, scope)));
      } else {
        throw new TypeError("Applying a non-function.");
      }
    }
  }
}
```

{{index "literal expression", scope}}

The evaluator has code for each of the ((expression)) types. A literal
value expression produces its value. (For example, the expression
`100` just evaluates to the number 100.) For a binding, we must check
whether it is actually defined in the scope and, if it is, fetch the
binding's value.

{{index [function, application]}}

Applications are more involved. If they are a ((special form)), like
`if`, we do not evaluate anything and pass the argument expressions,
along with the scope, to the function that handles this form. If it is
a normal call, we evaluate the operator, verify that it is a function,
and call it with the evaluated arguments.

We use plain JavaScript function values to represent Egg's function
values. We will come back to this [later](language#egg_fun), when the
special form called `fun` is defined.

{{index readability, "evaluate function", recursion, parsing}}

The recursive structure of `evaluate` resembles the similar structure
of the parser, and both mirror the structure of the language itself.
It would also be possible to integrate the parser with the evaluator
and evaluate during parsing, but splitting them up this way makes the
program clearer.

{{index "Egg language", interpretation}}

This is really all that is needed to interpret Egg. It is that simple.
But without defining a few special forms and adding some useful values
to the ((environment)), you can't do much with this language yet.

## Special forms

{{index "special form", "specialForms object"}}

The `specialForms` object is used to define special syntax in Egg. It
associates words with functions that evaluate such forms. It is
currently empty. Let's add `if`.

```{includeCode: true}
specialForms.if = (args, scope) => {
  if (args.length != 3) {
    throw new SyntaxError("Wrong number of args to if");
  } else if (evaluate(args[0], scope) !== false) {
    return evaluate(args[1], scope);
  } else {
    return evaluate(args[2], scope);
  }
};
```

{{index "conditional execution", "ternary operator", "?: operator", "conditional operator"}}

Egg's `if` construct expects exactly three arguments. It will evaluate
the first, and if the result isn't the value `false`, it will evaluate
the second. Otherwise, the third gets evaluated. This `if` form is
more similar to JavaScript's ternary `?:` operator than to
JavaScript's `if`. It is an expression, not a statement, and it
produces a value, namely, the result of the second or third argument.

{{index Boolean}}

Egg also differs from JavaScript in how it handles the condition value
to `if`. It will not treat things like zero or the empty string as
false, only the precise value `false`.

{{index "short-circuit evaluation"}}

The reason we need to represent `if` as a special form, rather than a
regular function, is that all arguments to functions are evaluated
before the function is called, whereas `if` should evaluate only
_either_ its second or its third argument, depending on the value of
the first.

The `while` form is similar.

```{includeCode: true}
specialForms.while = (args, scope) => {
  if (args.length != 2) {
    throw new SyntaxError("Wrong number of args to while");
  }
  while (evaluate(args[0], scope) !== false) {
    evaluate(args[1], scope);
  }

  // Since undefined does not exist in Egg, we return false,
  // for lack of a meaningful result.
  return false;
};
```

Another basic building block is `do`, which executes all its arguments
from top to bottom. Its value is the value produced by the last
argument.

```{includeCode: true}
specialForms.do = (args, scope) => {
  let value = false;
  for (let arg of args) {
    value = evaluate(arg, scope);
  }
  return value;
};
```

{{index ["= operator", "in Egg"], [binding, "in Egg"]}}

To be able to create bindings and give them new values, we also
create a form called `define`. It expects a word as its first argument
and an expression producing the value to assign to that word as its
second argument. Since `define`, like everything, is an expression, it
must return a value. We'll make it return the value that was assigned
(just like JavaScript's `=` operator).

```{includeCode: true}
specialForms.define = (args, scope) => {
  if (args.length != 2 || args[0].type != "word") {
    throw new SyntaxError("Incorrect use of define");
  }
  let value = evaluate(args[1], scope);
  scope[args[0].name] = value;
  return value;
};
```

## The environment

{{index "Egg language", "evaluate function", [binding, "in Egg"]}}

The ((scope)) accepted by `evaluate` is an object with properties
whose names correspond to binding names and whose values correspond to
the values those bindings are bound to. Let's define an object to
represent the ((global scope)).

To be able to use the `if` construct we just defined, we must have
access to ((Boolean)) values. Since there are only two Boolean values,
we do not need special syntax for them. We simply bind two names to
the values `true` and `false` and use them.

```{includeCode: true}
const topScope = Object.create(null);

topScope.true = true;
topScope.false = false;
```

We can now evaluate a simple expression that negates a Boolean value.

```
let prog = parse(`if(true, false, true)`);
console.log(evaluate(prog, topScope));
// → false
```

{{index arithmetic, "Function constructor"}}

To supply basic ((arithmetic)) and ((comparison)) ((operator))s, we
will also add some function values to the ((scope)). In the interest
of keeping the code short, we'll use `Function` to synthesize a bunch
of operator functions in a loop, instead of defining them
individually.

```{includeCode: true}
for (let op of ["+", "-", "*", "/", "==", "<", ">"]) {
  topScope[op] = Function("a, b", `return a ${op} b;`);
}
```

A way to ((output)) values is also useful, so we'll wrap
`console.log` in a function and call it `print`.

```{includeCode: true}
topScope.print = value => {
  console.log(value);
  return value;
};
```

{{index parsing, "run function"}}

That gives us enough elementary tools to write simple programs. The
following function provides a convenient way to parse a program and
run it in a fresh scope:

```{includeCode: true}
function run(program) {
  return evaluate(parse(program), Object.create(topScope));
}
```

{{index "Object.create function", prototype}}

We'll use object prototype chains to represent nested scopes so that
the program can add bindings to its local scope without changing the
top-level scope.

```
run(`
do(define(total, 0),
   define(count, 1),
   while(<(count, 11),
         do(define(total, +(total, count)),
            define(count, +(count, 1)))),
   print(total))
`);
// → 55
```

{{index "summing example", "Egg language"}}

This is the program we've seen several times before, which computes
the sum of the numbers 1 to 10, expressed in Egg. It is clearly uglier
than the equivalent JavaScript program—but not bad for a language
implemented in less than 150 ((lines of code)).

{{id egg_fun}}

## Functions

{{index function, "Egg language"}}

A programming language without functions is a poor programming
language indeed.

Fortunately, it isn't hard to add a `fun` construct, which treats its
last argument as the function's body and uses all arguments before
that as the names of the function's parameters.

```{includeCode: true}
specialForms.fun = (args, scope) => {
  if (!args.length) {
    throw new SyntaxError("Functions need a body");
  }
  let body = args[args.length - 1];
  let params = args.slice(0, args.length - 1).map(expr => {
    if (expr.type != "word") {
      throw new SyntaxError("Parameter names must be words");
    }
    return expr.name;
  });

  return function() {
    if (arguments.length != params.length) {
      throw new TypeError("Wrong number of arguments");
    }
    let localScope = Object.create(scope);
    for (let i = 0; i < arguments.length; i++) {
      localScope[params[i]] = arguments[i];
    }
    return evaluate(body, localScope);
  };
};
```

{{index "local scope"}}

Functions in Egg get their own local scope. The function produced by
the `fun` form creates this local scope and adds the argument bindings
to it. It then evaluates the function body in this scope and returns
the result.

```{startCode: true}
run(`
do(define(plusOne, fun(a, +(a, 1))),
   print(plusOne(10)))
`);
// → 11

run(`
do(define(pow, fun(base, exp,
     if(==(exp, 0),
        1,
        *(base, pow(base, -(exp, 1)))))),
   print(pow(2, 10)))
`);
// → 1024
```

## Compilation

{{index interpretation, compilation}}

What we have built is an interpreter. During evaluation, it acts
directly on the representation of the program produced by the parser.

{{index efficiency, performance, [binding, definition], [memory, speed]}}

_Compilation_ is the process of adding another step between the
parsing and the running of a program, which transforms the program
into something that can be evaluated more efficiently by doing as much
work as possible in advance. For example, in well-designed languages
it is obvious, for each use of a binding, which binding is being
referred to, without actually running the program. This can be used to
avoid looking up the binding by name every time it is accessed,
instead directly fetching it from some predetermined memory
location.

Traditionally, ((compilation)) involves converting the program to
((machine code)), the raw format that a computer's processor can
execute. But any process that converts a program to a different
representation can be thought of as compilation.

{{index simplicity, "Function constructor", transpilation}}

It would be possible to write an alternative ((evaluation)) strategy
for Egg, one that first converts the program to a JavaScript program,
uses `Function` to invoke the JavaScript compiler on it, and then runs
the result. When done right, this would make Egg run very fast while
still being quite simple to implement.

If you are interested in this topic and willing to spend some time on
it, I encourage you to try to implement such a compiler as an
exercise.

## Cheating

{{index "Egg language"}}

When we defined `if` and `while`, you probably noticed that they were
more or less trivial wrappers around JavaScript's own `if` and
`while`. Similarly, the values in Egg are just regular old JavaScript
values.

If you compare the implementation of Egg, built on top of JavaScript,
with the amount of work and complexity required to build a programming
language directly on the raw functionality provided by a machine, the
difference is huge. Regardless, this example ideally gave you an
impression of the way ((programming language))s work.

And when it comes to getting something done, cheating is more
effective than doing everything yourself. Though the toy language in
this chapter doesn't do anything that couldn't be done better in
JavaScript, there _are_ situations where writing small languages helps
get real work done.

Such a language does not have to resemble a typical programming
language. If JavaScript didn't come equipped with regular expressions,
for example, you could write your own parser and evaluator for regular
expressions.

{{index "artificial intelligence"}}

Or imagine you are building a giant robotic ((dinosaur)) and need to
program its ((behavior)). JavaScript might not be the most effective
way to do this. You might instead opt for a language that looks like
this:

```{lang: null}
behavior walk
  perform when
    destination ahead
  actions
    move left-foot
    move right-foot

behavior attack
  perform when
    Godzilla in-view
  actions
    fire laser-eyes
    launch arm-rockets
```

{{index expressivity}}

This is what is usually called a _((domain-specific language))_, a
language tailored to express a narrow domain of knowledge. Such a
language can be more expressive than a general-purpose language
because it is designed to describe exactly the things that need to be
described in its domain, and nothing else.

## Exercises

### Arrays

{{index "Egg language", "arrays in egg (exercise)", [array, "in Egg"]}}

Add support for arrays to Egg by adding the following three
functions to the top scope: `array(...values)` to construct an array
containing the argument values, `length(array)` to get an array's
length, and `element(array, n)` to fetch the n^th^ element from an
array.

{{if interactive

```{test: no}
// Modify these definitions...

topScope.array = "...";

topScope.length = "...";

topScope.element = "...";

run(`
do(define(sum, fun(array,
     do(define(i, 0),
        define(sum, 0),
        while(<(i, length(array)),
          do(define(sum, +(sum, element(array, i))),
             define(i, +(i, 1)))),
        sum))),
   print(sum(array(1, 2, 3))))
`);
// → 6
```

if}}

{{hint

{{index "arrays in egg (exercise)"}}

The easiest way to do this is to represent Egg arrays with JavaScript
arrays.

{{index "slice method"}}

The values added to the top scope must be functions. By using a rest
argument (with triple-dot notation), the definition of `array` can be
_very_ simple.

hint}}

### Closure

{{index closure, [function, scope], "closure in egg (exercise)"}}

The way we have defined `fun` allows functions in Egg to reference
the surrounding scope, allowing the function's body to use local
values that were visible at the time the function was defined, just
like JavaScript functions do.

The following program illustrates this: function `f` returns a
function that adds its argument to `f`'s argument, meaning that it
needs access to the local ((scope)) inside `f` to be able to use
binding `a`.

```
run(`
do(define(f, fun(a, fun(b, +(a, b)))),
   print(f(4)(5)))
`);
// → 9
```

Go back to the definition of the `fun` form and explain which
mechanism causes this to work.

{{hint

{{index closure, "closure in egg (exercise)"}}

Again, we are riding along on a JavaScript mechanism to get the
equivalent feature in Egg. Special forms are passed the local scope in
which they are evaluated so that they can evaluate their subforms in
that scope. The function returned by `fun` has access to the `scope`
argument given to its enclosing function and uses that to create the
function's local ((scope)) when it is called.

{{index compilation}}

This means that the ((prototype)) of the local scope will be the scope
in which the function was created, which makes it possible to access
bindings in that scope from the function. This is all there is to
implementing closure (though to compile it in a way that is actually
efficient, you'd need to do some more work).

hint}}

### Comments

{{index "hash character", "Egg language", "comments in egg (exercise)"}}

It would be nice if we could write ((comment))s in Egg. For example,
whenever we find a hash sign (`#`), we could treat the rest of the
line as a comment and ignore it, similar to `//` in JavaScript.

{{index "skipSpace function"}}

We do not have to make any big changes to the parser to support this.
We can simply change `skipSpace` to skip comments as if they are
((whitespace)) so that all the points where `skipSpace` is called will
now also skip comments. Make this change.

{{if interactive

```{test: no}
// This is the old skipSpace. Modify it...
function skipSpace(string) {
  let first = string.search(/\S/);
  if (first == -1) return "";
  return string.slice(first);
}

console.log(parse("# hello\nx"));
// → {type: "word", name: "x"}

console.log(parse("a # one\n   # two\n()"));
// → {type: "apply",
//    operator: {type: "word", name: "a"},
//    args: []}
```
if}}

{{hint

{{index "comments in egg (exercise)", [whitespace, syntax]}}

Make sure your solution handles multiple comments in a row, with
potentially whitespace between or after them.

A ((regular expression)) is probably the easiest way to solve this.
Write something that matches "whitespace or a comment, zero or more
times". Use the `exec` or `match` method and look at the length of the
first element in the returned array (the whole match) to find out how
many characters to slice off.

hint}}

### Fixing scope

{{index [binding, definition], assignment, "fixing scope (exercise)"}}

Currently, the only way to assign a binding a value is `define`.
This construct acts as a way both to define new bindings and to give
existing ones a new value.

{{index "local binding"}}

This ((ambiguity)) causes a problem. When you try to give a nonlocal
binding a new value, you will end up defining a local one with the
same name instead. Some languages work like this by design, but I've
always found it an awkward way to handle ((scope)).

{{index "ReferenceError type"}}

Add a special form `set`, similar to `define`, which gives a binding a
new value, updating the binding in an outer scope if it doesn't
already exist in the inner scope. If the binding is not defined at
all, throw a `ReferenceError` (another standard error type).

{{index "hasOwnProperty method", prototype, "getPrototypeOf function"}}

The technique of representing scopes as simple objects, which has made
things convenient so far, will get in your way a little at this point.
You might want to use the `Object.getPrototypeOf` function, which
returns the prototype of an object. Also remember that scopes do not
derive from `Object.prototype`, so if you want to call
`hasOwnProperty` on them, you have to use this clumsy expression:

```{test: no}
Object.prototype.hasOwnProperty.call(scope, name);
```

{{if interactive

```{test: no}
specialForms.set = (args, scope) => {
  // Your code here.
};

run(`
do(define(x, 4),
   define(setx, fun(val, set(x, val))),
   setx(50),
   print(x))
`);
// → 50
run(`set(quux, true)`);
// → Some kind of ReferenceError
```
if}}

{{hint

{{index [binding, "compilation of"], assignment, "getPrototypeOf function", "hasOwnProperty method", "fixing scope (exercise)"}}

You will have to loop through one ((scope)) at a time, using
`Object.getPrototypeOf` to go to the next outer scope. For each scope,
use `hasOwnProperty` to find out whether the binding, indicated by the
`name` property of the first argument to `set`, exists in that scope.
If it does, set it to the result of evaluating the second argument to
`set` and then return that value.

{{index "global scope", "run-time error"}}

If the outermost scope is reached (`Object.getPrototypeOf` returns
null) and we haven't found the binding yet, it doesn't exist, and an
error should be thrown.

hint}}
# JavaScript and the Browser

{{quote {author: "Tim Berners-Lee", title: "The World Wide Web: A very short personal history", chapter: true}

The dream behind the Web is of a common information space in which we
communicate by sharing information. Its universality is essential: the
fact that a hypertext link can point to anything, be it personal,
local or global, be it draft or highly polished.

quote}}

{{index "Berners-Lee, Tim", "World Wide Web", HTTP, [JavaScript, "history of"], "World Wide Web"}}

{{figure {url: "img/chapter_picture_13.jpg", alt: "Picture of a telephone switchboard", chapter: "framed"}}}

The next chapters of this book will talk about web browsers. Without
web ((browser))s, there would be no JavaScript. Or even if there were,
no one would ever have paid any attention to it.

{{index decentralization, compatibility}}

Web technology has been decentralized from the start, not just
technically but also in the way it evolved. Various browser vendors
have added new functionality in ad hoc and sometimes poorly thought-out
ways, which then, sometimes, ended up being adopted by others—and
finally set down as in ((standards)).

This is both a blessing and a curse. On the one hand, it is empowering
to not have a central party control a system but have it be improved
by various parties working in loose ((collaboration)) (or occasionally
open hostility). On the other hand, the haphazard way in which the Web
was developed means that the resulting system is not exactly a shining
example of internal ((consistency)). Some parts of it are downright
confusing and poorly conceived.

## Networks and the Internet

Computer ((network))s have been around since the 1950s. If you put
cables between two or more computers and allow them to send data back
and forth through these cables, you can do all kinds of wonderful
things.

And if connecting two machines in the same building allows us to do
wonderful things, connecting machines all over the planet should be
even better. The technology to start implementing this vision was
developed in the 1980s, and the resulting network is called the
_((Internet))_. It has lived up to its promise.

A computer can use this network to shoot bits at another computer. For
any effective ((communication)) to arise out of this bit-shooting, the
computers on both ends must know what the bits are supposed to
represent. The meaning of any given sequence of bits depends entirely
on the kind of thing that it is trying to express and on the
((encoding)) mechanism used.

{{index [network, protocol]}}

A _network ((protocol))_ describes a style of communication over a
((network)). There are protocols for sending email, for fetching email,
for sharing files, and even for controlling computers that happen to be
infected by malicious software.

{{indexsee "Hypertext Transfer Protocol", HTTP}}

For example, the _Hypertext Transfer Protocol_ (((HTTP))) is
a protocol for retrieving named ((resource))s (chunks of information,
such as web pages or pictures). It specifies that the side making the
request should start with a line like this, naming the resource and
the version of the protocol that it is trying to use:

```{lang: "text/plain"}
GET /index.html HTTP/1.1
```

There are a lot more rules about the way the requester can include more
information in the ((request)) and the way the other side, which
returns the resource, packages up its content. We'll look at HTTP in a
little more detail in [Chapter ?](http).

{{index layering, stream, ordering}}

Most protocols are built on top of other protocols. HTTP treats the
network as a streamlike device into which you can put bits and have
them arrive at the correct destination in the correct order. As we saw
in [Chapter ?](async), ensuring those things is already a rather
difficult problem.

{{index TCP}}

{{indexsee "Transmission Control Protocol", TCP}}

The _Transmission Control Protocol_ (TCP) is a ((protocol)) that
addresses this problem. All Internet-connected devices "speak" it, and
most communication on the ((Internet)) is built on top of it.

{{index "listening (TCP)"}}

A TCP ((connection)) works as follows: one computer must be waiting,
or _listening_, for other computers to start talking to it. To be able
to listen for different kinds of communication at the same time on a
single machine, each listener has a number (called a _((port))_)
associated with it. Most ((protocol))s specify which port should be
used by default. For example, when we want to send an email using the
((SMTP)) protocol, the machine through which we send it is expected to
be listening on port 25.

Another computer can then establish a ((connection)) by connecting to
the target machine using the correct port number. If the target
machine can be reached and is listening on that port, the connection
is successfully created. The listening computer is called the
_((server))_, and the connecting computer is called the _((client))_.

{{index [abtraction, "of the network"]}}

Such a connection acts as a two-way ((pipe)) through which bits can
flow—the machines on both ends can put data into it. Once the bits are
successfully transmitted, they can be read out again by the machine on
the other side. This is a convenient model. You could say that ((TCP))
provides an abstraction of the network.

{{id web}}

## The Web

The _((World Wide Web))_ (not to be confused with the ((Internet)) as
a whole) is a set of ((protocol))s and formats that allow us to visit
web pages in a browser. The "Web" part in the name refers to the fact
that such pages can easily link to each other, thus connecting into a
huge ((mesh)) that users can move through.

To become part of the Web, all you need to do is connect a machine to
the ((Internet)) and have it listen on port 80 with the ((HTTP))
protocol so that other computers can ask it for documents.

{{index URL}}

{{indexsee "Uniform Resource Locator", URL}}

Each ((document)) on the Web is named by a _Uniform Resource Locator_
(URL), which looks something like this:

```{lang: null}
  http://eloquentjavascript.net/13_browser.html
 |      |                      |               |
 protocol       server               path
```

{{index HTTPS}}

The first part tells us that this URL uses the HTTP ((protocol)) (as
opposed to, for example, encrypted HTTP, which would be _https://_).
Then comes the part that identifies which ((server)) we are requesting
the document from. Last is a path string that identifies the specific
document (or _((resource))_) we are interested in.

Machines connected to the Internet get an _((IP address))_, which is a
number that can be used to send messages to that machine, and looks
something like `149.210.142.219` or `2001:4860:4860::8888`. But lists
of more or less random numbers are hard to remember and awkward to
type, so you can instead register a _((domain)) name_ for a specific
address or set of addresses. I registered _eloquentjavascript.net_ to
point at the IP address of a machine I control and can thus use that
domain name to serve web pages.

{{index browser}}

If you type this URL into your browser's ((address bar)), the browser
will try to retrieve and display the ((document)) at that URL. First,
your browser has to find out what address _eloquentjavascript.net_
refers to. Then, using the ((HTTP)) protocol, it will make a
connection to the server at that address and ask for the resource
_/13_browser.html_. If all goes well, the server sends back a
document, which your browser then displays on your screen.

## HTML

{{index HTML}}

{{indexsee "Hypertext Markup Language", HTML}}

HTML, which stands for _Hypertext Markup Language_, is the document
format used for web pages. An HTML document contains ((text)), as well
as _((tag))s_ that give structure to the text, describing things such
as links, paragraphs, and headings.

A short HTML document might look like this:

```{lang: "text/html"}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>My home page</title>
  </head>
  <body>
    <h1>My home page</h1>
    <p>Hello, I am Marijn and this is my home page.</p>
    <p>I also wrote a book! Read it
      <a href="http://eloquentjavascript.net">here</a>.</p>
  </body>
</html>
```

{{if book

This is what such a document would look like in the browser:

{{figure {url: "img/home-page.png", alt: "My home page",width: "6.3cm"}}}

if}}

{{index [HTML, notation]}}

The tags, wrapped in ((angle brackets)) (`<` and `>`, the symbols for
_less than_ and _greater than_), provide information about the
((structure)) of the document. The other ((text)) is just plain text.

{{index doctype, version}}

The document starts with `<!doctype html>`, which tells the browser to
interpret the page as _modern_ HTML, as opposed to various dialects
that were in use in the past.

{{index "head (HTML tag)", "body (HTML tag)", "title (HTML tag)", "h1 (HTML tag)", "p (HTML tag)"}}

HTML documents have a head and a body. The head contains information
_about_ the document, and the body contains the document itself. In
this case, the head declares that the title of this document is "My
home page" and that it uses the UTF-8 encoding, which is a way to
encode Unicode text as binary data. The document's body contains a
heading (`<h1>`, meaning "heading 1"—`<h2>` to `<h6>` produce
subheadings) and two ((paragraph))s (`<p>`).

{{index "href attribute", "a (HTML tag)"}}

Tags come in several forms. An ((element)), such as the body, a
paragraph, or a link, is started by an _((opening tag))_ like `<p>`
and ended by a _((closing tag))_ like `</p>`. Some opening tags, such
as the one for the ((link)) (`<a>`), contain extra information in the
form of `name="value"` pairs. These are called _((attribute))s_. In
this case, the destination of the link is indicated with
`href="http://eloquentjavascript.net"`, where `href` stands for
"hypertext reference".

{{index "src attribute", "self-closing tag", "img (HTML tag)"}}

Some kinds of ((tag))s do not enclose anything and thus do not need to
be closed. The metadata tag `<meta charset="utf-8">` is an example of
this.

{{index [escaping, "in HTML"]}}

To be able to include ((angle brackets)) in the text of a document,
even though they have a special meaning in HTML, yet another form of
special notation has to be introduced. A plain opening angle bracket
is written as `&lt;` ("less than"), and a closing bracket is written
as `&gt;` ("greater than"). In HTML, an ampersand (`&`) character
followed by a name or character code and a semicolon (`;`) is called an _((entity))_
and will be replaced by the character it encodes.

{{index ["backslash character", "in strings"], "ampersand character", "double-quote character"}}

This is analogous to the way backslashes are used in JavaScript
strings. Since this mechanism gives ampersand characters a special
meaning, too, they need to be escaped as `&amp;`. Inside attribute
values, which are wrapped in double quotes, `&quot;` can be used to
insert an actual quote character.

{{index "error tolerance", parsing}}

HTML is parsed in a remarkably error-tolerant way. When tags that
should be there are missing, the browser reconstructs them. The way in
which this is done has been standardized, and you can rely on all
modern browsers to do it in the same way.

The following document will be treated just like the one shown previously:

```{lang: "text/html"}
<!doctype html>

<meta charset=utf-8>
<title>My home page</title>

<h1>My home page</h1>
<p>Hello, I am Marijn and this is my home page.
<p>I also wrote a book! Read it
  <a href=http://eloquentjavascript.net>here</a>.
```

{{index "title (HTML tag)", "head (HTML tag)", "body (HTML tag)", "html (HTML tag)"}}

The `<html>`, `<head>`, and `<body>` tags are gone completely. The
browser knows that `<meta>` and `<title>` belong in the head and that
`<h1>` means the body has started. Furthermore, I am no longer
explicitly closing the paragraphs since opening a new paragraph or
ending the document will close them implicitly. The quotes around the
attribute values are also gone.

This book will usually omit the `<html>`, `<head>`, and `<body>` tags
from examples to keep them short and free of clutter. But I _will_
close tags and include quotes around attributes.

{{index browser}}

I will also usually omit the ((doctype)) and `charset` declaration.
This is not to be taken as an encouragement to drop these from HTML
documents. Browsers will often do ridiculous things when you forget
them. You should consider the doctype and the `charset` metadata
to be implicitly present in examples, even when they are not actually shown
in the text.

{{id script_tag}}

## HTML and JavaScript

{{index [JavaScript, "in HTML"], "script (HTML tag)"}}

In the context of this book, the most important HTML tag is
`<script>`. This tag allows us to include a piece of JavaScript in a
document.

```{lang: "text/html"}
<h1>Testing alert</h1>
<script>alert("hello!");</script>
```

{{index "alert function", timeline}}

Such a script will run as soon as its `<script>` tag is encountered
while the browser reads the HTML. This page will pop up a dialog when
opened—the `alert` function resembles `prompt`, in that it pops up a
little window, but only shows a message without asking for input.

{{index "src attribute"}}

Including large programs directly in HTML documents is often
impractical. The `<script>` tag can be given an `src` attribute  to fetch a script file (a text file containing a JavaScript
program) from a URL.

```{lang: "text/html"}
<h1>Testing alert</h1>
<script src="code/hello.js"></script>
```

The _code/hello.js_ file included here contains the same
program—`alert("hello!")`. When an HTML page references other URLs as
part of itself—for example, an image file or a script—web browsers
will retrieve them immediately and include them in the page.

{{index "script (HTML tag)", "closing tag"}}

A script tag must always be closed with `</script>`, even if it refers
to a script file and doesn't contain any code. If you forget this, the
rest of the page will be interpreted as part of the script.

{{index "relative path", dependency}}

You can load ((ES modules)) (see [Chapter ?](modules#es)) in the
browser by giving your script tag a `type="module"` attribute. Such
modules can depend on other modules by using ((URL))s relative to
themselves as module names in `import` declarations.

{{index "button (HTML tag)", "onclick attribute"}}

Some attributes can also contain a JavaScript program. The `<button>`
tag shown next (which shows up as a button) has an `onclick`
attribute. The attribute's value will be run whenever the button is
clicked.

```{lang: "text/html"}
<button onclick="alert('Boom!');">DO NOT PRESS</button>
```

{{index "single-quote character", [escaping, "in HTML"]}}

Note that I had to use single quotes for the string in the `onclick`
attribute because double quotes are already used to quote the whole
attribute. I could also have used `&quot;`.

## In the sandbox

{{index "malicious script", "World Wide Web", browser, website, security}}

Running programs downloaded from the ((Internet)) is potentially
dangerous. You do not know much about the people behind most sites you
visit, and they do not necessarily mean well. Running programs by
people who do not mean well is how you get your computer infected by
((virus))es, your data stolen, and your accounts hacked.

Yet the attraction of the Web is that you can browse it without
necessarily ((trust))ing all the pages you visit. This is why browsers
severely limit the things a JavaScript program may do: it can't look
at the files on your computer or modify anything not related to the
web page it was embedded in.

{{index isolation}}

Isolating a programming environment in this way is called
_((sandbox))ing_, the idea being that the program is harmlessly
playing in a sandbox. But you should imagine this particular kind of
sandbox as having a cage of thick steel bars over it so that the
programs playing in it can't actually get out.

The hard part of sandboxing is allowing the programs enough room to be
useful yet at the same time restricting them from doing anything
dangerous. Lots of useful functionality, such as communicating with
other servers or reading the content of the copy-paste ((clipboard)),
can also be used to do problematic, ((privacy))-invading things.

{{index leak, exploit, security}}

Every now and then, someone comes up with a new way to circumvent the
limitations of a ((browser)) and do something harmful, ranging from
leaking minor private information to taking over the whole machine
that the browser runs on. The browser developers respond by fixing the
hole, and all is well again—until the next problem is discovered, and
hopefully publicized, rather than secretly exploited by some
government agency or ((mafia)).

## Compatibility and the browser wars

{{index Microsoft, "World Wide Web"}}

In the early stages of the Web, a browser called ((Mosaic)) dominated
the market. After a few years, the balance shifted to
((Netscape)), which was then, in turn, largely supplanted by
Microsoft's ((Internet Explorer)). At any point where a single
((browser)) was dominant, that browser's vendor would feel entitled to
unilaterally invent new features for the Web. Since most users used
the most popular browser, ((website))s would simply start using those
features—never mind the other browsers.

This was the dark age of ((compatibility)), often called the
_((browser wars))_. Web developers were left with not one unified Web
but two or three incompatible platforms. To make things worse, the
browsers in use around 2003 were all full of ((bug))s, and of course
the bugs were different for each ((browser)). Life was hard for people
writing web pages.

{{index Apple, "Internet Explorer", Mozilla}}

Mozilla ((Firefox)), a not-for-profit offshoot of ((Netscape)),
challenged Internet Explorer's position in the late 2000s. Because
((Microsoft)) was not particularly interested in staying competitive
at the time, Firefox took a lot of market share away from it. Around
the same time, ((Google)) introduced its ((Chrome)) browser, and
Apple's ((Safari)) browser gained popularity, leading to a situation
where there were four major players, rather than one.

{{index compatibility}}

The new players had a more serious attitude toward ((standards)) and
better ((engineering)) practices, giving us less incompatibility and
fewer ((bug))s. Microsoft, seeing its market share crumble, came
around and adopted these attitudes in its Edge browser, which replaces
Internet Explorer. If you are starting to learn web development today,
consider yourself lucky. The latest versions of the major browsers
behave quite uniformly and have relatively few bugs.
# The Document Object Model

{{quote {author: "Friedrich Nietzsche", title: "Beyond Good and Evil", chapter: true}

Too bad! Same old story! Once you've finished building your house you
notice you've accidentally learned something that you really should
have known—before you started.

quote}}

{{figure {url: "img/chapter_picture_14.jpg", alt: "Picture of a tree with letters and scripts hanging from its branches", chapter: "framed"}}}

{{index drawing, parsing}}

When you open a web page in your browser, the browser retrieves the
page's ((HTML)) text and parses it, much like the way our parser from
[Chapter ?](language#parsing) parsed programs. The browser builds up a
model of the document's ((structure)) and uses this model to draw the
page on the screen.

{{index "live data structure"}}

This representation of the ((document)) is one of the toys that a
JavaScript program has available in its ((sandbox)). It is a ((data
structure)) that you can read or modify. It acts as a _live_ data
structure: when it's modified, the page on the screen is updated to
reflect the changes.

## Document structure

{{index [HTML, structure]}}

You can imagine an HTML document as a nested set of ((box))es.
Tags such as `<body>` and `</body>` enclose other ((tag))s, which in
turn contain other tags or ((text)). Here's the example document from
the [previous chapter](browser):

```{lang: "text/html", sandbox: "homepage"}
<!doctype html>
<html>
  <head>
    <title>My home page</title>
  </head>
  <body>
    <h1>My home page</h1>
    <p>Hello, I am Marijn and this is my home page.</p>
    <p>I also wrote a book! Read it
      <a href="http://eloquentjavascript.net">here</a>.</p>
  </body>
</html>
```

This page has the following structure:

{{figure {url: "img/html-boxes.svg", alt: "HTML document as nested boxes", width: "7cm"}}}

{{indexsee "Document Object Model", DOM}}

The data structure the browser uses to represent the document follows
this shape. For each box, there is an object, which we can
interact with to find out things such as what HTML tag it represents
and which boxes and text it contains. This representation is called
the _Document Object Model_, or ((DOM)) for short.

{{index "documentElement property", "head property", "body property", "html (HTML tag)", "body (HTML tag)", "head (HTML tag)"}}

The global binding `document` gives us access to these objects. Its
`documentElement` property refers to the object representing the
`<html>` tag. Since every HTML document has a head and a body, it also
has `head` and `body` properties, pointing at those elements.

## Trees

{{index [nesting, "of objects"]}}

Think back to the ((syntax tree))s from [Chapter ?](language#parsing)
for a moment. Their structures are strikingly similar to the structure
of a browser's document. Each _((node))_ may refer to other nodes,
_children_, which in turn may have their own children. This shape is
typical of nested structures where elements can contain subelements
that are similar to themselves.

{{index "documentElement property", [DOM, tree]}}

We call a data structure a _((tree))_ when it has a branching
structure, has no ((cycle))s (a node may not contain itself, directly
or indirectly), and has a single, well-defined _((root))_. In the case
of the DOM, `document.documentElement` serves as the root.

{{index sorting, ["data structure", "tree"], "syntax tree"}}

Trees come up a lot in computer science. In addition to representing
recursive structures such as HTML documents or programs, they are
often used to maintain sorted ((set))s of data because elements can
usually be found or inserted more efficiently in a tree than in a flat
array.

{{index "leaf node", "Egg language"}}

A typical tree has different kinds of ((node))s. The syntax tree for
[the Egg language](language) had identifiers, values, and application
nodes. Application nodes may have children, whereas identifiers and
values are _leaves_, or nodes without children.

{{index "body property", [HTML, structure]}}

The same goes for the DOM. Nodes for _((element))s_, which represent
HTML tags, determine the structure of the document. These can have
((child node))s. An example of such a node is `document.body`. Some of
these children can be ((leaf node))s, such as pieces of ((text)) or
((comment)) nodes.

{{index "text node", element, "ELEMENT_NODE code", "COMMENT_NODE code", "TEXT_NODE code", "nodeType property"}}

Each DOM node object has a `nodeType` property, which contains a code
(number) that identifies the type of node. Elements have code 1, which
is also defined as the constant property `Node.ELEMENT_NODE`. Text
nodes, representing a section of text in the document, get code 3
(`Node.TEXT_NODE`). Comments have code 8
(`Node.COMMENT_NODE`).

Another way to visualize our document ((tree)) is as follows:

{{figure {url: "img/html-tree.svg", alt: "HTML document as a tree",width: "8cm"}}}

The leaves are text nodes, and the arrows indicate parent-child
relationships between nodes.

{{id standard}}

## The standard

{{index "programming language", [interface, design], [DOM, interface]}}

Using cryptic numeric codes to represent node types is not a very
JavaScript-like thing to do. Later in this chapter, we'll see that
other parts of the DOM interface also feel cumbersome and alien.
The reason for this is that the DOM wasn't designed for just
JavaScript. Rather, it tries to be a language-neutral interface
that can be used in other systems as well—not just for HTML but also
for ((XML)), which is a generic ((data format)) with an HTML-like
syntax.

{{index consistency, integration}}

This is unfortunate. Standards are often useful. But in this case, the
advantage (cross-language consistency) isn't all that compelling.
Having an interface that is properly integrated with the language you
are using will save you more time than having a familiar interface
across languages.

{{index "array-like object", "NodeList type"}}

As an example of this poor integration, consider the `childNodes`
property that element nodes in the DOM have. This property holds an
array-like object, with a `length` property and properties labeled by
numbers to access the child nodes. But it is an instance of the
`NodeList` type, not a real array, so it does not have methods such as
`slice` and `map`.

{{index [interface, design], [DOM, construction], "side effect"}}

Then there are issues that are simply poor design. For example, there
is no way to create a new node and immediately add children or
((attribute))s to it. Instead, you have to first create it and then add
the children and attributes one by one, using side effects. Code that
interacts heavily with the DOM tends to get long, repetitive, and
ugly.

{{index library}}

But these flaws aren't fatal. Since JavaScript allows us to create our
own ((abstraction))s, it is possible to design improved ways to
express the operations you are performing. Many libraries intended for
browser programming come with such tools.

## Moving through the tree

{{index pointer}}

DOM nodes contain a wealth of ((link))s to other nearby nodes. The
following diagram illustrates these:

{{figure {url: "img/html-links.svg", alt: "Links between DOM nodes",width: "6cm"}}}

{{index "child node", "parentNode property", "childNodes property"}}

Although the diagram shows only one link of each type, every node has
a `parentNode` property that points to the node it is part of, if any.
Likewise, every element node (node type 1) has a `childNodes` property
that points to an ((array-like object)) holding its children.

{{index "firstChild property", "lastChild property", "previousSibling property", "nextSibling property"}}

In theory, you could move anywhere in the tree using just these parent
and child links. But JavaScript also gives you access to a number of
additional convenience links. The `firstChild` and `lastChild`
properties point to the first and last child elements or have the
value `null` for nodes without children. Similarly, `previousSibling`
and `nextSibling` point to adjacent nodes, which are nodes with the
same parent that appear immediately before or after the node itself.
For a first child, `previousSibling` will be null, and for a last
child, `nextSibling` will be null.

{{index "children property", "text node", element}}

There's also the `children` property, which is like `childNodes` but
contains only element (type 1) children, not other types of
child nodes. This can be useful when you aren't interested in text
nodes.

{{index "talksAbout function", recursion, [nesting, "of objects"]}}

When dealing with a nested data structure like this one, recursive
functions are often useful. The following function scans a document
for ((text node))s containing a given string and returns `true` when
it has found one:

{{id talksAbout}}

```{sandbox: "homepage"}
function talksAbout(node, string) {
  if (node.nodeType == Node.ELEMENT_NODE) {
    for (let child of node.childNodes) {
      if (talksAbout(child, string)) {
        return true;
      }
    }
    return false;
  } else if (node.nodeType == Node.TEXT_NODE) {
    return node.nodeValue.indexOf(string) > -1;
  }
}

console.log(talksAbout(document.body, "book"));
// → true
```

{{index "nodeValue property"}}

The `nodeValue` property of a text node holds the string of text that
it represents.

## Finding elements

{{index [DOM, querying], "body property", "hard-coding", [whitespace, "in HTML"]}}

Navigating these ((link))s among parents, children, and siblings is
often useful. But if we want to find a specific node in the document,
reaching it by starting at `document.body` and following a fixed path
of properties is a bad idea. Doing so bakes assumptions into our
program about the precise structure of the document—a structure you
might want to change later. Another complicating factor is that text
nodes are created even for the whitespace between nodes. The
example document's `<body>` tag does not have just three children (`<h1>`
and two `<p>` elements) but actually has seven: those three, plus the
spaces before, after, and between them.

{{index "search problem", "href attribute", "getElementsByTagName method"}}

So if we want to get the `href` attribute of the link in that
document, we don't want to say something like "Get the second child of
the sixth child of the document body". It'd be better if we could say
"Get the first link in the document". And we can.

```{sandbox: "homepage"}
let link = document.body.getElementsByTagName("a")[0];
console.log(link.href);
```

{{index "child node"}}

All element nodes have a `getElementsByTagName` method, which collects
all elements with the given tag name that are descendants (direct or
indirect children) of that node and returns them as an ((array-like
object)).

{{index "id attribute", "getElementById method"}}

To find a specific _single_ node, you can give it an `id` attribute
and use `document.getElementById` instead.

```{lang: "text/html"}
<p>My ostrich Gertrude:</p>
<p><img id="gertrude" src="img/ostrich.png"></p>

<script>
  let ostrich = document.getElementById("gertrude");
  console.log(ostrich.src);
</script>
```

{{index "getElementsByClassName method", "class attribute"}}

A third, similar method is `getElementsByClassName`, which, like
`getElementsByTagName`, searches through the contents of an element
node and retrieves all elements that have the given string in their
`class` attribute.

## Changing the document

{{index "side effect", "removeChild method", "appendChild method", "insertBefore method", [DOM, construction], [DOM, modification]}}

Almost everything about the DOM data structure can be changed. The
shape of the document tree can be modified by changing parent-child
relationships. Nodes have a `remove` method to remove them from their
current parent node. To add a child node to an element node, we can
use `appendChild`, which puts it at the end of the list of children,
or `insertBefore`, which inserts the node given as the first argument
before the node given as the second argument.

```{lang: "text/html"}
<p>One</p>
<p>Two</p>
<p>Three</p>

<script>
  let paragraphs = document.body.getElementsByTagName("p");
  document.body.insertBefore(paragraphs[2], paragraphs[0]);
</script>
```

A node can exist in the document in only one place. Thus, inserting
paragraph _Three_ in front of paragraph _One_ will first remove it
from the end of the document and then insert it at the front,
resulting in _Three_/_One_/_Two_. All operations that insert a node
somewhere will, as a ((side effect)), cause it to be removed from its
current position (if it has one).

{{index "insertBefore method", "replaceChild method"}}

The `replaceChild` method is used to replace a child node with another
one. It takes as arguments two nodes: a new node and the node to be
replaced. The replaced node must be a child of the element the method
is called on. Note that both `replaceChild` and `insertBefore` expect
the _new_ node as their first argument.

## Creating nodes

{{index "alt attribute", "img (HTML tag)"}}

Say we want to write a script that replaces all ((image))s (`<img>`
tags) in the document with the text held in their `alt` attributes,
which specifies an alternative textual representation of the image.

{{index "createTextNode method"}}

This involves not only removing the images but adding a new text node
to replace them. Text nodes are created with the
`document.createTextNode` method.

```{lang: "text/html"}
<p>The <img src="img/cat.png" alt="Cat"> in the
  <img src="img/hat.png" alt="Hat">.</p>

<p><button onclick="replaceImages()">Replace</button></p>

<script>
  function replaceImages() {
    let images = document.body.getElementsByTagName("img");
    for (let i = images.length - 1; i >= 0; i--) {
      let image = images[i];
      if (image.alt) {
        let text = document.createTextNode(image.alt);
        image.parentNode.replaceChild(text, image);
      }
    }
  }
</script>
```

{{index "text node"}}

Given a string, `createTextNode` gives us a text node that we can
insert into the document to make it show up on the screen.

{{index "live data structure", "getElementsByTagName method", "childNodes property"}}

The loop that goes over the images starts at the end of the list. This
is necessary because the node list returned by a method like
`getElementsByTagName` (or a property like `childNodes`) is _live_.
That is, it is updated as the document changes. If we started from the
front, removing the first image would cause the list to lose its first
element so that the second time the loop repeats, where `i` is 1, it
would stop because the length of the collection is now also 1.

{{index "slice method"}}

If you want a _solid_ collection of nodes, as opposed to a live one,
you can convert the collection to a real array by calling
`Array.from`.

```
let arrayish = {0: "one", 1: "two", length: 2};
let array = Array.from(arrayish);
console.log(array.map(s => s.toUpperCase()));
// → ["ONE", "TWO"]
```

{{index "createElement method"}}

To create ((element)) nodes, you can use the `document.createElement`
method. This method takes a tag name and returns a new empty node of
the given type.

{{index "Popper, Karl", [DOM, construction], "elt function"}}

{{id elt}}

The following example defines a utility `elt`, which creates an
element node and treats the rest of its arguments as children to that
node. This function is then used to add an attribution to a quote.

```{lang: "text/html"}
<blockquote id="quote">
  No book can ever be finished. While working on it we learn
  just enough to find it immature the moment we turn away
  from it.
</blockquote>

<script>
  function elt(type, ...children) {
    let node = document.createElement(type);
    for (let child of children) {
      if (typeof child != "string") node.appendChild(child);
      else node.appendChild(document.createTextNode(child));
    }
    return node;
  }

  document.getElementById("quote").appendChild(
    elt("footer", "—",
        elt("strong", "Karl Popper"),
        ", preface to the second edition of ",
        elt("em", "The Open Society and Its Enemies"),
        ", 1950"));
</script>
```

{{if book

This is what the resulting document looks like:

{{figure {url: "img/blockquote.png", alt: "A blockquote with attribution",width: "8cm"}}}

if}}

## Attributes

{{index "href attribute", [DOM, attributes]}}

Some element ((attribute))s, such as `href` for links, can be accessed
through a property of the same name on the element's ((DOM))
object. This is the case for most commonly used standard attributes.

{{index "data attribute", "getAttribute method", "setAttribute method", attribute}}

But HTML allows you to set any attribute you want on nodes. This can
be useful because it allows you to store extra information in a
document. If you make up your own attribute names, though, such
attributes will not be present as properties on the element's node.
Instead, you have to use the `getAttribute` and `setAttribute` methods
to work with them.

```{lang: "text/html"}
<p data-classified="secret">The launch code is 00000000.</p>
<p data-classified="unclassified">I have two feet.</p>

<script>
  let paras = document.body.getElementsByTagName("p");
  for (let para of Array.from(paras)) {
    if (para.getAttribute("data-classified") == "secret") {
      para.remove();
    }
  }
</script>
```

It is recommended to prefix the names of such made-up attributes with
`data-` to ensure they do not conflict with any other attributes.

{{index "getAttribute method", "setAttribute method", "className property", "class attribute"}}

There is a commonly used attribute, `class`, which is a ((keyword)) in
the JavaScript language. For historical reasons—some old JavaScript
implementations could not handle property names that matched
keywords—the property used to access this attribute is called
`className`. You can also access it under its real name, `"class"`, by
using the `getAttribute` and `setAttribute` methods.

## Layout

{{index layout, "block element", "inline element", "p (HTML tag)", "h1 (HTML tag)", "a (HTML tag)", "strong (HTML tag)"}}

You may have noticed that different types of elements are laid out
differently. Some, such as paragraphs (`<p>`) or headings (`<h1>`),
take up the whole width of the document and are rendered on separate
lines. These are called _block_ elements. Others, such as links
(`<a>`) or the `<strong>` element, are rendered on the same line with
their surrounding text. Such elements are called _inline_ elements.

{{index drawing}}

For any given document, browsers are able to compute a layout, which
gives each element a size and position based on its type and content.
This layout is then used to actually draw the document.

{{index "border (CSS)", "offsetWidth property", "offsetHeight property", "clientWidth property", "clientHeight property", dimensions}}

The size and position of an element can be accessed from JavaScript.
The `offsetWidth` and `offsetHeight` properties give you the space the
element takes up in _((pixel))s_. A pixel is the basic unit of
measurement in the browser. It traditionally corresponds to the
smallest dot that the screen can draw, but on modern displays, which
can draw _very_ small dots, that may no longer be the case, and a
browser pixel may span multiple display dots.

Similarly, `clientWidth` and `clientHeight` give you the size of the
space _inside_ the element, ignoring border width.

```{lang: "text/html"}
<p style="border: 3px solid red">
  I'm boxed in
</p>

<script>
  let para = document.body.getElementsByTagName("p")[0];
  console.log("clientHeight:", para.clientHeight);
  console.log("offsetHeight:", para.offsetHeight);
</script>
```

{{if book

Giving a paragraph a border causes a rectangle to be drawn around it.

{{figure {url: "img/boxed-in.png", alt: "A paragraph with a border",width: "8cm"}}}

if}}

{{index "getBoundingClientRect method", position, "pageXOffset property", "pageYOffset property"}}

{{id boundingRect}}

The most effective way to find the precise position of an element on
the screen is the `getBoundingClientRect` method. It returns an object
with `top`, `bottom`, `left`, and `right` properties, indicating the
pixel positions of the sides of the element relative to the top left
of the screen. If you want them relative to the whole document, you
must add the current scroll position, which you can find in the
`pageXOffset` and `pageYOffset` bindings.

{{index "offsetHeight property", "getBoundingClientRect method", drawing, laziness, performance, efficiency}}

Laying out a document can be quite a lot of work. In the interest of
speed, browser engines do not immediately re-layout a document every
time you change it but wait as long as they can. When a JavaScript
program that changed the document finishes running, the browser will
have to compute a new layout to draw the changed document to
the screen. When a program _asks_ for the position or size of
something by reading properties such as `offsetHeight` or calling
`getBoundingClientRect`, providing correct information also requires
computing a ((layout)).

{{index "side effect", optimization, benchmark}}

A program that repeatedly alternates between reading DOM layout
information and changing the DOM forces a lot of layout computations
to happen and will consequently run very slowly. The following code is
an example of this. It contains two different programs that build up a
line of _X_ characters 2,000 pixels wide and measures the time each
one takes.

```{lang: "text/html", test: nonumbers}
<p><span id="one"></span></p>
<p><span id="two"></span></p>

<script>
  function time(name, action) {
    let start = Date.now(); // Current time in milliseconds
    action();
    console.log(name, "took", Date.now() - start, "ms");
  }

  time("naive", () => {
    let target = document.getElementById("one");
    while (target.offsetWidth < 2000) {
      target.appendChild(document.createTextNode("X"));
    }
  });
  // → naive took 32 ms

  time("clever", function() {
    let target = document.getElementById("two");
    target.appendChild(document.createTextNode("XXXXX"));
    let total = Math.ceil(2000 / (target.offsetWidth / 5));
    target.firstChild.nodeValue = "X".repeat(total);
  });
  // → clever took 1 ms
</script>
```

## Styling

{{index "block element", "inline element", style, "strong (HTML tag)", "a (HTML tag)", underline}}

We have seen that different HTML elements are drawn differently. Some
are displayed as blocks, others inline. Some add styling—`<strong>`
makes its content ((bold)), and `<a>` makes it blue and underlines it.

{{index "img (HTML tag)", "default behavior", "style attribute"}}

The way an `<img>` tag shows an image or an `<a>` tag causes a link to
be followed when it is clicked is strongly tied to the element type.
But we can change the styling associated with an element, such
as the text color or underline. Here is an example that uses
the `style` property:

```{lang: "text/html"}
<p><a href=".">Normal link</a></p>
<p><a href="." style="color: green">Green link</a></p>
```

{{if book

The second link will be green instead of the default link color.

{{figure {url: "img/colored-links.png", alt: "A normal and a green link",width: "2.2cm"}}}

if}}

{{index "border (CSS)", "color (CSS)", CSS, "colon character"}}

A style attribute may contain one or more _((declaration))s_, which
are a property (such as `color`) followed by a colon and a value (such
as `green`). When there is more than one declaration, they must be
separated by ((semicolon))s, as in `"color: red; border: none"`.

{{index "display (CSS)", layout}}

A lot of aspects of the document can be influenced by
styling. For example, the `display` property controls whether an
element is displayed as a block or an inline element.

```{lang: "text/html"}
This text is displayed <strong>inline</strong>,
<strong style="display: block">as a block</strong>, and
<strong style="display: none">not at all</strong>.
```

{{index "hidden element"}}

The `block` tag will end up on its own line since ((block element))s
are not displayed inline with the text around them. The last tag is
not displayed at all—`display: none` prevents an element from showing
up on the screen. This is a way to hide elements. It is often
preferable to removing them from the document entirely because it
makes it easy to reveal them again later.

{{if book

{{figure {url: "img/display.png", alt: "Different display styles",width: "4cm"}}}

if}}

{{index "color (CSS)", "style attribute"}}

JavaScript code can directly manipulate the style of an element
through the element's `style` property. This property holds an object
that has properties for all possible style properties. The values of
these properties are strings, which we can write to in order to change
a particular aspect of the element's style.

```{lang: "text/html"}
<p id="para" style="color: purple">
  Nice text
</p>

<script>
  let para = document.getElementById("para");
  console.log(para.style.color);
  para.style.color = "magenta";
</script>
```

{{index "camel case", capitalization, "hyphen character", "font-family (CSS)"}}

Some style property names contain hyphens, such as `font-family`.
Because such property names are awkward to work with in JavaScript
(you'd have to say `style["font-family"]`), the property names in the
`style` object for such properties have their hyphens removed and the
letters after them capitalized (`style.fontFamily`).

## Cascading styles

{{index "rule (CSS)", "style (HTML tag)"}}

{{indexsee "Cascading Style Sheets", CSS}}
{{indexsee "style sheet", CSS}}

The styling system for HTML is called ((CSS)), for _Cascading Style
Sheets_. A _style sheet_ is a set of rules for how to style
elements in a document. It can be given inside a `<style>` tag.

```{lang: "text/html"}
<style>
  strong {
    font-style: italic;
    color: gray;
  }
</style>
<p>Now <strong>strong text</strong> is italic and gray.</p>
```

{{index "rule (CSS)", "font-weight (CSS)", overlay}}

The _((cascading))_ in the name refers to the fact that multiple such
rules are combined to produce the final style for an element. In the
example, the default styling for `<strong>` tags, which gives them
`font-weight: bold`, is overlaid by the rule in the `<style>` tag,
which adds `font-style` and `color`.

{{index "style (HTML tag)", "style attribute"}}

When multiple rules define a value for the same property, the most
recently read rule gets a higher ((precedence)) and wins. So if the
rule in the `<style>` tag included `font-weight: normal`,
contradicting the default `font-weight` rule, the text would be
normal, _not_ bold. Styles in a `style` attribute applied directly to
the node have the highest precedence and always win.

{{index uniqueness, "class attribute", "id attribute"}}

It is possible to target things other than ((tag)) names in CSS rules.
A rule for `.abc` applies to all elements with `"abc"` in their `class`
attribute. A rule for `#xyz` applies to the element with an `id`
attribute of `"xyz"` (which should be unique within the document).

```{lang: "text/css"}
.subtle {
  color: gray;
  font-size: 80%;
}
#header {
  background: blue;
  color: white;
}
/* p elements with id main and with classes a and b */
p#main.a.b {
  margin-bottom: 20px;
}
```

{{index "rule (CSS)"}}

The ((precedence)) rule favoring the most recently defined rule
applies only when the rules have the same _((specificity))_. A rule's
specificity is a measure of how precisely it describes matching
elements, determined by the number and kind (tag, class, or ID) of
element aspects it requires. For example, a rule that targets `p.a` is
more specific than rules that target `p` or just `.a` and would thus
take precedence over them.

{{index "direct child node"}}

The notation `p > a {…}` applies the given styles to all `<a>` tags
that are direct children of `<p>` tags. Similarly, `p a {…}` applies
to all `<a>` tags inside `<p>` tags, whether they are direct or
indirect children.

## Query selectors

{{index complexity, CSS}}

We won't be using style sheets all that much in this book.
Understanding them is helpful when programming in the browser, but
they are complicated enough to warrant a separate book.

{{index "domain-specific language", [DOM, querying]}}

The main reason I introduced _((selector))_ syntax—the notation used
in style sheets to determine which elements a set of styles apply
to—is that we can use this same mini-language as an effective way to
find DOM elements.

{{index "querySelectorAll method", "NodeList type"}}

The `querySelectorAll` method, which is defined both on the `document`
object and on element nodes, takes a selector string and returns a
`NodeList` containing all the elements that it matches.

```{lang: "text/html"}
<p>And if you go chasing
  <span class="animal">rabbits</span></p>
<p>And you know you're going to fall</p>
<p>Tell 'em a <span class="character">hookah smoking
  <span class="animal">caterpillar</span></span></p>
<p>Has given you the call</p>

<script>
  function count(selector) {
    return document.querySelectorAll(selector).length;
  }
  console.log(count("p"));           // All <p> elements
  // → 4
  console.log(count(".animal"));     // Class animal
  // → 2
  console.log(count("p .animal"));   // Animal inside of <p>
  // → 2
  console.log(count("p > .animal")); // Direct child of <p>
  // → 1
</script>
```

{{index "live data structure"}}

Unlike methods such as `getElementsByTagName`, the object returned by
`querySelectorAll` is _not_ live. It won't change when you change the
document. It is still not a real array, though, so you still need to
call `Array.from` if you want to treat it like one.

{{index "querySelector method"}}

The `querySelector` method (without the `All` part) works in a similar
way. This one is useful if you want a specific, single element. It
will return only the first matching element or null when no element
matches.

{{id animation}}

## Positioning and animating

{{index "position (CSS)", "relative positioning", "top (CSS)", "left (CSS)", "absolute positioning"}}

The `position` style property influences layout in a powerful way. By
default it has a value of `static`, meaning the element sits in its
normal place in the document. When it is set to `relative`, the
element still takes up space in the document, but now the `top` and
`left` style properties can be used to move it relative to that normal
place. When `position` is set to `absolute`, the element is removed
from the normal document flow—that is, it no longer takes up space and
may overlap with other elements. Also, its `top` and `left` properties
can be used to absolutely position it relative to the top-left corner
of the nearest enclosing element whose `position` property isn't
`static`, or relative to the document if no such enclosing element
exists.

{{index [animation, "spinning cat"]}}

We can use this to create an animation. The following document
displays a picture of a cat that moves around in an ((ellipse)):

```{lang: "text/html", startCode: true}
<p style="text-align: center">
  <img src="img/cat.png" style="position: relative">
</p>
<script>
  let cat = document.querySelector("img");
  let angle = Math.PI / 2;
  function animate(time, lastTime) {
    if (lastTime != null) {
      angle += (time - lastTime) * 0.001;
    }
    cat.style.top = (Math.sin(angle) * 20) + "px";
    cat.style.left = (Math.cos(angle) * 200) + "px";
    requestAnimationFrame(newTime => animate(newTime, time));
  }
  requestAnimationFrame(animate);
</script>
```

{{if book

The gray arrow shows the path along which the image moves.

{{figure {url: "img/cat-animation.png", alt: "A moving cat head",width: "8cm"}}}

if}}

{{index "top (CSS)", "left (CSS)", centering, "relative positioning"}}

Our picture is centered on the page and given a `position` of
`relative`. We'll repeatedly update that picture's `top` and `left`
styles to move it.

{{index "requestAnimationFrame function", drawing, animation}}

{{id animationFrame}}

The script uses `requestAnimationFrame` to schedule the `animate`
function to run whenever the browser is ready to repaint the screen.
The `animate` function itself again calls `requestAnimationFrame` to
schedule the next update. When the browser window (or tab) is active,
this will cause updates to happen at a rate of about 60 per second,
which tends to produce a good-looking animation.

{{index timeline, blocking}}

If we just updated the DOM in a loop, the page would freeze, and
nothing would show up on the screen. Browsers do not update their
display while a JavaScript program is running, nor do they allow any
interaction with the page. This is why we need
`requestAnimationFrame`—it lets the browser know that we are done for
now, and it can go ahead and do the things that browsers do, such as
updating the screen and responding to user actions.

{{index "smooth animation"}}

The animation function is passed the current ((time)) as an
argument. To ensure that the motion of the cat per millisecond is
stable, it bases the speed at which the angle changes on the
difference between the current time and the last time the function
ran. If it just moved the angle by a fixed amount per step, the motion
would stutter if, for example, another heavy task running on the same
computer were to prevent the function from running for a fraction of a
second.

{{index "Math.cos function", "Math.sin function", cosine, sine, trigonometry}}

{{id sin_cos}}

Moving in ((circle))s is done using the trigonometry functions
`Math.cos` and `Math.sin`. For those who aren't familiar with
these, I'll briefly introduce them since we will occasionally use them
in this book.

{{index coordinates, pi}}

`Math.cos` and `Math.sin` are useful for finding points that lie on a
circle around point (0,0) with a radius of one. Both functions
interpret their argument as the position on this circle, with zero
denoting the point on the far right of the circle, going clockwise
until 2π (about 6.28) has taken us around the whole circle. `Math.cos`
tells you the x-coordinate of the point that corresponds to the given
position, and `Math.sin` yields the y-coordinate. Positions (or
angles) greater than 2π or less than 0 are valid—the rotation repeats
so that _a_+2π refers to the same ((angle)) as _a_.

{{index "PI constant"}}

This unit for measuring angles is called ((radian))s—a full circle is
2π radians, similar to how it is 360 degrees when measuring in
degrees. The constant π is available as `Math.PI` in JavaScript.

{{figure {url: "img/cos_sin.svg", alt: "Using cosine and sine to compute coordinates",width: "6cm"}}}

{{index "counter variable", "Math.sin function", "top (CSS)", "Math.cos function", "left (CSS)", ellipse}}

The cat animation code keeps a counter, `angle`, for the current angle
of the animation and increments it every time the `animate` function
is called. It can then use this angle to compute the current position
of the image element. The `top` style is computed with `Math.sin` and
multiplied by 20, which is the vertical radius of our ellipse. The
`left` style is based on `Math.cos` and multiplied by 200 so that the
ellipse is much wider than it is high.

{{index "unit (CSS)"}}

Note that styles usually need _units_. In this case, we have to append
`"px"` to the number to tell the browser that we are counting in ((pixel))s
(as opposed to centimeters, "ems", or other units). This is easy to
forget. Using numbers without units will result in your style being
ignored—unless the number is 0, which always means the same thing,
regardless of its unit.

## Summary

JavaScript programs may inspect and interfere with the document that
the browser is displaying through a data structure called the DOM.
This data structure represents the browser's model of the document,
and a JavaScript program can modify it to change the visible document.

The DOM is organized like a tree, in which elements are arranged
hierarchically according to the structure of the document. The objects
representing elements have properties such as `parentNode` and
`childNodes`, which can be used to navigate through this tree.

The way a document is displayed can be influenced by _styling_, both
by attaching styles to nodes directly and by defining rules that match
certain nodes. There are many different style properties, such as
`color` or `display`. JavaScript code can manipulate an element's
style directly through its `style` property.

## Exercises

{{id exercise_table}}

### Build a table

{{index "table (HTML tag)"}}

An HTML table is built with the following tag structure:

```{lang: "text/html"}
<table>
  <tr>
    <th>name</th>
    <th>height</th>
    <th>place</th>
  </tr>
  <tr>
    <td>Kilimanjaro</td>
    <td>5895</td>
    <td>Tanzania</td>
  </tr>
</table>
```

{{index "tr (HTML tag)", "th (HTML tag)", "td (HTML tag)"}}

For each _((row))_, the `<table>` tag contains a `<tr>` tag. Inside of
these `<tr>` tags, we can put cell elements: either heading cells
(`<th>`) or regular cells (`<td>`).

Given a data set of mountains, an array of objects with `name`,
`height`, and `place` properties, generate the DOM structure for a
table that enumerates the objects. It should have one column per key
and one row per object, plus a header row with `<th>` elements at the
top, listing the column names.

Write this so that the columns are automatically derived from the
objects, by taking the property names of the first object in the data.

Add the resulting table to the element with an `id` attribute of
`"mountains"` so that it becomes visible in the document.

{{index "right-aligning", "text-align (CSS)"}}

Once you have this working, right-align cells that contain number
values by setting their `style.textAlign` property to `"right"`.

{{if interactive

```{test: no, lang: "text/html"}
<h1>Mountains</h1>

<div id="mountains"></div>

<script>
  const MOUNTAINS = [
    {name: "Kilimanjaro", height: 5895, place: "Tanzania"},
    {name: "Everest", height: 8848, place: "Nepal"},
    {name: "Mount Fuji", height: 3776, place: "Japan"},
    {name: "Vaalserberg", height: 323, place: "Netherlands"},
    {name: "Denali", height: 6168, place: "United States"},
    {name: "Popocatepetl", height: 5465, place: "Mexico"},
    {name: "Mont Blanc", height: 4808, place: "Italy/France"}
  ];

  // Your code here
</script>
```

if}}

{{hint

{{index "createElement method", "table example", "appendChild method"}}

You can use `document.createElement` to create new element nodes,
`document.createTextNode` to create text nodes, and the `appendChild`
method to put nodes into other nodes.

{{index "Object.keys function"}}

You'll want to loop over the key names once to fill in the top row and
then again for each object in the array to construct the data rows. To
get an array of key names from the first object, `Object.keys` will be
useful.

{{index "getElementById method", "querySelector method"}}

To add the table to the correct parent node, you can use
`document.getElementById` or `document.querySelector` to find the node
with the proper `id` attribute.

hint}}

### Elements by tag name

{{index "getElementsByTagName method", recursion}}

The `document.getElementsByTagName` method returns all child elements
with a given tag name. Implement your own version of this as a
function that takes a node and a string (the tag name) as arguments
and returns an array containing all descendant element nodes with the
given tag name.

{{index "nodeName property", capitalization, "toLowerCase method", "toUpperCase method"}}

To find the tag name of an element, use its `nodeName` property. But
note that this will return the tag name in all uppercase. Use the
`toLowerCase` or `toUpperCase` string methods to compensate for this.

{{if interactive

```{lang: "text/html", test: no}
<h1>Heading with a <span>span</span> element.</h1>
<p>A paragraph with <span>one</span>, <span>two</span>
  spans.</p>

<script>
  function byTagName(node, tagName) {
    // Your code here.
  }

  console.log(byTagName(document.body, "h1").length);
  // → 1
  console.log(byTagName(document.body, "span").length);
  // → 3
  let para = document.querySelector("p");
  console.log(byTagName(para, "span").length);
  // → 2
</script>
```
if}}

{{hint

{{index "getElementsByTagName method", recursion}}

The solution is most easily expressed with a recursive function,
similar to the [`talksAbout` function](dom#talksAbout) defined earlier
in this chapter.

{{index concatenation, "concat method", closure}}

You could call `byTagname` itself recursively, concatenating the
resulting arrays to produce the output. Or you could create an inner
function that calls itself recursively and that has access to an array
binding defined in the outer function, to which it can add the
matching elements it finds. Don't forget to call the ((inner
function)) once from the outer function to start the process.

{{index "nodeType property", "ELEMENT_NODE code"}}

The recursive function must check the node type. Here we are
interested only in node type 1 (`Node.ELEMENT_NODE`). For such
nodes, we must loop over their children and, for each child, see
whether the child matches the query while also doing a recursive call
on it to inspect its own children.

hint}}

### The cat's hat

{{index "cat's hat (exercise)", [animation, "spinning cat"]}}

Extend the cat animation defined [earlier](dom#animation) so that
both the cat and his hat (`<img src="img/hat.png">`) orbit at opposite
sides of the ellipse.

Or make the hat circle around the cat. Or alter the animation in some
other interesting way.

{{index "absolute positioning", "top (CSS)", "left (CSS)", "position (CSS)"}}

To make positioning multiple objects easier, it is probably a good
idea to switch to absolute positioning. This means that `top` and
`left` are counted relative to the top left of the document. To avoid
using negative coordinates, which would cause the image to move
outside of the visible page, you can add a fixed number of pixels to
the position values.

{{if interactive

```{lang: "text/html", test: no}
<style>body { min-height: 200px }</style>
<img src="img/cat.png" id="cat" style="position: absolute">
<img src="img/hat.png" id="hat" style="position: absolute">

<script>
  let cat = document.querySelector("#cat");
  let hat = document.querySelector("#hat");

  let angle = 0;
  let lastTime = null;
  function animate(time) {
    if (lastTime != null) angle += (time - lastTime) * 0.001;
    lastTime = time;
    cat.style.top = (Math.sin(angle) * 40 + 40) + "px";
    cat.style.left = (Math.cos(angle) * 200 + 230) + "px";

    // Your extensions here.

    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
</script>
```

if}}

{{hint

`Math.cos` and `Math.sin` measure angles in radians, where a full
circle is 2π. For a given angle, you can get the opposite angle by
adding half of this, which is `Math.PI`. This can be useful for
putting the hat on the opposite side of the orbit.

hint}}
# Handling Events

{{quote {author: "Marcus Aurelius", title: Meditations, chapter: true}

You have power over your mind—not outside events. Realize this, and
you will find strength.

quote}}

{{index stoicism, "Marcus Aurelius", input, timeline}}

{{figure {url: "img/chapter_picture_15.jpg", alt: "Picture a Rube Goldberg machine", chapter: "framed"}}}

Some programs work with direct user input, such as mouse and keyboard
actions. That kind of input isn't available as a well-organized data
structure—it comes in piece by piece, in real time, and the program is
expected to respond to it as it happens.

## Event handlers

{{index polling, button, "real-time"}}

Imagine an interface where the only way to find out whether a key on
the ((keyboard)) is being pressed is to read the current state of that
key. To be able to react to keypresses, you would have to constantly
read the key's state so that you'd catch it before it's released
again. It would be dangerous to perform other time-intensive
computations since you might miss a keypress.

Some primitive machines do handle input like that. A step up from this
would be for the hardware or operating system to notice the keypress
and put it in a queue. A program can then periodically check the queue
for new events and react to what it finds there.

{{index responsiveness, "user experience"}}

Of course, it has to remember to look at the queue, and to do it
often, because any time between the key being pressed and the program
noticing the event will cause the software to feel unresponsive. This
approach is called _((polling))_. Most programmers prefer to avoid it.

{{index "callback function", "event handling"}}

A better mechanism is for the system to actively notify our code when
an event occurs. Browsers do this by allowing us to register functions
as _handlers_ for specific events.

```{lang: "text/html"}
<p>Click this document to activate the handler.</p>
<script>
  window.addEventListener("click", () => {
    console.log("You knocked?");
  });
</script>
```

{{index "click event", "addEventListener method", "window object", [browser, window]}}

The `window` binding refers to a built-in object provided by the
browser. It represents the browser window that contains the
document. Calling its `addEventListener` method registers the second
argument to be called whenever the event described by its first
argument occurs.

## Events and DOM nodes

{{index "addEventListener method", "event handling", "window object", browser, [DOM, events]}}

Each browser event handler is registered in a context. In the previous example we called
`addEventListener` on the `window` object to register a handler
for the whole window. Such a method can also be found on DOM
elements and some other types of objects. Event listeners are
called only when the event happens in the context of the object they are
registered on.

```{lang: "text/html"}
<button>Click me</button>
<p>No handler here.</p>
<script>
  let button = document.querySelector("button");
  button.addEventListener("click", () => {
    console.log("Button clicked.");
  });
</script>
```

{{index "click event", "button (HTML tag)"}}

That example attaches a handler to the button node. Clicks on the
button cause that handler to run, but clicks on the rest of the
document do not.

{{index "onclick attribute", encapsulation}}

Giving a node an `onclick` attribute has a similar effect. This works
for most types of events—you can attach a handler through the
attribute whose name is the event name with `on` in front of it.

But a node can have only one `onclick` attribute, so you can register
only one handler per node that way. The `addEventListener` method
allows you to add any number of handlers so that it is safe to add
handlers even if there is already another handler on the element.

{{index "removeEventListener method"}}

The `removeEventListener` method, called with arguments similar to
`addEventListener`, removes a handler.

```{lang: "text/html"}
<button>Act-once button</button>
<script>
  let button = document.querySelector("button");
  function once() {
    console.log("Done.");
    button.removeEventListener("click", once);
  }
  button.addEventListener("click", once);
</script>
```

{{index [function, "as value"]}}

The function given to `removeEventListener` has to be the same
function value that was given to `addEventListener`. So, to unregister
a handler, you'll want to give the function a name (`once`, in the
example) to be able to pass the same function value to both methods.

## Event objects

{{index "button property", "event handling"}}

Though we have ignored it so far, event handler functions are passed
an argument: the _((event object))_. This object holds additional
information about the event. For example, if we want to know _which_
((mouse button)) was pressed, we can look at the event object's
`button` property.

```{lang: "text/html"}
<button>Click me any way you want</button>
<script>
  let button = document.querySelector("button");
  button.addEventListener("mousedown", event => {
    if (event.button == 0) {
      console.log("Left button");
    } else if (event.button == 1) {
      console.log("Middle button");
    } else if (event.button == 2) {
      console.log("Right button");
    }
  });
</script>
```

{{index "event type", "type property"}}

The information stored in an event object differs per type of event.
We'll discuss different types later in the chapter. The object's
`type` property always holds a string identifying the event (such as
`"click"` or `"mousedown"`).

## Propagation

{{index "event propagation", "parent node"}}

{{indexsee bubbling, "event propagation"}}

{{indexsee propagation, "event propagation"}}

For most event types, handlers registered on nodes with children will
also receive events that happen in the children. If a button inside a
paragraph is clicked, event handlers on the paragraph will also see
the click event.

{{index "event handling"}}

But if both the paragraph and the button have a handler, the more
specific handler—the one on the button—gets to go first. The event is
said to _propagate_ outward, from the node where it happened to that
node's parent node and on to the root of the document. Finally, after
all handlers registered on a specific node have had their turn,
handlers registered on the whole ((window)) get a chance to respond to
the event.

{{index "stopPropagation method", "click event"}}

At any point, an event handler can call the `stopPropagation` method
on the event object to prevent handlers further up from receiving the
event. This can be useful when, for example, you have a button inside
another clickable element and you don't want clicks on the button to
activate the outer element's click behavior.

{{index "mousedown event", "pointer event"}}

The following example registers `"mousedown"` handlers on both a
button and the paragraph around it. When clicked with the right mouse
button, the handler for the button calls `stopPropagation`, which will
prevent the handler on the paragraph from running. When the button is
clicked with another ((mouse button)), both handlers will run.

```{lang: "text/html"}
<p>A paragraph with a <button>button</button>.</p>
<script>
  let para = document.querySelector("p");
  let button = document.querySelector("button");
  para.addEventListener("mousedown", () => {
    console.log("Handler for paragraph.");
  });
  button.addEventListener("mousedown", event => {
    console.log("Handler for button.");
    if (event.button == 2) event.stopPropagation();
  });
</script>
```

{{index "event propagation", "target property"}}

Most event objects have a `target` property that refers to the node
where they originated. You can use this property to ensure that you're
not accidentally handling something that propagated up from a node you
do not want to handle.

It is also possible to use the `target` property to cast a wide net
for a specific type of event. For example, if you have a node
containing a long list of buttons, it may be more convenient to
register a single click handler on the outer node and have it use the
`target` property to figure out whether a button was clicked, rather
than register individual handlers on all of the buttons.

```{lang: "text/html"}
<button>A</button>
<button>B</button>
<button>C</button>
<script>
  document.body.addEventListener("click", event => {
    if (event.target.nodeName == "BUTTON") {
      console.log("Clicked", event.target.textContent);
    }
  });
</script>
```

## Default actions

{{index scrolling, "default behavior", "event handling"}}

Many events have a default action associated with them. If you click a
((link)), you will be taken to the link's target. If you press the
down arrow, the browser will scroll the page down. If you right-click,
you'll get a context menu. And so on.

{{index "preventDefault method"}}

For most types of events, the JavaScript event handlers are called
_before_ the default behavior takes place. If the handler doesn't want
this normal behavior to happen, typically because it has already taken
care of handling the event, it can call the `preventDefault` method on
the event object.

{{index expectation}}

This can be used to implement your own ((keyboard)) shortcuts or
((context menu)). It can also be used to obnoxiously interfere with
the behavior that users expect. For example, here is a link that
cannot be followed:

```{lang: "text/html"}
<a href="https://developer.mozilla.org/">MDN</a>
<script>
  let link = document.querySelector("a");
  link.addEventListener("click", event => {
    console.log("Nope.");
    event.preventDefault();
  });
</script>
```

{{index usability}}

Try not to do such things unless you have a really good reason to.
It'll be unpleasant for people who use your page when expected
behavior is broken.

Depending on the browser, some events can't be intercepted at all. On
Chrome, for example, the ((keyboard)) shortcut to close the current
tab ([control]{keyname}-W or [command]{keyname}-W) cannot be handled by JavaScript.

## Key events

{{index keyboard, "keydown event", "keyup event", "event handling"}}

When a key on the keyboard is pressed, your browser fires a
`"keydown"` event. When it is released, you get a `"keyup"`
event.

```{lang: "text/html", focus: true}
<p>This page turns violet when you hold the V key.</p>
<script>
  window.addEventListener("keydown", event => {
    if (event.key == "v") {
      document.body.style.background = "violet";
    }
  });
  window.addEventListener("keyup", event => {
    if (event.key == "v") {
      document.body.style.background = "";
    }
  });
</script>
```

{{index "repeating key"}}

Despite its name, `"keydown"` fires not only when the key is
physically pushed down. When a key is pressed and held, the event
fires again every time the key _repeats_. Sometimes you have to be
careful about this. For example, if you add a button to the DOM when a
key is pressed and remove it again when the key is released, you
might accidentally add hundreds of buttons when the key is held down
longer.

{{index "key property"}}

The example looked at the `key` property of the event object to see
which key the event is about. This property holds a string that, for
most keys, corresponds to the thing that pressing that key would type.
For special keys such as [enter]{keyname}, it holds a string that names the key
(`"Enter"`, in this case). If you hold [shift]{keyname} while pressing a key,
that might also influence the name of the key—`"v"` becomes `"V"`, and
`"1"` may become `"!"`, if that is what pressing [shift]{keyname}-1 produces on
your keyboard.

{{index "modifier key", "shift key", "control key", "alt key", "meta key", "command key", "ctrlKey property", "shiftKey property", "altKey property", "metaKey property"}}

Modifier keys such as [shift]{keyname}, [control]{keyname}, [alt]{keyname}, and [meta]{keyname} ([command]{keyname} on Mac)
generate key events just like normal keys. But when looking for key
combinations, you can also find out whether these keys are held down
by looking at the `shiftKey`, `ctrlKey`, `altKey`, and `metaKey`
properties of keyboard and mouse events.

```{lang: "text/html", focus: true}
<p>Press Control-Space to continue.</p>
<script>
  window.addEventListener("keydown", event => {
    if (event.key == " " && event.ctrlKey) {
      console.log("Continuing!");
    }
  });
</script>
```

{{index "button (HTML tag)", "tabindex attribute", [DOM, events]}}

The DOM node where a key event originates depends on the element
that has ((focus)) when the key is pressed. Most nodes cannot have
focus unless you give them a `tabindex` attribute, but things like
((link))s, buttons, and form fields can. We'll come back to form
((field))s in [Chapter ?](http#forms). When nothing in particular has
focus, `document.body` acts as the target node of key events.

When the user is typing text, using key events to figure out what is
being typed is problematic. Some platforms, most notably the ((virtual
keyboard)) on ((Android)) ((phone))s, don't fire key events. But even
when you have an old-fashioned keyboard, some types of text input
don't match key presses in a straightforward way, such as _input method editor_ (((IME)))
software used by people whose scripts don't
fit on a keyboard, where multiple key strokes are combined to create
characters.

To notice when something was typed, elements that you can type into,
such as the `<input>` and `<textarea>` tags, fire `"input"` events
whenever the user changes their content. To get the actual content
that was typed, it is best to directly read it from the focused field.
[Chapter ?](http#forms) will show how.

## Pointer events

There are currently two widely used ways to point at things on a
screen: mice (including devices that act like mice, such as touchpads
and trackballs) and touchscreens. These produce different kinds of
events.

### Mouse clicks

{{index "mousedown event", "mouseup event", "mouse cursor"}}

Pressing a ((mouse button)) causes a number of events to fire. The
`"mousedown"` and `"mouseup"` events are similar to `"keydown"` and
`"keyup"` and fire when the button is pressed and released. These
happen on the DOM nodes that are immediately below the mouse pointer
when the event occurs.

{{index "click event"}}

After the `"mouseup"` event, a `"click"` event fires on the most
specific node that contained both the press and the release of the
button. For example, if I press down the mouse button on one paragraph
and then move the pointer to another paragraph and release the button,
the `"click"` event will happen on the element that contains both
those paragraphs.

{{index "dblclick event", "double click"}}

If two clicks happen close together, a `"dblclick"` (double-click)
event also fires, after the second click event.

{{index pixel, "clientX property", "clientY property", "pageX property", "pageY property", "event object"}}

To get precise information about the place where a mouse event
happened, you can look at its `clientX` and `clientY` properties,
which contain the event's ((coordinates)) (in pixels) relative to the
top-left corner of the window, or `pageX` and `pageY`, which are
relative to the top-left corner of the whole document (which may be
different when the window has been scrolled).

{{index "border-radius (CSS)", "absolute positioning", "drawing program example"}}

{{id mouse_drawing}}

The following implements a primitive drawing program. Every time you
click the document, it adds a dot under your mouse pointer. See
[Chapter ?](paint) for a less primitive drawing program.

```{lang: "text/html"}
<style>
  body {
    height: 200px;
    background: beige;
  }
  .dot {
    height: 8px; width: 8px;
    border-radius: 4px; /* rounds corners */
    background: blue;
    position: absolute;
  }
</style>
<script>
  window.addEventListener("click", event => {
    let dot = document.createElement("div");
    dot.className = "dot";
    dot.style.left = (event.pageX - 4) + "px";
    dot.style.top = (event.pageY - 4) + "px";
    document.body.appendChild(dot);
  });
</script>
```

### Mouse motion

{{index "mousemove event"}}

Every time the mouse pointer moves, a `"mousemove"` event is fired.
This event can be used to track the position of the mouse. A common
situation in which this is useful is when implementing some form of
mouse-((dragging)) functionality.

{{index "draggable bar example"}}

As an example, the following program displays a bar and sets up event
handlers so that dragging to the left or right on this bar makes it
narrower or wider:

```{lang: "text/html", startCode: true}
<p>Drag the bar to change its width:</p>
<div style="background: orange; width: 60px; height: 20px">
</div>
<script>
  let lastX; // Tracks the last observed mouse X position
  let bar = document.querySelector("div");
  bar.addEventListener("mousedown", event => {
    if (event.button == 0) {
      lastX = event.clientX;
      window.addEventListener("mousemove", moved);
      event.preventDefault(); // Prevent selection
    }
  });

  function moved(event) {
    if (event.buttons == 0) {
      window.removeEventListener("mousemove", moved);
    } else {
      let dist = event.clientX - lastX;
      let newWidth = Math.max(10, bar.offsetWidth + dist);
      bar.style.width = newWidth + "px";
      lastX = event.clientX;
    }
  }
</script>
```

{{if book

The resulting page looks like this:

{{figure {url: "img/drag-bar.png", alt: "A draggable bar",width: "5.3cm"}}}

if}}

{{index "mouseup event", "mousemove event"}}

Note that the `"mousemove"` handler is registered on the whole
((window)). Even if the mouse goes outside of the bar during resizing,
as long as the button is held we still want to update its size.

{{index "buttons property", "button property", "bitfield"}}

We must stop resizing the bar when the mouse button is released. For
that, we can use the `buttons` property (note the plural), which tells
us about the buttons that are currently held down. When this is zero,
no buttons are down. When buttons are held, its value is the sum of
the codes for those buttons—the left button has code 1, the right
button 2, and the middle one 4. That way, you can check whether a given
button is pressed by taking the remainder of the value of `buttons`
and its code.

Note that the order of these codes is different from the one used by
`button`, where the middle button came before the right one. As
mentioned, consistency isn't really a strong point of the browser's
programming interface.

### Touch events

{{index touch, "mousedown event", "mouseup event", "click event"}}

The style of graphical browser that we use was designed with mouse
interfaces in mind, at a time where touchscreens were rare. To
make the Web "work" on early touchscreen phones, browsers for those
devices pretended, to a certain extent, that touch events were mouse
events. If you tap your screen, you'll get `"mousedown"`, `"mouseup"`,
and `"click"` events.

But this illusion isn't very robust. A touchscreen works differently
from a mouse: it doesn't have multiple buttons, you can't track the
finger when it isn't on the screen (to simulate `"mousemove"`), and it
allows multiple fingers to be on the screen at the same time.

Mouse events cover touch interaction only in straightforward cases—if
you add a `"click"` handler to a button, touch users will still be
able to use it. But something like the resizeable bar in the previous
example does not work on a touchscreen.

{{index "touchstart event", "touchmove event", "touchend event"}}

There are specific event types fired by touch interaction. When a
finger starts touching the screen, you get a `"touchstart"` event.
When it is moved while touching, `"touchmove"` events fire. 
Finally, when it stops touching the screen, you'll see a `"touchend"`
event.

{{index "touches property", "clientX property", "clientY property", "pageX property", "pageY property"}}

Because many touchscreens can detect multiple fingers at the same
time, these events don't have a single set of coordinates associated
with them. Rather, their ((event object))s have a `touches` property,
which holds an ((array-like object)) of points, each of which has its
own `clientX`, `clientY`, `pageX`, and `pageY` properties.

You could do something like this to show red circles around every
touching finger:

```{lang: "text/html"}
<style>
  dot { position: absolute; display: block;
        border: 2px solid red; border-radius: 50px;
        height: 100px; width: 100px; }
</style>
<p>Touch this page</p>
<script>
  function update(event) {
    for (let dot; dot = document.querySelector("dot");) {
      dot.remove();
    }
    for (let i = 0; i < event.touches.length; i++) {
      let {pageX, pageY} = event.touches[i];
      let dot = document.createElement("dot");
      dot.style.left = (pageX - 50) + "px";
      dot.style.top = (pageY - 50) + "px";
      document.body.appendChild(dot);
    }
  }
  window.addEventListener("touchstart", update);
  window.addEventListener("touchmove", update);
  window.addEventListener("touchend", update);
</script>
```

{{index "preventDefault method"}}

You'll often want to call `preventDefault` in touch event handlers to
override the browser's default behavior (which may include scrolling
the page on swiping) and to prevent the mouse events from being fired,
for which you may _also_ have a handler.

## Scroll events

{{index scrolling, "scroll event", "event handling"}}

Whenever an element is scrolled, a `"scroll"` event is fired on it.
This has various uses, such as knowing what the user is currently
looking at (for disabling off-screen ((animation))s or sending ((spy))
reports to your evil headquarters) or showing some indication of
progress (by highlighting part of a table of contents or showing a
page number).

The following example draws a ((progress bar)) above the document and
updates it to fill up as you scroll down:

```{lang: "text/html"}
<style>
  #progress {
    border-bottom: 2px solid blue;
    width: 0;
    position: fixed;
    top: 0; left: 0;
  }
</style>
<div id="progress"></div>
<script>
  // Create some content
  document.body.appendChild(document.createTextNode(
    "supercalifragilisticexpialidocious ".repeat(1000)));

  let bar = document.querySelector("#progress");
  window.addEventListener("scroll", () => {
    let max = document.body.scrollHeight - innerHeight;
    bar.style.width = `${(pageYOffset / max) * 100}%`;
  });
</script>
```

{{index "unit (CSS)", scrolling, "position (CSS)", "fixed positioning", "absolute positioning", percentage, "repeat method"}}

Giving an element a `position` of `fixed` acts much like an `absolute`
position but also prevents it from scrolling along with the rest of
the document. The effect is to make our progress bar stay at the top.
Its width is changed to indicate the current progress. We use `%`,
rather than `px`, as a unit when setting the width so that the element
is sized relative to the page width.

{{index "innerHeight property", "innerWidth property", "pageYOffset property"}}

The global `innerHeight` binding gives us the height of the window,
which we have to subtract from the total scrollable height—you can't
keep scrolling when you hit the bottom of the document. There's also
an `innerWidth` for the window width. By dividing `pageYOffset`, the
current scroll position, by the maximum scroll position and
multiplying by 100, we get the percentage for the progress bar.

{{index "preventDefault method"}}

Calling `preventDefault` on a scroll event does not prevent the
scrolling from happening. In fact, the event handler is called only
_after_ the scrolling takes place.

## Focus events

{{index "event handling", "focus event", "blur event"}}

When an element gains ((focus)), the browser fires a `"focus"` event
on it. When it loses focus, the element gets a `"blur"` event.

{{index "event propagation"}}

Unlike the events discussed earlier, these two events do not
propagate. A handler on a parent element is not notified when a child
element gains or loses focus.

{{index "input (HTML tag)", "help text example"}}

The following example displays help text for the ((text field)) that
currently has focus:

```{lang: "text/html"}
<p>Name: <input type="text" data-help="Your full name"></p>
<p>Age: <input type="text" data-help="Your age in years"></p>
<p id="help"></p>

<script>
  let help = document.querySelector("#help");
  let fields = document.querySelectorAll("input");
  for (let field of Array.from(fields)) {
    field.addEventListener("focus", event => {
      let text = event.target.getAttribute("data-help");
      help.textContent = text;
    });
    field.addEventListener("blur", event => {
      help.textContent = "";
    });
  }
</script>
```

{{if book

This screenshot shows the help text for the age field.

{{figure {url: "img/help-field.png", alt: "Providing help when a field is focused",width: "4.4cm"}}}

if}}

{{index "focus event", "blur event"}}

The ((window)) object will receive `"focus"` and `"blur"` events when
the user moves from or to the browser tab or window in which the
document is shown.

## Load event

{{index "script (HTML tag)", "load event"}}

When a page finishes loading, the `"load"` event fires on the window
and the document body objects. This is often used to schedule
((initialization)) actions that require the whole ((document)) to have
been built. Remember that the content of `<script>` tags is run
immediately when the tag is encountered. This may be too soon, for
example when the script needs to do something with parts of the
document that appear after the `<script>` tag.

{{index "event propagation", "img (HTML tag)"}}

Elements such as ((image))s and script tags that load an external file
also have a `"load"` event that indicates the files they reference
were loaded. Like the focus-related events, loading events do not
propagate.

{{index "beforeunload event", "page reload", "preventDefault method"}}

When a page is closed or navigated away from (for example, by
following a link), a `"beforeunload"` event fires. The main use of
this event is to prevent the user from accidentally losing work by
closing a document. If you prevent the default behavior on this event
_and_ set the `returnValue` property on the event object to a
string, the browser will show the user a dialog asking if they really
want to leave the page. That dialog might include your string, but
because some malicious sites try to use these dialogs to confuse
people into staying on their page to look at dodgy weight loss ads,
most browsers no longer display them.

{{id timeline}}

## Events and the event loop

{{index "requestAnimationFrame function", "event handling", timeline, "script (HTML tag)"}}

In the context of the event loop, as discussed in [Chapter ?](async),
browser event handlers behave like other asynchronous notifications.
They are scheduled when the event occurs but must wait for other
scripts that are running to finish before they get a chance to run.

The fact that events can be processed only when nothing else is
running means that, if the event loop is tied up with other work, any
interaction with the page (which happens through events) will be
delayed until there's time to process it. So if you schedule too much
work, either with long-running event handlers or with lots of
short-running ones, the page will become slow and cumbersome to use.

For cases where you _really_ do want to do some time-consuming thing
in the background without freezing the page, browsers provide
something called _((web worker))s_. A worker is a JavaScript process
that runs alongside the main script, on its own timeline.

Imagine that squaring a number is a heavy, long-running computation
that we want to perform in a separate ((thread)). We could write a
file called `code/squareworker.js` that responds to messages by
computing a square and sending a message back.

```
addEventListener("message", event => {
  postMessage(event.data * event.data);
});
```

To avoid the problems of having multiple ((thread))s touching the same
data, workers do not share their ((global scope)) or any other data
with the main script's environment. Instead, you have to communicate
with them by sending messages back and forth.

This code spawns a worker running that script, sends it a few
messages, and outputs the responses.

```{test: no}
let squareWorker = new Worker("code/squareworker.js");
squareWorker.addEventListener("message", event => {
  console.log("The worker responded:", event.data);
});
squareWorker.postMessage(10);
squareWorker.postMessage(24);
```

{{index "postMessage method", "message event"}}

The `postMessage` function sends a message, which will cause a
`"message"` event to fire in the receiver. The script that created the
worker sends and receives messages through the `Worker` object,
whereas the worker talks to the script that created it by sending and
listening directly on its ((global scope)). Only values that can be
represented as JSON can be sent as messages—the other side will
receive a _copy_ of them, rather than the value itself.

## Timers

{{index timeout, "setTimeout function"}}

We saw the `setTimeout` function in [Chapter ?](async). It schedules
another function to be called later, after a given number of
milliseconds.

{{index "clearTimeout function"}}

Sometimes you need to cancel a function you have scheduled. This is
done by storing the value returned by `setTimeout` and calling
`clearTimeout` on it.

```
let bombTimer = setTimeout(() => {
  console.log("BOOM!");
}, 500);

if (Math.random() < 0.5) { // 50% chance
  console.log("Defused.");
  clearTimeout(bombTimer);
}
```

{{index "cancelAnimationFrame function", "requestAnimationFrame function"}}

The `cancelAnimationFrame` function works in the same way as
`clearTimeout`—calling it on a value returned by
`requestAnimationFrame` will cancel that frame (assuming it hasn't
already been called).

{{index "setInterval function", "clearInterval function", repetition}}

A similar set of functions, `setInterval` and `clearInterval`, are used
to set timers that should _repeat_ every _X_ milliseconds.

```
let ticks = 0;
let clock = setInterval(() => {
  console.log("tick", ticks++);
  if (ticks == 10) {
    clearInterval(clock);
    console.log("stop.");
  }
}, 200);
```

## Debouncing

{{index optimization, "mousemove event", "scroll event", blocking}}

Some types of events have the potential to fire rapidly, many times in
a row (the `"mousemove"` and `"scroll"` events, for example). When
handling such events, you must be careful not to do anything too
time-consuming or your handler will take up so much time that
interaction with the document starts to feel slow.

{{index "setTimeout function"}}

If you do need to do something nontrivial in such a handler, you can
use `setTimeout` to make sure you are not doing it too often. This is
usually called _((debouncing))_ the event. There are several slightly
different approaches to this.

{{index "textarea (HTML tag)", "clearTimeout function", "keydown event"}}

In the first example, we want to react when the user has typed
something, but we don't want to do it immediately for every input
event. When they are ((typing)) quickly, we just want to wait until a
pause occurs. Instead of immediately performing an action in the event
handler, we set a timeout. We also clear the previous timeout (if any)
so that when events occur close together (closer than our timeout
delay), the timeout from the previous event will be canceled.

```{lang: "text/html"}
<textarea>Type something here...</textarea>
<script>
  let textarea = document.querySelector("textarea");
  let timeout;
  textarea.addEventListener("input", () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => console.log("Typed!"), 500);
  });
</script>
```

{{index "sloppy programming"}}

Giving an undefined value to `clearTimeout` or calling it on a timeout
that has already fired has no effect. Thus, we don't have to be
careful about when to call it, and we simply do so for every event.

{{index "mousemove event"}}

We can use a slightly different pattern if we want to space responses
so that they're separated by at least a certain length of ((time)) but
want to fire them _during_ a series of events, not just afterward. For
example, we might want to respond to `"mousemove"` events by showing
the current coordinates of the mouse but only every 250 milliseconds.

```{lang: "text/html"}
<script>
  let scheduled = null;
  window.addEventListener("mousemove", event => {
    if (!scheduled) {
      setTimeout(() => {
        document.body.textContent =
          `Mouse at ${scheduled.pageX}, ${scheduled.pageY}`;
        scheduled = null;
      }, 250);
    }
    scheduled = event;
  });
</script>
```

## Summary

Event handlers make it possible to detect and react to events
happening in our web page. The `addEventListener` method is used to
register such a handler.

Each event has a type (`"keydown"`, `"focus"`, and so on) that
identifies it. Most events are called on a specific DOM element and
then _propagate_ to that element's ancestors, allowing handlers
associated with those elements to handle them.

When an event handler is called, it is passed an event object with
additional information about the event. This object also has methods
that allow us to stop further propagation (`stopPropagation`) and
prevent the browser's default handling of the event
(`preventDefault`).

Pressing a key fires `"keydown"` and `"keyup"` events. Pressing a
mouse button fires `"mousedown"`, `"mouseup"`, and `"click"` events.
Moving the mouse fires `"mousemove"` events. Touchscreen interaction
will result in `"touchstart"`, `"touchmove"`, and `"touchend"` events.

Scrolling can be detected with the `"scroll"` event, and focus changes
can be detected with the `"focus"` and `"blur"` events. When the
document finishes loading, a `"load"` event fires on the window.

## Exercises

### Balloon

{{index "balloon (exercise)", "arrow key"}}

Write a page that displays a ((balloon)) (using the balloon ((emoji)),
🎈). When you press the up arrow, it should inflate (grow) 10 percent,
and when you press the down arrow, it should deflate (shrink) 10 percent.

{{index "font-size (CSS)"}}

You can control the size of text (emoji are text) by setting the
`font-size` CSS property (`style.fontSize`) on its parent element.
Remember to include a unit in the value—for example, pixels (`10px`).

The key names of the arrow keys are `"ArrowUp"` and `"ArrowDown"`.
Make sure the keys change only the balloon, without scrolling the
page.

When that works, add a feature where, if you blow up the balloon past
a certain size, it explodes. In this case, exploding means that it is
replaced with an 💥 emoji, and the event handler is removed (so that
you can't inflate or deflate the explosion).

{{if interactive

```{test: no, lang: "text/html", focus: yes}
<p>🎈</p>

<script>
  // Your code here
</script>
```

if}}

{{hint

{{index "keydown event", "key property", "balloon (exercise)"}}

You'll want to register a handler for the `"keydown"` event and look
at `event.key` to figure out whether the up or down arrow key was
pressed.

The current size can be kept in a binding so that you can base the
new size on it. It'll be helpful to define a function that updates the
size—both the binding and the style of the balloon in the DOM—so that
you can call it from your event handler, and possibly also once when
starting, to set the initial size.

{{index "replaceChild method", "textContent property"}}

You can change the balloon to an explosion by replacing the text node
with another one (using `replaceChild`) or by setting the
`textContent` property of its parent node to a new string.

hint}}

### Mouse trail

{{index animation, "mouse trail (exercise)"}}

In JavaScript's early days, which was the high time of ((gaudy home
pages)) with lots of animated images, people came up with some truly
inspiring ways to use the language.

One of these was the _mouse trail_—a series of elements that would
follow the mouse pointer as you moved it across the page.

{{index "absolute positioning", "background (CSS)"}}

In this exercise, I want you to implement a mouse trail. Use
absolutely positioned `<div>` elements with a fixed size and
background color (refer to the [code](event#mouse_drawing) in the
"Mouse Clicks" section for an example). Create a bunch of such
elements and, when the mouse moves, display them in the wake of the
mouse pointer.

{{index "mousemove event"}}

There are various possible approaches here. You can make your solution
as simple or as complex as you want. A simple solution to start with
is to keep a fixed number of trail elements and cycle through them,
moving the next one to the mouse's current position every time a
`"mousemove"` event occurs.

{{if interactive

```{lang: "text/html", test: no}
<style>
  .trail { /* className for the trail elements */
    position: absolute;
    height: 6px; width: 6px;
    border-radius: 3px;
    background: teal;
  }
  body {
    height: 300px;
  }
</style>

<script>
  // Your code here.
</script>
```

if}}

{{hint

{{index "mouse trail (exercise)"}}

Creating the elements is best done with a loop. Append them to the
document to make them show up. To be able to access them later to change their position, you'll want to store the elements in
an array.

{{index "mousemove event", [array, indexing], "remainder operator", "% operator"}}

Cycling through them can be done by keeping a ((counter variable)) and
adding 1 to it every time the `"mousemove"` event fires. The remainder
operator (`% elements.length`) can then be used to get a valid array
index to pick the element you want to position during a given event.

{{index simulation, "requestAnimationFrame function"}}

Another interesting effect can be achieved by modeling a simple
((physics)) system. Use the `"mousemove"` event only to update a pair
of bindings that track the mouse position. Then use
`requestAnimationFrame` to simulate the trailing elements being
attracted to the position of the mouse pointer. At every animation
step, update their position based on their position relative to the
pointer (and, optionally, a speed that is stored for each element).
Figuring out a good way to do this is up to you.

hint}}

### Tabs

{{index "tabbed interface (exercise)"}}

Tabbed panels are widely used in user interfaces. They allow you to
select an interface panel by choosing from a number of tabs "sticking
out" above an element.

{{index "button (HTML tag)", "display (CSS)", "hidden element", "data attribute"}}

In this exercise you must implement a simple tabbed interface. Write a
function, `asTabs`, that takes a DOM node and creates a tabbed
interface showing the child elements of that node. It should insert a
list of `<button>` elements at the top of the node, one for each child
element, containing text retrieved from the `data-tabname` attribute
of the child. All but one of the original children should be hidden
(given a `display` style of `none`). The currently visible node can be
selected by clicking the buttons.

When that works, extend it to style the button for the currently
selected tab differently so that it is obvious which tab is selected.

{{if interactive

```{lang: "text/html", test: no}
<tab-panel>
  <div data-tabname="one">Tab one</div>
  <div data-tabname="two">Tab two</div>
  <div data-tabname="three">Tab three</div>
</tab-panel>
<script>
  function asTabs(node) {
    // Your code here.
  }
  asTabs(document.querySelector("tab-panel"));
</script>
```

if}}

{{hint

{{index "text node", "childNodes property", "live data structure", "tabbed interface (exercise)", [whitespace, "in HTML"]}}

One pitfall you might run into is that you can't directly use the
node's `childNodes` property as a collection of tab nodes. For one
thing, when you add the buttons, they will also become child nodes and
end up in this object because it is a live data structure. For
another, the text nodes created for the whitespace between the
nodes are also in `childNodes` but should not get their own tabs. You
can use `children` instead of `childNodes` to ignore text nodes.

{{index "TEXT_NODE code", "nodeType property"}}

You could start by building up an array of tabs so that you have easy
access to them. To implement the styling of the buttons, you could
store objects that contain both the tab panel and its button.

I recommend writing a separate function for changing tabs. You can
either store the previously selected tab and change only the styles
needed to hide that and show the new one, or you can just update the
style of all tabs every time a new tab is selected.

You might want to call this function immediately to make the
interface start with the first tab visible.

hint}}
{{meta {load_files: ["code/chapter/16_game.js", "code/levels.js"], zip: "html include=[\"css/game.css\"]"}}}

# Project: A Platform Game

{{quote {author: "Iain Banks", title: "The Player of Games", chapter: true}

All reality is a game.

quote}}

{{index "Banks, Ian", "project chapter", simulation}}

{{figure {url: "img/chapter_picture_16.jpg", alt: "Picture of a game character jumping over lava", chapter: "framed"}}}

Much of my initial fascination with computers, like that of many nerdy
kids, had to do with computer ((game))s. I was drawn into the tiny
simulated ((world))s that I could manipulate and in which stories
(sort of) unfolded—more, I suppose, because of the way I projected my
((imagination)) into them than because of the possibilities they
actually offered.

I don't wish a ((career)) in game programming on anyone. Much like the
((music)) industry, the discrepancy between the number of eager young
people wanting to work in it and the actual demand for such people
creates a rather unhealthy environment. But writing games for fun is
amusing.

{{index "jump-and-run game", dimensions}}

This chapter will walk through the implementation of a small
((platform game)). Platform games (or "jump and run" games) are games
that expect the ((player)) to move a figure through a ((world)), which
is usually two-dimensional and viewed from the side, while jumping over and
onto things.

## The game

{{index minimalism, "Palef, Thomas", "Dark Blue (game)"}}

Our ((game)) will be roughly based on [Dark
Blue](http://www.lessmilk.com/games/10)[
(_www.lessmilk.com/games/10_)]{if book} by Thomas Palef. I chose that
game because it is both entertaining and minimalist and because it
can be built without too much ((code)). It looks like this:

{{figure {url: "img/darkblue.png", alt: "The game Dark Blue"}}}

{{index coin, lava}}

The dark ((box)) represents the ((player)), whose task is to collect
the yellow boxes (coins) while avoiding the red stuff (lava). A
((level)) is completed when all coins have been collected.

{{index keyboard, jumping}}

The player can walk around with the left and right arrow keys and can
jump with the up arrow. Jumping is a specialty of this game character.
It can reach several times its own height and can change
direction in midair. This may not be entirely realistic, but it helps
give the player the feeling of being in direct control of the on-screen
((avatar)).

{{index "fractional number", discretization, "artificial life", "electronic life"}}

The ((game)) consists of a static ((background)), laid out like a
((grid)), with the moving elements overlaid on that background. Each
field on the grid is either empty, solid, or ((lava)). The moving
elements are the player, coins, and certain pieces of lava. The
positions of these elements are not constrained to the grid—their
coordinates may be fractional, allowing smooth ((motion)).

## The technology

{{index "event handling", keyboard, [DOM, graphics]}}

We will use the ((browser)) DOM to display the game, and we'll
read user input by handling key events.

{{index rectangle, "background (CSS)", "position (CSS)", graphics}}

The screen- and keyboard-related code is only a small part of the work
we need to do to build this ((game)). Since everything looks like
colored ((box))es, drawing is uncomplicated: we create DOM elements
and use styling to give them a background color, size, and position.

{{index "table (HTML tag)"}}

We can represent the background as a table since it is an unchanging
((grid)) of squares. The free-moving elements can be overlaid using
absolutely positioned elements.

{{index performance, [DOM, graphics]}}

In games and other programs that should animate ((graphics)) and
respond to user ((input)) without noticeable delay, ((efficiency)) is
important. Although the DOM was not originally designed for
high-performance graphics, it is actually better at this than you
would expect. You saw some ((animation))s in [Chapter
?](dom#animation). On a modern machine, a simple game like this
performs well, even if we don't worry about ((optimization)) very
much.

{{index canvas, [DOM, graphics]}}

In the [next chapter](canvas), we will explore another ((browser))
technology, the `<canvas>` tag, which provides a more traditional way
to draw graphics, working in terms of shapes and ((pixel))s rather
than DOM elements.

## Levels

{{index dimensions}}

We'll want a human-readable, human-editable way to specify levels.
Since it is okay for everything to start out on a grid, we could use
big strings in which each character represents an element—either a
part of the background grid or a moving element.

The plan for a small level might look like this:

```{includeCode: true}
let simpleLevelPlan = `
......................
..#................#..
..#..............=.#..
..#.........o.o....#..
..#.@......#####...#..
..#####............#..
......#++++++++++++#..
......##############..
......................`;
```

{{index level}}

Periods are empty space, hash (`#`) characters are walls, and plus
signs are lava. The ((player))'s starting position is the ((at sign))
(`@`). Every O character is a coin, and the equal sign (`=`) at the
top is a block of lava that moves back and forth horizontally.

{{index bouncing}}

We'll support two additional kinds of moving ((lava)): the pipe
character (`|`) creates vertically moving blobs, and `v` indicates
_dripping_ lava—vertically moving lava that doesn't bounce back and
forth but only moves down, jumping back to its start position when it
hits the floor.

A whole ((game)) consists of multiple ((level))s that the ((player))
must complete. A level is completed when all ((coin))s have been
collected. If the player touches ((lava)), the current level is
restored to its starting position, and the player may try again.

{{id level}}

## Reading a level

{{index "Level class"}}

The following ((class)) stores a ((level)) object. Its argument should
be the string that defines the level.

```{includeCode: true}
class Level {
  constructor(plan) {
    let rows = plan.trim().split("\n").map(l => [...l]);
    this.height = rows.length;
    this.width = rows[0].length;
    this.startActors = [];

    this.rows = rows.map((row, y) => {
      return row.map((ch, x) => {
        let type = levelChars[ch];
        if (typeof type == "string") return type;
        this.startActors.push(
          type.create(new Vec(x, y), ch));
        return "empty";
      });
    });
  }
}
```

{{index "trim method", "split method", [whitespace, trimming]}}

The `trim` method is used to remove whitespace at the start and
end of the plan string. This allows our example plan to start with a
newline so that all the lines are directly below each other. The
remaining string is split on ((newline character))s, and each line is
spread into an array, producing arrays of characters.

{{index [array, "as matrix"]}}

So `rows` holds an array of arrays of characters, the rows of the
plan. We can derive the level's width and height from these. But we
must still separate the moving elements from the background grid.
We'll call moving elements _actors_. They'll be stored in an array of
objects. The background will be an array of arrays of strings, holding
field types such as `"empty"`, `"wall"`, or `"lava"`.

{{index "map method"}}

To create these arrays, we map over the rows and then over their
content. Remember that `map` passes the array index as a second
argument to the mapping function, which tells us the x- and
y-coordinates of a given character. Positions in the game will be
stored as pairs of coordinates, with the top left being 0,0 and each
background square being 1 unit high and wide.

{{index "static method"}}

To interpret the characters in the plan, the `Level` constructor uses
the `levelChars` object, which maps background elements to strings and
actor characters to classes. When `type` is an actor class, its static
`create` method is used to create an object, which is added to
`startActors`, and the mapping function returns `"empty"` for this
background square.

{{index "Vec class"}}

The position of the actor is stored as a `Vec` object. This is a
two-dimensional vector, an object with `x` and `y` properties, as seen
in the exercises of [Chapter ?](object#exercise_vector).

{{index [state, in objects]}}

As the game runs, actors will end up in different places or even
disappear entirely (as coins do when collected). We'll use a `State`
class to track the state of a running game.

```{includeCode: true}
class State {
  constructor(level, actors, status) {
    this.level = level;
    this.actors = actors;
    this.status = status;
  }

  static start(level) {
    return new State(level, level.startActors, "playing");
  }

  get player() {
    return this.actors.find(a => a.type == "player");
  }
}
```

The `status` property will switch to `"lost"` or `"won"` when the game
has ended.

This is again a persistent data structure—updating the game state
creates a new state and leaves the old one intact.

## Actors

{{index actor, "Vec class", [interface, object]}}

Actor objects represent the current position and state of a given
moving element in our game. All actor objects conform to the same
interface. Their `pos` property holds the coordinates of the
element's top-left corner, and their `size` property holds its size.

Then they have an `update` method, which is used to compute their
new state and position after a given time step. It simulates the thing
the actor does—moving in response to the arrow keys for the player and
bouncing back and forth for the lava—and returns a new, updated actor
object.

A `type` property contains a string that identifies the type of the
actor—`"player"`, `"coin"`, or `"lava"`. This is useful when drawing
the game—the look of the rectangle drawn for an actor is based on its
type.

Actor classes have a static `create` method that is used by the
`Level` constructor to create an actor from a character in the level
plan. It is given the coordinates of the character and the character
itself, which is needed because the `Lava` class handles several
different characters.

{{id vector}}

This is the `Vec` class that we'll use for our two-dimensional values,
such as the position and size of actors.

```{includeCode: true}
class Vec {
  constructor(x, y) {
    this.x = x; this.y = y;
  }
  plus(other) {
    return new Vec(this.x + other.x, this.y + other.y);
  }
  times(factor) {
    return new Vec(this.x * factor, this.y * factor);
  }
}
```

{{index "times method", multiplication}}

The `times` method scales a vector by a given number. It will be
useful when we need to multiply a speed vector by a time interval to
get the distance traveled during that time.

The different types of actors get their own classes since their
behavior is very different. Let's define these classes. We'll get to
their `update` methods later.

{{index simulation, "Player class"}}

The player class has a property `speed` that stores its current speed
to simulate momentum and gravity.

```{includeCode: true}
class Player {
  constructor(pos, speed) {
    this.pos = pos;
    this.speed = speed;
  }

  get type() { return "player"; }

  static create(pos) {
    return new Player(pos.plus(new Vec(0, -0.5)),
                      new Vec(0, 0));
  }
}

Player.prototype.size = new Vec(0.8, 1.5);
```

Because a player is one-and-a-half squares high, its initial position
is set to be half a square above the position where the `@` character
appeared. This way, its bottom aligns with the bottom of the square it
appeared in.

The `size` property is the same for all instances of `Player`, so we
store it on the prototype rather than on the instances themselves. We
could have used a ((getter)) like `type`, but that would create and
return a new `Vec` object every time the property is read, which would
be wasteful. (Strings, being ((immutable)), don't have to be re-created
every time they are evaluated.)

{{index "Lava class", bouncing}}

When constructing a `Lava` actor, we need to initialize the object
differently depending on the character it is based on. Dynamic lava
moves along at its current speed until it hits an obstacle. At that
point, if it has a `reset` property, it will jump back to its start
position (dripping). If it does not, it will invert its speed and
continue in the other direction (bouncing).

The `create` method looks at the character that the `Level`
constructor passes and creates the appropriate lava actor.

```{includeCode: true}
class Lava {
  constructor(pos, speed, reset) {
    this.pos = pos;
    this.speed = speed;
    this.reset = reset;
  }

  get type() { return "lava"; }

  static create(pos, ch) {
    if (ch == "=") {
      return new Lava(pos, new Vec(2, 0));
    } else if (ch == "|") {
      return new Lava(pos, new Vec(0, 2));
    } else if (ch == "v") {
      return new Lava(pos, new Vec(0, 3), pos);
    }
  }
}

Lava.prototype.size = new Vec(1, 1);
```

{{index "Coin class", animation}}

`Coin` actors are relatively simple. They mostly just sit in their
place. But to liven up the game a little, they are given a "wobble", a
slight vertical back-and-forth motion. To track this, a coin object
stores a base position as well as a `wobble` property that tracks the
((phase)) of the bouncing motion. Together, these determine the coin's
actual position (stored in the `pos` property).

```{includeCode: true}
class Coin {
  constructor(pos, basePos, wobble) {
    this.pos = pos;
    this.basePos = basePos;
    this.wobble = wobble;
  }

  get type() { return "coin"; }

  static create(pos) {
    let basePos = pos.plus(new Vec(0.2, 0.1));
    return new Coin(basePos, basePos,
                    Math.random() * Math.PI * 2);
  }
}

Coin.prototype.size = new Vec(0.6, 0.6);
```

{{index "Math.random function", "random number", "Math.sin function", sine, wave}}

In [Chapter ?](dom#sin_cos), we saw that `Math.sin` gives us the
y-coordinate of a point on a circle. That coordinate goes back and
forth in a smooth waveform as we move along the circle, which makes
the sine function useful for modeling a wavy motion.

{{index pi}}

To avoid a situation where all coins move up and down synchronously,
the starting phase of each coin is randomized. The _((phase))_ of
`Math.sin`'s wave, the width of a wave it produces, is 2π. We multiply
the value returned by `Math.random` by that number to give the coin a
random starting position on the wave.

{{index map, [object, "as map"]}}

We can now define the `levelChars` object that maps plan characters to
either background grid types or actor classes.

```{includeCode: true}
const levelChars = {
  ".": "empty", "#": "wall", "+": "lava",
  "@": Player, "o": Coin,
  "=": Lava, "|": Lava, "v": Lava
};
```

That gives us all the parts needed to create a `Level` instance.

```{includeCode: strip_log}
let simpleLevel = new Level(simpleLevelPlan);
console.log(`${simpleLevel.width} by ${simpleLevel.height}`);
// → 22 by 9
```

The task ahead is to display such levels on the screen and to model
time and motion inside them.

## Encapsulation as a burden

{{index "programming style", "program size", complexity}}

Most of the code in this chapter does not worry about
((encapsulation)) very much for two reasons. First, encapsulation
takes extra effort. It makes programs bigger and requires additional
concepts and interfaces to be introduced. Since there is only so much
code you can throw at a reader before their eyes glaze over, I've made
an effort to keep the program small.

{{index [interface, design]}}

Second, the various elements in this game are so closely tied together
that if the behavior of one of them changed, it is unlikely that any
of the others would be able to stay the same. Interfaces between the
elements would end up encoding a lot of assumptions about the way the
game works. This makes them a lot less effective—whenever you change
one part of the system, you still have to worry about the way it
impacts the other parts because their interfaces wouldn't cover the
new situation.

Some _((cutting point))s_ in a system lend themselves well to
separation through rigorous interfaces, but others don't. Trying to
encapsulate something that isn't a suitable boundary is a sure way to
waste a lot of energy. When you are making this mistake, you'll
usually notice that your interfaces are getting awkwardly large and
detailed and that they need to be changed often, as the program
evolves.

{{index graphics, encapsulation, graphics}}

There is one thing that we _will_ encapsulate, and that is the
((drawing)) subsystem. The reason for this is that we'll ((display))
the same game in a different way in the [next
chapter](canvas#canvasdisplay). By putting the drawing behind an
interface, we can load the same game program there and plug in a new
display ((module)).

{{id domdisplay}}

## Drawing

{{index "DOMDisplay class", [DOM, graphics]}}

The encapsulation of the ((drawing)) code is done by defining a
_((display))_ object, which displays a given ((level)) and state. The
display type we define in this chapter is called `DOMDisplay` because
it uses DOM elements to show the level.

{{index "style attribute", CSS}}

We'll be using a style sheet to set the actual colors and other
fixed properties of the elements that make up the game. It would also
be possible to directly assign to the elements' `style` property when
we create them, but that would produce more verbose programs.

{{index "class attribute"}}

The following helper function provides a succinct way to create an
element and give it some attributes and child nodes:

```{includeCode: true}
function elt(name, attrs, ...children) {
  let dom = document.createElement(name);
  for (let attr of Object.keys(attrs)) {
    dom.setAttribute(attr, attrs[attr]);
  }
  for (let child of children) {
    dom.appendChild(child);
  }
  return dom;
}
```

A display is created by giving it a parent element to which it should
append itself and a ((level)) object.

```{includeCode: true}
class DOMDisplay {
  constructor(parent, level) {
    this.dom = elt("div", {class: "game"}, drawGrid(level));
    this.actorLayer = null;
    parent.appendChild(this.dom);
  }

  clear() { this.dom.remove(); }
}
```

{{index level}}

The level's ((background)) grid, which never changes, is drawn once.
Actors are redrawn every time the display is updated with a given
state. The `actorLayer` property will be used to track the element
that holds the actors so that they can be easily removed and replaced.

{{index scaling, "DOMDisplay class"}}

Our ((coordinates)) and sizes are tracked in ((grid)) units, where a
size or distance of 1 means one grid block. When setting ((pixel))
sizes, we will have to scale these coordinates up—everything in the
game would be ridiculously small at a single pixel per square. The
`scale` constant gives the number of pixels that a single unit takes
up on the screen.

```{includeCode: true}
const scale = 20;

function drawGrid(level) {
  return elt("table", {
    class: "background",
    style: `width: ${level.width * scale}px`
  }, ...level.rows.map(row =>
    elt("tr", {style: `height: ${scale}px`},
        ...row.map(type => elt("td", {class: type})))
  ));
}
```

{{index "table (HTML tag)", "tr (HTML tag)", "td (HTML tag)", "spread operator"}}

As mentioned, the background is drawn as a `<table>` element.
This nicely corresponds to the structure of the `rows` property of the
level—each row of the grid is turned into a table row (`<tr>`
element). The strings in the grid are used as class names for the
table cell (`<td>`) elements. The spread (triple dot) operator is used
to pass arrays of child nodes to `elt` as separate arguments.

{{id game_css}}

The following ((CSS)) makes the table look like the background we
want:

```{lang: "text/css"}
.background    { background: rgb(52, 166, 251);
                 table-layout: fixed;
                 border-spacing: 0;              }
.background td { padding: 0;                     }
.lava          { background: rgb(255, 100, 100); }
.wall          { background: white;              }
```

{{index "padding (CSS)"}}

Some of these (`table-layout`, `border-spacing`, and `padding`) are
used to suppress unwanted default behavior. We don't want the layout
of the ((table)) to depend upon the contents of its cells, and we
don't want space between the ((table)) cells or padding inside them.

{{index "background (CSS)", "rgb (CSS)", CSS}}

The `background` rule sets the background color. CSS allows colors to
be specified both as words (`white`) or with a format such as
`rgb(R, G, B)`, where the red, green, and blue components of the color
are separated into three numbers from 0 to 255. So, in `rgb(52, 166,
251)`, the red component is 52, green is 166, and blue is 251. Since
the blue component is the largest, the resulting color will be bluish.
You can see that in the `.lava` rule, the first number (red) is the
largest.

{{index [DOM, graphics]}}

We draw each ((actor)) by creating a DOM element for it and
setting that element's position and size based on the actor's
properties. The values have to be multiplied by `scale` to go from
game units to pixels.

```{includeCode: true}
function drawActors(actors) {
  return elt("div", {}, ...actors.map(actor => {
    let rect = elt("div", {class: `actor ${actor.type}`});
    rect.style.width = `${actor.size.x * scale}px`;
    rect.style.height = `${actor.size.y * scale}px`;
    rect.style.left = `${actor.pos.x * scale}px`;
    rect.style.top = `${actor.pos.y * scale}px`;
    return rect;
  }));
}
```

{{index "position (CSS)", "class attribute"}}

To give an element more than one class, we separate the class names by
spaces. In the ((CSS)) code shown next, the `actor` class gives the
actors their absolute position. Their type name is used as an extra
class to give them a color. We don't have to define the `lava` class
again because we're reusing the class for the lava grid squares we
defined earlier.

```{lang: "text/css"}
.actor  { position: absolute;            }
.coin   { background: rgb(241, 229, 89); }
.player { background: rgb(64, 64, 64);   }
```

{{index graphics, optimization, efficiency, [state, "of application"], [DOM, graphics]}}

The `syncState` method is used to make the display show a given state.
It first removes the old actor graphics, if any, and then redraws the
actors in their new positions. It may be tempting to try to reuse the
DOM elements for actors, but to make that work, we would need a
lot of additional bookkeeping to associate actors with DOM elements
and to make sure we remove elements when their actors vanish. Since
there will typically be only a handful of actors in the game,
redrawing all of them is not expensive.

```{includeCode: true}
DOMDisplay.prototype.syncState = function(state) {
  if (this.actorLayer) this.actorLayer.remove();
  this.actorLayer = drawActors(state.actors);
  this.dom.appendChild(this.actorLayer);
  this.dom.className = `game ${state.status}`;
  this.scrollPlayerIntoView(state);
};
```

{{index level, "class attribute"}}

By adding the level's current status as a class name to the wrapper,
we can style the player actor slightly differently when the game is
won or lost by adding a ((CSS)) rule that takes effect only when the
player has an ((ancestor element)) with a given class.

```{lang: "text/css"}
.lost .player {
  background: rgb(160, 64, 64);
}
.won .player {
  box-shadow: -4px -7px 8px white, 4px -7px 8px white;
}
```

{{index player, "box shadow (CSS)"}}

After touching ((lava)), the player's color turns dark red, suggesting
scorching. When the last coin has been collected, we add two blurred
white shadows—one to the top left and one to the top right—to create a
white halo effect.

{{id viewport}}

{{index "position (CSS)", "max-width (CSS)", "overflow (CSS)", "max-height (CSS)", viewport, scrolling, [DOM, graphics]}}

We can't assume that the level always fits in the _viewport_—the
element into which we draw the game. That is why the
`scrollPlayerIntoView` call is needed. It ensures that if the level is
protruding outside the viewport, we scroll that viewport to make sure
the player is near its center. The following ((CSS)) gives the game's
wrapping DOM element a maximum size and ensures that anything that
sticks out of the element's box is not visible. We also give it
a relative position so that the actors inside it are
positioned relative to the level's top-left corner.

```{lang: "text/css"}
.game {
  overflow: hidden;
  max-width: 600px;
  max-height: 450px;
  position: relative;
}
```

{{index scrolling}}

In the `scrollPlayerIntoView` method, we find the player's position
and update the wrapping element's scroll position. We change the
scroll position by manipulating that element's `scrollLeft` and
`scrollTop` properties when the player is too close to the edge.

```{includeCode: true}
DOMDisplay.prototype.scrollPlayerIntoView = function(state) {
  let width = this.dom.clientWidth;
  let height = this.dom.clientHeight;
  let margin = width / 3;

  // The viewport
  let left = this.dom.scrollLeft, right = left + width;
  let top = this.dom.scrollTop, bottom = top + height;

  let player = state.player;
  let center = player.pos.plus(player.size.times(0.5))
                         .times(scale);

  if (center.x < left + margin) {
    this.dom.scrollLeft = center.x - margin;
  } else if (center.x > right - margin) {
    this.dom.scrollLeft = center.x + margin - width;
  }
  if (center.y < top + margin) {
    this.dom.scrollTop = center.y - margin;
  } else if (center.y > bottom - margin) {
    this.dom.scrollTop = center.y + margin - height;
  }
};
```

{{index center, coordinates, readability}}

The way the player's center is found shows how the methods on our
`Vec` type allow computations with objects to be written in a
relatively readable way. To find the actor's center, we add its
position (its top-left corner) and half its size. That is the center
in level coordinates, but we need it in pixel coordinates, so we then
multiply the resulting vector by our display scale.

{{index validation}}

Next, a series of checks verifies that the player position isn't outside
of the allowed range. Note that sometimes this will set nonsense
scroll coordinates that are below zero or beyond the element's scrollable
area. This is okay—the DOM will constrain them to acceptable values.
Setting `scrollLeft` to -10 will cause it to become 0.

It would have been slightly simpler to always try to scroll the player
to the center of the ((viewport)). But this creates a rather jarring
effect. As you are jumping, the view will constantly shift up and
down. It is more pleasant to have a "neutral" area in the middle of
the screen where you can move around without causing any scrolling.

{{index [game, screenshot]}}

We are now able to display our tiny level.

```{lang: "text/html"}
<link rel="stylesheet" href="css/game.css">

<script>
  let simpleLevel = new Level(simpleLevelPlan);
  let display = new DOMDisplay(document.body, simpleLevel);
  display.syncState(State.start(simpleLevel));
</script>
```

{{if book

{{figure {url: "img/game_simpleLevel.png", alt: "Our level rendered",width: "7cm"}}}

if}}

{{index "link (HTML tag)", CSS}}

The `<link>` tag, when used with `rel="stylesheet"`, is a way to load
a CSS file into a page. The file `game.css` contains the styles
necessary for our game.

## Motion and collision

{{index physics, [animation, "platform game"]}}

Now we're at the point where we can start adding motion—the most
interesting aspect of the game. The basic approach, taken by most
games like this, is to split ((time)) into small steps and, for each
step, move the actors by a distance corresponding to their speed
multiplied by the size of the time step. We'll measure time in
seconds, so speeds are expressed in units per second.

{{index obstacle, "collision detection"}}

Moving things is easy. The difficult part is dealing with the
interactions between the elements. When the player hits a wall or
floor, they should not simply move through it. The game must notice
when a given motion causes an object to hit another object and respond
accordingly. For walls, the motion must be stopped. When hitting a
coin, it must be collected. When touching lava, the game should be lost.

Solving this for the general case is a big task. You can find
libraries, usually called _((physics engine))s_, that simulate
interaction between physical objects in two or three ((dimensions)).
We'll take a more modest approach in this chapter, handling only
collisions between rectangular objects and handling them in a rather
simplistic way.

{{index bouncing, "collision detection", [animation, "platform game"]}}

Before moving the ((player)) or a block of ((lava)), we test whether
the motion would take it inside of a wall. If it does, we simply
cancel the motion altogether. The response to such a collision depends
on the type of actor—the player will stop, whereas a lava block will
bounce back.

{{index discretization}}

This approach requires our ((time)) steps to be rather small since it
will cause motion to stop before the objects actually touch. If the
time steps (and thus the motion steps) are too big, the player would
end up hovering a noticeable distance above the ground. Another
approach, arguably better but more complicated, would be to find the
exact collision spot and move there. We will take the simple approach
and hide its problems by ensuring the animation proceeds in small
steps.

{{index obstacle, "touches method", "collision detection"}}

{{id touches}}

This method tells us whether a ((rectangle)) (specified by a position
and a size) touches a grid element of the given type.

```{includeCode: true}
Level.prototype.touches = function(pos, size, type) {
  var xStart = Math.floor(pos.x);
  var xEnd = Math.ceil(pos.x + size.x);
  var yStart = Math.floor(pos.y);
  var yEnd = Math.ceil(pos.y + size.y);

  for (var y = yStart; y < yEnd; y++) {
    for (var x = xStart; x < xEnd; x++) {
      let isOutside = x < 0 || x >= this.width ||
                      y < 0 || y >= this.height;
      let here = isOutside ? "wall" : this.rows[y][x];
      if (here == type) return true;
    }
  }
  return false;
};
```

{{index "Math.floor function", "Math.ceil function"}}

The method computes the set of grid squares that the body ((overlap))s
with by using `Math.floor` and `Math.ceil` on its ((coordinates)).
Remember that ((grid)) squares are 1 by 1 units in size. By
((rounding)) the sides of a box up and down, we get the range of
((background)) squares that the box touches.

{{figure {url: "img/game-grid.svg", alt: "Finding collisions on a grid",width: "3cm"}}}

We loop over the block of ((grid)) squares found by ((rounding)) the
((coordinates)) and return `true` when a matching square is found.
Squares outside of the level are always treated as `"wall"` to ensure
that the player can't leave the world and that we won't accidentally
try to read outside of the bounds of our `rows` array.

The state `update` method uses `touches` to figure out whether the player
is touching lava.

```{includeCode: true}
State.prototype.update = function(time, keys) {
  let actors = this.actors
    .map(actor => actor.update(time, this, keys));
  let newState = new State(this.level, actors, this.status);

  if (newState.status != "playing") return newState;

  let player = newState.player;
  if (this.level.touches(player.pos, player.size, "lava")) {
    return new State(this.level, actors, "lost");
  }

  for (let actor of actors) {
    if (actor != player && overlap(actor, player)) {
      newState = actor.collide(newState);
    }
  }
  return newState;
};
```

The method is passed a time step and a data structure that tells it which keys
are being held down. The first thing it does is call the `update`
method on all actors, producing an array of updated actors. The actors
also get the time step, the keys, and the state, so that they can base
their update on those. Only the player will actually read keys, since
that's the only actor that's controlled by the keyboard.

If the game is already over, no further processing has to be done (the
game can't be won after being lost, or vice versa). Otherwise, the
method tests whether the player is touching background lava. If so,
the game is lost, and we're done. Finally, if the game really is still
going on, it sees whether any other actors overlap the player.

Overlap between actors is detected with the `overlap` function. It
takes two actor objects and returns true when they touch—which is the
case when they overlap both along the x-axis and along the y-axis.

```{includeCode: true}
function overlap(actor1, actor2) {
  return actor1.pos.x + actor1.size.x > actor2.pos.x &&
         actor1.pos.x < actor2.pos.x + actor2.size.x &&
         actor1.pos.y + actor1.size.y > actor2.pos.y &&
         actor1.pos.y < actor2.pos.y + actor2.size.y;
}
```

If any actor does overlap, its `collide` method gets a chance to
update the state. Touching a lava actor sets the game status to
`"lost"`. Coins vanish when you touch them and set the status to
`"won"` when they are the last coin of the level.

```{includeCode: true}
Lava.prototype.collide = function(state) {
  return new State(state.level, state.actors, "lost");
};

Coin.prototype.collide = function(state) {
  let filtered = state.actors.filter(a => a != this);
  let status = state.status;
  if (!filtered.some(a => a.type == "coin")) status = "won";
  return new State(state.level, filtered, status);
};
```

{{id actors}}

## Actor updates

{{index actor, "Lava class", lava}}

Actor objects' `update` methods take as arguments the time step, the
state object, and a `keys` object. The one for the `Lava` actor type
ignores the `keys` object.

```{includeCode: true}
Lava.prototype.update = function(time, state) {
  let newPos = this.pos.plus(this.speed.times(time));
  if (!state.level.touches(newPos, this.size, "wall")) {
    return new Lava(newPos, this.speed, this.reset);
  } else if (this.reset) {
    return new Lava(this.reset, this.speed, this.reset);
  } else {
    return new Lava(this.pos, this.speed.times(-1));
  }
};
```

{{index bouncing, multiplication, "Vec class", "collision detection"}}

This `update` method computes a new position by adding the product of the ((time)) step
and the current speed to its old position. If no obstacle blocks that
new position, it moves there. If there is an obstacle, the behavior
depends on the type of the ((lava)) block—dripping lava has a `reset`
position, to which it jumps back when it hits something. Bouncing lava
inverts its speed by multiplying it by -1 so that it starts moving in
the opposite direction.

{{index "Coin class", coin, wave}}

Coins use their `update` method to wobble. They ignore collisions with
the grid since they are simply wobbling around inside of their own
square.

```{includeCode: true}
const wobbleSpeed = 8, wobbleDist = 0.07;

Coin.prototype.update = function(time) {
  let wobble = this.wobble + time * wobbleSpeed;
  let wobblePos = Math.sin(wobble) * wobbleDist;
  return new Coin(this.basePos.plus(new Vec(0, wobblePos)),
                  this.basePos, wobble);
};
```

{{index "Math.sin function", sine, phase}}

The `wobble` property is incremented to track time and then used as an
argument to `Math.sin` to find the new position on the ((wave)). The
coin's current position is then computed from its base position and an
offset based on this wave.

{{index "collision detection", "Player class"}}

That leaves the ((player)) itself. Player motion is handled separately
per ((axis)) because hitting the floor should not prevent horizontal
motion, and hitting a wall should not stop falling or jumping motion.

```{includeCode: true}
const playerXSpeed = 7;
const gravity = 30;
const jumpSpeed = 17;

Player.prototype.update = function(time, state, keys) {
  let xSpeed = 0;
  if (keys.ArrowLeft) xSpeed -= playerXSpeed;
  if (keys.ArrowRight) xSpeed += playerXSpeed;
  let pos = this.pos;
  let movedX = pos.plus(new Vec(xSpeed * time, 0));
  if (!state.level.touches(movedX, this.size, "wall")) {
    pos = movedX;
  }

  let ySpeed = this.speed.y + time * gravity;
  let movedY = pos.plus(new Vec(0, ySpeed * time));
  if (!state.level.touches(movedY, this.size, "wall")) {
    pos = movedY;
  } else if (keys.ArrowUp && ySpeed > 0) {
    ySpeed = -jumpSpeed;
  } else {
    ySpeed = 0;
  }
  return new Player(pos, new Vec(xSpeed, ySpeed));
};
```

{{index [animation, "platform game"], keyboard}}

The horizontal motion is computed based on the state of the left and
right arrow keys. When there's no wall blocking the new position
created by this motion, it is used. Otherwise, the old position is
kept.

{{index acceleration, physics}}

Vertical motion works in a similar way but has to simulate ((jumping))
and ((gravity)). The player's vertical speed (`ySpeed`) is first
accelerated to account for ((gravity)).

{{index "collision detection", keyboard, jumping}}

We check for walls again. If we don't hit any, the new position is
used. If there _is_ a wall, there are two possible outcomes. When the
up arrow is pressed _and_ we are moving down (meaning the thing we hit
is below us), the speed is set to a relatively large, negative value.
This causes the player to jump. If that is not the case, the player
simply bumped into something, and the speed is set to zero.

The gravity strength, ((jumping)) speed, and pretty much all other
((constant))s in this game have been set by ((trial and error)). I
tested values until I found a combination I liked.

## Tracking keys

{{index keyboard}}

For a ((game)) like this, we do not want keys to take effect once per
keypress. Rather, we want their effect (moving the player figure) to
stay active as long as they are held.

{{index "preventDefault method"}}

We need to set up a key handler that stores the current state of the
left, right, and up arrow keys. We will also want to call
`preventDefault` for those keys so that they don't end up
((scrolling)) the page.

{{index "trackKeys function", "key code", "event handling", "addEventListener method"}}

The following function, when given an array of key names, will return
an object that tracks the current position of those keys. It registers
event handlers for `"keydown"` and `"keyup"` events and, when the key
code in the event is present in the set of codes that it is tracking,
updates the object.

```{includeCode: true}
function trackKeys(keys) {
  let down = Object.create(null);
  function track(event) {
    if (keys.includes(event.key)) {
      down[event.key] = event.type == "keydown";
      event.preventDefault();
    }
  }
  window.addEventListener("keydown", track);
  window.addEventListener("keyup", track);
  return down;
}

const arrowKeys =
  trackKeys(["ArrowLeft", "ArrowRight", "ArrowUp"]);
```

{{index "keydown event", "keyup event"}}

The same handler function is used for both event types. It looks at
the event object's `type` property to determine whether the key state
should be updated to true (`"keydown"`) or false (`"keyup"`).

{{id runAnimation}}

## Running the game

{{index "requestAnimationFrame function", [animation, "platform game"]}}

The `requestAnimationFrame` function, which we saw in [Chapter
?](dom#animationFrame), provides a good way to animate a game. But its
interface is quite primitive—using it requires us to track the time at
which our function was called the last time around and call
`requestAnimationFrame` again after every frame.

{{index "runAnimation function", "callback function", [function, "as value"], [function, "higher-order"], [animation, "platform game"]}}

Let's define a helper function that wraps those boring parts in a
convenient interface and allows us to simply call `runAnimation`,
giving it a function that expects a time difference as an argument and
draws a single frame. When the frame function returns the value
`false`, the animation stops.

```{includeCode: true}
function runAnimation(frameFunc) {
  let lastTime = null;
  function frame(time) {
    if (lastTime != null) {
      let timeStep = Math.min(time - lastTime, 100) / 1000;
      if (frameFunc(timeStep) === false) return;
    }
    lastTime = time;
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}
```

{{index time, discretization}}

I have set a maximum frame step of 100 milliseconds (one-tenth of a
second). When the browser tab or window with our page is hidden,
`requestAnimationFrame` calls will be suspended until the tab or
window is shown again. In this case, the difference between `lastTime`
and `time` will be the entire time in which the page was hidden.
Advancing the game by that much in a single step would look silly and
might cause weird side effects, such as the player falling through the
floor.

The function also converts the time steps to seconds, which are an
easier quantity to think about than milliseconds.

{{index "callback function", "runLevel function", [animation, "platform game"]}}

The `runLevel` function takes a `Level` object and a ((display))
constructor and returns a promise. It displays the level (in
`document.body`) and lets the user play through it. When the level is
finished (lost or won), `runLevel` waits one more second (to let the
user see what happens) and then clears the display, stops the
animation, and resolves the promise to the game's end status.

```{includeCode: true}
function runLevel(level, Display) {
  let display = new Display(document.body, level);
  let state = State.start(level);
  let ending = 1;
  return new Promise(resolve => {
    runAnimation(time => {
      state = state.update(time, arrowKeys);
      display.syncState(state);
      if (state.status == "playing") {
        return true;
      } else if (ending > 0) {
        ending -= time;
        return true;
      } else {
        display.clear();
        resolve(state.status);
        return false;
      }
    });
  });
}
```

{{index "runGame function"}}

A game is a sequence of ((level))s. Whenever the ((player)) dies, the
current level is restarted. When a level is completed, we move on to
the next level. This can be expressed by the following function, which
takes an array of level plans (strings) and a ((display)) constructor:

```{includeCode: true}
async function runGame(plans, Display) {
  for (let level = 0; level < plans.length;) {
    let status = await runLevel(new Level(plans[level]),
                                Display);
    if (status == "won") level++;
  }
  console.log("You've won!");
}
```

{{index "asynchronous programming", "event handling"}}

Because we made `runLevel` return a promise, `runGame` can be written
using an `async` function, as shown in [Chapter ?](async). It returns
another promise, which resolves when the player finishes the game.

{{index game, "GAME_LEVELS data set"}}

There is a set of ((level)) plans available in the `GAME_LEVELS`
binding in [this chapter's
sandbox](https://eloquentjavascript.net/code#16)[
([_https://eloquentjavascript.net/code#16_](https://eloquentjavascript.net/code#16))]{if
book}. This page feeds them to `runGame`, starting an actual game.

```{sandbox: null, focus: yes, lang: "text/html", startCode: true}
<link rel="stylesheet" href="css/game.css">

<body>
  <script>
    runGame(GAME_LEVELS, DOMDisplay);
  </script>
</body>
```

{{if interactive

See if you can beat those. I had quite a lot of fun building them.

if}}

## Exercises

### Game over

{{index "lives (exercise)", game}}

It's traditional for ((platform game))s to have the player start with
a limited number of _lives_ and subtract one life each time they die.
When the player is out of lives, the game restarts from the beginning.

{{index "runGame function"}}

Adjust `runGame` to implement lives. Have the player start with three.
Output the current number of lives (using `console.log`) every time a
level starts.

{{if interactive

```{lang: "text/html", test: no, focus: yes}
<link rel="stylesheet" href="css/game.css">

<body>
<script>
  // The old runGame function. Modify it...
  async function runGame(plans, Display) {
    for (let level = 0; level < plans.length;) {
      let status = await runLevel(new Level(plans[level]),
                                  Display);
      if (status == "won") level++;
    }
    console.log("You've won!");
  }
  runGame(GAME_LEVELS, DOMDisplay);
</script>
</body>
```

if}}

### Pausing the game

{{index "pausing (exercise)", "escape key", keyboard}}

Make it possible to pause (suspend) and unpause the game by pressing
the Esc key.

{{index "runLevel function", "event handling"}}

This can be done by changing the `runLevel` function to use another
keyboard event handler and interrupting or resuming the animation
whenever the Esc key is hit.

{{index "runAnimation function"}}

The `runAnimation` interface may not look like it is suitable for this
at first glance, but it is if you rearrange the way `runLevel` calls
it.

{{index [binding, global], "trackKeys function"}}

When you have that working, there is something else you could try. The
way we have been registering keyboard event handlers is somewhat
problematic. The `arrowKeys` object is currently a global binding, and
its event handlers are kept around even when no game is running. You
could say they _((leak))_ out of our system. Extend `trackKeys` to
provide a way to unregister its handlers and then change `runLevel`
to register its handlers when it starts and unregister them again when
it is finished.

{{if interactive

```{lang: "text/html", focus: yes, test: no}
<link rel="stylesheet" href="css/game.css">

<body>
<script>
  // The old runLevel function. Modify this...
  function runLevel(level, Display) {
    let display = new Display(document.body, level);
    let state = State.start(level);
    let ending = 1;
    return new Promise(resolve => {
      runAnimation(time => {
        state = state.update(time, arrowKeys);
        display.syncState(state);
        if (state.status == "playing") {
          return true;
        } else if (ending > 0) {
          ending -= time;
          return true;
        } else {
          display.clear();
          resolve(state.status);
          return false;
        }
      });
    });
  }
  runGame(GAME_LEVELS, DOMDisplay);
</script>
</body>
```

if}}

{{hint

{{index "pausing (exercise)", [animation, "platform game"]}}

An animation can be interrupted by returning `false` from the
function given to `runAnimation`. It can be continued by calling
`runAnimation` again.

{{index closure}}

So we need to communicate the fact that we are pausing the game to the
function given to `runAnimation`. For that, you can use a binding that
both the event handler and that function have access to.

{{index "event handling", "removeEventListener method", [function, "as value"]}}

When finding a way to unregister the handlers registered by
`trackKeys`, remember that the _exact_ same function value that was
passed to `addEventListener` must be passed to `removeEventListener`
to successfully remove a handler. Thus, the `handler` function value
created in `trackKeys` must be available to the code that unregisters
the handlers.

You can add a property to the object returned by `trackKeys`,
containing either that function value or a method that handles the
unregistering directly.

hint}}

### A monster

{{index "monster (exercise)"}}

It is traditional for platform games to have enemies that you can jump
on top of to defeat. This exercise asks you to add such an actor type
to the game.

We'll call it a monster. Monsters move only horizontally. You can make
them move in the direction of the player, bounce back and forth
like horizontal lava, or have any movement pattern you want. The class
doesn't have to handle falling, but it should make sure the monster
doesn't walk through walls.

When a monster touches the player, the effect depends on whether the
player is jumping on top of them or not. You can approximate this by
checking whether the player's bottom is near the monster's top. If
this is the case, the monster disappears. If not, the game is lost.

{{if interactive

```{test: no, lang: "text/html", focus: yes}
<link rel="stylesheet" href="css/game.css">
<style>.monster { background: purple }</style>

<body>
  <script>
    // Complete the constructor, update, and collide methods
    class Monster {
      constructor(pos, /* ... */) {}

      get type() { return "monster"; }

      static create(pos) {
        return new Monster(pos.plus(new Vec(0, -1)));
      }

      update(time, state) {}

      collide(state) {}
    }

    Monster.prototype.size = new Vec(1.2, 2);

    levelChars["M"] = Monster;

    runLevel(new Level(`
..................................
.################################.
.#..............................#.
.#..............................#.
.#..............................#.
.#...........................o..#.
.#..@...........................#.
.##########..............########.
..........#..o..o..o..o..#........
..........#...........M..#........
..........################........
..................................
`), DOMDisplay);
  </script>
</body>
```

if}}

{{hint

{{index "monster (exercise)", "persistent data structure"}}

If you want to implement a type of motion that is stateful, such as
bouncing, make sure you store the necessary state in the actor
object—include it as constructor argument and add it as a property.

Remember that `update` returns a _new_ object, rather than changing
the old one.

{{index "collision detection"}}

When handling collision, find the player in `state.actors` and
compare its position to the monster's position. To get the _bottom_ of
the player, you have to add its vertical size to its vertical
position. The creation of an updated state will resemble either
`Coin`'s `collide` method (removing the actor) or `Lava`'s (changing
the status to `"lost"`), depending on the player position.

hint}}
{{meta {load_files: ["code/chapter/16_game.js", "code/levels.js", "code/chapter/17_canvas.js"], zip: "html include=[\"img/player.png\", \"img/sprites.png\"]"}}}

# Drawing on Canvas

{{quote {author: "M.C. Escher", title: "cited by Bruno Ernst in The Magic Mirror of M.C. Escher", chapter: true}

Drawing is deception.

quote}}

{{index "Escher, M.C."}}

{{figure {url: "img/chapter_picture_17.jpg", alt: "Picture of a robot arm drawing on paper", chapter: "framed"}}}

{{index CSS, "transform (CSS)", [DOM, graphics]}}

Browsers give us several ways to display ((graphics)). The simplest
way is to use styles to position and color regular DOM elements.
This can get you quite far, as the game in the [previous
chapter](game) showed. By adding partially transparent background
((image))s to the nodes, we can make them look exactly the way we
want. It is even possible to rotate or skew nodes with the `transform`
style.

But we'd be using the DOM for something that it wasn't originally
designed for. Some tasks, such as drawing a ((line)) between
arbitrary points, are extremely awkward to do with regular
HTML elements.

{{index SVG, "img (HTML tag)"}}

There are two alternatives. The first is DOM-based but utilizes
_Scalable Vector Graphics_ (SVG), rather than HTML. Think of SVG as a
((document))-markup dialect that focuses on ((shape))s rather than
text. You can embed an SVG document directly in an HTML document or
include it with an `<img>` tag.

{{index clearing, [DOM graphics], [interface, canvas]}}

The second alternative is called a _((canvas))_. A canvas is a single
DOM element that encapsulates a ((picture)). It provides a
programming interface for drawing ((shape))s onto the space taken
up by the node. The main difference between a canvas and an SVG
picture is that in SVG the original description of the shapes is
preserved so that they can be moved or resized at any time. A canvas,
on the other hand, converts the shapes to ((pixel))s (colored dots on
a raster) as soon as they are drawn and does not remember what these
pixels represent. The only way to move a shape on a canvas is to clear
the canvas (or the part of the canvas around the shape) and redraw it
with the shape in a new position.

## SVG

This book will not go into ((SVG)) in detail, but I will briefly
explain how it works. At the [end of the
chapter](canvas#graphics_tradeoffs), I'll come back to the trade-offs
that you must consider when deciding which ((drawing)) mechanism is
appropriate for a given application.

This is an HTML document with a simple SVG ((picture)) in it:

```{lang: "text/html", sandbox: "svg"}
<p>Normal HTML here.</p>
<svg xmlns="http://www.w3.org/2000/svg">
  <circle r="50" cx="50" cy="50" fill="red"/>
  <rect x="120" y="5" width="90" height="90"
        stroke="blue" fill="none"/>
</svg>
```

{{index "circle (SVG tag)", "rect (SVG tag)", "XML namespace", XML, "xmlns attribute"}}

The `xmlns` attribute changes an element (and its children) to a
different _XML namespace_. This namespace, identified by a ((URL)),
specifies the dialect that we are currently speaking. The `<circle>`
and `<rect>` tags, which do not exist in HTML, do have a meaning in
SVG—they draw shapes using the style and position specified by their
attributes.

{{if book

The document is displayed like this:

{{figure {url: "img/svg-demo.png", alt: "An embedded SVG image",width: "4.5cm"}}}

if}}

{{index [DOM, graphics]}}

These tags create DOM elements, just like HTML tags, that
scripts can interact with. For example, this changes the `<circle>`
element to be ((color))ed cyan instead:

```{sandbox: "svg"}
let circle = document.querySelector("circle");
circle.setAttribute("fill", "cyan");
```

## The canvas element

{{index [canvas, size], "canvas (HTML tag)"}}

Canvas ((graphics)) can be drawn onto a `<canvas>` element. You can
give such an element `width` and `height` attributes to determine its
size in ((pixel))s.

A new canvas is empty, meaning it is entirely ((transparent)) and thus
shows up as empty space in the document.

{{index "2d (canvas context)", "webgl (canvas context)", OpenGL, [canvas, context], dimensions, [interface, canvas]}}

The `<canvas>` tag is intended to allow different styles of
((drawing)). To get access to an actual drawing interface, we
first need to create a _((context))_, an object whose methods provide
the drawing interface. There are currently two widely supported
drawing styles: `"2d"` for two-dimensional graphics and `"webgl"` for
three-dimensional graphics through the OpenGL interface.

{{index rendering, graphics, efficiency}}

This book won't discuss WebGL—we'll stick to two dimensions. But if
you are interested in three-dimensional graphics, I do encourage you
to look into WebGL. It provides a direct interface to graphics
hardware and allows you to render even complicated scenes efficiently,
using JavaScript.

{{index "getContext method", [canvas, context]}}

You create a ((context)) with the `getContext` method on the
`<canvas>` DOM element.

```{lang: "text/html"}
<p>Before canvas.</p>
<canvas width="120" height="60"></canvas>
<p>After canvas.</p>
<script>
  let canvas = document.querySelector("canvas");
  let context = canvas.getContext("2d");
  context.fillStyle = "red";
  context.fillRect(10, 10, 100, 50);
</script>
```

After creating the context object, the example draws a red
((rectangle)) 100 ((pixel))s wide and 50 pixels high, with its top-left
corner at coordinates (10,10).

{{if book

{{figure {url: "img/canvas_fill.png", alt: "A canvas with a rectangle",width: "2.5cm"}}}

if}}

{{index SVG, coordinates}}

Just like in HTML (and SVG), the coordinate system that the canvas
uses puts (0,0) at the top-left corner, and the positive y-((axis))
goes down from there. So (10,10) is 10 pixels below and to the right
of the top-left corner.

{{id fill_stroke}}

## Lines and surfaces

{{index filling, stroking, drawing, SVG}}

In the ((canvas)) interface, a shape can be _filled_, meaning its area
is given a certain color or pattern, or it can be _stroked_, which
means a ((line)) is drawn along its edge. The same terminology is used
by SVG.

{{index "fillRect method", "strokeRect method"}}

The `fillRect` method fills a ((rectangle)). It takes first the x- and
y-((coordinates)) of the rectangle's top-left corner, then its width,
and then its height. A similar method, `strokeRect`, draws the
((outline)) of a rectangle.

{{index [state, "of canvas"]}}

Neither method takes any further parameters. The color of the fill,
thickness of the stroke, and so on, are not determined by an argument
to the method (as you might reasonably expect) but rather by
properties of the context object.

{{index filling, "fillStyle property"}}

The `fillStyle` property controls the way shapes are filled. It can be
set to a string that specifies a ((color)), using the color notation
used by ((CSS)).

{{index stroking, "line width", "strokeStyle property", "lineWidth property", canvas}}

The `strokeStyle` property works similarly but determines the color
used for a stroked line. The width of that line is determined by the
`lineWidth` property, which may contain any positive number.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.strokeStyle = "blue";
  cx.strokeRect(5, 5, 50, 50);
  cx.lineWidth = 5;
  cx.strokeRect(135, 5, 50, 50);
</script>
```

{{if book

This code draws two blue squares, using a thicker line for the second
one.

{{figure {url: "img/canvas_stroke.png", alt: "Two stroked squares",width: "5cm"}}}

if}}

{{index "default value", [canvas, size]}}

When no `width` or `height` attribute is specified, as in the example,
a canvas element gets a default width of 300 pixels and height of 150
pixels.

## Paths

{{index [path, canvas], [interface, design], [canvas, path]}}

A path is a sequence of ((line))s. The 2D canvas interface takes a
peculiar approach to describing such a path. It is done entirely
through ((side effect))s. Paths are not values that can be stored and
passed around. Instead, if you want to do something with a path, you
make a sequence of method calls to describe its shape.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.beginPath();
  for (let y = 10; y < 100; y += 10) {
    cx.moveTo(10, y);
    cx.lineTo(90, y);
  }
  cx.stroke();
</script>
```

{{index canvas, "stroke method", "lineTo method", "moveTo method", shape}}

This example creates a path with a number of horizontal ((line))
segments and then strokes it using the `stroke` method. Each segment
created with `lineTo` starts at the path's _current_ position. That
position is usually the end of the last segment, unless `moveTo` was
called. In that case, the next segment would start at the position
passed to `moveTo`.

{{if book

The path described by the previous program looks like this:

{{figure {url: "img/canvas_path.png", alt: "Stroking a number of lines",width: "2.1cm"}}}

if}}

{{index [path, canvas], filling, [path, closing], "fill method"}}

When filling a path (using the `fill` method), each ((shape)) is
filled separately. A path can contain multiple shapes—each `moveTo`
motion starts a new one. But the path needs to be _closed_ (meaning
its start and end are in the same position) before it can be filled.
If the path is not already closed, a line is added from its end to its
start, and the shape enclosed by the completed path is filled.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.beginPath();
  cx.moveTo(50, 10);
  cx.lineTo(10, 70);
  cx.lineTo(90, 70);
  cx.fill();
</script>
```

This example draws a filled triangle. Note that only two of the
triangle's sides are explicitly drawn. The third, from the
bottom-right corner back to the top, is implied and wouldn't be there
when you stroke the path.

{{if book

{{figure {url: "img/canvas_triangle.png", alt: "Filling a path",width: "2.2cm"}}}

if}}

{{index "stroke method", "closePath method", [path, closing], canvas}}

You could also use the `closePath` method to explicitly close a path
by adding an actual ((line)) segment back to the path's start. This
segment _is_ drawn when stroking the path.

## Curves

{{index [path, canvas], canvas, drawing}}

A path may also contain ((curve))d ((line))s. These are unfortunately
a bit more involved to draw.

{{index "quadraticCurveTo method"}}

The `quadraticCurveTo` method draws a curve to a given point. To
determine the curvature of the line, the method is given a ((control
point)) as well as a destination point. Imagine this control point as
_attracting_ the line, giving it its curve. The line won't go through
the control point, but its direction at the start and end points will
be such that a straight line in that direction would point toward the
control point. The following example illustrates this:

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.beginPath();
  cx.moveTo(10, 90);
  // control=(60,10) goal=(90,90)
  cx.quadraticCurveTo(60, 10, 90, 90);
  cx.lineTo(60, 10);
  cx.closePath();
  cx.stroke();
</script>
```

{{if book

It produces a path that looks like this:

{{figure {url: "img/canvas_quadraticcurve.png", alt: "A quadratic curve",width: "2.3cm"}}}

if}}

{{index "stroke method"}}

We draw a ((quadratic curve)) from the left to the right, with (60,10)
as control point, and then draw two ((line)) segments going through
that control point and back to the start of the line. The result
somewhat resembles a _((Star Trek))_ insignia. You can see the effect
of the control point: the lines leaving the lower corners start off in
the direction of the control point and then ((curve)) toward their
target.

{{index canvas, "bezierCurveTo method"}}

The `bezierCurveTo` method draws a similar kind of curve. Instead of a
single ((control point)), this one has two—one for each of the
((line))'s endpoints. Here is a similar sketch to illustrate the
behavior of such a curve:

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.beginPath();
  cx.moveTo(10, 90);
  // control1=(10,10) control2=(90,10) goal=(50,90)
  cx.bezierCurveTo(10, 10, 90, 10, 50, 90);
  cx.lineTo(90, 10);
  cx.lineTo(10, 10);
  cx.closePath();
  cx.stroke();
</script>
```

The two control points specify the direction at both ends of the
curve. The farther they are away from their corresponding point, the
more the curve will "bulge" in that direction.

{{if book

{{figure {url: "img/canvas_beziercurve.png", alt: "A bezier curve",width: "2.2cm"}}}

if}}

{{index "trial and error"}}

Such ((curve))s can be hard to work with—it's not always clear how to
find the ((control point))s that provide the ((shape)) you are looking
for. Sometimes you can compute them, and sometimes you'll just have to
find a suitable value by trial and error.

{{index "arc method", arc}}

The `arc` method is a way to draw a line that curves along the edge of
a circle. It takes a pair of ((coordinates)) for the arc's center, a
radius, and then a start angle and end angle.

{{index pi, "Math.PI constant"}}

Those last two parameters make it possible to draw only part of the
circle. The ((angle))s are measured in ((radian))s, not ((degree))s.
This means a full ((circle)) has an angle of 2π, or `2 * Math.PI`,
which is about 6.28. The angle starts counting at the point to the
right of the circle's center and goes clockwise from there. You can
use a start of 0 and an end bigger than 2π (say, 7) to draw a full
circle.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.beginPath();
  // center=(50,50) radius=40 angle=0 to 7
  cx.arc(50, 50, 40, 0, 7);
  // center=(150,50) radius=40 angle=0 to ½π
  cx.arc(150, 50, 40, 0, 0.5 * Math.PI);
  cx.stroke();
</script>
```

{{index "moveTo method", "arc method", [path, " canvas"]}}

The resulting picture contains a ((line)) from the right of the full
circle (first call to `arc`) to the right of the quarter-((circle))
(second call). Like other path-drawing methods, a line drawn with
`arc` is connected to the previous path segment. You can call `moveTo`
or start a new path to avoid this.

{{if book

{{figure {url: "img/canvas_circle.png", alt: "Drawing a circle",width: "4.9cm"}}}

if}}

{{id pie_chart}}

## Drawing a pie chart

{{index "pie chart example"}}

Imagine you've just taken a ((job)) at EconomiCorp, Inc., and your
first assignment is to draw a pie chart of its customer satisfaction
((survey)) results.

The `results` binding contains an array of objects that represent the
survey responses.

```{sandbox: "pie", includeCode: true}
const results = [
  {name: "Satisfied", count: 1043, color: "lightblue"},
  {name: "Neutral", count: 563, color: "lightgreen"},
  {name: "Unsatisfied", count: 510, color: "pink"},
  {name: "No comment", count: 175, color: "silver"}
];
```

{{index "pie chart example"}}

To draw a pie chart, we draw a number of pie slices, each made up of
an ((arc)) and a pair of ((line))s to the center of that arc. We can
compute the ((angle)) taken up by each arc by dividing a full circle
(2π) by the total number of responses and then multiplying that number
(the angle per response) by the number of people who picked a given
choice.

```{lang: "text/html", sandbox: "pie"}
<canvas width="200" height="200"></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  let total = results
    .reduce((sum, {count}) => sum + count, 0);
  // Start at the top
  let currentAngle = -0.5 * Math.PI;
  for (let result of results) {
    let sliceAngle = (result.count / total) * 2 * Math.PI;
    cx.beginPath();
    // center=100,100, radius=100
    // from current angle, clockwise by slice's angle
    cx.arc(100, 100, 100,
           currentAngle, currentAngle + sliceAngle);
    currentAngle += sliceAngle;
    cx.lineTo(100, 100);
    cx.fillStyle = result.color;
    cx.fill();
  }
</script>
```

{{if book

This draws the following chart:

{{figure {url: "img/canvas_pie_chart.png", alt: "A pie chart",width: "5cm"}}}

if}}

But a chart that doesn't tell us what the slices mean isn't very
helpful. We need a way to draw text to the ((canvas)).

## Text

{{index stroking, filling, "fillStyle property", "fillText method", "strokeText method"}}

A 2D canvas drawing context provides the methods `fillText` and
`strokeText`. The latter can be useful for outlining letters, but
usually `fillText` is what you need. It will fill the outline of the
given ((text)) with the current `fillStyle`.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.font = "28px Georgia";
  cx.fillStyle = "fuchsia";
  cx.fillText("I can draw text, too!", 10, 50);
</script>
```

You can specify the size, style, and ((font)) of the text with the
`font` property. This example just gives a font size and family name.
It is also possible to add `italic` or `bold` to the start of the
string to select a style.

{{index "fillText method", "strokeText method", "textAlign property", "textBaseline property"}}

The last two arguments to `fillText` and `strokeText` provide the
position at which the font is drawn. By default, they indicate the
position of the start of the text's alphabetic baseline, which is the
line that letters "stand" on, not counting hanging parts in letters
such as _j_ or _p_. You can change the horizontal position by setting the
`textAlign` property to `"end"` or `"center"` and the vertical
position by setting `textBaseline` to `"top"`, `"middle"`, or
`"bottom"`.

{{index "pie chart example"}}

We'll come back to our pie chart, and the problem of ((label))ing the
slices, in the [exercises](canvas#exercise_pie_chart) at the end of
the chapter.

## Images

{{index "vector graphics", "bitmap graphics"}}

In computer ((graphics)), a distinction is often made between _vector_
graphics and _bitmap_ graphics. The first is what we have been doing
so far in this chapter—specifying a picture by giving a logical
description of ((shape))s. Bitmap graphics, on the other hand, don't
specify actual shapes but rather work with ((pixel)) data (rasters of
colored dots).

{{index "load event", "event handling", "img (HTML tag)", "drawImage method"}}

The `drawImage` method allows us to draw ((pixel)) data onto a
((canvas)). This pixel data can originate from an `<img>` element or
from another canvas. The following example creates a detached `<img>`
element and loads an image file into it. But it cannot immediately
start drawing from this picture because the browser may not have
loaded it yet. To deal with this, we register a `"load"` event handler
and do the drawing after the image has loaded.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  let img = document.createElement("img");
  img.src = "img/hat.png";
  img.addEventListener("load", () => {
    for (let x = 10; x < 200; x += 30) {
      cx.drawImage(img, x, 10);
    }
  });
</script>
```

{{index "drawImage method", scaling}}

By default, `drawImage` will draw the image at its original size. You
can also give it two additional arguments to set a different width
and height.

When `drawImage` is given _nine_ arguments, it can be used to draw
only a fragment of an image. The second through fifth arguments
indicate the rectangle (x, y, width, and height) in the source image
that should be copied, and the sixth to ninth arguments give the
rectangle (on the canvas) into which it should be copied.

{{index "player", "pixel art"}}

This can be used to pack multiple _((sprite))s_ (image elements) into
a single image file and then draw only the part you need. For example,
we have this picture containing a game character in multiple
((pose))s:

{{figure {url: "img/player_big.png", alt: "Various poses of a game character",width: "6cm"}}}

{{index [animation, "platform game"]}}

By alternating which pose we draw, we can show an animation that
looks like a walking character.

{{index "fillRect method", "clearRect method", clearing}}

To animate a ((picture)) on a ((canvas)), the `clearRect` method is
useful. It resembles `fillRect`, but instead of coloring the
rectangle, it makes it ((transparent)), removing the previously drawn
pixels.

{{index "setInterval function", "img (HTML tag)"}}

We know that each _((sprite))_, each subpicture, is 24 ((pixel))s wide
and 30 pixels high. The following code loads the image and then sets
up an interval (repeated timer) to draw the next ((frame)):

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  let img = document.createElement("img");
  img.src = "img/player.png";
  let spriteW = 24, spriteH = 30;
  img.addEventListener("load", () => {
    let cycle = 0;
    setInterval(() => {
      cx.clearRect(0, 0, spriteW, spriteH);
      cx.drawImage(img,
                   // source rectangle
                   cycle * spriteW, 0, spriteW, spriteH,
                   // destination rectangle
                   0,               0, spriteW, spriteH);
      cycle = (cycle + 1) % 8;
    }, 120);
  });
</script>
```

{{index "remainder operator", "% operator", [animation, "platform game"]}}

The `cycle` binding tracks our position in the animation. For each
((frame)), it is incremented and then clipped back to the 0 to 7 range
by using the remainder operator. This binding is then used to compute
the x-coordinate that the sprite for the current pose has in the
picture.

## Transformation

{{index transformation, mirroring}}

{{indexsee flipping, mirroring}}

But what if we want our character to walk to the left instead of to
the right? We could draw another set of sprites, of course. But we can
also instruct the ((canvas)) to draw the picture the other way round.

{{index "scale method", scaling}}

Calling the `scale` method will cause anything drawn after it to be
scaled. This method takes two parameters, one to set a horizontal
scale and one to set a vertical scale.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  cx.scale(3, .5);
  cx.beginPath();
  cx.arc(50, 50, 40, 0, 7);
  cx.lineWidth = 3;
  cx.stroke();
</script>
```

{{if book

Because of the call to `scale`, the circle is drawn three times as wide
and half as high.

{{figure {url: "img/canvas_scale.png", alt: "A scaled circle",width: "6.6cm"}}}

if}}

{{index mirroring}}

Scaling will cause everything about the drawn image, including the
((line width)), to be stretched out or squeezed together as specified.
Scaling by a negative amount will flip the picture around. The
flipping happens around point (0,0), which means it will also flip the
direction of the coordinate system. When a horizontal scaling of -1 is
applied, a shape drawn at x position 100 will end up at what used to
be position -100.

{{index "drawImage method"}}

So to turn a picture around, we can't simply add `cx.scale(-1, 1)`
before the call to `drawImage` because that would move our picture
outside of the ((canvas)), where it won't be visible. You could adjust
the ((coordinates)) given to `drawImage` to compensate for this by
drawing the image at x position -50 instead of 0. Another solution,
which doesn't require the code that does the drawing to know about the
scale change, is to adjust the ((axis)) around which the scaling
happens.

{{index "rotate method", "translate method", transformation}}

There are several other methods besides `scale` that influence the
coordinate system for a ((canvas)). You can rotate subsequently drawn
shapes with the `rotate` method and move them with the `translate`
method. The interesting—and confusing—thing is that these
transformations _stack_, meaning that each one happens relative to the
previous transformations.

{{index "rotate method", "translate method"}}

So if we translate by 10 horizontal pixels twice, everything will be
drawn 20 pixels to the right. If we first move the center of the
coordinate system to (50,50) and then rotate by 20 ((degree))s (about
0.1π ((radian))s), that rotation will happen _around_ point (50,50).

{{figure {url: "img/transform.svg", alt: "Stacking transformations",width: "9cm"}}}

{{index coordinates}}

But if we _first_ rotate by 20 degrees and _then_ translate by
(50,50), the translation will happen in the rotated coordinate system
and thus produce a different orientation. The order in which
transformations are applied matters.

{{index axis, mirroring}}

To flip a picture around the vertical line at a given x position, we
can do the following:

```{includeCode: true}
function flipHorizontally(context, around) {
  context.translate(around, 0);
  context.scale(-1, 1);
  context.translate(-around, 0);
}
```

{{index "flipHorizontally method"}}

We move the y-((axis)) to where we want our ((mirror)) to be, apply
the mirroring, and finally move the y-axis back to its proper place in
the mirrored universe. The following picture explains why this works:

{{figure {url: "img/mirror.svg", alt: "Mirroring around a vertical line",width: "8cm"}}}

{{index "translate method", "scale method", transformation, canvas}}

This shows the coordinate systems before and after mirroring across
the central line. The triangles are numbered to illustrate each step.
If we draw a triangle at a positive x position, it would, by default,
be in the place where triangle 1 is. A call to `flipHorizontally`
first does a translation to the right, which gets us to triangle 2. It
then scales, flipping the triangle over to position 3. This is not
where it should be, if it were mirrored in the given line. The second
`translate` call fixes this—it "cancels" the initial translation and
makes triangle 4 appear exactly where it should.

We can now draw a mirrored character at position (100,0) by flipping
the world around the character's vertical center.

```{lang: "text/html"}
<canvas></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  let img = document.createElement("img");
  img.src = "img/player.png";
  let spriteW = 24, spriteH = 30;
  img.addEventListener("load", () => {
    flipHorizontally(cx, 100 + spriteW / 2);
    cx.drawImage(img, 0, 0, spriteW, spriteH,
                 100, 0, spriteW, spriteH);
  });
</script>
```

## Storing and clearing transformations

{{index "side effect", canvas, transformation}}

Transformations stick around. Everything else we draw after
((drawing)) that mirrored character would also be mirrored. That might
be inconvenient.

It is possible to save the current transformation, do some drawing and
transforming, and then restore the old transformation. This is usually
the proper thing to do for a function that needs to temporarily
transform the coordinate system. First, we save whatever
transformation the code that called the function was using. Then the
function does its thing, adding more transformations on top of the
current transformation. Finally, we revert to the
transformation we started with.

{{index "save method", "restore method", [state, "of canvas"]}}

The `save` and `restore` methods on the 2D ((canvas)) context do this
((transformation)) management. They conceptually keep a stack of
transformation states. When you call `save`, the current state is
pushed onto the stack, and when you call `restore`, the state on top
of the stack is taken off and used as the context's current
transformation. You can also call `resetTransform` to fully reset the
transformation.

{{index "branching recursion", "fractal example", recursion}}

The `branch` function in the following example illustrates what you
can do with a function that changes the transformation and then calls
a function (in this case itself), which continues drawing with
the given transformation.

This function draws a treelike shape by drawing a line, moving the
center of the coordinate system to the end of the line, and calling
itself twice—first rotated to the left and then rotated to the right.
Every call reduces the length of the branch drawn, and the recursion
stops when the length drops below 8.

```{lang: "text/html"}
<canvas width="600" height="300"></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  function branch(length, angle, scale) {
    cx.fillRect(0, 0, 1, length);
    if (length < 8) return;
    cx.save();
    cx.translate(0, length);
    cx.rotate(-angle);
    branch(length * scale, angle, scale);
    cx.rotate(2 * angle);
    branch(length * scale, angle, scale);
    cx.restore();
  }
  cx.translate(300, 0);
  branch(60, 0.5, 0.8);
</script>
```

{{if book

The result is a simple fractal.

{{figure {url: "img/canvas_tree.png", alt: "A recursive picture",width: "5cm"}}}

if}}

{{index "save method", "restore method", canvas, "rotate method"}}

If the calls to `save` and `restore` were not there, the second
recursive call to `branch` would end up with the position and rotation
created by the first call. It wouldn't be connected to the current
branch but rather to the innermost, rightmost branch drawn by the
first call. The resulting shape might also be interesting, but it is
definitely not a tree.

{{id canvasdisplay}}

## Back to the game

{{index "drawImage method"}}

We now know enough about ((canvas)) drawing to start working on a
((canvas))-based ((display)) system for the ((game)) from the
[previous chapter](game). The new display will no longer be showing
just colored boxes. Instead, we'll use `drawImage` to draw pictures
that represent the game's elements.

{{index "CanvasDisplay class", "DOMDisplay class", [interface, object]}}

We define another display object type called `CanvasDisplay`,
supporting the same interface as `DOMDisplay` from [Chapter
?](game#domdisplay), namely, the methods `syncState` and `clear`.

{{index [state, "in objects"]}}

This object keeps a little more information than `DOMDisplay`. Rather
than using the scroll position of its DOM element, it tracks its own
((viewport)), which tells us what part of the level we are currently
looking at. Finally, it keeps a `flipPlayer` property so that even
when the player is standing still, it keeps facing the direction it
last moved in.

```{sandbox: "game", includeCode: true}
class CanvasDisplay {
  constructor(parent, level) {
    this.canvas = document.createElement("canvas");
    this.canvas.width = Math.min(600, level.width * scale);
    this.canvas.height = Math.min(450, level.height * scale);
    parent.appendChild(this.canvas);
    this.cx = this.canvas.getContext("2d");

    this.flipPlayer = false;

    this.viewport = {
      left: 0,
      top: 0,
      width: this.canvas.width / scale,
      height: this.canvas.height / scale
    };
  }

  clear() {
    this.canvas.remove();
  }
}
```

The `syncState` method first computes a new viewport and then draws
the game scene at the appropriate position.

```{sandbox: "game", includeCode: true}
CanvasDisplay.prototype.syncState = function(state) {
  this.updateViewport(state);
  this.clearDisplay(state.status);
  this.drawBackground(state.level);
  this.drawActors(state.actors);
};
```

{{index scrolling, clearing}}

Contrary to `DOMDisplay`, this display style _does_ have to redraw the
background on every update. Because shapes on a canvas are just
((pixel))s, after we draw them there is no good way to move them (or
remove them). The only way to update the canvas display is to clear it
and redraw the scene. We may also have scrolled, which requires the
background to be in a different position.

{{index "CanvasDisplay class"}}

The `updateViewport` method is similar to `DOMDisplay`'s
`scrollPlayerIntoView` method. It checks whether the player is too
close to the edge of the screen and moves the ((viewport)) when this
is the case.

```{sandbox: "game", includeCode: true}
CanvasDisplay.prototype.updateViewport = function(state) {
  let view = this.viewport, margin = view.width / 3;
  let player = state.player;
  let center = player.pos.plus(player.size.times(0.5));

  if (center.x < view.left + margin) {
    view.left = Math.max(center.x - margin, 0);
  } else if (center.x > view.left + view.width - margin) {
    view.left = Math.min(center.x + margin - view.width,
                         state.level.width - view.width);
  }
  if (center.y < view.top + margin) {
    view.top = Math.max(center.y - margin, 0);
  } else if (center.y > view.top + view.height - margin) {
    view.top = Math.min(center.y + margin - view.height,
                        state.level.height - view.height);
  }
};
```

{{index boundary, "Math.max function", "Math.min function", clipping}}

The calls to `Math.max` and `Math.min` ensure that the viewport does
not end up showing space outside of the level. `Math.max(x, 0)` makes
sure the resulting number is not less than zero. `Math.min`
similarly guarantees that a value stays below a given bound.

When ((clearing)) the display, we'll use a slightly different
((color)) depending on whether the game is won (brighter) or lost
(darker).

```{sandbox: "game", includeCode: true}
CanvasDisplay.prototype.clearDisplay = function(status) {
  if (status == "won") {
    this.cx.fillStyle = "rgb(68, 191, 255)";
  } else if (status == "lost") {
    this.cx.fillStyle = "rgb(44, 136, 214)";
  } else {
    this.cx.fillStyle = "rgb(52, 166, 251)";
  }
  this.cx.fillRect(0, 0,
                   this.canvas.width, this.canvas.height);
};
```

{{index "Math.floor function", "Math.ceil function", rounding}}

To draw the background, we run through the tiles that are visible in
the current viewport, using the same trick used in the `touches`
method from the [previous chapter](game#touches).

```{sandbox: "game", includeCode: true}
let otherSprites = document.createElement("img");
otherSprites.src = "img/sprites.png";

CanvasDisplay.prototype.drawBackground = function(level) {
  let {left, top, width, height} = this.viewport;
  let xStart = Math.floor(left);
  let xEnd = Math.ceil(left + width);
  let yStart = Math.floor(top);
  let yEnd = Math.ceil(top + height);

  for (let y = yStart; y < yEnd; y++) {
    for (let x = xStart; x < xEnd; x++) {
      let tile = level.rows[y][x];
      if (tile == "empty") continue;
      let screenX = (x - left) * scale;
      let screenY = (y - top) * scale;
      let tileX = tile == "lava" ? scale : 0;
      this.cx.drawImage(otherSprites,
                        tileX,         0, scale, scale,
                        screenX, screenY, scale, scale);
    }
  }
};
```

{{index "drawImage method", sprite, tile}}

Tiles that are not empty are drawn with `drawImage`. The
`otherSprites` image contains the pictures used for elements other
than the player. It contains, from left to right, the wall tile, the
lava tile, and the sprite for a coin.

{{figure {url: "img/sprites_big.png", alt: "Sprites for our game",width: "1.4cm"}}}

{{index scaling}}

Background tiles are 20 by 20 pixels since we will use the same scale
that we used in `DOMDisplay`. Thus, the offset for lava tiles is 20
(the value of the `scale` binding), and the offset for walls is 0.

{{index drawing, "load event", "drawImage method"}}

We don't bother waiting for the sprite image to load. Calling
`drawImage` with an image that hasn't been loaded yet will simply do
nothing. Thus, we might fail to draw the game properly for the first
few ((frame))s, while the image is still loading, but that is not a
serious problem. Since we keep updating the screen, the correct scene
will appear as soon as the loading finishes.

{{index "player", [animation, "platform game"], drawing}}

The ((walking)) character shown earlier will be used to represent the
player. The code that draws it needs to pick the right ((sprite)) and
direction based on the player's current motion. The first eight
sprites contain a walking animation. When the player is moving along a
floor, we cycle through them based on the current time. We want to
switch frames every 60 milliseconds, so the ((time)) is divided by 60
first. When the player is standing still, we draw the ninth sprite.
During jumps, which are recognized by the fact that the vertical speed
is not zero, we use the tenth, rightmost sprite.

{{index "flipHorizontally function", "CanvasDisplay class"}}

Because the ((sprite))s are slightly wider than the player object—24
instead of 16 pixels to allow some space for feet and arms—the method
has to adjust the x-coordinate and width by a given amount
(`playerXOverlap`).

```{sandbox: "game", includeCode: true}
let playerSprites = document.createElement("img");
playerSprites.src = "img/player.png";
const playerXOverlap = 4;

CanvasDisplay.prototype.drawPlayer = function(player, x, y,
                                              width, height){
  width += playerXOverlap * 2;
  x -= playerXOverlap;
  if (player.speed.x != 0) {
    this.flipPlayer = player.speed.x < 0;
  }

  let tile = 8;
  if (player.speed.y != 0) {
    tile = 9;
  } else if (player.speed.x != 0) {
    tile = Math.floor(Date.now() / 60) % 8;
  }

  this.cx.save();
  if (this.flipPlayer) {
    flipHorizontally(this.cx, x + width / 2);
  }
  let tileX = tile * width;
  this.cx.drawImage(playerSprites, tileX, 0, width, height,
                                   x,     y, width, height);
  this.cx.restore();
};
```

The `drawPlayer` method is called by `drawActors`, which is
responsible for drawing all the actors in the game.

```{sandbox: "game", includeCode: true}
CanvasDisplay.prototype.drawActors = function(actors) {
  for (let actor of actors) {
    let width = actor.size.x * scale;
    let height = actor.size.y * scale;
    let x = (actor.pos.x - this.viewport.left) * scale;
    let y = (actor.pos.y - this.viewport.top) * scale;
    if (actor.type == "player") {
      this.drawPlayer(actor, x, y, width, height);
    } else {
      let tileX = (actor.type == "coin" ? 2 : 1) * scale;
      this.cx.drawImage(otherSprites,
                        tileX, 0, width, height,
                        x,     y, width, height);
    }
  }
};
```

When ((drawing)) something that is not the ((player)), we look at its
type to find the offset of the correct sprite. The ((lava)) tile is
found at offset 20, and the ((coin)) sprite is found at 40 (two times
`scale`).

{{index viewport}}

We have to subtract the viewport's position when computing the actor's
position since (0,0) on our ((canvas)) corresponds to the top left of
the viewport, not the top left of the level. We could also have used
`translate` for this. Either way works.

{{if interactive

This document plugs the new display into `runGame`:

```{lang: "text/html", sandbox: game, focus: yes, startCode: true}
<body>
  <script>
    runGame(GAME_LEVELS, CanvasDisplay);
  </script>
</body>
```

if}}

{{if book

{{index [game, screenshot], [game, "with canvas"]}}

That concludes the new ((display)) system. The resulting game looks
something like this:

{{figure {url: "img/canvas_game.png", alt: "The game as shown on canvas",width: "8cm"}}}

if}}

{{id graphics_tradeoffs}}

## Choosing a graphics interface

So when you need to generate graphics in the browser, you can choose
between plain HTML, ((SVG)), and ((canvas)). There is no single
_best_ approach that works in all situations. Each option has
strengths and weaknesses.

{{index "text wrapping"}}

Plain HTML has the advantage of being simple. It also integrates well
with ((text)). Both SVG and canvas allow you to draw text, but they
won't help you position that text or wrap it when it takes up more
than one line. In an HTML-based picture, it is much easier to include
blocks of text.

{{index zooming, SVG}}

SVG can be used to produce ((crisp)) ((graphics)) that look good at
any zoom level. Unlike HTML, it is designed for drawing
and is thus more suitable for that purpose.

{{index [DOM, graphics], SVG, "event handling", ["data structure", tree]}}

Both SVG and HTML build up a data structure (the DOM) that
represents your picture. This makes it possible to modify elements
after they are drawn. If you need to repeatedly change a small part of
a big ((picture)) in response to what the user is doing or as part of
an ((animation)), doing it in a canvas can be needlessly expensive.
The DOM also allows us to register mouse event handlers on every
element in the picture (even on shapes drawn with SVG). You can't do
that with canvas.

{{index performance, optimization}}

But ((canvas))'s ((pixel))-oriented approach can be an advantage when
drawing a huge number of tiny elements. The fact that it does not
build up a data structure but only repeatedly draws onto the same
pixel surface gives canvas a lower cost per shape.

{{index "ray tracer"}}

There are also effects, such as rendering a scene one pixel at a time
(for example, using a ray tracer) or postprocessing an image with
JavaScript (blurring or distorting it), that can be realistically
handled only by a ((pixel))-based approach.

In some cases, you may want to combine several of these techniques.
For example, you might draw a ((graph)) with ((SVG)) or ((canvas)) but
show ((text))ual information by positioning an HTML element on top
of the picture.

{{index display}}

For nondemanding applications, it really doesn't matter much which
interface you choose. The display we built for our game in this
chapter could have been implemented using any of these three
((graphics)) technologies since it does not need to draw text, handle
mouse interaction, or work with an extraordinarily large number of
elements.

## Summary

In this chapter we discussed techniques for drawing graphics in the
browser, focusing on the `<canvas>` element.

A canvas node represents an area in a document that our program may
draw on. This drawing is done through a drawing context object,
created with the `getContext` method.

The 2D drawing interface allows us to fill and stroke various shapes.
The context's `fillStyle` property determines how shapes are filled.
The `strokeStyle` and `lineWidth` properties control the way lines are
drawn.

Rectangles and pieces of text can be drawn with a single method call.
The `fillRect` and `strokeRect` methods draw rectangles, and the
`fillText` and `strokeText` methods draw text. To create custom
shapes, we must first build up a path.

{{index stroking, filling}}

Calling `beginPath` starts a new path. A number of other methods add
lines and curves to the current path. For example, `lineTo` can add a
straight line. When a path is finished, it can be filled with the
`fill` method or stroked with the `stroke` method.

Moving pixels from an image or another canvas onto our canvas is done
with the `drawImage` method. By default, this method draws the whole
source image, but by giving it more parameters, you can copy a
specific area of the image. We used this for our game by copying
individual poses of the game character out of an image that contained
many such poses.

Transformations allow you to draw a shape in multiple orientations. A
2D drawing context has a current transformation that can be changed
with the `translate`, `scale`, and `rotate` methods. These will affect
all subsequent drawing operations. A transformation state can be saved
with the `save` method and restored with the `restore` method.

When showing an animation on a canvas, the `clearRect` method can be
used to clear part of the canvas before redrawing it.

## Exercises

### Shapes

{{index "shapes (exercise)"}}

Write a program that draws the following ((shape))s on a ((canvas)):

{{index rotation}}

1. A ((trapezoid)) (a ((rectangle)) that is wider on one side)

2. A red ((diamond)) (a rectangle rotated 45 degrees or ¼π radians)

3. A zigzagging ((line))

4. A ((spiral)) made up of 100 straight line segments

5. A yellow ((star))

{{figure {url: "img/exercise_shapes.png", alt: "The shapes to draw",width: "8cm"}}}

When drawing the last two, you may want to refer to the explanation of
`Math.cos` and `Math.sin` in [Chapter ?](dom#sin_cos), which describes
how to get coordinates on a circle using these functions.

{{index readability, "hard-coding"}}

I recommend creating a function for each shape. Pass the position, and
optionally other properties such as the size or the number of points,
as parameters. The alternative, which is to hard-code numbers all over
your code, tends to make the code needlessly hard to read and modify.

{{if interactive

```{lang: "text/html", test: no}
<canvas width="600" height="200"></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");

  // Your code here.
</script>
```

if}}

{{hint

{{index [path, canvas], "shapes (exercise)"}}

The ((trapezoid)) (1) is easiest to draw using a path. Pick suitable
center coordinates and add each of the four corners around the center.

{{index "flipHorizontally function", rotation}}

The ((diamond)) (2) can be drawn the straightforward way, with a path,
or the interesting way, with a `rotate` ((transformation)). To use
rotation, you will have to apply a trick similar to what we did in the
`flipHorizontally` function. Because you want to rotate around the
center of your rectangle and not around the point (0,0), you must
first `translate` to there, then rotate, and then translate back.

Make sure you reset the transformation after drawing any shape that
creates one.

{{index "remainder operator", "% operator"}}

For the ((zigzag)) (3) it becomes impractical to write a new call to
`lineTo` for each line segment. Instead, you should use a ((loop)).
You can have each iteration draw either two ((line)) segments (right
and then left again) or one, in which case you must use the evenness
(`% 2`) of the loop index to determine whether to go left or right.

You'll also need a loop for the ((spiral)) (4). If you draw a series
of points, with each point moving further along a circle around the
spiral's center, you get a circle. If, during the loop, you vary the
radius of the circle on which you are putting the current point and go
around more than once, the result is a spiral.

{{index "quadraticCurveTo method"}}

The ((star)) (5) depicted is built out of `quadraticCurveTo` lines.
You could also draw one with straight lines. Divide a circle into
eight pieces for a star with eight points, or however many pieces you
want. Draw lines between these points, making them curve toward the
center of the star. With `quadraticCurveTo`, you can use the center as
the control point.

hint}}

{{id exercise_pie_chart}}

### The pie chart

{{index label, text, "pie chart example"}}

[Earlier](canvas#pie_chart) in the chapter, we saw an example program
that drew a pie chart. Modify this program so that the name of each
category is shown next to the slice that represents it. Try to find a
pleasing-looking way to automatically position this text that would
work for other data sets as well. You may assume that categories are
big enough to leave ample room for their labels.

You might need `Math.sin` and `Math.cos` again, which are described in
[Chapter ?](dom#sin_cos).

{{if interactive

```{lang: "text/html", test: no}
<canvas width="600" height="300"></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");
  let total = results
    .reduce((sum, {count}) => sum + count, 0);
  let currentAngle = -0.5 * Math.PI;
  let centerX = 300, centerY = 150;

  // Add code to draw the slice labels in this loop.
  for (let result of results) {
    let sliceAngle = (result.count / total) * 2 * Math.PI;
    cx.beginPath();
    cx.arc(centerX, centerY, 100,
           currentAngle, currentAngle + sliceAngle);
    currentAngle += sliceAngle;
    cx.lineTo(centerX, centerY);
    cx.fillStyle = result.color;
    cx.fill();
  }
</script>
```

if}}

{{hint

{{index "fillText method", "textAlign property", "textBaseline property", "pie chart example"}}

You will need to call `fillText` and set the context's `textAlign` and
`textBaseline` properties in such a way that the text ends up where
you want it.

A sensible way to position the labels would be to put the text on the
line going from the center of the pie through the middle of the slice.
You don't want to put the text directly against the side of the pie
but rather move the text out to the side of the pie by a given number
of pixels.

The ((angle)) of this line is `currentAngle + 0.5 * sliceAngle`. The
following code finds a position on this line 120 pixels from the
center:

```{test: no}
let middleAngle = currentAngle + 0.5 * sliceAngle;
let textX = Math.cos(middleAngle) * 120 + centerX;
let textY = Math.sin(middleAngle) * 120 + centerY;
```

For `textBaseline`, the value `"middle"` is probably appropriate when
using this approach. What to use for `textAlign` depends on which side
of the circle we are on. On the left, it should be `"right"`, and on
the right, it should be `"left"`, so that the text is positioned away
from the pie.

{{index "Math.cos function"}}

If you are not sure how to find out which side of the circle a given
angle is on, look to the explanation of `Math.cos` in [Chapter
?](dom#sin_cos). The cosine of an angle tells us which x-coordinate it
corresponds to, which in turn tells us exactly which side of the
circle we are on.

hint}}

### A bouncing ball

{{index [animation, "bouncing ball"], "requestAnimationFrame function", bouncing}}

Use the `requestAnimationFrame` technique that we saw in [Chapter
?](dom#animationFrame) and [Chapter ?](game#runAnimation) to draw a
((box)) with a bouncing ((ball)) in it. The ball moves at a constant
((speed)) and bounces off the box's sides when it hits them.

{{if interactive

```{lang: "text/html", test: no}
<canvas width="400" height="400"></canvas>
<script>
  let cx = document.querySelector("canvas").getContext("2d");

  let lastTime = null;
  function frame(time) {
    if (lastTime != null) {
      updateAnimation(Math.min(100, time - lastTime) / 1000);
    }
    lastTime = time;
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  function updateAnimation(step) {
    // Your code here.
  }
</script>
```

if}}

{{hint

{{index "strokeRect method", animation, "arc method"}}

A ((box)) is easy to draw with `strokeRect`. Define a binding that
holds its size or define two bindings if your box's width and height
differ. To create a round ((ball)), start a path and call `arc(x, y,
radius, 0, 7)`, which creates an arc going from zero to more than a
whole circle. Then fill the path.

{{index "collision detection", "Vec class"}}

To model the ball's position and ((speed)), you can use the `Vec`
class from [Chapter ?](game#vector)[ (which is available on this
page)]{if interactive}. Give it a starting speed, preferably one that
is not purely vertical or horizontal, and for every ((frame)) multiply
that speed by the amount of time that elapsed. When the ball gets
too close to a vertical wall, invert the x component in its speed.
Likewise, invert the y component when it hits a horizontal wall.

{{index "clearRect method", clearing}}

After finding the ball's new position and speed, use `clearRect` to
delete the scene and redraw it using the new position.

hint}}

### Precomputed mirroring

{{index optimization, "bitmap graphics", mirror}}

One unfortunate thing about ((transformation))s is that they slow down
the drawing of bitmaps. The position and size of each ((pixel)) has to be
transformed, and though it is possible that ((browser))s will get
cleverer about transformation in the ((future)), they currently cause a
measurable increase in the time it takes to draw a bitmap.

In a game like ours, where we are drawing only a single transformed
sprite, this is a nonissue. But imagine that we need to draw hundreds
of characters or thousands of rotating particles from an explosion.

Think of a way to allow us to draw an inverted character without
loading additional image files and without having to make transformed
`drawImage` calls every frame.

{{hint

{{index mirror, scaling, "drawImage method"}}

The key to the solution is the fact that we can use a ((canvas))
element as a source image when using `drawImage`. It is possible to
create an extra `<canvas>` element, without adding it to the document,
and draw our inverted sprites to it, once. When drawing an actual
frame, we just copy the already inverted sprites to the main canvas.

{{index "load event"}}

Some care would be required because images do not load instantly. We
do the inverted drawing only once, and if we do it before the image
loads, it won't draw anything. A `"load"` handler on the image can be
used to draw the inverted images to the extra canvas. This canvas can
be used as a drawing source immediately (it'll simply be blank until
we draw the character onto it).

hint}}

{{meta {load_files: ["code/chapter/18_http.js"]}}}

# HTTP and Forms

{{quote {author: "Roy Fielding", title: "Architectural Styles and the Design of Network-based Software Architectures", chapter: true}

Communication must be stateless in nature [...] such that each request
from client to server must contain all of the information necessary to
understand the request, and cannot take advantage of any stored
context on the server.

quote}}

{{index "Fielding, Roy"}}

{{figure {url: "img/chapter_picture_18.jpg", alt: "Picture of a web form on a medieval scroll", chapter: "framed"}}}

{{index [browser, environment]}}

The _Hypertext Transfer Protocol_, already mentioned in [Chapter
?](browser#web), is the mechanism through which data is requested and
provided on the ((World Wide Web)). This chapter describes the
((protocol)) in more detail and explains the way browser
JavaScript has access to it.

## The protocol

{{index "IP address"}}

If you type _eloquentjavascript.net/18_http.html_ into your browser's
((address bar)), the ((browser)) first looks up the ((address)) of the
server associated with _eloquentjavascript.net_ and tries to open a
((TCP)) ((connection)) to it on ((port)) 80, the default port for
((HTTP)) traffic. If the ((server)) exists and accepts the connection,
the browser might send something like this:

```{lang: http}
GET /18_http.html HTTP/1.1
Host: eloquentjavascript.net
User-Agent: Your browser's name
```

Then the server responds, through that same connection.

```{lang: http}
HTTP/1.1 200 OK
Content-Length: 65585
Content-Type: text/html
Last-Modified: Mon, 08 Jan 2018 10:29:45 GMT

<!doctype html>
... the rest of the document
```

The browser takes the part of the ((response)) after the blank line,
its _body_ (not to be confused with the HTML `<body>` tag), and
displays it as an ((HTML)) document.

{{index HTTP}}

The information sent by the client is called the _((request))_. It
starts with this line:

```{lang: http}
GET /18_http.html HTTP/1.1
```

{{index "DELETE method", "PUT method", "GET method", [method, HTTP]}}

The first word is the _method_ of the ((request)). `GET` means
that we want to _get_ the specified resource. Other common methods are
`DELETE` to delete a resource, `PUT` to create or replace it, and `POST` to send
information to it. Note that the ((server)) is not obliged to carry
out every request it gets. If you walk up to a random website and tell
it to `DELETE` its main page, it'll probably refuse.

{{index [path, URL], GitHub, [file, resource]}}

The part after the method name is the path of the _((resource))_ the
request applies to. In the simplest case, a resource is simply a
file on the ((server)), but the protocol doesn't require it to be.
A resource may be anything that can be transferred _as if_ it is a
file. Many servers generate the responses they produce on the fly. For
example, if you open
[_https://github.com/marijnh_](https://github.com/marijnh), the server looks
in its database for a user named "marijnh", and if it finds one, it
will generate a profile page for that user.

After the resource path, the first line of the request mentions
`HTTP/1.1` to indicate the ((version)) of the ((HTTP)) ((protocol)) it
is using.

In practice, many sites use HTTP version 2, which supports the same
concepts as version 1.1 but is a lot more complicated so that it can
be faster. Browsers will automatically switch to the appropriate
protocol version when talking to a given server, and the outcome of a
request is the same regardless of which version is used. Because version
1.1 is more straightforward and easier to play around with, we'll
focus on that.

{{index "status code"}}

The server's ((response)) will start with a version as well, followed
by the status of the response, first as a three-digit status code and
then as a human-readable string.

```{lang: http}
HTTP/1.1 200 OK
```

{{index "200 (HTTP status code)", "error response", "404 (HTTP status code)"}}

Status codes starting with a 2 indicate that the request succeeded.
Codes starting with 4 mean there was something wrong with the
((request)). 404 is probably the most famous HTTP status code—it means
that the resource could not be found. Codes that start with 5 mean an
error happened on the ((server)) and the request is not to blame.

{{index HTTP}}

{{id headers}}

The first line of a request or response may be followed by any number
of _((header))s_. These are lines in the form `name: value` that
specify extra information about the request or response. These headers
were part of the example ((response)):

```{lang: null}
Content-Length: 65585
Content-Type: text/html
Last-Modified: Thu, 04 Jan 2018 14:05:30 GMT
```

{{index "Content-Length header", "Content-Type header", "Last-Modified header"}}

This tells us the size and type of the response document. In this
case, it is an HTML document of 65,585 bytes. It also tells us when
that document was last modified.

{{index "Host header", domain}}

For most ((header))s, the client and server are free to decide whether
to include them in a ((request)) or ((response)). But a few are
required. For example, the `Host` header, which specifies the
hostname, should be included in a request because a ((server)) might
be serving multiple hostnames on a single ((IP address)), and without
that header, the server won't know which hostname the client is trying
to talk to.

{{index "GET method", "DELETE method", "PUT method", "POST method", "body (HTTP)"}}

After the headers, both requests and responses may include a blank
line followed by a body, which contains the data being sent. `GET` and
`DELETE` requests don't send along any data, but `PUT` and `POST`
requests do. Similarly, some response types, such as error responses,
do not require a body.

## Browsers and HTTP

{{index HTTP, [file, resource]}}

As we saw in the example, a ((browser)) will make a request when we
enter a ((URL)) in its ((address bar)). When the resulting HTML page
references other files, such as ((image))s and JavaScript files,
those are also retrieved.

{{index parallelism, "GET method"}}

A moderately complicated ((website)) can easily include anywhere from
10 to 200 ((resource))s. To be able to fetch those quickly, browsers
will make several `GET` requests simultaneously, rather than waiting
for the responses one at a time.

HTML pages may include _((form))s_, which allow the user to fill out
information and send it to the server. This is an example of a form:

```{lang: "text/html"}
<form method="GET" action="example/message.html">
  <p>Name: <input type="text" name="name"></p>
  <p>Message:<br><textarea name="message"></textarea></p>
  <p><button type="submit">Send</button></p>
</form>
```

{{index form, "method attribute", "GET method"}}

This code describes a form with two ((field))s: a small one asking for
a name and a larger one to write a message in. When you click the Send
((button)), the form is _submitted_, meaning that the content of its
field is packed into an HTTP request and the browser navigates to the
result of that request.

When the `<form>` element's `method` attribute is `GET` (or is
omitted), the information in the form is added to the end of the
`action` URL as a _((query string))_. The browser might make a request
to this URL:

```{lang: null}
GET /example/message.html?name=Jean&message=Yes%3F HTTP/1.1
```

{{index "ampersand character"}}

The ((question mark)) indicates the end of the path part of the URL
and the start of the query. It is followed by pairs of names and
values, corresponding to the `name` attribute on the form field
elements and the content of those elements, respectively. An ampersand
character (`&`) is used to separate the pairs.

{{index [escaping, "in URLs"], "hexadecimal number", "encodeURIComponent function", "decodeURIComponent function"}}

The actual message encoded in the URL is "Yes?", but the question mark
is replaced by a strange code. Some characters in query strings must
be escaped. The question mark, represented as `%3F`, is one of those.
There seems to be an unwritten rule that every format needs its own
way of escaping characters. This one, called _((URL encoding))_, uses
a ((percent sign)) followed by two hexadecimal (base 16) digits that
encode the character code. In this case, 3F, which is 63 in decimal
notation, is the code of a question mark character. JavaScript
provides the `encodeURIComponent` and `decodeURIComponent` functions
to encode and decode this format.

```
console.log(encodeURIComponent("Yes?"));
// → Yes%3F
console.log(decodeURIComponent("Yes%3F"));
// → Yes?
```

{{index "body (HTTP)", "POST method"}}

If we change the `method` attribute of the HTML form in the example we
saw earlier to `POST`, the ((HTTP)) request made to submit the
((form)) will use the `POST` method and put the ((query string)) in
the body of the request, rather than adding it to the URL.

```{lang: http}
POST /example/message.html HTTP/1.1
Content-length: 24
Content-type: application/x-www-form-urlencoded

name=Jean&message=Yes%3F
```

`GET` requests should be used for requests that do not have ((side
effect))s but simply ask for information. Requests that change
something on the server, for example creating a new account or posting
a message, should be expressed with other methods, such as `POST`.
Client-side software such as a browser knows that it shouldn't blindly
make `POST` requests but will often implicitly make `GET` requests—for
example to prefetch a resource it believes the user will soon need.

We'll come back to forms and how to interact with them from JavaScript
[later in the chapter](http#forms).

{{id fetch}}

## Fetch

{{index "fetch function", "Promise class", [interface, module]}}

The interface through which browser JavaScript can make HTTP
requests is called `fetch`. Since it is relatively new, it
conveniently uses promises (which is rare for browser interfaces).

```{test: no}
fetch("example/data.txt").then(response => {
  console.log(response.status);
  // → 200
  console.log(response.headers.get("Content-Type"));
  // → text/plain
});
```

{{index "Response class", "status property", "headers property"}}

Calling `fetch` returns a promise that resolves to a `Response` object
holding information about the server's response, such as its status
code and its headers. The headers are wrapped in a `Map`-like object
that treats its keys (the header names) as case insensitive because
header names are not supposed to be case sensitive. This means 
`headers.get("Content-Type")` and `headers.get("content-TYPE")` will
return the same value.

Note that the promise returned by `fetch` resolves successfully even
if the server responded with an error code. It _might_ also be
rejected if there is a network error or if the ((server)) that the
request is addressed to can't be found.

{{index [path, URL], "relative URL"}}

The first argument to `fetch` is the URL that should be requested.
When that ((URL)) doesn't start with a protocol name (such as _http:_),
it is treated as _relative_, which means it is interpreted relative
to the current document. When it starts with a slash (/), it replaces
the current path, which is the part after the server name. When it
does not, the part of the current path up to and including its last
((slash character)) is put in front of the relative URL.

{{index "text method", "body (HTTP)", "Promise class"}}

To get at the actual content of a response, you can use its `text`
method. Because the initial promise is resolved as soon as the
response's headers have been received and because reading the response body
might take a while longer, this again returns a promise.

```{test: no}
fetch("example/data.txt")
  .then(resp => resp.text())
  .then(text => console.log(text));
// → This is the content of data.txt
```

{{index "json method"}}

A similar method, called `json`, returns a promise that
resolves to the value you get when parsing the body as ((JSON)) or
rejects if it's not valid JSON.

{{index "GET method", "body (HTTP)", "DELETE method", "method property"}}

By default, `fetch` uses the `GET` method to make its request and
does not include a request body. You can configure it differently by
passing an object with extra options as a second argument. For
example, this request tries to delete `example/data.txt`:

```{test: no}
fetch("example/data.txt", {method: "DELETE"}).then(resp => {
  console.log(resp.status);
  // → 405
});
```

{{index "405 (HTTP status code)"}}

The 405 status code means "method not allowed", an HTTP server's way
of saying "I can't do that".

{{index "Range header", "body property", "headers property"}}

To add a request body, you can include a `body` option. To set
headers, there's the `headers` option. For example, this request
includes a `Range` header, which instructs the server to return only
part of a response.

```{test: no}
fetch("example/data.txt", {headers: {Range: "bytes=8-19"}})
  .then(resp => resp.text())
  .then(console.log);
// → the content
```

The browser will automatically add some request ((header))s, such as
"Host" and those needed for the server to figure out the size of the
body. But adding your own headers is often useful to include things
such as authentication information or to tell the server which file
format you'd like to receive.

{{id http_sandbox}}

## HTTP sandboxing

{{index sandbox, [browser, security]}}

Making ((HTTP)) requests in web page scripts once again raises
concerns about ((security)). The person who controls the script might
not have the same interests as the person on whose computer it is
running. More specifically, if I visit _themafia.org_, I do not want
its scripts to be able to make a request to _mybank.com_, using
identifying information from my browser, with instructions to
transfer all my money to some random account.

For this reason, browsers protect us by disallowing scripts to make
HTTP requests to other ((domain))s (names such as _themafia.org_ and
_mybank.com_).

{{index "Access-Control-Allow-Origin header", "cross-domain request"}}

This can be an annoying problem when building systems that want to
access several domains for legitimate reasons. Fortunately,
((server))s can include a ((header)) like this in their ((response))
to explicitly indicate to the browser that it is okay for the request
to come from another domain:

```{lang: null}
Access-Control-Allow-Origin: *
```

## Appreciating HTTP

{{index client, HTTP, [interface, HTTP]}}

When building a system that requires ((communication)) between a
JavaScript program running in the ((browser)) (client-side) and a
program on a ((server)) (server-side), there are several different
ways to model this communication.

{{index [network, abstraction], abstraction}}

A commonly used model is that of _((remote procedure call))s_. In this
model, communication follows the patterns of normal function calls,
except that the function is actually running on another machine.
Calling it involves making a request to the server that includes the
function's name and arguments. The response to that request contains
the returned value.

When thinking in terms of remote procedure calls, HTTP is just a
vehicle for communication, and you will most likely write an
abstraction layer that hides it entirely.

{{index "media type", "document format", [method, HTTP]}}

Another approach is to build your communication around the concept of
((resource))s and ((HTTP)) methods. Instead of a remote procedure
called `addUser`, you use a `PUT` request to `/users/larry`. Instead
of encoding that user's properties in function arguments, you define a
JSON document format (or use an existing format) that represents a
user. The body of the `PUT` request to create a new resource is then
such a document. A resource is fetched by making a `GET` request to
the resource's URL (for example, `/user/larry`), which again returns
the document representing the resource.

This second approach makes it easier to use some of the features that
HTTP provides, such as support for caching resources (keeping a copy
on the client for fast access). The concepts used in HTTP, which are
well designed, can provide a helpful set of principles to design your
server interface around.

## Security and HTTPS

{{index "man-in-the-middle", security, HTTPS, [network, security]}}

Data traveling over the Internet tends to follow a long, dangerous
road. To get to its destination, it must hop through anything from
coffee shop Wi-Fi hotspots to networks controlled by various companies and
states. At any point along its route it may be inspected or even
modified.

{{index tampering}}

If it is important that something remain secret, such as the
((password)) to your ((email)) account, or that it arrive at its
destination unmodified, such as the account number you transfer money
to via your bank's website, plain HTTP is not good enough.

{{index cryptography, encryption}}

{{indexsee "Secure HTTP", HTTPS, [browser, security]}}

The secure ((HTTP)) protocol, used for ((URL))s starting with _https://_,
wraps HTTP traffic in a way that makes it harder to read and tamper
with. Before exchanging data, the client verifies that the server is
who it claims to be by asking it to prove that it has a cryptographic
((certificate)) issued by a certificate authority that the browser
recognizes. Next, all data going over the ((connection)) is encrypted
in a way that should prevent eavesdropping and tampering.

Thus, when it works right, ((HTTPS)) prevents other people from
impersonating the website you are trying to talk to and from
snooping on your communication. It is not perfect, and there have been
various incidents where HTTPS failed because of forged or stolen
certificates and broken software, but it is a _lot_ safer than plain
HTTP.

{{id forms}}

## Form fields

Forms were originally designed for the pre-JavaScript Web to allow
web sites to send user-submitted information in an HTTP request. This
design assumes that interaction with the server always happens by
navigating to a new page.

{{index [DOM, fields]}}

But their elements are part of the DOM like the rest of the page,
and the DOM elements that represent form ((field))s support a number
of properties and events that are not present on other elements. These
make it possible to inspect and control such input fields with
JavaScript programs and do things such as adding new functionality to
a form or using forms and fields as building blocks in a JavaScript
application.

{{index "form (HTML tag)"}}

A web form consists of any number of input ((field))s grouped in a
`<form>` tag. HTML allows several different styles of fields, ranging
from simple on/off checkboxes to drop-down menus and fields for text
input. This book won't try to comprehensively discuss all field types,
but we'll start with a rough overview.

{{index "input (HTML tag)", "type attribute"}}

A lot of field types use the
`<input>` tag. This tag's `type` attribute is used to select the
field's style. These are some commonly used `<input>` types:

{{index "password field", checkbox, "radio button", "file field"}}

{{table {cols: [1,5]}}}

| `text`     | A single-line ((text field))
| `password` | Same as `text` but hides the text that is typed
| `checkbox` | An on/off switch
| `radio`    | (Part of) a ((multiple-choice)) field
| `file`     | Allows the user to choose a file from their computer

{{index "value attribute", "checked attribute", "form (HTML tag)"}}

Form fields do not necessarily have to appear in a `<form>` tag. You
can put them anywhere in a page. Such form-less fields cannot be
((submit))ted (only a form as a whole can), but when responding to
input with JavaScript, we often don't want to submit our fields
normally anyway.

```{lang: "text/html"}
<p><input type="text" value="abc"> (text)</p>
<p><input type="password" value="abc"> (password)</p>
<p><input type="checkbox" checked> (checkbox)</p>
<p><input type="radio" value="A" name="choice">
   <input type="radio" value="B" name="choice" checked>
   <input type="radio" value="C" name="choice"> (radio)</p>
<p><input type="file"> (file)</p>
```

{{if book

The fields created with this HTML code look like this:

{{figure {url: "img/form_fields.png", alt: "Various types of input tags",width: "4cm"}}}

if}}

The JavaScript interface for such elements differs with the type of
the element.

{{index "textarea (HTML tag)", "text field"}}

Multiline text fields have their own tag, `<textarea>`, mostly because
using an attribute to specify a multiline starting value would be
awkward. The `<textarea>` tag requires a matching `</textarea>`
closing tag and uses the text between those two, instead of the
`value` attribute, as starting text.

```{lang: "text/html"}
<textarea>
one
two
three
</textarea>
```

{{index "select (HTML tag)", "option (HTML tag)", "multiple choice", "drop-down menu"}}

Finally, the `<select>` tag is used to
create a field that allows the user to select from a number of
predefined options.

```{lang: "text/html"}
<select>
  <option>Pancakes</option>
  <option>Pudding</option>
  <option>Ice cream</option>
</select>
```

{{if book

Such a field looks like this:

{{figure {url: "img/form_select.png", alt: "A select field", width: "4cm"}}}

if}}

{{index "change event"}}

Whenever the value of a form field changes, it will fire a `"change"`
event.

## Focus

{{index keyboard, focus}}

{{indexsee "keyboard focus", focus}}

Unlike most elements in HTML documents, form fields can get _keyboard
((focus))_. When clicked or activated in some other way, they become
the currently active element and the recipient of keyboard ((input)).

{{index "option (HTML tag)", "select (HTML tag)"}}

Thus, you can type into a ((text field)) only when it is focused. Other
fields respond differently to keyboard events. For example, a
`<select>` menu tries to move to the option that contains the text the
user typed and responds to the arrow keys by moving its selection up
and down.

{{index "focus method", "blur method", "activeElement property"}}

We can control ((focus)) from JavaScript with the `focus` and `blur`
methods. The first moves focus to the DOM element it is called on, and
the second removes focus. The value in `document.activeElement`
corresponds to the currently focused element.

```{lang: "text/html"}
<input type="text">
<script>
  document.querySelector("input").focus();
  console.log(document.activeElement.tagName);
  // → INPUT
  document.querySelector("input").blur();
  console.log(document.activeElement.tagName);
  // → BODY
</script>
```

{{index "autofocus attribute"}}

For some pages, the user is expected to want to interact with a form
field immediately. JavaScript can be used to ((focus)) this field when
the document is loaded, but HTML also provides the `autofocus`
attribute, which produces the same effect while letting the browser
know what we are trying to achieve. This gives the browser the option
to disable the behavior when it is not appropriate, such as when the
user has put the focus on something else.

{{index "tab key", keyboard, "tabindex attribute", "a (HTML tag)"}}

Browsers traditionally also allow the user to move the focus
through the document by pressing the [tab]{keyname} key. We can influence the
order in which elements receive focus with the `tabindex` attribute.
The following example document will let the focus jump from the text input to
the OK button, rather than going through the help link first:

```{lang: "text/html", focus: true}
<input type="text" tabindex=1> <a href=".">(help)</a>
<button onclick="console.log('ok')" tabindex=2>OK</button>
```

{{index "tabindex attribute"}}

By default, most types of HTML elements cannot be focused. But you can
add a `tabindex` attribute to any element that will make it
focusable. A `tabindex` of -1 makes tabbing skip over an element, even
if it is normally focusable.

## Disabled fields

{{index "disabled attribute"}}

All ((form)) ((field))s can be _disabled_ through their `disabled`
attribute. It is an ((attribute)) that can be specified without
value—the fact that it is present at all disables the element.

```{lang: "text/html"}
<button>I'm all right</button>
<button disabled>I'm out</button>
```

Disabled fields cannot be ((focus))ed or changed, and browsers make
them look gray and faded.

{{if book

{{figure {url: "img/button_disabled.png", alt: "A disabled button",width: "3cm"}}}

if}}

{{index "user experience"}}

When a program is
in the process of handling an action caused by some ((button)) or other control
that might require communication with the server and thus take a
while, it can be a good idea to
disable the control until the action finishes. That way, when the user
gets impatient and clicks it again, they don't accidentally repeat
their action.

## The form as a whole

{{index "array-like object", "form (HTML tag)", "form property", "elements property"}}

When a ((field)) is contained in a `<form>` element, its DOM element
will have a `form` property linking back to the form's DOM element.
The `<form>` element, in turn, has a property called `elements` that
contains an array-like collection of the fields inside it.

{{index "elements property", "name attribute"}}

The `name` attribute of a form field determines the way its value will
be identified when the form is ((submit))ted. It can also be used as a
property name when accessing the form's `elements` property, which
acts both as an array-like object (accessible by number) and a ((map))
(accessible by name).

```{lang: "text/html"}
<form action="example/submit.html">
  Name: <input type="text" name="name"><br>
  Password: <input type="password" name="password"><br>
  <button type="submit">Log in</button>
</form>
<script>
  let form = document.querySelector("form");
  console.log(form.elements[1].type);
  // → password
  console.log(form.elements.password.type);
  // → password
  console.log(form.elements.name.form == form);
  // → true
</script>
```

{{index "button (HTML tag)", "type attribute", submit, "enter key"}}

A button with a `type` attribute of `submit` will, when pressed,
cause the form to be submitted. Pressing [enter]{keyname} when a form field is
focused has the same effect.

{{index "submit event", "event handling", "preventDefault method", "page reload", "GET method", "POST method"}}

Submitting a ((form)) normally means that the ((browser)) navigates to
the page indicated by the form's `action` attribute, using either a
`GET` or a `POST` ((request)). But before that happens, a `"submit"`
event is fired. You can handle this event with JavaScript and prevent
this default behavior by calling `preventDefault` on the event object.

```{lang: "text/html"}
<form action="example/submit.html">
  Value: <input type="text" name="value">
  <button type="submit">Save</button>
</form>
<script>
  let form = document.querySelector("form");
  form.addEventListener("submit", event => {
    console.log("Saving value", form.elements.value.value);
    event.preventDefault();
  });
</script>
```

{{index "submit event", validation}}

Intercepting `"submit"` events in JavaScript has various uses. We can
write code to verify that the values the user entered make sense and
immediately show an error message instead of submitting the form. Or
we can disable the regular way of submitting the form entirely, as in
the example, and have our program handle the input, possibly using
`fetch` to send it to a server without reloading the page.

## Text fields

{{index "value attribute", "input (HTML tag)", "text field", "textarea (HTML tag)", [DOM, fields], [interface, object]}}

Fields created by `<textarea>` tags, or `<input>` tags with a type of
`text` or `password`, share a common interface. Their DOM
elements have a `value` property that holds their current content as a
string value. Setting this property to another string changes the
field's content.

{{index "selectionStart property", "selectionEnd property"}}

The
`selectionStart` and `selectionEnd` properties of ((text field))s give
us information about the ((cursor)) and ((selection)) in the ((text)).
When nothing is selected, these two properties hold the same number,
indicating the position of the cursor. For example, 0 indicates the
start of the text, and 10 indicates the cursor is after the 10^th^ ((character)).
When part of the field is selected, the two properties will differ, giving us the
start and end of the selected text. Like `value`, these properties may
also be written to.

{{index Khasekhemwy, "textarea (HTML tag)", keyboard, "event handling"}}

Imagine you are writing an article about Khasekhemwy but have some
trouble spelling his name. The following code wires up a `<textarea>`
tag with an event handler that, when you press F2, inserts the string
"Khasekhemwy" for you.

```{lang: "text/html"}
<textarea></textarea>
<script>
  let textarea = document.querySelector("textarea");
  textarea.addEventListener("keydown", event => {
    // The key code for F2 happens to be 113
    if (event.keyCode == 113) {
      replaceSelection(textarea, "Khasekhemwy");
      event.preventDefault();
    }
  });
  function replaceSelection(field, word) {
    let from = field.selectionStart, to = field.selectionEnd;
    field.value = field.value.slice(0, from) + word +
                  field.value.slice(to);
    // Put the cursor after the word
    field.selectionStart = from + word.length;
    field.selectionEnd = from + word.length;
  }
</script>
```

{{index "replaceSelection function", "text field"}}

The `replaceSelection`
function replaces the currently selected part of a text field's
content with the given word and then moves the ((cursor)) after that
word so that the user can continue typing.

{{index "change event", "input event"}}

The `"change"` event for a ((text
field)) does not fire every time something is typed. Rather, it
fires when the field loses ((focus)) after its content was changed.
To respond immediately to changes in a text field, you should register
a handler for the `"input"` event instead, which fires for every
time the user types a character, deletes text, or otherwise manipulates
the field's content.

The following example shows a text field and a counter displaying the
current length of the text in the field:

```{lang: "text/html"}
<input type="text"> length: <span id="length">0</span>
<script>
  let text = document.querySelector("input");
  let output = document.querySelector("#length");
  text.addEventListener("input", () => {
    output.textContent = text.value.length;
  });
</script>
```

## Checkboxes and radio buttons

{{index "input (HTML tag)", "checked attribute"}}

A ((checkbox)) field is a binary toggle. Its value can be extracted or
changed through its `checked` property, which holds a Boolean value.

```{lang: "text/html"}
<label>
  <input type="checkbox" id="purple"> Make this page purple
</label>
<script>
  let checkbox = document.querySelector("#purple");
  checkbox.addEventListener("change", () => {
    document.body.style.background =
      checkbox.checked ? "mediumpurple" : "";
  });
</script>
```

{{index "for attribute", "id attribute", focus, "label (HTML tag)", labeling}}

The `<label>` tag associates a piece of document with an input
((field)). Clicking anywhere on the label will activate the field,
which focuses it and toggles its value when it is a checkbox or radio
button.

{{index "input (HTML tag)", "multiple-choice"}}

A ((radio button)) is similar to a checkbox, but it's implicitly
linked to other radio buttons with the same `name` attribute so that
only one of them can be active at any time.

```{lang: "text/html"}
Color:
<label>
  <input type="radio" name="color" value="orange"> Orange
</label>
<label>
  <input type="radio" name="color" value="lightgreen"> Green
</label>
<label>
  <input type="radio" name="color" value="lightblue"> Blue
</label>
<script>
  let buttons = document.querySelectorAll("[name=color]");
  for (let button of Array.from(buttons)) {
    button.addEventListener("change", () => {
      document.body.style.background = button.value;
    });
  }
</script>
```

{{index "name attribute", "querySelectorAll method"}}

The ((square brackets)) in the CSS query given to `querySelectorAll`
are used to match attributes. It selects elements whose `name`
attribute is `"color"`.

## Select fields

{{index "select (HTML tag)", "multiple-choice", "option (HTML tag)"}}

Select fields are conceptually similar to radio buttons—they
also allow the user to choose from a set of options. But where a radio
button puts the layout of the options under our control, the
appearance of a `<select>` tag is determined by the browser.

{{index "multiple attribute", "drop-down menu"}}

Select fields also have a variant that is more akin to a list of
checkboxes, rather than radio boxes. When given the `multiple`
attribute, a `<select>` tag will allow the user to select any number
of options, rather than just a single option. This will, in most
browsers, show up differently than a normal select field, which is
typically drawn as a _drop-down_ control that shows the options only
when you open it.

{{index "option (HTML tag)", "value attribute"}}

Each `<option>` tag has a value. This value can be defined with a
`value` attribute. When that is not given, the ((text)) inside the
option will count as its value. The `value` property of a `<select>`
element reflects the currently selected option. For a `multiple`
field, though, this property doesn't mean much since it will give the
value of only _one_ of the currently selected options.

{{index "select (HTML tag)", "options property", "selected attribute"}}

The `<option>` tags for a `<select>` field can be accessed as an
array-like object through the field's `options` property. Each option
has a property called `selected`, which indicates whether that option
is currently selected. The property can also be written to select or
deselect an option.

{{index "multiple attribute", "binary number"}}

This example extracts the selected values from a `multiple` select
field and uses them to compose a binary number from individual bits.
Hold [control]{keyname} (or [command]{keyname} on a Mac) to select multiple options.

```{lang: "text/html"}
<select multiple>
  <option value="1">0001</option>
  <option value="2">0010</option>
  <option value="4">0100</option>
  <option value="8">1000</option>
</select> = <span id="output">0</span>
<script>
  let select = document.querySelector("select");
  let output = document.querySelector("#output");
  select.addEventListener("change", () => {
    let number = 0;
    for (let option of Array.from(select.options)) {
      if (option.selected) {
        number += Number(option.value);
      }
    }
    output.textContent = number;
  });
</script>
```

## File fields

{{index file, "hard drive", "file system", security, "file field", "input (HTML tag)"}}

File fields were originally designed as
a way to ((upload)) files from the user's machine through a form.
In modern browsers, they also provide a way to read such files from
JavaScript programs. The field acts as a kind of gatekeeper. The
script cannot simply start reading private files from the user's
computer, but if the user selects a file in such a field, the browser
interprets that action to mean that the script may read the file.

A file field usually looks like a button labeled with something like
"choose file" or "browse", with information about the chosen file next
to it.

```{lang: "text/html"}
<input type="file">
<script>
  let input = document.querySelector("input");
  input.addEventListener("change", () => {
    if (input.files.length > 0) {
      let file = input.files[0];
      console.log("You chose", file.name);
      if (file.type) console.log("It has type", file.type);
    }
  });
</script>
```

{{index "multiple attribute", "files property"}}

The `files` property of a
((file field)) element is an ((array-like object)) (again, not a real
array) containing the files chosen in the field. It is initially
empty. The reason there isn't simply a `file` property is that file
fields also support a `multiple` attribute, which makes it possible to
select multiple files at the same time.

{{index "File type"}}

Objects in the `files` object have properties such as `name` (the
filename), `size` (the file's size in bytes, which are chunks of 8
bits), and `type` (the media type of the file, such as `text/plain` or
`image/jpeg`).

{{index ["asynchronous programming", "reading files"], "file reading", "FileReader class"}}

{{id filereader}}

What it does not have is a property that contains the content of the
file. Getting at that is a little more involved. Since reading a file
from disk can take time, the interface must be asynchronous to avoid
freezing the document.

```{lang: "text/html"}
<input type="file" multiple>
<script>
  let input = document.querySelector("input");
  input.addEventListener("change", () => {
    for (let file of Array.from(input.files)) {
      let reader = new FileReader();
      reader.addEventListener("load", () => {
        console.log("File", file.name, "starts with",
                    reader.result.slice(0, 20));
      });
      reader.readAsText(file);
    }
  });
</script>
```

{{index "FileReader class", "load event", "readAsText method", "result property"}}

Reading a file is done by creating a `FileReader` object, registering
a `"load"` event handler for it, and calling its `readAsText` method,
giving it the file we want to read. Once loading finishes, the
reader's `result` property contains the file's content.

{{index "error event", "FileReader class", "Promise class"}}

`FileReader`s also fire an `"error"` event when reading the file fails
for any reason. The error object itself will end up in the reader's
`error` property. This interface was designed before promises became
part of the language. You could wrap it in a promise like this:

```
function readFileText(file) {
  return new Promise((resolve, reject) => {
    let reader = new FileReader();
    reader.addEventListener(
      "load", () => resolve(reader.result));
    reader.addEventListener(
      "error", () => reject(reader.error));
    reader.readAsText(file);
  });
}
```

## Storing data client-side

{{index "web application"}}

Simple ((HTML)) pages with a bit of JavaScript can be a great format
for "((mini application))s"—small helper programs that automate basic
tasks. By connecting a few form ((field))s with event handlers, you
can do anything from converting between centimeters and inches to
computing passwords from a master password and a website name.

{{index persistence, [binding, "as state"], [browser, storage]}}

When such an application needs to remember something between sessions,
you cannot use JavaScript bindings—those are thrown away every
time the page is closed. You could set up a server, connect it to the
Internet, and have your application store something there. We will see
how to do that in [Chapter ?](node). But that's a lot of extra work
and complexity. Sometimes it is enough to just keep the data in the
((browser)).

{{index "localStorage object", "setItem method", "getItem method", "removeItem method"}}

The `localStorage` object can be used to store data in a way that
survives ((page reload))s. This object allows you to file string
values under names.

```
localStorage.setItem("username", "marijn");
console.log(localStorage.getItem("username"));
// → marijn
localStorage.removeItem("username");
```

{{index "localStorage object"}}

A value in `localStorage` sticks around until it is overwritten, it is
removed with `removeItem`, or the user clears their local data.

{{index security}}

Sites from different ((domain))s get different storage
compartments. That means data stored in `localStorage` by a given
website can, in principle, be read (and overwritten) only by scripts on
that same site.

{{index "localStorage object"}}

Browsers do enforce a limit on the size of the data a site can store
in `localStorage`. That restriction, along with the fact that filling
up people's ((hard drive))s with junk is not really profitable,
prevents the feature from eating up too much space.

{{index "localStorage object", "note-taking example", "select (HTML tag)", "button (HTML tag)", "textarea (HTML tag)"}}

The following code implements a crude note-taking application. It
keeps a set of named notes and allows the user to edit notes and
create new ones.

```{lang: "text/html", startCode: true}
Notes: <select></select> <button>Add</button><br>
<textarea style="width: 100%"></textarea>

<script>
  let list = document.querySelector("select");
  let note = document.querySelector("textarea");

  let state;
  function setState(newState) {
    list.textContent = "";
    for (let name of Object.keys(newState.notes)) {
      let option = document.createElement("option");
      option.textContent = name;
      if (newState.selected == name) option.selected = true;
      list.appendChild(option);
    }
    note.value = newState.notes[newState.selected];

    localStorage.setItem("Notes", JSON.stringify(newState));
    state = newState;
  }
  setState(JSON.parse(localStorage.getItem("Notes")) || {
    notes: {"shopping list": "Carrots\nRaisins"},
    selected: "shopping list"
  });

  list.addEventListener("change", () => {
    setState({notes: state.notes, selected: list.value});
  });
  note.addEventListener("change", () => {
    setState({
      notes: Object.assign({}, state.notes,
                           {[state.selected]: note.value}),
      selected: state.selected
    });
  });
  document.querySelector("button")
    .addEventListener("click", () => {
      let name = prompt("Note name");
      if (name) setState({
        notes: Object.assign({}, state.notes, {[name]: ""}),
        selected: name
      });
    });
</script>
```

{{index "getItem method", JSON, "|| operator", "default value"}}

The script gets its starting state from the `"Notes"` value stored in
`localStorage` or, if that is missing, creates an example state
that has only a shopping list in it. Reading a field that does not
exist from `localStorage` will yield `null`. Passing `null` to
`JSON.parse` will make it parse the string `"null"` and return `null`.
Thus, the `||` operator can be used to provide a default value in a
situation like this.

The `setState` method makes sure the DOM is showing a given state and
stores the new state to `localStorage`. Event handlers call this
function to move to a new state.

{{index "Object.assign function", [object, creation], property, "computed property"}}

The use of `Object.assign` in the example is intended to create a new
object that is a clone of the old `state.notes`, but with one property
added or overwritten. `Object.assign` takes its first argument and
adds all properties from any further arguments to it. Thus, giving it
an empty object will cause it to fill a fresh object. The ((square
brackets)) notation in the third argument is used to create a property
whose name is based on some dynamic value.

{{index "sessionStorage object", [browser, storage]}}

There is another object, similar to `localStorage`, called
`sessionStorage`. The difference between the two is that the content
of `sessionStorage` is forgotten at the end of each _((session))_,
which for most browsers means whenever the browser is closed.

## Summary

In this chapter, we discussed how the HTTP protocol works. A _client_
sends a request, which contains a method (usually `GET`) and a path
that identifies a resource. The _server_ then decides what to do with
the request and responds with a status code and a response body. Both
requests and responses may contain headers that provide additional
information.

The interface through which browser JavaScript can make HTTP requests
is called `fetch`. Making a request looks like this:

```
fetch("/18_http.html").then(r => r.text()).then(text => {
  console.log(`The page starts with ${text.slice(0, 15)}`);
});
```

Browsers make `GET` requests to fetch the resources needed to display
a web page. A page may also contain forms, which allow information
entered by the user to be sent as a request for a new page when the
form is submitted.

HTML can represent various types of form fields, such as text fields,
checkboxes, multiple-choice fields, and file pickers.

Such fields can be inspected and manipulated with JavaScript. They
fire the `"change"` event when changed, fire the `"input"` event when text
is typed, and receive keyboard events when they have keyboard focus.
Properties like `value` (for text and select fields) or `checked` (for
checkboxes and radio buttons) are used to read or set the field's
content.

When a form is submitted, a `"submit"` event is fired on it. A
JavaScript handler can call `preventDefault` on that event to disable
the browser's default behavior. Form field elements may also occur
outside of a form tag.

When the user has selected a file from their local file system in a
file picker field, the `FileReader` interface can be used to access
the content of this file from a JavaScript program.

The `localStorage` and `sessionStorage` objects can be used to save
information in a way that survives page reloads. The first object saves the
data forever (or until the user decides to clear it), and the second
saves it until the browser is closed.

## Exercises

### Content negotiation

{{index "Accept header", "media type", "document format", "content negotiation (exercise)"}}

One of the things HTTP can do is called _content negotiation_.
The `Accept` request header is used to tell the server what type of
document the client would like to get. Many servers ignore this
header, but when a server knows of various ways to encode a resource,
it can look at this header and send the one that the client prefers.

{{index "MIME type"}}

The URL
[_https://eloquentjavascript.net/author_](https://eloquentjavascript.net/author)
is configured to respond with either plaintext, HTML, or JSON,
depending on what the client asks for. These formats are identified by
the standardized _((media type))s_ `text/plain`, `text/html`, and
`application/json`.

{{index "headers property", "fetch function"}}

Send requests to fetch all three formats of this resource. Use the
`headers` property in the options object passed to `fetch` to set the
header named `Accept` to the desired media type.

Finally, try asking for the media type `application/rainbows+unicorns`
and see which status code that produces.

{{if interactive

```{test: no}
// Your code here.
```

if}}

{{hint

{{index "content negotiation (exercise)"}}

Base your code on the `fetch` examples [earlier in the
chapter](http#fetch).

{{index "406 (HTTP status code)", "Accept header"}}

Asking for a bogus media type will return a response with code 406,
"Not acceptable", which is the code a server should return when it
can't fulfill the `Accept` header.

hint}}

### A JavaScript workbench

{{index "JavaScript console", "workbench (exercise)"}}

Build an interface that allows people to type and run pieces of
JavaScript code.

{{index "textarea (HTML tag)", "button (HTML tag)", "Function constructor", "error message"}}

Put a button next to a `<textarea>` field that, when pressed, uses
the `Function` constructor we saw in [Chapter ?](modules#eval) to wrap
the text in a function and call it. Convert the return value of the
function, or any error it raises, to a string and display it below the
text field.

{{if interactive

```{lang: "text/html", test: no}
<textarea id="code">return "hi";</textarea>
<button id="button">Run</button>
<pre id="output"></pre>

<script>
  // Your code here.
</script>
```

if}}

{{hint

{{index "click event", "mousedown event", "Function constructor", "workbench (exercise)"}}

Use `document.querySelector` or `document.getElementById` to get
access to the elements defined in your HTML. An event handler for
`"click"` or `"mousedown"` events on the button can get the `value`
property of the text field and call `Function` on it.

{{index "try keyword", "exception handling"}}

Make sure you wrap both the call to `Function` and the call to its
result in a `try` block so you can catch the exceptions it
produces. In this case, we really don't know what type of exception we
are looking for, so catch everything.

{{index "textContent property", output, text, "createTextNode method", "newline character"}}

The `textContent` property of the output element can be used to fill
it with a string message. Or, if you want to keep the old content
around, create a new text node using `document.createTextNode` and
append it to the element. Remember to add a newline character to the
end so that not all output appears on a single line.

hint}}

### Conway's Game of Life

{{index "game of life (exercise)", "artificial life", "Conway's Game of Life"}}

Conway's Game of Life is a simple ((simulation)) that creates
artificial "life" on a ((grid)), each cell of which is either alive or
not. Each ((generation)) (turn), the following rules are applied:

* Any live ((cell)) with fewer than two or more than three live
  ((neighbor))s dies.

* Any live cell with two or three live neighbors lives on to the next
  generation.

* Any dead cell with exactly three live neighbors becomes a live cell.

A _neighbor_ is defined as any adjacent cell, including diagonally
adjacent ones.

{{index "pure function"}}

Note that these rules are applied to the whole grid at once, not one
square at a time. That means the counting of neighbors is based on the
situation at the start of the generation, and changes happening to
neighbor cells during this generation should not influence the new
state of a given cell.

{{index "Math.random function"}}

Implement this game using whichever ((data structure)) you find
appropriate. Use `Math.random` to populate the grid with a random
pattern initially. Display it as a grid of ((checkbox)) ((field))s,
with a ((button)) next to it to advance to the next ((generation)).
When the user checks or unchecks the checkboxes, their changes should
be included when computing the next generation.

{{if interactive

```{lang: "text/html", test: no}
<div id="grid"></div>
<button id="next">Next generation</button>

<script>
  // Your code here.
</script>
```

if}}

{{hint

{{index "game of life (exercise)"}}

To solve the problem of having the changes conceptually happen at the
same time, try to see the computation of a ((generation)) as a ((pure
function)), which takes one ((grid)) and produces a new grid that
represents the next turn.

Representing the matrix can be done in the way shown in [Chapter
?](object#matrix). You can count live ((neighbor))s with two nested
loops, looping over adjacent coordinates in both dimensions. Take care
not to count cells outside of the field and to ignore the cell in the
center, whose neighbors we are counting.

{{index "event handling", "change event"}}

Ensuring that changes to ((checkbox))es take effect on the next generation
can be done in two ways. An event handler could notice these changes
and update the current grid to reflect them, or you could generate a
fresh grid from the values in the checkboxes before computing the next
turn.

If you choose to go with event handlers, you might want to attach
((attribute))s that identify the position that each checkbox
corresponds to so that it is easy to find out which cell to change.

{{index drawing, "table (HTML tag)", "br (HTML tag)"}}

To draw the grid of checkboxes, you can either use a `<table>` element
(see [Chapter ?](dom#exercise_table)) or simply put them all in the
same element and put `<br>` (line break) elements between the rows.

hint}}
{{meta {load_files: ["code/chapter/19_paint.js"], zip: "html include=[\"css/paint.css\"]"}}}

# Project: A Pixel Art Editor

{{quote {author: "Joan Miro", chapter: true}

I look at the many colors before me. I look at my blank canvas. Then,
I try to apply colors like words that shape poems, like notes that
shape music.

quote}}

{{index "Miro, Joan", "drawing program example", "project chapter"}}

{{figure {url: "img/chapter_picture_19.jpg", alt: "Picture of a tiled mosaic", chapter: "framed"}}}

The material from the previous chapters gives you all the elements you
need to build a basic ((web application)). In this chapter, we will do
just that.

{{index [file, image]}}

Our ((application)) will be a ((pixel)) ((drawing)) program, where you
can modify a picture pixel by pixel by manipulating a zoomed-in view of it, shown as a grid of colored squares. You can use the program to open image files,
scribble on them with your mouse or other pointer device, and save
them. This is what it will look like:

{{figure {url: "img/pixel_editor.png", alt: "The pixel editor interface, with colored pixels at the top and a number of controls below that", width: "8cm"}}}

Painting on a computer is great. You don't need to worry about
materials, ((skill)), or talent. You just start smearing.

## Components

{{index drawing, "select (HTML tag)", "canvas (HTML tag)", component}}

The interface for the application shows a big `<canvas>` element on
top, with a number of form ((field))s below it. The user draws on the
((picture)) by selecting a tool from a `<select>` field and then
clicking, ((touch))ing, or ((dragging)) across the canvas. There are
((tool))s for drawing single pixels or rectangles, for filling an
area, and for picking a ((color)) from the picture.

{{index [DOM, components]}}

We will structure the editor interface as a number of
_((component))s_, objects that are responsible for a piece of the
DOM and that may contain other components inside them.

{{index [state, "of application"]}}

The state of the application consists of the current picture, the
selected tool, and the selected color. We'll set things up so that the
state lives in a single value, and the interface components always
base the way they look on the current state.

To see why this is important, let's consider the
alternative—distributing pieces of state throughout the interface. Up
to a certain point, this is easier to program. We can just put in a
((color field)) and read its value when we need to know the current
color.

But then we add the ((color picker))—a tool that lets you click the
picture to select the color of a given pixel. To keep the
color field showing the correct color, that tool would have to know
that it exists and update it whenever it picks a new color. If
you ever add another place that makes the color visible (maybe the
mouse cursor could show it), you have to update your
color-changing code to keep that synchronized.

{{index modularity}}

In effect, this creates a problem where each part of the interface
needs to know about all other parts, which is not very modular. For
small applications like the one in this chapter, that may not be a
problem. For bigger projects, it can turn into a real nightmare.

To avoid this nightmare on principle, we're going to be strict
about _((data flow))_. There is a state, and the interface is drawn
based on that state. An interface component may respond to user
actions by updating the state, at which point the components get a
chance to synchronize themselves with this new state.

{{index library, framework}}

In practice, each ((component)) is set up so that when it is given a
new state, it also notifies its child components, insofar as those
need to be updated. Setting this up is a bit of a hassle. Making this
more convenient is the main selling point of many browser programming
libraries. But for a small application like this, we can do it without
such infrastructure.

{{index [state, transitions]}}

Updates to the state are represented as objects, which we'll call
_((action))s_. Components may create such actions and _((dispatch))_
them—give them to a central state management function. That function
computes the next state, after which the interface components update
themselves to this new state.

{{index [DOM, components]}}

We're taking the messy task of running a ((user interface)) and
applying some ((structure)) to it. Though the DOM-related pieces
are still full of ((side effect))s, they are held up by a conceptually
simple backbone: the state update cycle. The state determines what the
DOM looks like, and the only way DOM events can change the state is by
dispatching actions to the state.

{{index "data flow"}}

There are _many_ variants of this approach, each with its own
benefits and problems, but their central idea is the same: state
changes should go through a single well-defined channel, not happen
all over the place.

{{index "dom property", [interface, object]}}

Our ((component))s will be ((class))es conforming to an interface.
Their constructor is given a state—which may be the whole application
state or some smaller value if it doesn't need access to everything—and
uses that to build up a `dom` property. This is the DOM element that represents
the component. Most constructors will also take some other values
that won't change over time, such as the function they can use to
((dispatch)) an action.

{{index "syncState method"}}

Each component has a `syncState` method that is used to synchronize it
to a new state value. The method takes one argument, the state, which
is of the same type as the first argument to its constructor.

## The state

{{index "Picture class", "picture property", "tool property", "color property", "Matrix class"}}

The application state will be an object with `picture`, `tool`, and
`color` properties. The picture is itself an object that stores the
width, height, and pixel content of the picture. The ((pixel))s are
stored in an array, in the same way as the matrix class from [Chapter
?](object)—row by row, from top to bottom.

```{includeCode: true}
class Picture {
  constructor(width, height, pixels) {
    this.width = width;
    this.height = height;
    this.pixels = pixels;
  }
  static empty(width, height, color) {
    let pixels = new Array(width * height).fill(color);
    return new Picture(width, height, pixels);
  }
  pixel(x, y) {
    return this.pixels[x + y * this.width];
  }
  draw(pixels) {
    let copy = this.pixels.slice();
    for (let {x, y, color} of pixels) {
      copy[x + y * this.width] = color;
    }
    return new Picture(this.width, this.height, copy);
  }
}
```

{{index "side effect", "persistent data structure"}}

We want to be able to treat a picture as an ((immutable)) value, for
reasons that we'll get back to later in the chapter. But we also
sometimes need to update a whole bunch of pixels at a time. To be able
to do that, the class has a `draw` method that expects an array of
updated pixels—objects with `x`, `y`, and `color` properties—and
creates a new picture with those pixels overwritten. This method uses
`slice` without arguments to copy the entire pixel array—the start of
the slice defaults to 0, and the end defaults to the array's length.

{{index "Array constructor", "fill method", ["length property", "for array"], [array, creation]}}

The `empty` method uses two pieces of array functionality that we
haven't seen before. The `Array` constructor can be called with a
number to create an empty array of the given length. The `fill`
method can then be used to fill this array with a given value. These
are used to create an array in which all pixels have the same color.

{{index "hexadecimal number", "color component", "color field", "fillStyle property"}}

Colors are stored as strings containing traditional ((CSS)) ((color
code))s made up of a ((hash sign)) (`#`) followed by six hexadecimal (base-16)
digits—two for the ((red)) component, two for the ((green))
component, and two for the ((blue)) component. This is a somewhat
cryptic and inconvenient way to write colors, but it is the format the
HTML color input field uses, and it can be used in the `fillStyle`
property of a canvas drawing context, so for the ways we'll use colors
in this program, it is practical enough.

{{index black}}

Black, where all components are zero, is written `"#000000"`, and
bright ((pink)) looks like `"#ff00ff"`, where the red and blue
components have the maximum value of 255, written `ff` in hexadecimal
((digit))s (which use _a_ to _f_ to represent digits 10 to 15).

{{index [state, transitions]}}

We'll allow the interface to ((dispatch)) ((action))s as objects whose
properties overwrite the properties of the previous state. The
color field, when the user changes it, could dispatch an object like
`{color: field.value}`, from which this update function can compute a
new state.

{{index "updateState function"}}

```{includeCode: true}
function updateState(state, action) {
  return Object.assign({}, state, action);
}
```

{{index "period character", spread, "Object.assign function"}}

This rather cumbersome pattern, in which `Object.assign` is used to
first add the properties of `state` to an empty object and then
overwrite some of those with the properties from `action`, is common
in JavaScript code that uses ((immutable)) objects. A more convenient
notation for this, in which the triple-dot operator is used to include
all properties from another object in an object expression, is in the
final stages of being standardized. With that addition, you could
write `{...state, ...action}` instead. At the time of writing, this
doesn't yet work in all browsers.

## DOM building

{{index "createElement method", "elt function", [DOM, construction]}}

One of the main things that interface components do is creating
DOM structure. We again don't want to directly use the verbose DOM
methods for that, so here's a slightly expanded version of the `elt`
function:

```{includeCode: true}
function elt(type, props, ...children) {
  let dom = document.createElement(type);
  if (props) Object.assign(dom, props);
  for (let child of children) {
    if (typeof child != "string") dom.appendChild(child);
    else dom.appendChild(document.createTextNode(child));
  }
  return dom;
}
```

{{index "setAttribute method", "attribute", "onclick property", "click event", "event handling"}}

The main difference between this version and the one we used in
[Chapter ?](game#domdisplay) is that it assigns _properties_ to DOM
nodes, not _attributes_. This means we can't use it to set arbitrary
attributes, but we _can_ use it to set properties whose value isn't a
string, such as `onclick`, which can be set to a function to register
a click event handler.

{{index "button (HTML tag)"}}

This allows the following style of registering event handlers:

```{lang: "text/html"}
<body>
  <script>
    document.body.appendChild(elt("button", {
      onclick: () => console.log("click")
    }, "The button"));
  </script>
</body>
```

## The canvas

The first component we'll define is the part of the interface that
displays the picture as a grid of colored boxes. This component is
responsible for two things: showing a picture and communicating
((pointer event))s on that picture to the rest of the application.

{{index "PictureCanvas class", "callback function", "scale constant", "canvas (HTML tag)", "mousedown event", "touchstart event", [state, "of application"]}}

As such, we can define it as a component that knows about only the
current picture, not the whole application state. Because it
doesn't know how the application as a whole works, it cannot directly
dispatch ((action))s. Rather, when responding to pointer events, it
calls a callback function provided by the code that created it, which
will handle the application-specific parts.

```{includeCode: true}
const scale = 10;

class PictureCanvas {
  constructor(picture, pointerDown) {
    this.dom = elt("canvas", {
      onmousedown: event => this.mouse(event, pointerDown),
      ontouchstart: event => this.touch(event, pointerDown)
    });
    this.syncState(picture);
  }
  syncState(picture) {
    if (this.picture == picture) return;
    this.picture = picture;
    drawPicture(this.picture, this.dom, scale);
  }
}
```

{{index "syncState method", efficiency}}

We draw each pixel as a 10-by-10 square, as determined by the `scale`
constant. To avoid unnecessary work, the component keeps track of its
current picture and does a redraw only when `syncState` is given a new
picture.

{{index "drawPicture function"}}

The actual drawing function sets the size of the canvas based on the
scale and picture size and fills it with a series of squares, one for
each pixel.

```{includeCode: true}
function drawPicture(picture, canvas, scale) {
  canvas.width = picture.width * scale;
  canvas.height = picture.height * scale;
  let cx = canvas.getContext("2d");

  for (let y = 0; y < picture.height; y++) {
    for (let x = 0; x < picture.width; x++) {
      cx.fillStyle = picture.pixel(x, y);
      cx.fillRect(x * scale, y * scale, scale, scale);
    }
  }
}
```

{{index "mousedown event", "mousemove event", "button property", "buttons property", "pointerPosition function"}}

When the left mouse button is pressed while the mouse is over the
picture canvas, the component calls the `pointerDown` callback, giving
it the position of the pixel that was clicked—in picture coordinates.
This will be used to implement mouse interaction with the picture. The
callback may return another callback function to be notified when the
pointer is moved to a different pixel while the button is held down.

```{includeCode: true}
PictureCanvas.prototype.mouse = function(downEvent, onDown) {
  if (downEvent.button != 0) return;
  let pos = pointerPosition(downEvent, this.dom);
  let onMove = onDown(pos);
  if (!onMove) return;
  let move = moveEvent => {
    if (moveEvent.buttons == 0) {
      this.dom.removeEventListener("mousemove", move);
    } else {
      let newPos = pointerPosition(moveEvent, this.dom);
      if (newPos.x == pos.x && newPos.y == pos.y) return;
      pos = newPos;
      onMove(newPos);
    }
  };
  this.dom.addEventListener("mousemove", move);
};

function pointerPosition(pos, domNode) {
  let rect = domNode.getBoundingClientRect();
  return {x: Math.floor((pos.clientX - rect.left) / scale),
          y: Math.floor((pos.clientY - rect.top) / scale)};
}
```

{{index "getBoundingClientRect method", "clientX property", "clientY property"}}

Since we know the size of the ((pixel))s and we can use
`getBoundingClientRect` to find the position of the canvas on the
screen, it is possible to go from mouse event coordinates (`clientX`
and `clientY`) to picture coordinates. These are always rounded down
so that they refer to a specific pixel.

{{index "touchstart event", "touchmove event", "preventDefault method"}}

With touch events, we have to do something similar, but using
different events and making sure we call `preventDefault` on the
`"touchstart"` event to prevent ((panning)).

```{includeCode: true}
PictureCanvas.prototype.touch = function(startEvent,
                                         onDown) {
  let pos = pointerPosition(startEvent.touches[0], this.dom);
  let onMove = onDown(pos);
  startEvent.preventDefault();
  if (!onMove) return;
  let move = moveEvent => {
    let newPos = pointerPosition(moveEvent.touches[0],
                                 this.dom);
    if (newPos.x == pos.x && newPos.y == pos.y) return;
    pos = newPos;
    onMove(newPos);
  };
  let end = () => {
    this.dom.removeEventListener("touchmove", move);
    this.dom.removeEventListener("touchend", end);
  };
  this.dom.addEventListener("touchmove", move);
  this.dom.addEventListener("touchend", end);
};
```

{{index "touches property", "clientX property", "clientY property"}}

For touch events, `clientX` and `clientY` aren't available directly on
the event object, but we can use the coordinates of the first touch
object in the `touches` property.

## The application

To make it possible to build the application piece by piece, we'll
implement the main component as a shell around a picture canvas and a
dynamic set of ((tool))s and ((control))s that we pass to its
constructor.

The _controls_ are the interface elements that appear below the
picture. They'll be provided as an array of ((component))
constructors.

{{index "br (HTML tag)", "flood fill", "select (HTML tag)", "PixelEditor class", dispatch}}

The _tools_ do things like drawing pixels or filling in an area. The
application shows the set of available tools as a `<select>` field.
The currently selected tool determines what happens when the user
interacts with the picture with a pointer device. The set of
available tools is provided as
an object that maps the names that appear in the drop-down field to
functions that implement the tools. Such functions get a picture
position, a current application state, and a `dispatch` function as
arguments. They may return a move handler function that gets called
with a new position and a current state when the pointer moves to a
different pixel.

```{includeCode: true}
class PixelEditor {
  constructor(state, config) {
    let {tools, controls, dispatch} = config;
    this.state = state;

    this.canvas = new PictureCanvas(state.picture, pos => {
      let tool = tools[this.state.tool];
      let onMove = tool(pos, this.state, dispatch);
      if (onMove) return pos => onMove(pos, this.state);
    });
    this.controls = controls.map(
      Control => new Control(state, config));
    this.dom = elt("div", {}, this.canvas.dom, elt("br"),
                   ...this.controls.reduce(
                     (a, c) => a.concat(" ", c.dom), []));
  }
  syncState(state) {
    this.state = state;
    this.canvas.syncState(state.picture);
    for (let ctrl of this.controls) ctrl.syncState(state);
  }
}
```

The pointer handler given to `PictureCanvas` calls the currently
selected tool with the appropriate arguments and, if that returns a
move handler, adapts it to also receive the state.

{{index "reduce method", "map method", [whitespace, "in HTML"], "syncState method"}}

All controls are constructed and stored in `this.controls` so that
they can be updated when the application state changes. The call to
`reduce` introduces spaces between the controls' DOM elements. That
way they don't look so pressed together.

{{index "select (HTML tag)", "change event", "ToolSelect class", "syncState method"}}

The first control is the ((tool)) selection menu. It creates a
`<select>` element with an option for each tool and sets up a
`"change"` event handler that updates the application state when the
user selects a different tool.

```{includeCode: true}
class ToolSelect {
  constructor(state, {tools, dispatch}) {
    this.select = elt("select", {
      onchange: () => dispatch({tool: this.select.value})
    }, ...Object.keys(tools).map(name => elt("option", {
      selected: name == state.tool
    }, name)));
    this.dom = elt("label", null, "🖌 Tool: ", this.select);
  }
  syncState(state) { this.select.value = state.tool; }
}
```

{{index "label (HTML tag)"}}

By wrapping the label text and the field in a `<label>` element, we
tell the browser that the label belongs to that field so that you
can, for example, click the label to focus the field.

{{index "color field", "input (HTML tag)"}}

We also need to be able to change the color, so let's add a control for
that. An HTML `<input>` element with a `type` attribute of `color`
gives us a form field that is specialized for selecting colors. Such a
field's value is always a CSS color code in `"#RRGGBB"` format (red,
green, and blue components, two digits per color). The browser will
show a ((color picker)) interface when the user interacts with it.

{{if book

Depending on the browser, the color picker might look like this:

{{figure {url: "img/color-field.png", alt: "A color field", width: "6cm"}}}

if}}

{{index "ColorSelect class", "syncState method"}}

This ((control)) creates such a field and wires it up to stay
synchronized with the application state's `color` property.

```{includeCode: true}
class ColorSelect {
  constructor(state, {dispatch}) {
    this.input = elt("input", {
      type: "color",
      value: state.color,
      onchange: () => dispatch({color: this.input.value})
    });
    this.dom = elt("label", null, "🎨 Color: ", this.input);
  }
  syncState(state) { this.input.value = state.color; }
}
```

## Drawing tools

Before we can draw anything, we need to implement the ((tool))s that
will control the functionality of mouse or touch events on the canvas.

{{index "draw function"}}

The most basic tool is the draw tool, which changes any ((pixel)) you
click or tap to the currently selected color. It dispatches an action
that updates the picture to a version in which the pointed-at pixel is
given the currently selected color.

```{includeCode: true}
function draw(pos, state, dispatch) {
  function drawPixel({x, y}, state) {
    let drawn = {x, y, color: state.color};
    dispatch({picture: state.picture.draw([drawn])});
  }
  drawPixel(pos, state);
  return drawPixel;
}
```

The function immediately calls the `drawPixel` function but then also
returns it so that it is called again for newly touched pixels when
the user drags or ((swipe))s over the picture.

{{index "rectangle function"}}

To draw larger shapes, it can be useful to quickly create
((rectangle))s. The `rectangle` ((tool)) draws a rectangle between the
point where you start ((dragging)) and the point that you drag to.

```{includeCode: true}
function rectangle(start, state, dispatch) {
  function drawRectangle(pos) {
    let xStart = Math.min(start.x, pos.x);
    let yStart = Math.min(start.y, pos.y);
    let xEnd = Math.max(start.x, pos.x);
    let yEnd = Math.max(start.y, pos.y);
    let drawn = [];
    for (let y = yStart; y <= yEnd; y++) {
      for (let x = xStart; x <= xEnd; x++) {
        drawn.push({x, y, color: state.color});
      }
    }
    dispatch({picture: state.picture.draw(drawn)});
  }
  drawRectangle(start);
  return drawRectangle;
}
```

{{index "persistent data structure", [state, persistence]}}

An important detail in this implementation is that when dragging, the
rectangle is redrawn on the picture from the _original_ state.
That way, you can make the rectangle larger and smaller again while
creating it, without the intermediate rectangles sticking around in
the final picture. This is one of the reasons why ((immutable))
picture objects are useful—we'll see another reason later.

Implementing ((flood fill)) is somewhat more involved. This is a
((tool)) that fills the pixel under the pointer and all adjacent
pixels that have the same color. "Adjacent" means directly
horizontally or vertically adjacent, not diagonally. This picture
illustrates the set of ((pixel))s colored when the flood fill tool is
used at the marked pixel:

{{figure {url: "img/flood-grid.svg", alt: "A pixel grid showing the area filled by a flood fill operation", width: "6cm"}}}

{{index "fill function"}}

Interestingly, the way we'll do this looks a bit like the
((pathfinding)) code from [Chapter ?](robot). Whereas that code
searched through a graph to find a route, this code searches through a
grid to find all "connected" pixels. The problem of keeping track of a
branching set of possible routes is similar.

```{includeCode: true}
const around = [{dx: -1, dy: 0}, {dx: 1, dy: 0},
                {dx: 0, dy: -1}, {dx: 0, dy: 1}];

function fill({x, y}, state, dispatch) {
  let targetColor = state.picture.pixel(x, y);
  let drawn = [{x, y, color: state.color}];
  for (let done = 0; done < drawn.length; done++) {
    for (let {dx, dy} of around) {
      let x = drawn[done].x + dx, y = drawn[done].y + dy;
      if (x >= 0 && x < state.picture.width &&
          y >= 0 && y < state.picture.height &&
          state.picture.pixel(x, y) == targetColor &&
          !drawn.some(p => p.x == x && p.y == y)) {
        drawn.push({x, y, color: state.color});
      }
    }
  }
  dispatch({picture: state.picture.draw(drawn)});
}
```

The array of drawn pixels doubles as the function's ((work list)).
For each pixel reached, we have to see whether any adjacent pixels have the
same color and haven't already been painted over. The loop counter
lags behind the length of the `drawn` array as new pixels are added.
Any pixels ahead of it still need to be explored. When it catches up
with the length, no unexplored pixels remain, and the function is
done.

{{index "pick function"}}

The final ((tool)) is a ((color picker)), which allows you to point at
a color in the picture to use it as the current drawing color.

```{includeCode: true}
function pick(pos, state, dispatch) {
  dispatch({color: state.picture.pixel(pos.x, pos.y)});
}
```

{{if interactive

We can now test our application!

```{lang: "text/html"}
<div></div>
<script>
  let state = {
    tool: "draw",
    color: "#000000",
    picture: Picture.empty(60, 30, "#f0f0f0")
  };
  let app = new PixelEditor(state, {
    tools: {draw, fill, rectangle, pick},
    controls: [ToolSelect, ColorSelect],
    dispatch(action) {
      state = updateState(state, action);
      app.syncState(state);
    }
  });
  document.querySelector("div").appendChild(app.dom);
</script>
```

if}}

## Saving and loading

{{index "SaveButton class", "drawPicture function", [file, image]}}

When we've drawn our masterpiece, we'll want to save it for later. We
should add a button for ((download))ing the current picture as an
image file. This ((control)) provides that button:

```{includeCode: true}
class SaveButton {
  constructor(state) {
    this.picture = state.picture;
    this.dom = elt("button", {
      onclick: () => this.save()
    }, "💾 Save");
  }
  save() {
    let canvas = elt("canvas");
    drawPicture(this.picture, canvas, 1);
    let link = elt("a", {
      href: canvas.toDataURL(),
      download: "pixelart.png"
    });
    document.body.appendChild(link);
    link.click();
    link.remove();
  }
  syncState(state) { this.picture = state.picture; }
}
```

{{index "canvas (HTML tag)"}}

The component keeps track of the current picture so that it can access
it when saving. To create the image file, it uses a `<canvas>` element
that it draws the picture on (at a scale of one pixel per pixel).

{{index "toDataURL method", "data URL"}}

The `toDataURL` method on a canvas element creates a URL that starts
with `data:`. Unlike `http:` and `https:` URLs, data URLs contain the
whole resource in the URL. They are usually very long, but they
allow us to create working links to arbitrary pictures, right here in
the browser.

{{index "a (HTML tag)", "download attribute"}}

To actually get the browser to download the picture, we then create a
((link)) element that points at this URL and has a `download`
attribute. Such links, when clicked, make the browser show a file save
dialog. We add that link to the document, simulate a click on it, and
remove it again.

You can do a lot with ((browser)) technology, but sometimes the way to
do it is rather odd.

{{index "LoadButton class", control, [file, image]}}

And it gets worse. We'll also want to be able to load existing image
files into our application. To do that, we again define a button
component.

```{includeCode: true}
class LoadButton {
  constructor(_, {dispatch}) {
    this.dom = elt("button", {
      onclick: () => startLoad(dispatch)
    }, "📁 Load");
  }
  syncState() {}
}

function startLoad(dispatch) {
  let input = elt("input", {
    type: "file",
    onchange: () => finishLoad(input.files[0], dispatch)
  });
  document.body.appendChild(input);
  input.click();
  input.remove();
}
```

{{index [file, access], "input (HTML tag)"}}

To get access to a file on the user's computer, we need the user to
select the file through a file input field. But I don't want the load
button to look like a file input field, so we create the file input
when the button is clicked and then pretend that this file input
itself was clicked.

{{index "FileReader class", "img (HTML tag)", "readAsDataURL method", "Picture class"}}

When the user has selected a file, we can use `FileReader` to get
access to its contents, again as a ((data URL)). That URL can be used
to create an `<img>` element, but because we can't get direct access
to the pixels in such an image, we can't create a `Picture` object
from that.

```{includeCode: true}
function finishLoad(file, dispatch) {
  if (file == null) return;
  let reader = new FileReader();
  reader.addEventListener("load", () => {
    let image = elt("img", {
      onload: () => dispatch({
        picture: pictureFromImage(image)
      }),
      src: reader.result
    });
  });
  reader.readAsDataURL(file);
}
```

{{index "canvas (HTML tag)", "getImageData method", "pictureFromImage function"}}

To get access to the pixels, we must first draw the picture to a
`<canvas>` element. The canvas context has a `getImageData` method
that allows a script to read its ((pixel))s. So, once the picture is on
the canvas, we can access it and construct a `Picture` object.

```{includeCode: true}
function pictureFromImage(image) {
  let width = Math.min(100, image.width);
  let height = Math.min(100, image.height);
  let canvas = elt("canvas", {width, height});
  let cx = canvas.getContext("2d");
  cx.drawImage(image, 0, 0);
  let pixels = [];
  let {data} = cx.getImageData(0, 0, width, height);

  function hex(n) {
    return n.toString(16).padStart(2, "0");
  }
  for (let i = 0; i < data.length; i += 4) {
    let [r, g, b] = data.slice(i, i + 3);
    pixels.push("#" + hex(r) + hex(g) + hex(b));
  }
  return new Picture(width, height, pixels);
}
```

We'll limit the size of images to 100 by 100 pixels since anything
bigger will look _huge_ on our display and might slow down the
interface.

{{index "getImageData method", color, transparency}}

The `data` property of the object returned by `getImageData` is an
array of color components. For each pixel in the rectangle specified
by the arguments, it contains four values, which represent the red,
green, blue, and _((alpha))_ components of the pixel's color, as
numbers between 0 and 255. The alpha part represents opacity—when it
is zero, the pixel is fully transparent, and when it is 255, it is
fully opaque. For our purpose, we can ignore it.

{{index "hexadecimal number", "toString method"}}

The two hexadecimal digits per component, as used in our color
notation, correspond precisely to the 0 to 255 range—two base-16
digits can express 16^2^ = 256 different numbers. The `toString`
method of numbers can be given a base as argument, so `n.toString(16)`
will produce a string representation in base 16. We have to make sure
that each number takes up two digits, so the `hex` helper function
calls `padStart` to add a leading zero when necessary.

We can load and save now! That leaves one more feature before we're
done.

## Undo history

Half of the process of editing is making little mistakes and
correcting them. So an important feature in a drawing
program is an ((undo history)).

{{index "persistent data structure", [state, "of application"]}}

To be able to undo changes, we need to store previous versions of the
picture. Since it's an ((immutable)) value, that is easy. But it does
require an additional field in the application state.

{{index "done property"}}

We'll add a `done` array to keep previous versions of the ((picture)).
Maintaining this property requires a more complicated state update
function that adds pictures to the array.

{{index "doneAt property", "historyUpdateState function", "Date.now function"}}

But we don't want to store _every_ change, only changes a certain
amount of ((time)) apart. To be able to do that, we'll need a second
property, `doneAt`, tracking the time at which we last stored a
picture in the history.

```{includeCode: true}
function historyUpdateState(state, action) {
  if (action.undo == true) {
    if (state.done.length == 0) return state;
    return Object.assign({}, state, {
      picture: state.done[0],
      done: state.done.slice(1),
      doneAt: 0
    });
  } else if (action.picture &&
             state.doneAt < Date.now() - 1000) {
    return Object.assign({}, state, action, {
      done: [state.picture, ...state.done],
      doneAt: Date.now()
    });
  } else {
    return Object.assign({}, state, action);
  }
}
```

{{index "undo history"}}

When the action is an undo action, the function takes the most recent
picture from the history and makes that the current picture. It sets
`doneAt` to zero so that the next change is guaranteed to store the
picture back in the history, allowing you to revert to it another
time if you want.

Otherwise, if the action contains a new picture and the last time we
stored something is more than a second (1000 milliseconds) ago, the
`done` and `doneAt` properties are updated to store the previous
picture.

{{index "UndoButton class", control}}

The undo button ((component)) doesn't do much. It dispatches undo
actions when clicked and disables itself when there is nothing to
undo.

```{includeCode: true}
class UndoButton {
  constructor(state, {dispatch}) {
    this.dom = elt("button", {
      onclick: () => dispatch({undo: true}),
      disabled: state.done.length == 0
    }, "⮪ Undo");
  }
  syncState(state) {
    this.dom.disabled = state.done.length == 0;
  }
}
```

## Let's draw

{{index "PixelEditor class", "startState constant", "baseTools constant", "baseControls constant", "startPixelEditor function"}}

To set up the application, we need to create a state, a set of
((tool))s, a set of ((control))s, and a ((dispatch)) function. We can
pass them to the `PixelEditor` constructor to create the main
component. Since we'll need to create several editors in the
exercises, we first define some bindings.

```{includeCode: true}
const startState = {
  tool: "draw",
  color: "#000000",
  picture: Picture.empty(60, 30, "#f0f0f0"),
  done: [],
  doneAt: 0
};

const baseTools = {draw, fill, rectangle, pick};

const baseControls = [
  ToolSelect, ColorSelect, SaveButton, LoadButton, UndoButton
];

function startPixelEditor({state = startState,
                           tools = baseTools,
                           controls = baseControls}) {
  let app = new PixelEditor(state, {
    tools,
    controls,
    dispatch(action) {
      state = historyUpdateState(state, action);
      app.syncState(state);
    }
  });
  return app.dom;
}
```

{{index "destructuring binding", "= operator", [property, access]}}

When destructuring an object or array, you can use `=` after a binding
name to give the binding a ((default value)), which is used when the
property is missing or holds `undefined`. The `startPixelEditor`
function makes use of this to accept an object with a number of
optional properties as an argument. If you don't provide a `tools`
property, for example, `tools` will be bound to `baseTools`.

This is how we get an actual editor on the screen:

```{lang: "text/html", startCode: true}
<div></div>
<script>
  document.querySelector("div")
    .appendChild(startPixelEditor({}));
</script>
```

{{if interactive

Go ahead and draw something. I'll wait.

if}}

## Why is this so hard?

Browser technology is amazing. It provides a powerful set of interface
building blocks, ways to style and manipulate them, and tools to
inspect and debug your applications. The software you write for the
((browser)) can be run on almost every computer and phone on the
planet.

At the same time, browser technology is ridiculous. You have to learn
a large number of silly tricks and obscure facts to master it, and the
default programming model it provides is so problematic that most
programmers prefer to cover it in several layers of ((abstraction))
rather than deal with it directly.

{{index standard, evolution}}

And though the situation is definitely improving, it mostly does so in
the form of more elements being added to address shortcomings—creating
even more ((complexity)). A feature used by a million websites can't
really be replaced. Even if it could, it would be hard to decide
what it should be replaced with.

{{index "social factors", "economic factors", history}}

Technology never exists in a vacuum—we're constrained by our tools and
the social, economic, and historical factors that produced them.
This can be annoying, but it is generally more productive to try to
build a good understanding of how the _existing_ technical reality
works—and why it is the way it is—than to rage against it or hold out
for another reality.

New ((abstraction))s _can_ be helpful. The component model and ((data
flow)) convention I used in this chapter is a crude form of that. As
mentioned, there are libraries that try to make user interface
programming more pleasant. At the time of writing,
[React](https://reactjs.org/) and [Angular](https://angular.io/) are
popular choices, but there's a whole cottage industry of such
frameworks. If you're interested in programming web applications, I
recommend investigating a few of them to understand how they work and
what benefits they provide.

## Exercises

There is still room for improvement in our program. Let's add a few
more features as exercises.

### Keyboard bindings

{{index "keyboard bindings (exercise)"}}

Add ((keyboard)) shortcuts to the application. The first letter of a
tool's name selects the tool, and [control]{keyname}-Z or [command]{keyname}-Z activates undo.

{{index "PixelEditor class", "tabindex attribute", "elt function", "keydown event"}}

Do this by modifying the `PixelEditor` component. Add a `tabIndex`
property of 0 to the wrapping `<div>` element so that it can receive
keyboard ((focus)). Note that the _property_ corresponding to the
`tabindex` _attribute_ is called `tabIndex`, with a capital I, and our
`elt` function expects property names. Register the key event handlers
directly on that element. This means you have to click, touch, or
tab to the application before you can interact with it with the
keyboard.

{{index "ctrlKey property", "metaKey property", "control key", "command key"}}

Remember that keyboard events have `ctrlKey` and `metaKey` (for the
[command]{keyname} key on Mac) properties that you can use to see whether those
keys are held down.

{{if interactive

```{test: no, lang: "text/html"}
<div></div>
<script>
  // The original PixelEditor class. Extend the constructor.
  class PixelEditor {
    constructor(state, config) {
      let {tools, controls, dispatch} = config;
      this.state = state;

      this.canvas = new PictureCanvas(state.picture, pos => {
        let tool = tools[this.state.tool];
        let onMove = tool(pos, this.state, dispatch);
        if (onMove) {
          return pos => onMove(pos, this.state, dispatch);
        }
      });
      this.controls = controls.map(
        Control => new Control(state, config));
      this.dom = elt("div", {}, this.canvas.dom, elt("br"),
                     ...this.controls.reduce(
                       (a, c) => a.concat(" ", c.dom), []));
    }
    syncState(state) {
      this.state = state;
      this.canvas.syncState(state.picture);
      for (let ctrl of this.controls) ctrl.syncState(state);
    }
  }

  document.querySelector("div")
    .appendChild(startPixelEditor({}));
</script>
```

if}}

{{hint

{{index "keyboard bindings (exercise)", "key property", "shift key"}}

The `key` property of events for letter keys will be the lowercase
letter itself, if [shift]{keyname} isn't being held. We're not interested in
key events with [shift]{keyname} here.

{{index "keydown event"}}

A `"keydown"` handler can inspect its event object to see whether it
matches any of the shortcuts. You can automatically get the list of
first letters from the `tools` object so that you don't have to write
them out.

{{index "preventDefault method"}}

When the key event matches a shortcut, call `preventDefault` on it and
((dispatch)) the appropriate action.

hint}}

### Efficient drawing

{{index "efficient drawing (exercise)", "canvas (HTML tag)", efficiency}}

During drawing, the majority of work that our application does happens
in `drawPicture`. Creating a new state and updating the rest of the
DOM isn't very expensive, but repainting all the pixels on the canvas
is quite a bit of work.

{{index "syncState method", "PictureCanvas class"}}

Find a way to make the `syncState` method of `PictureCanvas` faster by
redrawing only the pixels that actually changed.

{{index "drawPicture function", compatibility}}

Remember that `drawPicture` is also used by the save button, so if you
change it, either make sure the changes don't break the old use or
create a new version with a different name.

{{index "width property", "height property"}}

Also note that changing the size of a `<canvas>` element, by setting
its `width` or `height` properties, clears it, making it entirely
transparent again.

{{if interactive

```{test: no, lang: "text/html"}
<div></div>
<script>
  // Change this method
  PictureCanvas.prototype.syncState = function(picture) {
    if (this.picture == picture) return;
    this.picture = picture;
    drawPicture(this.picture, this.dom, scale);
  };

  // You may want to use or change this as well
  function drawPicture(picture, canvas, scale) {
    canvas.width = picture.width * scale;
    canvas.height = picture.height * scale;
    let cx = canvas.getContext("2d");

    for (let y = 0; y < picture.height; y++) {
      for (let x = 0; x < picture.width; x++) {
        cx.fillStyle = picture.pixel(x, y);
        cx.fillRect(x * scale, y * scale, scale, scale);
      }
    }
  }

  document.querySelector("div")
    .appendChild(startPixelEditor({}));
</script>
```

if}}

{{hint

{{index "efficient drawing (exercise)"}}

This exercise is a good example of how ((immutable)) data structures
can make code _faster_. Because we have both the old and the new
picture, we can compare them and redraw only the pixels that changed
color, saving more than 99 percent of the drawing work in most cases.

{{index "drawPicture function"}}

You can either write a new function `updatePicture` or have
`drawPicture` take an extra argument, which may be undefined or the
previous picture. For each ((pixel)), the function checks whether a
previous picture was passed with the same color at this position and
skips the pixel when that is the case.

{{index "width property", "height property", "canvas (HTML tag)"}}

Because the canvas gets cleared when we change its size, you should
also avoid touching its `width` and `height` properties when the old
picture and the new picture have the same size. If they are different, which
will happen when a new picture has been loaded, you can set
the binding holding the old picture to null after changing the canvas size because you shouldn't
skip any pixels after you've changed the canvas size.

hint}}

### Circles

{{index "circles (exercise)", dragging}}

Define a ((tool)) called `circle` that draws a filled circle when you
drag. The center of the circle lies at the point where the drag or
touch gesture starts, and its ((radius)) is determined by the distance
dragged.

{{if interactive

```{test: no, lang: "text/html"}
<div></div>
<script>
  function circle(pos, state, dispatch) {
    // Your code here
  }

  let dom = startPixelEditor({
    tools: Object.assign({}, baseTools, {circle})
  });
  document.querySelector("div").appendChild(dom);
</script>
```

if}}

{{hint

{{index "circles (exercise)", "rectangle function"}}

You can take some inspiration from the `rectangle` tool. Like that
tool, you'll want to keep drawing on the _starting_ picture, rather
than the current picture, when the pointer moves.

To figure out which pixels to color, you can use the ((Pythagorean
theorem)). First figure out the distance between the current pointer
position and the start position by taking the square root
(`Math.sqrt`) of the sum of the square (`Math.pow(x, 2)`) of the difference in
x-coordinates and the square of the difference in y-coordinates. Then
loop over a square of pixels around the start position, whose sides
are at least twice the ((radius)), and color those that are within the
circle's radius, again using the Pythagorean formula to figure out
their ((distance)) from the center.

Make sure you don't try to color pixels that are outside of the
picture's boundaries.

hint}}

### Proper lines

{{index "proper lines (exercise)", "line drawing"}}

This is a more advanced exercise than the preceding two, and it will
require you to design a solution to a nontrivial problem. Make sure
you have plenty of time and ((patience)) before starting to work on
this exercise, and do not get discouraged by initial failures.

{{index "draw function", "mousemove event", "touchmove event"}}

On most browsers, when you select the `draw` ((tool)) and quickly drag
across the picture, you don't get a closed line. Rather, you get dots
with gaps between them because the `"mousemove"` or `"touchmove"`
events did not fire quickly enough to hit every ((pixel)).

Improve the `draw` tool to make it draw a full line. This means you
have to make the motion handler function remember the previous
position and connect that to the current one.

To do this, since the pixels can be an arbitrary distance apart,
you'll have to write a general line drawing function.

A line between two pixels is a connected chain of pixels, as straight
as possible, going from the start to the end. Diagonally adjacent
pixels count as a connected. So a slanted line should look like the
picture on the left, not the picture on the right.

{{figure {url: "img/line-grid.svg", alt: "Two pixelated lines, one light, skipping across pixels diagonally, and one heavy, with all pixels connected horizontally or vertically", width: "6cm"}}}

Finally, if we have code that draws a line between two arbitrary points, we
might as well use it to also define a `line` tool,
which draws a straight line between the start and end of a drag.

{{if interactive

```{test: no, lang: "text/html"}
<div></div>
<script>
  // The old draw tool. Rewrite this.
  function draw(pos, state, dispatch) {
    function drawPixel({x, y}, state) {
      let drawn = {x, y, color: state.color};
      dispatch({picture: state.picture.draw([drawn])});
    }
    drawPixel(pos, state);
    return drawPixel;
  }

  function line(pos, state, dispatch) {
    // Your code here
  }

  let dom = startPixelEditor({
    tools: {draw, line, fill, rectangle, pick}
  });
  document.querySelector("div").appendChild(dom);
</script>
```

if}}

{{hint

{{index "proper lines (exercise)", "line drawing"}}

The thing about the problem of drawing a pixelated line is that it is
really four similar but slightly different problems. Drawing a
horizontal line from the left to the right is easy—you loop over the
x-coordinates and color a pixel at every step. If the line has a
slight slope (less than 45 degrees or ¼π radians), you can interpolate
the y-coordinate along the slope. You still need one pixel per _x_
position, with the _y_ position of those pixels determined by the
slope.

But as soon as your slope goes across 45 degrees, you need to switch
the way you treat the coordinates. You now need one pixel per _y_
position since the line goes up more than it goes left. And then,
when you cross 135 degrees, you have to go back to looping over the
x-coordinates, but from right to left.

You don't actually have to write four loops. Since drawing a line from
_A_ to _B_ is the same as drawing a line from _B_ to _A_, you can swap
the start and end positions for lines going from right to left and
treat them as going left to right.

So you need two different loops. The first thing your line drawing
function should do is check whether the difference between the
x-coordinates is larger than the difference between the y-coordinates.
If it is, this is a horizontal-ish line, and if not, a vertical-ish
one.

{{index "Math.abs function", "absolute value"}}

Make sure you compare the _absolute_ values of the _x_ and _y_
difference, which you can get with `Math.abs`.

{{index "swapping bindings"}}

Once you know along which ((axis)) you will be looping, you can check
whether the start point has a higher coordinate along that axis than
the endpoint and swap them if necessary. A succinct way to swap the
values of two bindings in JavaScript uses ((destructuring assignment))
like this:

```{test: no}
[start, end] = [end, start];
```

{{index rounding}}

Then you can compute the ((slope)) of the line, which determines the
amount the coordinate on the other axis changes for each step you
take along your main axis. With that, you can run a loop along the
main axis while also tracking the corresponding position on the other
axis, and you can draw pixels on every iteration. Make sure you round the
non-main axis coordinates since they are likely to be fractional and
the `draw` method doesn't respond well to fractional coordinates.

hint}}
{{meta {code_links: ["code/file_server.js"]}}}

# Node.js

{{quote {author: "Master Yuan-Ma", title: "The Book of Programming", chapter: true}

A student asked, 'The programmers of old used only simple machines and
no programming languages, yet they made beautiful programs. Why do we
use complicated machines and programming languages?'. Fu-Tzu replied,
'The builders of old used only sticks and clay, yet they made
beautiful huts.'

quote}}

{{index "Yuan-Ma", "Book of Programming"}}

{{figure {url: "img/chapter_picture_20.jpg", alt: "Picture of a telephone pole", chapter: "framed"}}}

{{index "command line"}}

So far, we have used the JavaScript language in a single environment:
the browser. This chapter and the [next one](skillsharing) will
briefly introduce ((Node.js)), a program that allows you to apply your
JavaScript skills outside of the browser. With it, you can build
anything from small command line tools to HTTP ((server))s that power
dynamic ((website))s.

These chapters aim to teach you the main concepts that Node.js uses
and to give you enough information to write useful programs for it.
They do not try to be a complete, or even a thorough, treatment of the
platform.

{{if interactive

Whereas you could run the code in previous chapters directly on these
pages, because it was either raw JavaScript or written for the
browser, the code samples in this chapter are written for Node and
often won't run in the browser.

if}}

If you want to follow along and run the code in this chapter, you'll
need to install Node.js version 10.1 or higher. To do so, go to
[_https://nodejs.org_](https://nodejs.org) and follow the installation
instructions for your operating system. You can also find further
((documentation)) for Node.js there.

## Background

{{index responsiveness, input, [network, speed]}}

One of the more difficult problems with writing systems that
communicate over the network is managing input and ((output))—that
is, the reading and writing of data to and from the network and ((hard
drive)). Moving data around takes time, and ((scheduling)) it cleverly
can make a big difference in how quickly a system responds to the user
or to network requests.

{{index ["asynchronous programming", "in Node.js"]}}

In such programs, asynchronous programming is often helpful. It
allows the program to send and receive data from and to multiple
devices at the same time without complicated thread management and
synchronization.

{{index "programming language", "Node.js", standard}}

Node was initially conceived for the purpose of making asynchronous
programming easy and convenient. JavaScript lends itself well to a
system like Node. It is one of the few programming languages that does
not have a built-in way to do in- and output. Thus, JavaScript could
be fit onto Node's rather eccentric approach to in- and output without
ending up with two inconsistent interfaces. In 2009, when Node was
being designed, people were already doing callback-based programming
in the browser, so the ((community)) around the language was used to
an asynchronous programming style.

## The node command

{{index "node program"}}

When ((Node.js)) is installed on a system, it provides a program
called `node`, which is used to run JavaScript files. Say you have a
file `hello.js`, containing this code:

```
let message = "Hello world";
console.log(message);
```

You can then run `node` from the ((command line)) like this to execute
the program:

```{lang: null}
$ node hello.js
Hello world
```

{{index "console.log"}}

The `console.log` method in Node does something similar to what it
does in the browser. It prints out a piece of text. But in Node, the
text will go to the process's ((standard output)) stream, rather than
to a browser's ((JavaScript console)). When running `node` from the
command line, that means you see the logged values in your
((terminal)).

{{index "node program", "read-eval-print loop"}}

If you run `node` without giving it a file, it provides you with a
prompt at which you can type JavaScript code and immediately see the
result.

```{lang: null}
$ node
> 1 + 1
2
> [-1, -2, -3].map(Math.abs)
[1, 2, 3]
> process.exit(0)
$
```

{{index "process object", "global scope", [binding, global], "exit method", "status code"}}

The `process` binding, just like the `console` binding, is available
globally in Node. It provides various ways to inspect and manipulate
the current program. The `exit` method ends the process and can be
given an exit status code, which tells the program that started `node`
(in this case, the command line shell) whether the program completed
successfully (code zero) or encountered an error (any other code).

{{index "command line", "argv property"}}

To find the command line arguments given to your script, you can read
`process.argv`, which is an array of strings. Note that it also
includes the name of the `node` command and your script name, so the
actual arguments start at index 2. If `showargv.js` contains the
statement `console.log(process.argv)`, you could run it like this:

```{lang: null}
$ node showargv.js one --and two
["node", "/tmp/showargv.js", "one", "--and", "two"]
```

{{index [binding, global]}}

All the ((standard)) JavaScript global bindings, such as `Array`,
`Math`, and `JSON`, are also present in Node's environment.
Browser-related functionality, such as `document` or `prompt`, is not.

## Modules

{{index "Node.js", "global scope", "module loader"}}

Beyond the bindings I mentioned, such as `console` and `process`,
Node puts few additional bindings in the global scope. If you want to access
built-in functionality, you have to ask the module system for it.

{{index "require function"}}

The ((CommonJS)) module system, based on the `require` function, was
described in [Chapter ?](modules#commonjs). This system is built into
Node and is used to load anything from built-in ((module))s to
downloaded ((package))s to ((file))s that are part of your own
program.

{{index [path, "file system"], "relative path", resolution}}

When `require` is called, Node has to resolve the given string to an
actual ((file)) that it can load. Pathnames that start with `/`,
`./`, or `../` are resolved relative to the current module's path,
where `.` stands for the current directory, `../` for one
directory up, and `/` for the root of the file system. So if you ask
for `"./graph"` from the file `/tmp/robot/robot.js`, Node will try to
load the file `/tmp/robot/graph.js`.

{{index "index.js"}}

The `.js` ((extension)) may be omitted, and Node will add it if such a
file exists. If the required path refers to a ((directory)), Node will
try to load the file named `index.js` in that directory.

{{index "node_modules directory", directory}}

When a string that does not look like a relative or absolute path is
given to `require`, it is assumed to refer to either a built-in
((module)) or a module installed in a `node_modules` directory. For
example, `require("fs")` will give you Node's built-in file system
module. And `require("robot")` might try to load the library found in
`node_modules/robot/`. A common way to install such libraries is by
using ((NPM)), which we'll come back to in a moment.

{{index "require function", "Node.js", "garble example"}}

Let's set up a small project consisting of two files. The first one,
called `main.js`, defines a script that can be called from the
((command line)) to reverse a string.

```
const {reverse} = require("./reverse");

// Index 2 holds the first actual command line argument
let argument = process.argv[2];

console.log(reverse(argument));
```

{{index reuse, "Array.from function", "join method"}}

The file `reverse.js` defines a library for reversing strings, which
can be used both by this command line tool and by other scripts that
need direct access to a string-reversing function.

```
exports.reverse = function(string) {
  return Array.from(string).reverse().join("");
};
```

{{index "exports object", CommonJS, [interface, module]}}

Remember that adding properties to `exports` adds them to the
interface of the module. Since Node.js treats files as
((CommonJS)) ((module))s, `main.js` can take the exported `reverse`
function from `reverse.js`.

We can now call our tool like this:

```{lang: null}
$ node main.js JavaScript
tpircSavaJ
```

## Installing with NPM

{{index NPM, "Node.js", "npm program", library}}

NPM, which was introduced in [Chapter ?](modules#modules_npm), is an
online repository of JavaScript ((module))s, many of which are
specifically written for Node. When you install Node on your computer,
you also get the `npm` command, which you can use to interact with this
repository.

{{index "ini package"}}

NPM's main use is ((download))ing packages. We saw the `ini` package in
[Chapter ?](modules#modules_ini). We can use NPM to fetch and install
that package on our computer.

```{lang: null}
$ npm install ini
npm WARN enoent ENOENT: no such file or directory,
         open '/tmp/package.json'
+ ini@1.3.5
added 1 package in 0.552s

$ node
> const {parse} = require("ini");
> parse("x = 1\ny = 2");
{ x: '1', y: '2' }
```

{{index "require function", "node_modules directory", "npm program"}}

After running `npm install`, ((NPM)) will have created a directory
called `node_modules`. Inside that directory will be an `ini`
directory that contains the ((library)). You can open it and look at
the code. When we call `require("ini")`, this library is loaded, and
we can call its `parse` property to parse a configuration file.

By default NPM installs packages under the current directory, rather
than in a central place. If you are used to other package managers,
this may seem unusual, but it has advantages—it puts each application
in full control of the packages it installs and makes it easier to
manage versions and clean up when removing an application.

### Package files

{{index "package.json", dependency}}

In the `npm install` example, you could see a ((warning)) about the
fact that the `package.json` file did not exist. It is recommended to
create such a file for each project, either manually or by running
`npm init`. It contains some information about the project, such as
its name and ((version)), and lists its dependencies.

The robot simulation from [Chapter ?](robot), as modularized in the
exercise in [Chapter ?](modules#modular_robot), might have a
`package.json` file like this:

```{lang: "application/json"}
{
  "author": "Marijn Haverbeke",
  "name": "eloquent-javascript-robot",
  "description": "Simulation of a package-delivery robot",
  "version": "1.0.0",
  "main": "run.js",
  "dependencies": {
    "dijkstrajs": "^1.0.1",
    "random-item": "^1.0.0"
  },
  "license": "ISC"
}
```

{{index "npm program", tool}}

When you run `npm install` without naming a package to install, NPM
will install the dependencies listed in `package.json`. When you
install a specific package that is not already listed as a dependency,
NPM will add it to `package.json`.

### Versions

{{index "package.json", dependency, evolution}}

A `package.json` file lists both the program's own ((version)) and
versions for its dependencies. Versions are a way to deal with the
fact that ((package))s evolve separately, and code written to work
with a package as it existed at one point may not work with a later,
modified version of the package.

{{index compatibility}}

NPM demands that its packages follow a schema called _((semantic
versioning))_, which encodes some information about which versions are
_compatible_ (don't break the old interface) in the version number. A
semantic version consists of three numbers, separated by periods, such
as `2.3.0`. Every time new functionality is added, the middle number
has to be incremented. Every time compatibility is broken, so that
existing code that uses the package might not work with the new
version, the first number has to be incremented.

{{index "caret character"}}

A caret character (`^`) in front of the version number for a
dependency in `package.json` indicates that any version compatible
with the given number may be installed. So, for example, `"^2.3.0"`
would mean that any version greater than or equal to 2.3.0 and less
than 3.0.0 is allowed.

{{index publishing}}

The `npm` command is also used to publish new packages or new versions
of packages. If you run `npm publish` in a ((directory)) that has a
`package.json` file, it will publish a package with the name and
version listed in the JSON file to the registry. Anyone can publish
packages to NPM—though only under a package name that isn't in use yet since it would be
somewhat scary if random people could update existing packages.

Since the `npm` program is a piece of software that talks to an open
system—the package registry—there is nothing unique about what it
does. Another program, `yarn`, which can be installed from the NPM
registry, fills the same role as `npm` using a somewhat different
interface and installation strategy.

This book won't delve further into the details of ((NPM)) usage. Refer
to [_https://npmjs.org_](https://npmjs.org) for further documentation and a
way to search for packages.

## The file system module

{{index directory, "fs package", "Node.js", [file, access]}}

One of the most commonly used built-in modules in Node is the `fs`
module, which stands for _((file system))_. It exports functions for
working with files and directories.

{{index "readFile function", "callback function"}}

For example, the function called `readFile` reads a file
and then calls a callback with the file's contents.

```
let {readFile} = require("fs");
readFile("file.txt", "utf8", (error, text) => {
  if (error) throw error;
  console.log("The file contains:", text);
});
```

{{index "Buffer class"}}

The second argument to `readFile` indicates the _((character
encoding))_ used to decode the file into a string. There are several
ways in which ((text)) can be encoded to ((binary data)), but most
modern systems use ((UTF-8)). So unless you have reasons to believe
another encoding is used, pass `"utf8"` when reading a text file. If
you do not pass an encoding, Node will assume you are interested in
the binary data and will give you a `Buffer` object instead of a
string. This is an ((array-like object)) that contains numbers
representing the bytes (8-bit chunks of data) in the files.

```
const {readFile} = require("fs");
readFile("file.txt", (error, buffer) => {
  if (error) throw error;
  console.log("The file contained", buffer.length, "bytes.",
              "The first byte is:", buffer[0]);
});
```

{{index "writeFile function", "file system", [file, access]}}

A similar function, `writeFile`, is used to write a file to disk.

```
const {writeFile} = require("fs");
writeFile("graffiti.txt", "Node was here", err => {
  if (err) console.log(`Failed to write file: ${err}`);
  else console.log("File written.");
});
```

{{index "Buffer class", "character encoding"}}

Here it was not necessary to specify the encoding—`writeFile` will
assume that when it is given a string to write, rather than a `Buffer`
object, it should write it out as text using its default character
encoding, which is ((UTF-8)).

{{index "fs package", "readdir function", "stat function", "rename function", "unlink function"}}

The `fs` module contains many other useful functions: `readdir` will
return the files in a ((directory)) as an array of strings, `stat`
will retrieve information about a file, `rename` will rename a file,
`unlink` will remove one, and so on. See the documentation at
[_https://nodejs.org_](https://nodejs.org) for specifics.

{{index ["asynchronous programming", "in Node.js"], "Node.js", "error handling", "callback function"}}

Most of these take a callback function as the last parameter, which
they call either with an error (the first argument) or with a successful
result (the second). As we saw in [Chapter ?](async), there are
downsides to this style of programming—the biggest one being that
error handling becomes verbose and error-prone.

{{index "Promise class", "promises package"}}

Though promises have been part of JavaScript for a while, at the time
of writing their integration into Node.js is still a work in progress.
There is an object `promises` exported from the `fs` package since
version 10.1 that contains most of the same functions as `fs` but
uses promises rather than callback functions.

```
const {readFile} = require("fs").promises;
readFile("file.txt", "utf8")
  .then(text => console.log("The file contains:", text));
```

{{index "synchronous programming", "fs package", "readFileSync function"}}

Sometimes you don't need asynchronicity, and it just gets in the way.
Many of the functions in `fs` also have a synchronous variant, which
has the same name with `Sync` added to the end. For example, the
synchronous version of `readFile` is called `readFileSync`.

```
const {readFileSync} = require("fs");
console.log("The file contains:",
            readFileSync("file.txt", "utf8"));
```

{{index optimization, performance, blocking}}

Do note that while such a synchronous operation is being performed,
your program is stopped entirely. If it should be responding to the
user or to other machines on the network, being stuck on a synchronous
action might produce annoying delays.

## The HTTP module

{{index "Node.js", "http package", [HTTP, server]}}

Another central module is called `http`. It provides functionality for
running HTTP ((server))s and making HTTP ((request))s.

{{index "listening (TCP)", "listen method", "createServer function"}}

This is all it takes to start an HTTP server:

```
const {createServer} = require("http");
let server = createServer((request, response) => {
  response.writeHead(200, {"Content-Type": "text/html"});
  response.write(`
    <h1>Hello!</h1>
    <p>You asked for <code>${request.url}</code></p>`);
  response.end();
});
server.listen(8000);
console.log("Listening! (port 8000)");
```

{{index port, localhost}}

If you run this script on your own machine, you can point your web
browser at
[_http://localhost:8000/hello_](http://localhost:8000/hello) to make a
request to your server. It will respond with a small HTML page.

{{index "createServer function", HTTP}}

The function passed as argument to `createServer` is called every time
a client connects to the server. The `request` and `response` bindings
are objects representing the incoming and outgoing data. The first
contains information about the ((request)), such as its `url` property,
which tells us to what URL the request was made.

So, when you open that page in your browser, it sends a request to your
own computer. This causes the server function to run and send back a
response, which you can then see in the browser.

{{index "200 (HTTP status code)", "Content-Type header", "writeHead method"}}

To send something back, you call methods on the `response` object. The
first, `writeHead`, will write out the ((response)) ((header))s (see
[Chapter ?](http#headers)). You give it the status code (200 for "OK"
in this case) and an object that contains header values. The example
sets the `Content-Type` header to inform the client that we'll be
sending back an HTML document.

{{index "writable stream", "body (HTTP)", stream, "write method", "end method"}}

Next, the actual response body (the document itself) is sent with
`response.write`. You are allowed to call this method multiple times
if you want to send the response piece by piece, for example to stream
data to the client as it becomes available. Finally, `response.end`
signals the end of the response.

{{index "listen method"}}

The call to `server.listen` causes the ((server)) to start waiting for
connections on ((port)) 8000. This is why you have to connect
to _localhost:8000_ to speak to this server, rather than just
_localhost_, which would use the default port 80.

{{index "Node.js", "kill process"}}

When you run this script, the process just sits there and waits. When
a script is listening for events—in this case, network
connections—`node` will not automatically exit when it reaches the end
of the script. To close it, press [control]{keyname}-C.

{{index [method, HTTP]}}

A real web ((server)) usually does more than the one in the example—it
looks at the request's ((method)) (the `method` property) to see what
action the client is trying to perform and looks at the request's ((URL)) to
find out which resource this action is being performed on. We'll see a
more advanced server [later in this chapter](node#file_server).

{{index "http package", "request function", [HTTP, client]}}

To act as an HTTP _((client))_, we can use the `request` function
in the `http` module.

```
const {request} = require("http");
let requestStream = request({
  hostname: "eloquentjavascript.net",
  path: "/20_node.html",
  method: "GET",
  headers: {Accept: "text/html"}
}, response => {
  console.log("Server responded with status code",
              response.statusCode);
});
requestStream.end();
```

{{index "Node.js", "callback function", "readable stream"}}

The first argument to `request` configures the request, telling Node
what server to talk to, what path to request from that server, which
method to use, and so on. The second argument is the function that
should be called when a response comes in. It is given an object that
allows us to inspect the response, for example to find out its status
code.

{{index "GET method", "write method", "end method", "writable stream", "request function"}}

Just like the `response` object we saw in the server, the object
returned by `request` allows us to ((stream)) data into the
((request)) with the `write` method and finish the request with the
`end` method. The example does not use `write` because `GET` requests
should not contain data in their request body.

{{index HTTPS, "https package", "request function"}}

There's a similar `request` function in the `https` module that
can be used to make requests to `https:` URLs.

{{index "fetch function", "Promise class", "node-fetch package"}}

Making requests with Node's raw functionality is rather verbose.
There are much more convenient wrapper packages available on NPM. For
example, `node-fetch` provides the promise-based `fetch` interface that
we know from the browser.

## Streams

{{index "Node.js", stream, "writable stream"}}

We have seen two instances of writable streams in the HTTP
examples—namely, the response object that the server could write to
and the request object that was returned from `request`.

{{index "callback function", ["asynchronous programming", "in Node.js"], "write method", "end method", "Buffer class"}}

_Writable streams_ are a widely used concept in Node. Such objects have
a `write` method that can be passed a string or a `Buffer` object to
write something to the stream. Their `end` method closes the stream
and optionally takes a value to write to the stream before
closing. Both of these methods can also be given a callback as an
additional argument, which they will call when the writing or closing
has finished.

{{index "createWriteStream function", "writeFile function", [file, stream]}}

It is possible to create a writable stream that points at a file
with the `createWriteStream` function from the `fs` module. Then you
can use the `write` method on the resulting object to write the file
one piece at a time, rather than in one shot as with `writeFile`.

{{index "createServer function", "request function", "event handling", "readable stream"}}

Readable ((stream))s are a little more involved. Both the `request`
binding that was passed to the HTTP server's callback and the
`response` binding passed to the HTTP client's callback are readable
streams—a server reads requests and then writes responses, whereas a
client first writes a request and then reads a response. Reading from
a stream is done using event handlers, rather than methods.

{{index "on method", "addEventListener method"}}

Objects that emit events in Node have a method called `on` that is
similar to the `addEventListener` method in the browser. You give it
an event name and then a function, and it will register that function
to be called whenever the given event occurs.

{{index "createReadStream function", "data event", "end event", "readable stream"}}

Readable ((stream))s have `"data"` and `"end"` events. The first is
fired every time data comes in, and the second is called whenever the
stream is at its end. This model is most suited for _streaming_ data that
can be immediately processed, even when the whole document isn't
available yet. A file can be read as a readable stream by using the
`createReadStream` function from `fs`.

{{index "upcasing server example", capitalization, "toUpperCase method"}}

This code creates a ((server)) that reads request bodies and streams
them back to the client as all-uppercase text:

```
const {createServer} = require("http");
createServer((request, response) => {
  response.writeHead(200, {"Content-Type": "text/plain"});
  request.on("data", chunk =>
    response.write(chunk.toString().toUpperCase()));
  request.on("end", () => response.end());
}).listen(8000);
```

{{index "Buffer class", "toString method"}}

The `chunk` value passed to the data handler will be a binary
`Buffer`. We can convert this to a string by decoding it as UTF-8
encoded characters with its `toString` method.

The following piece of code, when run with the uppercasing server
active, will send a request to that server and write out the response
it gets:

```
const {request} = require("http");
request({
  hostname: "localhost",
  port: 8000,
  method: "POST"
}, response => {
  response.on("data", chunk =>
    process.stdout.write(chunk.toString()));
}).end("Hello server");
// → HELLO SERVER
```

{{index "stdout property", "standard output", "writable stream", "console.log"}}

The example writes to `process.stdout` (the process's standard output,
which is a writable stream) instead of using `console.log`. We can't
use `console.log` because it adds an extra newline character after
each piece of text that it writes, which isn't appropriate here since
the response may come in as multiple chunks.

{{id file_server}}

## A file server

{{index "file server example", "Node.js", [HTTP, server]}}

Let's combine our newfound knowledge about HTTP ((server))s and
working with the ((file system)) to create a bridge between the two:
an HTTP server that allows ((remote access)) to a file system. Such a
server has all kinds of uses—it allows web applications to store and
share data, or it can give a group of people shared access to a bunch of
files.

{{index [path, URL], "GET method", "PUT method", "DELETE method", [file, resource]}}

When we treat files as HTTP ((resource))s, the HTTP methods `GET`,
`PUT`, and `DELETE` can be used to read, write, and delete the files,
respectively. We will interpret the path in the request as the path of
the file that the request refers to.

{{index [path, "file system"], "relative path"}}

We probably don't want to share our whole file system, so we'll
interpret these paths as starting in the server's working
((directory)), which is the directory in which it was started. If I
ran the server from `/tmp/public/` (or `C:\tmp\public\` on Windows),
then a request for `/file.txt` should refer to `/tmp/public/file.txt`
(or `C:\tmp\public\file.txt`).

{{index "file server example", "Node.js", "methods object", "Promise class"}}

We'll build the program piece by piece, using an object called
`methods` to store the functions that handle the various HTTP methods.
Method handlers are `async` functions that get the request object as
argument and return a promise that resolves to an object that
describes the response.

```{includeCode: ">code/file_server.js"}
const {createServer} = require("http");

const methods = Object.create(null);

createServer((request, response) => {
  let handler = methods[request.method] || notAllowed;
  handler(request)
    .catch(error => {
      if (error.status != null) return error;
      return {body: String(error), status: 500};
    })
    .then(({body, status = 200, type = "text/plain"}) => {
       response.writeHead(status, {"Content-Type": type});
       if (body && body.pipe) body.pipe(response);
       else response.end(body);
    });
}).listen(8000);

async function notAllowed(request) {
  return {
    status: 405,
    body: `Method ${request.method} not allowed.`
  };
}
```

{{index "405 (HTTP status code)"}}

This starts a server that just returns 405 error responses, which is
the code used to indicate that the server refuses to handle a given
method.

{{index "500 (HTTP status code)", "error handling", "error response"}}

When a request handler's promise is rejected, the `catch` call
translates the error into a response object, if it isn't one already, so
that the server can send back an error response to inform the client
that it failed to handle the request.

{{index "200 (HTTP status code)", "Content-Type header"}}

The `status` field of the response description may be omitted, in
which case it defaults to 200 (OK). The content type, in the `type`
property, can also be left off, in which case the response is assumed
to be plain text.

{{index "end method", "pipe method", stream}}

When the value of `body` is a ((readable stream)), it will have a
`pipe` method that is used to forward all content from a readable
stream to a ((writable stream)). If not, it is assumed to be either
`null` (no body), a string, or a buffer, and it is passed directly to the
((response))'s `end` method.

{{index [path, URL], "urlToPath function", "url package", parsing, [escaping, "in URLs"], "decodeURIComponent function", "startsWith method"}}

To figure out which file path corresponds to a request URL, the
`urlPath` function uses Node's built-in `url` module to parse the URL.
It takes its pathname, which will be something like `"/file.txt"`,
decodes that to get rid of the `%20`-style escape codes, and resolves
it relative to the program's working directory.

```{includeCode: ">code/file_server.js"}
const {parse} = require("url");
const {resolve, sep} = require("path");

const baseDirectory = process.cwd();

function urlPath(url) {
  let {pathname} = parse(url);
  let path = resolve(decodeURIComponent(pathname).slice(1));
  if (path != baseDirectory &&
      !path.startsWith(baseDirectory + sep)) {
    throw {status: 403, body: "Forbidden"};
  }
  return path;
}
```

As soon as you set up a program to accept network requests, you have
to start worrying about ((security)). In this case, if we aren't
careful, it is likely that we'll accidentally expose our whole ((file
system)) to the network.

File paths are strings in Node. To map such a string to an actual
file, there is a nontrivial amount of interpretation going on. Paths
may, for example, include `../` to refer to a parent directory. So
one obvious source of problems would be requests for paths like
`/../secret_file`.

{{index "path package", "resolve function", "cwd function", "process object", "403 (HTTP status code)", "sep binding", ["backslash character", "as path separator"], "slash character"}}

To avoid such problems, `urlPath` uses the `resolve` function from the
`path` module, which resolves relative paths. It then verifies that
the result is _below_ the working directory. The `process.cwd`
function (where `cwd` stands for "current working directory") can be
used to find this working directory. The `sep` binding from the
`path` package is the system's path separator—a backslash on Windows
and a forward slash on most other systems. When the path doesn't start
with the base directory, the function throws an error response object,
using the HTTP status code indicating that access to the resource is
forbidden.

{{index "file server example", "Node.js", "GET method", [file, resource]}}

We'll set up the `GET` method to return a list of files when
reading a ((directory)) and to return the file's content when reading
a regular file.

{{index "media type", "Content-Type header", "mime package"}}

One tricky question is what kind of `Content-Type` header we should
set when returning a file's content. Since these files could be
anything, our server can't simply return the same content type for all
of them. ((NPM)) can help us again here. The `mime` package (content
type indicators like `text/plain` are also called _((MIME type))s_)
knows the correct type for a large number of ((file extension))s.

{{index "require function", "npm program"}}

The following `npm` command, in the directory where the server script
lives, installs a specific version of `mime`:

```{lang: null}
$ npm install mime@2.2.0
```

{{index "404 (HTTP status code)", "stat function", [file, resource]}}

When a requested file does not exist, the correct HTTP status code to
return is 404. We'll use the `stat` function, which looks up
information about a file, to find out both whether the file exists
and whether it is a ((directory)).

```{includeCode: ">code/file_server.js"}
const {createReadStream} = require("fs");
const {stat, readdir} = require("fs").promises;
const mime = require("mime");

methods.GET = async function(request) {
  let path = urlPath(request.url);
  let stats;
  try {
    stats = await stat(path);
  } catch (error) {
    if (error.code != "ENOENT") throw error;
    else return {status: 404, body: "File not found"};
  }
  if (stats.isDirectory()) {
    return {body: (await readdir(path)).join("\n")};
  } else {
    return {body: createReadStream(path),
            type: mime.getType(path)};
  }
};
```

{{index "createReadStream function", ["asynchronous programming", "in Node.js"], "error handling", "ENOENT (status code)", "Error type", inheritance}}

Because it has to touch the disk and thus might take a while, `stat`
is asynchronous. Since we're using promises rather than callback
style, it has to be imported from `promises` instead of directly from
`fs`.

When the file does not exist, `stat` will throw an error object with a
`code` property of `"ENOENT"`. These somewhat obscure,
((Unix))-inspired codes are how you recognize error types in Node.

{{index "Stats type", "stat function", "isDirectory method"}}

The `stats` object returned by `stat` tells us a number of things
about a ((file)), such as its size (`size` property) and its
((modification date)) (`mtime` property). Here we are interested in
the question of whether it is a ((directory)) or a regular file, which
the `isDirectory` method tells us.

{{index "readdir function"}}

We use `readdir` to read the array of files in a ((directory)) and
return it to the client. For normal files, we create a readable stream
with `createReadStream` and return that as the body, along with the
content type that the `mime` package gives us for the file's name.

{{index "Node.js", "file server example", "DELETE method", "rmdir function", "unlink function"}}

The code to handle `DELETE` requests is slightly simpler.

```{includeCode: ">code/file_server.js"}
const {rmdir, unlink} = require("fs").promises;

methods.DELETE = async function(request) {
  let path = urlPath(request.url);
  let stats;
  try {
    stats = await stat(path);
  } catch (error) {
    if (error.code != "ENOENT") throw error;
    else return {status: 204};
  }
  if (stats.isDirectory()) await rmdir(path);
  else await unlink(path);
  return {status: 204};
};
```

{{index "204 (HTTP status code)", "body (HTTP)"}}

When an ((HTTP)) ((response)) does not contain any data, the status
code 204 ("no content") can be used to indicate this. Since the
response to deletion doesn't need to transmit any information beyond
whether the operation succeeded, that is a sensible thing to return
here.

{{index idempotence, "error response"}}

You may be wondering why trying to delete a nonexistent file returns a
success status code, rather than an error. When the file that is being
deleted is not there, you could say that the request's objective is
already fulfilled. The ((HTTP)) standard encourages us to make
requests _idempotent_, which means that making the same request
multiple times produces the same result as making it once. In a way,
if you try to delete something that's already gone, the effect you
were trying to do has been achieved—the thing is no longer there.

{{index "file server example", "Node.js", "PUT method"}}

This is the handler for `PUT` requests:

```{includeCode: ">code/file_server.js"}
const {createWriteStream} = require("fs");

function pipeStream(from, to) {
  return new Promise((resolve, reject) => {
    from.on("error", reject);
    to.on("error", reject);
    to.on("finish", resolve);
    from.pipe(to);
  });
}

methods.PUT = async function(request) {
  let path = urlPath(request.url);
  await pipeStream(request, createWriteStream(path));
  return {status: 204};
};
```

{{index overwriting, "204 (HTTP status code)", "error event", "finish event", "createWriteStream function", "pipe method", stream}}

We don't need to check whether the file exists this time—if it does,
we'll just overwrite it. We again use `pipe` to move data from a
readable stream to a writable one, in this case from the request to
the file. But since `pipe` isn't written to return a promise, we have
to write a wrapper, `pipeStream`, that creates a promise around the
outcome of calling `pipe`.

{{index "error event", "finish event"}}

When something goes wrong when opening the file, `createWriteStream`
will still return a stream, but that stream will fire an `"error"`
event. The output stream to the request may also fail, for example if
the network goes down. So we wire up both streams' `"error"` events to
reject the promise. When `pipe` is done, it will close the output
stream, which causes it to fire a `"finish"` event. That's the point
where we can successfully resolve the promise (returning nothing).

{{index download, "file server example", "Node.js"}}

The full script for the server is available at
[_https://eloquentjavascript.net/code/file_server.js_](https://eloquentjavascript.net/code/file_server.js).
You can download that and, after installing its dependencies, run it
with Node to start your own file server. And, of course, you can modify
and extend it to solve this chapter's exercises or to experiment.

{{index "body (HTTP)", "curl program", [HTTP, client], [method, HTTP]}}

The command line tool `curl`, widely available on ((Unix))-like
systems (such as macOS and Linux), can be used to make HTTP
((request))s. The following session briefly tests our server. The `-X`
option is used to set the request's method, and `-d` is used to
include a request body.

```{lang: null}
$ curl http://localhost:8000/file.txt
File not found
$ curl -X PUT -d hello http://localhost:8000/file.txt
$ curl http://localhost:8000/file.txt
hello
$ curl -X DELETE http://localhost:8000/file.txt
$ curl http://localhost:8000/file.txt
File not found
```

The first request for `file.txt` fails since the file does not exist
yet. The `PUT` request creates the file, and behold, the next request
successfully retrieves it. After deleting it with a `DELETE` request,
the file is again missing.

## Summary

{{index "Node.js"}}

Node is a nice, small system that lets us run JavaScript in a
nonbrowser context. It was originally designed for network tasks to
play the role of a _node_ in a network. But it lends itself to all
kinds of scripting tasks, and if writing JavaScript is something you
enjoy, automating tasks with Node works well.

NPM provides packages for everything you can think of (and quite a few
things you'd probably never think of), and it allows you to fetch and
install those packages with the `npm` program. Node comes with a
number of built-in modules, including the `fs` module for working with
the file system and the `http` module for running HTTP servers and
making HTTP requests.

All input and output in Node is done asynchronously, unless you
explicitly use a synchronous variant of a function, such as
`readFileSync`. When calling such asynchronous functions, you provide
callback functions, and Node will call them with an error value and
(if available) a result when it is ready.

## Exercises

### Search tool

{{index grep, "search problem", "search tool (exercise)"}}

On ((Unix)) systems, there is a command line tool called `grep` that
can be used to quickly search files for a ((regular expression)).

Write a Node script that can be run from the ((command line)) and acts
somewhat like `grep`. It treats its first command line argument as a
regular expression and treats any further arguments as files to search. It
should output the names of any file whose content matches the regular
expression.

When that works, extend it so that when one of the arguments is a
((directory)), it searches through all files in that directory and its
subdirectories.

{{index ["asynchronous programming", "in Node.js"], "synchronous programming"}}

Use asynchronous or synchronous file system functions as you see fit.
Setting things up so that multiple asynchronous actions are requested
at the same time might speed things up a little, but not a huge
amount, since most file systems can read only one thing at a time.

{{hint

{{index "RegExp class", "search tool (exercise)"}}

Your first command line argument, the ((regular expression)), can be
found in `process.argv[2]`. The input files come after that. You can
use the `RegExp` constructor to go from a string to a regular
expression object.

{{index "readFileSync function"}}

Doing this synchronously, with `readFileSync`, is more
straightforward, but if you use `fs.promises` again to get
promise-returning functions and write an `async` function, the code
looks similar.

{{index "stat function", "statSync function", "isDirectory method"}}

To figure out whether something is a directory, you can again use
`stat` (or `statSync`) and the stats object's `isDirectory` method.

{{index "readdir function", "readdirSync function"}}

Exploring a directory is a branching process. You can do it either
by using a recursive function or by keeping an array of work (files that
still need to be explored). To find the files in a directory, you can
call `readdir` or `readdirSync`. The strange
capitalization—Node's file system function naming is loosely based on
standard Unix functions, such as `readdir`, that are all lowercase,
but then it adds `Sync` with a capital letter.

To go from a filename read with `readdir` to a full path name, you
have to combine it with the name of the directory, putting a ((slash
character)) (`/`) between them.

hint}}

### Directory creation

{{index "file server example", "directory creation (exercise)", "rmdir function"}}

Though the `DELETE` method in our file server is able to delete
directories (using `rmdir`), the server currently does not provide any
way to _create_ a ((directory)).

{{index "MKCOL method", "mkdir function"}}

Add support for the `MKCOL` method ("make collection"), which should create
a directory by calling `mkdir` from the `fs` module. `MKCOL` is not a
widely used HTTP method, but it does exist for this same purpose in
the _((WebDAV))_ standard, which specifies a set of conventions on top
of ((HTTP)) that make it suitable for creating documents.

```{hidden: true, includeCode: ">code/file_server.js"}
const {mkdir} = require("fs").promises;

methods.MKCOL = async function(request) {
  let path = urlPath(request.url);
  let stats;
  try {
    stats = await stat(path);
  } catch (error) {
    if (error.code != "ENOENT") throw error;
    await mkdir(path);
    return {status: 204};
  }
  if (stats.isDirectory()) return {status: 204};
  else return {status: 400, body: "Not a directory"};
};
```

{{hint

{{index "directory creation (exercise)", "file server example", "MKCOL method", "mkdir function", idempotency, "400 (HTTP status code)"}}

You can use the function that implements the `DELETE` method as a
blueprint for the `MKCOL` method. When no file is found, try to create
a directory with `mkdir`. When a directory exists at that path, you
can return a 204 response so that directory creation requests are
idempotent. If a nondirectory file exists here, return an error code.
Code 400 ("bad request") would be appropriate.

hint}}

### A public space on the web

{{index "public space (exercise)", "file server example", "Content-Type header", website}}

Since the file server serves up any kind of file and even includes the
right `Content-Type` header, you can use it to serve a website. Since
it allows everybody to delete and replace files, it would be an
interesting kind of website: one that can be modified, improved, and
vandalized by everybody who takes the time to create the right HTTP
request.

Write a basic ((HTML)) page that includes a simple JavaScript file.
Put the files in a directory served by the file server and open them
in your browser.

Next, as an advanced exercise or even a ((weekend project)), combine
all the knowledge you gained from this book to build a more
user-friendly interface for modifying the website—from _inside_ the
website.

Use an HTML ((form)) to edit the content of the files that make up the
website, allowing the user to update them on the server by using HTTP
requests, as described in [Chapter ?](http).

Start by making only a single file editable. Then make it so that the
user can select which file to edit. Use the fact that our file server
returns lists of files when reading a directory.

{{index overwriting}}

Don't work directly in the code exposed by the file server since if
you make a mistake, you are likely to damage the files there. Instead,
keep your work outside of the publicly accessible directory and copy
it there when testing.

{{hint

{{index "file server example", "textarea (HTML tag)", "fetch function", "relative path", "public space (exercise)"}}

You can create a `<textarea>` element to hold the content of the file
that is being edited. A `GET` request, using `fetch`, can retrieve the
current content of the file. You can use relative URLs like
_index.html_, instead of
[_http://localhost:8000/index.html_](http://localhost:8000/index.html),
to refer to files on the same server as the running script.

{{index "form (HTML tag)", "submit event", "PUT method"}}

Then, when the user clicks a button (you can use a `<form>` element
and `"submit"` event), make a `PUT` request to the same URL, with the
content of the `<textarea>` as request body, to save the file.

{{index "select (HTML tag)", "option (HTML tag)", "change event"}}

You can then add a `<select>` element that contains all the files in
the server's top ((directory)) by adding `<option>` elements
containing the lines returned by a `GET` request to the URL `/`. When
the user selects another file (a `"change"` event on the field), the
script must fetch and display that file. When saving a file, use the
currently selected filename.

hint}}
{{meta {code_links: ["code/skillsharing.zip"]}}}

# Project: Skill-Sharing Website

{{quote {author: "Margaret Fuller", chapter: true}

If you have knowledge, let others light their candles at it.

quote}}

{{index "skill-sharing project", meetup, "project chapter"}}

{{figure {url: "img/chapter_picture_21.jpg", alt: "Picture of two unicycles", chapter: "framed"}}}

A _((skill-sharing))_ meeting is an event where people with a shared
interest come together and give small, informal presentations about
things they know. At a ((gardening)) skill-sharing meeting, someone
might explain how to cultivate ((celery)). Or in a programming
skill-sharing group, you could drop by and tell people about Node.js.

{{index learning, "users' group"}}

Such meetups—also often called _users' groups_ when they are about
computers—are a great way to broaden your horizon, learn about new
developments, or simply meet people with similar interests. Many
larger cities have JavaScript meetups. They are typically free to
attend, and I've found the ones I've visited to be friendly and
welcoming.

In this final project chapter, our goal is to set up a ((website)) for
managing ((talk))s given at a skill-sharing meeting. Imagine a small
group of people meeting up regularly in the office of one of the
members to talk about ((unicycling)). The previous organizer of the
meetings moved to another town, and nobody stepped forward to take
over this task. We want a system that will let the participants
propose and discuss talks among themselves, without a central
organizer.

[Just like in the [previous chapter](node), some of the code in this
chapter is written for Node.js, and running it directly in the HTML
page that you are looking at is unlikely to work.]{if interactive} The
full code for the project can be ((download))ed from
[_https://eloquentjavascript.net/code/skillsharing.zip_](https://eloquentjavascript.net/code/skillsharing.zip).

## Design

{{index "skill-sharing project", persistence}}

There is a _((server))_ part to this project, written for ((Node.js)),
and a _((client))_ part, written for the ((browser)). The server
stores the system's data and provides it to the client. It also serves
the files that implement the client-side system.

{{index [HTTP, client]}}

The server keeps the list of ((talk))s proposed for the next meeting,
and the client shows this list. Each talk has a presenter name, a
title, a summary, and an array of ((comment))s associated with it. The
client allows users to propose new talks (adding them to the list),
delete talks, and comment on existing talks. Whenever the user makes
such a change, the client makes an HTTP ((request)) to tell the
server about it.

{{figure {url: "img/skillsharing.png", alt: "Screenshot of the skill-sharing website",width: "10cm"}}}

{{index "live view", "user experience", "pushing data", connection}}

The ((application)) will be set up to show a _live_ view of the
current proposed talks and their comments. Whenever someone,
somewhere, submits a new talk or adds a comment, all people who have
the page open in their browsers should immediately see the change.
This poses a bit of a challenge—there is no way for a web server to
open a connection to a client, nor is there a good way to know which
clients are currently looking at a given website.

{{index "Node.js"}}

A common solution to this problem is called _((long polling))_, which
happens to be one of the motivations for Node's design.

## Long polling

{{index firewall, notification, "long polling", network, [browser, security]}}

To be able to immediately notify a client that something changed, we
need a ((connection)) to that client. Since web browsers do not
traditionally accept connections and clients are often behind
((router))s that would block such connections anyway, having the
server initiate this connection is not practical.

We can arrange for the client to open the connection and keep it
around so that the server can use it to send information when it needs
to do so.

{{index socket}}

But an ((HTTP)) request allows only a simple flow of information: the
client sends a request, the server comes back with a single response,
and that is it. There is a technology called _((WebSockets))_,
supported by modern browsers, that makes it possible to open
((connection))s for arbitrary data exchange. But using them properly
is somewhat tricky.

In this chapter, we use a simpler technique—((long polling))—where
clients continuously ask the server for new information using regular
HTTP requests, and the server stalls its answer when it has nothing
new to report.

{{index "live view"}}

As long as the client makes sure it constantly has a polling request
open, it will receive information from the server quickly after it
becomes available. For example, if Fatma has our skill-sharing
application open in her browser, that browser will have made a request
for updates and will be waiting for a response to that request. When Iman
submits a talk on Extreme Downhill Unicycling, the server will notice
that Fatma is waiting for updates and send a response containing the
new talk to her pending request. Fatma's browser will receive the data
and update the screen to show the talk.

{{index robustness, timeout}}

To prevent connections from timing out (being aborted because of a
lack of activity), ((long polling)) techniques usually set a maximum
time for each request, after which the server will respond anyway,
even though it has nothing to report, after which the client will
start a new request. Periodically restarting the request also makes
the technique more robust, allowing clients to recover from temporary
((connection)) failures or server problems.

{{index "Node.js"}}

A busy server that is using long polling may have thousands of waiting
requests, and thus ((TCP)) connections, open. Node, which makes it
easy to manage many connections without creating a separate thread of
control for each one, is a good fit for such a system.

## HTTP interface

{{index "skill-sharing project", [interface, HTTP]}}

Before we start designing either the server or the client, let's think
about the point where they touch: the ((HTTP)) interface over
which they communicate.

{{index [path, URL], [method, HTTP]}}

We will use ((JSON)) as the format of our request and response body.
Like in the file server from [Chapter ?](node#file_server), we'll try
to make good use of HTTP methods and ((header))s. The interface is
centered around the `/talks` path. Paths that do not start with
`/talks` will be used for serving ((static file))s—the HTML and
JavaScript code for the client-side system.

{{index "GET method"}}

A `GET` request to `/talks` returns a JSON document like this:

```{lang: "application/json"}
[{"title": "Unituning",
  "presenter": "Jamal",
  "summary": "Modifying your cycle for extra style",
  "comments": []}]
```

{{index "PUT method", URL}}

Creating a new talk is done by making a `PUT` request to a URL like
`/talks/Unituning`, where the part after the second slash is the title
of the talk. The `PUT` request's body should contain a ((JSON)) object
that has `presenter` and `summary` properties.

{{index "encodeURIComponent function", [escaping, "in URLs"], [whitespace, "in URLs"]}}

Since talk titles may contain spaces and other characters that may not
appear normally in a URL, title strings must be encoded with the
`encodeURIComponent` function when building up such a URL.

```
console.log("/talks/" + encodeURIComponent("How to Idle"));
// → /talks/How%20to%20Idle
```

A request to create a talk about idling might look something like
this:

```{lang: http}
PUT /talks/How%20to%20Idle HTTP/1.1
Content-Type: application/json
Content-Length: 92

{"presenter": "Maureen",
 "summary": "Standing still on a unicycle"}
```

Such URLs also support `GET` requests to retrieve the JSON
representation of a talk and `DELETE` requests to delete a talk.

{{index "POST method"}}

Adding a ((comment)) to a talk is done with a `POST` request to a URL
like `/talks/Unituning/comments`, with a JSON body that has `author`
and `message` properties.

```{lang: http}
POST /talks/Unituning/comments HTTP/1.1
Content-Type: application/json
Content-Length: 72

{"author": "Iman",
 "message": "Will you talk about raising a cycle?"}
```

{{index "query string", timeout, "ETag header", "If-None-Match header"}}

To support ((long polling)), `GET` requests to `/talks` may include
extra headers that inform the server to delay the response if no new
information is available. We'll use a pair of headers normally
intended to manage caching: `ETag` and `If-None-Match`.

{{index "304 (HTTP status code)"}}

Servers may include an `ETag` ("entity tag") header in a response. Its
value is a string that identifies the current version of the resource.
Clients, when they later request that resource again, may make a
_((conditional request))_ by including an `If-None-Match` header whose
value holds that same string. If the resource hasn't changed, the
server will respond with status code 304, which means "not modified",
telling the client that its cached version is still current. When the
tag does not match, the server responds as normal.

{{index "Prefer header"}}

We need something like this, where the client can tell the server
which version of the list of talks it has, and the server
responds only when that list has changed. But instead of immediately
returning a 304 response, the server should stall the response and
return only when something new is available or a given amount of time
has elapsed. To distinguish long polling requests from normal
conditional requests, we give them another header, `Prefer: wait=90`,
which tells the server that the client is willing to wait up to 90
seconds for the response.

The server will keep a version number that it updates every time the
talks change and will use that as the `ETag` value. Clients can make
requests like this to be notified when the talks change:

```{lang: null}
GET /talks HTTP/1.1
If-None-Match: "4"
Prefer: wait=90

(time passes)

HTTP/1.1 200 OK
Content-Type: application/json
ETag: "5"
Content-Length: 295

[....]
```

{{index security}}

The protocol described here does not do any ((access control)).
Everybody can comment, modify talks, and even delete them. (Since the
Internet is full of ((hooligan))s, putting such a system online
without further protection probably wouldn't end well.)

## The server

{{index "skill-sharing project"}}

Let's start by building the ((server))-side part of the program. The
code in this section runs on ((Node.js)).

### Routing

{{index "createServer function", [path, URL], [method, HTTP]}}

Our server will use `createServer` to start an HTTP server. In the
function that handles a new request, we must distinguish between the
various kinds of requests (as determined by the method and the
path) that we support. This can be done with a long chain of `if`
statements, but there is a nicer way.

{{index dispatch}}

A _((router))_ is a component that helps dispatch a request to the
function that can handle it. You can tell the router, for example,
that `PUT` requests with a path that matches the regular expression
`/^\/talks\/([^\/]+)$/` (`/talks/` followed by a talk title) can be
handled by a given function. In addition, it can help extract the
meaningful parts of the path (in this case the talk title), wrapped in
parentheses in the ((regular expression)), and pass them to the
handler function.

There are a number of good router packages on ((NPM)), but here we'll
write one ourselves to illustrate the principle.

{{index "require function", "Router class", module}}

This is `router.js`, which we will later `require` from our server
module:

```{includeCode: ">code/skillsharing/router.js"}
const {parse} = require("url");

module.exports = class Router {
  constructor() {
    this.routes = [];
  }
  add(method, url, handler) {
    this.routes.push({method, url, handler});
  }
  resolve(context, request) {
    let path = parse(request.url).pathname;

    for (let {method, url, handler} of this.routes) {
      let match = url.exec(path);
      if (!match || request.method != method) continue;
      let urlParts = match.slice(1).map(decodeURIComponent);
      return handler(context, ...urlParts, request);
    }
    return null;
  }
};
```

{{index "Router class"}}

The module exports the `Router` class. A router object allows new
handlers to be registered with the `add` method and can resolve
requests with its `resolve` method.

{{index "some method"}}

The latter will return a response when a handler was found, and `null`
otherwise. It tries the routes one at a time (in the order in which
they were defined) until a matching one is found.

{{index "capture group", "decodeURIComponent function", [escaping, "in URLs"]}}

The handler functions are called with the `context` value (which
will be the server instance in our case), match strings for any groups
they defined in their ((regular expression)), and the request object.
The strings have to be URL-decoded since the raw URL may contain
`%20`-style codes.

### Serving files

When a request matches none of the request types defined in our
router, the server must interpret it as a request for a file in the
`public` directory. It would be possible to use the file server
defined in [Chapter ?](node#file_server) to serve such files, but we
neither need nor want to support `PUT` and `DELETE` requests on files,
and we would like to have advanced features such as support for
caching. So let's use a solid, well-tested ((static file)) server from
((NPM)) instead.

{{index "createServer function", "ecstatic package"}}

I opted for `ecstatic`. This isn't the only such server on NPM, but it
works well and fits our purposes. The `ecstatic` package exports a
function that can be called with a configuration object to produce a
request handler function. We use the `root` option to tell the server
where it should look for files. The handler function accepts `request`
and `response` parameters and can be passed directly to `createServer`
to create a server that serves _only_ files. We want to first check
for requests that we should handle specially, though, so we wrap it in
another function.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
const {createServer} = require("http");
const Router = require("./router");
const ecstatic = require("ecstatic");

const router = new Router();
const defaultHeaders = {"Content-Type": "text/plain"};

class SkillShareServer {
  constructor(talks) {
    this.talks = talks;
    this.version = 0;
    this.waiting = [];

    let fileServer = ecstatic({root: "./public"});
    this.server = createServer((request, response) => {
      let resolved = router.resolve(this, request);
      if (resolved) {
        resolved.catch(error => {
          if (error.status != null) return error;
          return {body: String(error), status: 500};
        }).then(({body,
                  status = 200,
                  headers = defaultHeaders}) => {
          response.writeHead(status, headers);
          response.end(body);
        });
      } else {
        fileServer(request, response);
      }
    });
  }
  start(port) {
    this.server.listen(port);
  }
  stop() {
    this.server.close();
  }
}
```

This uses a similar convention as the file server from the [previous
chapter](node) for responses—handlers return promises that resolve to
objects describing the response. It wraps the server in an object that
also holds its state.

### Talks as resources

The ((talk))s that have been proposed are stored in the `talks`
property of the server, an object whose property names are the talk
titles. These will be exposed as HTTP ((resource))s under
`/talks/[title]`, so we need to add handlers to our router that
implement the various methods that clients can use to work with them.

{{index "GET method", "404 (HTTP status code)"}}

The handler for requests that `GET` a single talk must look up the
talk and respond either with the talk's JSON data or with a 404 error
response.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
const talkPath = /^\/talks\/([^\/]+)$/;

router.add("GET", talkPath, async (server, title) => {
  if (title in server.talks) {
    return {body: JSON.stringify(server.talks[title]),
            headers: {"Content-Type": "application/json"}};
  } else {
    return {status: 404, body: `No talk '${title}' found`};
  }
});
```

{{index "DELETE method"}}

Deleting a talk is done by removing it from the `talks` object.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
router.add("DELETE", talkPath, async (server, title) => {
  if (title in server.talks) {
    delete server.talks[title];
    server.updated();
  }
  return {status: 204};
});
```

{{index "long polling", "updated method"}}

The `updated` method, which we will define
[later](skillsharing#updated), notifies waiting long polling requests
about the change.

{{index "readStream function", "body (HTTP)", stream}}

To retrieve the content of a request body, we define a function called
`readStream`, which reads all content from a ((readable stream)) and
returns a promise that resolves to a string.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
function readStream(stream) {
  return new Promise((resolve, reject) => {
    let data = "";
    stream.on("error", reject);
    stream.on("data", chunk => data += chunk.toString());
    stream.on("end", () => resolve(data));
  });
}
```

{{index validation, input, "PUT method"}}

One handler that needs to read request bodies is the `PUT` handler,
which is used to create new ((talk))s. It has to check whether the
data it was given has `presenter` and `summary` properties, which are
strings. Any data coming from outside the system might be nonsense,
and we don't want to corrupt our internal data model or ((crash)) when
bad requests come in.

{{index "updated method"}}

If the data looks valid, the handler stores an object that represents
the new talk in the `talks` object, possibly ((overwriting)) an
existing talk with this title, and again calls `updated`.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
router.add("PUT", talkPath,
           async (server, title, request) => {
  let requestBody = await readStream(request);
  let talk;
  try { talk = JSON.parse(requestBody); }
  catch (_) { return {status: 400, body: "Invalid JSON"}; }

  if (!talk ||
      typeof talk.presenter != "string" ||
      typeof talk.summary != "string") {
    return {status: 400, body: "Bad talk data"};
  }
  server.talks[title] = {title,
                         presenter: talk.presenter,
                         summary: talk.summary,
                         comments: []};
  server.updated();
  return {status: 204};
});
```

{{index validation, "readStream function"}}

Adding a ((comment)) to a ((talk)) works similarly. We use
`readStream` to get the content of the request, validate the resulting
data, and store it as a comment when it looks valid.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
router.add("POST", /^\/talks\/([^\/]+)\/comments$/,
           async (server, title, request) => {
  let requestBody = await readStream(request);
  let comment;
  try { comment = JSON.parse(requestBody); }
  catch (_) { return {status: 400, body: "Invalid JSON"}; }

  if (!comment ||
      typeof comment.author != "string" ||
      typeof comment.message != "string") {
    return {status: 400, body: "Bad comment data"};
  } else if (title in server.talks) {
    server.talks[title].comments.push(comment);
    server.updated();
    return {status: 204};
  } else {
    return {status: 404, body: `No talk '${title}' found`};
  }
});
```

{{index "404 (HTTP status code)"}}

Trying to add a comment to a nonexistent talk returns a 404 error.

### Long polling support

The most interesting aspect of the server is the part that handles
((long polling)). When a `GET` request comes in for `/talks`, it may
be either a regular request or a long polling request.

{{index "talkResponse method", "ETag header"}}

There will be multiple places in which we have to send an array of
talks to the client, so we first define a helper method that builds up
such an array and includes an `ETag` header in the response.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
SkillShareServer.prototype.talkResponse = function() {
  let talks = [];
  for (let title of Object.keys(this.talks)) {
    talks.push(this.talks[title]);
  }
  return {
    body: JSON.stringify(talks),
    headers: {"Content-Type": "application/json",
              "ETag": `"${this.version}"`,
              "Cache-Control": "no-store"}
  };
};
```

{{index "query string", "url package", parsing}}

The handler itself needs to look at the request headers to see whether
`If-None-Match` and `Prefer` headers are present. Node stores headers,
whose names are specified to be case insensitive, under their
lowercase names.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
router.add("GET", /^\/talks$/, async (server, request) => {
  let tag = /"(.*)"/.exec(request.headers["if-none-match"]);
  let wait = /\bwait=(\d+)/.exec(request.headers["prefer"]);
  if (!tag || tag[1] != server.version) {
    return server.talkResponse();
  } else if (!wait) {
    return {status: 304};
  } else {
    return server.waitForChanges(Number(wait[1]));
  }
});
```

{{index "long polling", "waitForChanges method", "If-None-Match header", "Prefer header"}}

If no tag was given or a tag was given that doesn't match the
server's current version, the handler responds with the list of talks.
If the request is conditional and the talks did not change, we consult
the `Prefer` header to see whether we should delay the response or respond
right away.

{{index "304 (HTTP status code)", "setTimeout function", timeout, "callback function"}}

Callback functions for delayed requests are stored in the server's
`waiting` array so that they can be notified when something happens.
The `waitForChanges` method also immediately sets a timer to respond
with a 304 status when the request has waited long enough.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
SkillShareServer.prototype.waitForChanges = function(time) {
  return new Promise(resolve => {
    this.waiting.push(resolve);
    setTimeout(() => {
      if (!this.waiting.includes(resolve)) return;
      this.waiting = this.waiting.filter(r => r != resolve);
      resolve({status: 304});
    }, time * 1000);
  });
};
```

{{index "updated method"}}

{{id updated}}

Registering a change with `updated` increases the `version` property
and wakes up all waiting requests.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
SkillShareServer.prototype.updated = function() {
  this.version++;
  let response = this.talkResponse();
  this.waiting.forEach(resolve => resolve(response));
  this.waiting = [];
};
```

{{index [HTTP, server]}}

That concludes the server code. If we create an instance of
`SkillShareServer` and start it on port 8000, the resulting HTTP
server serves files from the `public` subdirectory alongside a
talk-managing interface under the `/talks` URL.

```{includeCode: ">code/skillsharing/skillsharing_server.js"}
new SkillShareServer(Object.create(null)).start(8000);
```

## The client

{{index "skill-sharing project"}}

The ((client))-side part of the skill-sharing website consists of
three files: a tiny HTML page, a style sheet, and a JavaScript file.

### HTML

{{index "index.html"}}

It is a widely used convention for web servers to try to serve a file
named `index.html` when a request is made directly to a path that
corresponds to a directory. The ((file server)) module we use,
`ecstatic`, supports this convention. When a request is made to the
path `/`, the server looks for the file `./public/index.html`
(`./public` being the root we gave it) and returns that file if found.

Thus, if we want a page to show up when a browser is pointed at our
server, we should put it in `public/index.html`. This is our index
file:

```{lang: "text/html", includeCode: ">code/skillsharing/public/index.html"}
<!doctype html>
<meta charset="utf-8">
<title>Skill Sharing</title>
<link rel="stylesheet" href="skillsharing.css">

<h1>Skill Sharing</h1>

<script src="skillsharing_client.js"></script>
```

{{index CSS}}

It defines the document ((title)) and includes a style sheet,
which defines a few styles to, among other things, make sure there is
some space between talks.

At the bottom, it adds a heading at the top of the page and loads the
script that contains the ((client))-side application.

### Actions

The application state consists of the list of talks and the name of
the user, and we'll store it in a `{talks, user}` object. We don't
allow the user interface to directly manipulate the state or send off
HTTP requests. Rather, it may emit _actions_ that describe what the
user is trying to do.

{{index "handleAction function"}}

The `handleAction` function takes such an action and makes it happen.
Because our state updates are so simple, state changes are handled in
the same function.

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function handleAction(state, action) {
  if (action.type == "setUser") {
    localStorage.setItem("userName", action.user);
    return Object.assign({}, state, {user: action.user});
  } else if (action.type == "setTalks") {
    return Object.assign({}, state, {talks: action.talks});
  } else if (action.type == "newTalk") {
    fetchOK(talkURL(action.title), {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        presenter: state.user,
        summary: action.summary
      })
    }).catch(reportError);
  } else if (action.type == "deleteTalk") {
    fetchOK(talkURL(action.talk), {method: "DELETE"})
      .catch(reportError);
  } else if (action.type == "newComment") {
    fetchOK(talkURL(action.talk) + "/comments", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        author: state.user,
        message: action.message
      })
    }).catch(reportError);
  }
  return state;
}
```

{{index "localStorage object"}}

We'll store the user's name in `localStorage` so that it can be
restored when the page is loaded.

{{index "fetch function", "status property"}}

The actions that need to involve the server make network requests,
using `fetch`, to the HTTP interface described earlier. We use a
wrapper function, `fetchOK`, which makes sure the returned promise is
rejected when the server returns an error code.

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function fetchOK(url, options) {
  return fetch(url, options).then(response => {
    if (response.status < 400) return response;
    else throw new Error(response.statusText);
  });
}
```

{{index "talkURL function", "encodeURIComponent function"}}

This helper function is used to build up a ((URL)) for a talk
with a given title.

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function talkURL(title) {
  return "talks/" + encodeURIComponent(title);
}
```

{{index "error handling", "user experience", "reportError function"}}

When the request fails, we don't want to have our page just sit there,
doing nothing without explanation. So we define a function called
`reportError`, which at least shows the user a dialog that tells them
something went wrong.

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function reportError(error) {
  alert(String(error));
}
```

### Rendering components

{{index "renderUserField function"}}

We'll use an approach similar to the one we saw in [Chapter ?](paint),
splitting the application into components. But since some of the
components either never need to update or are always fully redrawn
when updated, we'll define those not as classes but as functions that
directly return a DOM node. For example, here is a component that
shows the field where the user can enter their name:

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function renderUserField(name, dispatch) {
  return elt("label", {}, "Your name: ", elt("input", {
    type: "text",
    value: name,
    onchange(event) {
      dispatch({type: "setUser", user: event.target.value});
    }
  }));
}
```

{{index "elt function"}}

The `elt` function used to construct DOM elements is the one we used
in [Chapter ?](paint).

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no, hidden: true}
function elt(type, props, ...children) {
  let dom = document.createElement(type);
  if (props) Object.assign(dom, props);
  for (let child of children) {
    if (typeof child != "string") dom.appendChild(child);
    else dom.appendChild(document.createTextNode(child));
  }
  return dom;
}
```

{{index "renderTalk function"}}

A similar function is used to render talks, which include a list of
comments and a form for adding a new ((comment)).

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function renderTalk(talk, dispatch) {
  return elt(
    "section", {className: "talk"},
    elt("h2", null, talk.title, " ", elt("button", {
      type: "button",
      onclick() {
        dispatch({type: "deleteTalk", talk: talk.title});
      }
    }, "Delete")),
    elt("div", null, "by ",
        elt("strong", null, talk.presenter)),
    elt("p", null, talk.summary),
    ...talk.comments.map(renderComment),
    elt("form", {
      onsubmit(event) {
        event.preventDefault();
        let form = event.target;
        dispatch({type: "newComment",
                  talk: talk.title,
                  message: form.elements.comment.value});
        form.reset();
      }
    }, elt("input", {type: "text", name: "comment"}), " ",
       elt("button", {type: "submit"}, "Add comment")));
}
```

{{index "submit event"}}

The `"submit"` event handler calls `form.reset` to clear the form's
content after creating a `"newComment"` action.

When creating moderately complex pieces of DOM, this style of
programming starts to look rather messy. There's a widely used
(non-standard) JavaScript extension called _((JSX))_ that lets you
write HTML directly in your scripts, which can make such code prettier
(depending on what you consider pretty). Before you can actually run
such code, you have to run a program on your script to convert the
pseudo-HTML into JavaScript function calls much like the ones we use
here.

Comments are simpler to render.

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function renderComment(comment) {
  return elt("p", {className: "comment"},
             elt("strong", null, comment.author),
             ": ", comment.message);
}
```

{{index "form (HTML tag)", "renderTalkForm function"}}

Finally, the form that the user can use to create a new talk is
rendered like this:

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function renderTalkForm(dispatch) {
  let title = elt("input", {type: "text"});
  let summary = elt("input", {type: "text"});
  return elt("form", {
    onsubmit(event) {
      event.preventDefault();
      dispatch({type: "newTalk",
                title: title.value,
                summary: summary.value});
      event.target.reset();
    }
  }, elt("h3", null, "Submit a Talk"),
     elt("label", null, "Title: ", title),
     elt("label", null, "Summary: ", summary),
     elt("button", {type: "submit"}, "Submit"));
}
```

### Polling

{{index "pollTalks function", "long polling", "If-None-Match header", "Prefer header", "fetch function"}}

To start the app we need the current list of talks. Since the initial
load is closely related to the long polling process—the `ETag` from
the load must be used when polling—we'll write a function that keeps
polling the server for `/talks` and calls a ((callback function))
when a new set of talks is available.

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
async function pollTalks(update) {
  let tag = undefined;
  for (;;) {
    let response;
    try {
      response = await fetchOK("/talks", {
        headers: tag && {"If-None-Match": tag,
                         "Prefer": "wait=90"}
      });
    } catch (e) {
      console.log("Request failed: " + e);
      await new Promise(resolve => setTimeout(resolve, 500));
      continue;
    }
    if (response.status == 304) continue;
    tag = response.headers.get("ETag");
    update(await response.json());
  }
}
```

{{index "async function"}}

This is an `async` function so that looping and waiting for the
request is easier. It runs an infinite loop that, on each iteration,
retrieves the list of talks—either normally or, if this isn't the
first request, with the headers included that make it a long polling
request.

{{index "error handling", "Promise class", "setTimeout function"}}

When a request fails, the function waits a moment and then tries
again. This way, if your network connection goes away for a while and
then comes back, the application can recover and continue updating.
The promise resolved via `setTimeout` is a way to force the `async`
function to wait.

{{index "304 (HTTP status code)", "ETag header"}}

When the server gives back a 304 response, that means a long polling
request timed out, so the function should just immediately start the
next request. If the response is a normal 200 response, its body is
read as ((JSON)) and passed to the callback, and its `ETag` header
value is stored for the next iteration.

### The application

{{index "SkillShareApp class"}}

The following component ties the whole user interface together:

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
class SkillShareApp {
  constructor(state, dispatch) {
    this.dispatch = dispatch;
    this.talkDOM = elt("div", {className: "talks"});
    this.dom = elt("div", null,
                   renderUserField(state.user, dispatch),
                   this.talkDOM,
                   renderTalkForm(dispatch));
    this.syncState(state);
  }

  syncState(state) {
    if (state.talks != this.talks) {
      this.talkDOM.textContent = "";
      for (let talk of state.talks) {
        this.talkDOM.appendChild(
          renderTalk(talk, this.dispatch));
      }
      this.talks = state.talks;
    }
  }
}
```

{{index synchronization, "live view"}}

When the talks change, this component redraws all of them. This is
simple but also wasteful. We'll get back to that in the exercises.

We can start the application like this:

```{includeCode: ">code/skillsharing/public/skillsharing_client.js", test: no}
function runApp() {
  let user = localStorage.getItem("userName") || "Anon";
  let state, app;
  function dispatch(action) {
    state = handleAction(state, action);
    app.syncState(state);
  }

  pollTalks(talks => {
    if (!app) {
      state = {user, talks};
      app = new SkillShareApp(state, dispatch);
      document.body.appendChild(app.dom);
    } else {
      dispatch({type: "setTalks", talks});
    }
  }).catch(reportError);
}

runApp();
```

If you run the server and open two browser windows for
[_http://localhost:8000_](http://localhost:8000/) next to each other, you can
see that the actions you perform in one window are immediately visible
in the other.

## Exercises

{{index "Node.js", NPM}}

The following exercises will involve modifying the system defined in
this chapter. To work on them, make sure you ((download)) the code
first
([_https://eloquentjavascript.net/code/skillsharing.zip_](https://eloquentjavascript.net/code/skillsharing.zip)),
have Node installed [_https://nodejs.org_](https://nodejs.org), and have
installed the project's dependency with `npm install`.

### Disk persistence

{{index "data loss", persistence, [memory, persistence]}}

The skill-sharing server keeps its data purely in memory. This
means that when it ((crash))es or is restarted for any reason, all
talks and comments are lost.

{{index "hard drive"}}

Extend the server so that it stores the talk data to disk and
automatically reloads the data when it is restarted. Do not worry
about efficiency—do the simplest thing that works.

{{hint

{{index "file system", "writeFile function", "updated method", persistence}}

The simplest solution I can come up with is to encode the whole
`talks` object as ((JSON)) and dump it to a file with `writeFile`.
There is already a method (`updated`) that is called every time the
server's data changes. It can be extended to write the new data to
disk.

{{index "readFile function"}}

Pick a ((file))name, for example `./talks.json`. When the server
starts, it can try to read that file with `readFile`, and if that
succeeds, the server can use the file's contents as its starting data.

{{index prototype, "JSON.parse function"}}

Beware, though. The `talks` object started as a prototype-less object
so that the `in` operator could reliably be used. `JSON.parse` will
return regular objects with `Object.prototype` as their prototype. If
you use JSON as your file format, you'll have to copy the properties
of the object returned by `JSON.parse` into a new, prototype-less
object.

hint}}

### Comment field resets

{{index "comment field reset (exercise)", template, [state, "of application"]}}

The wholesale redrawing of talks works pretty well because you usually
can't tell the difference between a DOM node and its identical
replacement. But there are exceptions. If you start typing something
in the comment ((field)) for a talk in one browser window and then, in
another, add a comment to that talk, the field in the first window
will be redrawn, removing both its content and its ((focus)).

In a heated discussion, where multiple people are adding comments at
the same time, this would be annoying. Can you come up with a way
to solve it?

{{hint

{{index "comment field reset (exercise)", template, "syncState method"}}

The best way to do this is probably to make talks component objects,
with a `syncState` method, so that they can be updated to show a
modified version of the talk. During normal operation, the only way a
talk can be changed is by adding more comments, so the `syncState`
method can be relatively simple.

The difficult part is that, when a changed list of talks comes in, we
have to reconcile the existing list of DOM components with the talks
on the new list—deleting components whose talk was deleted and
updating components whose talk changed.

{{index synchronization, "live view"}}

To do this, it might be helpful to keep a data structure that stores
the talk components under the talk titles so that you can easily
figure out whether a component exists for a given talk. You can then
loop over the new array of talks, and for each of them, either
synchronize an existing component or create a new one. To delete
components for deleted talks, you'll have to also loop over the
components and check whether the corresponding talks still exist.

hint}}
# Eloquent JavaScript

These are the sources used to build the third edition of Eloquent
JavaScript (https://eloquentjavascript.net).

Feedback welcome, in the form of issues and pull requests.

## Building

This builds the HTML output in `html/`, where `make` is GNU make:

    npm install
    make html

To build the PDF file (don't bother trying this unless you really need
it, since this list has probably bitrotted again and getting all this
set up is a pain):

    apt-get install texlive texlive-xetex fonts-inconsolata fonts-symbola texlive-lang-chinese inkscape
    make book.pdf

## Translating

Translations are very much welcome. The license this book is published
under allows non-commercial derivations, which includes open
translations. If you do one, let me know, and I'll add a link to the
website.

A note of caution though: This text consists of about 130 000 words,
the paper book is 400 pages. That's a lot of text, which will take a
lot of time to translate.

If that doesn't scare you off, the recommended way to go about a
translation is:

 - Fork this repository on GitHub.

 - Create an issue on the repository describing your plan to translate.

 - Translate the `.md` files in your fork. These are
   [CommonMark](https://commonmark.org/) formatted, with a few
   extensions. You may consider omitting the index terms (indicated
   with double parentheses and `{{index ...}}` syntax) from your
   translation, since that's mostly relevant for print output.

 - Publish somewhere online or ask me to host the result.

Doing this in public, and creating an issue that links to your work,
helps avoid wasted effort, where multiple people start a translation
to the same language (and possibly never finish it). (Since
translations have to retain the license, it is okay to pick up someone
else's translation and continue it, even when they have vanished from
the internet.)
